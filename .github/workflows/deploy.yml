name: Deploy Docker G3

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: self-hosted
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout do codigo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Incrementar versao e atualizar containers
        run: |
          set -euo pipefail

          arquivoVersao="backend/src/main/resources/static/version.txt"

          if [ ! -f "$arquivoVersao" ]; then
            echo "Arquivo de versao nao encontrado: $arquivoVersao"
            exit 1
          fi

          versaoAtual=$(head -n 1 "$arquivoVersao" | tr -cd '0-9.')
          major=$(echo "$versaoAtual" | cut -d. -f1)
          minor=$(echo "$versaoAtual" | cut -d. -f2)
          patch=$(echo "$versaoAtual" | cut -d. -f3)

          if [ -z "$major" ] || [ -z "$minor" ] || [ -z "$patch" ]; then
            echo "Formato de versao invalido: $versaoAtual"
            exit 1
          fi

          patch=$((10#$patch + 1))
          novaVersao="${major}.${minor}.${patch}"
          echo "$novaVersao" > "$arquivoVersao"

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add "$arquivoVersao"
          git commit -m "chore: atualiza versao para ${novaVersao} [skip ci]"
          git push origin "${GITHUB_REF_NAME}"

          # Garante que o compose tenha acesso ao TUNNEL_TOKEN (e demais variaveis)
          if [ -f /home/srv/g3/.env ]; then
            cp /home/srv/g3/.env ./.env
          fi

          COMPOSE="docker compose -p g3 -f docker-compose.yml"
          if [ -f docker-compose.tunnel.yml ]; then
            COMPOSE="$COMPOSE -f docker-compose.tunnel.yml"
          fi
          $COMPOSE down --remove-orphans
          $COMPOSE up -d --build --force-recreate --remove-orphans

          echo "Aguardando backend subir..."
          for i in {1..20}; do
            if curl -fsS http://localhost:8080/health > /dev/null; then
              echo "Backend respondeu /health"
              break
            fi
            sleep 3
          done

          if ! curl -fsS http://localhost:8080/health > /dev/null; then
            echo "Erro: backend nao respondeu /health"
            exit 1
          fi

          echo "Aguardando frontend subir..."
          for i in {1..20}; do
            if curl -fsS http://localhost/ > /dev/null; then
              echo "Frontend respondeu"
              break
            fi
            sleep 3
          done

          if ! curl -fsS http://localhost/ > /dev/null; then
            echo "Erro: frontend nao respondeu"
            exit 1
          fi
