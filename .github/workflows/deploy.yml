name: Deploy Docker G3

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  deploy:
    runs-on: self-hosted
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout do codigo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Incrementar versao e atualizar containers
        run: |
          set -euo pipefail

          arquivoVersao="backend/src/main/resources/static/version.txt"

          if [ ! -f "$arquivoVersao" ]; then
            echo "Arquivo de versao nao encontrado: $arquivoVersao"
            exit 1
          fi

          versaoAtual=$(cat "$arquivoVersao" | tr -d '[:space:]')
          major=$(echo "$versaoAtual" | cut -d. -f1)
          minor=$(echo "$versaoAtual" | cut -d. -f2)
          patch=$(echo "$versaoAtual" | cut -d. -f3)

          if [ -z "$major" ] || [ -z "$minor" ] || [ -z "$patch" ]; then
            echo "Formato de versao invalido: $versaoAtual"
            exit 1
          fi

          patch=$((10#$patch + 1))
          novaVersao="${major}.${minor}.${patch}"
          echo "$novaVersao" > "$arquivoVersao"

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add "$arquivoVersao"
          git commit -m "chore: atualiza versao para ${novaVersao} [skip ci]"
          git push origin "${GITHUB_REF_NAME}"

          docker compose down --remove-orphans
          docker compose up -d --build --remove-orphans

          echo "Aguardando backend subir..."
          for i in {1..20}; do
            if curl -fsS http://localhost:8080/health > /dev/null; then
              echo "Backend respondeu /health"
              break
            fi
            sleep 3
          done

          if ! curl -fsS http://localhost:8080/health > /dev/null; then
            echo "Erro: backend nao respondeu /health"
            exit 1
          fi

          if ! curl -fsS http://localhost/ > /dev/null; then
            echo "Erro: frontend nao respondeu"
            exit 1
          fi
