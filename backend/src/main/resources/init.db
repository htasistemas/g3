-- Arquivo SQL idempotente executado no startup
CREATE EXTENSION IF NOT EXISTS unaccent;
CREATE TABLE IF NOT EXISTS unidade_assistencial (
  id BIGSERIAL PRIMARY KEY,
  nome_fantasia VARCHAR(200) NOT NULL,
  razao_social VARCHAR(200),
  cnpj VARCHAR(20),
  email VARCHAR(150),
  telefone VARCHAR(30),
  horario_funcionamento VARCHAR(120),
  observacoes TEXT,
  unidade_principal BOOLEAN NOT NULL DEFAULT FALSE,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS tarefas_pendencias (
  id BIGSERIAL PRIMARY KEY,
  titulo VARCHAR(200) NOT NULL,
  descricao TEXT NOT NULL,
  responsavel VARCHAR(150) NOT NULL,
  prioridade VARCHAR(20) NOT NULL,
  prazo DATE,
  status VARCHAR(40) NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS tarefas_pendencias_checklist (
  id BIGSERIAL PRIMARY KEY,
  tarefa_id BIGINT NOT NULL REFERENCES tarefas_pendencias(id) ON DELETE CASCADE,
  titulo VARCHAR(200) NOT NULL,
  concluido BOOLEAN NOT NULL DEFAULT FALSE,
  concluido_em TIMESTAMP,
  ordem INTEGER NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS tarefas_pendencias_historico (
  id BIGSERIAL PRIMARY KEY,
  tarefa_id BIGINT NOT NULL REFERENCES tarefas_pendencias(id) ON DELETE CASCADE,
  mensagem VARCHAR(500) NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS autorizacao_compras (
  id BIGSERIAL PRIMARY KEY,
  titulo VARCHAR(255) NOT NULL,
  tipo VARCHAR(30) NOT NULL,
  area VARCHAR(150),
  responsavel VARCHAR(150),
  data_prevista DATE,
  valor NUMERIC(14, 2),
  quantidade_itens INTEGER NOT NULL DEFAULT 1,
  justificativa TEXT,
  centro_custo VARCHAR(60),
  prioridade VARCHAR(20) NOT NULL DEFAULT 'normal',
  status VARCHAR(40) NOT NULL,
  aprovador VARCHAR(150),
  decisao VARCHAR(30),
  observacoes_aprovacao TEXT,
  data_aprovacao DATE,
  dispensar_cotacao BOOLEAN NOT NULL DEFAULT FALSE,
  motivo_dispensa TEXT,
  vencedor VARCHAR(255),
  registro_patrimonio BOOLEAN NOT NULL DEFAULT FALSE,
  registro_almoxarifado BOOLEAN NOT NULL DEFAULT FALSE,
  numero_reserva VARCHAR(60),
  autorizacao_pagamento_numero VARCHAR(100),
  autorizacao_pagamento_autor VARCHAR(150),
  autorizacao_pagamento_data DATE,
  autorizacao_pagamento_observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS autorizacao_compras_cotacoes (
  id BIGSERIAL PRIMARY KEY,
  autorizacao_compra_id BIGINT NOT NULL REFERENCES autorizacao_compras(id) ON DELETE CASCADE,
  fornecedor VARCHAR(200) NOT NULL,
  razao_social VARCHAR(200),
  cnpj VARCHAR(20),
  cartao_cnpj_url VARCHAR(400),
  cartao_cnpj_nome VARCHAR(255),
  cartao_cnpj_tipo VARCHAR(100),
  cartao_cnpj_conteudo TEXT,
  valor NUMERIC(14, 2) NOT NULL,
  prazo_entrega DATE,
  validade DATE,
  conformidade VARCHAR(30),
  observacoes TEXT,
  orcamento_fisico_nome VARCHAR(255),
  orcamento_fisico_tipo VARCHAR(100),
  orcamento_fisico_conteudo TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS endereco (
  id BIGSERIAL PRIMARY KEY,
  cep VARCHAR(20),
  logradouro VARCHAR(200),
  numero VARCHAR(20),
  complemento VARCHAR(150),
  bairro VARCHAR(150),
  ponto_referencia VARCHAR(200),
  cidade VARCHAR(150),
  zona VARCHAR(60),
  estado VARCHAR(2),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS cadastro_beneficiario (
  id BIGSERIAL PRIMARY KEY,
  codigo VARCHAR(20),
  nome_completo VARCHAR(200) NOT NULL,
  nome_social VARCHAR(200),
  apelido VARCHAR(120),
  data_nascimento DATE NOT NULL,
  foto_3x4 TEXT,
  sexo_biologico VARCHAR(60),
  identidade_genero VARCHAR(120),
  cor_raca VARCHAR(60),
  estado_civil VARCHAR(60),
  nacionalidade VARCHAR(120),
  naturalidade_cidade VARCHAR(150),
  naturalidade_uf VARCHAR(2),
  nome_mae VARCHAR(200) NOT NULL,
  nome_pai VARCHAR(200),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS cadastro_profissionais (
  id BIGSERIAL PRIMARY KEY,
  nome_completo VARCHAR(200) NOT NULL,
  cpf VARCHAR(20),
  nome_social VARCHAR(200),
  apelido VARCHAR(120),
  data_nascimento DATE,
  foto_3x4 TEXT,
  sexo_biologico VARCHAR(60),
  identidade_genero VARCHAR(120),
  cor_raca VARCHAR(60),
  estado_civil VARCHAR(60),
  nacionalidade VARCHAR(120),
  naturalidade_cidade VARCHAR(150),
  naturalidade_uf VARCHAR(2),
  nome_mae VARCHAR(200),
  nome_pai VARCHAR(200),
  vinculo VARCHAR(40),
  categoria VARCHAR(120) NOT NULL,
  registro_conselho VARCHAR(120),
  especialidade VARCHAR(120),
  email VARCHAR(150),
  telefone VARCHAR(30),
  unidade VARCHAR(200),
  sala_atendimento VARCHAR(120),
  carga_horaria INTEGER,
  disponibilidade TEXT,
  canais_atendimento TEXT,
  status VARCHAR(60),
  tags TEXT,
  resumo TEXT,
  observacoes TEXT,
  endereco_id BIGINT REFERENCES endereco(id) ON DELETE SET NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS versao_sistema (
  id BIGSERIAL PRIMARY KEY,
  versao VARCHAR(50) NOT NULL,
  descricao TEXT,
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS historico_versao_sistema (
  id BIGSERIAL PRIMARY KEY,
  versao VARCHAR(50) NOT NULL,
  descricao TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

INSERT INTO versao_sistema (id, versao, descricao, atualizado_em)
SELECT 1, '1.0.0', 'Vers√£o inicial do sistema.', NOW()
WHERE NOT EXISTS (SELECT 1 FROM versao_sistema);

UPDATE versao_sistema
SET versao = '1.00.7',
    descricao = 'Padronizacao dos botoes de navegacao (Buscar, Novo, Salvar, Cancelar, Excluir, Imprimir, Fechar) e ajustes nas telas de Banco de Empregos, Contabilidade, Transparencia, Termos de Fomento, Plano de Trabalho e Fotos e Eventos.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.00.7';

UPDATE versao_sistema
SET versao = '1.00.0'
WHERE id = 1
  AND versao = '1.0.0';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.00.7', 'Padronizacao dos botoes de navegacao (Buscar, Novo, Salvar, Cancelar, Excluir, Imprimir, Fechar) e ajustes nas telas de Banco de Empregos, Contabilidade, Transparencia, Termos de Fomento, Plano de Trabalho e Fotos e Eventos.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.00.7'
    AND descricao = 'Padronizacao dos botoes de navegacao (Buscar, Novo, Salvar, Cancelar, Excluir, Imprimir, Fechar) e ajustes nas telas de Banco de Empregos, Contabilidade, Transparencia, Termos de Fomento, Plano de Trabalho e Fotos e Eventos.'
);

UPDATE historico_versao_sistema
SET versao = '1.00.0'
WHERE versao = '1.0.0';

UPDATE historico_versao_sistema
SET versao = '1.00.5'
WHERE versao = '1.0.5';


CREATE TABLE IF NOT EXISTS cadastro_voluntario (
  id BIGSERIAL PRIMARY KEY,
  profissional_id BIGINT REFERENCES cadastro_profissionais(id) ON DELETE SET NULL,
  nome_completo VARCHAR(200) NOT NULL,
  cpf VARCHAR(20) NOT NULL,
  rg VARCHAR(20),
  foto_3x4 TEXT,
  endereco_id BIGINT REFERENCES endereco(id) ON DELETE SET NULL,
  data_nascimento DATE,
  genero VARCHAR(60),
  profissao VARCHAR(120),
  motivacao TEXT,
  telefone VARCHAR(30),
  email VARCHAR(150) NOT NULL,
  cidade VARCHAR(150),
  estado VARCHAR(2),
  area_interesse VARCHAR(150),
  habilidades TEXT,
  idiomas TEXT,
  linkedin VARCHAR(200),
  status VARCHAR(60) NOT NULL DEFAULT 'ATIVO',
  disponibilidade_dias TEXT,
  disponibilidade_periodos TEXT,
  carga_horaria_semanal VARCHAR(50),
  presencial BOOLEAN DEFAULT FALSE,
  remoto BOOLEAN DEFAULT FALSE,
  inicio_previsto DATE,
  observacoes TEXT,
  documento_identificacao TEXT,
  comprovante_endereco TEXT,
  aceite_voluntariado BOOLEAN NOT NULL DEFAULT FALSE,
  aceite_imagem BOOLEAN NOT NULL DEFAULT FALSE,
  assinatura_digital TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS almoxarifado_item (
  id BIGSERIAL PRIMARY KEY,
  codigo VARCHAR(30) NOT NULL UNIQUE,
  codigo_barras VARCHAR(60) UNIQUE,
  descricao VARCHAR(200) NOT NULL,
  categoria VARCHAR(120) NOT NULL,
  unidade VARCHAR(60) NOT NULL,
  localizacao VARCHAR(120),
  localizacao_interna VARCHAR(120),
  estoque_atual INTEGER NOT NULL DEFAULT 0,
  estoque_minimo INTEGER NOT NULL DEFAULT 0,
  valor_unitario NUMERIC(12, 2) NOT NULL DEFAULT 0,
  situacao VARCHAR(20) NOT NULL,
  validade DATE,
  ignorar_validade BOOLEAN NOT NULL DEFAULT FALSE,
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS almoxarifado_movimentacao (
  id BIGSERIAL PRIMARY KEY,
  item_id BIGINT NOT NULL REFERENCES almoxarifado_item(id) ON DELETE CASCADE,
  data_movimentacao DATE NOT NULL,
  tipo VARCHAR(20) NOT NULL,
  quantidade INTEGER NOT NULL,
  saldo_apos INTEGER NOT NULL,
  referencia VARCHAR(150),
  responsavel VARCHAR(150),
  observacoes TEXT,
  direcao_ajuste VARCHAR(20),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS imagens_unidade (
  id BIGSERIAL PRIMARY KEY,
  unidade_id BIGINT NOT NULL UNIQUE,
  logomarca TEXT,
  logomarca_relatorio TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  FOREIGN KEY (unidade_id) REFERENCES unidade_assistencial(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS diretoria_unidade (
  id BIGSERIAL PRIMARY KEY,
  unidade_id BIGINT NOT NULL,
  nome_completo VARCHAR(200) NOT NULL,
  documento VARCHAR(60) NOT NULL,
  funcao VARCHAR(120) NOT NULL,
  mandato_inicio VARCHAR(9),
  mandato_fim VARCHAR(9),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  FOREIGN KEY (unidade_id) REFERENCES unidade_assistencial(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS salas_unidade (
  id BIGSERIAL PRIMARY KEY,
  unidade_id BIGINT NOT NULL,
  nome VARCHAR(120) NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  FOREIGN KEY (unidade_id) REFERENCES unidade_assistencial(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS usuarios (
    id BIGSERIAL PRIMARY KEY,
    nome_usuario VARCHAR(120) NOT NULL,
    nome VARCHAR(150),
    email VARCHAR(150),
    senha_hash VARCHAR(255) NOT NULL,
    criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
    atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
  );

ALTER TABLE usuarios
  ADD COLUMN IF NOT EXISTS nome VARCHAR(150);

ALTER TABLE usuarios
  ADD COLUMN IF NOT EXISTS email VARCHAR(150);

CREATE UNIQUE INDEX IF NOT EXISTS usuarios_nome_usuario_unique ON usuarios (nome_usuario);
CREATE UNIQUE INDEX IF NOT EXISTS usuarios_email_unique ON usuarios (email);

CREATE TABLE IF NOT EXISTS usuario_recuperacao_senha (
    id BIGSERIAL PRIMARY KEY,
    usuario_id BIGINT NOT NULL REFERENCES usuarios(id) ON DELETE CASCADE,
    token VARCHAR(120) NOT NULL,
    expira_em TIMESTAMP NOT NULL,
    usado_em TIMESTAMP,
    criado_em TIMESTAMP NOT NULL DEFAULT NOW()
  );

CREATE UNIQUE INDEX IF NOT EXISTS usuario_recuperacao_senha_token_unique
  ON usuario_recuperacao_senha (token);
CREATE INDEX IF NOT EXISTS usuario_recuperacao_senha_usuario_idx
  ON usuario_recuperacao_senha (usuario_id);

INSERT INTO usuarios (nome_usuario, senha_hash)
VALUES ('admin', '$2b$12$5TpCYArxeCzM9aE6yrSVeOmdONYrVZwXRqUXwhEqOh11IUkCo23sq')
ON CONFLICT (nome_usuario) DO NOTHING;

CREATE TABLE IF NOT EXISTS permissao (
  id BIGSERIAL PRIMARY KEY,
  nome VARCHAR(60) NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS usuario_permissao (
  usuario_id BIGINT NOT NULL,
  permissao_id BIGINT NOT NULL,
  PRIMARY KEY (usuario_id, permissao_id),
  FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE CASCADE,
  FOREIGN KEY (permissao_id) REFERENCES permissao(id)
);

INSERT INTO permissao (nome)
VALUES
  ('ADMINISTRADOR'),
  ('OPERADOR'),
  ('LEITURA_APENAS')
ON CONFLICT (nome) DO NOTHING;

INSERT INTO usuario_permissao (usuario_id, permissao_id)
SELECT u.id, p.id
FROM usuarios u
JOIN permissao p ON p.nome = 'ADMINISTRADOR'
WHERE u.nome_usuario = 'admin'
ON CONFLICT DO NOTHING;

ALTER TABLE unidade_assistencial
  ADD COLUMN IF NOT EXISTS nome_fantasia VARCHAR(200);

ALTER TABLE unidade_assistencial
  ADD COLUMN IF NOT EXISTS razao_social VARCHAR(200);

ALTER TABLE unidade_assistencial
  ADD COLUMN IF NOT EXISTS horario_funcionamento VARCHAR(120);

ALTER TABLE unidade_assistencial
  ADD COLUMN IF NOT EXISTS observacoes TEXT;

ALTER TABLE unidade_assistencial
  ADD COLUMN IF NOT EXISTS unidade_principal BOOLEAN NOT NULL DEFAULT FALSE;

ALTER TABLE usuarios
  ADD COLUMN IF NOT EXISTS nome_usuario VARCHAR(120);

ALTER TABLE usuarios
  ADD COLUMN IF NOT EXISTS nome VARCHAR(150);

ALTER TABLE usuarios
  ADD COLUMN IF NOT EXISTS email VARCHAR(150);

ALTER TABLE usuarios
  ADD COLUMN IF NOT EXISTS senha_hash VARCHAR(255);

ALTER TABLE usuarios
  ADD COLUMN IF NOT EXISTS criado_em TIMESTAMP NOT NULL DEFAULT NOW();

ALTER TABLE usuarios
  ADD COLUMN IF NOT EXISTS atualizado_em TIMESTAMP NOT NULL DEFAULT NOW();

ALTER TABLE autorizacao_compras
  ADD COLUMN IF NOT EXISTS quantidade_itens INTEGER NOT NULL DEFAULT 1;

ALTER TABLE autorizacao_compras
  ADD COLUMN IF NOT EXISTS prioridade VARCHAR(20) NOT NULL DEFAULT 'normal';

ALTER TABLE autorizacao_compras_cotacoes
  ADD COLUMN IF NOT EXISTS cartao_cnpj_url VARCHAR(400);

ALTER TABLE autorizacao_compras_cotacoes
  ADD COLUMN IF NOT EXISTS cartao_cnpj_nome VARCHAR(255);

ALTER TABLE autorizacao_compras_cotacoes
  ADD COLUMN IF NOT EXISTS cartao_cnpj_tipo VARCHAR(100);

ALTER TABLE autorizacao_compras_cotacoes
  ADD COLUMN IF NOT EXISTS cartao_cnpj_conteudo TEXT;

ALTER TABLE unidade_assistencial
  ADD COLUMN IF NOT EXISTS endereco_id BIGINT REFERENCES endereco(id) ON DELETE SET NULL;

ALTER TABLE diretoria_unidade
  ADD COLUMN IF NOT EXISTS mandato_inicio VARCHAR(9);

ALTER TABLE diretoria_unidade
  ADD COLUMN IF NOT EXISTS mandato_fim VARCHAR(9);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS codigo VARCHAR(20);

UPDATE cadastro_beneficiario
SET codigo = LPAD(id::text, 4, '0')
WHERE codigo IS NULL OR TRIM(codigo) = '';

UPDATE cadastro_beneficiario
SET codigo = LPAD(sequencia::text, 4, '0')
FROM (
  SELECT id, ROW_NUMBER() OVER (ORDER BY id) AS sequencia
  FROM cadastro_beneficiario
) AS ordenado
WHERE cadastro_beneficiario.id = ordenado.id;

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS nome_completo VARCHAR(200);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS nome_social VARCHAR(200);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS apelido VARCHAR(120);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS data_nascimento DATE;

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS foto_3x4 TEXT;

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS sexo_biologico VARCHAR(60);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS identidade_genero VARCHAR(120);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS cor_raca VARCHAR(60);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS estado_civil VARCHAR(60);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS nacionalidade VARCHAR(120);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS naturalidade_cidade VARCHAR(150);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS naturalidade_uf VARCHAR(2);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS nome_mae VARCHAR(200);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS nome_pai VARCHAR(200);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS status VARCHAR(60);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS opta_receber_cesta_basica BOOLEAN;

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS apto_receber_cesta_basica BOOLEAN;

UPDATE cadastro_beneficiario
SET status = 'EM_ANALISE'
WHERE status IS NULL OR TRIM(status) = '';

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS nome_completo VARCHAR(200);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS cpf VARCHAR(20);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS nome_social VARCHAR(200);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS apelido VARCHAR(120);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS data_nascimento DATE;

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS foto_3x4 TEXT;

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS sexo_biologico VARCHAR(60);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS identidade_genero VARCHAR(120);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS cor_raca VARCHAR(60);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS estado_civil VARCHAR(60);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS nacionalidade VARCHAR(120);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS naturalidade_cidade VARCHAR(150);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS naturalidade_uf VARCHAR(2);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS nome_mae VARCHAR(200);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS nome_pai VARCHAR(200);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS vinculo VARCHAR(40);

UPDATE cadastro_profissionais
SET vinculo = 'VOLUNTARIO'
WHERE vinculo IS NULL OR TRIM(vinculo) = '';

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS profissional_id BIGINT REFERENCES cadastro_profissionais(id) ON DELETE SET NULL;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS nome_completo VARCHAR(200);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS cpf VARCHAR(20);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS rg VARCHAR(20);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS foto_3x4 TEXT;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS endereco_id BIGINT REFERENCES endereco(id) ON DELETE SET NULL;

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS codigo VARCHAR(30);

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS descricao VARCHAR(200);

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS codigo_barras VARCHAR(60);

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS categoria VARCHAR(120);

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS unidade VARCHAR(60);

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS localizacao VARCHAR(120);

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS localizacao_interna VARCHAR(120);

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS estoque_atual INTEGER;

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS estoque_minimo INTEGER;

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS valor_unitario NUMERIC(12, 2);

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS situacao VARCHAR(20);

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS validade DATE;

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS ignorar_validade BOOLEAN DEFAULT FALSE;

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS observacoes TEXT;

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS criado_em TIMESTAMP NOT NULL DEFAULT NOW();

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS atualizado_em TIMESTAMP NOT NULL DEFAULT NOW();

CREATE UNIQUE INDEX IF NOT EXISTS almoxarifado_item_codigo_barras_unique
  ON almoxarifado_item (codigo_barras);

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS item_id BIGINT REFERENCES almoxarifado_item(id) ON DELETE CASCADE;

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS data_movimentacao DATE;

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS tipo VARCHAR(20);

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS quantidade INTEGER;

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS saldo_apos INTEGER;

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS referencia VARCHAR(150);

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS responsavel VARCHAR(150);

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS observacoes TEXT;

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS direcao_ajuste VARCHAR(20);

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS criado_em TIMESTAMP NOT NULL DEFAULT NOW();

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS data_nascimento DATE;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS genero VARCHAR(60);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS profissao VARCHAR(120);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS motivacao TEXT;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS telefone VARCHAR(30);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS email VARCHAR(150);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS cidade VARCHAR(150);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS estado VARCHAR(2);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS area_interesse VARCHAR(150);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS habilidades TEXT;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS idiomas TEXT;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS linkedin VARCHAR(200);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS disponibilidade_dias TEXT;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS disponibilidade_periodos TEXT;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS carga_horaria_semanal VARCHAR(50);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS presencial BOOLEAN DEFAULT FALSE;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS remoto BOOLEAN DEFAULT FALSE;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS inicio_previsto DATE;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS observacoes TEXT;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS documento_identificacao TEXT;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS comprovante_endereco TEXT;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS aceite_voluntariado BOOLEAN NOT NULL DEFAULT FALSE;
ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS status VARCHAR(60) DEFAULT 'ATIVO';

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS aceite_imagem BOOLEAN NOT NULL DEFAULT FALSE;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS assinatura_digital TEXT;

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS categoria VARCHAR(120);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS registro_conselho VARCHAR(120);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS especialidade VARCHAR(120);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS email VARCHAR(150);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS telefone VARCHAR(30);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS unidade VARCHAR(200);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS sala_atendimento VARCHAR(120);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS carga_horaria INTEGER;

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS disponibilidade TEXT;

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS canais_atendimento TEXT;

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS status VARCHAR(60);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS tags TEXT;

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS resumo TEXT;

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS observacoes TEXT;

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS endereco_id BIGINT REFERENCES endereco(id) ON DELETE SET NULL;

ALTER TABLE endereco
  ADD COLUMN IF NOT EXISTS complemento VARCHAR(150);

ALTER TABLE endereco
  ADD COLUMN IF NOT EXISTS ponto_referencia VARCHAR(200);

ALTER TABLE endereco
  ADD COLUMN IF NOT EXISTS zona VARCHAR(60);

ALTER TABLE endereco
  ADD COLUMN IF NOT EXISTS subzona VARCHAR(60);

ALTER TABLE endereco
  ADD COLUMN IF NOT EXISTS latitude NUMERIC(10, 6);

ALTER TABLE endereco
  ADD COLUMN IF NOT EXISTS longitude NUMERIC(10, 6);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS endereco_id BIGINT REFERENCES endereco(id) ON DELETE SET NULL;

CREATE TABLE IF NOT EXISTS contato_beneficiario (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  telefone_principal VARCHAR(30),
  telefone_principal_whatsapp BOOLEAN DEFAULT FALSE,
  telefone_secundario VARCHAR(30),
  telefone_recado_nome VARCHAR(150),
  telefone_recado_numero VARCHAR(30),
  email VARCHAR(150),
  permite_contato_tel BOOLEAN DEFAULT FALSE,
  permite_contato_whatsapp BOOLEAN DEFAULT FALSE,
  permite_contato_sms BOOLEAN DEFAULT FALSE,
  permite_contato_email BOOLEAN DEFAULT FALSE,
  horario_preferencial_contato VARCHAR(80),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS documentos (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  tipo_documento VARCHAR(80),
  numero_documento VARCHAR(80),
  orgao_emissor VARCHAR(120),
  uf_emissor VARCHAR(2),
  data_emissao DATE,
  livro VARCHAR(40),
  folha VARCHAR(40),
  termo VARCHAR(60),
  cartorio VARCHAR(150),
  municipio VARCHAR(150),
  uf VARCHAR(2),
  nome_documento VARCHAR(200),
  nome_arquivo VARCHAR(200),
  caminho_arquivo VARCHAR(400),
  content_type VARCHAR(120),
  obrigatorio BOOLEAN DEFAULT FALSE,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS situacao_social (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  mora_com_familia BOOLEAN DEFAULT FALSE,
  responsavel_legal BOOLEAN DEFAULT FALSE,
  vinculo_familiar VARCHAR(150),
  situacao_vulnerabilidade TEXT,
  composicao_familiar TEXT,
  criancas_adolescentes INTEGER,
  idosos INTEGER,
  acompanhamento_cras BOOLEAN DEFAULT FALSE,
  acompanhamento_saude BOOLEAN DEFAULT FALSE,
  participa_comunidade VARCHAR(200),
  rede_apoio TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS escolaridade_beneficiario (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  sabe_ler_escrever BOOLEAN DEFAULT FALSE,
  nivel_escolaridade VARCHAR(150),
  estuda_atualmente BOOLEAN DEFAULT FALSE,
  ocupacao VARCHAR(150),
  situacao_trabalho VARCHAR(150),
  local_trabalho VARCHAR(150),
  renda_mensal VARCHAR(60),
  fonte_renda VARCHAR(150),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS saude_beneficiario (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  possui_deficiencia BOOLEAN DEFAULT FALSE,
  tipo_deficiencia VARCHAR(200),
  cid_principal VARCHAR(60),
  usa_medicacao_continua BOOLEAN DEFAULT FALSE,
  descricao_medicacao TEXT,
  servico_saude_referencia VARCHAR(200),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS beneficios_beneficiario (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  recebe_beneficio BOOLEAN DEFAULT FALSE,
  beneficios_descricao TEXT,
  valor_total_beneficios VARCHAR(60),
  beneficios_recebidos TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS observacoes_beneficiario (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  aceite_lgpd BOOLEAN DEFAULT FALSE,
  data_aceite_lgpd DATE,
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS vinculo_familiar (
  id BIGSERIAL PRIMARY KEY,
  nome_familia VARCHAR(200) NOT NULL,
  id_referencia_familiar BIGINT REFERENCES cadastro_beneficiario(id) ON DELETE SET NULL,
  status VARCHAR(60) NOT NULL DEFAULT 'ATIVO',
  cep VARCHAR(20),
  logradouro VARCHAR(200),
  numero VARCHAR(20),
  complemento VARCHAR(150),
  bairro VARCHAR(150),
  ponto_referencia VARCHAR(200),
  municipio VARCHAR(150),
  uf VARCHAR(2),
  zona VARCHAR(60),
  situacao_imovel VARCHAR(120),
  tipo_moradia VARCHAR(120),
  agua_encanada BOOLEAN DEFAULT FALSE,
  esgoto_tipo VARCHAR(120),
  coleta_lixo VARCHAR(120),
  energia_eletrica BOOLEAN DEFAULT FALSE,
  internet BOOLEAN DEFAULT FALSE,
  arranjo_familiar VARCHAR(200),
  qtd_membros INTEGER,
  qtd_criancas INTEGER,
  qtd_adolescentes INTEGER,
  qtd_idosos INTEGER,
  qtd_pessoas_deficiencia INTEGER,
  renda_familiar_total VARCHAR(60),
  renda_per_capita VARCHAR(60),
  faixa_renda_per_capita VARCHAR(120),
  principais_fontes_renda TEXT,
  situacao_inseguranca_alimentar TEXT,
  possui_dividas_relevantes BOOLEAN DEFAULT FALSE,
  descricao_dividas TEXT,
  vulnerabilidades_familia TEXT,
  servicos_acompanhamento TEXT,
  tecnico_responsavel VARCHAR(150),
  periodicidade_atendimento VARCHAR(120),
  proxima_visita_prevista DATE,
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS vinculo_familiar_membro (
  id BIGSERIAL PRIMARY KEY,
  vinculo_familiar_id BIGINT NOT NULL REFERENCES vinculo_familiar(id) ON DELETE CASCADE,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  parentesco VARCHAR(120),
  responsavel_familiar BOOLEAN DEFAULT FALSE,
  contribui_renda BOOLEAN DEFAULT FALSE,
  renda_individual VARCHAR(60),
  participa_servicos BOOLEAN DEFAULT FALSE,
  observacoes TEXT,
  usa_endereco_familia BOOLEAN DEFAULT TRUE,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE vinculo_familiar
  ADD COLUMN IF NOT EXISTS status VARCHAR(60) DEFAULT 'ATIVO';

CREATE TABLE IF NOT EXISTS doacao_realizada (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT REFERENCES cadastro_beneficiario(id) ON DELETE SET NULL,
  vinculo_familiar_id BIGINT REFERENCES vinculo_familiar(id) ON DELETE SET NULL,
  tipo_doacao VARCHAR(120) NOT NULL,
  situacao VARCHAR(60) NOT NULL,
  responsavel VARCHAR(150),
  observacoes TEXT,
  data_doacao DATE NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS doacao_realizada_item (
  id BIGSERIAL PRIMARY KEY,
  doacao_realizada_id BIGINT NOT NULL REFERENCES doacao_realizada(id) ON DELETE CASCADE,
  almoxarifado_item_id BIGINT NOT NULL REFERENCES almoxarifado_item(id) ON DELETE RESTRICT,
  quantidade INTEGER NOT NULL,
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS doador (
  id BIGSERIAL PRIMARY KEY,
  nome VARCHAR(200) NOT NULL,
  tipo_pessoa VARCHAR(20),
  documento VARCHAR(30),
  responsavel_empresa VARCHAR(200),
  email VARCHAR(150),
  telefone VARCHAR(30),
  logradouro VARCHAR(200),
  numero VARCHAR(40),
  complemento VARCHAR(120),
  bairro VARCHAR(120),
  cidade VARCHAR(120),
  uf VARCHAR(2),
  cep VARCHAR(12),
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE doador
  ADD COLUMN IF NOT EXISTS responsavel_empresa VARCHAR(200);
ALTER TABLE doador
  ADD COLUMN IF NOT EXISTS logradouro VARCHAR(200);
ALTER TABLE doador
  ADD COLUMN IF NOT EXISTS numero VARCHAR(40);
ALTER TABLE doador
  ADD COLUMN IF NOT EXISTS complemento VARCHAR(120);
ALTER TABLE doador
  ADD COLUMN IF NOT EXISTS bairro VARCHAR(120);
ALTER TABLE doador
  ADD COLUMN IF NOT EXISTS cidade VARCHAR(120);
ALTER TABLE doador
  ADD COLUMN IF NOT EXISTS uf VARCHAR(2);
ALTER TABLE doador
  ADD COLUMN IF NOT EXISTS cep VARCHAR(12);

CREATE TABLE IF NOT EXISTS recebimento_doacao (
  id BIGSERIAL PRIMARY KEY,
  doador_id BIGINT REFERENCES doador(id) ON DELETE SET NULL,
  tipo_doacao VARCHAR(40) NOT NULL,
  descricao TEXT,
  quantidade_itens INTEGER,
  valor_medio NUMERIC(12, 2),
  valor_total NUMERIC(12, 2),
  valor NUMERIC(12, 2),
  data_recebimento DATE NOT NULL,
  forma_recebimento VARCHAR(60),
  recorrente BOOLEAN NOT NULL DEFAULT FALSE,
  periodicidade VARCHAR(40),
  proxima_cobranca DATE,
  status VARCHAR(40) NOT NULL,
  observacoes TEXT,
  contabilidade_pendente BOOLEAN NOT NULL DEFAULT FALSE,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE recebimento_doacao
  ADD COLUMN IF NOT EXISTS quantidade_itens INTEGER;

ALTER TABLE recebimento_doacao
  ADD COLUMN IF NOT EXISTS valor_medio NUMERIC(12, 2);

ALTER TABLE recebimento_doacao
  ADD COLUMN IF NOT EXISTS valor_total NUMERIC(12, 2);

CREATE TABLE IF NOT EXISTS conta_bancaria (
  id BIGSERIAL PRIMARY KEY,
  banco VARCHAR(120) NOT NULL,
  agencia VARCHAR(20),
  numero VARCHAR(40) NOT NULL,
  tipo VARCHAR(30) NOT NULL,
  projeto_vinculado VARCHAR(200),
  pix_vinculado BOOLEAN NOT NULL DEFAULT FALSE,
  tipo_chave_pix VARCHAR(20),
  chave_pix VARCHAR(200),
  saldo NUMERIC(12, 2) NOT NULL DEFAULT 0,
  data_atualizacao DATE NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE conta_bancaria ADD COLUMN IF NOT EXISTS agencia VARCHAR(20);
ALTER TABLE conta_bancaria ADD COLUMN IF NOT EXISTS projeto_vinculado VARCHAR(200);
ALTER TABLE conta_bancaria ADD COLUMN IF NOT EXISTS pix_vinculado BOOLEAN NOT NULL DEFAULT FALSE;
ALTER TABLE conta_bancaria ADD COLUMN IF NOT EXISTS tipo_chave_pix VARCHAR(20);
ALTER TABLE conta_bancaria ADD COLUMN IF NOT EXISTS chave_pix VARCHAR(200);

CREATE TABLE IF NOT EXISTS lancamento_financeiro (
  id BIGSERIAL PRIMARY KEY,
  tipo VARCHAR(20) NOT NULL,
  descricao VARCHAR(200) NOT NULL,
  contraparte VARCHAR(200) NOT NULL,
  vencimento DATE NOT NULL,
  valor NUMERIC(12, 2) NOT NULL,
  situacao VARCHAR(20) NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE autorizacao_compras
  ADD COLUMN IF NOT EXISTS numero_termo VARCHAR(20);

CREATE TABLE IF NOT EXISTS autorizacao_compras_reserva_bancaria (
  id BIGSERIAL PRIMARY KEY,
  autorizacao_compra_id BIGINT NOT NULL REFERENCES autorizacao_compras(id) ON DELETE CASCADE,
  conta_bancaria_id BIGINT NOT NULL REFERENCES conta_bancaria(id) ON DELETE RESTRICT,
  valor NUMERIC(14, 2) NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE lancamento_financeiro
  ADD COLUMN IF NOT EXISTS compra_id BIGINT REFERENCES autorizacao_compras(id) ON DELETE SET NULL;

CREATE TABLE IF NOT EXISTS patrimonio_item (
  id BIGSERIAL PRIMARY KEY,
  numero_patrimonio VARCHAR(60) NOT NULL,
  nome VARCHAR(200) NOT NULL,
  categoria VARCHAR(120),
  subcategoria VARCHAR(120),
  conservacao VARCHAR(60),
  status VARCHAR(60),
  data_aquisicao DATE,
  valor_aquisicao NUMERIC(14, 2),
  origem VARCHAR(120),
  responsavel VARCHAR(150),
  unidade VARCHAR(120),
  sala VARCHAR(120),
  taxa_depreciacao NUMERIC(5, 2),
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS patrimonio_movimentacao (
  id BIGSERIAL PRIMARY KEY,
  patrimonio_id BIGINT NOT NULL REFERENCES patrimonio_item(id) ON DELETE CASCADE,
  tipo VARCHAR(30) NOT NULL,
  destino VARCHAR(150),
  responsavel VARCHAR(150),
  observacao TEXT,
  data_movimento DATE NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE patrimonio_movimentacao
  DROP CONSTRAINT IF EXISTS patrimonio_movimentacao_patrimonio_id_fkey;

ALTER TABLE patrimonio_movimentacao
  ADD CONSTRAINT patrimonio_movimentacao_patrimonio_id_fkey
  FOREIGN KEY (patrimonio_id) REFERENCES patrimonio_item(id) ON DELETE CASCADE;

CREATE TABLE IF NOT EXISTS movimentacao_financeira (
  id BIGSERIAL PRIMARY KEY,
  tipo VARCHAR(20) NOT NULL,
  descricao VARCHAR(200) NOT NULL,
  contraparte VARCHAR(200),
  categoria VARCHAR(80),
  conta_bancaria_id BIGINT REFERENCES conta_bancaria(id) ON DELETE SET NULL,
  data_movimentacao DATE NOT NULL,
  valor NUMERIC(12, 2) NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS emenda_impositiva (
  id BIGSERIAL PRIMARY KEY,
  identificacao VARCHAR(120) NOT NULL,
  referencia_legal VARCHAR(160),
  data_prevista DATE NOT NULL,
  valor_previsto NUMERIC(12, 2) NOT NULL,
  dias_alerta INTEGER NOT NULL DEFAULT 15,
  status VARCHAR(20) NOT NULL,
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS prontuario_registros (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  familia_id BIGINT REFERENCES vinculo_familiar(id) ON DELETE SET NULL,
  tipo VARCHAR(40) NOT NULL,
  data_registro TIMESTAMP NOT NULL,
  profissional_id BIGINT REFERENCES cadastro_profissionais(id) ON DELETE SET NULL,
  unidade_id BIGINT REFERENCES unidade_assistencial(id) ON DELETE SET NULL,
  titulo VARCHAR(200),
  descricao TEXT NOT NULL,
  dados_extra JSONB,
  status VARCHAR(20) NOT NULL DEFAULT 'aberto',
  referencia_origem_tipo VARCHAR(40),
  referencia_origem_id BIGINT,
  nivel_sigilo VARCHAR(30),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  criado_por BIGINT REFERENCES usuarios(id) ON DELETE SET NULL,
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_por BIGINT REFERENCES usuarios(id) ON DELETE SET NULL
);

CREATE INDEX IF NOT EXISTS prontuario_registros_beneficiario_data_idx
  ON prontuario_registros (beneficiario_id, data_registro DESC);
CREATE INDEX IF NOT EXISTS prontuario_registros_tipo_idx
  ON prontuario_registros (tipo);
CREATE INDEX IF NOT EXISTS prontuario_registros_profissional_idx
  ON prontuario_registros (profissional_id);

ALTER TABLE prontuario_registros
  ADD COLUMN IF NOT EXISTS familia_id BIGINT REFERENCES vinculo_familiar(id) ON DELETE SET NULL;

ALTER TABLE prontuario_registros
  ADD COLUMN IF NOT EXISTS referencia_origem_tipo VARCHAR(40);

ALTER TABLE prontuario_registros
  ADD COLUMN IF NOT EXISTS referencia_origem_id BIGINT;

ALTER TABLE prontuario_registros
  ADD COLUMN IF NOT EXISTS nivel_sigilo VARCHAR(30);

CREATE INDEX IF NOT EXISTS prontuario_registros_familia_idx
  ON prontuario_registros (familia_id);

CREATE TABLE IF NOT EXISTS prontuario_anexos (
  id BIGSERIAL PRIMARY KEY,
  registro_id BIGINT NOT NULL REFERENCES prontuario_registros(id) ON DELETE CASCADE,
  nome_arquivo VARCHAR(200) NOT NULL,
  tipo_mime VARCHAR(80),
  url_arquivo TEXT NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS visita_domiciliar (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  unidade VARCHAR(200) NOT NULL,
  responsavel VARCHAR(150) NOT NULL,
  data_visita DATE NOT NULL,
  horario_inicial TIME NOT NULL,
  horario_final TIME,
  tipo_visita VARCHAR(80),
  situacao VARCHAR(30) NOT NULL,
  usar_endereco_beneficiario BOOLEAN NOT NULL DEFAULT TRUE,
  endereco JSONB,
  observacoes_iniciais TEXT,
  condicoes JSONB,
  situacao_social JSONB,
  registro JSONB,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS visita_domiciliar_beneficiario_idx
  ON visita_domiciliar (beneficiario_id);

CREATE INDEX IF NOT EXISTS visita_domiciliar_data_idx
  ON visita_domiciliar (data_visita DESC);

CREATE TABLE IF NOT EXISTS visita_domiciliar_anexo (
  id BIGSERIAL PRIMARY KEY,
  visita_id BIGINT NOT NULL REFERENCES visita_domiciliar(id) ON DELETE CASCADE, 
  nome VARCHAR(200) NOT NULL,
  tipo VARCHAR(60) NOT NULL,
  tamanho VARCHAR(40),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS fotos_eventos (
  id BIGSERIAL PRIMARY KEY,
  unidade_id BIGINT REFERENCES unidade_assistencial(id) ON DELETE SET NULL,
  titulo VARCHAR(200) NOT NULL,
  descricao TEXT,
  data_evento DATE NOT NULL,
  local VARCHAR(200),
  status VARCHAR(20) NOT NULL DEFAULT 'PLANEJADO',
  tags TEXT,
  foto_principal_id BIGINT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  criado_por BIGINT REFERENCES usuarios(id) ON DELETE SET NULL
);

ALTER TABLE IF EXISTS fotos_eventos_fotos RENAME TO fotos_eventos_itens;

CREATE TABLE IF NOT EXISTS fotos_eventos_itens (
  id BIGSERIAL PRIMARY KEY,
  evento_id BIGINT NOT NULL REFERENCES fotos_eventos(id) ON DELETE CASCADE,
  arquivo TEXT NOT NULL,
  nome_arquivo VARCHAR(255),
  mime_type VARCHAR(120),
  tamanho_bytes BIGINT,
  largura INTEGER,
  altura INTEGER,
  legenda TEXT,
  creditos VARCHAR(200),
  tags TEXT,
  ordem INTEGER,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS fotos_eventos_tags (
  id BIGSERIAL PRIMARY KEY,
  evento_id BIGINT NOT NULL REFERENCES fotos_eventos(id) ON DELETE CASCADE,
  tag VARCHAR(120) NOT NULL
);

ALTER TABLE fotos_eventos
  ADD COLUMN IF NOT EXISTS status VARCHAR(20) NOT NULL DEFAULT 'PLANEJADO';
ALTER TABLE fotos_eventos
  ADD COLUMN IF NOT EXISTS tags TEXT;
ALTER TABLE fotos_eventos
  ADD COLUMN IF NOT EXISTS foto_principal_id BIGINT;
ALTER TABLE fotos_eventos
  ADD COLUMN IF NOT EXISTS criado_por BIGINT REFERENCES usuarios(id) ON DELETE SET NULL;
ALTER TABLE fotos_eventos
  ALTER COLUMN tags TYPE TEXT USING convert_from(tags::bytea, 'UTF8');
ALTER TABLE fotos_eventos
  ALTER COLUMN titulo TYPE VARCHAR(200) USING convert_from(titulo::bytea, 'UTF8');
ALTER TABLE fotos_eventos
  ALTER COLUMN descricao TYPE TEXT USING convert_from(descricao::bytea, 'UTF8');
ALTER TABLE fotos_eventos
  ALTER COLUMN local TYPE VARCHAR(200) USING convert_from(local::bytea, 'UTF8');
ALTER TABLE fotos_eventos
  DROP COLUMN IF EXISTS foto_principal;

ALTER TABLE fotos_eventos
  DROP CONSTRAINT IF EXISTS fotos_eventos_foto_principal_id_fkey;
ALTER TABLE fotos_eventos
  ADD CONSTRAINT fotos_eventos_foto_principal_id_fkey
  FOREIGN KEY (foto_principal_id) REFERENCES fotos_eventos_itens(id) ON DELETE SET NULL;

ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS nome_arquivo VARCHAR(255);
ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS mime_type VARCHAR(120);
ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS tamanho_bytes BIGINT;
ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS largura INTEGER;
ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS altura INTEGER;
ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS legenda TEXT;
ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS creditos VARCHAR(200);
ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS tags TEXT;
ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS ordem INTEGER;
ALTER TABLE fotos_eventos_itens
  ALTER COLUMN tags TYPE TEXT;
ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS atualizado_em TIMESTAMP NOT NULL DEFAULT NOW();

CREATE INDEX IF NOT EXISTS fotos_eventos_data_idx
  ON fotos_eventos (data_evento DESC);
CREATE INDEX IF NOT EXISTS fotos_eventos_titulo_idx
  ON fotos_eventos (titulo);
CREATE INDEX IF NOT EXISTS fotos_eventos_tags_evento_idx
  ON fotos_eventos_tags (evento_id);
CREATE INDEX IF NOT EXISTS fotos_eventos_tags_tag_idx
  ON fotos_eventos_tags (tag);

CREATE TABLE IF NOT EXISTS cursos_atendimentos (
  id BIGSERIAL PRIMARY KEY,
  tipo VARCHAR(20) NOT NULL,
  nome VARCHAR(200) NOT NULL,
  descricao TEXT,
  imagem TEXT,
  vagas_totais INTEGER NOT NULL DEFAULT 0,
  vagas_disponiveis INTEGER NOT NULL DEFAULT 0,
  carga_horaria INTEGER,
  horario_inicial TIME,
  duracao_horas INTEGER NOT NULL DEFAULT 0,
  dias_semana TEXT,
  restricoes TEXT,
  profissional VARCHAR(150),
  sala_id BIGINT REFERENCES salas_unidade(id) ON DELETE SET NULL,
  status VARCHAR(30) NOT NULL,
  data_triagem DATE,
  data_encaminhamento DATE,
  data_conclusao DATE,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS cursos_atendimentos_status_idx
  ON cursos_atendimentos (status);
CREATE INDEX IF NOT EXISTS cursos_atendimentos_sala_idx
  ON cursos_atendimentos (sala_id);

CREATE TABLE IF NOT EXISTS cursos_atendimentos_matriculas (
  id BIGSERIAL PRIMARY KEY,
  curso_id BIGINT NOT NULL REFERENCES cursos_atendimentos(id) ON DELETE CASCADE,
  beneficiario_nome VARCHAR(200) NOT NULL,
  cpf VARCHAR(20),
  status VARCHAR(20) NOT NULL,
  data_matricula TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS cursos_atendimentos_fila_espera (
  id BIGSERIAL PRIMARY KEY,
  curso_id BIGINT NOT NULL REFERENCES cursos_atendimentos(id) ON DELETE CASCADE,
  beneficiario_nome VARCHAR(200) NOT NULL,
  cpf VARCHAR(20),
  data_entrada TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS cursos_atendimentos_status (
  id BIGSERIAL PRIMARY KEY,
  curso_id BIGINT NOT NULL REFERENCES cursos_atendimentos(id) ON DELETE CASCADE,
  status VARCHAR(30) NOT NULL,
  data_alteracao TIMESTAMP NOT NULL DEFAULT NOW(),
  justificativa TEXT
);

CREATE TABLE IF NOT EXISTS banco_empregos (
  id BIGSERIAL PRIMARY KEY,
  titulo VARCHAR(200) NOT NULL,
  area VARCHAR(120),
  tipo VARCHAR(80),
  nivel VARCHAR(80),
  modelo VARCHAR(80),
  status VARCHAR(20) NOT NULL,
  data_abertura DATE,
  data_encerramento DATE,
  tipo_contrato VARCHAR(80),
  carga_horaria VARCHAR(80),
  salario VARCHAR(80),
  beneficios TEXT,
  nome_empresa VARCHAR(200),
  cnpj VARCHAR(20),
  responsavel VARCHAR(150),
  telefone VARCHAR(60),
  email VARCHAR(150),
  endereco VARCHAR(200),
  bairro VARCHAR(120),
  cidade VARCHAR(120),
  uf VARCHAR(10),
  escolaridade VARCHAR(120),
  experiencia VARCHAR(200),
  habilidades TEXT,
  requisitos TEXT,
  descricao TEXT,
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE banco_empregos
  ADD COLUMN IF NOT EXISTS data_abertura DATE;
ALTER TABLE banco_empregos
  ADD COLUMN IF NOT EXISTS data_encerramento DATE;
ALTER TABLE banco_empregos
  ADD COLUMN IF NOT EXISTS tipo_contrato VARCHAR(80);
ALTER TABLE banco_empregos
  ADD COLUMN IF NOT EXISTS carga_horaria VARCHAR(80);
ALTER TABLE banco_empregos
  ADD COLUMN IF NOT EXISTS cnpj VARCHAR(20);
ALTER TABLE banco_empregos
  ADD COLUMN IF NOT EXISTS requisitos TEXT;
ALTER TABLE banco_empregos
  ADD COLUMN IF NOT EXISTS observacoes TEXT;

CREATE TABLE IF NOT EXISTS banco_empregos_encaminhamentos (
  id BIGSERIAL PRIMARY KEY,
  emprego_id BIGINT NOT NULL REFERENCES banco_empregos(id) ON DELETE CASCADE,
  beneficiario_id BIGINT REFERENCES cadastro_beneficiario(id) ON DELETE SET NULL,
  beneficiario_nome VARCHAR(200),
  data_encaminhamento DATE NOT NULL,
  status VARCHAR(40) NOT NULL,
  observacoes TEXT
);

CREATE INDEX IF NOT EXISTS banco_empregos_status_idx
  ON banco_empregos (status);
CREATE INDEX IF NOT EXISTS banco_empregos_encaminhamentos_emprego_idx
  ON banco_empregos_encaminhamentos (emprego_id);

CREATE TABLE IF NOT EXISTS termo_fomento (
  id BIGSERIAL PRIMARY KEY,
  numero_termo VARCHAR(120) NOT NULL,
  tipo_termo VARCHAR(20) NOT NULL,
  orgao_concedente VARCHAR(200),
  data_assinatura DATE,
  data_inicio_vigencia DATE,
  data_fim_vigencia DATE,
  situacao VARCHAR(20) NOT NULL,
  descricao_objeto TEXT,
  valor_global NUMERIC(14, 2),
  responsavel_interno VARCHAR(200),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS termo_fomento_aditivos (
  id BIGSERIAL PRIMARY KEY,
  termo_fomento_id BIGINT NOT NULL REFERENCES termo_fomento(id) ON DELETE CASCADE,
  tipo_aditivo VARCHAR(60) NOT NULL,
  data_aditivo DATE NOT NULL,
  nova_data_fim DATE,
  novo_valor NUMERIC(14, 2),
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS termo_fomento_documentos (
  id BIGSERIAL PRIMARY KEY,
  termo_fomento_id BIGINT NOT NULL REFERENCES termo_fomento(id) ON DELETE CASCADE,
  aditivo_id BIGINT REFERENCES termo_fomento_aditivos(id) ON DELETE CASCADE,
  tipo_documento VARCHAR(20) NOT NULL,
  nome VARCHAR(255) NOT NULL,
  data_url TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS termo_fomento_numero_idx
  ON termo_fomento (numero_termo);
CREATE INDEX IF NOT EXISTS termo_fomento_situacao_idx
  ON termo_fomento (situacao);
CREATE INDEX IF NOT EXISTS termo_fomento_documentos_termo_idx
  ON termo_fomento_documentos (termo_fomento_id);
CREATE INDEX IF NOT EXISTS termo_fomento_aditivos_termo_idx
  ON termo_fomento_aditivos (termo_fomento_id);

CREATE TABLE IF NOT EXISTS plano_trabalho (
  id BIGSERIAL PRIMARY KEY,
  codigo_interno VARCHAR(40) NOT NULL,
  titulo VARCHAR(200) NOT NULL,
  descricao_geral TEXT NOT NULL,
  status VARCHAR(20) NOT NULL,
  orgao_concedente VARCHAR(40),
  orgao_outro_descricao VARCHAR(200),
  area_programa VARCHAR(120),
  data_elaboracao DATE,
  data_aprovacao DATE,
  vigencia_inicio DATE,
  vigencia_fim DATE,
  termo_fomento_id BIGINT NOT NULL REFERENCES termo_fomento(id) ON DELETE RESTRICT,
  numero_processo VARCHAR(120),
  modalidade VARCHAR(120),
  observacoes_vinculacao TEXT,
  arquivo_formato VARCHAR(20),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS plano_trabalho_metas (
  id BIGSERIAL PRIMARY KEY,
  plano_trabalho_id BIGINT NOT NULL REFERENCES plano_trabalho(id) ON DELETE CASCADE,
  codigo VARCHAR(60),
  descricao TEXT NOT NULL,
  indicador TEXT,
  unidade_medida VARCHAR(60),
  quantidade_prevista NUMERIC(14, 2),
  resultado_esperado TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS plano_trabalho_atividades (
  id BIGSERIAL PRIMARY KEY,
  meta_id BIGINT NOT NULL REFERENCES plano_trabalho_metas(id) ON DELETE CASCADE,
  descricao TEXT NOT NULL,
  justificativa TEXT,
  publico_alvo TEXT,
  local_execucao TEXT,
  produto_esperado TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS plano_trabalho_etapas (
  id BIGSERIAL PRIMARY KEY,
  atividade_id BIGINT NOT NULL REFERENCES plano_trabalho_atividades(id) ON DELETE CASCADE,
  descricao TEXT NOT NULL,
  status VARCHAR(30),
  data_inicio_prevista DATE,
  data_fim_prevista DATE,
  data_conclusao DATE,
  responsavel VARCHAR(200),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS plano_trabalho_cronograma (
  id BIGSERIAL PRIMARY KEY,
  plano_trabalho_id BIGINT NOT NULL REFERENCES plano_trabalho(id) ON DELETE CASCADE,
  referencia_tipo VARCHAR(40),
  referencia_id VARCHAR(40),
  referencia_descricao TEXT,
  competencia VARCHAR(20) NOT NULL,
  descricao_resumida TEXT,
  valor_previsto NUMERIC(14, 2),
  fonte_recurso VARCHAR(60),
  natureza_despesa VARCHAR(120),
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS plano_trabalho_equipe (
  id BIGSERIAL PRIMARY KEY,
  plano_trabalho_id BIGINT NOT NULL REFERENCES plano_trabalho(id) ON DELETE CASCADE,
  nome VARCHAR(200) NOT NULL,
  funcao VARCHAR(200),
  cpf VARCHAR(20),
  carga_horaria VARCHAR(80),
  tipo_vinculo VARCHAR(120),
  contato VARCHAR(200),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS plano_trabalho_termo_idx
  ON plano_trabalho (termo_fomento_id);
CREATE INDEX IF NOT EXISTS plano_trabalho_status_idx
  ON plano_trabalho (status);
CREATE INDEX IF NOT EXISTS plano_trabalho_metas_plano_idx
  ON plano_trabalho_metas (plano_trabalho_id);
CREATE INDEX IF NOT EXISTS plano_trabalho_atividades_meta_idx
  ON plano_trabalho_atividades (meta_id);
CREATE INDEX IF NOT EXISTS plano_trabalho_etapas_atividade_idx
  ON plano_trabalho_etapas (atividade_id);
CREATE INDEX IF NOT EXISTS plano_trabalho_cronograma_plano_idx
  ON plano_trabalho_cronograma (plano_trabalho_id);
CREATE INDEX IF NOT EXISTS plano_trabalho_equipe_plano_idx
  ON plano_trabalho_equipe (plano_trabalho_id);

CREATE TABLE IF NOT EXISTS transparencia (
  id BIGSERIAL PRIMARY KEY,
  unidade_id BIGINT REFERENCES unidade_assistencial(id) ON DELETE SET NULL,
  total_recebido NUMERIC(14, 2),
  total_recebido_helper VARCHAR(200),
  total_aplicado NUMERIC(14, 2),
  total_aplicado_helper VARCHAR(200),
  saldo_disponivel NUMERIC(14, 2),
  saldo_disponivel_helper VARCHAR(200),
  prestado_mes NUMERIC(14, 2),
  prestado_mes_helper VARCHAR(200),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS transparencia_recebimentos (
  id BIGSERIAL PRIMARY KEY,
  transparencia_id BIGINT NOT NULL REFERENCES transparencia(id) ON DELETE CASCADE,
  fonte VARCHAR(200) NOT NULL,
  valor NUMERIC(14, 2),
  periodicidade VARCHAR(200),
  status VARCHAR(60),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS transparencia_destinacoes (
  id BIGSERIAL PRIMARY KEY,
  transparencia_id BIGINT NOT NULL REFERENCES transparencia(id) ON DELETE CASCADE,
  titulo VARCHAR(200) NOT NULL,
  descricao TEXT,
  percentual INTEGER,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS transparencia_comprovantes (
  id BIGSERIAL PRIMARY KEY,
  transparencia_id BIGINT NOT NULL REFERENCES transparencia(id) ON DELETE CASCADE,
  titulo VARCHAR(200) NOT NULL,
  descricao TEXT,
  arquivo_nome VARCHAR(255),
  arquivo_url TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS transparencia_timelines (
  id BIGSERIAL PRIMARY KEY,
  transparencia_id BIGINT NOT NULL REFERENCES transparencia(id) ON DELETE CASCADE,
  titulo VARCHAR(200) NOT NULL,
  detalhe TEXT,
  status VARCHAR(30),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS transparencia_checklist (
  id BIGSERIAL PRIMARY KEY,
  transparencia_id BIGINT NOT NULL REFERENCES transparencia(id) ON DELETE CASCADE,
  titulo VARCHAR(200) NOT NULL,
  descricao TEXT,
  status VARCHAR(30),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS transparencia_unidade_idx
  ON transparencia (unidade_id);
CREATE INDEX IF NOT EXISTS transparencia_recebimentos_idx
  ON transparencia_recebimentos (transparencia_id);
CREATE INDEX IF NOT EXISTS transparencia_destinacoes_idx
  ON transparencia_destinacoes (transparencia_id);
CREATE INDEX IF NOT EXISTS transparencia_comprovantes_idx
  ON transparencia_comprovantes (transparencia_id);
CREATE INDEX IF NOT EXISTS transparencia_timelines_idx
  ON transparencia_timelines (transparencia_id);
CREATE INDEX IF NOT EXISTS transparencia_checklist_idx
  ON transparencia_checklist (transparencia_id);
