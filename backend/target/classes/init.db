-- Arquivo SQL idempotente executado no startup
CREATE EXTENSION IF NOT EXISTS unaccent;
CREATE TABLE IF NOT EXISTS unidade_assistencial (  
  id BIGSERIAL PRIMARY KEY,
  nome_fantasia VARCHAR(200) NOT NULL,
  razao_social VARCHAR(200),
  cnpj VARCHAR(20),
  email VARCHAR(150),
  site VARCHAR(200),
  telefone VARCHAR(30),
  horario_funcionamento VARCHAR(120),
  observacoes TEXT,
  unidade_principal BOOLEAN NOT NULL DEFAULT FALSE,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS tarefas_pendencias (
  id BIGSERIAL PRIMARY KEY,
  titulo VARCHAR(200) NOT NULL,
  descricao TEXT NOT NULL,
  responsavel VARCHAR(150) NOT NULL,
  prioridade VARCHAR(20) NOT NULL,
  prazo DATE,
  status VARCHAR(40) NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS tarefas_pendencias_checklist (
  id BIGSERIAL PRIMARY KEY,
  tarefa_id BIGINT NOT NULL REFERENCES tarefas_pendencias(id) ON DELETE CASCADE,
  titulo VARCHAR(200) NOT NULL,
  concluido BOOLEAN NOT NULL DEFAULT FALSE,
  concluido_em TIMESTAMP,
  ordem INTEGER NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS tarefas_pendencias_historico (
  id BIGSERIAL PRIMARY KEY,
  tarefa_id BIGINT NOT NULL REFERENCES tarefas_pendencias(id) ON DELETE CASCADE,
  mensagem VARCHAR(500) NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS autorizacao_compras (
  id BIGSERIAL PRIMARY KEY,
  titulo VARCHAR(255) NOT NULL,
  tipo VARCHAR(30) NOT NULL,
  area VARCHAR(150),
  responsavel VARCHAR(150),
  data_prevista DATE,
  valor NUMERIC(14, 2),
  quantidade_itens INTEGER NOT NULL DEFAULT 1,
  justificativa TEXT,
  centro_custo VARCHAR(60),
  prioridade VARCHAR(20) NOT NULL DEFAULT 'normal',
  status VARCHAR(40) NOT NULL,
  aprovador VARCHAR(150),
  decisao VARCHAR(30),
  observacoes_aprovacao TEXT,
  data_aprovacao DATE,
  dispensar_cotacao BOOLEAN NOT NULL DEFAULT FALSE,
  motivo_dispensa TEXT,
  vencedor VARCHAR(255),
  registro_patrimonio BOOLEAN NOT NULL DEFAULT FALSE,
  registro_almoxarifado BOOLEAN NOT NULL DEFAULT FALSE,
  numero_reserva VARCHAR(60),
  autorizacao_pagamento_numero VARCHAR(100),
  autorizacao_pagamento_autor VARCHAR(150),
  autorizacao_pagamento_data DATE,
  autorizacao_pagamento_observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS autorizacao_compras_cotacoes (
  id BIGSERIAL PRIMARY KEY,
  autorizacao_compra_id BIGINT NOT NULL REFERENCES autorizacao_compras(id) ON DELETE CASCADE,
  fornecedor VARCHAR(200) NOT NULL,
  razao_social VARCHAR(200),
  cnpj VARCHAR(20),
  cartao_cnpj_url VARCHAR(400),
  cartao_cnpj_nome VARCHAR(255),
  cartao_cnpj_tipo VARCHAR(100),
  cartao_cnpj_conteudo TEXT,
  valor NUMERIC(14, 2) NOT NULL,
  prazo_entrega DATE,
  validade DATE,
  conformidade VARCHAR(30),
  observacoes TEXT,
  orcamento_fisico_nome VARCHAR(255),
  orcamento_fisico_tipo VARCHAR(100),
  orcamento_fisico_conteudo TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS endereco (
  id BIGSERIAL PRIMARY KEY,
  cep VARCHAR(20),
  logradouro VARCHAR(200),
  numero VARCHAR(20),
  complemento VARCHAR(150),
  bairro VARCHAR(150),
  ponto_referencia VARCHAR(200),
  cidade VARCHAR(150),
  zona VARCHAR(60),
  estado VARCHAR(2),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS cadastro_beneficiario (
  id BIGSERIAL PRIMARY KEY,
  codigo VARCHAR(20),
  nome_completo VARCHAR(200) NOT NULL,
  nome_social VARCHAR(200),
  apelido VARCHAR(120),
  data_nascimento DATE NOT NULL,
  foto_3x4 TEXT,
  sexo_biologico VARCHAR(60),
  identidade_genero VARCHAR(120),
  cor_raca VARCHAR(60),
  estado_civil VARCHAR(60),
  nacionalidade VARCHAR(120),
  naturalidade_cidade VARCHAR(150),
  naturalidade_uf VARCHAR(2),
  nome_mae VARCHAR(200) NOT NULL,
  nome_pai VARCHAR(200),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS cadastro_profissionais (
  id BIGSERIAL PRIMARY KEY,
  nome_completo VARCHAR(200) NOT NULL,
  cpf VARCHAR(20),
  nome_social VARCHAR(200),
  apelido VARCHAR(120),
  data_nascimento DATE,
  foto_3x4 TEXT,
  sexo_biologico VARCHAR(60),
  identidade_genero VARCHAR(120),
  cor_raca VARCHAR(60),
  estado_civil VARCHAR(60),
  nacionalidade VARCHAR(120),
  naturalidade_cidade VARCHAR(150),
  naturalidade_uf VARCHAR(2),
  nome_mae VARCHAR(200),
  nome_pai VARCHAR(200),
  vinculo VARCHAR(40),
  categoria VARCHAR(120) NOT NULL,
  registro_conselho VARCHAR(120),
  especialidade VARCHAR(120),
  email VARCHAR(150),
  telefone VARCHAR(30),
  unidade VARCHAR(200),
  sala_atendimento VARCHAR(120),
  carga_horaria INTEGER,
  disponibilidade TEXT,
  canais_atendimento TEXT,
  status VARCHAR(60),
  tags TEXT,
  resumo TEXT,
  observacoes TEXT,
  endereco_id BIGINT REFERENCES endereco(id) ON DELETE SET NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS versao_sistema (
  id BIGSERIAL PRIMARY KEY,
  versao VARCHAR(50) NOT NULL,
  descricao TEXT,
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS historico_versao_sistema (
  id BIGSERIAL PRIMARY KEY,
  versao VARCHAR(50) NOT NULL,
  descricao TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS lembretes_diarios (
  id BIGSERIAL PRIMARY KEY,
  titulo VARCHAR(200) NOT NULL,
  descricao TEXT,
  data_inicial DATE NOT NULL,
  recorrencia VARCHAR(20) NOT NULL,
  hora_aviso TIME,
  status VARCHAR(20) NOT NULL,
  proxima_execucao_em TIMESTAMP NOT NULL,
  adiado_ate TIMESTAMP,
  concluido_em TIMESTAMP,
  deletado_em TIMESTAMP,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS gerenciamento_dados (
  id BIGSERIAL PRIMARY KEY,
  frequencia VARCHAR(20) NOT NULL,
  horario_execucao VARCHAR(8) NOT NULL,
  horario_incremental VARCHAR(8) NOT NULL,
  retencao_dias INTEGER NOT NULL,
  automacao_ativa BOOLEAN NOT NULL DEFAULT TRUE,
  limite_banda INTEGER NOT NULL DEFAULT 65,
  pausar_horario_comercial BOOLEAN NOT NULL DEFAULT TRUE,
  provedor VARCHAR(20) NOT NULL,
  caminho_destino VARCHAR(200),
  bucket_nome VARCHAR(120),
  criptografia BOOLEAN NOT NULL DEFAULT TRUE,
  compressao VARCHAR(20) NOT NULL,
  verificar_integridade BOOLEAN NOT NULL DEFAULT TRUE,
  email_notificacao VARCHAR(160),
  copia_externa BOOLEAN NOT NULL DEFAULT TRUE,
  alertas BOOLEAN NOT NULL DEFAULT TRUE,
  deteccao_anomalia BOOLEAN NOT NULL DEFAULT TRUE,
  auto_verificacao BOOLEAN NOT NULL DEFAULT TRUE,
  integracoes VARCHAR(40),
  simulacao_retencao BOOLEAN NOT NULL DEFAULT TRUE,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS gerenciamento_dados_backup (
  id BIGSERIAL PRIMARY KEY,
  codigo VARCHAR(30) NOT NULL,
  rotulo VARCHAR(200) NOT NULL,
  tipo VARCHAR(20) NOT NULL,
  status VARCHAR(20) NOT NULL,
  iniciado_em TIMESTAMP NOT NULL,
  armazenado_em VARCHAR(60),
  tamanho VARCHAR(40),
  criptografado BOOLEAN NOT NULL DEFAULT FALSE,
  retencao_dias INTEGER NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

INSERT INTO versao_sistema (id, versao, descricao, atualizado_em)
SELECT 1, '1.0.0', 'VersÃƒÂ£o inicial do sistema.', NOW()
WHERE NOT EXISTS (SELECT 1 FROM versao_sistema);

INSERT INTO gerenciamento_dados (
  id,
  frequencia,
  horario_execucao,
  horario_incremental,
  retencao_dias,
  automacao_ativa,
  limite_banda,
  pausar_horario_comercial,
  provedor,
  caminho_destino,
  bucket_nome,
  criptografia,
  compressao,
  verificar_integridade,
  email_notificacao,
  copia_externa,
  alertas,
  deteccao_anomalia,
  auto_verificacao,
  integracoes,
  simulacao_retencao,
  criado_em,
  atualizado_em
)
SELECT
  1,
  'diario',
  '02:00',
  '13:00',
  15,
  TRUE,
  65,
  TRUE,
  'hibrido',
  'C:\\Backup G3',
  'g3-operacional',
  TRUE,
  'balanceada',
  TRUE,
  'operacoes@sistema.local',
  TRUE,
  TRUE,
  TRUE,
  TRUE,
  'Email',
  TRUE,
  NOW(),
  NOW()
WHERE NOT EXISTS (SELECT 1 FROM gerenciamento_dados);

UPDATE gerenciamento_dados
SET caminho_destino = 'C:\\Backup G3',
    atualizado_em = NOW()
WHERE caminho_destino IS NULL
   OR caminho_destino = '/var/backups';

UPDATE versao_sistema
SET versao = '1.1.0',
    descricao = 'Ajustes no chamado tecnico (destino de envio, detalhes no historico e filtros por status), melhorias no controle de estoque (mascara do valor unitario, entrada de produtos, opcoes de categoria/unidade/localizacao e dashboard como primeira aba) e correcao do botao Fechar.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.0';

UPDATE versao_sistema
SET versao = '1.1.5',
    descricao = 'Gestao de oficios e documentos com anexos de imagens, dashboard de acompanhamento, cadastro de feriados para calculo de prazos em dias uteis e ajustes no rodape/assinaturas e anexos.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.5';

UPDATE versao_sistema
SET versao = '1.1.6',
    descricao = 'Registro de presenca em cursos e atendimentos com persistencia no banco e lista de presenca para impressao.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.6';

UPDATE versao_sistema
SET versao = '1.1.7',
    descricao = 'Ajustes no fluxo de restauracao de backups para garantir substituicao completa dos dados.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.7';

UPDATE versao_sistema
SET versao = '1.1.8',
    descricao = 'Dashboard com indicadores visuais na tela de emprestimo para eventos.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.8';

UPDATE versao_sistema
SET versao = '1.1.9',
    descricao = 'Ajustes visuais e de fluxo na lista de documentos institucionais.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.9';

UPDATE versao_sistema
SET versao = '1.1.10',
    descricao = 'Aviso de agendamento na agenda de emprestimos para eventos.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.10';

UPDATE versao_sistema
SET versao = '1.1.11',
    descricao = 'Aviso de agendamento com responsavel na agenda de emprestimos para eventos.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.11';

UPDATE versao_sistema
SET versao = '1.1.12',
    descricao = 'Aviso de agendamento com evento na agenda de emprestimos para eventos.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.12';

UPDATE versao_sistema
SET versao = '1.1.13',
    descricao = 'Popup de impressao e termo juridico no emprestimo para eventos.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.13';

UPDATE versao_sistema
SET versao = '1.1.14',
    descricao = 'Endpoint resumido de beneficiarios para painel de chamadas e ajuste de CORS.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.14';

UPDATE versao_sistema
SET versao = '1.1.15',
    descricao = 'Ajuste de rota para evitar conflito no resumo de beneficiarios.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.15';

UPDATE versao_sistema
SET versao = '1.1.16',
    descricao = 'Persistencia dos documentos institucionais e registros de anexos/historico.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.16';

UPDATE versao_sistema
SET versao = '1.1.17',
    descricao = 'Upload e visualizacao de anexos de documentos institucionais com armazenamento local.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.17';

UPDATE versao_sistema
SET versao = '1.1.18',
    descricao = 'Importacao da lista de beneficiarios a partir do relatorio em PDF.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.18';

UPDATE versao_sistema
SET versao = '1.1.19',
    descricao = 'Exibicao do codigo do beneficiario na listagem.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.19';

UPDATE versao_sistema
SET versao = '1.1.20',
    descricao = 'Dashboard de assistencia com card de bens cadastrados no patrimonio.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.20';

UPDATE versao_sistema
SET versao = '1.1.21',
    descricao = 'Correcao da listagem de bens no controle patrimonial.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.21';

UPDATE versao_sistema
SET versao = '1.1.22',
    descricao = 'Correcao da geracao de ficha individual de beneficiario.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.22';

UPDATE versao_sistema
SET versao = '1.1.23',
    descricao = 'Ajuste de template de relatorio para evitar erro de formatacao.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.23';

UPDATE versao_sistema
SET versao = '1.1.24',
    descricao = 'Ajustes na ficha do beneficiario com campos preenchidos e layout paginado.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.24';

UPDATE versao_sistema
SET versao = '1.1.25',
    descricao = 'Indicadores da assistencia exibindo contagem por idade.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.25';

UPDATE versao_sistema
SET versao = '1.1.26',
    descricao = 'Ajustes visuais na ficha do beneficiario com cards e cabecalho.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.26';

UPDATE versao_sistema
SET versao = '1.1.27',
    descricao = 'Indicadores com visualizacao didatica da faixa etaria por idade.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.27';

UPDATE versao_sistema
SET versao = '1.1.28',
    descricao = 'Ficha cadastral do beneficiario ajustada para o modelo do PDF.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.28';

UPDATE versao_sistema
SET versao = '1.1.29',
    descricao = 'Ajustes de cabecalho e layout na ficha cadastral do beneficiario.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.29';

UPDATE versao_sistema
SET versao = '1.1.30',
    descricao = 'Ficha cadastral com campos condicionais e termo simplificado.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.30';

UPDATE versao_sistema
SET versao = '1.1.31',
    descricao = 'Cabecalho da ficha com razao social alinhada a logomarca.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.31';

UPDATE versao_sistema
SET versao = '1.1.32',
    descricao = 'Ficha cadastral com idade e ajustes de cabecalho.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.32';

UPDATE versao_sistema
SET versao = '1.1.33',
    descricao = 'Ficha cadastral com ajustes no cabecalho e CPF formatado.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.33';

UPDATE versao_sistema
SET versao = '1.1.34',
    descricao = 'Razao social centralizada no cabecalho da ficha cadastral.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.34';

UPDATE versao_sistema
SET versao = '1.1.35',
    descricao = 'Ficha cadastral com campos em negrito e ajustes finais.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.35';

UPDATE versao_sistema
SET versao = '1.1.36',
    descricao = 'Ficha cadastral com espacamento reduzido nos campos.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.36';

UPDATE versao_sistema
SET versao = '1.1.37',
    descricao = 'Termo de consentimento sem tabela apos assinaturas.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.37';

UPDATE versao_sistema
SET versao = '1.1.38',
    descricao = 'Termo de consentimento sem titulo de modelo.',
    atualizado_em = NOW()
WHERE id = 1
  AND versao <> '1.1.38';

UPDATE versao_sistema
SET versao = '1.0.0'
WHERE id = 1
  AND versao = '1.00.0';

UPDATE versao_sistema
SET versao = regexp_replace(versao, '^1\.00\.(\d+)$', '1.0.\1')
WHERE versao ~ '^1\.00\.\d+$';

UPDATE versao_sistema
SET versao = regexp_replace(versao, '^1\.01\.(\d+)$', '1.1.\1')
WHERE versao ~ '^1\.01\.\d+$';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.0', 'Ajustes no chamado tecnico (destino de envio, detalhes no historico e filtros por status), melhorias no controle de estoque (mascara do valor unitario, entrada de produtos, opcoes de categoria/unidade/localizacao e dashboard como primeira aba) e correcao do botao Fechar.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.0'
    AND descricao = 'Ajustes no chamado tecnico (destino de envio, detalhes no historico e filtros por status), melhorias no controle de estoque (mascara do valor unitario, entrada de produtos, opcoes de categoria/unidade/localizacao e dashboard como primeira aba) e correcao do botao Fechar.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.2', 'Melhorias na tela de oficios e documentos (fluxo de cadastro, impressao padrao do oficio, anexos de PDF assinado, ajustes de layout e validacoes).', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.2'
    AND descricao = 'Melhorias na tela de oficios e documentos (fluxo de cadastro, impressao padrao do oficio, anexos de PDF assinado, ajustes de layout e validacoes).'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.3', 'Correcao de registros duplicados de versao e ajustes no fluxo de impressao/rodape do oficio.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.3'
    AND descricao = 'Correcao de registros duplicados de versao e ajustes no fluxo de impressao/rodape do oficio.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.4', 'Inclusao de anexos de imagens em oficios, dashboard de acompanhamento, cadastro de feriados e calculo de prazos em dias uteis.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.4'
    AND descricao = 'Inclusao de anexos de imagens em oficios, dashboard de acompanhamento, cadastro de feriados e calculo de prazos em dias uteis.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.16', 'Persistencia dos documentos institucionais e registros de anexos/historico.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.16'
    AND descricao = 'Persistencia dos documentos institucionais e registros de anexos/historico.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.17', 'Upload e visualizacao de anexos de documentos institucionais com armazenamento local.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.17'
    AND descricao = 'Upload e visualizacao de anexos de documentos institucionais com armazenamento local.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.18', 'Importacao da lista de beneficiarios a partir do relatorio em PDF.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.18'
    AND descricao = 'Importacao da lista de beneficiarios a partir do relatorio em PDF.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.19', 'Exibicao do codigo do beneficiario na listagem.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.19'
    AND descricao = 'Exibicao do codigo do beneficiario na listagem.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.20', 'Dashboard de assistencia com card de bens cadastrados no patrimonio.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.20'
    AND descricao = 'Dashboard de assistencia com card de bens cadastrados no patrimonio.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.21', 'Correcao da listagem de bens no controle patrimonial.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.21'
    AND descricao = 'Correcao da listagem de bens no controle patrimonial.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.22', 'Correcao da geracao de ficha individual de beneficiario.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.22'
    AND descricao = 'Correcao da geracao de ficha individual de beneficiario.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.23', 'Ajuste de template de relatorio para evitar erro de formatacao.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.23'
    AND descricao = 'Ajuste de template de relatorio para evitar erro de formatacao.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.24', 'Ajustes na ficha do beneficiario com campos preenchidos e layout paginado.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.24'
    AND descricao = 'Ajustes na ficha do beneficiario com campos preenchidos e layout paginado.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.25', 'Indicadores da assistencia exibindo contagem por idade.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.25'
    AND descricao = 'Indicadores da assistencia exibindo contagem por idade.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.26', 'Ajustes visuais na ficha do beneficiario com cards e cabecalho.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.26'
    AND descricao = 'Ajustes visuais na ficha do beneficiario com cards e cabecalho.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.27', 'Indicadores com visualizacao didatica da faixa etaria por idade.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.27'
    AND descricao = 'Indicadores com visualizacao didatica da faixa etaria por idade.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.28', 'Ficha cadastral do beneficiario ajustada para o modelo do PDF.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.28'
    AND descricao = 'Ficha cadastral do beneficiario ajustada para o modelo do PDF.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.29', 'Ajustes de cabecalho e layout na ficha cadastral do beneficiario.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.29'
    AND descricao = 'Ajustes de cabecalho e layout na ficha cadastral do beneficiario.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.30', 'Ficha cadastral com campos condicionais e termo simplificado.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.30'
    AND descricao = 'Ficha cadastral com campos condicionais e termo simplificado.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.31', 'Cabecalho da ficha com razao social alinhada a logomarca.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.31'
    AND descricao = 'Cabecalho da ficha com razao social alinhada a logomarca.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.32', 'Ficha cadastral com idade e ajustes de cabecalho.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.32'
    AND descricao = 'Ficha cadastral com idade e ajustes de cabecalho.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.33', 'Ficha cadastral com ajustes no cabecalho e CPF formatado.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.33'
    AND descricao = 'Ficha cadastral com ajustes no cabecalho e CPF formatado.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.34', 'Razao social centralizada no cabecalho da ficha cadastral.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.34'
    AND descricao = 'Razao social centralizada no cabecalho da ficha cadastral.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.35', 'Ficha cadastral com campos em negrito e ajustes finais.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.35'
    AND descricao = 'Ficha cadastral com campos em negrito e ajustes finais.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.36', 'Ficha cadastral com espacamento reduzido nos campos.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.36'
    AND descricao = 'Ficha cadastral com espacamento reduzido nos campos.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.37', 'Termo de consentimento sem tabela apos assinaturas.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.37'
    AND descricao = 'Termo de consentimento sem tabela apos assinaturas.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.38', 'Termo de consentimento sem titulo de modelo.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.38'
    AND descricao = 'Termo de consentimento sem titulo de modelo.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.5', 'Ajustes no emprestimo para eventos: popup para criacao/edicao/exclusao de eventos, validacoes detalhadas do cadastro, melhorias de disponibilidade e avisos reposicionados na tela.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.5'
    AND descricao = 'Ajustes no emprestimo para eventos: popup para criacao/edicao/exclusao de eventos, validacoes detalhadas do cadastro, melhorias de disponibilidade e avisos reposicionados na tela.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.6', 'Registro de presenca em cursos e atendimentos com persistencia no banco e lista de presenca para impressao.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.6'
    AND descricao = 'Registro de presenca em cursos e atendimentos com persistencia no banco e lista de presenca para impressao.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.7', 'Ajustes no fluxo de restauracao de backups para garantir substituicao completa dos dados.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.7'
    AND descricao = 'Ajustes no fluxo de restauracao de backups para garantir substituicao completa dos dados.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.8', 'Dashboard com indicadores visuais na tela de emprestimo para eventos.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.8'
    AND descricao = 'Dashboard com indicadores visuais na tela de emprestimo para eventos.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.9', 'Ajustes visuais e de fluxo na lista de documentos institucionais.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.9'
    AND descricao = 'Ajustes visuais e de fluxo na lista de documentos institucionais.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.10', 'Aviso de agendamento na agenda de emprestimos para eventos.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.10'
    AND descricao = 'Aviso de agendamento na agenda de emprestimos para eventos.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.11', 'Aviso de agendamento com responsavel na agenda de emprestimos para eventos.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.11'
    AND descricao = 'Aviso de agendamento com responsavel na agenda de emprestimos para eventos.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.12', 'Aviso de agendamento com evento na agenda de emprestimos para eventos.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.12'
    AND descricao = 'Aviso de agendamento com evento na agenda de emprestimos para eventos.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.13', 'Popup de impressao e termo juridico no emprestimo para eventos.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.13'
    AND descricao = 'Popup de impressao e termo juridico no emprestimo para eventos.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.14', 'Endpoint resumido de beneficiarios para painel de chamadas e ajuste de CORS.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.14'
    AND descricao = 'Endpoint resumido de beneficiarios para painel de chamadas e ajuste de CORS.'
);

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.1.15', 'Ajuste de rota para evitar conflito no resumo de beneficiarios.', NOW()
WHERE NOT EXISTS (
  SELECT 1
  FROM historico_versao_sistema
  WHERE versao = '1.1.15'
    AND descricao = 'Ajuste de rota para evitar conflito no resumo de beneficiarios.'
);

UPDATE historico_versao_sistema
SET versao = '1.0.0'
WHERE versao = '1.00.0';

UPDATE historico_versao_sistema
SET versao = '1.0.5'
WHERE versao = '1.00.5';

UPDATE historico_versao_sistema
SET versao = regexp_replace(versao, '^1\.00\.(\d+)$', '1.0.\1')
WHERE versao ~ '^1\.00\.\d+$';

UPDATE historico_versao_sistema
SET versao = regexp_replace(versao, '^1\.01\.(\d+)$', '1.1.\1')
WHERE versao ~ '^1\.01\.\d+$';


CREATE TABLE IF NOT EXISTS cadastro_voluntario (
  id BIGSERIAL PRIMARY KEY,
  profissional_id BIGINT REFERENCES cadastro_profissionais(id) ON DELETE SET NULL,
  nome_completo VARCHAR(200) NOT NULL,
  cpf VARCHAR(20) NOT NULL,
  rg VARCHAR(20),
  foto_3x4 TEXT,
  endereco_id BIGINT REFERENCES endereco(id) ON DELETE SET NULL,
  data_nascimento DATE,
  genero VARCHAR(60),
  profissao VARCHAR(120),
  motivacao TEXT,
  telefone VARCHAR(30),
  email VARCHAR(150) NOT NULL,
  cidade VARCHAR(150),
  estado VARCHAR(2),
  area_interesse VARCHAR(150),
  habilidades TEXT,
  idiomas TEXT,
  linkedin VARCHAR(200),
  status VARCHAR(60) NOT NULL DEFAULT 'ATIVO',
  disponibilidade_dias TEXT,
  disponibilidade_periodos TEXT,
  carga_horaria_semanal VARCHAR(50),
  presencial BOOLEAN DEFAULT FALSE,
  remoto BOOLEAN DEFAULT FALSE,
  inicio_previsto DATE,
  observacoes TEXT,
  documento_identificacao TEXT,
  comprovante_endereco TEXT,
  aceite_voluntariado BOOLEAN NOT NULL DEFAULT FALSE,
  aceite_imagem BOOLEAN NOT NULL DEFAULT FALSE,
  assinatura_digital TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS almoxarifado_item (
  id BIGSERIAL PRIMARY KEY,
  codigo VARCHAR(30) NOT NULL UNIQUE,
  codigo_barras VARCHAR(60) UNIQUE,
  descricao VARCHAR(200) NOT NULL,
  categoria VARCHAR(120) NOT NULL,
  unidade VARCHAR(60) NOT NULL,
  localizacao VARCHAR(120),
  localizacao_interna VARCHAR(120),
  estoque_atual INTEGER NOT NULL DEFAULT 0,
  estoque_minimo INTEGER NOT NULL DEFAULT 0,
    valor_unitario NUMERIC(12, 2) NOT NULL DEFAULT 0,
    is_kit BOOLEAN NOT NULL DEFAULT FALSE,
    situacao VARCHAR(20) NOT NULL,
  validade DATE,
  ignorar_validade BOOLEAN NOT NULL DEFAULT FALSE,
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

  CREATE TABLE IF NOT EXISTS almoxarifado_movimentacao (
    id BIGSERIAL PRIMARY KEY,
    item_id BIGINT NOT NULL REFERENCES almoxarifado_item(id) ON DELETE CASCADE,
    data_movimentacao DATE NOT NULL,
    tipo VARCHAR(20) NOT NULL,
    quantidade INTEGER NOT NULL,
    saldo_apos INTEGER NOT NULL,
    referencia VARCHAR(150),
    responsavel VARCHAR(150),
    observacoes TEXT,
    direcao_ajuste VARCHAR(20),
    criado_em TIMESTAMP NOT NULL DEFAULT NOW()
  );

  CREATE TABLE IF NOT EXISTS produtos_kit_composicao (
    id BIGSERIAL PRIMARY KEY,
    produto_kit_id BIGINT NOT NULL REFERENCES almoxarifado_item(id) ON DELETE CASCADE,
    produto_item_id BIGINT NOT NULL REFERENCES almoxarifado_item(id) ON DELETE CASCADE,
    quantidade_item NUMERIC(12, 4) NOT NULL,
    ativo BOOLEAN NOT NULL DEFAULT TRUE,
    criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
    atualizado_em TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE (produto_kit_id, produto_item_id)
  );

  CREATE INDEX IF NOT EXISTS produtos_kit_composicao_kit_idx
    ON produtos_kit_composicao (produto_kit_id);

  CREATE TABLE IF NOT EXISTS movimentacao_vinculo_kit (
    id BIGSERIAL PRIMARY KEY,
    movimentacao_principal_id BIGINT NOT NULL REFERENCES almoxarifado_movimentacao(id) ON DELETE CASCADE,
    movimentacao_gerada_id BIGINT NOT NULL REFERENCES almoxarifado_movimentacao(id) ON DELETE CASCADE,
    criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE (movimentacao_principal_id, movimentacao_gerada_id)
  );

  CREATE INDEX IF NOT EXISTS movimentacao_vinculo_kit_principal_idx
    ON movimentacao_vinculo_kit (movimentacao_principal_id);

CREATE TABLE IF NOT EXISTS imagens_unidade (
  id BIGSERIAL PRIMARY KEY,
  unidade_id BIGINT NOT NULL UNIQUE,
  logomarca TEXT,
  logomarca_relatorio TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  FOREIGN KEY (unidade_id) REFERENCES unidade_assistencial(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS diretoria_unidade (
  id BIGSERIAL PRIMARY KEY,
  unidade_id BIGINT NOT NULL,
  nome_completo VARCHAR(200) NOT NULL,
  documento VARCHAR(60) NOT NULL,
  funcao VARCHAR(120) NOT NULL,
  mandato_inicio VARCHAR(9),
  mandato_fim VARCHAR(9),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  FOREIGN KEY (unidade_id) REFERENCES unidade_assistencial(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS salas_unidade (
  id BIGSERIAL PRIMARY KEY,
  unidade_id BIGINT NOT NULL,
  nome VARCHAR(120) NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  FOREIGN KEY (unidade_id) REFERENCES unidade_assistencial(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS usuarios (
    id BIGSERIAL PRIMARY KEY,
    nome_usuario VARCHAR(120) NOT NULL,
    nome VARCHAR(150),
    email VARCHAR(150),
    senha_hash VARCHAR(255) NOT NULL,
    criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
    atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
  );

ALTER TABLE usuarios
  ADD COLUMN IF NOT EXISTS nome VARCHAR(150);

ALTER TABLE usuarios
  ADD COLUMN IF NOT EXISTS email VARCHAR(150);

ALTER TABLE usuarios
  ADD COLUMN IF NOT EXISTS google_id VARCHAR(80);

ALTER TABLE usuarios
  ADD COLUMN IF NOT EXISTS foto_url VARCHAR(255);

CREATE UNIQUE INDEX IF NOT EXISTS usuarios_nome_usuario_unique ON usuarios (nome_usuario);
CREATE UNIQUE INDEX IF NOT EXISTS usuarios_email_unique ON usuarios (email);
CREATE UNIQUE INDEX IF NOT EXISTS usuarios_google_id_unique
  ON usuarios (google_id)
  WHERE google_id IS NOT NULL;

CREATE TABLE IF NOT EXISTS usuario_recuperacao_senha (
    id BIGSERIAL PRIMARY KEY,
    usuario_id BIGINT NOT NULL REFERENCES usuarios(id) ON DELETE CASCADE,
    token VARCHAR(120) NOT NULL,
    expira_em TIMESTAMP NOT NULL,
    usado_em TIMESTAMP,
    criado_em TIMESTAMP NOT NULL DEFAULT NOW()
  );

CREATE UNIQUE INDEX IF NOT EXISTS usuario_recuperacao_senha_token_unique
  ON usuario_recuperacao_senha (token);
CREATE INDEX IF NOT EXISTS usuario_recuperacao_senha_usuario_idx
  ON usuario_recuperacao_senha (usuario_id);

INSERT INTO usuarios (nome_usuario, senha_hash)
VALUES ('admin', '$2b$12$5TpCYArxeCzM9aE6yrSVeOmdONYrVZwXRqUXwhEqOh11IUkCo23sq')
ON CONFLICT (nome_usuario) DO NOTHING;

CREATE TABLE IF NOT EXISTS permissao (
  id BIGSERIAL PRIMARY KEY,
  nome VARCHAR(60) NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS usuario_permissao (
  usuario_id BIGINT NOT NULL,
  permissao_id BIGINT NOT NULL,
  PRIMARY KEY (usuario_id, permissao_id),
  FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE CASCADE,
  FOREIGN KEY (permissao_id) REFERENCES permissao(id)
);

INSERT INTO permissao (nome)
VALUES
  ('ADMINISTRADOR'),
  ('OPERADOR'),
  ('LEITURA_APENAS')
ON CONFLICT (nome) DO NOTHING;

INSERT INTO usuario_permissao (usuario_id, permissao_id)
SELECT u.id, p.id
FROM usuarios u
JOIN permissao p ON p.nome = 'ADMINISTRADOR'
WHERE u.nome_usuario = 'admin'
ON CONFLICT DO NOTHING;

ALTER TABLE unidade_assistencial
  ADD COLUMN IF NOT EXISTS nome_fantasia VARCHAR(200);

ALTER TABLE unidade_assistencial
  ADD COLUMN IF NOT EXISTS razao_social VARCHAR(200);

ALTER TABLE unidade_assistencial
  ADD COLUMN IF NOT EXISTS horario_funcionamento VARCHAR(120);

ALTER TABLE unidade_assistencial
  ADD COLUMN IF NOT EXISTS observacoes TEXT;

ALTER TABLE unidade_assistencial
  ADD COLUMN IF NOT EXISTS site VARCHAR(200);

ALTER TABLE unidade_assistencial
  ADD COLUMN IF NOT EXISTS unidade_principal BOOLEAN NOT NULL DEFAULT FALSE;

ALTER TABLE usuarios
  ADD COLUMN IF NOT EXISTS nome_usuario VARCHAR(120);

ALTER TABLE usuarios
  ADD COLUMN IF NOT EXISTS nome VARCHAR(150);

ALTER TABLE usuarios
  ADD COLUMN IF NOT EXISTS email VARCHAR(150);

ALTER TABLE usuarios
  ADD COLUMN IF NOT EXISTS senha_hash VARCHAR(255);

ALTER TABLE usuarios
  ADD COLUMN IF NOT EXISTS criado_em TIMESTAMP NOT NULL DEFAULT NOW();

ALTER TABLE usuarios
  ADD COLUMN IF NOT EXISTS atualizado_em TIMESTAMP NOT NULL DEFAULT NOW();

ALTER TABLE autorizacao_compras
  ADD COLUMN IF NOT EXISTS quantidade_itens INTEGER NOT NULL DEFAULT 1;

ALTER TABLE autorizacao_compras
  ADD COLUMN IF NOT EXISTS prioridade VARCHAR(20) NOT NULL DEFAULT 'normal';

ALTER TABLE autorizacao_compras_cotacoes
  ADD COLUMN IF NOT EXISTS cartao_cnpj_url VARCHAR(400);

ALTER TABLE autorizacao_compras_cotacoes
  ADD COLUMN IF NOT EXISTS cartao_cnpj_nome VARCHAR(255);

ALTER TABLE autorizacao_compras_cotacoes
  ADD COLUMN IF NOT EXISTS cartao_cnpj_tipo VARCHAR(100);

ALTER TABLE autorizacao_compras_cotacoes
  ADD COLUMN IF NOT EXISTS cartao_cnpj_conteudo TEXT;

ALTER TABLE unidade_assistencial
  ADD COLUMN IF NOT EXISTS endereco_id BIGINT REFERENCES endereco(id) ON DELETE SET NULL;

ALTER TABLE diretoria_unidade
  ADD COLUMN IF NOT EXISTS mandato_inicio VARCHAR(9);

ALTER TABLE diretoria_unidade
  ADD COLUMN IF NOT EXISTS mandato_fim VARCHAR(9);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS codigo VARCHAR(20);

UPDATE cadastro_beneficiario
SET codigo = LPAD(id::text, 4, '0')
WHERE codigo IS NULL OR TRIM(codigo) = '';

UPDATE cadastro_beneficiario
SET codigo = LPAD(sequencia::text, 4, '0')
FROM (
  SELECT id, ROW_NUMBER() OVER (ORDER BY id) AS sequencia
  FROM cadastro_beneficiario
) AS ordenado
WHERE cadastro_beneficiario.id = ordenado.id;

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS nome_completo VARCHAR(200);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS nome_social VARCHAR(200);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS apelido VARCHAR(120);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS data_nascimento DATE;

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS foto_3x4 TEXT;

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS sexo_biologico VARCHAR(60);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS identidade_genero VARCHAR(120);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS cor_raca VARCHAR(60);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS estado_civil VARCHAR(60);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS nacionalidade VARCHAR(120);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS naturalidade_cidade VARCHAR(150);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS naturalidade_uf VARCHAR(2);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS nome_mae VARCHAR(200);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS nome_pai VARCHAR(200);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS status VARCHAR(60);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS opta_receber_cesta_basica BOOLEAN;

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS apto_receber_cesta_basica BOOLEAN;

UPDATE cadastro_beneficiario
SET status = 'EM_ANALISE'
WHERE status IS NULL OR TRIM(status) = '';

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS nome_completo VARCHAR(200);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS cpf VARCHAR(20);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS nome_social VARCHAR(200);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS apelido VARCHAR(120);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS data_nascimento DATE;

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS foto_3x4 TEXT;

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS sexo_biologico VARCHAR(60);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS identidade_genero VARCHAR(120);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS cor_raca VARCHAR(60);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS estado_civil VARCHAR(60);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS nacionalidade VARCHAR(120);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS naturalidade_cidade VARCHAR(150);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS naturalidade_uf VARCHAR(2);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS nome_mae VARCHAR(200);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS nome_pai VARCHAR(200);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS vinculo VARCHAR(40);

UPDATE cadastro_profissionais
SET vinculo = 'VOLUNTARIO'
WHERE vinculo IS NULL OR TRIM(vinculo) = '';

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS profissional_id BIGINT REFERENCES cadastro_profissionais(id) ON DELETE SET NULL;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS nome_completo VARCHAR(200);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS cpf VARCHAR(20);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS rg VARCHAR(20);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS foto_3x4 TEXT;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS endereco_id BIGINT REFERENCES endereco(id) ON DELETE SET NULL;

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS codigo VARCHAR(30);

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS descricao VARCHAR(200);

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS codigo_barras VARCHAR(60);

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS categoria VARCHAR(120);

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS unidade VARCHAR(60);

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS localizacao VARCHAR(120);

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS localizacao_interna VARCHAR(120);

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS estoque_atual INTEGER;

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS estoque_minimo INTEGER;

  ALTER TABLE almoxarifado_item
    ADD COLUMN IF NOT EXISTS valor_unitario NUMERIC(12, 2);

  ALTER TABLE almoxarifado_item
    ADD COLUMN IF NOT EXISTS is_kit BOOLEAN NOT NULL DEFAULT FALSE;

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS situacao VARCHAR(20);

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS validade DATE;

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS ignorar_validade BOOLEAN DEFAULT FALSE;

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS observacoes TEXT;

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS criado_em TIMESTAMP NOT NULL DEFAULT NOW();

ALTER TABLE almoxarifado_item
  ADD COLUMN IF NOT EXISTS atualizado_em TIMESTAMP NOT NULL DEFAULT NOW();

CREATE UNIQUE INDEX IF NOT EXISTS almoxarifado_item_codigo_barras_unique
  ON almoxarifado_item (codigo_barras);

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS item_id BIGINT REFERENCES almoxarifado_item(id) ON DELETE CASCADE;

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS data_movimentacao DATE;

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS tipo VARCHAR(20);

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS quantidade INTEGER;

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS saldo_apos INTEGER;

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS referencia VARCHAR(150);

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS responsavel VARCHAR(150);

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS observacoes TEXT;

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS direcao_ajuste VARCHAR(20);

ALTER TABLE almoxarifado_movimentacao
  ADD COLUMN IF NOT EXISTS criado_em TIMESTAMP NOT NULL DEFAULT NOW();

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS data_nascimento DATE;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS genero VARCHAR(60);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS profissao VARCHAR(120);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS motivacao TEXT;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS telefone VARCHAR(30);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS email VARCHAR(150);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS cidade VARCHAR(150);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS estado VARCHAR(2);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS area_interesse VARCHAR(150);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS habilidades TEXT;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS idiomas TEXT;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS linkedin VARCHAR(200);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS disponibilidade_dias TEXT;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS disponibilidade_periodos TEXT;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS carga_horaria_semanal VARCHAR(50);

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS presencial BOOLEAN DEFAULT FALSE;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS remoto BOOLEAN DEFAULT FALSE;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS inicio_previsto DATE;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS observacoes TEXT;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS documento_identificacao TEXT;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS comprovante_endereco TEXT;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS aceite_voluntariado BOOLEAN NOT NULL DEFAULT FALSE;
ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS status VARCHAR(60) DEFAULT 'ATIVO';

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS aceite_imagem BOOLEAN NOT NULL DEFAULT FALSE;

ALTER TABLE cadastro_voluntario
  ADD COLUMN IF NOT EXISTS assinatura_digital TEXT;

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS categoria VARCHAR(120);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS registro_conselho VARCHAR(120);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS especialidade VARCHAR(120);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS email VARCHAR(150);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS telefone VARCHAR(30);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS unidade VARCHAR(200);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS sala_atendimento VARCHAR(120);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS carga_horaria INTEGER;

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS disponibilidade TEXT;

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS canais_atendimento TEXT;

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS status VARCHAR(60);

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS tags TEXT;

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS resumo TEXT;

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS observacoes TEXT;

ALTER TABLE cadastro_profissionais
  ADD COLUMN IF NOT EXISTS endereco_id BIGINT REFERENCES endereco(id) ON DELETE SET NULL;

ALTER TABLE endereco
  ADD COLUMN IF NOT EXISTS complemento VARCHAR(150);

ALTER TABLE endereco
  ADD COLUMN IF NOT EXISTS ponto_referencia VARCHAR(200);

ALTER TABLE endereco
  ADD COLUMN IF NOT EXISTS zona VARCHAR(60);

ALTER TABLE endereco
  ADD COLUMN IF NOT EXISTS subzona VARCHAR(60);

ALTER TABLE endereco
  ADD COLUMN IF NOT EXISTS latitude NUMERIC(10, 6);

ALTER TABLE endereco
  ADD COLUMN IF NOT EXISTS longitude NUMERIC(10, 6);

ALTER TABLE cadastro_beneficiario
  ADD COLUMN IF NOT EXISTS endereco_id BIGINT REFERENCES endereco(id) ON DELETE SET NULL;

CREATE TABLE IF NOT EXISTS contato_beneficiario (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  telefone_principal VARCHAR(30),
  telefone_principal_whatsapp BOOLEAN DEFAULT FALSE,
  telefone_secundario VARCHAR(30),
  telefone_recado_nome VARCHAR(150),
  telefone_recado_numero VARCHAR(30),
  email VARCHAR(150),
  permite_contato_tel BOOLEAN DEFAULT FALSE,
  permite_contato_whatsapp BOOLEAN DEFAULT FALSE,
  permite_contato_sms BOOLEAN DEFAULT FALSE,
  permite_contato_email BOOLEAN DEFAULT FALSE,
  horario_preferencial_contato VARCHAR(80),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS documentos (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  tipo_documento VARCHAR(80),
  numero_documento VARCHAR(80),
  orgao_emissor VARCHAR(120),
  uf_emissor VARCHAR(2),
  data_emissao DATE,
  livro VARCHAR(40),
  folha VARCHAR(40),
  termo VARCHAR(60),
  cartorio VARCHAR(150),
  municipio VARCHAR(150),
  uf VARCHAR(2),
  nome_documento VARCHAR(200),
  nome_arquivo VARCHAR(200),
  caminho_arquivo VARCHAR(400),
  content_type VARCHAR(120),
  obrigatorio BOOLEAN DEFAULT FALSE,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS situacao_social (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  mora_com_familia BOOLEAN DEFAULT FALSE,
  responsavel_legal BOOLEAN DEFAULT FALSE,
  vinculo_familiar VARCHAR(150),
  situacao_vulnerabilidade TEXT,
  composicao_familiar TEXT,
  criancas_adolescentes INTEGER,
  idosos INTEGER,
  acompanhamento_cras BOOLEAN DEFAULT FALSE,
  acompanhamento_saude BOOLEAN DEFAULT FALSE,
  participa_comunidade VARCHAR(200),
  rede_apoio TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS escolaridade_beneficiario (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  sabe_ler_escrever BOOLEAN DEFAULT FALSE,
  nivel_escolaridade VARCHAR(150),
  estuda_atualmente BOOLEAN DEFAULT FALSE,
  ocupacao VARCHAR(150),
  situacao_trabalho VARCHAR(150),
  local_trabalho VARCHAR(150),
  renda_mensal VARCHAR(60),
  fonte_renda VARCHAR(150),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS saude_beneficiario (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  possui_deficiencia BOOLEAN DEFAULT FALSE,
  tipo_deficiencia VARCHAR(200),
  cid_principal VARCHAR(60),
  usa_medicacao_continua BOOLEAN DEFAULT FALSE,
  descricao_medicacao TEXT,
  servico_saude_referencia VARCHAR(200),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS beneficios_beneficiario (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  recebe_beneficio BOOLEAN DEFAULT FALSE,
  beneficios_descricao TEXT,
  valor_total_beneficios VARCHAR(60),
  beneficios_recebidos TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS observacoes_beneficiario (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  aceite_lgpd BOOLEAN DEFAULT FALSE,
  data_aceite_lgpd DATE,
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS vinculo_familiar (
  id BIGSERIAL PRIMARY KEY,
  nome_familia VARCHAR(200) NOT NULL,
  id_referencia_familiar BIGINT REFERENCES cadastro_beneficiario(id) ON DELETE SET NULL,
  status VARCHAR(60) NOT NULL DEFAULT 'ATIVO',
  cep VARCHAR(20),
  logradouro VARCHAR(200),
  numero VARCHAR(20),
  complemento VARCHAR(150),
  bairro VARCHAR(150),
  ponto_referencia VARCHAR(200),
  municipio VARCHAR(150),
  uf VARCHAR(2),
  zona VARCHAR(60),
  situacao_imovel VARCHAR(120),
  tipo_moradia VARCHAR(120),
  agua_encanada BOOLEAN DEFAULT FALSE,
  esgoto_tipo VARCHAR(120),
  coleta_lixo VARCHAR(120),
  energia_eletrica BOOLEAN DEFAULT FALSE,
  internet BOOLEAN DEFAULT FALSE,
  arranjo_familiar VARCHAR(200),
  qtd_membros INTEGER,
  qtd_criancas INTEGER,
  qtd_adolescentes INTEGER,
  qtd_idosos INTEGER,
  qtd_pessoas_deficiencia INTEGER,
  renda_familiar_total VARCHAR(60),
  renda_per_capita VARCHAR(60),
  faixa_renda_per_capita VARCHAR(120),
  principais_fontes_renda TEXT,
  situacao_inseguranca_alimentar TEXT,
  possui_dividas_relevantes BOOLEAN DEFAULT FALSE,
  descricao_dividas TEXT,
  vulnerabilidades_familia TEXT,
  servicos_acompanhamento TEXT,
  tecnico_responsavel VARCHAR(150),
  periodicidade_atendimento VARCHAR(120),
  proxima_visita_prevista DATE,
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS vinculo_familiar_membro (
  id BIGSERIAL PRIMARY KEY,
  vinculo_familiar_id BIGINT NOT NULL REFERENCES vinculo_familiar(id) ON DELETE CASCADE,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  parentesco VARCHAR(120),
  responsavel_familiar BOOLEAN DEFAULT FALSE,
  contribui_renda BOOLEAN DEFAULT FALSE,
  renda_individual VARCHAR(60),
  participa_servicos BOOLEAN DEFAULT FALSE,
  observacoes TEXT,
  usa_endereco_familia BOOLEAN DEFAULT TRUE,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE vinculo_familiar
  ADD COLUMN IF NOT EXISTS status VARCHAR(60) DEFAULT 'ATIVO';

CREATE TABLE IF NOT EXISTS doacao_realizada (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT REFERENCES cadastro_beneficiario(id) ON DELETE SET NULL,
  vinculo_familiar_id BIGINT REFERENCES vinculo_familiar(id) ON DELETE SET NULL,
  tipo_doacao VARCHAR(120) NOT NULL,
  situacao VARCHAR(60) NOT NULL,
  responsavel VARCHAR(150),
  observacoes TEXT,
  data_doacao DATE NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS doacao_realizada_item (
  id BIGSERIAL PRIMARY KEY,
  doacao_realizada_id BIGINT NOT NULL REFERENCES doacao_realizada(id) ON DELETE CASCADE,
  almoxarifado_item_id BIGINT NOT NULL REFERENCES almoxarifado_item(id) ON DELETE RESTRICT,
  quantidade INTEGER NOT NULL,
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS doador (
  id BIGSERIAL PRIMARY KEY,
  nome VARCHAR(200) NOT NULL,
  tipo_pessoa VARCHAR(20),
  documento VARCHAR(30),
  responsavel_empresa VARCHAR(200),
  email VARCHAR(150),
  telefone VARCHAR(30),
  logradouro VARCHAR(200),
  numero VARCHAR(40),
  complemento VARCHAR(120),
  bairro VARCHAR(120),
  cidade VARCHAR(120),
  uf VARCHAR(2),
  cep VARCHAR(12),
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS alertas_sistema (
  id BIGSERIAL PRIMARY KEY,
  tipo_alerta VARCHAR(80) NOT NULL,
  frequencia_envio VARCHAR(30) NOT NULL,
  ativo BOOLEAN NOT NULL DEFAULT TRUE,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE doador
  ADD COLUMN IF NOT EXISTS responsavel_empresa VARCHAR(200);
ALTER TABLE doador
  ADD COLUMN IF NOT EXISTS logradouro VARCHAR(200);
ALTER TABLE doador
  ADD COLUMN IF NOT EXISTS numero VARCHAR(40);
ALTER TABLE doador
  ADD COLUMN IF NOT EXISTS complemento VARCHAR(120);
ALTER TABLE doador
  ADD COLUMN IF NOT EXISTS bairro VARCHAR(120);
ALTER TABLE doador
  ADD COLUMN IF NOT EXISTS cidade VARCHAR(120);
ALTER TABLE doador
  ADD COLUMN IF NOT EXISTS uf VARCHAR(2);
ALTER TABLE doador
  ADD COLUMN IF NOT EXISTS cep VARCHAR(12);

CREATE TABLE IF NOT EXISTS recebimento_doacao (
  id BIGSERIAL PRIMARY KEY,
  doador_id BIGINT REFERENCES doador(id) ON DELETE SET NULL,
  tipo_doacao VARCHAR(40) NOT NULL,
  descricao TEXT,
  quantidade_itens INTEGER,
  valor_medio NUMERIC(12, 2),
  valor_total NUMERIC(12, 2),
  valor NUMERIC(12, 2),
  data_recebimento DATE NOT NULL,
  forma_recebimento VARCHAR(60),
  recorrente BOOLEAN NOT NULL DEFAULT FALSE,
  periodicidade VARCHAR(40),
  proxima_cobranca DATE,
  status VARCHAR(40) NOT NULL,
  observacoes TEXT,
  contabilidade_pendente BOOLEAN NOT NULL DEFAULT FALSE,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE recebimento_doacao
  ADD COLUMN IF NOT EXISTS quantidade_itens INTEGER;

ALTER TABLE recebimento_doacao
  ADD COLUMN IF NOT EXISTS valor_medio NUMERIC(12, 2);

ALTER TABLE recebimento_doacao
  ADD COLUMN IF NOT EXISTS valor_total NUMERIC(12, 2);

CREATE TABLE IF NOT EXISTS conta_bancaria (
  id BIGSERIAL PRIMARY KEY,
  banco VARCHAR(120) NOT NULL,
  agencia VARCHAR(20),
  numero VARCHAR(40) NOT NULL,
  tipo VARCHAR(30) NOT NULL,
  projeto_vinculado VARCHAR(200),
  pix_vinculado BOOLEAN NOT NULL DEFAULT FALSE,
  tipo_chave_pix VARCHAR(20),
  chave_pix VARCHAR(200),
  saldo NUMERIC(12, 2) NOT NULL DEFAULT 0,
  data_atualizacao DATE NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE conta_bancaria ADD COLUMN IF NOT EXISTS agencia VARCHAR(20);
ALTER TABLE conta_bancaria ADD COLUMN IF NOT EXISTS projeto_vinculado VARCHAR(200);
ALTER TABLE conta_bancaria ADD COLUMN IF NOT EXISTS pix_vinculado BOOLEAN NOT NULL DEFAULT FALSE;
ALTER TABLE conta_bancaria ADD COLUMN IF NOT EXISTS tipo_chave_pix VARCHAR(20);
ALTER TABLE conta_bancaria ADD COLUMN IF NOT EXISTS chave_pix VARCHAR(200);

CREATE TABLE IF NOT EXISTS lancamento_financeiro (
  id BIGSERIAL PRIMARY KEY,
  tipo VARCHAR(20) NOT NULL,
  descricao VARCHAR(200) NOT NULL,
  contraparte VARCHAR(200) NOT NULL,
  vencimento DATE NOT NULL,
  valor NUMERIC(12, 2) NOT NULL,
  situacao VARCHAR(20) NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE autorizacao_compras
  ADD COLUMN IF NOT EXISTS numero_termo VARCHAR(20);

CREATE TABLE IF NOT EXISTS autorizacao_compras_reserva_bancaria (
  id BIGSERIAL PRIMARY KEY,
  autorizacao_compra_id BIGINT NOT NULL REFERENCES autorizacao_compras(id) ON DELETE CASCADE,
  conta_bancaria_id BIGINT NOT NULL REFERENCES conta_bancaria(id) ON DELETE RESTRICT,
  valor NUMERIC(14, 2) NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE lancamento_financeiro
  ADD COLUMN IF NOT EXISTS compra_id BIGINT REFERENCES autorizacao_compras(id) ON DELETE SET NULL;

CREATE TABLE IF NOT EXISTS patrimonio_item (
  id BIGSERIAL PRIMARY KEY,
  numero_patrimonio VARCHAR(60) NOT NULL,
  nome VARCHAR(200) NOT NULL,
  categoria VARCHAR(120),
  subcategoria VARCHAR(120),
  conservacao VARCHAR(60),
  status VARCHAR(60),
  data_aquisicao DATE,
  valor_aquisicao NUMERIC(14, 2),
  origem VARCHAR(120),
  responsavel VARCHAR(150),
  unidade VARCHAR(120),
  sala VARCHAR(120),
  taxa_depreciacao NUMERIC(5, 2),
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS patrimonio_movimentacao (
  id BIGSERIAL PRIMARY KEY,
  patrimonio_id BIGINT NOT NULL REFERENCES patrimonio_item(id) ON DELETE CASCADE,
  tipo VARCHAR(30) NOT NULL,
  destino VARCHAR(150),
  responsavel VARCHAR(150),
  observacao TEXT,
  data_movimento DATE NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE patrimonio_movimentacao
  DROP CONSTRAINT IF EXISTS patrimonio_movimentacao_patrimonio_id_fkey;

ALTER TABLE patrimonio_movimentacao
  ADD CONSTRAINT patrimonio_movimentacao_patrimonio_id_fkey
  FOREIGN KEY (patrimonio_id) REFERENCES patrimonio_item(id) ON DELETE CASCADE;

CREATE TABLE IF NOT EXISTS movimentacao_financeira (
  id BIGSERIAL PRIMARY KEY,
  tipo VARCHAR(20) NOT NULL,
  descricao VARCHAR(200) NOT NULL,
  contraparte VARCHAR(200),
  categoria VARCHAR(80),
  conta_bancaria_id BIGINT REFERENCES conta_bancaria(id) ON DELETE SET NULL,
  data_movimentacao DATE NOT NULL,
  valor NUMERIC(12, 2) NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS emenda_impositiva (
  id BIGSERIAL PRIMARY KEY,
  identificacao VARCHAR(120) NOT NULL,
  referencia_legal VARCHAR(160),
  data_prevista DATE NOT NULL,
  valor_previsto NUMERIC(12, 2) NOT NULL,
  dias_alerta INTEGER NOT NULL DEFAULT 15,
  status VARCHAR(20) NOT NULL,
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS prontuario_registros (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  familia_id BIGINT REFERENCES vinculo_familiar(id) ON DELETE SET NULL,
  tipo VARCHAR(40) NOT NULL,
  data_registro TIMESTAMP NOT NULL,
  profissional_id BIGINT REFERENCES cadastro_profissionais(id) ON DELETE SET NULL,
  unidade_id BIGINT REFERENCES unidade_assistencial(id) ON DELETE SET NULL,
  titulo VARCHAR(200),
  descricao TEXT NOT NULL,
  dados_extra JSONB,
  status VARCHAR(20) NOT NULL DEFAULT 'aberto',
  referencia_origem_tipo VARCHAR(40),
  referencia_origem_id BIGINT,
  nivel_sigilo VARCHAR(30),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  criado_por BIGINT REFERENCES usuarios(id) ON DELETE SET NULL,
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_por BIGINT REFERENCES usuarios(id) ON DELETE SET NULL
);

CREATE INDEX IF NOT EXISTS prontuario_registros_beneficiario_data_idx
  ON prontuario_registros (beneficiario_id, data_registro DESC);

-- Chamados tecnicos
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE TYPE IF NOT EXISTS chamado_tipo AS ENUM ('ERRO', 'MELHORIA');
CREATE TYPE IF NOT EXISTS chamado_status AS ENUM (
  'ABERTO',
  'EM_ANALISE',
  'EM_DESENVOLVIMENTO',
  'EM_TESTE',
  'AGUARDANDO_CLIENTE',
  'RESOLVIDO',
  'CANCELADO'
);
CREATE TYPE IF NOT EXISTS chamado_prioridade AS ENUM ('BAIXA', 'MEDIA', 'ALTA', 'CRITICA');
CREATE TYPE IF NOT EXISTS chamado_impacto AS ENUM ('BAIXO', 'MEDIO', 'ALTO');
CREATE TYPE IF NOT EXISTS chamado_acao_tipo AS ENUM (
  'CRIACAO',
  'COMENTARIO',
  'MUDANCA_STATUS',
  'ATRIBUICAO',
  'ANEXO',
  'EDICAO',
  'VINCULO',
  'REGISTRO_ATIVIDADE'
);

CREATE SEQUENCE IF NOT EXISTS chamado_tecnico_codigo_seq START WITH 1;

CREATE TABLE IF NOT EXISTS chamado_tecnico (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  codigo VARCHAR(20) NOT NULL,
  titulo VARCHAR(200) NOT NULL,
  descricao TEXT NOT NULL,
  tipo chamado_tipo NOT NULL,
  status chamado_status NOT NULL,
  prioridade chamado_prioridade NOT NULL,
  impacto chamado_impacto NOT NULL,
  modulo VARCHAR(120) NOT NULL,
  menu VARCHAR(160) NOT NULL,
  cliente VARCHAR(160) NOT NULL,
  ambiente VARCHAR(40) NOT NULL DEFAULT 'PRODUCAO',
  versao_sistema VARCHAR(40),
  passos_reproducao TEXT,
  resultado_atual TEXT,
  resultado_esperado TEXT,
  usuarios_teste TEXT,
    prazo_sla_em_horas INTEGER,
    data_limite_sla TIMESTAMP,
    resposta_desenvolvedor TEXT,
    respondido_em TIMESTAMP,
    respondido_por_usuario_id BIGINT REFERENCES usuarios(id) ON DELETE SET NULL,
    responsavel_usuario_id BIGINT REFERENCES usuarios(id) ON DELETE SET NULL,
  criado_por_usuario_id BIGINT REFERENCES usuarios(id) ON DELETE SET NULL,
  tags TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE UNIQUE INDEX IF NOT EXISTS chamado_tecnico_codigo_unique ON chamado_tecnico (codigo);
CREATE INDEX IF NOT EXISTS chamado_tecnico_status_idx ON chamado_tecnico (status);
CREATE INDEX IF NOT EXISTS chamado_tecnico_prioridade_idx ON chamado_tecnico (prioridade);
CREATE INDEX IF NOT EXISTS chamado_tecnico_modulo_idx ON chamado_tecnico (modulo);
CREATE INDEX IF NOT EXISTS chamado_tecnico_criado_em_idx ON chamado_tecnico (criado_em);

  ALTER TABLE chamado_tecnico
    ADD COLUMN IF NOT EXISTS resposta_desenvolvedor TEXT;

  ALTER TABLE chamado_tecnico
    ADD COLUMN IF NOT EXISTS respondido_em TIMESTAMP;

  ALTER TABLE chamado_tecnico
    ADD COLUMN IF NOT EXISTS respondido_por_usuario_id BIGINT REFERENCES usuarios(id) ON DELETE SET NULL;

  CREATE TABLE IF NOT EXISTS chamado_tecnico_acao (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  chamado_id UUID NOT NULL REFERENCES chamado_tecnico(id) ON DELETE CASCADE,
  tipo chamado_acao_tipo NOT NULL,
  descricao TEXT NOT NULL,
  de_status chamado_status,
  para_status chamado_status,
  de_responsavel_id BIGINT REFERENCES usuarios(id) ON DELETE SET NULL,
  para_responsavel_id BIGINT REFERENCES usuarios(id) ON DELETE SET NULL,
  criado_por_usuario_id BIGINT REFERENCES usuarios(id) ON DELETE SET NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS chamado_tecnico_acao_chamado_idx ON chamado_tecnico_acao (chamado_id);

CREATE TABLE IF NOT EXISTS chamado_tecnico_comentario (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  chamado_id UUID NOT NULL REFERENCES chamado_tecnico(id) ON DELETE CASCADE,
  comentario TEXT NOT NULL,
  criado_por_usuario_id BIGINT REFERENCES usuarios(id) ON DELETE SET NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS chamado_tecnico_comentario_chamado_idx ON chamado_tecnico_comentario (chamado_id);

CREATE TABLE IF NOT EXISTS chamado_tecnico_anexo (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  chamado_id UUID NOT NULL REFERENCES chamado_tecnico(id) ON DELETE CASCADE,
  nome_arquivo VARCHAR(255),
  mime_type VARCHAR(120),
  tamanho_bytes BIGINT,
  storage_path VARCHAR(600),
  hash_sha256 VARCHAR(120),
  criado_por_usuario_id BIGINT REFERENCES usuarios(id) ON DELETE SET NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS chamado_tecnico_anexo_chamado_idx ON chamado_tecnico_anexo (chamado_id);

CREATE TABLE IF NOT EXISTS auditoria_evento (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  usuario_id BIGINT REFERENCES usuarios(id) ON DELETE SET NULL,
  acao VARCHAR(120) NOT NULL,
  entidade VARCHAR(120) NOT NULL,
  entidade_id VARCHAR(120),
  dados_json JSONB,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS auditoria_evento_usuario_idx ON auditoria_evento (usuario_id);
CREATE INDEX IF NOT EXISTS auditoria_evento_entidade_idx ON auditoria_evento (entidade);
CREATE INDEX IF NOT EXISTS auditoria_evento_criado_em_idx ON auditoria_evento (criado_em);

CREATE TABLE IF NOT EXISTS chamado_tecnico_auditoria_vinculo (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  chamado_id UUID NOT NULL REFERENCES chamado_tecnico(id) ON DELETE CASCADE,
  auditoria_evento_id UUID NOT NULL REFERENCES auditoria_evento(id) ON DELETE CASCADE,
  criado_por_usuario_id BIGINT REFERENCES usuarios(id) ON DELETE SET NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS chamado_tecnico_auditoria_vinculo_chamado_idx
  ON chamado_tecnico_auditoria_vinculo (chamado_id);
CREATE INDEX IF NOT EXISTS prontuario_registros_tipo_idx
  ON prontuario_registros (tipo);
CREATE INDEX IF NOT EXISTS prontuario_registros_profissional_idx
  ON prontuario_registros (profissional_id);

ALTER TABLE prontuario_registros
  ADD COLUMN IF NOT EXISTS familia_id BIGINT REFERENCES vinculo_familiar(id) ON DELETE SET NULL;

ALTER TABLE prontuario_registros
  ADD COLUMN IF NOT EXISTS referencia_origem_tipo VARCHAR(40);

ALTER TABLE prontuario_registros
  ADD COLUMN IF NOT EXISTS referencia_origem_id BIGINT;

ALTER TABLE prontuario_registros
  ADD COLUMN IF NOT EXISTS nivel_sigilo VARCHAR(30);

CREATE INDEX IF NOT EXISTS prontuario_registros_familia_idx
  ON prontuario_registros (familia_id);

CREATE TABLE IF NOT EXISTS prontuario_anexos (
  id BIGSERIAL PRIMARY KEY,
  registro_id BIGINT NOT NULL REFERENCES prontuario_registros(id) ON DELETE CASCADE,
  nome_arquivo VARCHAR(200) NOT NULL,
  tipo_mime VARCHAR(80),
  url_arquivo TEXT NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS visita_domiciliar (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE CASCADE,
  unidade VARCHAR(200) NOT NULL,
  responsavel VARCHAR(150) NOT NULL,
  data_visita DATE NOT NULL,
  horario_inicial TIME NOT NULL,
  horario_final TIME,
  tipo_visita VARCHAR(80),
  situacao VARCHAR(30) NOT NULL,
  usar_endereco_beneficiario BOOLEAN NOT NULL DEFAULT TRUE,
  endereco JSONB,
  observacoes_iniciais TEXT,
  condicoes JSONB,
  situacao_social JSONB,
  registro JSONB,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS visita_domiciliar_beneficiario_idx
  ON visita_domiciliar (beneficiario_id);

CREATE INDEX IF NOT EXISTS visita_domiciliar_data_idx
  ON visita_domiciliar (data_visita DESC);

CREATE TABLE IF NOT EXISTS visita_domiciliar_anexo (
  id BIGSERIAL PRIMARY KEY,
  visita_id BIGINT NOT NULL REFERENCES visita_domiciliar(id) ON DELETE CASCADE, 
  nome VARCHAR(200) NOT NULL,
  tipo VARCHAR(60) NOT NULL,
  tamanho VARCHAR(40),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS fotos_eventos (
  id BIGSERIAL PRIMARY KEY,
  unidade_id BIGINT REFERENCES unidade_assistencial(id) ON DELETE SET NULL,
  titulo VARCHAR(200) NOT NULL,
  descricao TEXT,
  data_evento DATE NOT NULL,
  local VARCHAR(200),
  status VARCHAR(20) NOT NULL DEFAULT 'PLANEJADO',
  tags TEXT,
  foto_principal_id BIGINT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  criado_por BIGINT REFERENCES usuarios(id) ON DELETE SET NULL
);

ALTER TABLE IF EXISTS fotos_eventos_fotos RENAME TO fotos_eventos_itens;

CREATE TABLE IF NOT EXISTS fotos_eventos_itens (
  id BIGSERIAL PRIMARY KEY,
  evento_id BIGINT NOT NULL REFERENCES fotos_eventos(id) ON DELETE CASCADE,
  arquivo TEXT NOT NULL,
  nome_arquivo VARCHAR(255),
  mime_type VARCHAR(120),
  tamanho_bytes BIGINT,
  largura INTEGER,
  altura INTEGER,
  legenda TEXT,
  creditos VARCHAR(200),
  tags TEXT,
  ordem INTEGER,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS fotos_eventos_tags (
  id BIGSERIAL PRIMARY KEY,
  evento_id BIGINT NOT NULL REFERENCES fotos_eventos(id) ON DELETE CASCADE,
  tag VARCHAR(120) NOT NULL
);

ALTER TABLE fotos_eventos
  ADD COLUMN IF NOT EXISTS status VARCHAR(20) NOT NULL DEFAULT 'PLANEJADO';
ALTER TABLE fotos_eventos
  ADD COLUMN IF NOT EXISTS tags TEXT;
ALTER TABLE fotos_eventos
  ADD COLUMN IF NOT EXISTS foto_principal_id BIGINT;
ALTER TABLE fotos_eventos
  ADD COLUMN IF NOT EXISTS criado_por BIGINT REFERENCES usuarios(id) ON DELETE SET NULL;
ALTER TABLE fotos_eventos
  ALTER COLUMN tags TYPE TEXT USING convert_from(tags::bytea, 'UTF8');
ALTER TABLE fotos_eventos
  ALTER COLUMN titulo TYPE VARCHAR(200) USING convert_from(titulo::bytea, 'UTF8');
ALTER TABLE fotos_eventos
  ALTER COLUMN descricao TYPE TEXT USING convert_from(descricao::bytea, 'UTF8');
ALTER TABLE fotos_eventos
  ALTER COLUMN local TYPE VARCHAR(200) USING convert_from(local::bytea, 'UTF8');
ALTER TABLE fotos_eventos
  DROP COLUMN IF EXISTS foto_principal;

ALTER TABLE fotos_eventos
  DROP CONSTRAINT IF EXISTS fotos_eventos_foto_principal_id_fkey;
ALTER TABLE fotos_eventos
  ADD CONSTRAINT fotos_eventos_foto_principal_id_fkey
  FOREIGN KEY (foto_principal_id) REFERENCES fotos_eventos_itens(id) ON DELETE SET NULL;

ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS nome_arquivo VARCHAR(255);
ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS mime_type VARCHAR(120);
ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS tamanho_bytes BIGINT;
ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS largura INTEGER;
ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS altura INTEGER;
ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS legenda TEXT;
ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS creditos VARCHAR(200);
ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS tags TEXT;
ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS ordem INTEGER;
ALTER TABLE fotos_eventos_itens
  ALTER COLUMN tags TYPE TEXT;
ALTER TABLE fotos_eventos_itens
  ADD COLUMN IF NOT EXISTS atualizado_em TIMESTAMP NOT NULL DEFAULT NOW();

CREATE INDEX IF NOT EXISTS fotos_eventos_data_idx
  ON fotos_eventos (data_evento DESC);
CREATE INDEX IF NOT EXISTS fotos_eventos_titulo_idx
  ON fotos_eventos (titulo);
CREATE INDEX IF NOT EXISTS fotos_eventos_tags_evento_idx
  ON fotos_eventos_tags (evento_id);
CREATE INDEX IF NOT EXISTS fotos_eventos_tags_tag_idx
  ON fotos_eventos_tags (tag);

CREATE TABLE IF NOT EXISTS cursos_atendimentos (
  id BIGSERIAL PRIMARY KEY,
  tipo VARCHAR(20) NOT NULL,
  nome VARCHAR(200) NOT NULL,
  descricao TEXT,
  imagem TEXT,
  vagas_totais INTEGER NOT NULL DEFAULT 0,
  vagas_disponiveis INTEGER NOT NULL DEFAULT 0,
  carga_horaria INTEGER,
  horario_inicial TIME,
  duracao_horas INTEGER NOT NULL DEFAULT 0,
  dias_semana TEXT,
  faixa_etaria TEXT,
  vaga_preferencial_idosos BOOLEAN NOT NULL DEFAULT FALSE,
  sexo_permitido VARCHAR(20),
  restricoes TEXT,
  profissional VARCHAR(150),
  sala_id BIGINT REFERENCES salas_unidade(id) ON DELETE SET NULL,
  status VARCHAR(30) NOT NULL,
  data_triagem DATE,
  data_encaminhamento DATE,
  data_conclusao DATE,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS cursos_atendimentos_status_idx
  ON cursos_atendimentos (status);
CREATE INDEX IF NOT EXISTS cursos_atendimentos_sala_idx
  ON cursos_atendimentos (sala_id);

ALTER TABLE cursos_atendimentos
  ADD COLUMN IF NOT EXISTS faixa_etaria TEXT;

ALTER TABLE cursos_atendimentos
  ADD COLUMN IF NOT EXISTS vaga_preferencial_idosos BOOLEAN NOT NULL DEFAULT FALSE;

ALTER TABLE cursos_atendimentos
  ADD COLUMN IF NOT EXISTS sexo_permitido VARCHAR(20);

CREATE TABLE IF NOT EXISTS cursos_atendimentos_matriculas (
  id BIGSERIAL PRIMARY KEY,
  curso_id BIGINT NOT NULL REFERENCES cursos_atendimentos(id) ON DELETE CASCADE,
  beneficiario_nome VARCHAR(200) NOT NULL,
  cpf VARCHAR(20),
  status VARCHAR(20) NOT NULL,
  data_matricula TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS cursos_atendimentos_fila_espera (
  id BIGSERIAL PRIMARY KEY,
  curso_id BIGINT NOT NULL REFERENCES cursos_atendimentos(id) ON DELETE CASCADE,
  beneficiario_nome VARCHAR(200) NOT NULL,
  cpf VARCHAR(20),
  data_entrada TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS cursos_atendimentos_presencas (
  id BIGSERIAL PRIMARY KEY,
  curso_id BIGINT NOT NULL REFERENCES cursos_atendimentos(id) ON DELETE CASCADE,
  matricula_id BIGINT NOT NULL REFERENCES cursos_atendimentos_matriculas(id) ON DELETE CASCADE,
  data_aula DATE NOT NULL,
  status VARCHAR(10) NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  UNIQUE (curso_id, matricula_id, data_aula)
);

CREATE INDEX IF NOT EXISTS cursos_atendimentos_presencas_curso_data_idx
  ON cursos_atendimentos_presencas (curso_id, data_aula);

CREATE TABLE IF NOT EXISTS cursos_atendimentos_status (
  id BIGSERIAL PRIMARY KEY,
  curso_id BIGINT NOT NULL REFERENCES cursos_atendimentos(id) ON DELETE CASCADE,
  status VARCHAR(30) NOT NULL,
  data_alteracao TIMESTAMP NOT NULL DEFAULT NOW(),
  justificativa TEXT
);

CREATE TABLE IF NOT EXISTS banco_empregos (
  id BIGSERIAL PRIMARY KEY,
  titulo VARCHAR(200) NOT NULL,
  area VARCHAR(120),
  tipo VARCHAR(80),
  nivel VARCHAR(80),
  modelo VARCHAR(80),
  status VARCHAR(20) NOT NULL,
  data_abertura DATE,
  data_encerramento DATE,
  tipo_contrato VARCHAR(80),
  carga_horaria VARCHAR(80),
  salario VARCHAR(80),
  beneficios TEXT,
  nome_empresa VARCHAR(200),
  cnpj VARCHAR(20),
  responsavel VARCHAR(150),
  telefone VARCHAR(60),
  email VARCHAR(150),
  endereco VARCHAR(200),
  bairro VARCHAR(120),
  cidade VARCHAR(120),
  uf VARCHAR(10),
  escolaridade VARCHAR(120),
  experiencia VARCHAR(200),
  habilidades TEXT,
  requisitos TEXT,
  descricao TEXT,
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE banco_empregos
  ADD COLUMN IF NOT EXISTS data_abertura DATE;
ALTER TABLE banco_empregos
  ADD COLUMN IF NOT EXISTS data_encerramento DATE;
ALTER TABLE banco_empregos
  ADD COLUMN IF NOT EXISTS tipo_contrato VARCHAR(80);
ALTER TABLE banco_empregos
  ADD COLUMN IF NOT EXISTS carga_horaria VARCHAR(80);
ALTER TABLE banco_empregos
  ADD COLUMN IF NOT EXISTS cnpj VARCHAR(20);
ALTER TABLE banco_empregos
  ADD COLUMN IF NOT EXISTS requisitos TEXT;
ALTER TABLE banco_empregos
  ADD COLUMN IF NOT EXISTS observacoes TEXT;

CREATE TABLE IF NOT EXISTS banco_empregos_encaminhamentos (
  id BIGSERIAL PRIMARY KEY,
  emprego_id BIGINT NOT NULL REFERENCES banco_empregos(id) ON DELETE CASCADE,   
  beneficiario_id BIGINT REFERENCES cadastro_beneficiario(id) ON DELETE SET NULL,
  beneficiario_nome VARCHAR(200),
  data_encaminhamento DATE NOT NULL,
  status VARCHAR(40) NOT NULL,
  observacoes TEXT
);

CREATE TABLE IF NOT EXISTS banco_empregos_candidatos (
  id BIGSERIAL PRIMARY KEY,
  emprego_id BIGINT NOT NULL REFERENCES banco_empregos(id) ON DELETE CASCADE,
  beneficiario_id BIGINT REFERENCES cadastro_beneficiario(id) ON DELETE SET NULL,
  beneficiario_nome VARCHAR(200) NOT NULL,
  necessidades_profissionais TEXT,
  status VARCHAR(40) NOT NULL DEFAULT 'EM_ANALISE',
  curriculo_nome VARCHAR(255),
  curriculo_tipo VARCHAR(120),
  curriculo_conteudo TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE banco_empregos_candidatos
  ADD COLUMN IF NOT EXISTS status VARCHAR(40) NOT NULL DEFAULT 'EM_ANALISE';

CREATE INDEX IF NOT EXISTS banco_empregos_status_idx
  ON banco_empregos (status);
CREATE INDEX IF NOT EXISTS banco_empregos_encaminhamentos_emprego_idx
  ON banco_empregos_encaminhamentos (emprego_id);

CREATE TABLE IF NOT EXISTS termo_fomento (
  id BIGSERIAL PRIMARY KEY,
  numero_termo VARCHAR(120) NOT NULL,
  tipo_termo VARCHAR(20) NOT NULL,
  orgao_concedente VARCHAR(200),
  data_assinatura DATE,
  data_inicio_vigencia DATE,
  data_fim_vigencia DATE,
  situacao VARCHAR(20) NOT NULL,
  descricao_objeto TEXT,
  valor_global NUMERIC(14, 2),
  responsavel_interno VARCHAR(200),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS termo_fomento_aditivos (
  id BIGSERIAL PRIMARY KEY,
  termo_fomento_id BIGINT NOT NULL REFERENCES termo_fomento(id) ON DELETE CASCADE,
  tipo_aditivo VARCHAR(60) NOT NULL,
  data_aditivo DATE NOT NULL,
  nova_data_fim DATE,
  novo_valor NUMERIC(14, 2),
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS termo_fomento_documentos (
  id BIGSERIAL PRIMARY KEY,
  termo_fomento_id BIGINT NOT NULL REFERENCES termo_fomento(id) ON DELETE CASCADE,
  aditivo_id BIGINT REFERENCES termo_fomento_aditivos(id) ON DELETE CASCADE,
  tipo_documento VARCHAR(20) NOT NULL,
  nome VARCHAR(255) NOT NULL,
  data_url TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS termo_fomento_numero_idx
  ON termo_fomento (numero_termo);
CREATE INDEX IF NOT EXISTS termo_fomento_situacao_idx
  ON termo_fomento (situacao);
CREATE INDEX IF NOT EXISTS termo_fomento_documentos_termo_idx
  ON termo_fomento_documentos (termo_fomento_id);
CREATE INDEX IF NOT EXISTS termo_fomento_aditivos_termo_idx
  ON termo_fomento_aditivos (termo_fomento_id);

CREATE TABLE IF NOT EXISTS plano_trabalho (
  id BIGSERIAL PRIMARY KEY,
  codigo_interno VARCHAR(40) NOT NULL,
  titulo VARCHAR(200) NOT NULL,
  descricao_geral TEXT NOT NULL,
  status VARCHAR(20) NOT NULL,
  orgao_concedente VARCHAR(40),
  orgao_outro_descricao VARCHAR(200),
  area_programa VARCHAR(120),
  data_elaboracao DATE,
  data_aprovacao DATE,
  vigencia_inicio DATE,
  vigencia_fim DATE,
  termo_fomento_id BIGINT NOT NULL REFERENCES termo_fomento(id) ON DELETE RESTRICT,
  numero_processo VARCHAR(120),
  modalidade VARCHAR(120),
  observacoes_vinculacao TEXT,
  arquivo_formato VARCHAR(20),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS plano_trabalho_metas (
  id BIGSERIAL PRIMARY KEY,
  plano_trabalho_id BIGINT NOT NULL REFERENCES plano_trabalho(id) ON DELETE CASCADE,
  codigo VARCHAR(60),
  descricao TEXT NOT NULL,
  indicador TEXT,
  unidade_medida VARCHAR(60),
  quantidade_prevista NUMERIC(14, 2),
  resultado_esperado TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS plano_trabalho_atividades (
  id BIGSERIAL PRIMARY KEY,
  meta_id BIGINT NOT NULL REFERENCES plano_trabalho_metas(id) ON DELETE CASCADE,
  descricao TEXT NOT NULL,
  justificativa TEXT,
  publico_alvo TEXT,
  local_execucao TEXT,
  produto_esperado TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS plano_trabalho_etapas (
  id BIGSERIAL PRIMARY KEY,
  atividade_id BIGINT NOT NULL REFERENCES plano_trabalho_atividades(id) ON DELETE CASCADE,
  descricao TEXT NOT NULL,
  status VARCHAR(30),
  data_inicio_prevista DATE,
  data_fim_prevista DATE,
  data_conclusao DATE,
  responsavel VARCHAR(200),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS plano_trabalho_cronograma (
  id BIGSERIAL PRIMARY KEY,
  plano_trabalho_id BIGINT NOT NULL REFERENCES plano_trabalho(id) ON DELETE CASCADE,
  referencia_tipo VARCHAR(40),
  referencia_id VARCHAR(40),
  referencia_descricao TEXT,
  competencia VARCHAR(20) NOT NULL,
  descricao_resumida TEXT,
  valor_previsto NUMERIC(14, 2),
  fonte_recurso VARCHAR(60),
  natureza_despesa VARCHAR(120),
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS plano_trabalho_equipe (
  id BIGSERIAL PRIMARY KEY,
  plano_trabalho_id BIGINT NOT NULL REFERENCES plano_trabalho(id) ON DELETE CASCADE,
  nome VARCHAR(200) NOT NULL,
  funcao VARCHAR(200),
  cpf VARCHAR(20),
  carga_horaria VARCHAR(80),
  tipo_vinculo VARCHAR(120),
  contato VARCHAR(200),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS plano_trabalho_termo_idx
  ON plano_trabalho (termo_fomento_id);
CREATE INDEX IF NOT EXISTS plano_trabalho_status_idx
  ON plano_trabalho (status);
CREATE INDEX IF NOT EXISTS plano_trabalho_metas_plano_idx
  ON plano_trabalho_metas (plano_trabalho_id);
CREATE INDEX IF NOT EXISTS plano_trabalho_atividades_meta_idx
  ON plano_trabalho_atividades (meta_id);
CREATE INDEX IF NOT EXISTS plano_trabalho_etapas_atividade_idx
  ON plano_trabalho_etapas (atividade_id);
CREATE INDEX IF NOT EXISTS plano_trabalho_cronograma_plano_idx
  ON plano_trabalho_cronograma (plano_trabalho_id);
CREATE INDEX IF NOT EXISTS plano_trabalho_equipe_plano_idx
  ON plano_trabalho_equipe (plano_trabalho_id);

CREATE TABLE IF NOT EXISTS oficios (
  id BIGSERIAL PRIMARY KEY,
  tipo VARCHAR(20) NOT NULL,
  numero VARCHAR(120) NOT NULL,
  data DATE NOT NULL,
  setor_origem VARCHAR(200) NOT NULL,
  responsavel VARCHAR(200) NOT NULL, 
  destinatario VARCHAR(200) NOT NULL,
  destinatario_responsavel VARCHAR(200) NOT NULL,
  destinatario_cargo VARCHAR(200) NOT NULL,
  meio_envio VARCHAR(120) NOT NULL,  
  prazo_resposta VARCHAR(120),
  classificacao VARCHAR(120),
  razao_social VARCHAR(200) NOT NULL,
  logo_url TEXT,
  titulo VARCHAR(200),
  saudacao VARCHAR(200),
  para VARCHAR(200),
  cargo_para VARCHAR(200),
  assunto VARCHAR(300) NOT NULL,
  corpo TEXT NOT NULL,
  finalizacao TEXT,
  assinatura_nome VARCHAR(200),
  assinatura_cargo VARCHAR(200),
  rodape TEXT,
  status VARCHAR(30) NOT NULL,
  protocolo_envio VARCHAR(120),
  data_envio DATE,
  protocolo_recebimento VARCHAR(120),
  data_recebimento DATE,
  proximo_destino VARCHAR(200),
  observacoes TEXT,
  unidade_id BIGINT REFERENCES unidade_assistencial(id) ON DELETE SET NULL,
  criado_por BIGINT REFERENCES usuarios(id) ON DELETE SET NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS oficios_tramites (
  id BIGSERIAL PRIMARY KEY,
  oficio_id BIGINT NOT NULL REFERENCES oficios(id) ON DELETE CASCADE,
  data DATE,
  origem VARCHAR(200),
  destino VARCHAR(200),
  responsavel VARCHAR(200),
  acao VARCHAR(200) NOT NULL,
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS oficios_imagens (
  id BIGSERIAL PRIMARY KEY,
  oficio_id BIGINT NOT NULL REFERENCES oficios(id) ON DELETE CASCADE,
  nome_arquivo VARCHAR(200) NOT NULL,
  tipo_mime VARCHAR(60) NOT NULL,
  conteudo_base64 TEXT NOT NULL,
  ordem INT NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS oficios_numero_idx
  ON oficios (numero);
CREATE INDEX IF NOT EXISTS oficios_status_idx
  ON oficios (status);
CREATE INDEX IF NOT EXISTS oficios_data_idx
  ON oficios (data DESC);
CREATE INDEX IF NOT EXISTS oficios_tramites_oficio_idx
  ON oficios_tramites (oficio_id);
CREATE INDEX IF NOT EXISTS oficios_imagens_oficio_idx
  ON oficios_imagens (oficio_id);

CREATE TABLE IF NOT EXISTS ocorrencia_crianca (
  id BIGSERIAL PRIMARY KEY,
  data_preenchimento DATE NOT NULL,
  local_violencia VARCHAR(60),
  local_violencia_outro VARCHAR(200),
  violencia_motivada_por JSONB,
  violencia_motivada_outro VARCHAR(200),
  violencia_praticada_por JSONB,
  violencia_praticada_outro VARCHAR(200),
  outras_violacoes JSONB,
  vitima_nome VARCHAR(200) NOT NULL,
  vitima_idade INTEGER NOT NULL,
  vitima_raca_cor VARCHAR(40),
  vitima_identidade_genero VARCHAR(60),
  vitima_orientacao_sexual VARCHAR(40),
  vitima_orientacao_outro VARCHAR(120),
  vitima_escolaridade VARCHAR(40),
  vitima_responsavel_tipo VARCHAR(20),
  vitima_responsavel_nome VARCHAR(200),
  vitima_telefone_responsavel VARCHAR(40),
  vitima_endereco_logradouro VARCHAR(200),
  vitima_endereco_complemento VARCHAR(200),
  vitima_endereco_bairro VARCHAR(120),
  vitima_endereco_municipio VARCHAR(120),
  autor_nome VARCHAR(200),
  autor_idade INTEGER,
  autor_nao_consta BOOLEAN,
  autor_parentesco VARCHAR(20),
  autor_parentesco_grau VARCHAR(200),
  autor_responsavel_tipo VARCHAR(20),
  autor_responsavel_nome VARCHAR(200),
  autor_responsavel_telefone VARCHAR(40),
  autor_responsavel_nao_consta BOOLEAN,
  autor_endereco_logradouro VARCHAR(200),
  autor_endereco_complemento VARCHAR(200),
  autor_endereco_bairro VARCHAR(120),
  autor_endereco_municipio VARCHAR(120),
  autor_endereco_nao_consta BOOLEAN,
  tipificacao_violencia JSONB,
  tipificacao_psicologica JSONB,
  tipificacao_sexual JSONB,
  violencia_autoprovocada JSONB,
  outro_tipo_violencia TEXT,
  resumo_violencia TEXT NOT NULL,
  encaminhar_conselho BOOLEAN,
  encaminhar_motivo TEXT,
  data_envio_conselho DATE,
  denuncia_origem JSONB,
  denuncia_origem_outro VARCHAR(200),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS ocorrencia_crianca_anexo (
  id BIGSERIAL PRIMARY KEY,
  ocorrencia_id BIGINT NOT NULL REFERENCES ocorrencia_crianca(id) ON DELETE CASCADE,
  nome_arquivo VARCHAR(200) NOT NULL,
  tipo_mime VARCHAR(120) NOT NULL,
  conteudo_base64 TEXT NOT NULL,
  ordem INTEGER NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS ocorrencia_crianca_data_idx
  ON ocorrencia_crianca (data_preenchimento DESC);
CREATE INDEX IF NOT EXISTS ocorrencia_crianca_anexo_ocorrencia_idx
  ON ocorrencia_crianca_anexo (ocorrencia_id);

CREATE TABLE IF NOT EXISTS feriados (
  id BIGSERIAL PRIMARY KEY,
  data DATE NOT NULL,
  descricao VARCHAR(200) NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS feriados_data_idx
  ON feriados (data);

CREATE TABLE IF NOT EXISTS documentos_instituicao (
  id BIGSERIAL PRIMARY KEY,
  tipo_documento VARCHAR(200) NOT NULL,
  orgao_emissor VARCHAR(200) NOT NULL,
  descricao TEXT,
  categoria VARCHAR(120),
  emissao DATE NOT NULL,
  validade DATE,
  responsavel_interno VARCHAR(200),
  modo_renovacao VARCHAR(30),
  observacao_renovacao TEXT,
  gerar_alerta BOOLEAN NOT NULL DEFAULT TRUE,
  dias_antecedencia JSONB,
  forma_alerta VARCHAR(60),
  em_renovacao BOOLEAN NOT NULL DEFAULT FALSE,
  sem_vencimento BOOLEAN NOT NULL DEFAULT FALSE,
  vencimento_indeterminado BOOLEAN NOT NULL DEFAULT FALSE,
  situacao VARCHAR(30),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE IF EXISTS documentos_instituicao
  DROP COLUMN IF EXISTS numero_codigo;

CREATE TABLE IF NOT EXISTS documentos_instituicao_anexos (
  id BIGSERIAL PRIMARY KEY,
  documento_id BIGINT NOT NULL REFERENCES documentos_instituicao(id) ON DELETE CASCADE,
  nome_arquivo VARCHAR(200) NOT NULL,
  tipo VARCHAR(30) NOT NULL,
  tipo_mime VARCHAR(120),
  tamanho VARCHAR(40),
  caminho_arquivo TEXT,
  data_upload DATE NOT NULL,
  usuario VARCHAR(120) NOT NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE documentos_instituicao_anexos
  ADD COLUMN IF NOT EXISTS tipo_mime VARCHAR(120);

ALTER TABLE documentos_instituicao_anexos
  ADD COLUMN IF NOT EXISTS caminho_arquivo TEXT;

CREATE TABLE IF NOT EXISTS documentos_instituicao_historico (
  id BIGSERIAL PRIMARY KEY,
  documento_id BIGINT NOT NULL REFERENCES documentos_instituicao(id) ON DELETE CASCADE,
  data_hora TIMESTAMP NOT NULL,
  usuario VARCHAR(120) NOT NULL,
  tipo_alteracao VARCHAR(60) NOT NULL,
  observacao TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS documentos_instituicao_categoria_idx
  ON documentos_instituicao (categoria);
CREATE INDEX IF NOT EXISTS documentos_instituicao_situacao_idx
  ON documentos_instituicao (situacao);
CREATE INDEX IF NOT EXISTS documentos_instituicao_emissao_idx
  ON documentos_instituicao (emissao DESC);
CREATE INDEX IF NOT EXISTS documentos_instituicao_anexos_documento_idx
  ON documentos_instituicao_anexos (documento_id);
CREATE INDEX IF NOT EXISTS documentos_instituicao_historico_documento_idx
  ON documentos_instituicao_historico (documento_id);

CREATE TABLE IF NOT EXISTS transparencia (
  id BIGSERIAL PRIMARY KEY,
  unidade_id BIGINT REFERENCES unidade_assistencial(id) ON DELETE SET NULL,
  total_recebido NUMERIC(14, 2),
  total_recebido_helper VARCHAR(200),
  total_aplicado NUMERIC(14, 2),
  total_aplicado_helper VARCHAR(200),
  saldo_disponivel NUMERIC(14, 2),
  saldo_disponivel_helper VARCHAR(200),
  prestado_mes NUMERIC(14, 2),
  prestado_mes_helper VARCHAR(200),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS transparencia_recebimentos (
  id BIGSERIAL PRIMARY KEY,
  transparencia_id BIGINT NOT NULL REFERENCES transparencia(id) ON DELETE CASCADE,
  fonte VARCHAR(200) NOT NULL,
  valor NUMERIC(14, 2),
  periodicidade VARCHAR(200),
  status VARCHAR(60),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS transparencia_destinacoes (
  id BIGSERIAL PRIMARY KEY,
  transparencia_id BIGINT NOT NULL REFERENCES transparencia(id) ON DELETE CASCADE,
  titulo VARCHAR(200) NOT NULL,
  descricao TEXT,
  percentual INTEGER,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS transparencia_comprovantes (
  id BIGSERIAL PRIMARY KEY,
  transparencia_id BIGINT NOT NULL REFERENCES transparencia(id) ON DELETE CASCADE,
  titulo VARCHAR(200) NOT NULL,
  descricao TEXT,
  arquivo_nome VARCHAR(255),
  arquivo_url TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS transparencia_timelines (
  id BIGSERIAL PRIMARY KEY,
  transparencia_id BIGINT NOT NULL REFERENCES transparencia(id) ON DELETE CASCADE,
  titulo VARCHAR(200) NOT NULL,
  detalhe TEXT,
  status VARCHAR(30),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS transparencia_checklist (
  id BIGSERIAL PRIMARY KEY,
  transparencia_id BIGINT NOT NULL REFERENCES transparencia(id) ON DELETE CASCADE,
  titulo VARCHAR(200) NOT NULL,
  descricao TEXT,
  status VARCHAR(30),
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS transparencia_unidade_idx
  ON transparencia (unidade_id);
CREATE INDEX IF NOT EXISTS transparencia_recebimentos_idx
  ON transparencia_recebimentos (transparencia_id);
CREATE INDEX IF NOT EXISTS transparencia_destinacoes_idx
  ON transparencia_destinacoes (transparencia_id);
CREATE INDEX IF NOT EXISTS transparencia_comprovantes_idx
  ON transparencia_comprovantes (transparencia_id);
CREATE INDEX IF NOT EXISTS transparencia_timelines_idx
  ON transparencia_timelines (transparencia_id);
CREATE INDEX IF NOT EXISTS transparencia_checklist_idx
  ON transparencia_checklist (transparencia_id);

CREATE TABLE IF NOT EXISTS eventos (
  id BIGSERIAL PRIMARY KEY,
  titulo VARCHAR(200) NOT NULL,
  descricao TEXT,
  local VARCHAR(200),
  data_inicio TIMESTAMP NOT NULL,
  data_fim TIMESTAMP NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'PLANEJADO',
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS eventos_emprestimos (
  id BIGSERIAL PRIMARY KEY,
  titulo VARCHAR(200) NOT NULL,
  descricao TEXT,
  local VARCHAR(200),
  data_inicio TIMESTAMP NOT NULL,
  data_fim TIMESTAMP NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'PLANEJADO',
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS emprestimos_eventos (      
  id BIGSERIAL PRIMARY KEY,
  evento_id BIGINT NOT NULL REFERENCES eventos_emprestimos(id) ON DELETE RESTRICT,
  unidade_id BIGINT REFERENCES unidade_assistencial(id) ON DELETE SET NULL,
  responsavel_id BIGINT REFERENCES usuarios(id) ON DELETE SET NULL,
  data_retirada_prevista TIMESTAMP NOT NULL,
  data_devolucao_prevista TIMESTAMP NOT NULL,
  data_retirada_real TIMESTAMP,
  data_devolucao_real TIMESTAMP,
  status VARCHAR(20) NOT NULL DEFAULT 'RASCUNHO',
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS emprestimos_eventos_itens (
  id BIGSERIAL PRIMARY KEY,
  emprestimo_id BIGINT NOT NULL REFERENCES emprestimos_eventos(id) ON DELETE CASCADE,
  item_id BIGINT NOT NULL,
  tipo_item VARCHAR(20) NOT NULL,
  quantidade INTEGER NOT NULL,
  status_item VARCHAR(20) NOT NULL DEFAULT 'RESERVADO',
  observacao_item TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS emprestimos_eventos_movimentacoes (
  id BIGSERIAL PRIMARY KEY,
  emprestimo_id BIGINT NOT NULL REFERENCES emprestimos_eventos(id) ON DELETE CASCADE,
  acao VARCHAR(120) NOT NULL,
  descricao TEXT,
  usuario_id BIGINT REFERENCES usuarios(id) ON DELETE SET NULL,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS emprestimos_eventos_periodo_idx
  ON emprestimos_eventos (data_retirada_prevista, data_devolucao_prevista);

CREATE INDEX IF NOT EXISTS emprestimos_eventos_status_idx
  ON emprestimos_eventos (status);

CREATE INDEX IF NOT EXISTS emprestimos_eventos_itens_item_idx
  ON emprestimos_eventos_itens (item_id, tipo_item);

CREATE TABLE IF NOT EXISTS controle_veiculos (
  id BIGSERIAL PRIMARY KEY,
  placa VARCHAR(20),
  modelo VARCHAR(120),
  marca VARCHAR(120),
  ano INTEGER,
  tipo_combustivel VARCHAR(60),
  media_consumo_padrao NUMERIC(12, 2),
  capacidade_tanque_litros NUMERIC(10, 2),
  observacoes TEXT,
  ativo BOOLEAN DEFAULT TRUE,
  foto_frente TEXT,
  foto_lateral_esquerda TEXT,
  foto_lateral_direita TEXT,
  foto_traseira TEXT,
  documento_veiculo_pdf TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE UNIQUE INDEX IF NOT EXISTS controle_veiculos_placa_idx
  ON controle_veiculos (placa);


CREATE TABLE IF NOT EXISTS controle_veiculos_diario (
  id BIGSERIAL PRIMARY KEY,
  veiculo_id BIGINT REFERENCES controle_veiculos(id) ON DELETE CASCADE,
  data DATE,
  condutor VARCHAR(150),
  horario_saida TIME,
  km_inicial NUMERIC(12, 2),
  horario_chegada TIME,
  km_final NUMERIC(12, 2),
  destino VARCHAR(200),
  combustivel_consumido_litros NUMERIC(12, 2),
  km_rodados NUMERIC(12, 2),
  media_consumo NUMERIC(12, 2),
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS controle_veiculos_motoristas_autorizados (
  id BIGSERIAL PRIMARY KEY,
  veiculo_id BIGINT NOT NULL REFERENCES controle_veiculos(id) ON DELETE CASCADE,
  tipo_origem VARCHAR(20) NOT NULL,
  profissional_id BIGINT,
  voluntario_id BIGINT,
  nome_motorista VARCHAR(200) NOT NULL,
  numero_carteira VARCHAR(40),
  categoria_carteira VARCHAR(10),
  vencimento_carteira DATE,
  arquivo_carteira_pdf TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  CONSTRAINT controle_veiculos_motoristas_autorizados_tipo_ck
    CHECK (
      (tipo_origem = 'PROFISSIONAL' AND profissional_id IS NOT NULL AND voluntario_id IS NULL)
      OR
      (tipo_origem = 'VOLUNTARIO' AND voluntario_id IS NOT NULL AND profissional_id IS NULL)
    )
);

CREATE UNIQUE INDEX IF NOT EXISTS controle_veiculos_motoristas_autorizados_unique_idx
  ON controle_veiculos_motoristas_autorizados (veiculo_id, tipo_origem, profissional_id, voluntario_id);

CREATE INDEX IF NOT EXISTS controle_veiculos_motoristas_autorizados_veiculo_idx
  ON controle_veiculos_motoristas_autorizados (veiculo_id);

ALTER TABLE controle_veiculos ALTER COLUMN placa DROP NOT NULL;
ALTER TABLE controle_veiculos ALTER COLUMN modelo DROP NOT NULL;
ALTER TABLE controle_veiculos ALTER COLUMN marca DROP NOT NULL;
ALTER TABLE controle_veiculos ALTER COLUMN ano DROP NOT NULL;
ALTER TABLE controle_veiculos ALTER COLUMN tipo_combustivel DROP NOT NULL;
ALTER TABLE controle_veiculos ALTER COLUMN ativo DROP NOT NULL;

ALTER TABLE controle_veiculos ADD COLUMN IF NOT EXISTS media_consumo_padrao NUMERIC(12, 2);
ALTER TABLE controle_veiculos ADD COLUMN IF NOT EXISTS capacidade_tanque_litros NUMERIC(12, 2);

ALTER TABLE controle_veiculos ADD COLUMN IF NOT EXISTS foto_frente TEXT;
ALTER TABLE controle_veiculos ADD COLUMN IF NOT EXISTS foto_lateral_esquerda TEXT;
ALTER TABLE controle_veiculos ADD COLUMN IF NOT EXISTS foto_lateral_direita TEXT;
ALTER TABLE controle_veiculos ADD COLUMN IF NOT EXISTS foto_traseira TEXT;
ALTER TABLE controle_veiculos ADD COLUMN IF NOT EXISTS documento_veiculo_pdf TEXT;

ALTER TABLE controle_veiculos_motoristas_autorizados
  ADD COLUMN IF NOT EXISTS numero_carteira VARCHAR(40);
ALTER TABLE controle_veiculos_motoristas_autorizados
  ADD COLUMN IF NOT EXISTS categoria_carteira VARCHAR(10);
ALTER TABLE controle_veiculos_motoristas_autorizados
  ADD COLUMN IF NOT EXISTS vencimento_carteira DATE;
ALTER TABLE controle_veiculos_motoristas_autorizados
  ADD COLUMN IF NOT EXISTS arquivo_carteira_pdf TEXT;

ALTER TABLE controle_veiculos_diario ALTER COLUMN veiculo_id DROP NOT NULL;
ALTER TABLE controle_veiculos_diario ALTER COLUMN data DROP NOT NULL;
ALTER TABLE controle_veiculos_diario ALTER COLUMN condutor DROP NOT NULL;
ALTER TABLE controle_veiculos_diario ALTER COLUMN horario_saida DROP NOT NULL;
ALTER TABLE controle_veiculos_diario ALTER COLUMN km_inicial DROP NOT NULL;
ALTER TABLE controle_veiculos_diario ALTER COLUMN horario_chegada DROP NOT NULL;
ALTER TABLE controle_veiculos_diario ALTER COLUMN km_final DROP NOT NULL;
ALTER TABLE controle_veiculos_diario ALTER COLUMN destino DROP NOT NULL;
ALTER TABLE controle_veiculos_diario ALTER COLUMN combustivel_consumido_litros DROP NOT NULL;
ALTER TABLE controle_veiculos_diario ALTER COLUMN km_rodados DROP NOT NULL;
ALTER TABLE controle_veiculos_diario ALTER COLUMN media_consumo DROP NOT NULL;

CREATE INDEX IF NOT EXISTS controle_veiculos_diario_veiculo_idx
  ON controle_veiculos_diario (veiculo_id);

CREATE INDEX IF NOT EXISTS controle_veiculos_diario_data_idx
  ON controle_veiculos_diario (data DESC);



CREATE TABLE IF NOT EXISTS biblioteca_livros (
  id BIGSERIAL PRIMARY KEY,
  codigo VARCHAR(40) NOT NULL UNIQUE,
  titulo VARCHAR(220) NOT NULL,
  autor VARCHAR(200) NOT NULL,
  isbn VARCHAR(40),
  editora VARCHAR(180),
  ano_publicacao INTEGER,
  categoria VARCHAR(120),
  quantidade_total INTEGER NOT NULL,
  quantidade_disponivel INTEGER NOT NULL,
  localizacao VARCHAR(160),
  status VARCHAR(20) NOT NULL DEFAULT 'ATIVO',
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS biblioteca_emprestimos (
  id BIGSERIAL PRIMARY KEY,
  livro_id BIGINT NOT NULL REFERENCES biblioteca_livros(id) ON DELETE RESTRICT,
  beneficiario_id BIGINT REFERENCES cadastro_beneficiario(id) ON DELETE SET NULL,
  beneficiario_nome VARCHAR(200) NOT NULL,
  responsavel_id BIGINT REFERENCES usuarios(id) ON DELETE SET NULL,
  responsavel_nome VARCHAR(200),
  data_emprestimo DATE NOT NULL,
  data_devolucao_prevista DATE NOT NULL,
  data_devolucao_real DATE,
  status VARCHAR(20) NOT NULL DEFAULT 'ATIVO',
  observacoes TEXT,
  criado_em TIMESTAMP NOT NULL DEFAULT NOW(),
  atualizado_em TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS biblioteca_emprestimos_status_idx
  ON biblioteca_emprestimos (status);

CREATE INDEX IF NOT EXISTS biblioteca_emprestimos_devolucao_idx
  ON biblioteca_emprestimos (data_devolucao_prevista);

UPDATE versao_sistema
SET versao = '1.00.7',
  descricao = 'Inclusao do modulo de Biblioteca com gestao de livros, emprestimos e alertas.',
  atualizado_em = NOW()
WHERE versao <> '1.00.7';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.00.7', 'Inclusao do modulo de Biblioteca com gestao de livros, emprestimos e alertas.', NOW()
WHERE NOT EXISTS (
  SELECT 1 FROM historico_versao_sistema
  WHERE versao = '1.00.7'
);

UPDATE versao_sistema
SET versao = '1.00.8',
  descricao = 'Dashboard de assistencia com acesso rapido a tarefas e indicadores de abertas e vencidas.',
  atualizado_em = NOW()
WHERE versao <> '1.00.8';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.00.8', 'Dashboard de assistencia com acesso rapido a tarefas e indicadores de abertas e vencidas.', NOW()
WHERE NOT EXISTS (
  SELECT 1 FROM historico_versao_sistema
  WHERE versao = '1.00.8'
);

UPDATE versao_sistema
SET versao = '1.00.9',
  descricao = 'Prontuario social com busca aprimorada, selecao de unidade e linha do tempo interativa.',
  atualizado_em = NOW()
WHERE versao <> '1.00.9';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.00.9', 'Prontuario social com busca aprimorada, selecao de unidade e linha do tempo interativa.', NOW()
WHERE NOT EXISTS (
  SELECT 1 FROM historico_versao_sistema
  WHERE versao = '1.00.9'
);

UPDATE versao_sistema
SET versao = '1.00.10',
  descricao = 'Prontuario social somente leitura com indicadores de atendimentos, doacoes e cursos.',
  atualizado_em = NOW()
WHERE versao <> '1.00.10';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.00.10', 'Prontuario social somente leitura com indicadores de atendimentos, doacoes e cursos.', NOW()
WHERE NOT EXISTS (
  SELECT 1 FROM historico_versao_sistema
  WHERE versao = '1.00.10'
);

UPDATE versao_sistema
SET versao = '1.00.11',
  descricao = 'Dashboard de assistencia com atalhos de tarefas no topo da aplicacao.',
  atualizado_em = NOW()
WHERE versao <> '1.00.11';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.00.11', 'Dashboard de assistencia com atalhos de tarefas no topo da aplicacao.', NOW()
WHERE NOT EXISTS (
  SELECT 1 FROM historico_versao_sistema
  WHERE versao = '1.00.11'
);

CREATE TABLE IF NOT EXISTS senha_fila (
  id BIGSERIAL PRIMARY KEY,
  beneficiario_id BIGINT NOT NULL REFERENCES cadastro_beneficiario(id) ON DELETE RESTRICT,
  status VARCHAR(20) NOT NULL,
  prioridade INTEGER NOT NULL DEFAULT 0,
  data_hora_entrada TIMESTAMP NOT NULL DEFAULT NOW(),
  data_hora_atualizacao TIMESTAMP NOT NULL DEFAULT NOW(),
  unidade_id BIGINT REFERENCES unidade_assistencial(id) ON DELETE SET NULL,
  usuario_id BIGINT REFERENCES usuarios(id) ON DELETE SET NULL,
  sala_atendimento VARCHAR(120)
);

ALTER TABLE senha_fila
  ADD COLUMN IF NOT EXISTS sala_atendimento VARCHAR(120);

CREATE INDEX IF NOT EXISTS senha_fila_status_idx
  ON senha_fila (status);

CREATE INDEX IF NOT EXISTS senha_fila_prioridade_data_idx
  ON senha_fila (status, prioridade DESC, data_hora_entrada ASC);

CREATE INDEX IF NOT EXISTS senha_fila_unidade_idx
  ON senha_fila (unidade_id);

CREATE TABLE IF NOT EXISTS senha_chamada (
  id UUID PRIMARY KEY,
  fila_id BIGINT NOT NULL REFERENCES senha_fila(id) ON DELETE CASCADE,
  nome_beneficiario VARCHAR(200) NOT NULL,
  local_atendimento VARCHAR(120) NOT NULL,
  status VARCHAR(20) NOT NULL,
  data_hora_chamada TIMESTAMP NOT NULL,
  data_hora_criacao TIMESTAMP NOT NULL,
  chamado_por VARCHAR(120) NOT NULL,
  unidade_id BIGINT REFERENCES unidade_assistencial(id) ON DELETE SET NULL,
  usuario_id BIGINT REFERENCES usuarios(id) ON DELETE SET NULL
);

CREATE TABLE IF NOT EXISTS senha_config (
  id BIGINT PRIMARY KEY,
  frase_fala VARCHAR(300) NOT NULL,
  rss_url VARCHAR(500) NOT NULL,
  velocidade_ticker INT NOT NULL,
  modo_noticias VARCHAR(20),
  noticias_manuais TEXT,
  quantidade_ultimas_chamadas INT NOT NULL,
  unidade_painel_id BIGINT REFERENCES unidade_assistencial(id) ON DELETE SET NULL,
  titulo_tela VARCHAR(120),
  descricao_tela VARCHAR(200),
  atualizado_em TIMESTAMP NOT NULL
);

ALTER TABLE senha_config
  ADD COLUMN IF NOT EXISTS quantidade_ultimas_chamadas INT NOT NULL DEFAULT 4;

ALTER TABLE senha_config
  ADD COLUMN IF NOT EXISTS unidade_painel_id BIGINT REFERENCES unidade_assistencial(id) ON DELETE SET NULL;

ALTER TABLE senha_config
  ADD COLUMN IF NOT EXISTS modo_noticias VARCHAR(20);

ALTER TABLE senha_config
  ADD COLUMN IF NOT EXISTS noticias_manuais TEXT;

UPDATE senha_config
SET quantidade_ultimas_chamadas = 4
WHERE quantidade_ultimas_chamadas IS NULL;

UPDATE senha_config
SET modo_noticias = 'RSS'
WHERE modo_noticias IS NULL;

INSERT INTO senha_config (
  id,
  frase_fala,
  rss_url,
  velocidade_ticker,
  modo_noticias,
  noticias_manuais,
  quantidade_ultimas_chamadas,
  unidade_painel_id,
  titulo_tela,
  descricao_tela,
  atualizado_em
)
SELECT 1,
  'Beneficiário {beneficiario} dirija-se a {sala} para atendimento.',
  'https://www.gov.br/pt-br/noticias/assistencia-social/RSS',
  60,
  'RSS',
  NULL,
  4,
  NULL,
  'Chamada de senhas',
  'Controle de fila e chamada de beneficiarios.',
  NOW()
WHERE NOT EXISTS (SELECT 1 FROM senha_config WHERE id = 1);

CREATE INDEX IF NOT EXISTS senha_chamada_data_idx
  ON senha_chamada (data_hora_chamada DESC);

CREATE INDEX IF NOT EXISTS senha_chamada_unidade_idx
  ON senha_chamada (unidade_id);

UPDATE versao_sistema
SET versao = '1.00.12',
  descricao = 'Integracao do painel e chamada de senhas no modulo monolitico do G3.',
  atualizado_em = NOW()
WHERE versao <> '1.00.12';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.00.12', 'Integracao do painel e chamada de senhas no modulo monolitico do G3.', NOW()
WHERE NOT EXISTS (
  SELECT 1 FROM historico_versao_sistema
  WHERE versao = '1.00.12'
);

UPDATE versao_sistema
SET versao = '1.00.13',
  descricao = 'Correcao do mapeamento da configuracao de senhas para a tabela correta.',
  atualizado_em = NOW()
WHERE versao <> '1.00.13';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.00.13', 'Correcao do mapeamento da configuracao de senhas para a tabela correta.', NOW()
WHERE NOT EXISTS (
  SELECT 1 FROM historico_versao_sistema
  WHERE versao = '1.00.13'
);

ALTER TABLE biblioteca_livros
  ADD COLUMN IF NOT EXISTS estado_livro VARCHAR(30);

UPDATE biblioteca_livros
SET estado_livro = 'Bom'
WHERE estado_livro IS NULL;

UPDATE senha_config
SET frase_fala = 'Beneficiário {beneficiario} dirija-se a {sala} para atendimento.',
  atualizado_em = NOW()
WHERE frase_fala IN (
  'Beneficiario {beneficiario} dirija-se a sala {sala} para atendimento.',
  'Beneficiario {beneficiario} dirija-se a {sala} para atendimento.'
);

UPDATE versao_sistema
SET versao = '1.00.15',
  descricao = 'Configuracao da quantidade de ultimas chamadas no painel de senhas.',
  atualizado_em = NOW()
WHERE versao <> '1.00.15';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.00.15', 'Configuracao da quantidade de ultimas chamadas no painel de senhas.', NOW()
WHERE NOT EXISTS (
  SELECT 1 FROM historico_versao_sistema
  WHERE versao = '1.00.15'
);

UPDATE versao_sistema
SET versao = '1.00.14',
  descricao = 'Atualizacao do modelo padrao de chamada de senhas e ajuste de tela.',
  atualizado_em = NOW()
WHERE versao <> '1.00.14';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.00.14', 'Atualizacao do modelo padrao de chamada de senhas e ajuste de tela.', NOW()
WHERE NOT EXISTS (
  SELECT 1 FROM historico_versao_sistema
  WHERE versao = '1.00.14'
);

UPDATE versao_sistema
SET versao = '1.00.16',
  descricao = 'Configuracao da unidade exibida no topo do painel de senhas.',
  atualizado_em = NOW()
WHERE versao <> '1.00.16';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.00.16', 'Configuracao da unidade exibida no topo do painel de senhas.', NOW()
WHERE NOT EXISTS (
  SELECT 1 FROM historico_versao_sistema
  WHERE versao = '1.00.16'
);

UPDATE versao_sistema
SET versao = '1.00.17',
  descricao = 'Selecao de noticias manuais ou via RSS no painel de senhas.',
  atualizado_em = NOW()
WHERE versao <> '1.00.17';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.00.17', 'Selecao de noticias manuais ou via RSS no painel de senhas.', NOW()
WHERE NOT EXISTS (
  SELECT 1 FROM historico_versao_sistema
  WHERE versao = '1.00.17'
);

UPDATE versao_sistema
SET versao = '1.00.18',
  descricao = 'Controle de veiculos com campos nao obrigatorios e ajustes de layout.',
  atualizado_em = NOW()
WHERE versao <> '1.00.18';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.00.18', 'Controle de veiculos com campos nao obrigatorios e ajustes de layout.', NOW()
WHERE NOT EXISTS (
  SELECT 1 FROM historico_versao_sistema
  WHERE versao = '1.00.18'
);

UPDATE versao_sistema
SET versao = '1.00.19',
  descricao = 'Indicador de tarefas vencidas com destaque e ajuste de icone do tema escuro.',
  atualizado_em = NOW()
WHERE versao <> '1.00.19';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.00.19', 'Indicador de tarefas vencidas com destaque e ajuste de icone do tema escuro.', NOW()
WHERE NOT EXISTS (
  SELECT 1 FROM historico_versao_sistema
  WHERE versao = '1.00.19'
);

UPDATE versao_sistema
SET versao = '1.00.20',
  descricao = 'Paginacao do historico de versoes na tela de configuracoes.',
  atualizado_em = NOW()
WHERE versao <> '1.00.20';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.00.20', 'Paginacao do historico de versoes na tela de configuracoes.', NOW()
WHERE NOT EXISTS (
  SELECT 1 FROM historico_versao_sistema
  WHERE versao = '1.00.20'
);

UPDATE versao_sistema
SET versao = '1.00.21',
  descricao = 'Cadastro de veiculos com marcas sugeridas, validacao de placa e fotos do veiculo.',
  atualizado_em = NOW()
WHERE versao <> '1.00.21';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.00.21', 'Cadastro de veiculos com marcas sugeridas, validacao de placa e fotos do veiculo.', NOW()
WHERE NOT EXISTS (
  SELECT 1 FROM historico_versao_sistema
  WHERE versao = '1.00.21'
);

UPDATE versao_sistema
SET versao = '1.00.22',
  descricao = 'Cadastro de veiculos com foto traseira e cards alinhados.',
  atualizado_em = NOW()
WHERE versao <> '1.00.22';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.00.22', 'Cadastro de veiculos com foto traseira e cards alinhados.', NOW()
WHERE NOT EXISTS (
  SELECT 1 FROM historico_versao_sistema
  WHERE versao = '1.00.22'
);

UPDATE versao_sistema
SET versao = '1.00.28',
  descricao = 'Mensagem de indisponibilidade e ajuste no deploy.',
  atualizado_em = NOW()
WHERE versao <> '1.00.28';

INSERT INTO historico_versao_sistema (versao, descricao, criado_em)
SELECT '1.00.28', 'Mensagem de indisponibilidade e ajuste no deploy.', NOW()
WHERE NOT EXISTS (
  SELECT 1 FROM historico_versao_sistema
  WHERE versao = '1.00.28'
);


