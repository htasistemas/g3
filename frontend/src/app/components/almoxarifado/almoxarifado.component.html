<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  (salvar)="onSalvarToolbar()"
  (excluir)="onExcluirToolbar()"
  (novo)="onNovoToolbar()"
  (cancelar)="onCancelarToolbar()"
  (imprimir)="onImprimirToolbar()"
  (buscar)="onBuscarToolbar()"
  (fechar)="onFecharToolbar()"
>
  <header class="page-title" slot="titulo">
    <p class="page-title__eyebrow">Almoxarifado</p>
    <p class="page-title__label">Controle de Estoque</p>
    <p class="page-title__note">Controle de estoque e movimentacoes do almoxarifado.</p>
  </header>

  <app-popup-messages [mensagens]="popupErros" (fechar)="popupErros = []"></app-popup-messages>

  <section class="cadastro">
    <div class="tab-shell">
      <p class="tab-shell__title">Navegue pelas informacoes</p>
      <ol class="step-tabs" role="tablist">
        <li
          *ngFor="let tab of tabs; index as idx"
          class="step-tabs__item"
          [class.active]="activeTab === tab.id"
          [class.completed]="idx < activeTabIndex"
        >
          <button
            class="step-tabs__button"
            type="button"
            role="tab"
            [attr.aria-selected]="activeTab === tab.id"
            (click)="changeTab(tab.id)"
          >
            <span class="step-tabs__index">{{ idx + 1 }}</span>
            <span class="step-tabs__label">{{ tab.label }}</span>
          </button>
        </li>
      </ol>
    </div>

    <ng-template #navigationControls>
      <div class="tab-actions">
        <button type="button" class="ghost" *ngIf="hasPreviousTab" (click)="goToPreviousTab()">Voltar</button>
        <button type="button" class="primary" *ngIf="hasNextTab" (click)="goToNextTab()">Próximo: {{ nextTabLabel }}</button>
      </div>
    </ng-template>

    <div class="tab-card" *ngIf="activeTab === 'dashboards'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Indicadores consolidados para acompanhar estoque, valores e alertas.</p>
        </div>
        <div class="tab-card__actions">
          <button class="ghost" type="button" (click)="abrirEntradaProdutos()">
            <fa-icon [icon]="faPlus" class="mr-2"></fa-icon>
            Entrada de produtos
          </button>
          <button class="ghost" type="button" (click)="resetItemForm()">
            <fa-icon [icon]="faRotate" class="mr-2"></fa-icon>
            Limpar formulario
          </button>
          <button class="primary" type="button" (click)="openMovementModal()">
            <fa-icon [icon]="faPlus" class="mr-2"></fa-icon>
            Nova movimentacao
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
        <div class="card flex items-center gap-3 metric-card">
          <div class="metric-icon metric-icon--primary">
            <fa-icon [icon]="faWarehouse"></fa-icon>
          </div>
          <div>
            <p class="text-sm text-slate-500">Total de itens cadastrados</p>
            <p class="text-2xl font-bold text-slate-900">{{ indicatorTotals().totalItems }}</p>
          </div>
        </div>
        <div class="card flex items-center gap-3 metric-card">
          <div class="metric-icon metric-icon--alert">
            <fa-icon [icon]="faTriangleExclamation"></fa-icon>
          </div>
          <div>
            <p class="text-sm text-slate-500">Itens abaixo do estoque minimo</p>
            <p class="text-2xl font-bold text-slate-900">{{ indicatorTotals().belowMin }}</p>
          </div>
        </div>
        <div class="card flex items-center gap-3 metric-card">
          <div class="metric-icon metric-icon--info">
            <fa-icon [icon]="faMoneyBillTrendUp"></fa-icon>
          </div>
          <div>
            <p class="text-sm text-slate-500">Valor total em estoque</p>
            <p class="text-2xl font-bold text-slate-900">
              R$ {{ formatarMoeda(indicatorTotals().totalValue) }}
            </p>
          </div>
        </div>
        <div class="card flex items-center gap-3 metric-card">
          <div class="metric-icon metric-icon--muted">
            <fa-icon [icon]="faArrowTrendUp"></fa-icon>
          </div>
          <div>
            <p class="text-sm text-slate-500">Movimentações nos ultimos 30 dias</p>
            <p class="text-2xl font-bold text-slate-900">{{ indicatorTotals().recentMovements }}</p>
          </div>
        </div>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'cadastro'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Valide campos obrigatorios e acompanhe estoque e localizacao.</p>
        </div>
        <div class="tab-card__actions">
          <button class="ghost" type="button" (click)="resetItemForm()">
            <fa-icon [icon]="faRotate" class="mr-2"></fa-icon>
            Limpar formulario
          </button>
          <button class="primary" type="button" (click)="saveItem()">
            <fa-icon [icon]="faCircleCheck" class="mr-2"></fa-icon>
            {{ editingItemCode ? 'Atualizar item' : 'Salvar novo item' }}
          </button>
        </div>
      </div>

      <div class="card border border-emerald-200 rounded-2xl p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-800">Código do item *</label>
            <input
              class="input"
              type="text"
              [(ngModel)]="itemForm.code"
              placeholder="Gerado automaticamente"
              readonly
              required
            />
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-800">Código de barras</label>
            <input
              class="input"
              type="text"
              [ngModel]="itemForm.barcode"
              (ngModelChange)="onCodigoBarrasCadastroInput($event)"
              placeholder="Leitura do código de barras"
            />
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-800">Descrição do item *</label>
            <input
              class="input"
              type="text"
              [(ngModel)]="itemForm.description"
              placeholder="Ex: Máscara descartável tripla"
              required
            />
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-800">Categoria *</label>
            <app-autocomplete
              [termo]="categoriaTermo"
              [opcoes]="categoriasOpcoes"
              placeholder="Selecione a categoria"
              (termoChange)="atualizarTermoCategoria($event)"
              (selecionar)="selecionarCategoria($event)"
            ></app-autocomplete>
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-800">Unidade de medida *</label>
            <app-autocomplete
              [termo]="unidadeMedidaTermo"
              [opcoes]="unidadesMedidaOpcoes"
              placeholder="Selecione a unidade de medida"
              (termoChange)="atualizarTermoUnidadeMedida($event)"
              (selecionar)="selecionarUnidadeMedida($event)"
            ></app-autocomplete>
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-800">Localizacao</label>
            <app-autocomplete
              [termo]="localizacaoTermo"
              [opcoes]="localizacoesOpcoes"
              placeholder="Selecione a sala"
              (termoChange)="atualizarTermoLocalizacao($event)"
              (selecionar)="selecionarLocalizacao($event)"
            ></app-autocomplete>
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-800">Localizacao interna</label>
            <app-autocomplete
              [termo]="localizacaoInternaTermo"
              [opcoes]="localizacoesInternasOpcoes"
              placeholder="Selecione a localizacao interna"
              (termoChange)="atualizarTermoLocalizacaoInterna($event)"
              (selecionar)="selecionarLocalizacaoInterna($event)"
            ></app-autocomplete>
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-800">Estoque atual</label>
            <input class="input" type="number" min="0" [(ngModel)]="itemForm.currentStock" />
            <p class="text-xs text-slate-500">Padrao zero para novos itens.</p>
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-800">Estoque minimo *</label>
            <input class="input" type="number" min="0" [(ngModel)]="itemForm.minStock" required />
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-800">Valor unitario estimado</label>
            <input
              class="input"
              type="text"
              inputmode="numeric"
              [ngModel]="valorUnitarioMascara"
              (ngModelChange)="onValorUnitarioInput($event)"
              placeholder="0,00"
            />
          </div>
          <div class="flex items-center gap-2 mt-6">
            <input
              type="checkbox"
              [checked]="itemForm.isKit"
              (change)="onIsKitChange($event.target.checked)"
            />
            <label class="text-sm text-slate-800">Este produto e um kit/composto</label>
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-800">Validade</label>  
            <input
              class="input"
              type="date"
              [(ngModel)]="itemForm.validity"
              [disabled]="itemForm.ignoreValidity"
            />
          </div>
          <div class="flex items-center gap-2 mt-6">
            <input
              type="checkbox"
              [checked]="itemForm.ignoreValidity"
              (change)="onIgnorarValidadeChange($event.target.checked)"
            />
            <label class="text-sm text-slate-800">Ignorar validade</label>
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-slate-800">Situação</label>
            <select class="input" [(ngModel)]="itemForm.status">
              <option value="Ativo">Ativo</option>
              <option value="Inativo">Inativo</option>
            </select>
          </div>
          <div class="flex flex-col gap-1 xl:col-span-3">
            <label class="text-sm font-medium text-slate-800">Observações gerais</label>
            <textarea
              class="input min-h-[96px]"
              [(ngModel)]="itemForm.notes"
              placeholder="Registro de fornecedores, prazos ou cuidados de armazenamento"
            ></textarea>
          </div>
        </div>
        <div class="form-feedback">
          <span class="text-sm text-red-600" *ngIf="formError">{{ formError }}</span>
          <span class="text-sm text-emerald-600" *ngIf="successMessage">{{ successMessage }}</span>
        </div>
      </div>

      <div class="bg-emerald-50 border border-dashed border-emerald-200 rounded-2xl p-4 space-y-3 mt-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-semibold uppercase tracking-wide text-g3-green-500">Filtros rapidos</p>
            <h3 class="text-lg font-semibold text-slate-900">Buscar itens</h3>
          </div>
          <fa-icon [icon]="faSliders" class="text-slate-400"></fa-icon>
        </div>
        <div class="space-y-3">
          <div class="flex items-center gap-2">
            <fa-icon [icon]="faMagnifyingGlass" class="text-slate-400"></fa-icon>
            <input
              type="search"
              class="input flex-1"
              [(ngModel)]="itemFilters.term"
              placeholder="Descrição ou código"
            />
          </div>
          <div class="flex items-center gap-2">
            <fa-icon [icon]="faFilter" class="text-slate-400"></fa-icon>
            <select class="input flex-1" [(ngModel)]="itemFilters.category">
              <option value="all">Todas as categorias</option>
              <option *ngFor="let category of categories" [value]="category">{{ category }}</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <fa-icon [icon]="faBoxArchive" class="text-slate-400"></fa-icon>
            <select class="input flex-1" [(ngModel)]="itemFilters.status">
              <option value="all">Todas as situacoes</option>
              <option value="Ativo">Ativo</option>
              <option value="Inativo">Inativo</option>
            </select>
          </div>
          <label class="flex items-center gap-2 text-sm text-slate-800">
            <input type="checkbox" [(ngModel)]="itemFilters.belowMinOnly" />
            <span>Mostrar apenas itens abaixo do estoque minimo</span>
          </label>
          <div class="flex gap-2">
            <button class="btn-outline flex-1" type="button">
              <fa-icon [icon]="faDownload" class="mr-2"></fa-icon>
              Exportar lista
            </button>
            <button class="btn-primary flex-1" type="button" (click)="openMovementModal()">
              <fa-icon [icon]="faPlus" class="mr-2"></fa-icon>
              Nova movimentacao
            </button>
          </div>
        </div>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>      
    </div>

    <div class="tab-card" *ngIf="activeTab === 'kit'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Defina a composicao dos itens para produtos compostos.</p>
        </div>
        <div class="tab-card__actions">
          <button class="ghost" type="button" (click)="changeTab('cadastro')">
            Voltar ao cadastro
          </button>
          <button class="primary" type="button" (click)="salvarComposicaoKit()" [disabled]="kitComposicaoSalvando || !itemForm.isKit">
            {{ kitComposicaoSalvando ? 'Salvando...' : 'Salvar composicao' }}
          </button>
        </div>
      </div>

      <div class="card border border-emerald-200 rounded-2xl p-4 space-y-4">
        <ng-container *ngIf="itemForm.isKit; else kitDesativado">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <p class="text-sm text-slate-500">Kit selecionado</p>
              <p class="text-lg font-semibold text-slate-900">
                {{ editingItemCode || itemForm.code || 'Novo kit' }} - {{ itemForm.description || 'Informe a descricao no cadastro' }}
              </p>
            </div>
            <div class="text-xs text-slate-500">
              {{ kitComposicaoCarregando ? 'Carregando composicao...' : (kitComposicao.length + ' item(ns) na composicao') }}
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="flex flex-col gap-1 md:col-span-2">
              <label class="text-sm font-medium text-slate-800">Item da composicao *</label>
              <app-autocomplete
                [placeholder]="'Buscar item do almoxarifado'"
                [termo]="kitComposicaoNovo.termo"
                [opcoes]="opcoesProdutosKit"
                (termoChange)="onKitTermoChange($event)"
                (selecionar)="onKitSelecionado($event)"
              ></app-autocomplete>
            </div>
            <div class="flex flex-col gap-1">
              <label class="text-sm font-medium text-slate-800">Quantidade *</label>
              <input class="input" type="number" min="0" step="0.01" [(ngModel)]="kitComposicaoNovo.quantidade" />
            </div>
          </div>

          <div class="flex flex-wrap items-center justify-between gap-3">
            <p class="text-sm text-slate-600">
              Adicione os itens que compoem o kit. Nao e permitido repetir itens.
            </p>
            <button class="btn-primary" type="button" (click)="adicionarItemComposicao()">Adicionar item</button>
          </div>

          <div class="table-wrapper" *ngIf="kitComposicao.length">
            <table class="min-w-full text-sm border border-emerald-200 rounded-xl overflow-hidden">
              <thead>
                <tr class="bg-emerald-50 text-left text-slate-800">
                  <th class="px-4 py-3 border-b border-emerald-200">Codigo</th>
                  <th class="px-4 py-3 border-b border-emerald-200">Descricao</th>
                  <th class="px-4 py-3 border-b border-emerald-200">Quantidade</th>
                  <th class="px-4 py-3 border-b border-emerald-200">Acoes</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of kitComposicao" class="border-b border-emerald-200">
                  <td class="px-4 py-3 align-top">{{ item.produtoItemCodigo || '---' }}</td>
                  <td class="px-4 py-3 align-top">{{ item.produtoItemDescricao || '---' }}</td>
                  <td class="px-4 py-3 align-top">{{ item.quantidadeItem }}</td>
                  <td class="px-4 py-3 align-top">
                    <button class="btn-outline" type="button" (click)="removerItemComposicao(item)">Remover</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <p class="text-sm text-slate-500" *ngIf="!kitComposicao.length">Nenhum item adicionado na composicao.</p>
          <p class="text-sm text-red-600" *ngIf="kitComposicaoErro">{{ kitComposicaoErro }}</p>
        </ng-container>
        <ng-template #kitDesativado>
          <div class="text-sm text-slate-600">
            Marque este produto como kit no cadastro para liberar a composicao.
          </div>
        </ng-template>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'itens'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Ações rapidas: editar, movimentar e visualizar historico de cada item.</p>
        </div>
        <div class="tab-card__actions">
          <button class="ghost" type="button" (click)="saveItem()">
            <fa-icon [icon]="faPlus" class="mr-2"></fa-icon>
            Novo item de almoxarifado
          </button>
          <button class="primary" type="button">
            <fa-icon [icon]="faDownload" class="mr-2"></fa-icon>
            Exportar lista
          </button>
        </div>
      </div>
      <div class="table-wrapper">
        <table class="min-w-full text-sm border border-emerald-200 rounded-xl overflow-hidden">
          <thead>
            <tr class="bg-emerald-50 text-left text-slate-800">
              <th class="px-4 py-3 border-b border-emerald-200">Código</th>
              <th class="px-4 py-3 border-b border-emerald-200">Descrição</th>
              <th class="px-4 py-3 border-b border-emerald-200">Categoria</th>
              <th class="px-4 py-3 border-b border-emerald-200">Unidade</th>
              <th class="px-4 py-3 border-b border-emerald-200">Localizacao</th>
              <th class="px-4 py-3 border-b border-emerald-200">Estoque atual</th>
              <th class="px-4 py-3 border-b border-emerald-200">Estoque minimo</th>
              <th class="px-4 py-3 border-b border-emerald-200">Validade</th>
              <th class="px-4 py-3 border-b border-emerald-200">Situação</th>
              <th class="px-4 py-3 border-b border-emerald-200">Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of filteredItems" class="border-b border-emerald-200">
              <td class="px-4 py-3 align-top">{{ item.code }}</td>
              <td class="px-4 py-3 align-top">
                <div class="font-semibold text-slate-900">{{ item.description }}</div>
                <p class="text-sm text-slate-700">{{ item.locationDetail || 'Não informado' }}</p>
              </td>
              <td class="px-4 py-3 align-top">{{ item.category }}</td>
              <td class="px-4 py-3 align-top">{{ item.unit }}</td>
              <td class="px-4 py-3 align-top">{{ item.location || 'Não informado' }}</td>
              <td class="px-4 py-3 align-top">
                <span
                  class="status-chip"
                  [ngClass]="item.currentStock < item.minStock ? 'status-chip--alert' : 'status-chip--success'"
                >
                  {{ item.currentStock }}
                </span>
              </td>
              <td class="px-4 py-3 align-top">{{ item.minStock }}</td>
              <td class="px-4 py-3 align-top">
                <ng-container *ngIf="item.ignoreValidity || !item.validity">Não informado</ng-container>
                <ng-container *ngIf="!item.ignoreValidity && item.validity">
                  <div class="text-slate-900">{{ item.validity | date:'dd/MM/yyyy' }}</div>
                  <span
                    class="status-chip"
                    *ngIf="alertaVencimentoPorItem.get(item.id) as alerta"
                    [ngClass]="alerta === 'vencido' ? 'status-chip--alert' : 'status-chip--inactive'"
                  >
                    {{ alerta === 'vencido' ? 'Vencido' : 'Vencendo' }}
                  </span>
                </ng-container>
              </td>
              <td class="px-4 py-3 align-top">
                <span
                  class="status-chip"
                  [ngClass]="item.status === 'Inativo' ? 'status-chip--inactive' : 'status-chip--success'"
                >
                  {{ item.status }}
                </span>
              </td>
              <td class="px-4 py-3 align-top">
                <div class="flex flex-wrap gap-2">
                  <button
                    class="inline-flex items-center gap-2 px-3 py-2 rounded-full text-xs font-semibold border border-emerald-200 bg-white hover:bg-emerald-50 transition"
                    type="button"
                    (click)="editItem(item)"
                  >
                    <fa-icon [icon]="faCircleCheck"></fa-icon>
                    Editar
                  </button>
                  <button
                    class="inline-flex items-center gap-2 px-3 py-2 rounded-full text-xs font-semibold border border-emerald-200 bg-white hover:bg-emerald-50 transition"
                    type="button"
                    (click)="openMovementModal(item)"
                  >
                    <fa-icon [icon]="faClipboardList"></fa-icon>
                    Movimentar
                  </button>
                  <button
                    class="inline-flex items-center gap-2 px-3 py-2 rounded-full text-xs font-semibold border border-emerald-200 bg-emerald-50 border-dashed"
                    type="button"
                    (click)="openHistoryModal(item)"
                  >
                    <fa-icon [icon]="faUser"></fa-icon>
                    Histórico
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="filteredItems.length === 0">
              <td colspan="10" class="text-center py-6 text-slate-500">Nenhum item encontrado com os filtros atuais.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'movimentacoes'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Entradas, saidas e ajustes com saldo atualizado automaticamente.</p>
        </div>
        <div class="tab-card__actions">
          <button class="ghost" type="button" (click)="openMovementModal()">
            <fa-icon [icon]="faPlus" class="mr-2"></fa-icon>
            Nova movimentacao
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
        <div class="flex flex-col gap-1">
          <label class="text-sm font-medium text-slate-800">Data inicial</label>
          <input class="input" type="date" [(ngModel)]="movementFilters.startDate" />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-medium text-slate-800">Data final</label>
          <input class="input" type="date" [(ngModel)]="movementFilters.endDate" />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-medium text-slate-800">Tipo</label>
          <select class="input" [(ngModel)]="movementFilters.type">
            <option value="Todos">Todos</option>
            <option value="Entrada">Entrada</option>
            <option value="Saida">Saida</option>
            <option value="Ajuste">Ajuste</option>
          </select>
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-medium text-slate-800">Item</label>
          <input class="input" type="search" [(ngModel)]="movementFilters.itemSearch" placeholder="Código ou descricao" />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-medium text-slate-800">Responsavel</label>
          <input class="input" type="text" [(ngModel)]="movementFilters.responsible" placeholder="Filtrar por responsavel" />
        </div>
      </div>

      <div class="table-wrapper">
        <table class="min-w-full text-sm border border-emerald-200 rounded-xl overflow-hidden">
          <thead>
            <tr class="bg-emerald-50 text-left text-slate-800">
              <th class="px-4 py-3 border-b border-emerald-200">Data</th>
              <th class="px-4 py-3 border-b border-emerald-200">Tipo</th>
              <th class="px-4 py-3 border-b border-emerald-200">Item</th>
              <th class="px-4 py-3 border-b border-emerald-200">Quantidade</th>
              <th class="px-4 py-3 border-b border-emerald-200">Saldo apos movimentacao</th>
              <th class="px-4 py-3 border-b border-emerald-200">Documento / Referencia</th>
              <th class="px-4 py-3 border-b border-emerald-200">Responsavel</th>
              <th class="px-4 py-3 border-b border-emerald-200">Itens do kit</th>
              <th class="px-4 py-3 border-b border-emerald-200">Observações</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let movement of filteredMovements" class="border-b border-emerald-200">
              <td class="px-4 py-3 align-top">{{ movement.date | date:'dd/MM/yyyy' }}</td>
              <td class="px-4 py-3 align-top">
                <span
                  class="status-chip"
                  [ngClass]="movement.type === 'Saida' ? 'status-chip--inactive' : 'status-chip--success'"
                >
                  {{ movement.type }}
                </span>
              </td>
              <td class="px-4 py-3 align-top">
                <div class="font-semibold text-slate-900">{{ movement.itemDescription }}</div>
                <p class="text-sm text-slate-700">{{ movement.itemCode }}</p>
              </td>
              <td class="px-4 py-3 align-top">{{ movement.quantity }}</td>
              <td class="px-4 py-3 align-top">{{ movement.balanceAfter }}</td>
              <td class="px-4 py-3 align-top">{{ movement.reference || 'Não informado' }}</td>
              <td class="px-4 py-3 align-top">{{ movement.responsible || 'Não informado' }}</td>
              <td class="px-4 py-3 align-top">
                <button
                  class="btn-outline"
                  type="button"
                  *ngIf="movimentosComKit[movement.id]"
                  (click)="abrirVinculosKit(movement)"
                >
                  Ver itens
                </button>
                <span class="text-xs text-slate-500" *ngIf="!movimentosComKit[movement.id]">-</span>
              </td>
              <td class="px-4 py-3 align-top">{{ movement.notes || 'Não informado' }}</td>
            </tr>
            <tr *ngIf="filteredMovements.length === 0">
              <td colspan="9" class="text-center py-6 text-slate-500">Nenhuma movimentacao encontrada para os filtros.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>
  </section>

  <div
    class="fixed inset-0 bg-emerald-900/25 backdrop-blur-sm flex items-center justify-center z-50 p-4"
    *ngIf="showMovementModal"
  >
    <div class="bg-white rounded-2xl border border-emerald-200 max-w-4xl w-full shadow-2xl space-y-4 p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-semibold uppercase tracking-wide text-g3-green-500">Nova movimentacao</p>
          <h3 class="text-lg font-semibold text-slate-900">Registrar entrada, saida ou ajuste</h3>
        </div>
        <button class="btn-outline" type="button" (click)="showMovementModal = false">Fechar</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="flex flex-col gap-1">
          <label class="text-sm font-medium text-slate-800">Data *</label>
          <input class="input" type="date" [(ngModel)]="movementForm.date" />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-medium text-slate-800">Tipo *</label>
          <select class="input" [(ngModel)]="movementForm.type">
            <option value="Entrada">Entrada</option>
            <option value="Saida">Saida</option>
            <option value="Ajuste">Ajuste</option>
          </select>
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-medium text-slate-800">Código de barras</label>
          <input
            class="input"
            type="text"
            [ngModel]="movementForm.barcode"
            (ngModelChange)="onCodigoBarrasMovimentacaoInput($event)"
            placeholder="Leitura do código de barras"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-medium text-slate-800">Selecao do item *</label>
          <select class="input" [(ngModel)]="movementForm.itemCode" (ngModelChange)="onMovimentacaoItemChange($event)">
            <option value="">Selecione o item</option>
            <option *ngFor="let item of items()" [value]="item.code">{{ item.code }} - {{ item.description }}</option>
          </select>
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-medium text-slate-800">Quantidade movimentada *</label>
          <input class="input" type="number" min="1" [(ngModel)]="movementForm.quantity" />
        </div>
        <div class="md:col-span-2" *ngIf="movimentacaoSelecionadaEhKit">
          <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-4 space-y-3">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-slate-800">Composicao do kit</p>
                <p class="text-xs text-slate-600">Quantidade calculada por item conforme a quantidade informada.</p>
              </div>
              <span class="text-xs text-slate-500" *ngIf="movimentacaoKitCarregando">Carregando...</span>
            </div>
            <div class="text-sm text-red-600" *ngIf="movimentacaoKitErro">{{ movimentacaoKitErro }}</div>
            <div class="grid gap-2" *ngIf="!movimentacaoKitCarregando && movimentacaoKitComposicao.length">
              <div class="flex items-center justify-between text-sm" *ngFor="let item of movimentacaoKitComposicao">
                <span>{{ item.produtoItemDescricao || item.produtoItemCodigo }}</span>
                <span class="font-semibold">{{ calcularQuantidadeKit(item.quantidadeItem) }}</span>
              </div>
            </div>
            <p class="text-xs text-slate-500" *ngIf="!movimentacaoKitCarregando && !movimentacaoKitComposicao.length">
              Nenhum item configurado na composicao.
            </p>
            <label class="flex items-center gap-2 text-sm text-slate-800" *ngIf="movementForm.type === 'Entrada'">
              <input type="checkbox" [(ngModel)]="gerarItensKitEntrada" />
              <span>Ao dar entrada deste kit, lancar entrada nos itens da composicao</span>
            </label>
          </div>
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-medium text-slate-800">Documento / Referencia</label>
          <input class="input" type="text" [(ngModel)]="movementForm.reference" placeholder="Nota fiscal, requisicao" />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-medium text-slate-800">Responsavel</label>
          <input class="input" type="text" [(ngModel)]="movementForm.responsible" placeholder="Nome ou setor" />
        </div>
        <div class="flex flex-col gap-2 md:col-span-2" *ngIf="movementForm.type === 'Ajuste'">
          <label class="text-sm font-medium text-slate-800">Direcao do ajuste</label>
          <div class="flex gap-3">
            <label class="inline-flex items-center gap-2 px-3 py-2 rounded-full border border-emerald-200 bg-emerald-50 text-sm">
              <input type="radio" name="adjust" value="increase" [(ngModel)]="movementForm.adjustmentDirection" />
              Aumentar estoque
            </label>
            <label class="inline-flex items-center gap-2 px-3 py-2 rounded-full border border-emerald-200 bg-emerald-50 text-sm">
              <input type="radio" name="adjust" value="decrease" [(ngModel)]="movementForm.adjustmentDirection" />
              Reduzir estoque
            </label>
          </div>
          <p class="text-xs text-slate-500">Ajustes solicitam confirmacao para evitar lancamentos acidentais.</p>
        </div>
        <div class="flex flex-col gap-1 md:col-span-2">
          <label class="text-sm font-medium text-slate-800">Observações</label>
          <textarea class="input min-h-[96px]" [(ngModel)]="movementForm.notes" placeholder="Detalhes adicionais"></textarea>
        </div>
      </div>
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="space-y-1">
          <p class="text-sm text-red-600" *ngIf="movementError">{{ movementError }}</p>
          <p class="text-sm text-slate-700">Saída não permite quantidade maior que o estoque atual.</p>
        </div>
        <div class="flex gap-2">
          <button class="btn-outline" type="button" (click)="showMovementModal = false">Cancelar</button>
          <button class="btn-primary" type="button" (click)="saveMovement()">Salvar movimentacao</button>
        </div>
      </div>
    </div>
  </div>

  <div
    class="fixed inset-0 bg-emerald-900/25 backdrop-blur-sm flex items-center justify-center z-50 p-4"
    *ngIf="showHistoryModal"
  >
    <div class="bg-white rounded-2xl border border-emerald-200 max-w-5xl w-full shadow-2xl space-y-4 p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-semibold uppercase tracking-wide text-g3-green-500">Histórico do item</p>
          <h3 class="text-lg font-semibold text-slate-900">
            {{ historicoItemSelecionado?.code }} - {{ historicoItemSelecionado?.description }}
          </h3>
        </div>
        <button class="btn-outline" type="button" (click)="closeHistoryModal()">Fechar</button>
      </div>

      <div class="table-wrapper">
        <table class="min-w-full text-sm border border-emerald-200 rounded-xl overflow-hidden">
          <thead>
            <tr class="bg-emerald-50 text-left text-slate-800">
              <th class="px-4 py-3 border-b border-emerald-200">Data</th>
              <th class="px-4 py-3 border-b border-emerald-200">Tipo</th>
              <th class="px-4 py-3 border-b border-emerald-200">Quantidade</th>
              <th class="px-4 py-3 border-b border-emerald-200">Saldo apos movimentacao</th>
              <th class="px-4 py-3 border-b border-emerald-200">Documento / Referencia</th>
              <th class="px-4 py-3 border-b border-emerald-200">Responsavel</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let movement of historicoMovimentacoes" class="border-b border-emerald-200">
              <td class="px-4 py-3 align-top">{{ movement.date | date:'dd/MM/yyyy' }}</td>
              <td class="px-4 py-3 align-top">{{ movement.type }}</td>
              <td class="px-4 py-3 align-top">{{ movement.quantity }}</td>
              <td class="px-4 py-3 align-top">{{ movement.balanceAfter }}</td>
              <td class="px-4 py-3 align-top">{{ movement.reference || 'Não informado' }}</td>
              <td class="px-4 py-3 align-top">{{ movement.responsible || 'Não informado' }}</td>
              <td class="px-4 py-3 align-top">
                <button
                  class="btn-outline"
                  type="button"
                  *ngIf="movimentosComKit[movement.id]"
                  (click)="abrirVinculosKit(movement)"
                >
                  Ver itens
                </button>
                <span class="text-xs text-slate-500" *ngIf="!movimentosComKit[movement.id]">-</span>
              </td>
            </tr>
            <tr *ngIf="historicoMovimentacoes.length === 0">
              <td colspan="6" class="text-center py-6 text-slate-500">Nenhuma movimentacao para este item.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div
    class="fixed inset-0 bg-emerald-900/25 backdrop-blur-sm flex items-center justify-center z-50 p-4"
    *ngIf="showKitVinculosModal"
  >
    <div class="bg-white rounded-2xl border border-emerald-200 max-w-5xl w-full shadow-2xl space-y-4 p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-semibold uppercase tracking-wide text-g3-green-500">Itens do kit</p>
          <h3 class="text-lg font-semibold text-slate-900">
            Movimentacao {{ kitVinculosMovimentacaoSelecionada?.itemCode }} - {{ kitVinculosMovimentacaoSelecionada?.itemDescription }}
          </h3>
        </div>
        <button class="btn-outline" type="button" (click)="fecharVinculosKit()">Fechar</button>
      </div>

      <div class="text-sm text-red-600" *ngIf="kitVinculosErro">{{ kitVinculosErro }}</div>
      <div class="text-sm text-slate-500" *ngIf="kitVinculosCarregando">Carregando itens do kit...</div>

      <div class="table-wrapper" *ngIf="!kitVinculosCarregando">
        <table class="min-w-full text-sm border border-emerald-200 rounded-xl overflow-hidden">
          <thead>
            <tr class="bg-emerald-50 text-left text-slate-800">
              <th class="px-4 py-3 border-b border-emerald-200">Data</th>
              <th class="px-4 py-3 border-b border-emerald-200">Tipo</th>
              <th class="px-4 py-3 border-b border-emerald-200">Item</th>
              <th class="px-4 py-3 border-b border-emerald-200">Quantidade</th>
              <th class="px-4 py-3 border-b border-emerald-200">Saldo apos</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of kitVinculos" class="border-b border-emerald-200">
              <td class="px-4 py-3 align-top">{{ item.dataMovimentacao | date:'dd/MM/yyyy' }}</td>
              <td class="px-4 py-3 align-top">{{ item.tipo }}</td>
              <td class="px-4 py-3 align-top">{{ item.itemCodigo }} - {{ item.itemDescricao }}</td>
              <td class="px-4 py-3 align-top">{{ item.quantidade }}</td>
              <td class="px-4 py-3 align-top">{{ item.saldoApos }}</td>
            </tr>
            <tr *ngIf="!kitVinculos.length">
              <td colspan="5" class="text-center py-6 text-slate-500">Nenhum item vinculado para esta movimentacao.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</app-tela-padrao>


