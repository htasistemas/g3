<section class="unit-page">
  <header class="page-title">
    <p class="page-title__eyebrow">Unidade assistencial</p>
    <p class="page-title__label">Cadastro da unidade</p>
    <p class="page-title__hint">Navegue pelas abas para preencher os dados institucionais.</p>
  </header>

  <div class="tab-shell">
    <p class="tab-shell__title">Navegação por etapas</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of tabs"
        class="step-tabs__item"
        [class.active]="activeTab === tab.id"
        [attr.data-tab]="tab.id"
      >
        <button
          type="button"
          class="step-tabs__button"
          role="tab"
          [attr.aria-selected]="activeTab === tab.id"
          (click)="changeTab(tab.id)"
        >
          <span class="step-tabs__label">{{ tab.label }}</span>
        </button>
      </li>
    </ol>
  </div>

  <form [formGroup]="form" class="form-shell" (ngSubmit)="save()">
    <div *ngIf="feedback" class="alert" [ngClass]="{
        'alert-success': feedback.type === 'success',
        'alert-error': feedback.type === 'error',
        'alert-warning': feedback.type === 'warning'
      }">
      {{ feedback.message }}
    </div>

    <section class="tab-card" *ngIf="activeTab === 'dados'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('dados') }}</p>
          <h3>Dados da unidade</h3>
          <p class="muted">Informações institucionais e contatos principais.</p>
        </div>
      </div>

      <div class="field-grid cols-2">
        <label class="field full">Nome fantasia*
          <input id="nomeFantasia" type="text" formControlName="nomeFantasia" placeholder="Ex.: Unidade Central" />
          <span class="hint" *ngIf="form.get('nomeFantasia')?.touched && form.get('nomeFantasia')?.invalid">
            Informe um nome fantasia válido para a unidade.
          </span>
        </label>

        <label class="field full">Razão social
          <input id="razaoSocial" type="text" formControlName="razaoSocial" placeholder="Nome empresarial" />
          <span class="hint" *ngIf="form.get('razaoSocial')?.touched && form.get('razaoSocial')?.invalid">
            Informe a razão social da instituição.
          </span>
        </label>

        <label class="field">CNPJ
          <input id="cnpj" type="text" formControlName="cnpj" placeholder="00.000.000/0000-00" />
          <span class="hint" *ngIf="form.get('cnpj')?.touched && form.get('cnpj')?.invalid">Informe um CNPJ.</span>
        </label>

        <label class="field">Telefone
          <input
            id="telefone"
            type="text"
            formControlName="telefone"
            placeholder="(00) 00000-0000"
            (input)="onPhoneInput($event)"
          />
        </label>

        <label class="field">E-mail
          <input id="email" type="email" formControlName="email" placeholder="contato@unidade.com" />
          <span class="hint" *ngIf="form.get('email')?.touched && form.get('email')?.invalid">
            Informe um e-mail válido.
          </span>
        </label>

        <label class="field">Horário de funcionamento
          <input
            id="horarioFuncionamento"
            type="text"
            formControlName="horarioFuncionamento"
            placeholder="Ex.: Segunda a sexta, das 8h às 17h"
          />
        </label>

        <label class="field full">Observações
          <textarea
            id="observacoes"
            formControlName="observacoes"
            rows="3"
            placeholder="Instruções internas, horário de atendimento, etc."
          ></textarea>
        </label>
      </div>
    </section>

    <section class="tab-card" *ngIf="activeTab === 'endereco'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('endereco') }}</p>
          <h3>Endereço da unidade</h3>
          <p class="muted">Localização completa para correspondências e visitas.</p>
        </div>
      </div>

      <div class="field-grid cols-3">
        <label class="field">CEP
          <input
            id="cep"
            type="text"
            formControlName="cep"
            placeholder="00000-000"
            inputmode="numeric"
            maxlength="9"
            (input)="onCepInput($event)"
          />
        </label>

        <label class="field full">Endereço
          <input id="endereco" type="text" formControlName="endereco" placeholder="Rua, avenida..." />
        </label>

        <label class="field">Número
          <input id="numeroEndereco" type="text" formControlName="numeroEndereco" placeholder="Número" />
        </label>

        <label class="field">Bairro
          <input id="bairro" type="text" formControlName="bairro" placeholder="Bairro" />
        </label>

        <label class="field">Cidade
          <input id="cidade" type="text" formControlName="cidade" placeholder="Cidade" />
        </label>

        <label class="field">Estado
          <select id="estado" formControlName="estado">
            <option value="">Selecione...</option>
            <option *ngFor="let uf of estados" [value]="uf">{{ uf }}</option>
          </select>
        </label>
      </div>
    </section>

    <section class="tab-card" *ngIf="activeTab === 'imagens'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('imagens') }}</p>
          <h3>Imagens da unidade</h3>
          <p class="muted">Inclua logomarcas e versões para relatórios.</p>
        </div>
      </div>

      <div class="field-grid cols-2">
        <label class="field full">Logomarca
          <div class="file-row">
            <div class="file-row__controls">
              <input
                id="logomarca"
                type="file"
                accept="image/*"
                class="input"
                (change)="onLogoSelected($event)"
              />
              <button type="button" class="btn-outline" (click)="clearLogo()" *ngIf="logoPreview">Remover</button>
            </div>
            <div *ngIf="logoPreview" class="preview">
              <p class="hint">Pré-visualização</p>
              <img [src]="logoPreview" alt="Pré-visualização da logomarca" />
            </div>
            <p class="hint">Imagens quadradas funcionam melhor na tela de login.</p>
          </div>
        </label>

        <label class="field full">Imagem para relatórios (PDF)
          <div class="file-row">
            <div class="file-row__controls">
              <input
                id="logomarcaRelatorio"
                type="file"
                accept="image/*"
                class="input"
                (change)="onReportLogoSelected($event)"
              />
              <button type="button" class="btn-outline" (click)="clearReportLogo()" *ngIf="reportLogoPreview">Remover</button>
            </div>
            <div *ngIf="reportLogoPreview" class="preview">
              <p class="hint">Pré-visualização</p>
              <img [src]="reportLogoPreview" alt="Pré-visualização da imagem para relatórios" />
            </div>
            <p class="hint">Use uma versão horizontal ou em alta resolução para relatórios e PDFs.</p>
          </div>
        </label>
      </div>
    </section>

    <section class="tab-card" *ngIf="activeTab === 'diretoria'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('diretoria') }}</p>
          <h3>Diretoria da unidade</h3>
          <p class="muted">Dados do responsável e período de mandato.</p>
        </div>
      </div>

      <div class="field-grid cols-2">
        <label class="field full">Diretor(a) / coordenador(a) / presidente
          <input
            id="responsavelNome"
            type="text"
            formControlName="responsavelNome"
            placeholder="Nome completo do responsável"
          />
        </label>

        <label class="field">CPF do responsável
          <input
            id="responsavelCpf"
            type="text"
            formControlName="responsavelCpf"
            placeholder="000.000.000-00"
            inputmode="numeric"
            maxlength="14"
            (input)="onCpfInput($event)"
          />
          <span class="hint" *ngIf="form.get('responsavelCpf')?.touched && form.get('responsavelCpf')?.invalid">
            Informe um CPF válido.
          </span>
        </label>

        <label class="field">Período de mandato
          <input
            id="responsavelPeriodoMandato"
            type="text"
            formControlName="responsavelPeriodoMandato"
            placeholder="Ex.: 2024 - 2026"
          />
        </label>
      </div>
    </section>

    <div class="action-bar">
      <button type="button" class="btn-outline" (click)="resetForm()">Cancelar</button>
      <div class="action-bar__right">
        <div
          *ngIf="feedback"
          class="alert alert-inline"
          [ngClass]="{
            'alert-success': feedback.type === 'success',
            'alert-error': feedback.type === 'error',
            'alert-warning': feedback.type === 'warning'
          }"
        >
          {{ feedback.message }}
        </div>
        <div class="action-buttons">
          <button type="button" class="btn-outline" *ngIf="unidade?.id" (click)="requestDeletion()">
            Excluir unidade
          </button>
          <button type="submit" class="btn-primary">{{ unidade ? 'Atualizar unidade' : 'Salvar unidade' }}</button>
        </div>
      </div>
    </div>

    <div *ngIf="deleteConfirmation" class="alert alert-warning delete-warning">
      <div class="flex-1">
        <p class="font-semibold">Atenção</p>
        <p>Você está excluindo a unidade. Tem certeza? Esta ação é irreversível.</p>
      </div>
      <div class="flex gap-2 flex-wrap justify-end">
        <button type="button" class="btn-outline" (click)="cancelDeletion()">Cancelar</button>
        <button type="button" class="btn-danger" (click)="confirmDeletion()">Confirmar exclusão</button>
      </div>
    </div>
  </form>

  <div class="card card--compact data-card">
    <div class="card__header-row">
      <div class="card__header">Dados atuais da unidade</div>
      <button type="button" class="btn-outline" *ngIf="unidade" (click)="printUnit()">Imprimir dados</button>
    </div>
    <p class="text-sm text-slate-600" *ngIf="!unidade">Nenhuma unidade cadastrada até o momento.</p>
    <div *ngIf="unidade" class="data-grid">
      <div class="md:col-span-2 flex items-center gap-3" *ngIf="unidade.logomarca">
        <span class="font-semibold">Logomarca:</span>
        <img [src]="unidade.logomarca" alt="Logomarca da unidade" class="h-12 object-contain" />
      </div>
      <div class="md:col-span-2 flex items-center gap-3" *ngIf="unidade.logomarcaRelatorio">
        <span class="font-semibold">Imagem dos relatórios:</span>
        <img [src]="unidade.logomarcaRelatorio" alt="Imagem utilizada em relatórios" class="h-12 object-contain" />
      </div>
      <p><span class="font-semibold">Nome fantasia:</span> {{ unidade.nomeFantasia }}</p>
      <p><span class="font-semibold">Razão social:</span> {{ unidade.razaoSocial || 'Não informada' }}</p>
      <p><span class="font-semibold">CNPJ:</span> {{ unidade.cnpj || 'Não informado' }}</p>
      <p><span class="font-semibold">Telefone:</span> {{ unidade.telefone || 'Não informado' }}</p>
      <p><span class="font-semibold">E-mail:</span> {{ unidade.email || 'Não informado' }}</p>
      <p><span class="font-semibold">Horário de funcionamento:</span> {{ unidade.horarioFuncionamento || 'Não informado' }}</p>
      <p><span class="font-semibold">CEP:</span> {{ unidade.cep || 'Não informado' }}</p>
      <p><span class="font-semibold">Cidade/Estado:</span> {{ unidade.cidade || 'Sem cidade' }} / {{ unidade.estado || 'UF' }}</p>
      <p><span class="font-semibold">Período de mandato:</span> {{ unidade.responsavelPeriodoMandato || 'Não informado' }}</p>
      <p class="md:col-span-2"><span class="font-semibold">Endereço:</span> {{ unidade.endereco }} {{ unidade.numeroEndereco }}</p>
      <p><span class="font-semibold">Bairro:</span> {{ unidade.bairro || 'Não informado' }}</p>
      <p class="md:col-span-2"><span class="font-semibold">Responsável:</span> {{ unidade.responsavelNome || 'Não informado' }}</p>
      <p><span class="font-semibold">CPF:</span> {{ unidade.responsavelCpf || 'Não informado' }}</p>
      <p class="md:col-span-2"><span class="font-semibold">Observações:</span> {{ unidade.observacoes || 'Nenhuma' }}</p>
    </div>
  </div>
</section>
