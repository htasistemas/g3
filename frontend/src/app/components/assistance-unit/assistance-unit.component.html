<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  [fullWidth]="true"
  (imprimir)="openPrintDialog()"
  (salvar)="save()"
  (cancelar)="resetForm()"
  (excluir)="requestDeletion()"
  (novo)="startNew()"
  (buscar)="onBuscar()"
  (fechar)="closeForm()"
>
<header class="page-title page-title--row" slot="titulo">
  <div>
    <p class="page-title__label"></p>
  </div>
</header>

<section class="cadastro">
  <div class="cadastro-layout">
    <aside class="cadastro-menu">
      <div class="tab-shell">
        <p class="tab-shell__title tab-shell__title--destaque">
          <fa-icon [icon]="faHospitalUser" class="tab-shell__icon"></fa-icon>
          cadastros de Unidade Assistencial
        </p>
        <ol class="step-tabs" role="tablist">
          <li
            *ngFor="let tab of tabs; index as idx"
            class="step-tabs__item"
            [class.active]="activeTab === tab.id"
            [class.completed]="idx < activeTabIndex"
            [attr.data-tab]="tab.id"
          >
            <button
              type="button"
              class="step-tabs__button"
              role="tab"
              [attr.aria-selected]="activeTab === tab.id"
              (click)="changeTab(tab.id)"
            >
              <span class="step-tabs__index" aria-hidden="true">{{ idx + 1 }}</span>
              <span class="step-tabs__label">{{ tab.label }}</span>
            </button>
          </li>
        </ol>
      </div>
    </aside>

    <div class="cadastro-conteudo">

  <div class="print-dialog" *ngIf="printDialogOpen">
    <div class="print-dialog__backdrop" (click)="closePrintDialog()"></div>
    <div
      class="print-dialog__card"
      role="dialog"
      aria-modal="true"
      aria-label="Opções de impressão"
    >
      <div class="print-dialog__header">
        <p class="print-dialog__title">Opções de impressão</p>
        <p class="print-dialog__subtitle">Escolha o relatório que deseja gerar.</p>
      </div>
      <div class="print-dialog__actions">
        <button type="button" class="btn-primary" (click)="printUnidadePrincipal()">
          Imprimir unidade principal
        </button>
        <button type="button" class="btn-outline" (click)="printUnitList()">
          Imprimir listagem de unidade
        </button>
      </div>
    </div>
  </div>

  <form [formGroup]="form" class="form-shell" (ngSubmit)="save()">
    <div
      *ngIf="feedback"
      class="alert"
      [ngClass]="{
        'alert-success': feedback.type === 'success',
        'alert-error': feedback.type === 'error',
        'alert-warning': feedback.type === 'warning'
      }"
    >
      <span class="alert__message">{{ feedback.message }}</span>
      <button type="button" class="alert__close" aria-label="Fechar mensagem" (click)="dismissFeedback()">
        <span aria-hidden="true">×</span>
      </button>
    </div>

    <section class="tab-card" *ngIf="activeTab === 'dados'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('dados') }}</p>
          <p class="muted">Informações institucionais e contatos principais.</p>
        </div>
      </div>

      <div class="field-grid cols-2">
        <div class="field full field-inline">
          <label class="field-inline__label">Nome fantasia*</label>
          <div class="field-inline__content">
            <input id="nomeFantasia" type="text" formControlName="nomeFantasia" placeholder="Ex.: Unidade Central" />
            <label class="field-checkbox">
              <input type="checkbox" formControlName="unidadePrincipal" [disabled]="!podeMarcarPrincipal" />
              Unidade principal
            </label>
            <span class="field-inline__hint" *ngIf="!podeMarcarPrincipal">
              Ja existe uma unidade principal.
            </span>
          </div>
          <span class="hint" *ngIf="form.get('nomeFantasia')?.touched && form.get('nomeFantasia')?.invalid">
            Informe um nome fantasia válido para a unidade.
          </span>
        </div>

        <label class="field full">Razão social
          <input id="razaoSocial" type="text" formControlName="razaoSocial" placeholder="Nome empresarial" />
          <span class="hint" *ngIf="form.get('razaoSocial')?.touched && form.get('razaoSocial')?.invalid">
            Informe a razão social da instituição.
          </span>
        </label>

        <label class="field">CNPJ
          <input
            id="cnpj"
            type="text"
            formControlName="cnpj"
            placeholder="00.000.000/0000-00"
            (input)="onCnpjInput($event)"
          />
          <span class="hint" *ngIf="form.get('cnpj')?.errors?.['cnpjInvalid']">
            Informe um CNPJ válido.
          </span>
        </label>

        <label class="field">Telefone
          <input
            id="telefone"
            type="text"
            formControlName="telefone"
            placeholder="(00) 00000-0000"
            (input)="onPhoneInput($event)"
          />
        </label>

        <label class="field">E-mail
          <input id="email" type="email" formControlName="email" placeholder="contato@unidade.com" />
          <span class="hint" *ngIf="form.get('email')?.touched && form.get('email')?.invalid">
            Informe um e-mail válido.
          </span>
        </label>

        <label class="field">Site
          <input id="site" type="text" formControlName="site" placeholder="www.unidade.com.br" />
        </label>

        <label class="field">Horário de funcionamento
          <input
            id="horarioFuncionamento"
            type="text"
            formControlName="horarioFuncionamento"
            placeholder="Ex.: Segunda a sexta, das 8h às 17h"
          />
        </label>

        <label class="field full">Observações
          <textarea
            id="observacoes"
            formControlName="observacoes"
            rows="3"
            placeholder="Instruções internas, horário de atendimento, etc."
          ></textarea>
        </label>

        <div class="field full room-manager">
          <label class="field-title">Salas de atendimento</label>
          <div class="room-manager__actions">
            <input
              #novaSala
              type="text"
              placeholder="Ex.: Sala 01"
              [disabled]="!unidade?.id"
            />
            <button
              type="button"
              class="ghost"
              (click)="addSala(novaSala.value); novaSala.value = ''"
              [disabled]="!unidade?.id"
            >
              +
            </button>
          </div>
          <div class="search-hint" *ngIf="!unidade?.id">Salve a unidade para cadastrar salas.</div>
          <div class="search-hint" *ngIf="salasLoading">Carregando salas...</div>
          <div class="room-list" *ngIf="salasUnidade.length">
            <div class="room-chip" *ngFor="let sala of salasUnidade">
              <span>{{ sala.nome }}</span>
              <div class="room-chip__actions">
                <button type="button" class="ghost tiny" (click)="editSala(sala)">Editar</button>
                <button type="button" class="danger ghost tiny" (click)="removeSala(sala)">Remover</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="tab-card" *ngIf="activeTab === 'endereco'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('endereco') }}</p>
          <p class="muted">Localização completa para correspondências e visitas.</p>
        </div>
      </div>

      <div class="field-grid cols-3">
        <label class="field">CEP
          <input
            id="cep"
            type="text"
            formControlName="cep"
            placeholder="00000-000"
            inputmode="numeric"
            maxlength="9"
            (input)="onCepInput($event)"
          />
        </label>

        <label class="field full">endereço
          <input id="endereco" type="text" formControlName="endereco" placeholder="Rua, avenida..." />
        </label>

        <label class="field">Número
          <input id="numeroEndereco" type="text" formControlName="numeroEndereco" placeholder="Número" />
        </label>

        <label class="field">Complemento
          <input id="complementoEndereco" type="text" formControlName="complemento" placeholder="Apartamento, sala, bloco..." />
        </label>

        <label class="field">Bairro
          <input id="bairro" type="text" formControlName="bairro" placeholder="Bairro" />
        </label>

        <label class="field">Ponto de referência
          <input id="pontoReferencia" type="text" formControlName="pontoReferencia" placeholder="Próximo a..." />
        </label>

        <label class="field">Cidade
          <input
            id="cidade"
            type="text"
            formControlName="cidade"
            placeholder="Cidade"
            list="cidades-mg-list"
            (input)="onCidadeInput($event)"
          />
          <datalist id="cidades-mg-list">
            <option *ngFor="let cidade of cidadesMG" [value]="cidade.nome"></option>
          </datalist>
        </label>

        <label class="field">Zona
          <select id="zona" formControlName="zona">
            <option value="">Selecione...</option>
            <option value="URBANA">Urbana</option>
            <option value="RURAL">Rural</option>
          </select>
        </label>

        <label class="field">Subzona
          <select id="subzona" formControlName="subzona">
            <option value="">Selecione...</option>
            <option value="ZONA NORTE">Zona Norte</option>
            <option value="ZONA SUL">Zona Sul</option>
            <option value="ZONA LESTE">Zona Leste</option>
            <option value="ZONA OESTE">Zona Oeste</option>
            <option value="ZONA CENTRAL">Zona Central</option>
          </select>
        </label>

        <label class="field">Estado
          <select id="estado" formControlName="estado">
            <option value="">Selecione...</option>
            <option *ngFor="let uf of estados" [value]="uf">{{ uf }}</option>
          </select>
        </label>

        <div class="field">
          <span>Localização</span>
          <div class="button-row">
            <button
              type="button"
              class="btn-outline"
              (click)="buscarLocalizacao()"
              [disabled]="buscandoLocalizacao || !unidade?.id"
            >
              Buscar latitude/longitude
            </button>
            <button
              type="button"
              class="btn-primary"
              (click)="usarLocalizacaoAtual()"
            >
              Usar localização atual
            </button>
          </div>
          <span class="hint" *ngIf="!unidade?.id">Salve a unidade antes de buscar a localização.</span>
          <span class="hint">Use a localização atual estando na instituição.</span>
        </div>

        <label class="field">Raio do ponto (m)
          <input id="raioPontoMetros" type="number" formControlName="raioPontoMetros" />
        </label>

        <label class="field">Precisão máxima do GPS (m)
          <input id="accuracyMaxPontoMetros" type="number" formControlName="accuracyMaxPontoMetros" />
        </label>

        <label class="field">Latitude
          <input id="latitude" type="text" formControlName="latitude" placeholder="Ex.: -19.9208" readonly />
        </label>

        <label class="field">Longitude
          <input id="longitude" type="text" formControlName="longitude" placeholder="Ex.: -43.9378" readonly />
        </label>

        <label class="field full">IP interno para validação do ponto
          <input id="ipValidacaoPonto" type="text" formControlName="ipValidacaoPonto" placeholder="Ex.: 192.168.0.100" />
        </label>

        <label class="field">Timeout do ping (ms)
          <input id="pingTimeoutMs" type="number" formControlName="pingTimeoutMs" />
        </label>
      </div>
    </section>

    <section class="tab-card" *ngIf="activeTab === 'imagens'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('imagens') }}</p>
          <p class="muted">Inclua logomarcas e versões para relatórios.</p>
        </div>
      </div>

      <div class="field-grid cols-2">
        <label class="field full">Logomarca
          <div class="file-row">
            <div class="file-row__controls">
              <input
                id="logomarca"
                type="file"
                accept="image/*"
                class="input"
                (change)="onLogoSelected($event)"
              />
              <button type="button" class="btn-outline" (click)="clearLogo()" *ngIf="logoPreview">Remover</button>
            </div>
            <div *ngIf="logoPreview" class="preview">
              <p class="hint">Pré-visualização</p>
              <img [src]="logoPreview" alt="Pré-visualização da logomarca" />
            </div>
            <p class="hint">Imagens quadradas funcionam melhor na tela de login.</p>
          </div>
        </label>

        <label class="field full">Imagem para relatórios (PDF)
          <div class="file-row">
            <div class="file-row__controls">
              <input
                id="logomarcaRelatorio"
                type="file"
                accept="image/*"
                class="input"
                (change)="onReportLogoSelected($event)"
              />
              <button type="button" class="btn-outline" (click)="clearReportLogo()" *ngIf="reportLogoPreview">Remover</button>
            </div>
            <div *ngIf="reportLogoPreview" class="preview">
              <p class="hint">Pré-visualização</p>
              <img [src]="reportLogoPreview" alt="Pré-visualização da imagem para relatórios" />
            </div>
            <p class="hint">Use uma versão horizontal ou em alta resolução para relatórios e PDFs.</p>
          </div>
        </label>
      </div>
    </section>

    <section class="tab-card" *ngIf="activeTab === 'diretoria'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('diretoria') }}</p>
          <p class="muted">Cadastre os membros da diretoria para relatórios e identificação.</p>
        </div>
      </div>

      <div class="diretoria-toolbar">
        <p class="muted">Informe nome completo, documento e funcao.</p>
        <button type="button" class="btn-outline btn-small" (click)="addDiretoria()">Adicionar membro</button>
      </div>

      <div class="field-grid cols-2 diretoria-mandato">
        <label class="field">Mandato inicio
          <input type="text" formControlName="mandatoInicio" placeholder="Ex.: 2024" />
        </label>
        <label class="field">Mandato fim
          <input type="text" formControlName="mandatoFim" placeholder="Ex.: 2026" />
        </label>
      </div>

      <div class="diretoria-grid" formArrayName="diretoria">
        <div class="diretoria-grid__header">
          <span>Nome completo</span>
          <span>CPF</span>
          <span>Função</span>
          <span>Ações</span>
        </div>
        <div
          class="diretoria-grid__row"
          *ngFor="let grupo of diretoriaForm.controls; index as idx"
          [formGroupName]="idx"
        >
          <input
            type="text"
            formControlName="nomeCompleto"
            placeholder="Ex.: Maria da Silva"
            [class.input-error]="grupo.get('nomeCompleto')?.touched && grupo.get('nomeCompleto')?.errors?.['requiredDiretoria']"
          />
          <input
            type="text"
            formControlName="documento"
            placeholder="000.000.000-00"
            inputmode="numeric"
            maxlength="14"
            (input)="onDiretoriaCpfInput(idx, $event)"
            [class.input-error]="grupo.get('documento')?.touched && (grupo.get('documento')?.errors?.['cpfInvalid'] || grupo.get('documento')?.errors?.['requiredDiretoria'])"
          />
          <span class="diretoria-grid__error" *ngIf="grupo.get('documento')?.touched && grupo.get('documento')?.errors?.['cpfInvalid']">
            CPF inválido.
          </span>
          <input
            type="text"
            formControlName="funcao"
            placeholder="Ex.: Tesoureiro"
            [class.input-error]="grupo.get('funcao')?.touched && grupo.get('funcao')?.errors?.['requiredDiretoria']"
          />
          <button type="button" class="btn-outline btn-small" (click)="removeDiretoria(idx)">Remover</button>
        </div>
      </div>
    </section>

    <div *ngIf="deleteConfirmation" class="alert alert-warning delete-warning">
      <div class="flex-1">
        <p class="font-semibold">Atenção</p>
        <p>Você está excluindo a unidade. Tem certeza? Esta ação é irreversível.</p>
      </div>
      <div class="flex gap-2 flex-wrap justify-end">
        <button type="button" class="btn-outline" (click)="cancelDeletion()">Cancelar</button>
        <button type="button" class="btn-danger" (click)="confirmDeletion()">Confirmar exclusão</button>
      </div>
    </div>
  </form>

    <section class="tab-card" *ngIf="activeTab === 'lista'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">Listagem de unidades</p>
          <p class="muted">Selecione uma unidade para abrir o cadastro e editar.</p>
        </div>
      </div>

      <div class="unit-active" *ngIf="unidadePrincipal" (dblclick)="selecionarUnidade(unidadePrincipal)">
        <div>
          <p class="unit-active__eyebrow">Unidade principal</p>
          <p class="unit-active__name">{{ unidadePrincipal.nomeFantasia || 'Unidade sem nome' }}</p>
          <p class="unit-active__meta">
            {{ unidadePrincipal.cnpj || 'CNPJ não informado' }} · {{ unidadePrincipal.email || 'Sem e-mail' }}
          </p>
        </div>
      </div>

    <div class="unit-list" *ngIf="unidadesOrdenadas.length && unidadesPaginadas.length">
        <div
          class="unit-list__item"
          *ngFor="let unidadeItem of unidadesPaginadas"
          (dblclick)="selecionarUnidade(unidadeItem)"
        >
          <div>
            <p class="unit-list__name">{{ unidadeItem.nomeFantasia || 'Unidade sem nome' }}</p>
            <p class="unit-list__meta">
              {{ unidadeItem.cnpj || 'CNPJ não informado' }} · {{ unidadeItem.email || 'Sem e-mail' }}
            </p>
          </div>
          <div class="unit-list__actions">
            <span class="unit-list__action" *ngIf="unidadeItem.unidadePrincipal">Ativa</span>
          </div>
        </div>
      </div>

    <div class="unit-list__pagination" *ngIf="unidadesOrdenadas.length && unidadesPaginadas.length">
      <span class="unit-list__total">
        Total: {{ unidadesOrdenadas.length }} unidades · {{ unidadePrincipal ? '1 ativa' : '0 ativa' }}
      </span>
      <button type="button" class="btn-outline" (click)="paginaAnterior()" [disabled]="paginaAtual === 1">
        Anterior
      </button>
      <span class="unit-list__page">
        Página {{ paginaAtual }} de {{ totalPaginas }}
      </span>
      <button type="button" class="btn-outline" (click)="proximaPagina()" [disabled]="paginaAtual >= totalPaginas">
        Próximo
      </button>
    </div>

    <p class="muted" *ngIf="!unidadesOrdenadas.length">Nenhuma unidade cadastrada até o momento.</p>
    <p class="muted" *ngIf="unidadesOrdenadas.length && !unidadesPaginadas.length">
      Nenhuma unidade para listar.
    </p>
  </section>
    </div>
  </div>
</section>
</app-tela-padrao>




