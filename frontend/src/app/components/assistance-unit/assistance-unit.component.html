<section class="unit-page">
  <header class="page-title">
    <p class="page-title__eyebrow">Unidade assistencial</p>
    <p class="page-title__label">Cadastro da unidade</p>
  </header>

  <div class="tab-shell">
    <p class="tab-shell__title">Navegação por etapas</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of tabs; index as idx"
        class="step-tabs__item"
        [class.active]="activeTab === tab.id"
        [class.completed]="idx < activeTabIndex"
        [attr.data-tab]="tab.id"
      >
        <button
          type="button"
          class="step-tabs__button"
          role="tab"
          [attr.aria-selected]="activeTab === tab.id"
          (click)="changeTab(tab.id)"
        >
          <span class="step-tabs__index" aria-hidden="true">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ tab.label }}</span>
        </button>
      </li>
    </ol>
  </div>

  <form [formGroup]="form" class="form-shell" (ngSubmit)="save()">
    <div *ngIf="feedback" class="alert" [ngClass]="{
        'alert-success': feedback.type === 'success',
        'alert-error': feedback.type === 'error',
        'alert-warning': feedback.type === 'warning'
      }">
      {{ feedback.message }}
    </div>

    <section class="tab-card" *ngIf="activeTab === 'dados'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('dados') }}</p>
          <p class="muted">Informações institucionais e contatos principais.</p>
        </div>
        <div class="nav-buttons" aria-label="Ações rápidas da unidade">
          <button type="button" class="nav-button" (click)="printUnit()" [disabled]="!unidade">
            <span class="nav-button__icon" aria-hidden="true">
              <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M6 4.5C6 3.67157 6.67157 3 7.5 3H12.5C13.3284 3 14 3.67157 14 4.5V6H6V4.5Z"
                  fill="currentColor"
                />
                <path
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                  d="M5 6H15C16.1046 6 17 6.89543 17 8V11.5C17 12.3284 16.3284 13 15.5 13H14V14.5C14 15.3284 13.3284 16 12.5 16H7.5C6.67157 16 6 15.3284 6 14.5V13H4.5C3.67157 13 3 12.3284 3 11.5V8C3 6.89543 3.89543 6 5 6ZM7.5 8.75C7.22386 8.75 7 8.97386 7 9.25C7 9.52614 7.22386 9.75 7.5 9.75H12.5C12.7761 9.75 13 9.52614 13 9.25C13 8.97386 12.7761 8.75 12.5 8.75H7.5Z"
                  fill="currentColor"
                />
              </svg>
            </span>
            <span class="nav-button__label">Imprimir dados</span>
          </button>
          <button type="button" class="nav-button" (click)="save()">
            <span class="nav-button__icon" aria-hidden="true">
              <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M5 3C4.44772 3 4 3.44772 4 4V16C4 16.5523 4.44772 17 5 17H15C15.5523 17 16 16.5523 16 16V6.41421C16 6.149 15.8946 5.89464 15.7071 5.70711L13.2929 3.29289C13.1054 3.10536 12.851 3 12.5858 3H5Z"
                  stroke="currentColor"
                  stroke-width="1.25"
                />
                <path d="M7 3.5H12V7H7V3.5Z" fill="currentColor" />
                <rect x="7" y="11.5" width="6" height="3" rx="0.5" fill="currentColor" />
              </svg>
            </span>
            <span class="nav-button__label">Salvar</span>
          </button>
          <button type="button" class="nav-button" (click)="resetForm()">
            <span class="nav-button__icon" aria-hidden="true">
              <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M4.5 10C4.5 7.51472 6.51472 5.5 9 5.5H12.5"
                  stroke="currentColor"
                  stroke-width="1.25"
                  stroke-linecap="round"
                />
                <path
                  d="M12 3.5L14.5 5.75L12 8"
                  stroke="currentColor"
                  stroke-width="1.25"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M15.5 10C15.5 12.4853 13.4853 14.5 11 14.5H7.5"
                  stroke="currentColor"
                  stroke-width="1.25"
                  stroke-linecap="round"
                />
                <path
                  d="M8 16.5L5.5 14.25L8 12"
                  stroke="currentColor"
                  stroke-width="1.25"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </span>
            <span class="nav-button__label">Cancelar</span>
          </button>
          <button
            type="button"
            class="nav-button nav-button--danger"
            *ngIf="unidade?.id"
            (click)="requestDeletion()"
          >
            <span class="nav-button__icon" aria-hidden="true">
              <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M8 3.5H12C12.2761 3.5 12.5 3.72386 12.5 4V4.5H16"
                  stroke="currentColor"
                  stroke-width="1.25"
                  stroke-linecap="round"
                />
                <path d="M4 4.5H7.5V4C7.5 3.72386 7.72386 3.5 8 3.5" stroke="currentColor" stroke-width="1.25" />
                <path
                  d="M6.5 7.5V15.5C6.5 16.0523 6.94772 16.5 7.5 16.5H12.5C13.0523 16.5 13.5 16.0523 13.5 15.5V7.5"
                  stroke="currentColor"
                  stroke-width="1.25"
                  stroke-linecap="round"
                />
                <path d="M9.25 9.5V14" stroke="currentColor" stroke-width="1.25" stroke-linecap="round" />
                <path d="M10.75 9.5V14" stroke="currentColor" stroke-width="1.25" stroke-linecap="round" />
              </svg>
            </span>
            <span class="nav-button__label">Excluir</span>
          </button>
          <button type="button" class="nav-button" (click)="startNew()">
            <span class="nav-button__icon" aria-hidden="true">
              <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M10 4.5V15.5"
                  stroke="currentColor"
                  stroke-width="1.25"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M4.5 10H15.5"
                  stroke="currentColor"
                  stroke-width="1.25"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </span>
            <span class="nav-button__label">Novo</span>
          </button>
          <button type="button" class="nav-button" (click)="closeForm()">
            <span class="nav-button__icon" aria-hidden="true">
              <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M6.5 6.5L13.5 13.5"
                  stroke="currentColor"
                  stroke-width="1.25"
                  stroke-linecap="round"
                />
                <path
                  d="M13.5 6.5L6.5 13.5"
                  stroke="currentColor"
                  stroke-width="1.25"
                  stroke-linecap="round"
                />
              </svg>
            </span>
            <span class="nav-button__label">Fechar</span>
          </button>
        </div>
      </div>

      <div class="field-grid cols-2">
        <label class="field full">Nome fantasia*
          <input id="nomeFantasia" type="text" formControlName="nomeFantasia" placeholder="Ex.: Unidade Central" />
          <span class="hint" *ngIf="form.get('nomeFantasia')?.touched && form.get('nomeFantasia')?.invalid">
            Informe um nome fantasia válido para a unidade.
          </span>
        </label>

        <label class="field full">Razão social
          <input id="razaoSocial" type="text" formControlName="razaoSocial" placeholder="Nome empresarial" />
          <span class="hint" *ngIf="form.get('razaoSocial')?.touched && form.get('razaoSocial')?.invalid">
            Informe a razão social da instituição.
          </span>
        </label>

        <label class="field">CNPJ
          <input id="cnpj" type="text" formControlName="cnpj" placeholder="00.000.000/0000-00" />
          <span class="hint" *ngIf="form.get('cnpj')?.touched && form.get('cnpj')?.invalid">Informe um CNPJ.</span>
        </label>

        <label class="field">Telefone
          <input
            id="telefone"
            type="text"
            formControlName="telefone"
            placeholder="(00) 00000-0000"
            (input)="onPhoneInput($event)"
          />
        </label>

        <label class="field">E-mail
          <input id="email" type="email" formControlName="email" placeholder="contato@unidade.com" />
          <span class="hint" *ngIf="form.get('email')?.touched && form.get('email')?.invalid">
            Informe um e-mail válido.
          </span>
        </label>

        <label class="field">Horário de funcionamento
          <input
            id="horarioFuncionamento"
            type="text"
            formControlName="horarioFuncionamento"
            placeholder="Ex.: Segunda a sexta, das 8h às 17h"
          />
        </label>

        <label class="field full">Observações
          <textarea
            id="observacoes"
            formControlName="observacoes"
            rows="3"
            placeholder="Instruções internas, horário de atendimento, etc."
          ></textarea>
        </label>
      </div>
    </section>

    <section class="tab-card" *ngIf="activeTab === 'endereco'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('endereco') }}</p>
          <p class="muted">Localização completa para correspondências e visitas.</p>
        </div>
      </div>

      <div class="field-grid cols-3">
        <label class="field">CEP
          <input
            id="cep"
            type="text"
            formControlName="cep"
            placeholder="00000-000"
            inputmode="numeric"
            maxlength="9"
            (input)="onCepInput($event)"
          />
        </label>

        <label class="field full">Endereço
          <input id="endereco" type="text" formControlName="endereco" placeholder="Rua, avenida..." />
        </label>

        <label class="field">Número
          <input id="numeroEndereco" type="text" formControlName="numeroEndereco" placeholder="Número" />
        </label>

        <label class="field">Bairro
          <input id="bairro" type="text" formControlName="bairro" placeholder="Bairro" />
        </label>

        <label class="field">Cidade
          <input id="cidade" type="text" formControlName="cidade" placeholder="Cidade" />
        </label>

        <label class="field">Estado
          <select id="estado" formControlName="estado">
            <option value="">Selecione...</option>
            <option *ngFor="let uf of estados" [value]="uf">{{ uf }}</option>
          </select>
        </label>
      </div>
    </section>

    <section class="tab-card" *ngIf="activeTab === 'imagens'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('imagens') }}</p>
          <p class="muted">Inclua logomarcas e versões para relatórios.</p>
        </div>
      </div>

      <div class="field-grid cols-2">
        <label class="field full">Logomarca
          <div class="file-row">
            <div class="file-row__controls">
              <input
                id="logomarca"
                type="file"
                accept="image/*"
                class="input"
                (change)="onLogoSelected($event)"
              />
              <button type="button" class="btn-outline" (click)="clearLogo()" *ngIf="logoPreview">Remover</button>
            </div>
            <div *ngIf="logoPreview" class="preview">
              <p class="hint">Pré-visualização</p>
              <img [src]="logoPreview" alt="Pré-visualização da logomarca" />
            </div>
            <p class="hint">Imagens quadradas funcionam melhor na tela de login.</p>
          </div>
        </label>

        <label class="field full">Imagem para relatórios (PDF)
          <div class="file-row">
            <div class="file-row__controls">
              <input
                id="logomarcaRelatorio"
                type="file"
                accept="image/*"
                class="input"
                (change)="onReportLogoSelected($event)"
              />
              <button type="button" class="btn-outline" (click)="clearReportLogo()" *ngIf="reportLogoPreview">Remover</button>
            </div>
            <div *ngIf="reportLogoPreview" class="preview">
              <p class="hint">Pré-visualização</p>
              <img [src]="reportLogoPreview" alt="Pré-visualização da imagem para relatórios" />
            </div>
            <p class="hint">Use uma versão horizontal ou em alta resolução para relatórios e PDFs.</p>
          </div>
        </label>
      </div>
    </section>

    <section class="tab-card" *ngIf="activeTab === 'diretoria'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('diretoria') }}</p>
          <p class="muted">Dados do responsável e período de mandato.</p>
        </div>
      </div>

      <div class="field-grid cols-2">
        <label class="field full">Diretor(a) / coordenador(a) / presidente
          <input
            id="responsavelNome"
            type="text"
            formControlName="responsavelNome"
            placeholder="Nome completo do responsável"
          />
        </label>

        <label class="field">CPF do responsável
          <input
            id="responsavelCpf"
            type="text"
            formControlName="responsavelCpf"
            placeholder="000.000.000-00"
            inputmode="numeric"
            maxlength="14"
            (input)="onCpfInput($event)"
          />
          <span class="hint" *ngIf="form.get('responsavelCpf')?.touched && form.get('responsavelCpf')?.invalid">
            Informe um CPF válido.
          </span>
        </label>

        <label class="field">Período de mandato
          <input
            id="responsavelPeriodoMandato"
            type="text"
            formControlName="responsavelPeriodoMandato"
            placeholder="Ex.: 2024 - 2026"
          />
        </label>
      </div>
    </section>

    <div *ngIf="deleteConfirmation" class="alert alert-warning delete-warning">
      <div class="flex-1">
        <p class="font-semibold">Atenção</p>
        <p>Você está excluindo a unidade. Tem certeza? Esta ação é irreversível.</p>
      </div>
      <div class="flex gap-2 flex-wrap justify-end">
        <button type="button" class="btn-outline" (click)="cancelDeletion()">Cancelar</button>
        <button type="button" class="btn-danger" (click)="confirmDeletion()">Confirmar exclusão</button>
      </div>
    </div>
  </form>

  <div class="card card--compact data-card">
    <div class="card__header-row">
      <div class="card__header">Dados atuais da unidade</div>
      <button type="button" class="btn-outline" *ngIf="unidade" (click)="printUnit()">Imprimir dados</button>
    </div>
    <p class="text-sm text-slate-600" *ngIf="!unidade">Nenhuma unidade cadastrada até o momento.</p>
    <div *ngIf="unidade" class="unit-data-grid">
      <div class="unit-data-grid__item unit-data-grid__logo" *ngIf="unidade.logomarca">
        <p class="unit-data-grid__label">Logomarca</p>
        <img [src]="unidade.logomarca" alt="Logomarca da unidade" />
      </div>
      <div class="unit-data-grid__item unit-data-grid__report" *ngIf="unidade.logomarcaRelatorio">
        <p class="unit-data-grid__label">Imagem dos relatórios</p>
        <img [src]="unidade.logomarcaRelatorio" alt="Imagem utilizada em relatórios" />
      </div>
      <p class="unit-data-grid__item unit-data-grid__fantasy">
        <span class="unit-data-grid__label">Nome fantasia:</span>
        {{ unidade.nomeFantasia }}
      </p>
      <p class="unit-data-grid__item unit-data-grid__cnpj">
        <span class="unit-data-grid__label">CNPJ:</span>
        {{ unidade.cnpj || 'Não informado' }}
      </p>
      <p class="unit-data-grid__item unit-data-grid__phone">
        <span class="unit-data-grid__label">Telefone:</span>
        {{ unidade.telefone || 'Não informado' }}
      </p>
      <p class="unit-data-grid__item unit-data-grid__razao">
        <span class="unit-data-grid__label">Razão social:</span>
        {{ unidade.razaoSocial || 'Não informada' }}
      </p>
      <p class="unit-data-grid__item unit-data-grid__email">
        <span class="unit-data-grid__label">E-mail:</span>
        {{ unidade.email || 'Não informado' }}
      </p>
      <p class="unit-data-grid__item unit-data-grid__cep">
        <span class="unit-data-grid__label">CEP:</span>
        {{ unidade.cep || 'Não informado' }}
      </p>
      <p class="unit-data-grid__item unit-data-grid__cidade">
        <span class="unit-data-grid__label">Cidade/Estado:</span>
        {{ unidade.cidade || 'Sem cidade' }} / {{ unidade.estado || 'UF' }}
      </p>
      <p class="unit-data-grid__item unit-data-grid__schedule">
        <span class="unit-data-grid__label">Horário de funcionamento:</span>
        {{ unidade.horarioFuncionamento || 'Não informado' }}
      </p>
      <p class="unit-data-grid__item unit-data-grid__mandate">
        <span class="unit-data-grid__label">Período de mandato:</span>
        {{ unidade.responsavelPeriodoMandato || 'Não informado' }}
      </p>
      <p class="unit-data-grid__item unit-data-grid__address">
        <span class="unit-data-grid__label">Endereço:</span>
        {{ unidade.endereco }} {{ unidade.numeroEndereco }}
      </p>
      <p class="unit-data-grid__item unit-data-grid__district">
        <span class="unit-data-grid__label">Bairro:</span>
        {{ unidade.bairro || 'Não informado' }}
      </p>
      <p class="unit-data-grid__item unit-data-grid__responsavel">
        <span class="unit-data-grid__label">Responsável:</span>
        {{ unidade.responsavelNome || 'Não informado' }}
      </p>
      <p class="unit-data-grid__item unit-data-grid__cpf">
        <span class="unit-data-grid__label">CPF:</span>
        {{ unidade.responsavelCpf || 'Não informado' }}
      </p>
      <p class="unit-data-grid__item unit-data-grid__observacoes">
        <span class="unit-data-grid__label">Observações:</span>
        {{ unidade.observacoes || 'Nenhuma' }}
      </p>
    </div>
  </div>
</section>
