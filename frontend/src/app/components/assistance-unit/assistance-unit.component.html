<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  (imprimir)="openPrintDialog()"
  (salvar)="save()"
  (cancelar)="resetForm()"
  (excluir)="requestDeletion()"
  (novo)="startNew()"
  (buscar)="onBuscar()"
  (fechar)="closeForm()"
>
<header class="page-title page-title--row" slot="titulo">
  <div>
    <p class="page-title__eyebrow">cadastros</p>
    <p class="page-title__label">Unidade assistencial</p>
  </div>
  <p class="page-title__note">cadastro e gestao das unidades assistenciais.</p>
</header>

<section class="unit-page">
  <div class="tab-shell">
    <p class="tab-shell__title">NavegaÃ§Ã£o por etapas</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of tabs; index as idx"
        class="step-tabs__item"
        [class.active]="activeTab === tab.id"
        [class.completed]="idx < activeTabIndex"
        [attr.data-tab]="tab.id"
      >
        <button
          type="button"
          class="step-tabs__button"
          role="tab"
          [attr.aria-selected]="activeTab === tab.id"
          (click)="changeTab(tab.id)"
        >
          <span class="step-tabs__index" aria-hidden="true">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ tab.label }}</span>
        </button>
      </li>
    </ol>
  </div>


  <div class="toolbar-top">
  </div>

  <div class="print-dialog" *ngIf="printDialogOpen">
    <div class="print-dialog__backdrop" (click)="closePrintDialog()"></div>
    <div
      class="print-dialog__card"
      role="dialog"
      aria-modal="true"
      aria-label="Opcoes de impressão"
    >
      <div class="print-dialog__header">
        <p class="print-dialog__title">Opcoes de impressão</p>
        <p class="print-dialog__subtitle">Escolha o relatório que deseja gerar.</p>
      </div>
      <div class="print-dialog__actions">
        <button type="button" class="btn-primary" (click)="printUnidadePrincipal()">
          Imprimir unidade principal
        </button>
        <button type="button" class="btn-outline" (click)="printUnitList()">
          Imprimir listagem de unidade
        </button>
      </div>
    </div>
  </div>

  <form [formGroup]="form" class="form-shell" (ngSubmit)="save()">
    <div
      *ngIf="feedback"
      class="alert"
      [ngClass]="{
        'alert-success': feedback.type === 'success',
        'alert-error': feedback.type === 'error',
        'alert-warning': feedback.type === 'warning'
      }"
    >
      <span class="alert__message">{{ feedback.message }}</span>
      <button type="button" class="alert__close" aria-label="Fechar mensagem" (click)="dismissFeedback()">
        <span aria-hidden="true">Ã—</span>
      </button>
    </div>

    <section class="tab-card" *ngIf="activeTab === 'dados'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('dados') }}</p>
          <p class="muted">InformaÃ§Ãµes institucionais e contatos principais.</p>
        </div>
      </div>

      <div class="field-grid cols-2">
        <div class="field full field-inline">
          <label class="field-inline__label">Nome fantasia*</label>
          <div class="field-inline__content">
            <input id="nomeFantasia" type="text" formControlName="nomeFantasia" placeholder="Ex.: Unidade Central" />
            <label class="field-checkbox">
              <input type="checkbox" formControlName="unidadePrincipal" [disabled]="!podeMarcarPrincipal" />
              Unidade principal
            </label>
            <span class="field-inline__hint" *ngIf="!podeMarcarPrincipal">
              Ja existe uma unidade principal.
            </span>
          </div>
          <span class="hint" *ngIf="form.get('nomeFantasia')?.touched && form.get('nomeFantasia')?.invalid">
            Informe um nome fantasia válido para a unidade.
          </span>
        </div>

        <label class="field full">RazÃ£o social
          <input id="razaoSocial" type="text" formControlName="razaoSocial" placeholder="Nome empresarial" />
          <span class="hint" *ngIf="form.get('razaoSocial')?.touched && form.get('razaoSocial')?.invalid">
            Informe a razÃ£o social da instituiÃ§Ã£o.
          </span>
        </label>

        <label class="field">CNPJ
          <input
            id="cnpj"
            type="text"
            formControlName="cnpj"
            placeholder="00.000.000/0000-00"
            (input)="onCnpjInput($event)"
          />
          <span class="hint" *ngIf="form.get('cnpj')?.errors?.['cnpjInvalid']">
            Informe um CNPJ vÃ¡lido.
          </span>
        </label>

        <label class="field">Telefone
          <input
            id="telefone"
            type="text"
            formControlName="telefone"
            placeholder="(00) 00000-0000"
            (input)="onPhoneInput($event)"
          />
        </label>

        <label class="field">E-mail
          <input id="email" type="email" formControlName="email" placeholder="contato@unidade.com" />
          <span class="hint" *ngIf="form.get('email')?.touched && form.get('email')?.invalid">
            Informe um e-mail vÃ¡lido.
          </span>
        </label>

        <label class="field">Site
          <input id="site" type="text" formControlName="site" placeholder="www.unidade.com.br" />
        </label>

        <label class="field">HorÃ¡rio de funcionamento
          <input
            id="horarioFuncionamento"
            type="text"
            formControlName="horarioFuncionamento"
            placeholder="Ex.: Segunda a sexta, das 8h Ã s 17h"
          />
        </label>

        <label class="field full">ObservaÃ§Ãµes
          <textarea
            id="observacoes"
            formControlName="observacoes"
            rows="3"
            placeholder="InstruÃ§Ãµes internas, horÃ¡rio de atendimento, etc."
          ></textarea>
        </label>

        <div class="field full room-manager">
          <label class="field-title">Salas de atendimento</label>
          <div class="room-manager__actions">
            <input
              #novaSala
              type="text"
              placeholder="Ex.: Sala 01"
              [disabled]="!unidade?.id"
            />
            <button
              type="button"
              class="ghost"
              (click)="addSala(novaSala.value); novaSala.value = ''"
              [disabled]="!unidade?.id"
            >
              +
            </button>
          </div>
          <div class="search-hint" *ngIf="!unidade?.id">Salve a unidade para cadastrar salas.</div>
          <div class="search-hint" *ngIf="salasLoading">Carregando salas...</div>
          <div class="room-list" *ngIf="salasUnidade.length">
            <div class="room-chip" *ngFor="let sala of salasUnidade">
              <span>{{ sala.nome }}</span>
              <div class="room-chip__actions">
                <button type="button" class="ghost tiny" (click)="editSala(sala)">Editar</button>
                <button type="button" class="danger ghost tiny" (click)="removeSala(sala)">Remover</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="tab-card" *ngIf="activeTab === 'endereco'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('endereco') }}</p>
          <p class="muted">LocalizaÃ§Ã£o completa para correspondÃªncias e visitas.</p>
        </div>
      </div>

      <div class="field-grid cols-3">
        <label class="field">CEP
          <input
            id="cep"
            type="text"
            formControlName="cep"
            placeholder="00000-000"
            inputmode="numeric"
            maxlength="9"
            (input)="onCepInput($event)"
          />
        </label>

        <label class="field full">endereço
          <input id="endereco" type="text" formControlName="endereco" placeholder="Rua, avenida..." />
        </label>

        <label class="field">NÃºmero
          <input id="numeroEndereco" type="text" formControlName="numeroEndereco" placeholder="NÃºmero" />
        </label>

        <label class="field">Complemento
          <input id="complementoEndereco" type="text" formControlName="complemento" placeholder="Apartamento, sala, bloco..." />
        </label>

        <label class="field">Bairro
          <input id="bairro" type="text" formControlName="bairro" placeholder="Bairro" />
        </label>

        <label class="field">Ponto de referÃªncia
          <input id="pontoReferencia" type="text" formControlName="pontoReferencia" placeholder="PrÃ³ximo a..." />
        </label>

        <label class="field">Cidade
          <input
            id="cidade"
            type="text"
            formControlName="cidade"
            placeholder="Cidade"
            list="cidades-mg-list"
            (input)="onCidadeInput($event)"
          />
          <datalist id="cidades-mg-list">
            <option *ngFor="let cidade of cidadesMG" [value]="cidade.nome"></option>
          </datalist>
        </label>

        <label class="field">Zona
          <select id="zona" formControlName="zona">
            <option value="">Selecione...</option>
            <option value="URBANA">Urbana</option>
            <option value="RURAL">Rural</option>
          </select>
        </label>

        <label class="field">Subzona
          <select id="subzona" formControlName="subzona">
            <option value="">Selecione...</option>
            <option value="ZONA NORTE">Zona Norte</option>
            <option value="ZONA SUL">Zona Sul</option>
            <option value="ZONA LESTE">Zona Leste</option>
            <option value="ZONA OESTE">Zona Oeste</option>
            <option value="ZONA CENTRAL">Zona Central</option>
          </select>
        </label>

        <label class="field">Estado
          <select id="estado" formControlName="estado">
            <option value="">Selecione...</option>
            <option *ngFor="let uf of estados" [value]="uf">{{ uf }}</option>
          </select>
        </label>
      </div>
    </section>

    <section class="tab-card" *ngIf="activeTab === 'imagens'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('imagens') }}</p>
          <p class="muted">Inclua logomarcas e versÃµes para relatÃ³rios.</p>
        </div>
      </div>

      <div class="field-grid cols-2">
        <label class="field full">Logomarca
          <div class="file-row">
            <div class="file-row__controls">
              <input
                id="logomarca"
                type="file"
                accept="image/*"
                class="input"
                (change)="onLogoSelected($event)"
              />
              <button type="button" class="btn-outline" (click)="clearLogo()" *ngIf="logoPreview">Remover</button>
            </div>
            <div *ngIf="logoPreview" class="preview">
              <p class="hint">PrÃ©-visualizaÃ§Ã£o</p>
              <img [src]="logoPreview" alt="PrÃ©-visualizaÃ§Ã£o da logomarca" />
            </div>
            <p class="hint">Imagens quadradas funcionam melhor na tela de login.</p>
          </div>
        </label>

        <label class="field full">Imagem para relatÃ³rios (PDF)
          <div class="file-row">
            <div class="file-row__controls">
              <input
                id="logomarcaRelatorio"
                type="file"
                accept="image/*"
                class="input"
                (change)="onReportLogoSelected($event)"
              />
              <button type="button" class="btn-outline" (click)="clearReportLogo()" *ngIf="reportLogoPreview">Remover</button>
            </div>
            <div *ngIf="reportLogoPreview" class="preview">
              <p class="hint">PrÃ©-visualizaÃ§Ã£o</p>
              <img [src]="reportLogoPreview" alt="PrÃ©-visualizaÃ§Ã£o da imagem para relatÃ³rios" />
            </div>
            <p class="hint">Use uma versÃ£o horizontal ou em alta resoluÃ§Ã£o para relatÃ³rios e PDFs.</p>
          </div>
        </label>
      </div>
    </section>

    <section class="tab-card" *ngIf="activeTab === 'diretoria'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('diretoria') }}</p>
          <p class="muted">Cadastre os membros da diretoria para relatórios e identificação.</p>
        </div>
      </div>

      <div class="diretoria-toolbar">
        <p class="muted">Informe nome completo, documento e funcao.</p>
        <button type="button" class="btn-outline btn-small" (click)="addDiretoria()">Adicionar membro</button>
      </div>

      <div class="field-grid cols-2 diretoria-mandato">
        <label class="field">Mandato inicio
          <input type="text" formControlName="mandatoInicio" placeholder="Ex.: 2024" />
        </label>
        <label class="field">Mandato fim
          <input type="text" formControlName="mandatoFim" placeholder="Ex.: 2026" />
        </label>
      </div>

      <div class="diretoria-grid" formArrayName="diretoria">
        <div class="diretoria-grid__header">
          <span>Nome completo</span>
          <span>CPF</span>
          <span>Funcao</span>
          <span>AÃ§Ãµes</span>
        </div>
        <div
          class="diretoria-grid__row"
          *ngFor="let grupo of diretoriaForm.controls; index as idx"
          [formGroupName]="idx"
        >
          <input
            type="text"
            formControlName="nomeCompleto"
            placeholder="Ex.: Maria da Silva"
            [class.input-error]="grupo.get('nomeCompleto')?.touched && grupo.get('nomeCompleto')?.errors?.['requiredDiretoria']"
          />
          <input
            type="text"
            formControlName="documento"
            placeholder="000.000.000-00"
            inputmode="numeric"
            maxlength="14"
            (input)="onDiretoriaCpfInput(idx, $event)"
            [class.input-error]="grupo.get('documento')?.touched && (grupo.get('documento')?.errors?.['cpfInvalid'] || grupo.get('documento')?.errors?.['requiredDiretoria'])"
          />
          <span class="diretoria-grid__error" *ngIf="grupo.get('documento')?.touched && grupo.get('documento')?.errors?.['cpfInvalid']">
            CPF inválido.
          </span>
          <input
            type="text"
            formControlName="funcao"
            placeholder="Ex.: Tesoureiro"
            [class.input-error]="grupo.get('funcao')?.touched && grupo.get('funcao')?.errors?.['requiredDiretoria']"
          />
          <button type="button" class="btn-outline btn-small" (click)="removeDiretoria(idx)">Remover</button>
        </div>
      </div>
    </section>

    <div *ngIf="deleteConfirmation" class="alert alert-warning delete-warning">
      <div class="flex-1">
        <p class="font-semibold">AtenÃ§Ã£o</p>
        <p>VocÃª estÃ¡ excluindo a unidade. Tem certeza? Esta aÃ§Ã£o Ã© irreversÃ­vel.</p>
      </div>
      <div class="flex gap-2 flex-wrap justify-end">
        <button type="button" class="btn-outline" (click)="cancelDeletion()">Cancelar</button>
        <button type="button" class="btn-danger" (click)="confirmDeletion()">Confirmar exclusÃ£o</button>
      </div>
    </div>
  </form>

    <section class="tab-card" *ngIf="activeTab === 'lista'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">Unidades cadastradas</p>
          <p class="muted">Selecione uma unidade para abrir o cadastro e editar.</p>
        </div>
      </div>

      <div class="unit-active" *ngIf="unidadePrincipal">
        <div>
          <p class="unit-active__eyebrow">Unidade principal</p>
          <p class="unit-active__name">{{ unidadePrincipal.nomeFantasia || 'Unidade sem nome' }}</p>
          <p class="unit-active__meta">
            {{ unidadePrincipal.cnpj || 'CNPJ nÃ£o informado' }} Â· {{ unidadePrincipal.email || 'Sem e-mail' }}
          </p>
        </div>
        <button type="button" class="btn-outline btn-small" (click)="selecionarUnidade(unidadePrincipal)">
          Editar
        </button>
      </div>

    <div class="unit-list" *ngIf="unidadesOrdenadas.length && unidadesPaginadas.length">
        <div
          class="unit-list__item"
          *ngFor="let unidadeItem of unidadesPaginadas"
        >
          <div>
            <p class="unit-list__name">{{ unidadeItem.nomeFantasia || 'Unidade sem nome' }}</p>
            <p class="unit-list__meta">
              {{ unidadeItem.cnpj || 'CNPJ nÃ£o informado' }} Â· {{ unidadeItem.email || 'Sem e-mail' }}
            </p>
          </div>
          <div class="unit-list__actions">
            <span class="unit-list__action" *ngIf="unidadeItem.unidadePrincipal">Ativa</span>
            <button type="button" class="btn-outline btn-small" (click)="selecionarUnidade(unidadeItem)">
              Editar
            </button>
          </div>
        </div>
      </div>

    <div class="unit-list__pagination" *ngIf="unidadesOrdenadas.length && unidadesPaginadas.length">
      <span class="unit-list__total">
        Total: {{ unidadesOrdenadas.length }} unidades Â· {{ unidadePrincipal ? '1 ativa' : '0 ativa' }}
      </span>
      <button type="button" class="btn-outline" (click)="paginaAnterior()" [disabled]="paginaAtual === 1">
        Anterior
      </button>
      <span class="unit-list__page">
        PÃ¡gina {{ paginaAtual }} de {{ totalPaginas }}
      </span>
      <button type="button" class="btn-outline" (click)="proximaPagina()" [disabled]="paginaAtual >= totalPaginas">
        PrÃ³ximo
      </button>
    </div>

    <p class="muted" *ngIf="!unidadesOrdenadas.length">Nenhuma unidade cadastrada atÃ© o momento.</p>
    <p class="muted" *ngIf="unidadesOrdenadas.length && !unidadesPaginadas.length">
      Nenhuma unidade para listar.
    </p>
  </section>
</section>
</app-tela-padrao>




