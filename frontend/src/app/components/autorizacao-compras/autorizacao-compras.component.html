<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  (salvar)="salvarSolicitacao()"
  (excluir)="removerSolicitacaoSelecionada()"
  (novo)="iniciarNovaSolicitacao()"
  (cancelar)="limparFormularioSolicitacao()"
  (imprimir)="printSection()"
  (buscar)="onBuscar()"
  (fechar)="fecharTela()"
>
<header class="page-title page-title--row" slot="titulo">
  <div>
    <p class="page-title__eyebrow">SETOR FINANCEIRO</p>
    <p class="page-title__label">Autorização de Compras</p>
  </div>
  <p class="page-title__note">Gestao de solicitações e autorizações de compras.</p>
</header>

<section class="cadastro">
  <div class="tab-shell">
    <p class="tab-shell__title">Etapas principais</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let step of steps; index as idx"
        class="step-tabs__item"
        [class.active]="activeStep === step.id"
        [class.completed]="idx < activeStepIndex"
      >
        <button class="step-tabs__button" type="button" (click)="changeStep(step.id)">
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ step.label }}</span>
        </button>
      </li>
    </ol>
  </div>

  <div class="workspace">
    <div class="tab-card" [ngSwitch]="activeStep">
      <ng-container *ngSwitchCase="'solicitacao'">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">SolicitaÃ§Ã£o de compras</p>
          </div>
            <div class="tab-card__actions">
              <button class="ghost" type="button" (click)="printSection()">
                <fa-icon [icon]="faPrint"></fa-icon>
                Imprimir solicitaÃ§Ã£o
              </button>
              <button class="primary" type="button" (click)="navigateStep('next')">
                PrÃ³xima etapa
                <fa-icon [icon]="faArrowRight"></fa-icon>
              </button>
            </div>
        </div>

        <div class="grid-two-columns">
          <form class="panel" (ngSubmit)="createRequest()">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Nova solicitaÃ§Ã£o</p>
                <p class="panel__title">Detalhes da demanda</p>
              </div>
              <span class="pill">Etapa 1/5</span>
            </header>

            <app-popup-messages
              *ngIf="popupErros.length"
              [mensagens]="popupErros"
              (fechar)="fecharPopupErros()"
            ></app-popup-messages>

            <div class="form-grid">
              <div class="form-row form-row--line1">
                <label class="form-field form-field--type">
                  <span>Tipo*</span>
                  <select class="select" name="type" [(ngModel)]="newRequestForm.type">
                    <option value="produto">Compras de produtos</option>
                    <option value="bem">Compra de bens</option>
                    <option value="servico">AutorizaÃ§Ã£o de serviÃ§os</option>
                    <option value="contrato">Contratos</option>
                  </select>
                </label>
                <label class="form-field form-field--quantity">
                  <span>Quant.</span>
                  <input
                    class="input"
                    type="number"
                    min="1"
                    max="999999"
                    step="1"
                    name="quantity"
                    [(ngModel)]="newRequestForm.quantity"
                  />
                </label>
                <label class="form-field form-field--title">
                  <span>TÃ­tulo da compra*</span>
                  <input
                    class="input"
                    name="title"
                    [(ngModel)]="newRequestForm.title"
                    placeholder="Ex.: Kits pedagÃ³gicos"
                    required
                  />
                </label>
              </div>
              <div class="form-row form-row--line2">
                <label class="form-field">
                  <span>Ãrea solicitante</span>
                  <input class="input" name="area" [(ngModel)]="newRequestForm.area" placeholder="Setor / projeto" />
                </label>
                <label class="form-field">
                  <span>ResponsÃ¡vel*</span>
                  <select class="select" name="requester" [(ngModel)]="newRequestForm.requester" required>
                    <option value="" disabled [selected]="!newRequestForm.requester">Selecione um profissional</option>
                    <option *ngFor="let profissional of profissionais" [value]="profissional.nomeCompleto">
                      {{ profissional.nomeCompleto }}<span *ngIf="profissional.categoria"> â€¢ {{ profissional.categoria }}</span>
                    </option>
                  </select>
                </label>
                <label class="form-field form-field--value">
                  <span>Valor estimado*</span>
                  <input
                    class="input"
                    type="text"
                    name="value"
                    [value]="valorEstimadoDisplay"
                    inputmode="decimal"
                    placeholder="R$ 0,00"
                    (input)="formatValorEstimadoInput($event.target.value)"
                  />
                </label>
              </div>
              <div class="form-row form-row--line3">
                <label class="form-field">
                  <span>PrevisÃ£o / necessidade</span>
                  <input class="input" type="date" name="expectedDate" [(ngModel)]="newRequestForm.expectedDate" />
                </label>
                <label class="form-field form-field--priority">
                  <span>Prioridade</span>
                  <select class="select" name="priority" [(ngModel)]="newRequestForm.priority">
                    <option value="urgente">Urgente</option>
                    <option value="normal">Normal (nÃ£o urgente)</option>
                    <option value="baixa">Baixa prioridade</option>
                  </select>
                </label>
              </div>
              <label class="form-field form-field--full">
                <span>Justificativa e escopo*</span>
                <textarea
                  class="textarea"
                  name="justification"
                  [(ngModel)]="newRequestForm.justification"
                  rows="4"
                  placeholder="Objetivo, quantidades, critÃ©rios mÃ­nimos e impacto social"
                  required
                ></textarea>
              </label>
            </div>

            <div class="form-actions">
              <button
                class="primary"
                type="button"
                [disabled]="!podeSalvarSolicitacao"
                (click)="createRequest()"
              >
                Salvar solicitaÃ§Ã£o
              </button>
              <button class="ghost" type="button" (click)="navigateStep('next')">Pular para autorizaÃ§Ã£o</button>
            </div>
            <div class="pending-grid">
              <header class="pending-grid__header--meta">
                <div>
                  <p class="pending-grid__eyebrow">SolicitaÃ§Ãµes pendentes</p>
                  <p class="pending-grid__title">Aguardando autorizaÃ§Ã£o</p>
                </div>
                <span class="pill pill--ghost">{{ pendingSolicitacoes.length }} cadastrada(s)</span>
              </header>
              <div *ngIf="pendingSolicitacoes.length; else noPending">
                <div class="pending-grid__header">
                  <span>Quant.</span>
                  <span>Item</span>
                  <span>Resp.</span>
                  <span>Local</span>
                  <span>Prioridade</span>
                  <span>Prazo</span>
                  <span>Previsto</span>
                  <span class="text-center">AÃ§Ãµes</span>
                </div>
                <div class="pending-grid__list">
                  <article class="pending-grid__item" *ngFor="let request of pendingSolicitacoes">
                    <span class="pending-grid__quantidade">Qtd {{ request.quantity }}</span>
                    <span class="pending-grid__title">{{ request.title }}</span>
                    <span class="pending-grid__responsavel">{{ request.requester }}</span>
                    <span class="pending-grid__area">{{ request.area || 'Sem Ã¡rea' }}</span>
                    <span
                      class="pill pill--ghost pending-grid__priority"
                      *ngIf="request.priority"
                      [ngClass]="{
                        'pill--priority-urgente': request.priority === 'urgente',
                        'pill--priority-normal': request.priority === 'normal',
                        'pill--priority-baixa': request.priority === 'baixa'
                      }"
                    >
                      {{ request.priority | titlecase }}
                    </span>
                    <span class="pending-grid__prazo">{{ request.expectedDate | date: 'dd/MM/yyyy' }}</span>
                    <span class="pending-grid__valor">{{ request.value | currency: 'BRL' }}</span>
                    <div class="pending-grid__acoes">
                      <button class="chip chip--accent" type="button" (click)="avancarParaAutorizacao(request)">
                        Enviar para autorizaÃ§Ã£o
                      </button>
                      <small class="pending-grid__motivo" *ngIf="request.approval?.notes">
                        Motivo do parecer: {{ request.approval?.notes }}
                      </small>
                    </div>
                  </article>
                </div>
              </div>
              <ng-template #noPending>
                <p class="empty-state">Nenhuma solicitaÃ§Ã£o aguardando autorizaÃ§Ã£o no momento.</p>
              </ng-template>
            </div>
          </form>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'autorizacao'">
        <ng-container *ngIf="selectedRequest as selected; else noSelection">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">AutorizaÃ§Ã£o pela diretoria</p>
            <p class="muted">
              Registre parecer, encaminhe para contabilidade e defina condicionantes antes de liberar cotaÃ§Ãµes.
            </p>
          </div>
            <div class="tab-card__actions tab-card__actions--stacked">
              <button class="ghost" type="button" (click)="changeStep('solicitacao')">
                <fa-icon [icon]="faArrowLeft"></fa-icon>
                Revisar solicitaÃ§Ã£o
              </button>
              <button class="primary" type="button" (click)="navigateStep('next')">
                Ir para cotaÃ§Ã£o
                <fa-icon [icon]="faArrowRight"></fa-icon>
              </button>
            </div>
        </div>

        <div class="panel panel--wide">
          <header class="panel__header">
            <div>
              <p class="panel__eyebrow">SolicitaÃ§Ãµes para parecer</p>
              <p class="panel__title">Selecione a compra</p>
            </div>
            <span class="pill pill--ghost">{{ autorizacoesPendentes.length }} pendente(s)</span>
          </header>
          <div class="authorization-list" *ngIf="autorizacoesPendentes.length; else noPendingAuthorizations">
            <button
              class="authorization-list__item"
              *ngFor="let request of autorizacoesPendentes"
              type="button"
              [class.authorization-list__item--active]="request.id === selectedRequestId"
              (click)="selectRequest(request.id)"
            >
              <div>
                <p class="authorization-list__title">{{ request.title }}</p>
                <p class="authorization-list__meta">
                  {{ request.requester }} â€¢ {{ request.area || 'Sem Ã¡rea' }} â€¢ {{ request.expectedDate | date: 'dd/MM/yyyy' }}
                </p>
              </div>
              <div class="authorization-list__value">{{ request.value | currency: 'BRL' }}</div>
            </button>
          </div>
          <ng-template #noPendingAuthorizations>
            <p class="empty-state">Nenhuma solicitaÃ§Ã£o aguardando parecer no momento.</p>
          </ng-template>
        </div>

        <div class="grid-two-columns">
          <article class="panel">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Dados da solicitaÃ§Ã£o</p>
                <p class="panel__title">{{ selected.title }}</p>
              </div>
              <span class="pill">{{ selected.type }}</span>
            </header>

            <div class="info-grid">
              <div class="info-grid__item">
                <p class="info-grid__label">Valor estimado</p>
                <p class="info-grid__value">{{ selected.value | currency: 'BRL' }}</p>
              </div>
              <div class="info-grid__item">
                <p class="info-grid__label">Entrega prevista</p>
                <p class="info-grid__value">{{ selected.expectedDate | date: 'dd/MM/yyyy' }}</p>
              </div>
              <div class="info-grid__item">
                <p class="info-grid__label">Centro de custo</p>
                <p class="info-grid__value">{{ selected.budgetCenter || 'A definir com contabilidade' }}</p>
              </div>
            </div>

            <dl class="definition-list">
              <div class="definition-list__row definition-list__row--full">
                <dt>Justificativa</dt>
                <dd>{{ selected.justification }}</dd>
              </div>
              <div *ngIf="selected.quotationExemptionReason">
                <dt>Dispensa de cotaÃ§Ã£o</dt>
                <dd>{{ selected.quotationExemptionReason }}</dd>
              </div>
              <div>
                <dt>Ãrea / responsÃ¡vel</dt>
                <dd>{{ selected.area }} â€¢ {{ selected.requester }}</dd>
              </div>
              <div>
                <dt>Documentos e anexos</dt>
                <dd>Gerencie no relatÃ³rio para impressÃ£o.</dd>
              </div>
            </dl>

            <div class="callout" *ngIf="selected.approval?.notes">
              <p class="callout__title">ObservaÃ§Ã£o registrada pela diretoria</p>
              <p class="callout__text">{{ selected.approval?.notes }}</p>
            </div>
          </article>

          <form class="panel" (ngSubmit)="registerAuthorization()">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Parecer da diretoria</p>
                <p class="panel__title">Autorizar ou solicitar ajustes</p>
              </div>
              <span class="pill pill--ghost">Etapa 2/5</span>
            </header>

            <div class="form-grid">
              <label class="form-field">
                <span>Diretor responsÃ¡vel</span>
                <select class="select" name="director" [(ngModel)]="approvalForm.director">
                  <option value="" disabled [selected]="!approvalForm.director">Selecione um profissional</option>
                  <option *ngFor="let profissional of profissionais" [value]="profissional.nomeCompleto">
                    {{ profissional.nomeCompleto }}<span *ngIf="profissional.categoria"> â€¢ {{ profissional.categoria }}</span>
                  </option>
                </select>
              </label>
              <label class="form-field">
                <span>Data</span>
                <input class="input" type="date" name="date" [(ngModel)]="approvalForm.date" />
              </label>
              <div class="form-field form-field--full">
                <span>DecisÃ£o</span>
                <div class="decision-options" role="group" aria-label="DecisÃ£o da diretoria">
                  <label class="radio-card" [class.radio-card--active]="approvalForm.decision === 'aprovado'">
                    <input type="radio" name="decision" value="aprovado" [(ngModel)]="approvalForm.decision" />
                    <span class="radio-card__content">
                      <fa-icon [icon]="faCheckCircle"></fa-icon>
                      <span>
                        <strong>Aprovar</strong>
                        <small>Liberar imediatamente para cotaÃ§Ã£o.</small>
                      </span>
                    </span>
                  </label>
                  <label class="radio-card" [class.radio-card--active]="approvalForm.decision === 'ajustes'">
                    <input type="radio" name="decision" value="ajustes" [(ngModel)]="approvalForm.decision" />
                    <span class="radio-card__content">
                      <fa-icon [icon]="faFileSignature"></fa-icon>
                      <span>
                        <strong>Pedir ajustes</strong>
                        <small>Solicitar correÃ§Ã£o antes de avanÃ§ar.</small>
                      </span>
                    </span>
                  </label>
                  <label class="radio-card" [class.radio-card--active]="approvalForm.decision === 'rejeitado'">
                    <input type="radio" name="decision" value="rejeitado" [(ngModel)]="approvalForm.decision" />
                    <span class="radio-card__content">
                      <fa-icon [icon]="faStamp"></fa-icon>
                      <span>
                        <strong>Rejeitar</strong>
                        <small>Encerrar a solicitaÃ§Ã£o nesta etapa.</small>
                      </span>
                    </span>
                  </label>
                </div>
              </div>
              <label class="form-field form-field--full">
                <span>ObservaÃ§Ãµes</span>
                <textarea
                  class="textarea"
                  name="notes"
                  [(ngModel)]="approvalForm.notes"
                  rows="4"
                  placeholder="CondiÃ§Ãµes, limites de valor, reservas orÃ§amentÃ¡rias ou direcionamento de fornecedores"
                ></textarea>
              </label>
            </div>
            <div class="form-actions">
              <button class="primary" type="submit">Registrar parecer</button>
              <button class="ghost" type="button" (click)="navigateStep('next')">AvanÃ§ar</button>
            </div>
          </form>
        </div>

        <div class="panel panel--wide">
          <header class="panel__header">
            <div>
              <p class="panel__eyebrow">Linha do tempo</p>
              <p class="panel__title">EvidÃªncias e documentos impressos</p>
            </div>
            <span class="pill pill--ghost">FormulÃ¡rios de impressÃ£o por etapa</span>
          </header>

          <div class="timeline">
            <div class="timeline__item" *ngFor="let step of steps">
              <div class="timeline__bullet" [class.timeline__bullet--active]="step.id === activeStep"></div>
              <div>
                <p class="strong">{{ step.label }}</p>
                <p class="muted">{{ step.documentLabel }}</p>
              </div>
              <button class="ghost" type="button" (click)="printSection()">
                <fa-icon [icon]="faPrint"></fa-icon>
                Imprimir {{ step.label }}
              </button>
            </div>
          </div>
        </div>
        </ng-container>
      </ng-container>

      <ng-container *ngSwitchCase="'cotacoes'">
        <ng-container *ngIf="selectedRequest as selected; else noSelection">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">CotaÃ§Ã£o prÃ©via e vencedor</p>
            <p class="muted">Cadastre pelo menos 3 cotaÃ§Ãµes, compare condiÃ§Ãµes e selecione o fornecedor vencedor.</p>
          </div>
        <div class="tab-card__actions">
          <button class="primary" type="button" (click)="navigateStep('next')">
            Ir para reserva orÃ§amentÃ¡ria
            <fa-icon [icon]="faArrowRight"></fa-icon>
          </button>
        </div>
        </div>

        <div class="callout callout--info" *ngIf="!requiresQuotation(selected)">
          <p class="callout__title">Dispensa de cotaÃ§Ã£o autorizada</p>
          <p class="callout__text">
            O valor estimado ({{ selected.value | currency: 'BRL' }}) estÃ¡ abaixo do limite de
            {{ quotationThreshold | currency: 'BRL' }}. Registre o fornecedor com CNPJ ativo e siga direto para a
            reserva orÃ§amentÃ¡ria.
          </p>
          <div class="callout__actions">
            <button class="primary" type="button" (click)="dispenseQuotation()">
              <fa-icon [icon]="faCheckCircle"></fa-icon>
              Dispensar cotaÃ§Ã£o e avanÃ§ar
            </button>
            <button class="ghost" type="button" (click)="navigateStep('next')">Ir para reserva</button>
          </div>
        </div>

        <div class="grid-two-columns">
          <form class="panel" (ngSubmit)="addQuotation()">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Nova cotaÃ§Ã£o</p>
                <p class="panel__title">Registrar fornecedor</p>
              </div>
              <span class="pill pill--ghost">Etapa 3/5</span>
            </header>

            <app-popup-messages
              *ngIf="popupErrosCotacao.length"
              [mensagens]="popupErrosCotacao"
              (fechar)="popupErrosCotacao = []"
            ></app-popup-messages>

            <div class="form-grid">
              <label class="form-field">
                <span>Link do cartÃ£o CNPJ</span>
                <input
                  class="input"
                  name="cnpjCardUrl"
                  [ngModel]="newQuoteForm.cnpjCardUrl"
                  placeholder="URL do cartÃ£o CNPJ consultado"
                  (ngModelChange)="onCnpjCardUrlChange($event)"
                  (keydown)="onLinkCnpjKeydown($event)"
                />
                <small class="form-hint">Cole o link do cartÃ£o CNPJ ou preencha o CNPJ manualmente.</small>
              </label>
              <label class="form-field">
                <span>CNPJ do fornecedor*</span>
                <input
                  class="input"
                  name="cnpj"
                  [(ngModel)]="newQuoteForm.cnpj"
                  placeholder="00.000.000/0001-00"
                  inputmode="numeric"
                  (keydown)="onCnpjKeydown($event)"
                  (blur)="onCnpjBlur()"
                  required
                />
                <small class="form-hint" *ngIf="carregandoFornecedor">
                  <fa-icon [icon]="faSpinner" class="spinner"></fa-icon>
                  Buscando fornecedor...
                </small>
                <small class="form-error" *ngIf="avisoFornecedor">{{ avisoFornecedor }}</small>
              </label>
              <label class="form-field">
                <span>RazÃ£o social (cartÃ£o CNPJ)</span>
                <input
                  class="input"
                  name="companyName"
                  [(ngModel)]="newQuoteForm.companyName"
                  placeholder="Nome conforme Receita Federal"
                  (keydown)="onRazaoSocialKeydown($event)"
                  (blur)="onRazaoSocialBlur()"
                  (input)="onRazaoSocialInput()"
                />
              </label>
              <label class="form-field">
                <span>Nome fantasia / contato*</span>
                <input
                  class="input"
                  name="supplier"
                  [(ngModel)]="newQuoteForm.supplier"
                  placeholder="ResponsÃ¡vel comercial"
                  (input)="onNomeFantasiaInput()"
                  required
                />
              </label>
              <label class="form-field">
                <span>Valor ofertado*</span>
                <input
                  class="input"
                  type="text"
                  name="value"
                  [value]="valorCotacaoDisplay"
                  inputmode="decimal"
                  placeholder="R$ 0,00"
                  (input)="formatValorCotacaoInput($event.target.value)"
                  required
                />
              </label>
              <label class="form-field">
                <span>Prazo de entrega</span>
                <input class="input" type="date" name="delivery" [(ngModel)]="newQuoteForm.delivery" />
              </label>
              <label class="form-field">
                <span>válidade da proposta</span>
                <input class="input" type="date" name="validity" [(ngModel)]="newQuoteForm.validity" />
              </label>
              <label class="form-field">
                <span>OrÃ§amento fÃ­sico</span>
                <input
                  class="input"
                  type="file"
                  accept=".pdf,.jpg,.jpeg,.png"
                  (change)="onOrcamentoFisicoSelecionado($event)"
                />
              </label>
              <label class="form-field">
                <span>Conformidade</span>
                <select class="select" name="compliance" [(ngModel)]="newQuoteForm.compliance" disabled>
                  <option value="ok">DocumentaÃ§Ã£o OK</option>
                  <option value="pendente">DocumentaÃ§Ã£o pendente</option>
                </select>
              </label>
              <label class="form-field form-field--full">
                <span>ObservaÃ§Ãµes</span>
                <textarea class="textarea" name="notes" [(ngModel)]="newQuoteForm.notes" rows="3"></textarea>
              </label>
            </div>

            <div class="form-actions">
              <button class="primary" type="submit">Adicionar cotaÃ§Ã£o</button>
              <button class="ghost" type="button" (click)="navigateStep('next')">AvanÃ§ar</button>
            </div>
          </form>

          <div class="panel">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Comparativo</p>
                <p class="panel__title">Escolha o vencedor</p>
              </div>
              <span class="pill" [class.pill--accent]="quoteRequirementMet">
                {{ currentQuotes.length }} propostas
              </span>
            </header>

            <div class="quotes" *ngIf="currentQuotes.length; else noQuotes">
              <article
                class="quote-card"
                *ngFor="let quote of currentQuotes"
                [class.quote-card--winner]="isLowestQuote(quote)"
              >
                <div class="quote-card__header">
                  <div>
                    <p class="strong">{{ quote.supplier }}</p>
                    <p class="muted">Entrega: {{ quote.delivery | date: 'dd/MM/yyyy' }}</p>
                  </div>
                  <span class="pill" [class.pill--ghost]="quote.compliance === 'ok'">
                    {{ quote.compliance === 'ok' ? 'DocumentaÃ§Ã£o ok' : 'DocumentaÃ§Ã£o pendente' }}
                  </span>
                </div>
                <span class="pill pill--accent quote-card__winner" *ngIf="isLowestQuote(quote)">
                  Menor preÃ§o
                </span>
                <p class="quote-card__cnpj">
                  {{ quote.legalName }}
                  <br />
                  <span class="muted">
                    CNPJ {{ quote.cnpj }} â€¢ Consulta em {{ quote.cnpjCheckedAt | date: 'dd/MM/yyyy' }}
                  </span>
                </p>
                <div class="quote-card__status">
                  <span class="pill" [class.pill--accent]="quote.cnpjStatus === 'ATIVA'">
                    SituaÃ§Ã£o {{ quote.cnpjStatus | titlecase }}
                  </span>
                  <a
                    class="chip chip--link"
                    *ngIf="quote.cnpjCardUrl"
                    [href]="quote.cnpjCardUrl"
                    target="_blank"
                    rel="noreferrer"
                  >
                    CartÃ£o CNPJ na Receita Federal
                  </a>
                </div>
                <p class="quote-card__value">{{ quote.value | currency: 'BRL' }}</p>
                <p class="muted">válidade atÃ© {{ quote.validity | date: 'dd/MM/yyyy' }}</p>
                <p class="quote-card__notes">{{ quote.notes || 'Sem observaÃ§Ãµes adicionais' }}</p>
                <div class="quote-card__actions">
                  <button class="ghost" type="button" (click)="imprimirOrcamento(quote)">
                    <fa-icon [icon]="faPrint"></fa-icon>
                    Imprimir orÃ§amento
                  </button>
                  <button class="ghost" type="button" (click)="removerCotacao(quote)">
                    Excluir
                  </button>
                  <button class="primary" type="button" (click)="markWinner(quote)">
                    <fa-icon [icon]="faCheckCircle"></fa-icon>
                    Definir vencedor
                  </button>
                </div>
              </article>
            </div>
            <ng-template #noQuotes>
              <p class="empty-state">Inclua no mÃ­nimo 3 propostas para habilitar o vencedor.</p>
            </ng-template>
          </div>
        </div>
        </ng-container>
      </ng-container>

      <ng-container *ngSwitchCase="'reserva'">
        <ng-container *ngIf="selectedRequest as selected; else noSelection">    
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">Reserva orÃ§amentÃ¡ria</p>
            <p class="muted">Busque recursos na contabilidade, registre a reserva e siga para a contrataÃ§Ã£o.</p>
          </div>
        <div class="tab-card__actions">
          <button class="primary" type="button" (click)="navigateStep('next')"> 
            Ir para conclusÃ£o
            <fa-icon [icon]="faArrowRight"></fa-icon>
          </button>
        </div>
        </div>

        <div class="callout callout--info" *ngIf="reservaConfirmada">
          <p class="callout__title">Reserva registrada com sucesso</p>
          <p class="callout__text">
            O valor foi reservado e vinculado ao centro de custo selecionado.
          </p>
        </div>

        <div class="panel panel--wide">
          <header class="panel__header">
            <div>
              <p class="panel__eyebrow">Reserva orÃ§amentÃ¡ria</p>
              <p class="panel__title">Contas bancÃ¡rias e reserva contÃ¡bil</p>
            </div>
            <span class="pill pill--ghost">Etapa 4/5</span>
          </header>

          <div class="grid-two-columns">
            <div>
              <div class="panel__section-header">
                <p class="panel__section-title">Contas bancÃ¡rias</p>
                <p class="muted">Saldo positivo para reserva</p>
              </div>

              <div class="budget-grid" *ngIf="contasBancariasComSaldo.length; else noAccounts">
                <button
                  type="button"
                  class="budget-card"
                  *ngFor="let conta of contasBancariasComSaldo"
                  [class.budget-card--selected]="isContaReservada(conta)"
                  (click)="reservarSaldoBanco(conta)"
                >
                <div class="budget-card__header">
                  <div>
                    <p class="strong">{{ conta.banco }}</p>
                    <p class="muted">AgÃªncia {{ conta.agencia || '---' }} â€¢ {{ conta.numero }}</p>
                  </div>
                  <span class="pill pill--ghost">{{ conta.tipo }}</span>
                </div>
                <span class="pill pill--accent budget-card__status" *ngIf="isContaReservada(conta)">
                  <fa-icon [icon]="faCircleCheck"></fa-icon>
                  Reservado
                </span>
                <p class="budget-card__value">{{ conta.saldo | currency: 'BRL' }}</p>
                  <label class="budget-card__input">
                    <span>Valor da reserva</span>
                    <input
                      class="input"
                      type="text"
                      inputmode="decimal"
                      [value]="reservaValoresDisplay[conta.id]"
                      name="reservaValor-{{ conta.id }}"
                      (input)="atualizarValorReservaConta(conta, $event.target.value)"
                      (click)="$event.stopPropagation()"
                    />
                  </label>
                  <p class="muted" *ngIf="!isContaReservada(conta)">
                    Clique para reservar o valor definido
                  </p>
                  <p class="muted" *ngIf="isContaReservada(conta)">
                    Reserva aplicada. Clique para estornar.
                  </p>
                </button>
              </div>
              <ng-template #noAccounts>
                <p class="empty-state">Nenhuma conta com saldo positivo disponÃ­vel.</p>
              </ng-template>
            </div>

            <form (ngSubmit)="registerReservation()">
              <div class="panel__section-header">
                <p class="panel__section-title">Centro de custo</p>
              </div>

              <div class="form-grid">
                <label class="form-field">
                  <span>Centro de custo</span>
                  <select class="select" name="center" [(ngModel)]="reservationForm.center">
                    <option *ngFor="let envelope of budgetEnvelopes" [value]="envelope.center">
                      {{ envelope.center }} Â· {{ envelope.title }}
                    </option>
                  </select>
                </label>
                <label class="form-field">
                  <span>Valor a reservar</span>
                  <input
                    class="input"
                    type="text"
                    name="value"
                    [value]="valorReservaDisplay"
                    inputmode="decimal"
                    placeholder="0,00"
                    (input)="formatValorReservaTotalInput($event.target.value)"
                  />
                </label>
                <label class="form-field form-field--full">
                  <span>ObservaÃ§Ãµes</span>
                  <textarea class="textarea" name="observation" [(ngModel)]="reservationForm.observation" rows="3"></textarea>
                </label>
              </div>

              <div class="form-actions">
                <button class="primary" type="submit">Registrar reserva</button>
                <button class="ghost" type="button" (click)="navigateStep('next')">AvanÃ§ar</button>
              </div>
            </form>
          </div>
        </div>

        <div class="panel panel--wide">
          <header class="panel__header">
            <div>
              <p class="panel__eyebrow">Reservas registradas</p>
              <p class="panel__title">Rastreabilidade contÃ¡bil</p>
            </div>
            <span class="pill pill--ghost">Reserva orÃ§amentÃ¡ria impressa</span>
          </header>
          <div class="reservations" *ngIf="reservations.length; else noReservations">
            <article class="reservation" *ngFor="let reservation of reservations">
              <div>
                <p class="strong">{{ reservation.center }}</p>
                <p class="muted">{{ reservation.observation }}</p>
              </div>
              <div class="reservation__meta">
                <span class="pill" [class.pill--accent]="reservation.status === 'reservado'">{{ reservation.status }}</span>
                <span>{{ reservation.value | currency: 'BRL' }}</span>
                <span class="muted">{{ reservation.createdAt | date: 'dd/MM/yyyy' }}</span>
              </div>
            </article>
          </div>
          <ng-template #noReservations>
            <p class="empty-state">Nenhuma reserva realizada ainda.</p>
          </ng-template>
        </div>
        </ng-container>
      </ng-container>

      <ng-container *ngSwitchCase="'conclusao'">
        <ng-container *ngIf="selectedRequest as selected; else noSelection">    
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">ConclusÃ£o e integraÃ§Ã£o</p>        
            <p class="muted">Finalize a compra, envie para patrimÃ´nio ou almoxarifado e gere o termo de conclusÃ£o.</p>
          </div>
        <div class="tab-card__actions">
          <button class="primary" type="button" (click)="navigateStep('prev')"> 
            Voltar para reserva
            <fa-icon [icon]="faArrowLeft"></fa-icon>
          </button>
        </div>
        </div>

        <div class="callout callout--info" *ngIf="reservaConfirmada">
          <p class="callout__title">Reserva registrada com sucesso</p>
          <p class="callout__text">
            O valor foi reservado e vinculado ao centro de custo selecionado.
          </p>
        </div>

        <div class="grid-two-columns">
          <article class="panel">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Dados finais</p>
                <p class="panel__title">{{ selected.title }}</p>
              </div>
              <span class="pill">{{ selected.type }}</span>
            </header>

            <dl class="definition-list">
              <div>
                <dt>Quantidade</dt>
                <dd>{{ selected.quantity }}</dd>
              </div>
              <div>
                <dt>Valor total</dt>
                <dd>{{ selected.value | currency: 'BRL' }}</dd>
              </div>
              <div>
                <dt>Ãrea solicitante</dt>
                <dd>{{ selected.area || 'NÃ£o informado' }}</dd>
              </div>
              <div>
                <dt>ResponsÃ¡vel</dt>
                <dd>{{ selected.requester }}</dd>
              </div>
              <div>
                <dt>PrevisÃ£o / necessidade</dt>
                <dd>{{ selected.expectedDate | date: 'dd/MM/yyyy' }}</dd>
              </div>
              <div>
                <dt>Prioridade</dt>
                <dd>{{ selected.priority | titlecase }}</dd>
              </div>
              <div>
                <dt>Fornecedor vencedor</dt>
                <dd>{{ selected.winnerSupplier || 'Selecionar na etapa de cotaÃ§Ã£o' }}</dd>
              </div>
              <div>
                <dt>Reserva orÃ§amentÃ¡ria</dt>
                <dd>{{ selected.reservationNumber || 'Registrar nÃºmero da reserva' }}</dd>
              </div>
              <div>
                <dt>Termo / documento</dt>
                <dd>{{ selected.documentNumber || 'Gerado automaticamente na conclusÃ£o' }}</dd>
              </div>
              <div>
                <dt>Centro de custo reservado</dt>
                <dd>{{ selected.budgetCenter || 'Reservar centro de custo' }}</dd>
              </div>
              <div>
                <dt>AutorizaÃ§Ã£o de pagamento</dt>
                <dd>
                  <span *ngIf="selected.paymentAuthorization?.number; else noPaymentAuth">
                    NÂº {{ selected.paymentAuthorization?.number }}
                    <span *ngIf="selected.paymentAuthorization?.authorizedBy"> â€¢ {{ selected.paymentAuthorization?.authorizedBy }}</span>
                    <span *ngIf="selected.paymentAuthorization?.date">
                      â€¢ {{ selected.paymentAuthorization?.date | date: 'dd/MM/yyyy' }}
                    </span>
                  </span>
                  <ng-template #noPaymentAuth>
                    Registrar autorizaÃ§Ã£o de pagamento na conclusÃ£o.
                  </ng-template>
                </dd>
              </div>
              <div>
                <dt>IntegraÃ§Ãµes obrigatÃ³rias</dt>
                <dd>
                  <span class="pill pill--ghost" *ngIf="integrationChecklist[selected.id]?.patrimony">PatrimÃ´nio</span>
                  <span class="pill pill--ghost" *ngIf="integrationChecklist[selected.id]?.warehouse">Almoxarifado</span>
                  <span class="pill pill--ghost" *ngIf="integrationChecklist[selected.id]?.contracts">Contratos</span>
                  <span class="muted" *ngIf="!integrationChecklist[selected.id]">Defina os destinos abaixo</span>
                </dd>
              </div>
              <div>
                <dt>Destino principal</dt>
                <dd>
                  <span *ngIf="selected.type === 'produto'">Almoxarifado</span>
                  <span *ngIf="selected.type === 'bem'">PatrimÃ´nio</span>
                  <span *ngIf="selected.type !== 'produto' && selected.type !== 'bem'">NÃ£o aplicÃ¡vel</span>
                </dd>
              </div>
              <div class="definition-list__row definition-list__row--full">
                <dt>Justificativa</dt>
                <dd>{{ selected.justification }}</dd>
              </div>
            </dl>
          </article>

          <form class="panel" (ngSubmit)="finalizePurchase()">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">IntegraÃ§Ã£o</p>
                <p class="panel__title">PatrimÃ´nio e almoxarifado</p>
              </div>
              <span class="pill">Etapa 5/5</span>
            </header>

            <div class="form-grid">
              <label class="form-field">
                <span>NÂº do termo / documento</span>
                <input
                  class="input"
                  name="documentNumber"
                  [(ngModel)]="conclusionForm.documentNumber"
                  placeholder="0001/2025"
                  readonly
                />
              </label>
              <label class="form-field">
                <span>AutorizaÃ§Ã£o de pagamento</span>
                <input
                  class="input"
                  name="paymentNumber"
                  [(ngModel)]="paymentAuthorizationForm.number"
                  placeholder="0001/2025"
                  readonly
                />
              </label>
              <label class="form-field">
                <span>ResponsÃ¡vel pela autorizaÃ§Ã£o</span>
                <select class="select" name="authorizedBy" [(ngModel)]="paymentAuthorizationForm.authorizedBy">
                  <option value="" disabled [selected]="!paymentAuthorizationForm.authorizedBy">Selecione um profissional</option>
                  <option *ngFor="let profissional of profissionais" [value]="profissional.nomeCompleto">
                    {{ profissional.nomeCompleto }}<span *ngIf="profissional.categoria"> â€¢ {{ profissional.categoria }}</span>
                  </option>
                </select>
              </label>
              <label class="form-field">
                <span>Data da autorizaÃ§Ã£o</span>
                <input class="input" type="date" name="paymentDate" [(ngModel)]="paymentAuthorizationForm.date" />
              </label>
              <label class="form-field form-field--full">
                <span>ObservaÃ§Ãµes finais</span>
                <textarea class="textarea" name="observation" [(ngModel)]="conclusionForm.observation" rows="3"></textarea>
              </label>
              <label class="form-field form-field--full">
                <span>ObservaÃ§Ãµes da autorizaÃ§Ã£o de pagamento</span>
                <textarea class="textarea" name="paymentNotes" [(ngModel)]="paymentAuthorizationForm.notes" rows="3"></textarea>
              </label>
              <label class="checkbox">
                <input type="checkbox" name="sendToPatrimony" [(ngModel)]="conclusionForm.sendToPatrimony" />
                <span>Enviar para cadastro de patrimÃ´nio (compras de bens)</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" name="sendToWarehouse" [(ngModel)]="conclusionForm.sendToWarehouse" />
                <span>Enviar para cadastro de almoxarifado (materiais)</span>
              </label>
            </div>

            <div class="form-actions">
              <button class="primary" type="button" (click)="gerarAutorizacaoPagamento()">
                <fa-icon [icon]="faFileSignature"></fa-icon>
                Gerar autorizaÃ§Ã£o de pagamento
              </button>
              <button class="primary" type="submit">
                <fa-icon [icon]="faCircleCheck"></fa-icon>
                Concluir compra
              </button>
              <button class="ghost" type="button" (click)="printSection()">Imprimir termo</button>
            </div>
          </form>
        </div>

        <div class="panel panel--wide">
          <header class="panel__header">
            <div>
              <p class="panel__eyebrow">Checklist final</p>
              <p class="panel__title">Fluxo integrado</p>
            </div>
          </header>
          <div class="integration-grid">
            <article class="integration-card">
              <fa-icon [icon]="faBuildingColumns"></fa-icon>
              <div>
                <p class="strong">Contabilidade</p>
                <p class="muted">Reserva orÃ§amentÃ¡ria vinculada ao centro de custo e autorizaÃ§Ã£o de pagamento.</p>
              </div>
            </article>
            <article class="integration-card">
              <fa-icon [icon]="faWarehouse"></fa-icon>
              <div>
                <p class="strong">Almoxarifado</p>
                <p class="muted">Materiais geram saldo inicial no cadastro de estoque.</p>
              </div>
            </article>
            <article class="integration-card">
              <fa-icon [icon]="faGavel"></fa-icon>
              <div>
                <p class="strong">Contratos</p>
                <p class="muted">ServiÃ§os e contratos acompanham vigÃªncia, SLA e reajustes.</p>
              </div>
            </article>
            <article class="integration-card">
              <fa-icon [icon]="faStamp"></fa-icon>
              <div>
                <p class="strong">PatrimÃ´nio</p>
                <p class="muted">Bens permanentes sÃ£o registrados com tombamento e responsÃ¡vel.</p>
              </div>
            </article>
          </div>
        </div>
        </ng-container>
      </ng-container>
    </div>
  </div>
  <ng-template #noSelection>
    <div class="empty-state">
      <p>Selecione uma solicitaÃ§Ã£o existente para visualizar as etapas seguintes.</p>
      <p class="small">Ainda nÃ£o hÃ¡ solicitaÃ§Ãµes? Cadastre uma nova na aba â€œSolicitaÃ§Ã£o de comprasâ€.</p>
    </div>
  </ng-template>
</section>
</app-tela-padrao>




