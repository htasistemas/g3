<app-tela-padrao>
<header class="page-title" slot="titulo">
    <div class="page-title__stack">
      <p class="page-title__eyebrow">Financeiro · Autorização de Compras</p>
      <div class="page-title__headline">
        <div>
          <p class="page-title__label">Fluxo enxuto para autorizar compras</p>
          <p class="muted">
            Acompanhe cada etapa com clareza, registre pareceres e siga direto para reserva orçamentária e conclusão.
          </p>
        </div>
        <button type="button" class="ghost" (click)="printSection()">
          <fa-icon [icon]="faPrint"></fa-icon>
          Imprimir visão geral
        </button>
      </div>
    </div>
  </header>

  <section class="cadastro">
  <div class="tab-shell">
    <p class="tab-shell__title">Etapas principais</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let step of steps; index as idx"
        class="step-tabs__item"
        [class.active]="activeStep === step.id"
        [class.completed]="idx < activeStepIndex"
      >
        <button class="step-tabs__button" type="button" (click)="changeStep(step.id)">
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ step.label }}</span>
        </button>
      </li>
    </ol>
  </div>

  <div class="workspace" *ngIf="selectedRequest as selected">
    <div class="context-bar">
      <label class="context-bar__field">
        <span class="context-bar__label">Processo</span>
        <select
          class="select select--dense"
          name="selectedRequest"
          [ngModel]="selectedRequestId"
          (ngModelChange)="selectRequest($event)"
        >
          <option *ngFor="let request of requests" [value]="request.id">
            {{ request.id }} · {{ request.title }}
          </option>
        </select>
      </label>
      <div class="context-bar__summary">
        <div class="context-bar__item">
          <p class="context-bar__hint">Etapa atual</p>
          <p class="context-bar__value">{{ getStepLabel(selected.status) }}</p>
        </div>
        <div class="context-bar__item">
          <p class="context-bar__hint">Valor estimado</p>
          <p class="context-bar__value">{{ selected.value | currency: 'BRL' }}</p>
        </div>
        <div class="context-bar__item">
          <p class="context-bar__hint">Responsável</p>
          <p class="context-bar__value">{{ selected.requester }} — {{ selected.area }}</p>
        </div>
      </div>
    </div>

    <div class="tab-card" [ngSwitch]="activeStep">
      <ng-container *ngSwitchCase="'solicitacao'">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">Solicitação de compras</p>
            <p class="muted">Cadastre a demanda e gere o relatório de autorização para a diretoria.</p>
          </div>
          <div class="tab-card__actions">
            <button class="ghost" type="button" (click)="printSection()">
              <fa-icon [icon]="faPrint"></fa-icon>
              Imprimir formulário
            </button>
            <button class="primary" type="button" (click)="navigateStep('next')">
              Próxima etapa
              <fa-icon [icon]="faArrowRight"></fa-icon>
            </button>
          </div>
        </div>

        <div class="grid-two-columns">
          <form class="panel" (ngSubmit)="createRequest()">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Nova solicitação</p>
                <p class="panel__title">Detalhes da demanda</p>
              </div>
              <span class="pill">Etapa 1/5</span>
            </header>

            <div class="form-grid">
              <label class="form-field">
                <span>Título da compra</span>
                <input class="input" name="title" [(ngModel)]="newRequestForm.title" placeholder="Ex.: Kits pedagógicos" required />
              </label>
              <label class="form-field">
                <span>Tipo</span>
                <select class="select" name="type" [(ngModel)]="newRequestForm.type">
                  <option value="produto">Compras de produtos</option>
                  <option value="bem">Compra de bens</option>
                  <option value="servico">Autorização de serviços</option>
                  <option value="contrato">Contratos</option>
                </select>
              </label>
              <label class="form-field">
                <span>Área solicitante</span>
                <input class="input" name="area" [(ngModel)]="newRequestForm.area" placeholder="Setor / projeto" />
              </label>
              <label class="form-field">
                <span>Responsável</span>
                <input class="input" name="requester" [(ngModel)]="newRequestForm.requester" placeholder="Nome do solicitante" required />
              </label>
              <label class="form-field">
                <span>Previsão / necessidade</span>
                <input class="input" type="date" name="expectedDate" [(ngModel)]="newRequestForm.expectedDate" />
              </label>
              <label class="form-field">
                <span>Valor estimado</span>
                <input class="input" type="number" name="value" [(ngModel)]="newRequestForm.value" min="0" step="0.01" />
              </label>
              <label class="form-field form-field--full">
                <span>Justificativa e escopo</span>
                <textarea
                  class="textarea"
                  name="justification"
                  [(ngModel)]="newRequestForm.justification"
                  rows="4"
                  placeholder="Objetivo, quantidades, critérios mínimos e impacto social"
                  required
                ></textarea>
              </label>
              <label class="form-field">
                <span>Centro de custo / conta contábil</span>
                <select class="select" name="budgetCenter" [(ngModel)]="newRequestForm.budgetCenter">
                  <option *ngFor="let envelope of budgetEnvelopes" [value]="envelope.center">
                    {{ envelope.center }} · {{ envelope.title }}
                  </option>
                </select>
              </label>
            </div>

            <div class="form-actions">
              <button class="primary" type="submit">Salvar solicitação</button>
              <button class="ghost" type="button" (click)="navigateStep('next')">Pular para autorização</button>
            </div>
          </form>

          <div class="panel">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Relatório para autorização</p>
                <p class="panel__title">Resumo das solicitações</p>
              </div>
              <button class="ghost" type="button" (click)="printSection()">
                <fa-icon [icon]="faFileSignature"></fa-icon>
                Gerar PDF
              </button>
            </header>

            <div class="report">
              <div class="report__row report__row--head">
                <span>Processo</span>
                <span>Tipo</span>
                <span>Valor</span>
                <span>Etapa</span>
              </div>
              <div class="report__row" *ngFor="let request of requests">
                <span class="strong">{{ request.title }}</span>
                <span class="pill pill--ghost">{{ request.type }}</span>
                <span>{{ request.value | currency: 'BRL' }}</span>
                <span>{{ getStepLabel(request.status) }}</span>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'autorizacao'">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">Autorização pela diretoria</p>
            <p class="muted">
              Registre parecer, encaminhe para contabilidade e defina condicionantes antes de liberar cotações.
            </p>
          </div>
          <div class="tab-card__actions tab-card__actions--stacked">
            <button class="ghost" type="button" (click)="changeStep('solicitacao')">
              <fa-icon [icon]="faArrowLeft"></fa-icon>
              Revisar solicitação
            </button>
            <button class="ghost" type="button" (click)="printSection()">
              <fa-icon [icon]="faPrint"></fa-icon>
              Imprimir relatório
            </button>
            <button class="primary" type="button" (click)="navigateStep('next')">
              Ir para cotação
              <fa-icon [icon]="faArrowRight"></fa-icon>
            </button>
          </div>
        </div>

        <div class="authorization-overview">
          <div class="authorization-overview__intro">
            <div>
              <p class="authorization-overview__eyebrow">Processo {{ selected.id }}</p>
              <p class="authorization-overview__title">{{ selected.title }}</p>
              <p class="muted">Responsável: {{ selected.requester }} • {{ selected.area }}</p>
            </div>
            <div class="authorization-overview__tags">
              <span class="pill pill--ghost">{{ getStepLabel(selected.status) }}</span>
              <span class="pill">{{ selected.type }}</span>
              <span class="pill pill--accent">Entrega {{ selected.expectedDate | date: 'dd/MM/yyyy' }}</span>
            </div>
          </div>

          <div class="authorization-overview__stats">
            <div class="overview-stat">
              <p class="overview-stat__label">Valor estimado</p>
              <p class="overview-stat__value">{{ selected.value | currency: 'BRL' }}</p>
            </div>
            <div class="overview-stat">
              <p class="overview-stat__label">Centro de custo</p>
              <p class="overview-stat__value">{{ selected.budgetCenter || 'Definir na contabilidade' }}</p>
            </div>
            <div class="overview-stat">
              <p class="overview-stat__label">Último parecer</p>
              <p class="overview-stat__value">
                {{ selected.approval?.decision ? (selected.approval?.decision | titlecase) : 'Pendente' }}
              </p>
            </div>
          </div>

          <div class="authorization-overview__actions">
            <div class="helper-list">
              <p class="helper-list__title">O que fazer agora</p>
              <ul>
                <li>Conferir a justificativa e o orçamento informado.</li>
                <li>Registrar o parecer com condicionantes claros.</li>
                <li>Avançar só quando a diretoria sinalizar com “Aprovar”.</li>
              </ul>
            </div>
            <div class="authorization-overview__cta">
              <button class="chip" type="button" (click)="printSection()">
                <fa-icon [icon]="faFileSignature"></fa-icon>
                Baixar relatório em PDF
              </button>
              <button class="primary" type="button" (click)="navigateStep('next')">
                Liberar cotações
                <fa-icon [icon]="faArrowRight"></fa-icon>
              </button>
            </div>
          </div>
        </div>

        <div class="grid-two-columns">
          <article class="panel">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Dados da solicitação</p>
                <p class="panel__title">{{ selected.title }}</p>
              </div>
              <span class="pill">{{ selected.type }}</span>
            </header>

            <div class="info-grid">
              <div class="info-grid__item">
                <p class="info-grid__label">Valor estimado</p>
                <p class="info-grid__value">{{ selected.value | currency: 'BRL' }}</p>
              </div>
              <div class="info-grid__item">
                <p class="info-grid__label">Entrega prevista</p>
                <p class="info-grid__value">{{ selected.expectedDate | date: 'dd/MM/yyyy' }}</p>
              </div>
              <div class="info-grid__item">
                <p class="info-grid__label">Centro de custo</p>
                <p class="info-grid__value">{{ selected.budgetCenter || 'A definir com contabilidade' }}</p>
              </div>
            </div>

            <dl class="definition-list">
              <div class="definition-list__row definition-list__row--full">
                <dt>Justificativa</dt>
                <dd>{{ selected.justification }}</dd>
              </div>
              <div *ngIf="selected.quotationExemptionReason">
                <dt>Dispensa de cotação</dt>
                <dd>{{ selected.quotationExemptionReason }}</dd>
              </div>
              <div>
                <dt>Área / responsável</dt>
                <dd>{{ selected.area }} • {{ selected.requester }}</dd>
              </div>
              <div>
                <dt>Documentos e anexos</dt>
                <dd>Gerencie no relatório para impressão.</dd>
              </div>
            </dl>

            <div class="callout" *ngIf="selected.approval?.notes">
              <p class="callout__title">Observação registrada pela diretoria</p>
              <p class="callout__text">{{ selected.approval?.notes }}</p>
            </div>
          </article>

          <form class="panel" (ngSubmit)="registerAuthorization()">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Parecer da diretoria</p>
                <p class="panel__title">Autorizar ou solicitar ajustes</p>
              </div>
              <span class="pill pill--ghost">Etapa 2/5</span>
            </header>

            <div class="form-grid">
              <label class="form-field">
                <span>Diretor responsável</span>
                <input class="input" name="director" [(ngModel)]="approvalForm.director" placeholder="Nome" />
              </label>
              <label class="form-field">
                <span>Data</span>
                <input class="input" type="date" name="date" [(ngModel)]="approvalForm.date" />
              </label>
              <div class="form-field form-field--full">
                <span>Decisão</span>
                <div class="decision-options" role="group" aria-label="Decisão da diretoria">
                  <label class="radio-card" [class.radio-card--active]="approvalForm.decision === 'aprovado'">
                    <input type="radio" name="decision" value="aprovado" [(ngModel)]="approvalForm.decision" />
                    <span class="radio-card__content">
                      <fa-icon [icon]="faCheckCircle"></fa-icon>
                      <span>
                        <strong>Aprovar</strong>
                        <small>Liberar imediatamente para cotação.</small>
                      </span>
                    </span>
                  </label>
                  <label class="radio-card" [class.radio-card--active]="approvalForm.decision === 'ajustes'">
                    <input type="radio" name="decision" value="ajustes" [(ngModel)]="approvalForm.decision" />
                    <span class="radio-card__content">
                      <fa-icon [icon]="faFileSignature"></fa-icon>
                      <span>
                        <strong>Pedir ajustes</strong>
                        <small>Solicitar correção antes de avançar.</small>
                      </span>
                    </span>
                  </label>
                  <label class="radio-card" [class.radio-card--active]="approvalForm.decision === 'rejeitado'">
                    <input type="radio" name="decision" value="rejeitado" [(ngModel)]="approvalForm.decision" />
                    <span class="radio-card__content">
                      <fa-icon [icon]="faStamp"></fa-icon>
                      <span>
                        <strong>Rejeitar</strong>
                        <small>Encerrar a solicitação nesta etapa.</small>
                      </span>
                    </span>
                  </label>
                </div>
              </div>
              <label class="form-field form-field--full">
                <span>Observações</span>
                <textarea
                  class="textarea"
                  name="notes"
                  [(ngModel)]="approvalForm.notes"
                  rows="4"
                  placeholder="Condições, limites de valor, reservas orçamentárias ou direcionamento de fornecedores"
                ></textarea>
              </label>
            </div>
            <div class="form-actions">
              <button class="primary" type="submit">Registrar parecer</button>
              <button class="ghost" type="button" (click)="navigateStep('next')">Avançar</button>
            </div>
          </form>
        </div>

        <div class="panel panel--wide">
          <header class="panel__header">
            <div>
              <p class="panel__eyebrow">Linha do tempo</p>
              <p class="panel__title">Evidências e documentos impressos</p>
            </div>
            <span class="pill pill--ghost">Formulários de impressão por etapa</span>
          </header>

          <div class="timeline">
            <div class="timeline__item" *ngFor="let step of steps">
              <div class="timeline__bullet" [class.timeline__bullet--active]="step.id === activeStep"></div>
              <div>
                <p class="strong">{{ step.label }}</p>
                <p class="muted">{{ step.documentLabel }}</p>
              </div>
              <button class="ghost" type="button" (click)="printSection()">
                <fa-icon [icon]="faPrint"></fa-icon>
                Imprimir {{ step.label }}
              </button>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'cotacoes'">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">Cotação prévia e vencedor</p>
            <p class="muted">Cadastre pelo menos 3 cotações, compare condições e selecione o fornecedor vencedor.</p>
          </div>
          <div class="tab-card__actions">
            <button class="ghost" type="button" (click)="printSection()">
              <fa-icon [icon]="faPrint"></fa-icon>
              Imprimir mapa comparativo
            </button>
            <button class="primary" type="button" (click)="navigateStep('next')">
              Ir para reserva orçamentária
              <fa-icon [icon]="faArrowRight"></fa-icon>
            </button>
          </div>
        </div>

        <div class="panel panel--wide">
          <header class="panel__header">
            <div>
              <p class="panel__eyebrow">Regras de cotação</p>
              <p class="panel__title">3 propostas + comprovação de requisitos</p>
            </div>
            <span class="pill" [class.pill--accent]="quoteRequirementMet">{{ currentQuotes.length }}/3 cotações</span>
            <span class="pill pill--warning" *ngIf="!requiresQuotation(selected)">
              Dispensa até {{ quotationThreshold | currency: 'BRL' }}
            </span>
          </header>
          <div class="quote-guidelines">
            <div>
              <p class="strong">Tipos contemplados</p>
              <p class="muted">Produtos, bens permanentes, serviços e contratos.</p>
            </div>
            <div>
              <p class="strong">Critérios</p>
              <p class="muted">Preço, prazo, condições comerciais, comprovação fiscal e regularidade.</p>
            </div>
            <div>
              <p class="strong">Integrações</p>
              <p class="muted">Direcionar vencedor para reserva orçamentária, patrimônio ou almoxarifado conforme o tipo.</p>
            </div>
            <div>
              <p class="strong">Limite de dispensa</p>
              <p class="muted">
                Compras abaixo de {{ quotationThreshold | currency: 'BRL' }} podem seguir direto para reserva orçamentária, com
                registro de motivo e cartão CNPJ do fornecedor ativo.
              </p>
            </div>
          </div>
        </div>

        <div class="callout callout--info" *ngIf="!requiresQuotation(selected)">
          <p class="callout__title">Dispensa de cotação autorizada</p>
          <p class="callout__text">
            O valor estimado ({{ selected.value | currency: 'BRL' }}) está abaixo do limite de
            {{ quotationThreshold | currency: 'BRL' }}. Registre o fornecedor com CNPJ ativo e siga direto para a
            reserva orçamentária.
          </p>
          <div class="callout__actions">
            <button class="primary" type="button" (click)="dispenseQuotation()">
              <fa-icon [icon]="faCheckCircle"></fa-icon>
              Dispensar cotação e avançar
            </button>
            <button class="ghost" type="button" (click)="navigateStep('next')">Ir para reserva</button>
          </div>
        </div>

        <div class="grid-two-columns">
          <form class="panel" (ngSubmit)="addQuotation()">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Nova cotação</p>
                <p class="panel__title">Registrar fornecedor</p>
              </div>
              <span class="pill pill--ghost">Etapa 3/5</span>
            </header>

            <div class="form-grid">
              <label class="form-field">
                <span>CNPJ do fornecedor</span>
                <input
                  class="input"
                  name="cnpj"
                  [(ngModel)]="newQuoteForm.cnpj"
                  placeholder="00.000.000/0001-00"
                  inputmode="numeric"
                  (blur)="prefillSupplierFromCnpj()"
                  required
                />
                <small class="form-hint">Consulta validada na Receita Federal para aceitar apenas cartões ativos.</small>
                <p class="form-error" *ngIf="cnpjValidationError">{{ cnpjValidationError }}</p>
              </label>
              <label class="form-field">
                <span>Razão social (cartão CNPJ)</span>
                <input
                  class="input"
                  name="companyName"
                  [(ngModel)]="newQuoteForm.companyName"
                  placeholder="Nome conforme Receita Federal"
                />
              </label>
              <label class="form-field">
                <span>Nome fantasia / contato</span>
                <input
                  class="input"
                  name="supplier"
                  [(ngModel)]="newQuoteForm.supplier"
                  placeholder="Responsável comercial"
                  required
                />
              </label>
              <label class="form-field">
                <span>Link do cartão CNPJ</span>
                <input
                  class="input"
                  name="cnpjCardUrl"
                  [(ngModel)]="newQuoteForm.cnpjCardUrl"
                  placeholder="URL do cartão CNPJ consultado"
                />
              </label>
              <label class="form-field">
                <span>Valor ofertado</span>
                <input class="input" type="number" name="value" [(ngModel)]="newQuoteForm.value" min="0" step="0.01" required />
              </label>
              <label class="form-field">
                <span>Prazo de entrega</span>
                <input class="input" type="date" name="delivery" [(ngModel)]="newQuoteForm.delivery" />
              </label>
              <label class="form-field">
                <span>Validade da proposta</span>
                <input class="input" type="date" name="validity" [(ngModel)]="newQuoteForm.validity" />
              </label>
              <label class="form-field">
                <span>Conformidade</span>
                <select class="select" name="compliance" [(ngModel)]="newQuoteForm.compliance">
                  <option value="ok">Documentação OK</option>
                  <option value="pendente">Documentação pendente</option>
                </select>
              </label>
              <label class="form-field form-field--full">
                <span>Observações</span>
                <textarea class="textarea" name="notes" [(ngModel)]="newQuoteForm.notes" rows="3"></textarea>
              </label>
            </div>

            <div class="form-actions">
              <button class="primary" type="submit">Adicionar cotação</button>
              <button class="ghost" type="button" (click)="navigateStep('next')">Avançar</button>
            </div>
          </form>

          <div class="panel">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Comparativo</p>
                <p class="panel__title">Escolha o vencedor</p>
              </div>
              <span class="pill" [class.pill--accent]="quoteRequirementMet">
                {{ currentQuotes.length }} propostas
              </span>
            </header>

            <div class="quotes" *ngIf="currentQuotes.length; else noQuotes">
              <article class="quote-card" *ngFor="let quote of currentQuotes">
                <div class="quote-card__header">
                  <div>
                    <p class="strong">{{ quote.supplier }}</p>
                    <p class="muted">Entrega: {{ quote.delivery | date: 'dd/MM/yyyy' }}</p>
                  </div>
                  <span class="pill" [class.pill--ghost]="quote.compliance === 'ok'">
                    {{ quote.compliance === 'ok' ? 'Documentação ok' : 'Documentação pendente' }}
                  </span>
                </div>
                <p class="quote-card__cnpj">
                  {{ quote.legalName }}
                  <br />
                  <span class="muted">
                    CNPJ {{ quote.cnpj }} • Consulta em {{ quote.cnpjCheckedAt | date: 'dd/MM/yyyy' }}
                  </span>
                </p>
                <div class="quote-card__status">
                  <span class="pill" [class.pill--accent]="quote.cnpjStatus === 'ATIVA'">
                    Situação {{ quote.cnpjStatus | titlecase }}
                  </span>
                  <a
                    class="chip chip--link"
                    *ngIf="quote.cnpjCardUrl"
                    [href]="quote.cnpjCardUrl"
                    target="_blank"
                    rel="noreferrer"
                  >
                    Cartão CNPJ na Receita Federal
                  </a>
                </div>
                <p class="quote-card__value">{{ quote.value | currency: 'BRL' }}</p>
                <p class="muted">Validade até {{ quote.validity | date: 'dd/MM/yyyy' }}</p>
                <p class="quote-card__notes">{{ quote.notes || 'Sem observações adicionais' }}</p>
                <div class="quote-card__actions">
                  <button class="ghost" type="button" (click)="printSection()">
                    <fa-icon [icon]="faPrint"></fa-icon>
                    Imprimir
                  </button>
                  <button class="primary" type="button" [disabled]="currentQuotes.length < 3" (click)="markWinner(quote)">
                    <fa-icon [icon]="faCheckCircle"></fa-icon>
                    Definir vencedor
                  </button>
                </div>
              </article>
            </div>
            <ng-template #noQuotes>
              <p class="empty-state">Inclua no mínimo 3 propostas para habilitar o vencedor.</p>
            </ng-template>
          </div>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'reserva'">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">Reserva orçamentária</p>
            <p class="muted">Busque recursos na contabilidade, registre a reserva e siga para a contratação.</p>
          </div>
          <div class="tab-card__actions">
            <button class="ghost" type="button" (click)="printSection()">
              <fa-icon [icon]="faPrint"></fa-icon>
              Imprimir reserva
            </button>
            <button class="primary" type="button" (click)="navigateStep('next')">
              Ir para conclusão
              <fa-icon [icon]="faArrowRight"></fa-icon>
            </button>
          </div>
        </div>

        <div class="grid-two-columns">
          <div class="panel">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Centros de custo</p>
                <p class="panel__title">Disponibilidade na contabilidade</p>
              </div>
              <span class="pill pill--ghost">Etapa 4/5</span>
            </header>

            <div class="budget-grid">
              <article class="budget-card" *ngFor="let envelope of budgetEnvelopes">
                <div class="budget-card__header">
                  <div>
                    <p class="strong">{{ envelope.center }}</p>
                    <p class="muted">{{ envelope.title }}</p>
                  </div>
                  <span class="pill pill--ghost">{{ envelope.linkedTo }}</span>
                </div>
                <p class="budget-card__value">{{ envelope.available | currency: 'BRL' }}</p>
                <p class="muted">Saldo disponível para reserva</p>
              </article>
            </div>
          </div>

          <form class="panel" (ngSubmit)="registerReservation()">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Reserva contábil</p>
                <p class="panel__title">Vincular reserva à compra</p>
              </div>
              <span class="pill">{{ selected.title }}</span>
            </header>

            <div class="form-grid">
              <label class="form-field">
                <span>Centro de custo</span>
                <select class="select" name="center" [(ngModel)]="reservationForm.center">
                  <option *ngFor="let envelope of budgetEnvelopes" [value]="envelope.center">
                    {{ envelope.center }} · {{ envelope.title }}
                  </option>
                </select>
              </label>
              <label class="form-field">
                <span>Valor a reservar</span>
                <input class="input" type="number" name="value" [(ngModel)]="reservationForm.value" min="0" step="0.01" />
              </label>
              <label class="form-field">
                <span>Número da reserva</span>
                <input class="input" name="reservationNumber" [(ngModel)]="reservationForm.reservationNumber" placeholder="RES-000/2024" />
              </label>
              <label class="form-field form-field--full">
                <span>Observações</span>
                <textarea class="textarea" name="observation" [(ngModel)]="reservationForm.observation" rows="3"></textarea>
              </label>
            </div>

            <div class="form-actions">
              <button class="primary" type="submit">Registrar reserva</button>
              <button class="ghost" type="button" (click)="navigateStep('next')">Avançar</button>
            </div>
          </form>
        </div>

        <div class="panel panel--wide">
          <header class="panel__header">
            <div>
              <p class="panel__eyebrow">Reservas registradas</p>
              <p class="panel__title">Rastreabilidade contábil</p>
            </div>
            <span class="pill pill--ghost">Reserva orçamentária impressa</span>
          </header>
          <div class="reservations" *ngIf="reservations.length; else noReservations">
            <article class="reservation" *ngFor="let reservation of reservations">
              <div>
                <p class="strong">{{ reservation.center }}</p>
                <p class="muted">{{ reservation.observation }}</p>
              </div>
              <div class="reservation__meta">
                <span class="pill" [class.pill--accent]="reservation.status === 'reservado'">{{ reservation.status }}</span>
                <span>{{ reservation.value | currency: 'BRL' }}</span>
                <span class="muted">{{ reservation.createdAt | date: 'dd/MM/yyyy' }}</span>
              </div>
            </article>
          </div>
          <ng-template #noReservations>
            <p class="empty-state">Nenhuma reserva realizada ainda.</p>
          </ng-template>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'conclusao'">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">Conclusão e integração</p>
            <p class="muted">Finalize a compra, envie para patrimônio ou almoxarifado e gere o termo de conclusão.</p>
          </div>
          <div class="tab-card__actions">
            <button class="ghost" type="button" (click)="printSection()">
              <fa-icon [icon]="faPrint"></fa-icon>
              Imprimir termo
            </button>
            <button class="primary" type="button" (click)="navigateStep('prev')">
              Voltar para reserva
              <fa-icon [icon]="faArrowLeft"></fa-icon>
            </button>
          </div>
        </div>

        <div class="grid-two-columns">
          <article class="panel">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Dados finais</p>
                <p class="panel__title">{{ selected.title }}</p>
              </div>
              <span class="pill">{{ selected.type }}</span>
            </header>

            <dl class="definition-list">
              <div>
                <dt>Fornecedor vencedor</dt>
                <dd>{{ selected.winnerSupplier || 'Selecionar na etapa de cotação' }}</dd>
              </div>
              <div>
                <dt>Reserva orçamentária</dt>
                <dd>{{ selected.reservationNumber || 'Registrar número da reserva' }}</dd>
              </div>
              <div>
                <dt>Centro de custo reservado</dt>
                <dd>{{ selected.budgetCenter || 'Reservar centro de custo' }}</dd>
              </div>
              <div>
                <dt>Autorização de pagamento</dt>
                <dd>
                  <span *ngIf="selected.paymentAuthorization?.number; else noPaymentAuth">
                    Nº {{ selected.paymentAuthorization?.number }}
                    <span *ngIf="selected.paymentAuthorization?.authorizedBy"> • {{ selected.paymentAuthorization?.authorizedBy }}</span>
                    <span *ngIf="selected.paymentAuthorization?.date">
                      • {{ selected.paymentAuthorization?.date | date: 'dd/MM/yyyy' }}
                    </span>
                  </span>
                  <ng-template #noPaymentAuth>
                    Registrar autorização de pagamento na conclusão.
                  </ng-template>
                </dd>
              </div>
              <div>
                <dt>Integrações obrigatórias</dt>
                <dd>
                  <span class="pill pill--ghost" *ngIf="integrationChecklist[selected.id]?.patrimony">Patrimônio</span>
                  <span class="pill pill--ghost" *ngIf="integrationChecklist[selected.id]?.warehouse">Almoxarifado</span>
                  <span class="pill pill--ghost" *ngIf="integrationChecklist[selected.id]?.contracts">Contratos</span>
                  <span class="muted" *ngIf="!integrationChecklist[selected.id]">Defina os destinos abaixo</span>
                </dd>
              </div>
            </dl>
          </article>

          <form class="panel" (ngSubmit)="finalizePurchase()">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Integração</p>
                <p class="panel__title">Patrimônio e almoxarifado</p>
              </div>
              <span class="pill">Etapa 5/5</span>
            </header>

            <div class="form-grid">
              <label class="form-field">
                <span>Nº do termo / documento</span>
                <input class="input" name="documentNumber" [(ngModel)]="conclusionForm.documentNumber" placeholder="TERM-2024/001" />
              </label>
              <label class="form-field">
                <span>Autorização de pagamento</span>
                <input class="input" name="paymentNumber" [(ngModel)]="paymentAuthorizationForm.number" placeholder="AP-2024/001" />
              </label>
              <label class="form-field">
                <span>Responsável pela autorização</span>
                <input class="input" name="authorizedBy" [(ngModel)]="paymentAuthorizationForm.authorizedBy" placeholder="Nome do aprovador" />
              </label>
              <label class="form-field">
                <span>Data da autorização</span>
                <input class="input" type="date" name="paymentDate" [(ngModel)]="paymentAuthorizationForm.date" />
              </label>
              <label class="form-field form-field--full">
                <span>Observações finais</span>
                <textarea class="textarea" name="observation" [(ngModel)]="conclusionForm.observation" rows="3"></textarea>
              </label>
              <label class="form-field form-field--full">
                <span>Observações da autorização de pagamento</span>
                <textarea class="textarea" name="paymentNotes" [(ngModel)]="paymentAuthorizationForm.notes" rows="3"></textarea>
              </label>
              <label class="checkbox">
                <input type="checkbox" name="sendToPatrimony" [(ngModel)]="conclusionForm.sendToPatrimony" />
                <span>Enviar para cadastro de patrimônio (compras de bens)</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" name="sendToWarehouse" [(ngModel)]="conclusionForm.sendToWarehouse" />
                <span>Enviar para cadastro de almoxarifado (materiais)</span>
              </label>
            </div>

            <div class="form-actions">
              <button class="primary" type="submit">
                <fa-icon [icon]="faCircleCheck"></fa-icon>
                Concluir compra
              </button>
              <button class="ghost" type="button" (click)="printSection()">Imprimir termo</button>
            </div>
          </form>
        </div>

        <div class="panel panel--wide">
          <header class="panel__header">
            <div>
              <p class="panel__eyebrow">Checklist final</p>
              <p class="panel__title">Fluxo integrado</p>
            </div>
          </header>
          <div class="integration-grid">
            <article class="integration-card">
              <fa-icon [icon]="faBuildingColumns"></fa-icon>
              <div>
                <p class="strong">Contabilidade</p>
                <p class="muted">Reserva orçamentária vinculada ao centro de custo e autorização de pagamento.</p>
              </div>
            </article>
            <article class="integration-card">
              <fa-icon [icon]="faWarehouse"></fa-icon>
              <div>
                <p class="strong">Almoxarifado</p>
                <p class="muted">Materiais geram saldo inicial no cadastro de estoque.</p>
              </div>
            </article>
            <article class="integration-card">
              <fa-icon [icon]="faGavel"></fa-icon>
              <div>
                <p class="strong">Contratos</p>
                <p class="muted">Serviços e contratos acompanham vigência, SLA e reajustes.</p>
              </div>
            </article>
            <article class="integration-card">
              <fa-icon [icon]="faStamp"></fa-icon>
              <div>
                <p class="strong">Patrimônio</p>
                <p class="muted">Bens permanentes são registrados com tombamento e responsável.</p>
              </div>
            </article>
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</section>
</app-tela-padrao>

