<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  (salvar)="salvarSolicitacao()"
  (excluir)="removerSolicitacaoSelecionada()"
  (novo)="iniciarNovaSolicitacao()"
  (cancelar)="limparFormularioSolicitacao()"
  (imprimir)="printSection()"
  (buscar)="onBuscar()"
  (fechar)="fecharTela()"
>
<header class="page-title" slot="titulo">
    <div class="page-title__stack">
      <p class="page-title__eyebrow">Financeiro</p>
  <div class="page-title__headline">
    <div>
      <p class="page-title__label">Autoriza&ccedil;&atilde;o de compras</p>
      <p class="page-title__note">Gestao de solicitacoes e autorizacoes de compras.</p>
        </div>
    </div>
  </div>
</header>

<section class="cadastro">
  <div class="tab-shell">
    <p class="tab-shell__title">Etapas principais</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let step of steps; index as idx"
        class="step-tabs__item"
        [class.active]="activeStep === step.id"
        [class.completed]="idx < activeStepIndex"
      >
        <button class="step-tabs__button" type="button" (click)="changeStep(step.id)">
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ step.label }}</span>
        </button>
      </li>
    </ol>
  </div>

  <div class="workspace">
    <div class="tab-card" [ngSwitch]="activeStep">
      <ng-container *ngSwitchCase="'solicitacao'">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">Solicitação de compras</p>
          </div>
            <div class="tab-card__actions">
              <button class="ghost" type="button" (click)="printSection()">
                <fa-icon [icon]="faPrint"></fa-icon>
                Imprimir solicitação
              </button>
              <button class="primary" type="button" (click)="navigateStep('next')">
                Próxima etapa
                <fa-icon [icon]="faArrowRight"></fa-icon>
              </button>
            </div>
        </div>

        <div class="grid-two-columns">
          <form class="panel" (ngSubmit)="createRequest()">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Nova solicitação</p>
                <p class="panel__title">Detalhes da demanda</p>
              </div>
              <span class="pill">Etapa 1/5</span>
            </header>

            <app-popup-messages
              *ngIf="popupErros.length"
              [mensagens]="popupErros"
              (fechar)="fecharPopupErros()"
            ></app-popup-messages>

            <div class="form-grid">
              <div class="form-row form-row--line1">
                <label class="form-field form-field--type">
                  <span>Tipo*</span>
                  <select class="select" name="type" [(ngModel)]="newRequestForm.type">
                    <option value="produto">Compras de produtos</option>
                    <option value="bem">Compra de bens</option>
                    <option value="servico">Autorização de serviços</option>
                    <option value="contrato">Contratos</option>
                  </select>
                </label>
                <label class="form-field form-field--quantity">
                  <span>Quant.</span>
                  <input
                    class="input"
                    type="number"
                    min="1"
                    max="999999"
                    step="1"
                    name="quantity"
                    [(ngModel)]="newRequestForm.quantity"
                  />
                </label>
                <label class="form-field form-field--title">
                  <span>Título da compra*</span>
                  <input
                    class="input"
                    name="title"
                    [(ngModel)]="newRequestForm.title"
                    placeholder="Ex.: Kits pedagógicos"
                    required
                  />
                </label>
              </div>
              <div class="form-row form-row--line2">
                <label class="form-field">
                  <span>Área solicitante</span>
                  <input class="input" name="area" [(ngModel)]="newRequestForm.area" placeholder="Setor / projeto" />
                </label>
                <label class="form-field">
                  <span>Responsável*</span>
                  <select class="select" name="requester" [(ngModel)]="newRequestForm.requester" required>
                    <option value="" disabled [selected]="!newRequestForm.requester">Selecione um profissional</option>
                    <option *ngFor="let profissional of profissionais" [value]="profissional.nomeCompleto">
                      {{ profissional.nomeCompleto }}<span *ngIf="profissional.categoria"> • {{ profissional.categoria }}</span>
                    </option>
                  </select>
                </label>
                <label class="form-field form-field--value">
                  <span>Valor estimado*</span>
                  <input
                    class="input"
                    type="text"
                    name="value"
                    [value]="valorEstimadoDisplay"
                    inputmode="decimal"
                    placeholder="R$ 0,00"
                    (input)="formatValorEstimadoInput($event.target.value)"
                  />
                </label>
              </div>
              <div class="form-row form-row--line3">
                <label class="form-field">
                  <span>Previsão / necessidade</span>
                  <input class="input" type="date" name="expectedDate" [(ngModel)]="newRequestForm.expectedDate" />
                </label>
                <label class="form-field form-field--priority">
                  <span>Prioridade</span>
                  <select class="select" name="priority" [(ngModel)]="newRequestForm.priority">
                    <option value="urgente">Urgente</option>
                    <option value="normal">Normal (não urgente)</option>
                    <option value="baixa">Baixa prioridade</option>
                  </select>
                </label>
              </div>
              <label class="form-field form-field--full">
                <span>Justificativa e escopo*</span>
                <textarea
                  class="textarea"
                  name="justification"
                  [(ngModel)]="newRequestForm.justification"
                  rows="4"
                  placeholder="Objetivo, quantidades, critérios mínimos e impacto social"
                  required
                ></textarea>
              </label>
            </div>

            <div class="form-actions">
              <button
                class="primary"
                type="button"
                [disabled]="!podeSalvarSolicitacao"
                (click)="createRequest()"
              >
                Salvar solicitação
              </button>
              <button class="ghost" type="button" (click)="navigateStep('next')">Pular para autorização</button>
            </div>
            <div class="pending-grid">
              <header class="pending-grid__header--meta">
                <div>
                  <p class="pending-grid__eyebrow">Solicitações pendentes</p>
                  <p class="pending-grid__title">Aguardando autorização</p>
                </div>
                <span class="pill pill--ghost">{{ pendingSolicitacoes.length }} cadastrada(s)</span>
              </header>
              <div *ngIf="pendingSolicitacoes.length; else noPending">
                <div class="pending-grid__header">
                  <span>Quant.</span>
                  <span>Item</span>
                  <span>Resp.</span>
                  <span>Local</span>
                  <span>Prioridade</span>
                  <span>Prazo</span>
                  <span>Previsto</span>
                  <span class="text-center">Ações</span>
                </div>
                <div class="pending-grid__list">
                  <article class="pending-grid__item" *ngFor="let request of pendingSolicitacoes">
                    <span class="pending-grid__quantidade">Qtd {{ request.quantity }}</span>
                    <span class="pending-grid__title">{{ request.title }}</span>
                    <span class="pending-grid__responsavel">{{ request.requester }}</span>
                    <span class="pending-grid__area">{{ request.area || 'Sem área' }}</span>
                    <span
                      class="pill pill--ghost pending-grid__priority"
                      *ngIf="request.priority"
                      [ngClass]="{
                        'pill--priority-urgente': request.priority === 'urgente',
                        'pill--priority-normal': request.priority === 'normal',
                        'pill--priority-baixa': request.priority === 'baixa'
                      }"
                    >
                      {{ request.priority | titlecase }}
                    </span>
                    <span class="pending-grid__prazo">{{ request.expectedDate | date: 'dd/MM/yyyy' }}</span>
                    <span class="pending-grid__valor">{{ request.value | currency: 'BRL' }}</span>
                    <div class="pending-grid__acoes">
                      <button class="chip chip--accent" type="button" (click)="avancarParaAutorizacao(request)">
                        Enviar para autorização
                      </button>
                      <small class="pending-grid__motivo" *ngIf="request.approval?.notes">
                        Motivo do parecer: {{ request.approval?.notes }}
                      </small>
                    </div>
                  </article>
                </div>
              </div>
              <ng-template #noPending>
                <p class="empty-state">Nenhuma solicitação aguardando autorização no momento.</p>
              </ng-template>
            </div>
          </form>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'autorizacao'">
        <ng-container *ngIf="selectedRequest as selected; else noSelection">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">Autorização pela diretoria</p>
            <p class="muted">
              Registre parecer, encaminhe para contabilidade e defina condicionantes antes de liberar cotações.
            </p>
          </div>
            <div class="tab-card__actions tab-card__actions--stacked">
              <button class="ghost" type="button" (click)="changeStep('solicitacao')">
                <fa-icon [icon]="faArrowLeft"></fa-icon>
                Revisar solicitação
              </button>
              <button class="primary" type="button" (click)="navigateStep('next')">
                Ir para cotação
                <fa-icon [icon]="faArrowRight"></fa-icon>
              </button>
            </div>
        </div>

        <div class="panel panel--wide">
          <header class="panel__header">
            <div>
              <p class="panel__eyebrow">Solicitações para parecer</p>
              <p class="panel__title">Selecione a compra</p>
            </div>
            <span class="pill pill--ghost">{{ autorizacoesPendentes.length }} pendente(s)</span>
          </header>
          <div class="authorization-list" *ngIf="autorizacoesPendentes.length; else noPendingAuthorizations">
            <button
              class="authorization-list__item"
              *ngFor="let request of autorizacoesPendentes"
              type="button"
              [class.authorization-list__item--active]="request.id === selectedRequestId"
              (click)="selectRequest(request.id)"
            >
              <div>
                <p class="authorization-list__title">{{ request.title }}</p>
                <p class="authorization-list__meta">
                  {{ request.requester }} • {{ request.area || 'Sem área' }} • {{ request.expectedDate | date: 'dd/MM/yyyy' }}
                </p>
              </div>
              <div class="authorization-list__value">{{ request.value | currency: 'BRL' }}</div>
            </button>
          </div>
          <ng-template #noPendingAuthorizations>
            <p class="empty-state">Nenhuma solicitação aguardando parecer no momento.</p>
          </ng-template>
        </div>

        <div class="grid-two-columns">
          <article class="panel">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Dados da solicitação</p>
                <p class="panel__title">{{ selected.title }}</p>
              </div>
              <span class="pill">{{ selected.type }}</span>
            </header>

            <div class="info-grid">
              <div class="info-grid__item">
                <p class="info-grid__label">Valor estimado</p>
                <p class="info-grid__value">{{ selected.value | currency: 'BRL' }}</p>
              </div>
              <div class="info-grid__item">
                <p class="info-grid__label">Entrega prevista</p>
                <p class="info-grid__value">{{ selected.expectedDate | date: 'dd/MM/yyyy' }}</p>
              </div>
              <div class="info-grid__item">
                <p class="info-grid__label">Centro de custo</p>
                <p class="info-grid__value">{{ selected.budgetCenter || 'A definir com contabilidade' }}</p>
              </div>
            </div>

            <dl class="definition-list">
              <div class="definition-list__row definition-list__row--full">
                <dt>Justificativa</dt>
                <dd>{{ selected.justification }}</dd>
              </div>
              <div *ngIf="selected.quotationExemptionReason">
                <dt>Dispensa de cotação</dt>
                <dd>{{ selected.quotationExemptionReason }}</dd>
              </div>
              <div>
                <dt>Área / responsável</dt>
                <dd>{{ selected.area }} • {{ selected.requester }}</dd>
              </div>
              <div>
                <dt>Documentos e anexos</dt>
                <dd>Gerencie no relatório para impressão.</dd>
              </div>
            </dl>

            <div class="callout" *ngIf="selected.approval?.notes">
              <p class="callout__title">Observação registrada pela diretoria</p>
              <p class="callout__text">{{ selected.approval?.notes }}</p>
            </div>
          </article>

          <form class="panel" (ngSubmit)="registerAuthorization()">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Parecer da diretoria</p>
                <p class="panel__title">Autorizar ou solicitar ajustes</p>
              </div>
              <span class="pill pill--ghost">Etapa 2/5</span>
            </header>

            <div class="form-grid">
              <label class="form-field">
                <span>Diretor responsável</span>
                <select class="select" name="director" [(ngModel)]="approvalForm.director">
                  <option value="" disabled [selected]="!approvalForm.director">Selecione um profissional</option>
                  <option *ngFor="let profissional of profissionais" [value]="profissional.nomeCompleto">
                    {{ profissional.nomeCompleto }}<span *ngIf="profissional.categoria"> • {{ profissional.categoria }}</span>
                  </option>
                </select>
              </label>
              <label class="form-field">
                <span>Data</span>
                <input class="input" type="date" name="date" [(ngModel)]="approvalForm.date" />
              </label>
              <div class="form-field form-field--full">
                <span>Decisão</span>
                <div class="decision-options" role="group" aria-label="Decisão da diretoria">
                  <label class="radio-card" [class.radio-card--active]="approvalForm.decision === 'aprovado'">
                    <input type="radio" name="decision" value="aprovado" [(ngModel)]="approvalForm.decision" />
                    <span class="radio-card__content">
                      <fa-icon [icon]="faCheckCircle"></fa-icon>
                      <span>
                        <strong>Aprovar</strong>
                        <small>Liberar imediatamente para cotação.</small>
                      </span>
                    </span>
                  </label>
                  <label class="radio-card" [class.radio-card--active]="approvalForm.decision === 'ajustes'">
                    <input type="radio" name="decision" value="ajustes" [(ngModel)]="approvalForm.decision" />
                    <span class="radio-card__content">
                      <fa-icon [icon]="faFileSignature"></fa-icon>
                      <span>
                        <strong>Pedir ajustes</strong>
                        <small>Solicitar correção antes de avançar.</small>
                      </span>
                    </span>
                  </label>
                  <label class="radio-card" [class.radio-card--active]="approvalForm.decision === 'rejeitado'">
                    <input type="radio" name="decision" value="rejeitado" [(ngModel)]="approvalForm.decision" />
                    <span class="radio-card__content">
                      <fa-icon [icon]="faStamp"></fa-icon>
                      <span>
                        <strong>Rejeitar</strong>
                        <small>Encerrar a solicitação nesta etapa.</small>
                      </span>
                    </span>
                  </label>
                </div>
              </div>
              <label class="form-field form-field--full">
                <span>Observações</span>
                <textarea
                  class="textarea"
                  name="notes"
                  [(ngModel)]="approvalForm.notes"
                  rows="4"
                  placeholder="Condições, limites de valor, reservas orçamentárias ou direcionamento de fornecedores"
                ></textarea>
              </label>
            </div>
            <div class="form-actions">
              <button class="primary" type="submit">Registrar parecer</button>
              <button class="ghost" type="button" (click)="navigateStep('next')">Avançar</button>
            </div>
          </form>
        </div>

        <div class="panel panel--wide">
          <header class="panel__header">
            <div>
              <p class="panel__eyebrow">Linha do tempo</p>
              <p class="panel__title">Evidências e documentos impressos</p>
            </div>
            <span class="pill pill--ghost">Formulários de impressão por etapa</span>
          </header>

          <div class="timeline">
            <div class="timeline__item" *ngFor="let step of steps">
              <div class="timeline__bullet" [class.timeline__bullet--active]="step.id === activeStep"></div>
              <div>
                <p class="strong">{{ step.label }}</p>
                <p class="muted">{{ step.documentLabel }}</p>
              </div>
              <button class="ghost" type="button" (click)="printSection()">
                <fa-icon [icon]="faPrint"></fa-icon>
                Imprimir {{ step.label }}
              </button>
            </div>
          </div>
        </div>
        </ng-container>
      </ng-container>

      <ng-container *ngSwitchCase="'cotacoes'">
        <ng-container *ngIf="selectedRequest as selected; else noSelection">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">Cotação prévia e vencedor</p>
            <p class="muted">Cadastre pelo menos 3 cotações, compare condições e selecione o fornecedor vencedor.</p>
          </div>
        <div class="tab-card__actions">
          <button class="primary" type="button" (click)="navigateStep('next')">
            Ir para reserva orçamentária
            <fa-icon [icon]="faArrowRight"></fa-icon>
          </button>
        </div>
        </div>

        <div class="callout callout--info" *ngIf="!requiresQuotation(selected)">
          <p class="callout__title">Dispensa de cotação autorizada</p>
          <p class="callout__text">
            O valor estimado ({{ selected.value | currency: 'BRL' }}) está abaixo do limite de
            {{ quotationThreshold | currency: 'BRL' }}. Registre o fornecedor com CNPJ ativo e siga direto para a
            reserva orçamentária.
          </p>
          <div class="callout__actions">
            <button class="primary" type="button" (click)="dispenseQuotation()">
              <fa-icon [icon]="faCheckCircle"></fa-icon>
              Dispensar cotação e avançar
            </button>
            <button class="ghost" type="button" (click)="navigateStep('next')">Ir para reserva</button>
          </div>
        </div>

        <div class="grid-two-columns">
          <form class="panel" (ngSubmit)="addQuotation()">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Nova cotação</p>
                <p class="panel__title">Registrar fornecedor</p>
              </div>
              <span class="pill pill--ghost">Etapa 3/5</span>
            </header>

            <app-popup-messages
              *ngIf="popupErrosCotacao.length"
              [mensagens]="popupErrosCotacao"
              (fechar)="popupErrosCotacao = []"
            ></app-popup-messages>

            <div class="form-grid">
              <label class="form-field">
                <span>Link do cartão CNPJ</span>
                <input
                  class="input"
                  name="cnpjCardUrl"
                  [ngModel]="newQuoteForm.cnpjCardUrl"
                  placeholder="URL do cartão CNPJ consultado"
                  (ngModelChange)="onCnpjCardUrlChange($event)"
                  (keydown)="onLinkCnpjKeydown($event)"
                />
                <small class="form-hint">Cole o link do cartão CNPJ ou preencha o CNPJ manualmente.</small>
              </label>
              <label class="form-field">
                <span>CNPJ do fornecedor*</span>
                <input
                  class="input"
                  name="cnpj"
                  [(ngModel)]="newQuoteForm.cnpj"
                  placeholder="00.000.000/0001-00"
                  inputmode="numeric"
                  (keydown)="onCnpjKeydown($event)"
                  (blur)="onCnpjBlur()"
                  required
                />
                <small class="form-hint" *ngIf="carregandoFornecedor">
                  <fa-icon [icon]="faSpinner" class="spinner"></fa-icon>
                  Buscando fornecedor...
                </small>
                <small class="form-error" *ngIf="avisoFornecedor">{{ avisoFornecedor }}</small>
              </label>
              <label class="form-field">
                <span>Razão social (cartão CNPJ)</span>
                <input
                  class="input"
                  name="companyName"
                  [(ngModel)]="newQuoteForm.companyName"
                  placeholder="Nome conforme Receita Federal"
                  (keydown)="onRazaoSocialKeydown($event)"
                  (blur)="onRazaoSocialBlur()"
                  (input)="onRazaoSocialInput()"
                />
              </label>
              <label class="form-field">
                <span>Nome fantasia / contato*</span>
                <input
                  class="input"
                  name="supplier"
                  [(ngModel)]="newQuoteForm.supplier"
                  placeholder="Responsável comercial"
                  (input)="onNomeFantasiaInput()"
                  required
                />
              </label>
              <label class="form-field">
                <span>Valor ofertado*</span>
                <input
                  class="input"
                  type="text"
                  name="value"
                  [value]="valorCotacaoDisplay"
                  inputmode="decimal"
                  placeholder="R$ 0,00"
                  (input)="formatValorCotacaoInput($event.target.value)"
                  required
                />
              </label>
              <label class="form-field">
                <span>Prazo de entrega</span>
                <input class="input" type="date" name="delivery" [(ngModel)]="newQuoteForm.delivery" />
              </label>
              <label class="form-field">
                <span>Validade da proposta</span>
                <input class="input" type="date" name="validity" [(ngModel)]="newQuoteForm.validity" />
              </label>
              <label class="form-field">
                <span>Orçamento físico</span>
                <input
                  class="input"
                  type="file"
                  accept=".pdf,.jpg,.jpeg,.png"
                  (change)="onOrcamentoFisicoSelecionado($event)"
                />
              </label>
              <label class="form-field">
                <span>Conformidade</span>
                <select class="select" name="compliance" [(ngModel)]="newQuoteForm.compliance" disabled>
                  <option value="ok">Documentação OK</option>
                  <option value="pendente">Documentação pendente</option>
                </select>
              </label>
              <label class="form-field form-field--full">
                <span>Observações</span>
                <textarea class="textarea" name="notes" [(ngModel)]="newQuoteForm.notes" rows="3"></textarea>
              </label>
            </div>

            <div class="form-actions">
              <button class="primary" type="submit">Adicionar cotação</button>
              <button class="ghost" type="button" (click)="navigateStep('next')">Avançar</button>
            </div>
          </form>

          <div class="panel">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Comparativo</p>
                <p class="panel__title">Escolha o vencedor</p>
              </div>
              <span class="pill" [class.pill--accent]="quoteRequirementMet">
                {{ currentQuotes.length }} propostas
              </span>
            </header>

            <div class="quotes" *ngIf="currentQuotes.length; else noQuotes">
              <article
                class="quote-card"
                *ngFor="let quote of currentQuotes"
                [class.quote-card--winner]="isLowestQuote(quote)"
              >
                <div class="quote-card__header">
                  <div>
                    <p class="strong">{{ quote.supplier }}</p>
                    <p class="muted">Entrega: {{ quote.delivery | date: 'dd/MM/yyyy' }}</p>
                  </div>
                  <span class="pill" [class.pill--ghost]="quote.compliance === 'ok'">
                    {{ quote.compliance === 'ok' ? 'Documentação ok' : 'Documentação pendente' }}
                  </span>
                </div>
                <span class="pill pill--accent quote-card__winner" *ngIf="isLowestQuote(quote)">
                  Menor preço
                </span>
                <p class="quote-card__cnpj">
                  {{ quote.legalName }}
                  <br />
                  <span class="muted">
                    CNPJ {{ quote.cnpj }} • Consulta em {{ quote.cnpjCheckedAt | date: 'dd/MM/yyyy' }}
                  </span>
                </p>
                <div class="quote-card__status">
                  <span class="pill" [class.pill--accent]="quote.cnpjStatus === 'ATIVA'">
                    Situação {{ quote.cnpjStatus | titlecase }}
                  </span>
                  <a
                    class="chip chip--link"
                    *ngIf="quote.cnpjCardUrl"
                    [href]="quote.cnpjCardUrl"
                    target="_blank"
                    rel="noreferrer"
                  >
                    Cartão CNPJ na Receita Federal
                  </a>
                </div>
                <p class="quote-card__value">{{ quote.value | currency: 'BRL' }}</p>
                <p class="muted">Validade até {{ quote.validity | date: 'dd/MM/yyyy' }}</p>
                <p class="quote-card__notes">{{ quote.notes || 'Sem observações adicionais' }}</p>
                <div class="quote-card__actions">
                  <button class="ghost" type="button" (click)="imprimirOrcamento(quote)">
                    <fa-icon [icon]="faPrint"></fa-icon>
                    Imprimir orçamento
                  </button>
                  <button class="ghost" type="button" (click)="removerCotacao(quote)">
                    Excluir
                  </button>
                  <button class="primary" type="button" (click)="markWinner(quote)">
                    <fa-icon [icon]="faCheckCircle"></fa-icon>
                    Definir vencedor
                  </button>
                </div>
              </article>
            </div>
            <ng-template #noQuotes>
              <p class="empty-state">Inclua no mínimo 3 propostas para habilitar o vencedor.</p>
            </ng-template>
          </div>
        </div>
        </ng-container>
      </ng-container>

      <ng-container *ngSwitchCase="'reserva'">
        <ng-container *ngIf="selectedRequest as selected; else noSelection">    
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">Reserva orçamentária</p>
            <p class="muted">Busque recursos na contabilidade, registre a reserva e siga para a contratação.</p>
          </div>
        <div class="tab-card__actions">
          <button class="primary" type="button" (click)="navigateStep('next')"> 
            Ir para conclusão
            <fa-icon [icon]="faArrowRight"></fa-icon>
          </button>
        </div>
        </div>

        <div class="callout callout--info" *ngIf="reservaConfirmada">
          <p class="callout__title">Reserva registrada com sucesso</p>
          <p class="callout__text">
            O valor foi reservado e vinculado ao centro de custo selecionado.
          </p>
        </div>

        <div class="panel panel--wide">
          <header class="panel__header">
            <div>
              <p class="panel__eyebrow">Reserva orçamentária</p>
              <p class="panel__title">Contas bancárias e reserva contábil</p>
            </div>
            <span class="pill pill--ghost">Etapa 4/5</span>
          </header>

          <div class="grid-two-columns">
            <div>
              <div class="panel__section-header">
                <p class="panel__section-title">Contas bancárias</p>
                <p class="muted">Saldo positivo para reserva</p>
              </div>

              <div class="budget-grid" *ngIf="contasBancariasComSaldo.length; else noAccounts">
                <button
                  type="button"
                  class="budget-card"
                  *ngFor="let conta of contasBancariasComSaldo"
                  [class.budget-card--selected]="isContaReservada(conta)"
                  (click)="reservarSaldoBanco(conta)"
                >
                <div class="budget-card__header">
                  <div>
                    <p class="strong">{{ conta.banco }}</p>
                    <p class="muted">Agência {{ conta.agencia || '---' }} • {{ conta.numero }}</p>
                  </div>
                  <span class="pill pill--ghost">{{ conta.tipo }}</span>
                </div>
                <span class="pill pill--accent budget-card__status" *ngIf="isContaReservada(conta)">
                  <fa-icon [icon]="faCircleCheck"></fa-icon>
                  Reservado
                </span>
                <p class="budget-card__value">{{ conta.saldo | currency: 'BRL' }}</p>
                  <label class="budget-card__input">
                    <span>Valor da reserva</span>
                    <input
                      class="input"
                      type="text"
                      inputmode="decimal"
                      [value]="reservaValoresDisplay[conta.id]"
                      name="reservaValor-{{ conta.id }}"
                      (input)="atualizarValorReservaConta(conta, $event.target.value)"
                      (click)="$event.stopPropagation()"
                    />
                  </label>
                  <p class="muted" *ngIf="!isContaReservada(conta)">
                    Clique para reservar o valor definido
                  </p>
                  <p class="muted" *ngIf="isContaReservada(conta)">
                    Reserva aplicada. Clique para estornar.
                  </p>
                </button>
              </div>
              <ng-template #noAccounts>
                <p class="empty-state">Nenhuma conta com saldo positivo disponível.</p>
              </ng-template>
            </div>

            <form (ngSubmit)="registerReservation()">
              <div class="panel__section-header">
                <p class="panel__section-title">Centro de custo</p>
              </div>

              <div class="form-grid">
                <label class="form-field">
                  <span>Centro de custo</span>
                  <select class="select" name="center" [(ngModel)]="reservationForm.center">
                    <option *ngFor="let envelope of budgetEnvelopes" [value]="envelope.center">
                      {{ envelope.center }} · {{ envelope.title }}
                    </option>
                  </select>
                </label>
                <label class="form-field">
                  <span>Valor a reservar</span>
                  <input
                    class="input"
                    type="text"
                    name="value"
                    [value]="valorReservaDisplay"
                    inputmode="decimal"
                    placeholder="0,00"
                    (input)="formatValorReservaTotalInput($event.target.value)"
                  />
                </label>
                <label class="form-field form-field--full">
                  <span>Observações</span>
                  <textarea class="textarea" name="observation" [(ngModel)]="reservationForm.observation" rows="3"></textarea>
                </label>
              </div>

              <div class="form-actions">
                <button class="primary" type="submit">Registrar reserva</button>
                <button class="ghost" type="button" (click)="navigateStep('next')">Avançar</button>
              </div>
            </form>
          </div>
        </div>

        <div class="panel panel--wide">
          <header class="panel__header">
            <div>
              <p class="panel__eyebrow">Reservas registradas</p>
              <p class="panel__title">Rastreabilidade contábil</p>
            </div>
            <span class="pill pill--ghost">Reserva orçamentária impressa</span>
          </header>
          <div class="reservations" *ngIf="reservations.length; else noReservations">
            <article class="reservation" *ngFor="let reservation of reservations">
              <div>
                <p class="strong">{{ reservation.center }}</p>
                <p class="muted">{{ reservation.observation }}</p>
              </div>
              <div class="reservation__meta">
                <span class="pill" [class.pill--accent]="reservation.status === 'reservado'">{{ reservation.status }}</span>
                <span>{{ reservation.value | currency: 'BRL' }}</span>
                <span class="muted">{{ reservation.createdAt | date: 'dd/MM/yyyy' }}</span>
              </div>
            </article>
          </div>
          <ng-template #noReservations>
            <p class="empty-state">Nenhuma reserva realizada ainda.</p>
          </ng-template>
        </div>
        </ng-container>
      </ng-container>

      <ng-container *ngSwitchCase="'conclusao'">
        <ng-container *ngIf="selectedRequest as selected; else noSelection">    
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">Conclusão e integração</p>        
            <p class="muted">Finalize a compra, envie para patrimônio ou almoxarifado e gere o termo de conclusão.</p>
          </div>
        <div class="tab-card__actions">
          <button class="primary" type="button" (click)="navigateStep('prev')"> 
            Voltar para reserva
            <fa-icon [icon]="faArrowLeft"></fa-icon>
          </button>
        </div>
        </div>

        <div class="callout callout--info" *ngIf="reservaConfirmada">
          <p class="callout__title">Reserva registrada com sucesso</p>
          <p class="callout__text">
            O valor foi reservado e vinculado ao centro de custo selecionado.
          </p>
        </div>

        <div class="grid-two-columns">
          <article class="panel">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Dados finais</p>
                <p class="panel__title">{{ selected.title }}</p>
              </div>
              <span class="pill">{{ selected.type }}</span>
            </header>

            <dl class="definition-list">
              <div>
                <dt>Quantidade</dt>
                <dd>{{ selected.quantity }}</dd>
              </div>
              <div>
                <dt>Valor total</dt>
                <dd>{{ selected.value | currency: 'BRL' }}</dd>
              </div>
              <div>
                <dt>Área solicitante</dt>
                <dd>{{ selected.area || 'Não informado' }}</dd>
              </div>
              <div>
                <dt>Responsável</dt>
                <dd>{{ selected.requester }}</dd>
              </div>
              <div>
                <dt>Previsão / necessidade</dt>
                <dd>{{ selected.expectedDate | date: 'dd/MM/yyyy' }}</dd>
              </div>
              <div>
                <dt>Prioridade</dt>
                <dd>{{ selected.priority | titlecase }}</dd>
              </div>
              <div>
                <dt>Fornecedor vencedor</dt>
                <dd>{{ selected.winnerSupplier || 'Selecionar na etapa de cotação' }}</dd>
              </div>
              <div>
                <dt>Reserva orçamentária</dt>
                <dd>{{ selected.reservationNumber || 'Registrar número da reserva' }}</dd>
              </div>
              <div>
                <dt>Termo / documento</dt>
                <dd>{{ selected.documentNumber || 'Gerado automaticamente na conclusão' }}</dd>
              </div>
              <div>
                <dt>Centro de custo reservado</dt>
                <dd>{{ selected.budgetCenter || 'Reservar centro de custo' }}</dd>
              </div>
              <div>
                <dt>Autorização de pagamento</dt>
                <dd>
                  <span *ngIf="selected.paymentAuthorization?.number; else noPaymentAuth">
                    Nº {{ selected.paymentAuthorization?.number }}
                    <span *ngIf="selected.paymentAuthorization?.authorizedBy"> • {{ selected.paymentAuthorization?.authorizedBy }}</span>
                    <span *ngIf="selected.paymentAuthorization?.date">
                      • {{ selected.paymentAuthorization?.date | date: 'dd/MM/yyyy' }}
                    </span>
                  </span>
                  <ng-template #noPaymentAuth>
                    Registrar autorização de pagamento na conclusão.
                  </ng-template>
                </dd>
              </div>
              <div>
                <dt>Integrações obrigatórias</dt>
                <dd>
                  <span class="pill pill--ghost" *ngIf="integrationChecklist[selected.id]?.patrimony">Patrimônio</span>
                  <span class="pill pill--ghost" *ngIf="integrationChecklist[selected.id]?.warehouse">Almoxarifado</span>
                  <span class="pill pill--ghost" *ngIf="integrationChecklist[selected.id]?.contracts">Contratos</span>
                  <span class="muted" *ngIf="!integrationChecklist[selected.id]">Defina os destinos abaixo</span>
                </dd>
              </div>
              <div>
                <dt>Destino principal</dt>
                <dd>
                  <span *ngIf="selected.type === 'produto'">Almoxarifado</span>
                  <span *ngIf="selected.type === 'bem'">Patrimônio</span>
                  <span *ngIf="selected.type !== 'produto' && selected.type !== 'bem'">Não aplicável</span>
                </dd>
              </div>
              <div class="definition-list__row definition-list__row--full">
                <dt>Justificativa</dt>
                <dd>{{ selected.justification }}</dd>
              </div>
            </dl>
          </article>

          <form class="panel" (ngSubmit)="finalizePurchase()">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Integração</p>
                <p class="panel__title">Patrimônio e almoxarifado</p>
              </div>
              <span class="pill">Etapa 5/5</span>
            </header>

            <div class="form-grid">
              <label class="form-field">
                <span>Nº do termo / documento</span>
                <input
                  class="input"
                  name="documentNumber"
                  [(ngModel)]="conclusionForm.documentNumber"
                  placeholder="0001/2025"
                  readonly
                />
              </label>
              <label class="form-field">
                <span>Autorização de pagamento</span>
                <input
                  class="input"
                  name="paymentNumber"
                  [(ngModel)]="paymentAuthorizationForm.number"
                  placeholder="0001/2025"
                  readonly
                />
              </label>
              <label class="form-field">
                <span>Responsável pela autorização</span>
                <select class="select" name="authorizedBy" [(ngModel)]="paymentAuthorizationForm.authorizedBy">
                  <option value="" disabled [selected]="!paymentAuthorizationForm.authorizedBy">Selecione um profissional</option>
                  <option *ngFor="let profissional of profissionais" [value]="profissional.nomeCompleto">
                    {{ profissional.nomeCompleto }}<span *ngIf="profissional.categoria"> • {{ profissional.categoria }}</span>
                  </option>
                </select>
              </label>
              <label class="form-field">
                <span>Data da autorização</span>
                <input class="input" type="date" name="paymentDate" [(ngModel)]="paymentAuthorizationForm.date" />
              </label>
              <label class="form-field form-field--full">
                <span>Observações finais</span>
                <textarea class="textarea" name="observation" [(ngModel)]="conclusionForm.observation" rows="3"></textarea>
              </label>
              <label class="form-field form-field--full">
                <span>Observações da autorização de pagamento</span>
                <textarea class="textarea" name="paymentNotes" [(ngModel)]="paymentAuthorizationForm.notes" rows="3"></textarea>
              </label>
              <label class="checkbox">
                <input type="checkbox" name="sendToPatrimony" [(ngModel)]="conclusionForm.sendToPatrimony" />
                <span>Enviar para cadastro de patrimônio (compras de bens)</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" name="sendToWarehouse" [(ngModel)]="conclusionForm.sendToWarehouse" />
                <span>Enviar para cadastro de almoxarifado (materiais)</span>
              </label>
            </div>

            <div class="form-actions">
              <button class="primary" type="button" (click)="gerarAutorizacaoPagamento()">
                <fa-icon [icon]="faFileSignature"></fa-icon>
                Gerar autorização de pagamento
              </button>
              <button class="primary" type="submit">
                <fa-icon [icon]="faCircleCheck"></fa-icon>
                Concluir compra
              </button>
              <button class="ghost" type="button" (click)="printSection()">Imprimir termo</button>
            </div>
          </form>
        </div>

        <div class="panel panel--wide">
          <header class="panel__header">
            <div>
              <p class="panel__eyebrow">Checklist final</p>
              <p class="panel__title">Fluxo integrado</p>
            </div>
          </header>
          <div class="integration-grid">
            <article class="integration-card">
              <fa-icon [icon]="faBuildingColumns"></fa-icon>
              <div>
                <p class="strong">Contabilidade</p>
                <p class="muted">Reserva orçamentária vinculada ao centro de custo e autorização de pagamento.</p>
              </div>
            </article>
            <article class="integration-card">
              <fa-icon [icon]="faWarehouse"></fa-icon>
              <div>
                <p class="strong">Almoxarifado</p>
                <p class="muted">Materiais geram saldo inicial no cadastro de estoque.</p>
              </div>
            </article>
            <article class="integration-card">
              <fa-icon [icon]="faGavel"></fa-icon>
              <div>
                <p class="strong">Contratos</p>
                <p class="muted">Serviços e contratos acompanham vigência, SLA e reajustes.</p>
              </div>
            </article>
            <article class="integration-card">
              <fa-icon [icon]="faStamp"></fa-icon>
              <div>
                <p class="strong">Patrimônio</p>
                <p class="muted">Bens permanentes são registrados com tombamento e responsável.</p>
              </div>
            </article>
          </div>
        </div>
        </ng-container>
      </ng-container>
    </div>
  </div>
  <ng-template #noSelection>
    <div class="empty-state">
      <p>Selecione uma solicitação existente para visualizar as etapas seguintes.</p>
      <p class="small">Ainda não há solicitações? Cadastre uma nova na aba “Solicitação de compras”.</p>
    </div>
  </ng-template>
</section>
</app-tela-padrao>



