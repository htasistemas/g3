<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  (salvar)="onSalvar()"
  (excluir)="onExcluir()"
  (novo)="onNovo()"
  (cancelar)="onCancelar()"
  (imprimir)="onImprimir()"
  (buscar)="onBuscar()"
  (fechar)="onFechar()"
>
<header class="page-title page-title--row" slot="titulo">
  <div>
    <p class="page-title__eyebrow">Atendimentos</p>
    <p class="page-title__label">Banco de Empregos</p>
  </div>
    <p class="page-title__note">cadastro e acompanhamento de vagas e encaminhamentos.</p>
</header>

  <app-popup-messages [mensagens]="popupErros" [titulo]="popupTitulo" (fechar)="fecharPopupErros()"></app-popup-messages>

  <section class="job-page">
  <section class="tab-shell">
    <p class="tab-shell__title">NavegaÃ§Ã£o por etapas</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of tabs; index as idx"
        class="step-tabs__item"
        [class.active]="activeTab === tab.id"
        [class.completed]="idx < activeTabIndex"
      >
        <button
          type="button"
          class="step-tabs__button"
          role="tab"
          [attr.aria-selected]="activeTab === tab.id"
          (click)="changeTab(tab.id)"
        >
          <span class="step-tabs__index" aria-hidden="true">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ tab.label }}</span>
        </button>
      </li>
    </ol>
  </section>

  <form [formGroup]="form" class="form-shell">
    <section class="tab-card" *ngIf="activeTab === 'dadosVaga'" formGroupName="dadosVaga">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[0].label }}</p>
          <p class="muted">Informações principais da vaga.</p>
        </div>
      </div>

      <div class="field-grid cols-2">
        <label class="field full">Titulo da vaga *
          <input type="text" formControlName="titulo" placeholder="Ex.: Assistente administrativo" />
        </label>
        <label class="field">Status da vaga *
          <select formControlName="status">
            <option value="Aberta">Aberta</option>
            <option value="Em andamento">Em andamento</option>
            <option value="Encerrada">Encerrada</option>
          </select>
        </label>
        <label class="field">Data de abertura *
          <input type="date" formControlName="dataAbertura" />
        </label>
        <label class="field">Data de encerramento
          <input type="date" formControlName="dataEncerramento" />
        </label>
        <label class="field">Tipo de contrato
          <input type="text" formControlName="tipoContrato" placeholder="CLT, estagio, temporario..." />
        </label>
        <label class="field">Carga horaria
          <input type="text" formControlName="cargaHoraria" placeholder="Ex.: 40h semanais" />
        </label>
        <label class="field">Salario
          <input type="text" formControlName="salario" placeholder="Ex.: R$ 2.500,00" />
        </label>
      </div>
    </section>

    <section class="tab-card" *ngIf="activeTab === 'empresaLocal'" formGroupName="empresaLocal">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[1].label }}</p>
          <p class="muted">Dados da empresa e local de trabalho.</p>
        </div>
      </div>

      <div class="field-grid cols-2">
        <label class="field full">Nome da empresa *
          <input type="text" formControlName="nomeEmpresa" />
        </label>
        <label class="field">CNPJ
          <input type="text" formControlName="cnpj" (input)="onCnpjInput($event.target.value)" />
          <span class="text-error" *ngIf="cnpjErro">{{ cnpjErro }}</span>
        </label>
        <label class="field">Cidade *
          <input type="text" formControlName="cidade" />
        </label>
        <label class="field">endereço
          <input type="text" formControlName="endereco" />
        </label>
        <label class="field">Bairro
          <input type="text" formControlName="bairro" />
        </label>
      </div>
    </section>

    <section class="tab-card" *ngIf="activeTab === 'requisitos'" formGroupName="requisitos">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[2].label }}</p>
          <p class="muted">Requisitos, descricao e observações.</p>
        </div>
      </div>

      <div class="field-grid cols-1">
        <label class="field">Requisitos
          <textarea formControlName="requisitos" rows="4" placeholder="Liste os requisitos essenciais"></textarea>
        </label>
      <label class="field">Descricao *
          <textarea formControlName="descricao" rows="4" placeholder="Descreva a vaga"></textarea>
        </label>
        <label class="field">Outras observações
          <textarea formControlName="observacoes" rows="3" placeholder="Detalhes adicionais"></textarea>
        </label>
      </div>
    </section>

    <section class="tab-card" *ngIf="activeTab === 'encaminhamentos'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[3].label }}</p>
          <p class="muted">Inclua e acompanhe os encaminhamentos para beneficiarios.</p>
        </div>
      </div>

      <div class="encaminhamento-shell">
        <form [formGroup]="encaminhamentoForm" class="encaminhamento-form" (ngSubmit)="addEncaminhamento()">
          <div class="field-grid cols-2 narrow">
            <label class="field full">Buscar beneficiario *
              <input type="text" [formControl]="beneficiarioPesquisa" placeholder="Digite para buscar" />
            </label>
            <label class="field full">Beneficiario selecionado *
              <input type="text" formControlName="beneficiarioNome" placeholder="Escolha na busca" readonly />
            </label>
            <label class="field">Data de encaminhamento *
              <input type="date" formControlName="data" />
            </label>
            <label class="field">Status *
              <input type="text" formControlName="status" />
            </label>
            <label class="field full">Observações
              <textarea formControlName="observacoes" rows="2" placeholder="Notas do encaminhamento"></textarea>
            </label>
          </div>
          <div class="encaminhamento-actions">
            <div class="beneficiario-results" *ngIf="beneficiarios.length || beneficiarioErro">
              <p class="muted">Resultados:</p>
              <div class="result-list">
                <button
                  type="button"
                  class="result-item"
                  *ngFor="let beneficiario of beneficiarios"
                  (click)="selectBeneficiario(beneficiario)"
                >
                  <span class="result-item__name">{{ beneficiario.nome_completo }}</span>
                  <span class="result-item__doc" *ngIf="beneficiario.cpf">CPF: {{ beneficiario.cpf }}</span>
                </button>
              </div>
              <p class="text-error" *ngIf="beneficiarioErro">{{ beneficiarioErro }}</p>
            </div>
            <button class="nav-button" type="submit">Adicionar encaminhamento</button>
          </div>
        </form>

        <div class="table-card">
          <div class="table-card__header">
            <p>Encaminhamentos da vaga</p>
            <span class="muted">Total: {{ encaminhamentos.length }}</span>
          </div>
          <div class="table-card__table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Beneficiario</th>
                  <th>Data</th>
                  <th>Status</th>
                  <th>Observações</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngIf="!encaminhamentos.length">
                  <td colspan="5" class="muted">Nenhum encaminhamento adicionado.</td>
                </tr>
                <tr *ngFor="let item of encaminhamentos">
                  <td>{{ item.beneficiarioNome }}</td>
                  <td>{{ item.data }}</td>
                  <td>{{ item.status }}</td>
                  <td>{{ item.observacoes || 'Ã¢Â€Â”' }}</td>
                  <td>
                    <button type="button" class="nav-button nav-button--danger" (click)="removeEncaminhamento(item.id)">Remover</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </form>

  <section class="tab-card" *ngIf="activeTab === 'candidatos'">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">{{ tabs[4].label }}</p>
        <p class="muted">Cadastre beneficiarios interessados em vagas.</p>
      </div>
    </div>

    <div class="encaminhamento-shell">
      <form [formGroup]="formularioCandidato" class="encaminhamento-form" (ngSubmit)="adicionarCandidato()">
        <div class="field-grid cols-2 narrow">
          <label class="field full">Buscar beneficiario *
            <input type="text" [formControl]="pesquisaCandidato" placeholder="Digite para buscar" />
          </label>
          <label class="field full">Beneficiario selecionado *
            <input type="text" formControlName="beneficiarioNome" placeholder="Escolha na busca" readonly />
          </label>
          <label class="field full">Necessidades profissionais *
            <textarea formControlName="necessidadesProfissionais" rows="3" placeholder="Informe os interesses e necessidades"></textarea>
          </label>
          <label class="field">Status *
            <select formControlName="status">
              <option value="EM_ANALISE">Em analise</option>
              <option value="EM_ANDAMENTO">Em andamento</option>
              <option value="ENCAMINHADO">Encaminhado</option>
              <option value="CONTRATADO">Contratado</option>
              <option value="NAO_APROVADO">Não aprovado</option>
            </select>
          </label>
          <label class="field full">Curriculo (PDF ou DOC) *
            <input type="file" (change)="onCurriculoSelecionado($event)" />
            <span class="muted" *ngIf="curriculoNome">Arquivo: {{ curriculoNome }}</span>
          </label>
        </div>
        <div class="encaminhamento-actions">
          <div class="beneficiario-results" *ngIf="resultadosCandidatos.length || candidatoErro">
            <p class="muted">Resultados:</p>
            <div class="result-list">
              <button
                type="button"
                class="result-item"
                *ngFor="let beneficiario of resultadosCandidatos"
                (click)="selecionarCandidato(beneficiario)"
              >
                <span class="result-item__name">{{ beneficiario.nome_completo }}</span>
                <span class="result-item__doc" *ngIf="beneficiario.cpf">CPF: {{ beneficiario.cpf }}</span>
              </button>
            </div>
            <p class="text-error" *ngIf="candidatoErro">{{ candidatoErro }}</p>
          </div>
          <button class="nav-button" type="submit">Adicionar candidato</button>
        </div>
      </form>

      <div class="table-card">
        <div class="table-card__header">
          <p>Candidatos da vaga</p>
          <span class="muted">Total: {{ candidatos.length }}</span>
        </div>
        <div class="listing-filters">
          <label class="field">
            <span class="muted">Pesquisar</span>
            <input type="text" [formControl]="filtroCandidatoNome" placeholder="Nome do beneficiario" />
          </label>
          <label class="field">
            <span class="muted">Status</span>
            <select [formControl]="filtroCandidatoStatus">
              <option value="todos">Todos</option>
              <option value="EM_ANALISE">Em analise</option>
              <option value="EM_ANDAMENTO">Em andamento</option>
              <option value="ENCAMINHADO">Encaminhado</option>
              <option value="CONTRATADO">Contratado</option>
              <option value="NAO_APROVADO">Não aprovado</option>
            </select>
          </label>
          <label class="field">
            <span class="muted">Data</span>
            <input type="date" [formControl]="filtroCandidatoData" />
          </label>
        </div>
        <div class="table-card__table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Beneficiario</th>
                <th>Necessidades</th>
                <th>Curriculo</th>
                <th>Status</th>
                <th>Data</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="!candidatosFiltrados.length">
                <td colspan="6" class="muted">Nenhum candidato cadastrado.</td>
              </tr>
              <tr *ngFor="let item of candidatosFiltrados">
                <td>{{ item.beneficiarioNome }}</td>
                <td>{{ item.necessidadesProfissionais || '---' }}</td>
                <td>
                  <button
                    type="button"
                    class="nav-button"
                    (click)="baixarCurriculo(item)"
                    [disabled]="!item.curriculoConteudo"
                  >
                    {{ item.curriculoNome || 'Sem arquivo' }}
                  </button>
                </td>
                <td>{{ item.status || '---' }}</td>
                <td>{{ item.criadoEm || '---' }}</td>
                <td>
                  <button type="button" class="nav-button nav-button--danger" (click)="removerCandidato(item.id)">Remover</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <section class="tab-card" *ngIf="activeTab === 'listagemVagas'">
    <div class="listing-card">
    <div class="listing-card__header">
      <div>
        <p class="tab-card__highlight">Listagem de vagas</p>
        <p class="muted">Todas as vagas cadastradas aparecem aqui.</p>
      </div>
      <div class="listing-filters">
        <label class="field">
          <span class="muted">Pesquisar</span>
          <input type="text" [formControl]="listSearch" placeholder="Titulo, empresa ou cidade" />
        </label>
        <label class="field">
          <span class="muted">Status</span>
          <select [formControl]="statusFilter">
            <option value="todos">Todos</option>
            <option value="Aberta">Aberta</option>
            <option value="Em andamento">Em andamento</option>
            <option value="Encerrada">Encerrada</option>
          </select>
        </label>
      </div>
    </div>

    <div class="listing-grid" *ngIf="!listLoading; else loadingList">
      <article class="vaga-card" *ngFor="let record of filteredRecords">
        <header class="vaga-card__header">
          <div>
            <p class="vaga-card__title">{{ record.dadosVaga.titulo }}</p>
            <p class="muted">{{ record.empresaLocal?.nomeEmpresa }} Ã¢Â€Â¢ {{ record.empresaLocal?.cidade }}</p>
          </div>
          <span class="status-pill" [class.status-pill--open]="record.dadosVaga.status === 'Aberta'" [class.status-pill--progress]="record.dadosVaga.status === 'Pausada'" [class.status-pill--closed]="record.dadosVaga.status === 'Encerrada'">
            {{ record.dadosVaga.status }}
          </span>
        </header>
        <p class="vaga-card__description">{{ record.requisitos?.descricao }}</p>
        <dl class="vaga-card__meta">
          <div>
            <dt>Aberta em</dt>
            <dd>{{ record.criadoEm || 'Ã¢Â€Â”' }}</dd>
          </div>
          <div>
            <dt>Contrato</dt>
            <dd>{{ record.dadosVaga.tipo || 'Ã¢Â€Â”' }}</dd>
          </div>
          <div>
            <dt>Salario</dt>
            <dd>{{ record.dadosVaga.salario || 'Ã¢Â€Â”' }}</dd>
          </div>
        </dl>
        <div class="vaga-card__actions">
          <button type="button" class="nav-button" (click)="editRecord(record)">Editar</button>
          <button type="button" class="nav-button nav-button--danger" (click)="deleteRecord(record)" [disabled]="deletingId === record.id">
            {{ deletingId === record.id ? 'Removendo...' : 'Excluir' }}
          </button>
        </div>
      </article>
      <p class="muted" *ngIf="!filteredRecords.length">Nenhuma vaga encontrada com os filtros atuais.</p>
    </div>
    <ng-template #loadingList>
      <p class="muted">Carregando vagas...</p>
    </ng-template>
    </div>
  </section>
</section>

<app-dialog
  [aberto]="dialogConfirmacaoAberta"
  [titulo]="dialogTitulo"
  [mensagem]="dialogMensagem"
  [confirmarLabel]="dialogConfirmarLabel"
  [cancelarLabel]="dialogCancelarLabel"
  (confirmar)="confirmarDialogo()"
  (cancelar)="cancelarDialogo()"
></app-dialog>
</app-tela-padrao>




