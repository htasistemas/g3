<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  [fullWidth]="true"
  (buscar)="buscarBeneficiariosNaListagem()"
  (salvar)="onSave()"
  (excluir)="handleDeleteSelected()"
  (novo)="startNewBeneficiario()"
  (cancelar)="startNewBeneficiario()"
  (imprimir)="onPrint()"
  (fechar)="closeForm()"
>
<header class="page-title page-title--row" slot="titulo">
  <div>
    <p class="page-title__label"></p>
  </div>
</header>

  <section class="cadastro">
  <ng-template #gestaoRapida>
    <section class="list-panel">
      <div class="list-panel__header">
        <div>
          <p class="list-panel__eyebrow">Gestão rápida</p>
          <h2>Busque Beneficiários cadastrados</h2>
          <p>Localize pelo nome, CPF, data de nascimento ou Código e utilize os atalhos para navegar pelas ações.</p>
        </div>
        <div class="list-panel__actions">
          <button type="button" class="ghost" (click)="clearSearchFilters()">Limpar filtros</button>
          <button type="button" class="primary" (click)="buscarBeneficiariosNaListagem()">Buscar</button>
        </div>
      </div>

      <div class="list-panel__navigation" aria-label="ações rápidas para o cadastro">
        <button type="button" class="primary" (click)="startNewBeneficiario()">Incluir</button>
        <button type="button" class="ghost" [disabled]="!selectedBeneficiary" (click)="handleEditSelected()">
          Editar
        </button>
        <button type="button" class="ghost" [disabled]="!selectedBeneficiary" (click)="handleAlterSelected()">
          Alterar
        </button>
        <button
          type="button"
          class="danger"
          [disabled]="!selectedBeneficiary"
          (click)="handleDeleteSelected()"
        >
          Excluir
        </button>
      </div>

      <form [formGroup]="searchForm" class="list-panel__filters" (ngSubmit)="searchBeneficiaries()">
        <label class="field field-codigo">
          Código
          <input type="text" formControlName="codigo" placeholder="Ex.: 0001" />
        </label>
        <label class="field">
          Nome ou apelido
          <input type="text" formControlName="nome" placeholder="Digite parte do nome" />
        </label>
        <label class="field">
          Data de nascimento
          <input type="date" formControlName="data_nascimento" />
        </label>
        <label class="field">
          CPF
          <input type="text" formControlName="cpf" placeholder="Somente números" />
        </label>
        <label class="field">
          Status
          <select formControlName="status">
            <option value="">Todos</option>
            <option *ngFor="let option of statusOptions" [value]="option">{{ formatStatusLabel(option) }}</option>
          </select>
        </label>
        <div class="list-panel__filter-actions">
          <button type="button" class="primary" (click)="triggerSearchFromUi()">Aplicar filtros</button>
        </div>
      </form>

      <div *ngIf="listError" class="feedback">
        <span>{{ listError }}</span>
        <button type="button" class="feedback__close" (click)="dismissListError()" aria-label="Fechar aviso">&times;</button>
      </div>
      <div *ngIf="listLoading" class="list-panel__loading">Carregando Beneficiários...</div>

      <div class="list-panel__table" *ngIf="!listLoading">
        <table>
          <thead>
            <tr>
              <th>Nome</th>
              <th>Código</th>
              <th>CPF</th>
              <th>Nascimento</th>
              <th>Status</th>
              <th class="text-right">ações</th>
            </tr>
          </thead>
          <tbody *ngIf="beneficiariosPaginados.length; else emptyList">
            <tr *ngFor="let beneficiario of beneficiariosPaginados" (dblclick)="onBeneficiarioSelected(beneficiario)">
              <td>{{ formatarNomeListagem(beneficiario) }}</td>
              <td>{{ beneficiario.codigo || '---' }}</td>
              <td>{{ beneficiario.cpf || beneficiario.nis || '---' }}</td>
              <td>{{ formatarDataNascimentoListagem(beneficiario.data_nascimento) }}</td>
              <td><span [ngClass]="getStatusClass(beneficiario.status)">{{ formatStatusLabel(beneficiario.status) }}</span></td>
              <td class="text-right actions">
                <button type="button" class="danger" (click)="deleteBeneficiario(beneficiario)">Excluir</button>
              </td>
            </tr>
          </tbody>
        </table>
        <ng-template #emptyList>
          <tbody>
            <tr>
              <td colspan="6" class="list-panel__empty">Nenhum Beneficiário encontrado com os filtros informados.</td>
            </tr>
          </tbody>
        </ng-template>
      </div>
      <div class="unit-list__pagination" *ngIf="filteredBeneficiarios.length && beneficiariosPaginados.length">
        <span class="unit-list__total">
          Total: {{ filteredBeneficiarios.length }} Beneficiários
        </span>
        <button type="button" class="btn-outline" (click)="paginaAnterior()" [disabled]="paginaAtual === 1">
          Anterior
        </button>
        <span class="unit-list__page">
          Página {{ paginaAtual }} de {{ totalPaginas }}
        </span>
        <button type="button" class="btn-outline" (click)="proximaPagina()" [disabled]="paginaAtual >= totalPaginas">
          Próximo
        </button>
      </div>
    </section>
  </ng-template>

  <div class="cadastro-layout">
    <aside class="cadastro-menu">
      <div class="tab-shell">
        <p class="tab-shell__title tab-shell__title--destaque">
          <fa-icon [icon]="faUsers" class="tab-shell__icon"></fa-icon>
          cadastros de Beneficiários
        </p>
        <ol class="step-tabs" role="tablist">
          <li
            *ngFor="let tab of tabs; index as idx"
            class="step-tabs__item"
            [class.active]="activeTab === tab.id"
            [class.completed]="idx < activeTabIndex"
          >
            <button
              class="step-tabs__button"
              type="button"
              role="tab"
              [attr.aria-selected]="activeTab === tab.id"
              (click)="changeTab(tab.id)"
            >
              <span class="step-tabs__index">{{ idx + 1 }}</span>
              <span class="step-tabs__label">{{ tab.label }}</span>
            </button>
          </li>
        </ol>
      </div>
    </aside>

    <div class="cadastro-conteudo">
      <form [formGroup]="form" (ngSubmit)="submit()" class="form-shell">
    <app-popup-messages [mensagens]="popupErros" (fechar)="fecharPopupErros()"></app-popup-messages>

    <div *ngIf="feedback" class="feedback">
      <span>{{ feedback }}</span>
      <button type="button" class="feedback__close" (click)="dismissFeedback()" aria-label="Fechar aviso">&times;</button>
    </div>

    <ng-template #navigationControls>
      <div class="tab-actions">
        <button
          type="button"
          class="ghost"
          *ngIf="beneficiarioId || selectedBeneficiary?.id_beneficiario"
          (click)="abrirProntuario()"
          [disabled]="uploadingDocuments"
        >
          Abrir Prontuário
        </button>
        <button
          type="button"
          class="ghost"
          *ngIf="hasPreviousTab"
          (click)="goToPreviousTab()"
          [disabled]="uploadingDocuments"
        >
          Voltar
        </button>
        <button
          type="button"
          class="primary"
          *ngIf="hasNextTab"
          (click)="goToNextTab()"
          [disabled]="uploadingDocuments"
        >
          Próximo: {{ nextTabLabel }}
        </button>
        <button type="submit" class="primary" [disabled]="saving || uploadingDocuments" *ngIf="!hasNextTab">
          {{ saving ? 'Salvando...' : uploadingDocuments ? 'Aguardando envios' : 'Salvar cadastro' }}
        </button>
      </div>
    </ng-template>

    <div class="tab-card" *ngIf="activeTab === 'dados'">
      <div class="tab-card__header tab-card__header--listagem">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('dados') }}</p>
        </div>
      </div>
      <div class="tab-card__hero" [class.tab-card__hero--camera]="cameraActive">
        <div class="photo-section">
          <div class="photo-preview" [class.photo-preview--empty]="!photoPreview">
            <img *ngIf="photoPreview" [src]="photoPreview" alt="Foto 3x4 do beneficiario" />
            <span *ngIf="!photoPreview">Foto 3x4 do Beneficiário</span>
          </div>
          <div class="photo-actions">
            <label class="upload-btn">
              Enviar foto 3x4
              <input type="file" accept="image/*" (change)="onPhotoSelected($event)" />
            </label>
            <button type="button" class="ghost" (click)="handleCameraCapture()">
              {{ cameraActive ? 'Registrar foto' : 'Capturar pela câmera' }}
            </button>
            <button type="button" class="ghost" *ngIf="photoPreview" (click)="removePhoto()">Remover foto</button>
            <button type="button" class="ghost" *ngIf="cameraActive" (click)="stopCamera()">Fechar câmera</button>
            <p class="photo-hint">Aceite arquivos enviados ou registre uma nova foto pela webcam.</p>
            <p *ngIf="captureError" class="field-error">{{ captureError }}</p>
          </div>
        </div>

        <div class="camera-panel" *ngIf="cameraActive">
          <p class="camera-panel__title">Visualização da câmera</p>
          <div class="camera-panel__preview">
            <video #videoElement autoplay muted playsinline></video>
          </div>
          <p class="camera-panel__hint">Ajuste o enquadramento e clique em "Registrar foto" para salvar.</p>
        </div>

        <div class="status-panel">
          <p class="status-panel__title">Status do Beneficiário</p>
          <div class="status-panel__current">
            <span [ngClass]="getStatusClass(form.get('status')?.value)">{{ formatStatusLabel(form.get('status')?.value) }}</span>
            <span class="status-panel__reason" *ngIf="form.get('motivo_bloqueio')?.value">
              Motivo: {{ form.get('motivo_bloqueio')?.value }}
            </span>
          </div>
          <label class="field">
            <span>Atualizar status*</span>
            <select formControlName="status">
              <option *ngFor="let option of statusOptions" [value]="option">{{ formatStatusLabel(option) }}</option>
            </select>
          </label>          <button type="button" class="ghost" *ngIf="form.get('status')?.value === 'BLOQUEADO'" (click)="blockReasonModalOpen = true">
            Editar motivo do bloqueio
          </button>
        </div>
      </div>
      <canvas #canvasElement class="capture-canvas"></canvas>
      <div class="field-grid cols-3 dados-grid" formGroupName="dadosPessoais">
        <label class="field field-matricula">Código
          <input [value]="beneficiaryCode || nextSequentialCode" readonly />
        </label>
        <label class="field field-nome-completo">Nome*<input formControlName="nome_completo" placeholder="Digite o nome completo" /></label>

        <label class="field field-social">Nome social<input formControlName="nome_social" placeholder="Se houver" /></label>
        <label class="field field-apelido">Apelido<input formControlName="apelido" placeholder="Como prefere ser chamado" /></label>
        <label class="field field-sexo">Sexo biológico<select formControlName="sexo_biologico">
            <option value="">Selecione</option>
            <option value="MASCULINO">Masculino</option>
            <option value="FEMININO">Feminino</option>
            <option value="OUTRO">Outro</option>
          </select></label>
        <label class="field field-identidade">Identidade de gênero<select formControlName="identidade_genero">
            <option value="">Selecione</option>
            <option *ngFor="let option of genderIdentityOptions" [value]="option">{{ option }}</option>
          </select></label>

        <label class="field field-cor">Cor/Raça<select formControlName="cor_raca">
            <option value=""></option>
            <option value="BRANCA">Branca</option>
            <option value="PRETA">Preta</option>
            <option value="PARDA">Parda</option>
            <option value="AMARELA">Amarela</option>
            <option value="INDIGENA">Indígena</option>
            <option value="NAO_INFORMADO">Não informado</option>
          </select></label>
        <div class="field date-field field-nascimento">
          <label class="field">Data de nascimento*
            <div class="date-age-row">
              <input type="date" formControlName="data_nascimento" />
              <span class="age-badge" *ngIf="beneficiaryAge !== null">{{ beneficiaryAge }} anos</span>
            </div>
          </label>
        </div>
        <label class="field field-estado-civil">Estado civil<select formControlName="estado_civil">
            <option value=""></option>
            <option *ngFor="let option of maritalStatusOptions" [value]="option">{{ option }}</option>
          </select></label>
        <label class="field field-nacionalidade">Nacionalidade<select formControlName="nacionalidade">
            <option value=""></option>
            <option *ngFor="let option of nationalityOptions" [value]="option">{{ option }}</option>
          </select></label>

        <label class="field field-naturalidade">Naturalidade (cidade)<input formControlName="naturalidade_cidade" /></label>
        <label class="field field-uf">Estado<select formControlName="naturalidade_uf">
            <option value="">Selecione o estado</option>
            <option *ngFor="let uf of brazilianStates" [value]="uf">{{ uf }}</option>
          </select></label>

        <label class="field field-mae">Nome da mae*<input formControlName="nome_mae" /></label>
        <label class="field field-pai">Nome do pai<input formControlName="nome_pai" /></label>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
  </div>

    <div class="tab-card" *ngIf="activeTab === 'endereco'" formGroupName="endereco">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('endereco') }}</p>
          <p class="muted">Localização completa para correspondências e visitas.</p>
        </div>
        <div class="tab-card__header-actions">
          <button type="button" class="btn-outline" (click)="abrirMapaEndereco()">Ver no Google Maps</button>
        </div>
</div>
      <div class="field-grid cols-3 endereco-grid">
        <label class="field field-cep">CEP*<input formControlName="cep" placeholder="00000-000" (input)="onCepInput($event)" (blur)="onCepBlur()" />
          <p class="field-error" *ngIf="form.get(['endereco', 'cep'])?.invalid && form.get(['endereco', 'cep'])?.touched">
            Informe um CEP válido com 8 dígitos.</p>
          <p class="field-error" *ngIf="cepLookupError">{{ cepLookupError }}</p>
        </label>
        <label class="field field-logradouro">Endereço<input formControlName="logradouro" /></label>
        <label class="field field-numero">Número<input formControlName="numero" /></label>
        <label class="field field-complemento">Complemento<input formControlName="complemento" /></label>
        <label class="field field-bairro">Bairro<input formControlName="bairro" /></label>
        <label class="field field-ponto">Ponto de referência<input formControlName="ponto_referencia" /></label>
        <label class="field field-municipio">Município<input formControlName="municipio" /></label>
        <label class="field field-zona">Zona<select formControlName="zona">
            <option value="URBANA">Urbana</option>
            <option value="RURAL">Rural</option>
          </select></label>
        <label class="field field-subzona">Subzona<select formControlName="subzona">
            <option value="">Selecione...</option>
            <option value="ZONA NORTE">Zona Norte</option>
            <option value="ZONA SUL">Zona Sul</option>
            <option value="ZONA LESTE">Zona Leste</option>
            <option value="ZONA OESTE">Zona Oeste</option>
            <option value="ZONA CENTRAL">Zona Central</option>
          </select></label>
        <label class="field field-uf-endereco">Estado<input maxlength="2" formControlName="uf" /></label>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'contato'" formGroupName="contato">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('contato') }}</p>
          <p class="muted">Localização completa para correspondências e visitas.</p>
        </div>
      </div>
        <div class="field-grid cols-2">
          <label class="field">
            <span>Telefone principal*</span>
            <div class="contact-row">
              <input
                formControlName="telefone_principal"
                placeholder="(00) 00000-0000"
                (input)="onPhoneInput($event, 'telefone_principal')"
              />
              <div
                class="contact-actions"
                *ngIf="
                  form.get(['contato', 'permite_contato_tel'])?.value ||
                  form.get(['contato', 'permite_contato_whatsapp'])?.value ||
                  form.get(['contato', 'permite_contato_sms'])?.value
                "
              >
                <button
                  type="button"
                  class="contact-actions__button"
                  *ngIf="form.get(['contato', 'permite_contato_tel'])?.value"
                  (click)="startCall('telefone_principal')"
                  [disabled]="!hasPhoneValue('telefone_principal')"
                  aria-label="Ligar para telefone principal"
                  title="Ligar"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.02-.24 11.72 11.72 0 003.68.59 1 1 0 011 1v3.5a1 1 0 01-1 1A17.5 17.5 0 012.5 3a1 1 0 011-1H7a1 1 0 011 1 11.72 11.72 0 00.59 3.68 1 1 0 01-.24 1.02l-2.2 2.09z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
                <button
                  type="button"
                  class="contact-actions__button contact-actions__button--whatsapp"
                  *ngIf="form.get(['contato', 'permite_contato_whatsapp'])?.value"
                  (click)="openWhatsapp('telefone_principal')"
                  [disabled]="!hasPhoneValue('telefone_principal')"
                  aria-label="Abrir WhatsApp para telefone principal"
                  title="WhatsApp"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M12 2.25a9.75 9.75 0 00-8.51 14.48L2.2 21.8a.75.75 0 001 .93l5.08-1.74A9.75 9.75 0 1012 2.25zm0 1.5a8.25 8.25 0 110 16.5 8.18 8.18 0 01-3.74-.9l-.26-.13-3.05 1.04 1.03-2.88-.14-.24A8.25 8.25 0 0112 3.75zm-3.02 3.5c-.14 0-.35.05-.54.21-.22.18-.71.69-.71 1.68 0 1 .73 1.96.83 2.1.1.14 1.43 2.28 3.53 3.22 1.79.79 2.15.72 2.54.67.39-.05 1.26-.51 1.44-1 .18-.49.18-.91.13-1-.05-.09-.2-.15-.42-.26-.22-.1-1.3-.64-1.5-.71-.2-.08-.35-.11-.5.11-.15.23-.58.71-.72.86-.14.15-.27.17-.5.06-.23-.11-.97-.36-1.86-1.14a6.37 6.37 0 01-1.18-1.47c-.13-.22 0-.33.1-.44.1-.11.23-.27.35-.4.12-.13.15-.22.23-.36.08-.14.04-.26-.02-.36-.06-.1-.5-1.22-.69-1.68-.18-.44-.36-.38-.5-.39z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
                <button
                  type="button"
                  class="contact-actions__button contact-actions__button--sms"
                  *ngIf="form.get(['contato', 'permite_contato_sms'])?.value"
                  (click)="sendSms('telefone_principal')"
                  [disabled]="!hasPhoneValue('telefone_principal')"
                  aria-label="Enviar SMS para telefone principal"
                  title="SMS"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M4 4h16a1 1 0 011 1v10a1 1 0 01-1 1H8.41L5 19.92V16H4a1 1 0 01-1-1V5a1 1 0 011-1zm1 2v8h1a1 1 0 011 1v1.38L9.62 15H19V6H5zm3 2h8a1 1 0 110 2H8a1 1 0 110-2zm0 3h5a1 1 0 110 2H8a1 1 0 110-2z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
              </div>
            </div>
            <p class="field-error" *ngIf="form.get(['contato', 'telefone_principal'])?.invalid && form.get(['contato', 'telefone_principal'])?.touched">
              Informe o telefone principal.
            </p>
          </label>
          <label class="field">
            <span>Telefone secundario</span>
            <div class="contact-row">
              <input
                formControlName="telefone_secundario"
                placeholder="(00) 00000-0000"
                (input)="onPhoneInput($event, 'telefone_secundario')"
              />
              <div
                class="contact-actions"
                *ngIf="
                  form.get(['contato', 'permite_contato_tel'])?.value ||
                  form.get(['contato', 'permite_contato_whatsapp'])?.value ||
                  form.get(['contato', 'permite_contato_sms'])?.value
                "
              >
                <button
                  type="button"
                  class="contact-actions__button"
                  *ngIf="form.get(['contato', 'permite_contato_tel'])?.value"
                  (click)="startCall('telefone_secundario')"
                  [disabled]="!hasPhoneValue('telefone_secundario')"
                  aria-label="Ligar para telefone secundario"
                  title="Ligar"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.02-.24 11.72 11.72 0 003.68.59 1 1 0 011 1v3.5a1 1 0 01-1 1A17.5 17.5 0 012.5 3a1 1 0 011-1H7a1 1 0 011 1 11.72 11.72 0 00.59 3.68 1 1 0 01-.24 1.02l-2.2 2.09z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
                <button
                  type="button"
                  class="contact-actions__button contact-actions__button--whatsapp"
                  *ngIf="form.get(['contato', 'permite_contato_whatsapp'])?.value"
                  (click)="openWhatsapp('telefone_secundario')"
                  [disabled]="!hasPhoneValue('telefone_secundario')"
                  aria-label="Abrir WhatsApp para telefone secundario"
                  title="WhatsApp"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M12 2.25a9.75 9.75 0 00-8.51 14.48L2.2 21.8a.75.75 0 001 .93l5.08-1.74A9.75 9.75 0 1012 2.25zm0 1.5a8.25 8.25 0 110 16.5 8.18 8.18 0 01-3.74-.9l-.26-.13-3.05 1.04 1.03-2.88-.14-.24A8.25 8.25 0 0112 3.75zm-3.02 3.5c-.14 0-.35.05-.54.21-.22.18-.71.69-.71 1.68 0 1 .73 1.96.83 2.1.1.14 1.43 2.28 3.53 3.22 1.79.79 2.15.72 2.54.67.39-.05 1.26-.51 1.44-1 .18-.49.18-.91.13-1-.05-.09-.2-.15-.42-.26-.22-.1-1.3-.64-1.5-.71-.2-.08-.35-.11-.5.11-.15.23-.58.71-.72.86-.14.15-.27.17-.5.06-.23-.11-.97-.36-1.86-1.14a6.37 6.37 0 01-1.18-1.47c-.13-.22 0-.33.1-.44.1-.11.23-.27.35-.4.12-.13.15-.22.23-.36.08-.14.04-.26-.02-.36-.06-.1-.5-1.22-.69-1.68-.18-.44-.36-.38-.5-.39z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
                <button
                  type="button"
                  class="contact-actions__button contact-actions__button--sms"
                  *ngIf="form.get(['contato', 'permite_contato_sms'])?.value"
                  (click)="sendSms('telefone_secundario')"
                  [disabled]="!hasPhoneValue('telefone_secundario')"
                  aria-label="Enviar SMS para telefone secundario"
                  title="SMS"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M4 4h16a1 1 0 011 1v10a1 1 0 01-1 1H8.41L5 19.92V16H4a1 1 0 01-1-1V5a1 1 0 011-1zm1 2v8h1a1 1 0 011 1v1.38L9.62 15H19V6H5zm3 2h8a1 1 0 110 2H8a1 1 0 110-2zm0 3h5a1 1 0 110 2H8a1 1 0 110-2z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </label>
          <label class="checkbox-field"><input type="checkbox" formControlName="telefone_principal_whatsapp" /> <span>Telefone principal tem WhatsApp</span></label>
          <label class="field">Nome para recado<input formControlName="telefone_recado_nome" /></label>
          <label class="field">
            <span>Telefone para recado</span>
            <div class="contact-row">
              <input
                formControlName="telefone_recado_numero"
                placeholder="(00) 00000-0000"
                (input)="onPhoneInput($event, 'telefone_recado_numero')"
              />
              <div
                class="contact-actions"
                *ngIf="
                  form.get(['contato', 'permite_contato_tel'])?.value ||
                  form.get(['contato', 'permite_contato_whatsapp'])?.value
                "
              >
                <button
                  type="button"
                  class="contact-actions__button"
                  *ngIf="form.get(['contato', 'permite_contato_tel'])?.value"
                  (click)="startCall('telefone_recado_numero')"
                  [disabled]="!hasPhoneValue('telefone_recado_numero')"
                  aria-label="Ligar para telefone de recado"
                  title="Ligar"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.02-.24 11.72 11.72 0 003.68.59 1 1 0 011 1v3.5a1 1 0 01-1 1A17.5 17.5 0 012.5 3a1 1 0 011-1H7a1 1 0 011 1 11.72 11.72 0 00.59 3.68 1 1 0 01-.24 1.02l-2.2 2.09z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
                <button
                  type="button"
                  class="contact-actions__button contact-actions__button--whatsapp"
                  *ngIf="form.get(['contato', 'permite_contato_whatsapp'])?.value"
                  (click)="openWhatsapp('telefone_recado_numero')"
                  [disabled]="!hasPhoneValue('telefone_recado_numero')"
                  aria-label="Abrir WhatsApp para telefone de recado"
                  title="WhatsApp"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M12 2.25a9.75 9.75 0 00-8.51 14.48L2.2 21.8a.75.75 0 001 .93l5.08-1.74A9.75 9.75 0 1012 2.25zm0 1.5a8.25 8.25 0 110 16.5 8.18 8.18 0 01-3.74-.9l-.26-.13-3.05 1.04 1.03-2.88-.14-.24A8.25 8.25 0 0112 3.75zm-3.02 3.5c-.14 0-.35.05-.54.21-.22.18-.71.69-.71 1.68 0 1 .73 1.96.83 2.1.1.14 1.43 2.28 3.53 3.22 1.79.79 2.15.72 2.54.67.39-.05 1.26-.51 1.44-1 .18-.49.18-.91.13-1-.05-.09-.2-.15-.42-.26-.22-.1-1.3-.64-1.5-.71-.2-.08-.35-.11-.5.11-.15.23-.58.71-.72.86-.14.15-.27.17-.5.06-.23-.11-.97-.36-1.86-1.14a6.37 6.37 0 01-1.18-1.47c-.13-.22 0-.33.1-.44.1-.11.23-.27.35-.4.12-.13.15-.22.23-.36.08-.14.04-.26-.02-.36-.06-.1-.5-1.22-.69-1.68-.18-.44-.36-.38-.5-.39z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </label>
          <label class="field">
            <span>Email</span>
            <div class="contact-row">
              <input type="email" formControlName="email" />
              <div class="contact-actions" *ngIf="form.get(['contato', 'permite_contato_email'])?.value">
                <button
                  type="button"
                  class="contact-actions__button contact-actions__button--email"
                  (click)="openEmailClient()"
                  [disabled]="!form.get(['contato', 'email'])?.value"
                  aria-label="Abrir cliente de e-mail"
                  title="E-mail"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M4 5h16a1 1 0 011 1v12a1 1 0 01-1 1H4a1 1 0 01-1-1V6a1 1 0 011-1zm1.25 2l6.25 4.35L17.75 7H5.25zM19 17V9.74l-7.09 4.94a1 1 0 01-1.14 0L3 9.74V17h16z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
              </div>
            </div>
            <p class="field-error" *ngIf="form.get(['contato', 'email'])?.invalid && form.get(['contato', 'email'])?.touched">
              Informe um e-mail válido.
            </p>
          </label>
          <label class="field">Horario preferêncial<select formControlName="horario_preferencial_contato">
              <option value="">Selecione um horario</option>
              <option *ngFor="let option of preferredContactOptions" [value]="option.value">{{ option.label }}</option>
            </select></label>
          <div class="feature-grid">
            <label class="checkbox-field"><input type="checkbox" formControlName="permite_contato_tel" /> <span>Permite contato telefonico</span></label>
            <label class="checkbox-field"><input type="checkbox" formControlName="permite_contato_whatsapp" /> <span>Permite WhatsApp</span></label>
            <label class="checkbox-field"><input type="checkbox" formControlName="permite_contato_sms" /> <span>Permite SMS</span></label>
            <label class="checkbox-field"><input type="checkbox" formControlName="permite_contato_email" /> <span>Permite e-mail</span></label>
          </div>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'documentos'" formGroupName="documentos">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('documentos') }}</p>
          <p class="muted">Localização completa para correspondências e visitas.</p>
        </div>
      </div>
      <div class="field-grid cols-3">
        <label class="field">CPF*<input formControlName="cpf" (input)="onCpfInput($event)" />
          <p class="field-error" *ngIf="form.get(['documentos', 'cpf'])?.invalid && form.get(['documentos', 'cpf'])?.touched">
            Informe um CPF válido.
          </p>
        </label>
        <label class="field">RG Número<input formControlName="rg_numero" /></label>
        <label class="field">Orgao emissor<input formControlName="rg_orgao_emissor" /></label>
        <label class="field">Estado<input maxlength="2" formControlName="rg_uf" /></label>
        <label class="field">Data emissao<input type="date" formControlName="rg_data_emissao" /></label>
        <label class="field">NIS<input formControlName="nis" /></label>
        <label class="field">Certidao tipo<input formControlName="certidao_tipo" /></label>
        <label class="field">Livro<input formControlName="certidao_livro" /></label>
        <label class="field">Folha<input formControlName="certidao_folha" /></label>
        <label class="field">Termo<input formControlName="certidao_termo" /></label>
        <label class="field">Cartorio<input formControlName="certidao_cartorio" /></label>
        <label class="field">Município<input formControlName="certidao_municipio" /></label>
        <label class="field">Estado<input maxlength="2" formControlName="certidao_uf" /></label>
        <label class="field">Titulo de eleitor<input formControlName="titulo_eleitor" /></label>
        <label class="field">CNH<input formControlName="cnh" /></label>
        <label class="field">Cartao SUS<input formControlName="cartao_sus" /></label>
      </div>
      <div class="document-section" formArrayName="anexos">
        <div class="document-request">
          <div class="document-request__header">
            <div>
              <p class="document-request__title">Envio de documentos</p>
              <p class="document-request__subtitle">Selecione o tipo de documento, anexe o arquivo e visualize na listagem.</p>
            </div>
          </div>
          <p class="document-count document-count--top">
            Documentos anexados
            <span class="document-count__badge">{{ documentosAnexados.length }}</span>
          </p>
          <div class="document-upload-grid">
            <label class="field">
              Tipo de documento
              <select [(ngModel)]="documentoTipoSelecionado" [ngModelOptions]="{ standalone: true }">
                <option value="">Selecione</option>
                <option *ngFor="let tipo of tiposDocumento" [value]="tipo">{{ tipo }}</option>
              </select>
            </label>
            <label class="field">
              Arquivo
              <input
                type="file"
                accept=".jpg,.jpeg,.png,.pdf,image/jpeg,image/png,application/pdf"
                (change)="onDocumentTypeFileSelected($event)"
              />
            </label>
            <label class="field">
              Filtrar por tipo
              <select [(ngModel)]="filtroTipoDocumento" [ngModelOptions]="{ standalone: true }">
                <option value="">Todos</option>
                <option *ngFor="let tipo of tiposDocumento" [value]="tipo">{{ tipo }}</option>
              </select>
            </label>
            <div class="document-upload-grid__hint">
              <button type="button" class="ghost ghost--compact" (click)="toggleOrdenacaoDocumentos()">
                Ordenar: {{ ordenarDocumentosAsc ? 'A-Z' : 'Z-A' }}
              </button>
              <p class="upload-hint" *ngIf="uploadingDocuments">Aguarde o envio dos documentos selecionados.</p>
            </div>
          </div>

          <div class="document-table">
            <table>
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th>Arquivo</th>
                  <th class="text-right">ações</th>
                </tr>
              </thead>
              <tbody *ngIf="documentosAnexados.length; else emptyDocs">
                <tr *ngFor="let item of documentosAnexados">
                  <td>{{ item.control.get('nome')?.value }}</td>
                  <td>{{ item.control.get('nomeArquivo')?.value || 'Arquivo anexado' }}</td>
                  <td class="text-right actions">
                    <button type="button" class="ghost" (click)="viewDocument(item.index)">Visualizar</button>
                    <button type="button" class="ghost" (click)="printDocument(item.index)">Imprimir</button>
                    <button type="button" class="ghost destructive" (click)="removeUploadedDocument(item.index)">
                      Remover
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <ng-template #emptyDocs>
              <tbody>
                <tr>
                  <td colspan="3" class="list-panel__empty">Nenhum documento anexado ate o momento.</td>
                </tr>
              </tbody>
            </ng-template>
          </div>
        </div>
        <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
      </div>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'familiar'" formGroupName="familiar">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('familiar') }}</p>
          <p class="muted">Localização completa para correspondências e visitas.</p>
        </div>
      </div>
      <div class="field-grid cols-2">
        <label class="checkbox-field"><input type="checkbox" formControlName="mora_com_familia" /> <span>Mora com a familia</span></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="responsavel_legal" /> <span>Responsavel legal</span></label>
        <label class="field">Vinculo familiar<input formControlName="vinculo_familiar" /></label>
        <label class="field">Composicao familiar<textarea formControlName="composicao_familiar"></textarea></label>
        <label class="field">Criancas/adolescentes no domicilio<input type="number" formControlName="criancas_adolescentes" /></label>
        <label class="field">Idosos no domicilio<input type="number" formControlName="idosos" /></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="acompanhamento_cras" /> <span>Em acompanhamento do CRAS/CREAS</span></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="acompanhamento_saude" /> <span>Em acompanhamento pela saude (e-SUS)</span></label>
        <label class="field">Participação comunitaria<input formControlName="participa_comunidade" placeholder="Conselhos, grupos, coletivos" /></label>
        <label class="field">Rede de apoio<textarea formControlName="rede_apoio" placeholder="Instituicoes, vizinhos, familiares"></textarea></label>
        <label class="field full">Situação de vulnerabilidade<textarea formControlName="situacao_vulnerabilidade"></textarea></label>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'escolaridade'" formGroupName="escolaridade">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('escolaridade') }}</p>
          <p class="muted">Localização completa para correspondências e visitas.</p>
        </div>
      </div>
      <div class="field-grid cols-3">
        <label class="checkbox-field"><input type="checkbox" formControlName="sabe_ler_escrever" /> <span>Sabe ler e escrever</span></label>
        <label class="field">Nivel de escolaridade<select formControlName="nivel_escolaridade">
            <option value="">Selecione</option>
            <option *ngFor="let option of educationLevelOptions" [value]="option">{{ option }}</option>
          </select></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="estuda_atualmente" /> <span>Estuda atualmente</span></label>
        <label class="field">Ocupação
          <input
            formControlName="ocupacao"
            placeholder="Informe a ocupação"
          />
        </label>
        <label class="field">Situação de trabalho<input formControlName="situacao_trabalho" /></label>
        <label class="field">Local de trabalho<input formControlName="local_trabalho" /></label>
        <label class="field">Renda mensal
          <input
            type="text"
            formControlName="renda_mensal"
            (input)="formatCurrency($event, 'escolaridade', 'renda_mensal')"
            placeholder="R$ 0,00"
          />
        </label>
        <label class="field">Fonte de renda<input formControlName="fonte_renda" /></label>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'saude'" formGroupName="saude">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('saude') }}</p>
          <p class="muted">Localização completa para correspondências e visitas.</p>
        </div>
      </div>
      <div class="field-grid cols-2">
        <label class="checkbox-field"><input type="checkbox" formControlName="possui_deficiencia" /> <span>Possui deficiencia</span></label>
        <label class="field">Tipo de deficiencia<input formControlName="tipo_deficiencia" /></label>
        <label class="field">CID principal<input formControlName="cid_principal" /></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="usa_medicacao_continua" /> <span>Usa medicação continua</span></label>
        <label class="field full">Descrição da medicação<textarea formControlName="descricao_medicacao"></textarea></label>
        <label class="field">Servico de saude de referência<input formControlName="servico_saude_referencia" /></label>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'beneficios'" formGroupName="beneficios">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('beneficios') }}</p>
          <p class="muted">Localização completa para correspondências e visitas.</p>
        </div>
      </div>
      <div class="field-grid cols-2">
        <label class="checkbox-field"><input type="checkbox" formControlName="recebe_beneficio" /> <span>Recebe benefício</span></label>
        <label class="field">Valor total
          <input type="text" formControlName="valor_total_beneficios" (input)="formatCurrency($event)" placeholder="R$ 0,00" />
        </label>
        <div class="field full">
          <p class="field-title">Benefícios recebidos</p>
          <div class="chips">
            <label *ngFor="let benefit of availableBenefits" class="chip">
              <input type="checkbox" [checked]="selectionChecked(benefit)" (change)="toggleBenefit(benefit)" />
              <span>{{ benefit }}</span>
            </label>
          </div>
        </div>
        <label class="field full">Descrição dos Benefícios<textarea formControlName="beneficios_descricao"></textarea></label>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'observacoes'" formGroupName="observacoes">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('observacoes') }}</p>
          <p class="muted">Localização completa para correspondências e visitas.</p>
        </div>
      </div>
      <div class="field-grid cols-2">
        <label class="field">Data do aceite<input type="datetime-local" formControlName="data_aceite_lgpd" /></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="aceite_lgpd" (change)="handleLgpdToggle($event)" /> <span>Aceite LGPD*</span></label>
        <div class="field full">
          <button type="button" class="ghost" (click)="reimprimirTermoConsentimento()">
            Reimprimir termo de consentimento
          </button>
        </div>
        <label class="field full">Observações<textarea formControlName="observacoes"></textarea></label>
        <p class="field-error full-span" *ngIf="form.get(['observacoes', 'aceite_lgpd'])?.invalid && form.get(['observacoes', 'aceite_lgpd'])?.touched">
          Confirme o aceite LGPD para continuar.
        </p>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'lista'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">Listagem de Beneficiários</p>
        </div>
      </div>

      <form [formGroup]="searchForm" class="list-filters" (ngSubmit)="searchBeneficiaries()">
        <label class="field field-codigo">Código
          <input type="text" formControlName="codigo" placeholder="Ex.: 0001" />
        </label>
        <label class="field">Nome
          <input type="text" formControlName="nome" placeholder="Digite parte do nome" />
        </label>
        <label class="field">Nascimento
          <input type="date" formControlName="data_nascimento" />
        </label>
        <label class="field">CPF
          <input type="text" formControlName="cpf" placeholder="Somente números" />
        </label>
        <label class="field">Status
          <select formControlName="status">
            <option value="">Todos</option>
            <option *ngFor="let option of statusOptions" [value]="option">{{ formatStatusLabel(option) }}</option>
          </select>
        </label>
        <div class="list-panel__filter-actions">
          <button type="button" class="btn-outline" (click)="triggerSearchFromUi()">Buscar</button>
          <button type="button" class="btn-outline" (click)="clearSearchFilters()">Limpar</button>
        </div>
      </form>

      <div class="unit-active" *ngIf="selectedBeneficiary" (dblclick)="selecionarBeneficiarioNaLista(selectedBeneficiary)">
        <div>
          <p class="unit-active__eyebrow">Beneficiário ativo</p>
          <p class="unit-active__name">{{ selectedBeneficiary ? formatarNomeListagem(selectedBeneficiary) : 'Beneficiário sem nome' }}</p>
          <p class="unit-active__meta">
            {{ selectedBeneficiary.cpf || 'CPF não informado' }} - {{ formatDate(selectedBeneficiary.data_nascimento) }}
          </p>
        </div>
      </div>

      <div class="unit-list" *ngIf="beneficiariosPaginados.length">
        <div class="unit-list__item" *ngFor="let beneficiario of beneficiariosPaginados" (dblclick)="selecionarBeneficiarioNaLista(beneficiario)">
          <div>
            <div class="unit-list__header-row">
              <span class="unit-list__code">Código: {{ beneficiario.codigo || '---' }}</span>
              <span class="pill--status" [ngClass]="getStatusClass(beneficiario.status)">{{ formatStatusLabel(beneficiario.status) }}</span>
            </div>
            <div class="unit-list__name-row">
              <div class="unit-list__avatar" [class.unit-list__avatar--empty]="!beneficiario.foto_3x4">
                <img *ngIf="beneficiario.foto_3x4" [src]="beneficiario.foto_3x4" alt="Foto do beneficiario" />
                <span *ngIf="!beneficiario.foto_3x4" aria-hidden="true">
                  {{ (formatarNomeListagem(beneficiario) || 'B')[0] }}
                </span>
              </div>
              <p class="unit-list__name-text">{{ formatarNomeListagem(beneficiario) }}</p>
            </div>
            <div class="unit-list__info-row">
              <span class="unit-list__meta-text">Idade: {{ formatAge(beneficiario.data_nascimento) }}</span>
              <span class="unit-list__separator">-</span>
              <span class="unit-list__meta-text">Nascimento: {{ formatDate(beneficiario.data_nascimento) }}</span>
              <span class="unit-list__separator">-</span>
              <span class="unit-list__meta-text">CPF: {{ beneficiario.cpf || 'CPF não informado' }}</span>
              <span class="unit-list__separator">-</span>
              <span class="unit-list__meta-text" [title]="beneficiario.bairro || 'Bairro n?o informado'">
                <span class="unit-list__meta-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <path
                      d="M12 2.5c-4.14 0-7.5 3.17-7.5 7.09 0 4.73 6.39 11.22 7.02 11.85a.68.68 0 0 0 .96 0c.63-.63 7.02-7.12 7.02-11.85C19.5 5.67 16.14 2.5 12 2.5zm0 10.2a3.1 3.1 0 1 1 0-6.2 3.1 3.1 0 0 1 0 6.2z"
                    />
                  </svg>
                </span>
                Bairro: {{ beneficiario.bairro || 'Bairro não informado' }}
              </span>
              <span class="unit-list__separator">-</span>
              <span class="unit-list__meta-text">
                <span class="unit-list__meta-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <path
                      d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.02-.24 11.72 11.72 0 0 0 3.68.59 1 1 0 0 1 1 1v3.5a1 1 0 0 1-1 1A17.5 17.5 0 0 1 2.5 3a1 1 0 0 1 1-1H7a1 1 0 0 1 1 1 11.72 11.72 0 0 0 .59 3.68 1 1 0 0 1-.24 1.02l-2.2 2.09z"
                    />
                  </svg>
                </span>
                Tel.: {{ formatListPhone(beneficiario) }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="unit-list__pagination" *ngIf="filteredBeneficiarios.length && beneficiariosPaginados.length">
        <span class="unit-list__total">
          Total: {{ filteredBeneficiarios.length }} Beneficiários
        </span>
        <button type="button" class="btn-outline" (click)="paginaAnterior()" [disabled]="paginaAtual === 1">
          Anterior
        </button>
        <span class="unit-list__page">
          Página {{ paginaAtual }} de {{ totalPaginas }}
        </span>
        <button type="button" class="btn-outline" (click)="proximaPagina()" [disabled]="paginaAtual >= totalPaginas">
          Próximo
        </button>
      </div>

      <p class="muted" *ngIf="!filteredBeneficiarios.length">Escolha uma opção, insira a informação e clique em buscar.</p>
    </div>
      </form>
    </div>
  </div>

  <div class="modal" *ngIf="mapaModalOpen">
    <div class="modal__backdrop" (click)="fecharMapaEndereco()"></div>
    <div class="modal__content modal__content--wide">
      <div class="modal__header">
        <div>
          <p class="modal__eyebrow">Endereço</p>
          <h3>Localização no Google Maps</h3>
        </div>
        <button type="button" class="ghost" (click)="fecharMapaEndereco()" aria-label="Fechar">&times;</button>
      </div>
      <iframe
        *ngIf="mapaEnderecoUrl"
        [src]="mapaEnderecoUrl"
        width="100%"
        height="520"
        style="border:0;"
        allowfullscreen=""
        loading="lazy"
        referrerpolicy="no-referrer-when-downgrade"
      ></iframe>
      <div class="modal__actions">
        <a
          class="btn-outline"
          [href]="mapaEnderecoLink"
          target="_blank"
          rel="noopener"
          *ngIf="mapaEnderecoLink"
        >
          Abrir no Google Maps
        </a>
        <button type="button" class="primary" (click)="fecharMapaEndereco()">Fechar</button>
      </div>
    </div>
  </div>

  <div class="modal" *ngIf="quickSearchModalOpen">
    <div class="modal__backdrop" (click)="closeQuickSearch()"></div>
    <div class="modal__content modal__content--wide">
      <div class="modal__header">
        <div>
          <p class="modal__eyebrow">Gestão rápida</p>
          <h3>Buscar Beneficiário</h3>
        </div>
        <button type="button" class="ghost" (click)="closeQuickSearch()">Fechar</button>
      </div>
      <ng-container *ngTemplateOutlet="gestaoRapida"></ng-container>
    </div>
  </div>

  <div class="modal" *ngIf="blockReasonModalOpen">
    <div class="modal__backdrop"></div>
    <div class="modal__content">
      <h3>Motivo do bloqueio</h3>
      <p class="muted">Localização completa para correspondências e visitas.</p>
        <textarea [formControl]="motivoBloqueioControl" rows="4"></textarea>
      <p *ngIf="blockReasonError" class="field-error">{{ blockReasonError }}</p>
      <div class="modal__actions">
        <button type="button" class="ghost" (click)="cancelBlockReason()">Cancelar</button>
        <button type="button" class="primary" (click)="confirmBlockReason()">Salvar motivo</button>
      </div>
    </div>
  </div>

  <div class="print-dialog" *ngIf="printMenuOpen">
    <div class="print-dialog__backdrop" (click)="closePrintMenu()"></div>
    <div
      class="print-dialog__card"
      role="dialog"
      aria-modal="true"
      aria-label="opções de impressão"
    >
      <div class="print-dialog__header">
        <div>
          <p class="print-dialog__title">opções de impressão</p>
          <p class="print-dialog__subtitle">Selecione o relatório que deseja gerar.</p>
        </div>
        <button
          type="button"
          class="print-dialog__close"
          (click)="closePrintMenu()"
          aria-label="Fechar"
        >
          &times;
        </button>
      </div>
      <div class="print-dialog__actions">
        <button type="button" class="btn-primary" (click)="handlePrintSelection('individual')">
          Ficha do Beneficiário atual
        </button>
        <button type="button" class="btn-outline" (click)="openPrintByName()">
          Ficha por nome
        </button>
        <button type="button" class="btn-outline" (click)="handlePrintSelection('authorization')">
          Reimprimir termo de consentimento
        </button>
        <button type="button" class="btn-outline" (click)="handlePrintSelection('list')">
          Listagem de Beneficiários
        </button>
      </div>
    </div>
  </div>

  <div class="modal" *ngIf="printByNameOpen">
    <div class="modal__backdrop" (click)="closePrintByName()"></div>
    <div class="modal__content modal__content--wide">
      <div class="modal__header">
        <div>
          <p class="modal__eyebrow">Relatórios</p>
          <h3>Ficha por nome</h3>
        </div>
        <button type="button" class="ghost" (click)="closePrintByName()" aria-label="Fechar">&times;</button>
      </div>
      <label class="field full">
        <span>Nome do Beneficiário</span>
        <input
          type="text"
          [(ngModel)]="printByNameQuery"
          placeholder="Digite o nome para filtrar"
        />
      </label>
      <div class="unit-list" *ngIf="printByNameResults.length; else emptyPrintByName">
        <div class="unit-list__item" *ngFor="let beneficiario of printByNameResults">
          <div class="unit-list__info">
            <span class="unit-list__code">Código: {{ beneficiario.codigo || '---' }}</span>
            <p class="unit-list__name-text">
              {{ formatarNomeListagem(beneficiario) }}
            </p>
            <span class="unit-list__meta-text">CPF: {{ beneficiario.cpf || 'CPF Não informado' }}</span>
          </div>
          <button type="button" class="btn-outline btn-small" (click)="imprimirFichaPorNome(beneficiario)">
            Imprimir ficha
          </button>
        </div>
      </div>
      <ng-template #emptyPrintByName>
        <p class="muted">Nenhum Beneficiário encontrado com o filtro informado.</p>
      </ng-template>
      <div class="modal__actions">
        <button type="button" class="ghost" (click)="closePrintByName()">Fechar</button>
      </div>
    </div>
  </div>

  <div class="modal" *ngIf="pdfErrorDialogOpen">
    <div class="modal__backdrop" (click)="closePdfErrorDialog()"></div>
    <div class="modal__content">
      <div class="modal__header">
        <div>
          <p class="modal__eyebrow">Erro</p>
          <h3>Falha ao carregar documento PDF.</h3>
        </div>
        <button type="button" class="ghost" (click)="closePdfErrorDialog()" aria-label="Fechar aviso">&times;</button>
      </div>
      <p>{{ pdfErrorMessage || 'Não foi possivel gerar o termo de autorização.' }}</p>
      <div class="modal__actions">
        <button type="button" class="ghost" (click)="closePdfErrorDialog()">Fechar</button>
        <button type="button" class="primary" (click)="retryAuthorizationTerm()">Recarregar</button>
      </div>
    </div>
  </div>

  <div class="modal" *ngIf="missingFieldsModalOpen">
    <div class="modal__backdrop" (click)="closeMissingFieldsModal()"></div>
    <div class="modal__content">
      <div class="modal__header">
        <div>
          <p class="modal__eyebrow">Campos obrigatorios</p>
          <h3>Complete os itens para ativar o cadastro</h3>
        </div>
        <button type="button" class="ghost" (click)="closeMissingFieldsModal()" aria-label="Fechar aviso">&times;</button>
      </div>
      <p class="muted">Localização completa para correspondências e visitas.</p>
      <ul class="issue-list">
        <li class="issue-list__item" *ngFor="let item of missingFieldMessages">
          <span class="issue-list__dot"></span>
          <span>{{ item }}</span>
        </li>
      </ul>
      <div class="modal__actions">
        <button type="button" class="ghost" (click)="closeMissingFieldsModal()">Entendi</button>
        <button type="button" class="primary" (click)="closeMissingFieldsModal()">Voltar ao formulario</button>
      </div>
    </div>
  </div>
</section>
<app-dialog
  [aberto]="dialogConfirmacaoAberta"
  [titulo]="dialogTitulo"
  [mensagem]="dialogMensagem"
  [confirmarLabel]="dialogConfirmarLabel"
  (confirmar)="confirmarDialogo()"
  (cancelar)="cancelarDialogo()"
></app-dialog>
</app-tela-padrao>

























