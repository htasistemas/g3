<section class="cadastro">
  <header class="page-title">
    <p class="page-title__eyebrow">Beneficiário</p>
    <p class="page-title__label">Cadastro de beneficiário</p>
  </header>

  <ng-template #gestaoRapida>
    <section class="list-panel">
      <div class="list-panel__header">
        <div>
          <p class="list-panel__eyebrow">Gestão rápida</p>
          <h2>Busque beneficiários cadastrados</h2>
          <p>Localize pelo nome, CPF, data de nascimento ou código e utilize os atalhos para navegar pelas ações.</p>
        </div>
        <div class="list-panel__actions">
          <button type="button" class="ghost" (click)="clearSearchFilters()">Limpar filtros</button>
          <button type="button" class="primary" (click)="searchBeneficiaries()">Buscar</button>
        </div>
      </div>

      <div class="list-panel__navigation" aria-label="Ações rápidas para o cadastro">
        <button type="button" class="primary" (click)="startNewBeneficiario()">Incluir</button>
        <button type="button" class="ghost" [disabled]="!selectedBeneficiary" (click)="handleEditSelected()">
          Editar
        </button>
        <button type="button" class="ghost" [disabled]="!selectedBeneficiary" (click)="handleAlterSelected()">
          Alterar
        </button>
        <button
          type="button"
          class="danger"
          [disabled]="!selectedBeneficiary"
          (click)="handleDeleteSelected()"
        >
          Excluir
        </button>
      </div>

      <form [formGroup]="searchForm" class="list-panel__filters" (ngSubmit)="searchBeneficiaries()">
        <label class="field">
          Nome ou apelido
          <input type="text" formControlName="nome" placeholder="Digite parte do nome" />
        </label>
        <label class="field">
          Código
          <input type="text" formControlName="codigo" placeholder="Ex.: 0001" />
        </label>
        <label class="field">
          CPF
          <input type="text" formControlName="cpf" placeholder="Somente números" />
        </label>
        <label class="field">
          Data de nascimento
          <input type="date" formControlName="data_nascimento" />
        </label>
        <label class="field">
          Status
          <select formControlName="status">
            <option value="">Todos</option>
            <option *ngFor="let option of statusOptions" [value]="option">{{ formatStatusLabel(option) }}</option>
          </select>
        </label>
        <div class="list-panel__filter-actions">
          <button type="submit" class="primary">Aplicar filtros</button>
        </div>
      </form>

      <div *ngIf="listError" class="feedback">
        <span>{{ listError }}</span>
        <button type="button" class="feedback__close" (click)="dismissListError()" aria-label="Fechar aviso">×</button>
      </div>
      <div *ngIf="listLoading" class="list-panel__loading">Carregando beneficiários...</div>

      <div class="list-panel__table" *ngIf="!listLoading">
        <table>
          <thead>
            <tr>
              <th>Nome</th>
              <th>Código</th>
              <th>CPF</th>
              <th>Nascimento</th>
              <th>Status</th>
              <th class="text-right">Ações</th>
            </tr>
          </thead>
          <tbody *ngIf="filteredBeneficiarios.length; else emptyList">
            <tr *ngFor="let beneficiario of filteredBeneficiarios">
              <td>{{ beneficiario.nome_completo || beneficiario.nome_social }}</td>
              <td>{{ beneficiario.codigo || '---' }}</td>
              <td>{{ beneficiario.cpf || beneficiario.nis || '---' }}</td>
              <td>{{ beneficiario.data_nascimento ? (beneficiario.data_nascimento | date : 'dd/MM/yyyy') : '---' }}</td>
              <td><span [ngClass]="getStatusClass(beneficiario.status)">{{ formatStatusLabel(beneficiario.status) }}</span></td>
              <td class="text-right actions">
                <button type="button" class="ghost" (click)="onBeneficiarioSelected(beneficiario)">Selecionar</button>
                <button type="button" class="ghost" (click)="editBeneficiario(beneficiario)">Editar</button>
                <button type="button" class="danger" (click)="deleteBeneficiario(beneficiario)">Excluir</button>
              </td>
            </tr>
          </tbody>
        </table>
        <ng-template #emptyList>
          <tbody>
            <tr>
              <td colspan="6" class="list-panel__empty">Nenhum beneficiário encontrado com os filtros informados.</td>
            </tr>
          </tbody>
        </ng-template>
      </div>
    </section>
  </ng-template>

  <div class="tab-shell">
    <p class="tab-shell__title">Navegue pelas informações</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of tabs; index as idx"
        class="step-tabs__item"
        [class.active]="activeTab === tab.id"
        [class.completed]="idx < activeTabIndex"
      >
        <button
          class="step-tabs__button"
          type="button"
          role="tab"
          [attr.aria-selected]="activeTab === tab.id"
          (click)="changeTab(tab.id)"
        >
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ tab.label }}</span>
        </button>
      </li>
    </ol>
  </div>

  <form [formGroup]="form" (ngSubmit)="submit()" class="form-shell">
    <div class="beneficiary-meta-card">
      <p class="beneficiary-meta-card__title">Dados do cadastro</p>
      <div class="beneficiary-meta" aria-live="polite">
        <div class="beneficiary-meta__item">
          <span class="beneficiary-meta__label">Família</span>
          <span class="beneficiary-meta__value">{{ getFamilyRegistrationLabel() }}</span>
        </div>
        <div class="beneficiary-meta__item">
          <span class="beneficiary-meta__label">Matrícula</span>
          <span class="beneficiary-meta__value beneficiary-meta__value--code">
            {{ beneficiaryCode || 'Gerado ao salvar' }}
          </span>
        </div>
        <div class="beneficiary-meta__item">
          <span class="beneficiary-meta__label">Cadastrado em</span>
          <span class="beneficiary-meta__value">{{ formatDateTime(createdAt) }}</span>
        </div>
        <div class="beneficiary-meta__item">
          <span class="beneficiary-meta__label">Alterado em</span>
          <span class="beneficiary-meta__value">{{ formatDateTime(lastUpdatedAt) }}</span>
        </div>
      </div>
    </div>

    <div *ngIf="feedback" class="feedback">
      <span>{{ feedback }}</span>
      <button type="button" class="feedback__close" (click)="dismissFeedback()" aria-label="Fechar aviso">×</button>
    </div>

    <ng-template #navigationControls>
      <div class="tab-actions">
        <button
          type="button"
          class="ghost"
          *ngIf="hasPreviousTab"
          (click)="goToPreviousTab()"
          [disabled]="uploadingDocuments"
        >
          Voltar
        </button>
        <button
          type="button"
          class="primary"
          *ngIf="hasNextTab"
          (click)="goToNextTab()"
          [disabled]="uploadingDocuments"
        >
          Próximo: {{ nextTabLabel }}
        </button>
        <button type="submit" class="primary" [disabled]="saving || uploadingDocuments" *ngIf="!hasNextTab">
          {{ saving ? 'Salvando...' : uploadingDocuments ? 'Aguardando envios' : 'Salvar cadastro' }}
        </button>
      </div>
    </ng-template>

    <div class="tab-card" *ngIf="activeTab === 'dados'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('dados') }}</p>
          <p class="muted">Campos essenciais como nome, data de nascimento e responsáveis.</p>
          <span class="pill">Obrigatório</span>
        </div>
        <div class="nav-buttons" aria-label="Ações rápidas do cadastro">
          <div class="nav-buttons__row nav-buttons__row--primary">
            <div class="nav-button-group" [class.nav-button-group--open]="printMenuOpen">
              <button type="button" class="nav-button nav-button--print" (click)="togglePrintMenu()">
                <span class="nav-button__icon" aria-hidden="true">
                  <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M6 4.5C6 3.67157 6.67157 3 7.5 3H12.5C13.3284 3 14 3.67157 14 4.5V6H6V4.5Z"
                      fill="currentColor"
                    />
                    <path
                      fill-rule="evenodd"
                      clip-rule="evenodd"
                      d="M5 6H15C16.1046 6 17 6.89543 17 8V11.5C17 12.3284 16.3284 13 15.5 13H14V14.5C14 15.3284 13.3284 16 12.5 16H7.5C6.67157 16 6 15.3284 6 14.5V13H4.5C3.67157 13 3 12.3284 3 11.5V8C3 6.89543 3.89543 6 5 6ZM7.5 8.75C7.22386 8.75 7 8.97386 7 9.25C7 9.52614 7.22386 9.75 7.5 9.75H12.5C12.7761 9.75 13 9.52614 13 9.25C13 8.97386 12.7761 8.75 12.5 8.75H7.5Z"
                      fill="currentColor"
                    />
                  </svg>
                </span>
                <span class="nav-button__label">Imprimir dados</span>
              </button>
              <div class="print-menu" *ngIf="printMenuOpen" role="dialog" aria-label="Opções de impressão">
                <div class="print-menu__section">
                  <p class="print-menu__title">Ordenação da impressão</p>
                  <label class="print-menu__field">
                    <span>Ordenar por</span>
                    <select [value]="printOrderBy" (change)="onPrintOrderChange($any($event.target).value)">
                      <option *ngFor="let option of printOrderOptions" [value]="option.value">{{ option.label }}</option>
                    </select>
                  </label>
                </div>
                <div class="print-menu__section">
                  <div class="print-menu__heading">
                    <p class="print-menu__title">Relação de beneficiários</p>
                    <div class="chip-options" role="group" aria-label="Ordenação específica">
                      <label class="chip-option">
                        <input
                          type="radio"
                          name="printListOrder"
                          value="alphabetical"
                          [checked]="printListOrder === 'alphabetical'"
                          (change)="setPrintListOrder('alphabetical')"
                        />
                        <span>Ordem alfabética</span>
                      </label>
                      <label class="chip-option">
                        <input
                          type="radio"
                          name="printListOrder"
                          value="code"
                          [checked]="printListOrder === 'code'"
                          (change)="setPrintListOrder('code')"
                        />
                        <span>Ordem de código</span>
                      </label>
                    </div>
                  </div>
                  <button type="button" class="ghost ghost--compact" (click)="handlePrintSelection('list')">
                    Relação de beneficiários
                  </button>
                </div>
                <div class="print-menu__section print-menu__section--actions">
                  <button type="button" class="ghost ghost--compact" (click)="handlePrintSelection('individual')">
                    Ficha individual
                  </button>
                  <button type="button" class="ghost ghost--compact" (click)="handlePrintSelection('authorization')">
                    Termo de autorização
                  </button>
                  <button type="button" class="ghost ghost--compact" (click)="closePrintMenu()">Fechar</button>
                </div>
              </div>
            </div>
            <button type="button" class="nav-button nav-button--muted" (click)="openQuickSearch()">
              <span class="nav-button__icon" aria-hidden="true">
                <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    fill-rule="evenodd"
                    clip-rule="evenodd"
                    d="M9.25 4.25C6.62665 4.25 4.5 6.37665 4.5 9C4.5 11.6234 6.62665 13.75 9.25 13.75C10.4688 13.75 11.579 13.2974 12.4324 12.5521L15.1903 15.3099C15.4832 15.6028 15.958 15.6028 16.2509 15.3099C16.5438 15.017 16.5438 14.5421 16.2509 14.2492L13.493 11.4913C14.2382 10.6379 14.6909 9.52771 14.6909 8.30901C14.6909 5.68565 12.5643 3.55901 9.94093 3.55901C9.25 3.55901 9.25 4.25 9.25 4.25Z"
                    fill="currentColor"
                  />
                </svg>
              </span>
              <span class="nav-button__label">Localizar beneficiário</span>
            </button>
            <div class="action-toolbar" aria-label="Ações do cadastro">
              <div class="action-toolbar__group">
                <button
                  type="button"
                  class="action-button action-button--save"
                  (click)="onSave()"
                  [disabled]="saving || uploadingDocuments"
                >
                  <span class="action-button__icon" aria-hidden="true">
                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M5.25 3.5C4.55964 3.5 4 4.05964 4 4.75V15.25C4 15.9404 4.55964 16.5 5.25 16.5H14.75C15.4404 16.5 16 15.9404 16 15.25V6.41421C16 6.149 15.8946 5.89464 15.7071 5.70711L12.2929 2.29289C12.1054 2.10536 11.851 2 11.5858 2H5.25ZM6.25 4.5C6.11193 4.5 6 4.61193 6 4.75C6 4.88807 6.11193 5 6.25 5H10.25C10.3881 5 10.5 4.88807 10.5 4.75C10.5 4.61193 10.3881 4.5 10.25 4.5H6.25ZM6 8C6 7.86193 6.11193 7.75 6.25 7.75H13.75C13.8881 7.75 14 7.86193 14 8C14 8.13807 13.8881 8.25 13.75 8.25H6.25C6.11193 8.25 6 8.13807 6 8ZM6 10.5C6 10.3619 6.11193 10.25 6.25 10.25H13.75C13.8881 10.25 14 10.3619 14 10.5C14 10.6381 13.8881 10.75 13.75 10.75H6.25C6.11193 10.75 6 10.6381 6 10.5ZM6.25 12.75C6.11193 12.75 6 12.8619 6 13C6 13.1381 6.11193 13.25 6.25 13.25H11.75C11.8881 13.25 12 13.1381 12 13C12 12.8619 11.8881 12.75 11.75 12.75H6.25Z"
                        fill="currentColor"
                      />
                    </svg>
                  </span>
                  <span class="action-button__label">Salvar</span>
                </button>
                <button type="button" class="action-button action-button--new" (click)="onNew()">
                  <span class="action-button__icon" aria-hidden="true">
                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M10.75 5.25C10.75 4.97386 10.5261 4.75 10.25 4.75C9.97386 4.75 9.75 4.97386 9.75 5.25V9.25H5.75C5.47386 9.25 5.25 9.47386 5.25 9.75C5.25 10.0261 5.47386 10.25 5.75 10.25H9.75V14.25C9.75 14.5261 9.97386 14.75 10.25 14.75C10.5261 14.75 10.75 14.5261 10.75 14.25V10.25H14.75C15.0261 10.25 15.25 10.0261 15.25 9.75C15.25 9.47386 15.0261 9.25 14.75 9.25H10.75V5.25Z"
                        fill="currentColor"
                      />
                    </svg>
                  </span>
                  <span class="action-button__label">Novo</span>
                </button>
                <button type="button" class="action-button action-button--cancel" (click)="onCancel()">
                  <span class="action-button__icon" aria-hidden="true">
                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M10.3536 4.64645C10.5488 4.84171 10.5488 5.15829 10.3536 5.35355L7.70711 8H14.5C14.7761 8 15 8.22386 15 8.5C15 8.77614 14.7761 9 14.5 9H7.70711L10.3536 11.6464C10.5488 11.8417 10.5488 12.1583 10.3536 12.3536C10.1583 12.5488 9.84171 12.5488 9.64645 12.3536L6.14645 8.85355C5.95118 8.65829 5.95118 8.34171 6.14645 8.14645L9.64645 4.64645C9.84171 4.45118 10.1583 4.45118 10.3536 4.64645Z"
                        fill="currentColor"
                      />
                    </svg>
                  </span>
                  <span class="action-button__label">Cancelar</span>
                </button>
                <button
                  type="button"
                  class="action-button action-button--delete"
                  (click)="onDelete()"
                  [disabled]="!selectedBeneficiary"
                >
                  <span class="action-button__icon" aria-hidden="true">
                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M7.5 4C7.5 3.44772 7.94772 3 8.5 3H11.5C12.0523 3 12.5 3.44772 12.5 4V4.5H15.25C15.6642 4.5 16 4.83579 16 5.25C16 5.66421 15.6642 6 15.25 6H4.75C4.33579 6 4 5.66421 4 5.25C4 4.83579 4.33579 4.5 4.75 4.5H7.5V4Z"
                        fill="currentColor"
                      />
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M6.11392 7H13.8861L13.3861 14.5C13.3342 15.2792 12.6842 15.875 11.904 15.875H8.09597C7.31576 15.875 6.66579 15.2792 6.61392 14.5L6.11392 7ZM8.75 8.75C8.75 8.33579 8.41421 8 8 8C7.58579 8 7.25 8.33579 7.25 8.75V13.25C7.25 13.6642 7.58579 14 8 14C8.41421 14 8.75 13.6642 8.75 13.25V8.75ZM12.75 8.75C12.75 8.33579 12.4142 8 12 8C11.5858 8 11.25 8.33579 11.25 8.75V13.25C11.25 13.6642 11.5858 14 12 14C12.4142 14 12.75 13.6642 12.75 13.25V8.75Z"
                        fill="currentColor"
                      />
                    </svg>
                  </span>
                  <span class="action-button__label">Excluir</span>
                </button>
                <button type="button" class="action-button action-button--close" (click)="onClose()">
                  <span class="action-button__icon" aria-hidden="true">
                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M6.46967 6.46967C6.76256 6.17678 7.23744 6.17678 7.53033 6.46967L10 8.93934L12.4697 6.46967C12.7626 6.17678 13.2374 6.17678 13.5303 6.46967C13.8232 6.76256 13.8232 7.23744 13.5303 7.53033L11.0607 10L13.5303 12.4697C13.8232 12.7626 13.8232 13.2374 13.5303 13.5303C13.2374 13.8232 12.7626 13.8232 12.4697 13.5303L10 11.0607L7.53033 13.5303C7.23744 13.8232 6.76256 13.8232 6.46967 13.5303C6.17678 13.2374 6.17678 12.7626 6.46967 12.4697L8.93934 10L6.46967 7.53033C6.17678 7.23744 6.17678 6.76256 6.46967 6.46967Z"
                        fill="currentColor"
                      />
                    </svg>
                  </span>
                  <span class="action-button__label">Fechar</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-card__hero" [class.tab-card__hero--camera]="cameraActive">
        <div class="photo-section">
          <div class="photo-preview" [class.photo-preview--empty]="!photoPreview">
            <img *ngIf="photoPreview" [src]="photoPreview" alt="Foto 3x4 do beneficiário" />
            <span *ngIf="!photoPreview">Foto 3x4 do beneficiário</span>
          </div>
          <div class="photo-actions">
            <label class="upload-btn">
              Enviar foto 3x4
              <input type="file" accept="image/*" (change)="onPhotoSelected($event)" />
            </label>
            <button type="button" class="ghost" (click)="handleCameraCapture()">
              {{ cameraActive ? 'Registrar foto' : 'Capturar pela câmera' }}
            </button>
            <button type="button" class="ghost" *ngIf="photoPreview" (click)="removePhoto()">Remover foto</button>
            <button type="button" class="ghost" *ngIf="cameraActive" (click)="stopCamera()">Fechar câmera</button>
            <p class="photo-hint">Aceite arquivos enviados ou registre uma nova foto pela webcam.</p>
            <p *ngIf="captureError" class="field-error">{{ captureError }}</p>
          </div>
        </div>

        <div class="camera-panel" *ngIf="cameraActive">
          <p class="camera-panel__title">Visualização da câmera</p>
          <div class="camera-panel__preview">
            <video #videoElement autoplay muted playsinline></video>
          </div>
          <p class="camera-panel__hint">Ajuste o enquadramento e clique em "Registrar foto" para salvar.</p>
        </div>

        <div class="status-panel">
          <p class="status-panel__title">Status do beneficiário</p>
          <div class="status-panel__current">
            <span [ngClass]="getStatusClass(form.get('status')?.value)">{{ formatStatusLabel(form.get('status')?.value) }}</span>
            <span class="status-panel__reason" *ngIf="form.get('motivo_bloqueio')?.value">
              Motivo: {{ form.get('motivo_bloqueio')?.value }}
            </span>
          </div>
          <label class="field">
            <span>Atualizar status</span>
            <select formControlName="status">
              <option *ngFor="let option of statusOptions" [value]="option">{{ formatStatusLabel(option) }}</option>
            </select>
          </label>
          <button type="button" class="primary" [disabled]="saving" (click)="saveStatusChange()">
            {{ saving ? 'Salvando...' : 'Atualizar cadastro' }}
          </button>
          <button type="button" class="ghost" *ngIf="form.get('status')?.value === 'BLOQUEADO'" (click)="blockReasonModalOpen = true">
            Editar motivo do bloqueio
          </button>
        </div>
      </div>
      <canvas #canvasElement class="capture-canvas"></canvas>
      <div class="field-grid cols-2" formGroupName="dadosPessoais">
        <label class="field full">Nome completo*<input formControlName="nome_completo" placeholder="Digite o nome completo" /></label>
        <label class="field">Nome social<input formControlName="nome_social" placeholder="Se houver" /></label>
        <label class="field">Apelido<input formControlName="apelido" placeholder="Como prefere ser chamado" /></label>
        <div class="field date-field">
          <label class="field">Data de nascimento*<input type="date" formControlName="data_nascimento" /></label>
          <p class="age-hint" *ngIf="beneficiaryAge !== null">{{ beneficiaryAge }} anos</p>
        </div>
        <label class="field">Sexo biológico<select formControlName="sexo_biologico">
            <option value="">Selecione</option>
            <option value="MASCULINO">Masculino</option>
            <option value="FEMININO">Feminino</option>
            <option value="OUTRO">Outro</option>
          </select></label>
        <label class="field">Identidade de gênero<select formControlName="identidade_genero">
            <option value="">Selecione</option>
            <option *ngFor="let option of genderIdentityOptions" [value]="option">{{ option }}</option>
          </select></label>
        <label class="field">Cor/Raça<select formControlName="cor_raca">
            <option value=""></option>
            <option value="BRANCA">Branca</option>
            <option value="PRETA">Preta</option>
            <option value="PARDA">Parda</option>
            <option value="AMARELA">Amarela</option>
            <option value="INDIGENA">Indígena</option>
            <option value="NAO_INFORMADO">Não informado</option>
          </select></label>
        <label class="field">Estado civil<select formControlName="estado_civil">
            <option value=""></option>
            <option *ngFor="let option of maritalStatusOptions" [value]="option">{{ option }}</option>
          </select></label>
        <div class="field-grid cols-3 compact full-span">
          <label class="field">Nacionalidade<select formControlName="nacionalidade">
              <option value=""></option>
              <option *ngFor="let option of nationalityOptions" [value]="option">{{ option }}</option>
            </select></label>
          <label class="field">Naturalidade (cidade)<input formControlName="naturalidade_cidade" /></label>
          <label class="field">Estado<select formControlName="naturalidade_uf">
              <option value="">Selecione o estado</option>
              <option *ngFor="let uf of brazilianStates" [value]="uf">{{ uf }}</option>
            </select></label>
        </div>
      <label class="field full">Nome da mãe*<input formControlName="nome_mae" /></label>
      <label class="field full">Nome do pai<input formControlName="nome_pai" /></label>
    </div>

    <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
  </div>

    <div class="tab-card" *ngIf="activeTab === 'endereco'" formGroupName="endereco">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('endereco') }}</p>
          <p class="muted">Preferencialmente utilize o endereço da família para evitar inconsistências.</p>
        </div>
        <label class="checkbox-field">
          <input type="checkbox" formControlName="usa_endereco_familia" />
          <span>Usar endereço da família</span>
        </label>
      </div>
      <div class="field-grid cols-3">
        <label class="field">CEP*<input formControlName="cep" placeholder="00000-000" (input)="onCepInput($event)" (blur)="onCepBlur()" />
          <p class="field-error" *ngIf="form.get(['endereco', 'cep'])?.invalid && form.get(['endereco', 'cep'])?.touched">
            Informe um CEP válido com 8 dígitos.
          </p>
          <p class="field-error" *ngIf="cepLookupError">{{ cepLookupError }}</p>
        </label>
        <label class="field">Logradouro<input formControlName="logradouro" /></label>
        <label class="field">Número<input formControlName="numero" /></label>
        <label class="field">Complemento<input formControlName="complemento" /></label>
        <label class="field">Bairro<input formControlName="bairro" /></label>
        <label class="field">Ponto de referência<input formControlName="ponto_referencia" /></label>
        <label class="field">Município<input formControlName="municipio" /></label>
        <label class="field">Estado<input maxlength="2" formControlName="uf" /></label>
        <label class="field">Zona<select formControlName="zona">
            <option value="URBANA">Urbana</option>
            <option value="RURAL">Rural</option>
          </select></label>
        <label class="field">Situação do imóvel<select formControlName="situacao_imovel">
            <option value=""></option>
            <option *ngFor="let option of situacaoImovelOptions" [value]="option">{{ option }}</option>
          </select></label>
        <div class="field-grid cols-3 compact full-span">
          <label class="field">Tipo de moradia<select formControlName="tipo_moradia">
              <option value=""></option>
              <option *ngFor="let option of tipoMoradiaOptions" [value]="option">{{ option }}</option>
            </select></label>
          <label class="field">Esgoto<select formControlName="esgoto_tipo">
              <option value=""></option>
              <option value="REDE">Rede</option>
              <option value="FOSSA">Fossa</option>
              <option value="CEU_ABERTO">Céu aberto</option>
              <option value="NAO_POSSUI">Não possui</option>
            </select></label>
          <label class="field">Coleta de lixo<select formControlName="coleta_lixo">
              <option value=""></option>
              <option value="REGULAR">Regular</option>
              <option value="IRREGULAR">Irregular</option>
              <option value="NAO_POSSUI">Não possui</option>
            </select></label>
        </div>
        <div class="feature-grid">
          <label class="checkbox-field"><input type="checkbox" formControlName="agua_encanada" /> <span>Água encanada</span></label>
          <label class="checkbox-field"><input type="checkbox" formControlName="energia_eletrica" /> <span>Energia elétrica</span></label>
          <label class="checkbox-field"><input type="checkbox" formControlName="internet" /> <span>Internet</span></label>
        </div>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'contato'" formGroupName="contato">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('contato') }}</p>
          <p class="muted">Cadastre diferentes formas de contato e preferências.</p>
        </div>
      </div>
        <div class="field-grid cols-2">
          <label class="field">
            <span>Telefone principal*</span>
            <div class="contact-row">
              <input
                formControlName="telefone_principal"
                placeholder="(00) 00000-0000"
                (input)="onPhoneInput($event, 'telefone_principal')"
              />
              <div
                class="contact-actions"
                *ngIf="
                  form.get(['contato', 'permite_contato_tel'])?.value ||
                  form.get(['contato', 'permite_contato_whatsapp'])?.value ||
                  form.get(['contato', 'permite_contato_sms'])?.value
                "
              >
                <button
                  type="button"
                  class="contact-actions__button"
                  *ngIf="form.get(['contato', 'permite_contato_tel'])?.value"
                  (click)="startCall('telefone_principal')"
                  [disabled]="!hasPhoneValue('telefone_principal')"
                  aria-label="Ligar para telefone principal"
                  title="Ligar"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.02-.24 11.72 11.72 0 003.68.59 1 1 0 011 1v3.5a1 1 0 01-1 1A17.5 17.5 0 012.5 3a1 1 0 011-1H7a1 1 0 011 1 11.72 11.72 0 00.59 3.68 1 1 0 01-.24 1.02l-2.2 2.09z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
                <button
                  type="button"
                  class="contact-actions__button contact-actions__button--whatsapp"
                  *ngIf="form.get(['contato', 'permite_contato_whatsapp'])?.value"
                  (click)="openWhatsapp('telefone_principal')"
                  [disabled]="!hasPhoneValue('telefone_principal')"
                  aria-label="Abrir WhatsApp para telefone principal"
                  title="WhatsApp"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M12 2.25a9.75 9.75 0 00-8.51 14.48L2.2 21.8a.75.75 0 001 .93l5.08-1.74A9.75 9.75 0 1012 2.25zm0 1.5a8.25 8.25 0 110 16.5 8.18 8.18 0 01-3.74-.9l-.26-.13-3.05 1.04 1.03-2.88-.14-.24A8.25 8.25 0 0112 3.75zm-3.02 3.5c-.14 0-.35.05-.54.21-.22.18-.71.69-.71 1.68 0 1 .73 1.96.83 2.1.1.14 1.43 2.28 3.53 3.22 1.79.79 2.15.72 2.54.67.39-.05 1.26-.51 1.44-1 .18-.49.18-.91.13-1-.05-.09-.2-.15-.42-.26-.22-.1-1.3-.64-1.5-.71-.2-.08-.35-.11-.5.11-.15.23-.58.71-.72.86-.14.15-.27.17-.5.06-.23-.11-.97-.36-1.86-1.14a6.37 6.37 0 01-1.18-1.47c-.13-.22 0-.33.1-.44.1-.11.23-.27.35-.4.12-.13.15-.22.23-.36.08-.14.04-.26-.02-.36-.06-.1-.5-1.22-.69-1.68-.18-.44-.36-.38-.5-.39z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
                <button
                  type="button"
                  class="contact-actions__button contact-actions__button--sms"
                  *ngIf="form.get(['contato', 'permite_contato_sms'])?.value"
                  (click)="sendSms('telefone_principal')"
                  [disabled]="!hasPhoneValue('telefone_principal')"
                  aria-label="Enviar SMS para telefone principal"
                  title="SMS"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M4 4h16a1 1 0 011 1v10a1 1 0 01-1 1H8.41L5 19.92V16H4a1 1 0 01-1-1V5a1 1 0 011-1zm1 2v8h1a1 1 0 011 1v1.38L9.62 15H19V6H5zm3 2h8a1 1 0 110 2H8a1 1 0 110-2zm0 3h5a1 1 0 110 2H8a1 1 0 110-2z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
              </div>
            </div>
            <p class="field-error" *ngIf="form.get(['contato', 'telefone_principal'])?.invalid && form.get(['contato', 'telefone_principal'])?.touched">
              Informe o telefone principal.
            </p>
          </label>
          <label class="field">
            <span>Telefone secundário</span>
            <div class="contact-row">
              <input
                formControlName="telefone_secundario"
                placeholder="(00) 00000-0000"
                (input)="onPhoneInput($event, 'telefone_secundario')"
              />
              <div
                class="contact-actions"
                *ngIf="
                  form.get(['contato', 'permite_contato_tel'])?.value ||
                  form.get(['contato', 'permite_contato_whatsapp'])?.value ||
                  form.get(['contato', 'permite_contato_sms'])?.value
                "
              >
                <button
                  type="button"
                  class="contact-actions__button"
                  *ngIf="form.get(['contato', 'permite_contato_tel'])?.value"
                  (click)="startCall('telefone_secundario')"
                  [disabled]="!hasPhoneValue('telefone_secundario')"
                  aria-label="Ligar para telefone secundário"
                  title="Ligar"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.02-.24 11.72 11.72 0 003.68.59 1 1 0 011 1v3.5a1 1 0 01-1 1A17.5 17.5 0 012.5 3a1 1 0 011-1H7a1 1 0 011 1 11.72 11.72 0 00.59 3.68 1 1 0 01-.24 1.02l-2.2 2.09z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
                <button
                  type="button"
                  class="contact-actions__button contact-actions__button--whatsapp"
                  *ngIf="form.get(['contato', 'permite_contato_whatsapp'])?.value"
                  (click)="openWhatsapp('telefone_secundario')"
                  [disabled]="!hasPhoneValue('telefone_secundario')"
                  aria-label="Abrir WhatsApp para telefone secundário"
                  title="WhatsApp"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M12 2.25a9.75 9.75 0 00-8.51 14.48L2.2 21.8a.75.75 0 001 .93l5.08-1.74A9.75 9.75 0 1012 2.25zm0 1.5a8.25 8.25 0 110 16.5 8.18 8.18 0 01-3.74-.9l-.26-.13-3.05 1.04 1.03-2.88-.14-.24A8.25 8.25 0 0112 3.75zm-3.02 3.5c-.14 0-.35.05-.54.21-.22.18-.71.69-.71 1.68 0 1 .73 1.96.83 2.1.1.14 1.43 2.28 3.53 3.22 1.79.79 2.15.72 2.54.67.39-.05 1.26-.51 1.44-1 .18-.49.18-.91.13-1-.05-.09-.2-.15-.42-.26-.22-.1-1.3-.64-1.5-.71-.2-.08-.35-.11-.5.11-.15.23-.58.71-.72.86-.14.15-.27.17-.5.06-.23-.11-.97-.36-1.86-1.14a6.37 6.37 0 01-1.18-1.47c-.13-.22 0-.33.1-.44.1-.11.23-.27.35-.4.12-.13.15-.22.23-.36.08-.14.04-.26-.02-.36-.06-.1-.5-1.22-.69-1.68-.18-.44-.36-.38-.5-.39z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
                <button
                  type="button"
                  class="contact-actions__button contact-actions__button--sms"
                  *ngIf="form.get(['contato', 'permite_contato_sms'])?.value"
                  (click)="sendSms('telefone_secundario')"
                  [disabled]="!hasPhoneValue('telefone_secundario')"
                  aria-label="Enviar SMS para telefone secundário"
                  title="SMS"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M4 4h16a1 1 0 011 1v10a1 1 0 01-1 1H8.41L5 19.92V16H4a1 1 0 01-1-1V5a1 1 0 011-1zm1 2v8h1a1 1 0 011 1v1.38L9.62 15H19V6H5zm3 2h8a1 1 0 110 2H8a1 1 0 110-2zm0 3h5a1 1 0 110 2H8a1 1 0 110-2z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </label>
          <label class="checkbox-field"><input type="checkbox" formControlName="telefone_principal_whatsapp" /> <span>Telefone principal tem WhatsApp</span></label>
          <label class="field">Nome para recado<input formControlName="telefone_recado_nome" /></label>
          <label class="field">
            <span>Telefone para recado</span>
            <div class="contact-row">
              <input
                formControlName="telefone_recado_numero"
                placeholder="(00) 00000-0000"
                (input)="onPhoneInput($event, 'telefone_recado_numero')"
              />
              <div
                class="contact-actions"
                *ngIf="
                  form.get(['contato', 'permite_contato_tel'])?.value ||
                  form.get(['contato', 'permite_contato_whatsapp'])?.value
                "
              >
                <button
                  type="button"
                  class="contact-actions__button"
                  *ngIf="form.get(['contato', 'permite_contato_tel'])?.value"
                  (click)="startCall('telefone_recado_numero')"
                  [disabled]="!hasPhoneValue('telefone_recado_numero')"
                  aria-label="Ligar para telefone de recado"
                  title="Ligar"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.02-.24 11.72 11.72 0 003.68.59 1 1 0 011 1v3.5a1 1 0 01-1 1A17.5 17.5 0 012.5 3a1 1 0 011-1H7a1 1 0 011 1 11.72 11.72 0 00.59 3.68 1 1 0 01-.24 1.02l-2.2 2.09z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
                <button
                  type="button"
                  class="contact-actions__button contact-actions__button--whatsapp"
                  *ngIf="form.get(['contato', 'permite_contato_whatsapp'])?.value"
                  (click)="openWhatsapp('telefone_recado_numero')"
                  [disabled]="!hasPhoneValue('telefone_recado_numero')"
                  aria-label="Abrir WhatsApp para telefone de recado"
                  title="WhatsApp"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M12 2.25a9.75 9.75 0 00-8.51 14.48L2.2 21.8a.75.75 0 001 .93l5.08-1.74A9.75 9.75 0 1012 2.25zm0 1.5a8.25 8.25 0 110 16.5 8.18 8.18 0 01-3.74-.9l-.26-.13-3.05 1.04 1.03-2.88-.14-.24A8.25 8.25 0 0112 3.75zm-3.02 3.5c-.14 0-.35.05-.54.21-.22.18-.71.69-.71 1.68 0 1 .73 1.96.83 2.1.1.14 1.43 2.28 3.53 3.22 1.79.79 2.15.72 2.54.67.39-.05 1.26-.51 1.44-1 .18-.49.18-.91.13-1-.05-.09-.2-.15-.42-.26-.22-.1-1.3-.64-1.5-.71-.2-.08-.35-.11-.5.11-.15.23-.58.71-.72.86-.14.15-.27.17-.5.06-.23-.11-.97-.36-1.86-1.14a6.37 6.37 0 01-1.18-1.47c-.13-.22 0-.33.1-.44.1-.11.23-.27.35-.4.12-.13.15-.22.23-.36.08-.14.04-.26-.02-.36-.06-.1-.5-1.22-.69-1.68-.18-.44-.36-.38-.5-.39z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </label>
          <label class="field">
            <span>Email</span>
            <div class="contact-row">
              <input type="email" formControlName="email" />
              <div class="contact-actions" *ngIf="form.get(['contato', 'permite_contato_email'])?.value">
                <button
                  type="button"
                  class="contact-actions__button contact-actions__button--email"
                  (click)="openEmailClient()"
                  [disabled]="!form.get(['contato', 'email'])?.value"
                  aria-label="Abrir cliente de e-mail"
                  title="E-mail"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M4 5h16a1 1 0 011 1v12a1 1 0 01-1 1H4a1 1 0 01-1-1V6a1 1 0 011-1zm1.25 2l6.25 4.35L17.75 7H5.25zM19 17V9.74l-7.09 4.94a1 1 0 01-1.14 0L3 9.74V17h16z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
              </div>
            </div>
            <p class="field-error" *ngIf="form.get(['contato', 'email'])?.invalid && form.get(['contato', 'email'])?.touched">
              Informe um e-mail válido.
            </p>
          </label>
          <label class="field">Horário preferencial<select formControlName="horario_preferencial_contato">
              <option value="">Selecione um horário</option>
              <option *ngFor="let option of preferredContactOptions" [value]="option.value">{{ option.label }}</option>
            </select></label>
          <div class="feature-grid">
            <label class="checkbox-field"><input type="checkbox" formControlName="permite_contato_tel" /> <span>Permite contato telefônico</span></label>
            <label class="checkbox-field"><input type="checkbox" formControlName="permite_contato_whatsapp" /> <span>Permite WhatsApp</span></label>
            <label class="checkbox-field"><input type="checkbox" formControlName="permite_contato_sms" /> <span>Permite SMS</span></label>
            <label class="checkbox-field"><input type="checkbox" formControlName="permite_contato_email" /> <span>Permite e-mail</span></label>
          </div>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'documentos'" formGroupName="documentos">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('documentos') }}</p>
          <p class="muted">Organize CPF, RG, certidões e demais identificadores.</p>
        </div>
      </div>
      <div class="field-grid cols-3">
        <label class="field">CPF*<input formControlName="cpf" (input)="onCpfInput($event)" />
          <p class="field-error" *ngIf="form.get(['documentos', 'cpf'])?.invalid && form.get(['documentos', 'cpf'])?.touched">
            Informe um CPF válido.
          </p>
        </label>
        <label class="field">RG número<input formControlName="rg_numero" /></label>
        <label class="field">Órgão emissor<input formControlName="rg_orgao_emissor" /></label>
        <label class="field">Estado<input maxlength="2" formControlName="rg_uf" /></label>
        <label class="field">Data emissão<input type="date" formControlName="rg_data_emissao" /></label>
        <label class="field">NIS<input formControlName="nis" /></label>
        <label class="field">Certidão tipo<input formControlName="certidao_tipo" /></label>
        <label class="field">Livro<input formControlName="certidao_livro" /></label>
        <label class="field">Folha<input formControlName="certidao_folha" /></label>
        <label class="field">Termo<input formControlName="certidao_termo" /></label>
        <label class="field">Cartório<input formControlName="certidao_cartorio" /></label>
        <label class="field">Município<input formControlName="certidao_municipio" /></label>
        <label class="field">Estado<input maxlength="2" formControlName="certidao_uf" /></label>
        <label class="field">Título de eleitor<input formControlName="titulo_eleitor" /></label>
        <label class="field">CNH<input formControlName="cnh" /></label>
        <label class="field">Cartão SUS<input formControlName="cartao_sus" /></label>
      </div>
      <div class="document-section" formArrayName="anexos">
        <div class="document-request">
          <div class="document-request__header">
            <div>
              <p class="document-request__title">Envie seus Documentos</p>
              <p class="document-request__subtitle">Por favor, envie seus documentos para completar seu cadastro.</p>
            </div>
            <button type="button" class="ghost" (click)="addOptionalDocument()">Adicionar documento opcional</button>
          </div>
          <p class="upload-hint" *ngIf="uploadingDocuments">
            Aguarde o envio dos documentos selecionados para continuar.
          </p>
          <div class="document-request__list">
            <div
              class="document-request__card"
              *ngFor="let control of anexos.controls; index as i"
              [formGroupName]="i"
              [class.document-request__card--alert]="
                control.get('obrigatorio')?.value &&
                !control.get('nomeArquivo')?.value &&
                !control.get('conteudo')?.value
              "
            >
              <div class="document-request__icon" aria-hidden="true">
                <svg width="34" height="34" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M7 4h7l4 4v12a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1z"
                    stroke="currentColor"
                    stroke-width="1.5"
                  />
                  <path d="M14 4v4h4" stroke="currentColor" stroke-width="1.5" />
                  <path d="M8 13h8M8 16h6" stroke="currentColor" stroke-width="1.5" />
                </svg>
              </div>
              <div class="document-request__content">
                <div class="document-request__title-row">
                  <ng-container *ngIf="control.get('obrigatorio')?.value; else editableName">
                    <p class="document-request__name">{{ control.get('nome')?.value }}</p>
                  </ng-container>
                  <ng-template #editableName>
                    <input class="document-request__name-input" formControlName="nome" />
                  </ng-template>
                  <span *ngIf="control.get('obrigatorio')?.value" class="pill">Obrigatório</span>
                </div>
                <p class="document-request__description">
                  {{ control.get('nomeArquivo')?.value ? 'Arquivo anexado para conferência.' : 'Envie a foto do documento solicitado.' }}
                </p>
                <p class="document-request__status">
                  {{ control.get('nomeArquivo')?.value || 'Nenhum arquivo selecionado' }}
                </p>
                <div class="document-request__actions">
                  <label class="upload-btn upload-btn--primary">
                    Enviar arquivo
                    <input type="file" (change)="onDocumentFileSelected($event, i)" />
                  </label>
                  <button
                    type="button"
                    class="ghost"
                    *ngIf="control.get('conteudo')?.value"
                    (click)="viewDocument(i)"
                  >
                    Visualizar
                  </button>
                  <button
                    type="button"
                    class="ghost destructive"
                    *ngIf="control.get('nomeArquivo')?.value || control.get('conteudo')?.value"
                    (click)="removeUploadedDocument(i)"
                  >
                    Remover
                  </button>
                </div>
                <div class="upload-progress" *ngIf="uploadProgress[i] !== undefined">
                  <div
                    class="upload-progress__bar"
                    [style.width]="uploadProgress[i] + '%'"
                    [class.upload-progress__bar--complete]="uploadProgress[i] === 100"
                  ></div>
                  <p class="upload-progress__label">
                    {{ uploadProgress[i] === 100 ? 'Envio concluído' : 'Enviando documento...' }}
                    ({{ uploadProgress[i] }}%)
                  </p>
                </div>
              </div>
            </div>
          </div>
          <div class="document-request__footer">
            <p class="document-request__note">Formatos aceitos: JPG, PNG ou PDF. Tamanho máximo: 5MB.</p>
            <button type="button" class="primary" (click)="confirmDocuments()">Enviar documentos</button>
          </div>
        </div>
        <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
      </div>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'familiar'" formGroupName="familiar">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('familiar') }}</p>
          <p class="muted">Mapa da convivência familiar e condições de vulnerabilidade.</p>
        </div>
      </div>
      <div class="field-grid cols-2">
        <label class="checkbox-field"><input type="checkbox" formControlName="mora_com_familia" /> <span>Mora com a família</span></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="responsavel_legal" /> <span>Responsável legal</span></label>
        <label class="field">Vínculo familiar<input formControlName="vinculo_familiar" /></label>
        <label class="field">Composição familiar<textarea formControlName="composicao_familiar"></textarea></label>
        <label class="field">Crianças/adolescentes no domicílio<input type="number" formControlName="criancas_adolescentes" /></label>
        <label class="field">Idosos no domicílio<input type="number" formControlName="idosos" /></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="acompanhamento_cras" /> <span>Em acompanhamento do CRAS/CREAS</span></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="acompanhamento_saude" /> <span>Em acompanhamento pela saúde (e-SUS)</span></label>
        <label class="field">Participação comunitária<input formControlName="participa_comunidade" placeholder="Conselhos, grupos, coletivos" /></label>
        <label class="field">Rede de apoio<textarea formControlName="rede_apoio" placeholder="Instituições, vizinhos, familiares"></textarea></label>
        <label class="field full">Situação de vulnerabilidade<textarea formControlName="situacao_vulnerabilidade"></textarea></label>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'escolaridade'" formGroupName="escolaridade">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('escolaridade') }}</p>
          <p class="muted">Entenda a escolaridade, ocupação e fontes de renda.</p>
        </div>
      </div>
      <div class="field-grid cols-3">
        <label class="checkbox-field"><input type="checkbox" formControlName="sabe_ler_escrever" /> <span>Sabe ler e escrever</span></label>
        <label class="field">Nível de escolaridade<select formControlName="nivel_escolaridade">
            <option value="">Selecione</option>
            <option *ngFor="let option of educationLevelOptions" [value]="option">{{ option }}</option>
          </select></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="estuda_atualmente" /> <span>Estuda atualmente</span></label>
        <label class="field">Ocupação
          <input
            formControlName="ocupacao"
            placeholder="Informe a ocupação"
          />
        </label>
        <label class="field">Situação de trabalho<input formControlName="situacao_trabalho" /></label>
        <label class="field">Local de trabalho<input formControlName="local_trabalho" /></label>
        <label class="field">Renda mensal
          <input
            type="text"
            formControlName="renda_mensal"
            (input)="formatCurrency($event, 'escolaridade', 'renda_mensal')"
            placeholder="R$ 0,00"
          />
        </label>
        <label class="field">Fonte de renda<input formControlName="fonte_renda" /></label>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'saude'" formGroupName="saude">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('saude') }}</p>
          <p class="muted">Registro de deficiências, medicações e referência de atendimento.</p>
        </div>
      </div>
      <div class="field-grid cols-2">
        <label class="checkbox-field"><input type="checkbox" formControlName="possui_deficiencia" /> <span>Possui deficiência</span></label>
        <label class="field">Tipo de deficiência<input formControlName="tipo_deficiencia" /></label>
        <label class="field">CID principal<input formControlName="cid_principal" /></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="usa_medicacao_continua" /> <span>Usa medicação contínua</span></label>
        <label class="field full">Descrição da medicação<textarea formControlName="descricao_medicacao"></textarea></label>
        <label class="field">Serviço de saúde de referência<input formControlName="servico_saude_referencia" /></label>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'beneficios'" formGroupName="beneficios">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('beneficios') }}</p>
          <p class="muted">Indique benefícios ativos e valores aproximados.</p>
        </div>
      </div>
      <div class="field-grid cols-2">
        <label class="checkbox-field"><input type="checkbox" formControlName="recebe_beneficio" /> <span>Recebe benefício</span></label>
        <label class="field">Valor total
          <input type="text" formControlName="valor_total_beneficios" (input)="formatCurrency($event)" placeholder="R$ 0,00" />
        </label>
        <div class="field full">
          <p class="field-title">Benefícios recebidos</p>
          <div class="chips">
            <label *ngFor="let benefit of availableBenefits" class="chip">
              <input type="checkbox" [checked]="selectionChecked(benefit)" (change)="toggleBenefit(benefit)" />
              <span>{{ benefit }}</span>
            </label>
          </div>
        </div>
        <label class="field full">Descrição dos benefícios<textarea formControlName="beneficios_descricao"></textarea></label>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'observacoes'" formGroupName="observacoes">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('observacoes') }}</p>
          <p class="muted">Últimos apontamentos para complementar o cadastro.</p>
        </div>
      </div>
      <div class="field-grid cols-2">
        <label class="field">Data do aceite<input type="datetime-local" formControlName="data_aceite_lgpd" /></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="aceite_lgpd" (change)="handleLgpdToggle($event)" /> <span>Aceite LGPD*</span></label>
        <label class="field full">Observações<textarea formControlName="observacoes"></textarea></label>
        <p class="field-error full-span" *ngIf="form.get(['observacoes', 'aceite_lgpd'])?.invalid && form.get(['observacoes', 'aceite_lgpd'])?.touched">
          Confirme o aceite LGPD para continuar.
        </p>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>
  </form>

  <div class="modal" *ngIf="quickSearchModalOpen">
    <div class="modal__backdrop" (click)="closeQuickSearch()"></div>
    <div class="modal__content modal__content--wide">
      <div class="modal__header">
        <div>
          <p class="modal__eyebrow">Gestão rápida</p>
          <h3>Buscar beneficiário</h3>
        </div>
        <button type="button" class="ghost" (click)="closeQuickSearch()">Fechar</button>
      </div>
      <ng-container *ngTemplateOutlet="gestaoRapida"></ng-container>
    </div>
  </div>

  <div class="modal" *ngIf="blockReasonModalOpen">
    <div class="modal__backdrop"></div>
    <div class="modal__content">
      <h3>Motivo do bloqueio</h3>
      <p class="muted">Descreva o motivo para manter o registro bloqueado.</p>
        <textarea [formControl]="motivoBloqueioControl" rows="4"></textarea>
      <p *ngIf="blockReasonError" class="field-error">{{ blockReasonError }}</p>
      <div class="modal__actions">
        <button type="button" class="ghost" (click)="cancelBlockReason()">Cancelar</button>
        <button type="button" class="primary" (click)="confirmBlockReason()">Salvar motivo</button>
      </div>
    </div>
  </div>
</section>
