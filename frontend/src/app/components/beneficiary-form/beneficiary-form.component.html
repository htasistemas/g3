<div class="p-6 space-y-6">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <p class="text-sm text-g3-green-600 font-semibold uppercase tracking-wide">Beneficiários</p>
      <h1 class="text-2xl font-semibold text-slate-800">Cadastro de Beneficiário</h1>
      <p class="text-sm text-slate-600">Preencha os dados principais para registrar um novo beneficiário.</p>
    </div>
    <div class="flex items-center space-x-2 text-sm text-slate-600">
      <span class="inline-flex items-center rounded-full bg-green-50 text-g3-green-700 px-3 py-1 font-medium">Formulário ativo</span>
    </div>
  </div>

  <form [formGroup]="beneficiaryForm" (ngSubmit)="submit()" class="space-y-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="card space-y-4">
        <div class="card__header">Foto do beneficiário</div>
        <div class="space-y-3">
          <div class="flex justify-center">
            <div class="relative h-28 w-28 rounded-full bg-slate-100 overflow-hidden shadow-inner">
              <img *ngIf="photoPreview" [src]="photoPreview" alt="Foto do beneficiário" class="h-full w-full object-cover" />
              <div *ngIf="!photoPreview" class="h-full w-full flex items-center justify-center text-slate-400 text-sm">Prévia</div>
            </div>
          </div>

          <label class="text-sm font-medium text-slate-700">Capturar pela webcam</label>
          <div class="space-y-2">
            <video #videoElement class="w-full rounded-lg border border-dashed border-slate-300" autoplay muted playsinline></video>
            <canvas #canvasElement class="hidden"></canvas>
            <div class="flex gap-2">
              <button type="button" class="btn-outline" (click)="startCamera(videoElement)">Abrir câmera</button>
              <button type="button" class="btn-primary" [disabled]="!cameraActive" (click)="capturePhoto(videoElement, canvasElement)">
                Capturar
              </button>
              <button type="button" class="btn-outline" [disabled]="!cameraActive" (click)="stopCamera()">Fechar câmera</button>
            </div>
          </div>

          <label class="text-sm font-medium text-slate-700">Ou enviar arquivo</label>
          <input type="file" accept="image/*" (change)="handlePhotoUpload($event)" class="file-input" />
        </div>
      </div>

      <div class="card lg:col-span-2">
        <div class="card__header">Dados Pessoais</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-2">
            <label class="text-sm font-medium text-slate-700" for="fullName">Nome completo</label>
            <input
              id="fullName"
              type="text"
              formControlName="fullName"
              (input)="formatTitleCase('fullName')"
              class="input"
              placeholder="Digite o nome completo"
            />
            <p *ngIf="beneficiaryForm.get('fullName')?.touched && beneficiaryForm.get('fullName')?.invalid" class="text-xs text-red-500">
              Informe um nome válido (mínimo 3 caracteres).
            </p>
          </div>

          <div class="space-y-2">
            <label class="text-sm font-medium text-slate-700" for="motherName">Nome da mãe</label>
            <input
              id="motherName"
              type="text"
              formControlName="motherName"
              (input)="formatTitleCase('motherName')"
              class="input"
              placeholder="Digite o nome da mãe"
            />
          </div>

          <div class="space-y-2">
            <label class="text-sm font-medium text-slate-700" for="document">CPF</label>
            <input
              id="document"
              type="text"
              formControlName="document"
              (input)="onCpfInput($event)"
              class="input"
              placeholder="000.000.000-00"
            />
            <p *ngIf="beneficiaryForm.get('document')?.touched && beneficiaryForm.get('document')?.invalid" class="text-xs text-red-500">
              CPF inválido ou ausente.
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
            <div class="space-y-2">
              <label class="text-sm font-medium text-slate-700" for="birthDate">Data de nascimento</label>
              <input
                id="birthDate"
                type="date"
                formControlName="birthDate"
                class="input"
              />
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-slate-700" for="age">Idade</label>
              <input id="age" type="number" formControlName="age" class="input" placeholder="Idade" readonly />
            </div>
          </div>

          <div class="space-y-2">
            <label class="text-sm font-medium text-slate-700" for="phone">Telefone</label>
            <input
              id="phone"
              type="tel"
              formControlName="phone"
              (input)="onPhoneInput($event)"
              class="input"
              placeholder="(00) 00000-0000"
            />
            <p *ngIf="beneficiaryForm.get('phone')?.touched && beneficiaryForm.get('phone')?.invalid" class="text-xs text-red-500">
              Informe um telefone válido com DDD.
            </p>
          </div>

          <div class="space-y-2">
            <label class="text-sm font-medium text-slate-700" for="email">E-mail</label>
            <input
              id="email"
              type="email"
              formControlName="email"
              class="input"
              placeholder="email@exemplo.com"
            />
            <p *ngIf="beneficiaryForm.get('email')?.touched && beneficiaryForm.get('email')?.invalid" class="text-xs text-red-500">
              E-mail inválido.
            </p>
          </div>

          <div class="space-y-2">
            <label class="text-sm font-medium text-slate-700" for="status">Status do cadastro</label>
            <select id="status" formControlName="status" class="input">
              <option value="Ativo">Ativo</option>
              <option value="Inativo">Inativo</option>
              <option value="Em análise">Em análise</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card__header">Informações familiares e socioeconômicas</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700" for="hasMinorChildren">Possui filhos menores?</label>
          <label class="inline-flex items-center gap-2 text-sm text-slate-700">
            <input type="checkbox" id="hasMinorChildren" formControlName="hasMinorChildren" class="h-4 w-4" />
            <span>Sim</span>
          </label>
          <p class="text-xs text-slate-500">Quando marcado, a certidão de nascimento passa a ser obrigatória.</p>
        </div>

        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700" for="minorChildrenCount">Quantidade de filhos menores</label>
          <input
            id="minorChildrenCount"
            type="number"
            formControlName="minorChildrenCount"
            class="input"
            placeholder="0"
            min="0"
          />
          <p
            *ngIf="beneficiaryForm.get('minorChildrenCount')?.touched && beneficiaryForm.get('minorChildrenCount')?.invalid"
            class="text-xs text-red-500"
          >
            Informe a quantidade de filhos menores.
          </p>
        </div>

        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700" for="educationLevel">Escolaridade</label>
          <input
            id="educationLevel"
            type="text"
            formControlName="educationLevel"
            class="input"
            placeholder="Ensino médio completo"
          />
        </div>

        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700" for="individualIncome">Renda individual</label>
          <input
            id="individualIncome"
            type="number"
            step="0.01"
            formControlName="individualIncome"
            class="input"
            placeholder="0,00"
          />
        </div>

        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700" for="familyIncome">Renda total da família</label>
          <input
            id="familyIncome"
            type="number"
            step="0.01"
            formControlName="familyIncome"
            class="input"
            placeholder="0,00"
          />
        </div>

        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700" for="employmentStatus">Situação de trabalho</label>
          <input
            id="employmentStatus"
            type="text"
            formControlName="employmentStatus"
            class="input"
            placeholder="Empregado, autônomo, desempregado..."
          />
        </div>

        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700" for="occupation">Ocupação</label>
          <input
            id="occupation"
            type="text"
            formControlName="occupation"
            class="input"
            placeholder="Profissão ou atividade"
          />
        </div>

        <div class="space-y-2 md:col-span-2">
          <label class="text-sm font-medium text-slate-700" for="housingInformation">Informações sobre a moradia</label>
          <textarea
            id="housingInformation"
            formControlName="housingInformation"
            rows="3"
            class="input"
            placeholder="Tipo de moradia, condições estruturais, acesso a energia, água, etc."
          ></textarea>
        </div>

        <div class="space-y-2 md:col-span-2">
          <label class="text-sm font-medium text-slate-700" for="sanitationConditions">Condições de saneamento básico</label>
          <textarea
            id="sanitationConditions"
            formControlName="sanitationConditions"
            rows="3"
            class="input"
            placeholder="Abastecimento de água, coleta de lixo, rede de esgoto, outras observações"
          ></textarea>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card__header">Endereço</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700" for="zipCode">CEP</label>
          <input
            id="zipCode"
            type="text"
            formControlName="zipCode"
            (input)="handleCepInput($event)"
            class="input"
            placeholder="00000-000"
          />
          <p *ngIf="beneficiaryForm.get('zipCode')?.touched && beneficiaryForm.get('zipCode')?.invalid" class="text-xs text-red-500">
            <ng-container *ngIf="beneficiaryForm.get('zipCode')?.errors?.['cep']">Informe um CEP com 8 dígitos.</ng-container>
            <ng-container *ngIf="beneficiaryForm.get('zipCode')?.errors?.['invalidCep']">CEP não encontrado.</ng-container>
          </p>
        </div>

        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700" for="addressNumber">Número</label>
          <input
            id="addressNumber"
            type="text"
            formControlName="addressNumber"
            class="input"
            placeholder="Número da residência"
          />
          <p *ngIf="beneficiaryForm.get('addressNumber')?.touched && beneficiaryForm.get('addressNumber')?.invalid" class="text-xs text-red-500">
            Informe o número da residência.
          </p>
        </div>

        <div class="space-y-2 md:col-span-2">
          <label class="text-sm font-medium text-slate-700" for="address">Endereço</label>
          <input
            id="address"
            type="text"
            formControlName="address"
            (input)="formatTitleCase('address')"
            class="input"
            placeholder="Rua ou avenida"
          />
          <p *ngIf="beneficiaryForm.get('address')?.touched && beneficiaryForm.get('address')?.invalid" class="text-xs text-red-500">
            Endereço é obrigatório.
          </p>
        </div>

        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700" for="referencePoint">Ponto de referência</label>
          <input
            id="referencePoint"
            type="text"
            formControlName="referencePoint"
            class="input"
            placeholder="Próximo a..."
          />
        </div>

        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700" for="neighborhood">Bairro</label>
          <input
            id="neighborhood"
            type="text"
            formControlName="neighborhood"
            (input)="formatTitleCase('neighborhood')"
            class="input"
            placeholder="Digite o bairro"
          />
        </div>

        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700" for="city">Cidade</label>
          <input
            id="city"
            type="text"
            formControlName="city"
            (input)="formatTitleCase('city')"
            class="input"
            placeholder="Informe a cidade"
          />
        </div>

        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700" for="state">Estado</label>
          <select id="state" formControlName="state" class="input">
            <option value="" disabled>Selecione</option>
            <option *ngFor="let state of states" [value]="state">{{ state }}</option>
          </select>
        </div>

        <div class="space-y-2 md:col-span-2">
          <label class="text-sm font-medium text-slate-700" for="notes">Observações</label>
          <textarea
            id="notes"
            formControlName="notes"
            rows="4"
            class="input"
            placeholder="Detalhes adicionais sobre o beneficiário"
          ></textarea>
        </div>
      </div>
    </div>

    <div class="card space-y-4">
      <div class="card__header">Documentos Obrigatórios</div>
      <p class="text-sm text-slate-600">Envie um arquivo para cada documento listado abaixo.</p>
      <input type="hidden" formControlName="documentFiles" />

      <div class="space-y-3">
        <div
          class="flex flex-col md:flex-row md:items-center justify-between gap-3 border border-slate-200 rounded-lg p-3 bg-slate-50"
          *ngFor="let doc of requiredDocuments"
        >
          <div>
            <div class="flex items-center gap-2">
              <p class="text-sm font-semibold text-slate-800">{{ doc.name }}</p>
              <span
                class="inline-flex items-center px-2 py-0.5 text-[11px] font-semibold rounded-full"
                [ngClass]="{
                  'bg-amber-100 text-amber-700': doc.required,
                  'bg-slate-100 text-slate-600': !doc.required
                }"
              >
                {{ doc.required ? 'Obrigatório' : 'Opcional' }}
              </span>
            </div>
            <p class="text-xs text-slate-500">{{ doc.fileName ? 'Arquivo: ' + doc.fileName : 'Nenhum arquivo selecionado' }}</p>
          </div>
          <input type="file" (change)="onDocumentUpload($event, doc.name)" class="file-input" />
        </div>
      </div>

      <p *ngIf="beneficiaryForm.get('documentFiles')?.touched && beneficiaryForm.get('documentFiles')?.invalid" class="text-xs text-red-500">
        Documentos obrigatórios pendentes: {{ missingRequiredDocuments.join(', ') }}.
      </p>

      <div class="flex items-center gap-3 pt-2">
        <span class="text-sm font-medium text-slate-700">Status do cadastro:</span>
        <span class="inline-flex items-center rounded-full px-3 py-1 text-sm" [ngClass]="{
          'bg-green-50 text-g3-green-700': documentStatus === 'Enviado',
          'bg-orange-50 text-orange-700': documentStatus === 'Pendente'
        }">{{ documentStatus }}</span>
      </div>
    </div>

    <div class="flex justify-end gap-3 px-6 py-4 border border-slate-200 bg-white rounded-xl shadow-sm">
      <button type="button" class="btn-outline" (click)="resetForm()">Limpar</button>
      <button type="submit" class="btn-primary">{{ editingId ? 'Atualizar cadastro' : 'Salvar cadastro' }}</button>
      <span
        *ngIf="saveFeedback"
        [ngClass]="{ 'text-g3-green-700': saveFeedback.type === 'success', 'text-red-600': saveFeedback.type === 'error' }"
        class="text-sm font-medium"
      >
        {{ saveFeedback.message }}
      </span>
    </div>
  </form>

  <div class="card space-y-4">
    <div class="card__header">Beneficiários cadastrados</div>
    <p class="text-sm text-slate-600" *ngIf="!beneficiaries.length">Nenhum beneficiário cadastrado.</p>
    <div class="overflow-x-auto" *ngIf="beneficiaries.length">
      <table class="min-w-full text-sm text-slate-700">
        <thead>
          <tr class="text-left border-b border-slate-200">
            <th class="py-2 pr-4">Nome</th>
            <th class="py-2 pr-4">CPF</th>
            <th class="py-2 pr-4">Status</th>
            <th class="py-2 pr-4">Cidade/UF</th>
            <th class="py-2">Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let beneficiary of beneficiaries" class="border-b border-slate-100">
            <td class="py-2 pr-4 font-semibold">{{ beneficiary.fullName }}</td>
            <td class="py-2 pr-4">{{ beneficiary.document }}</td>
            <td class="py-2 pr-4">{{ beneficiary.status }}</td>
            <td class="py-2 pr-4">{{ beneficiary.city }}/{{ beneficiary.state }}</td>
            <td class="py-2">
              <button type="button" class="btn-outline" (click)="startEdit(beneficiary)">Editar</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
