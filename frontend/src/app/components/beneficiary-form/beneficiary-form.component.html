<div class="p-6 space-y-5">
  <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <div>
      <p class="text-sm font-semibold text-g3-green-700 uppercase">Beneficiários</p>
      <h1 class="text-3xl font-semibold text-slate-900">Cadastro de beneficiário</h1>
      <p class="text-sm text-slate-600">Organize os dados em abas sem rolagem prolongada.</p>
    </div>
    <div class="flex flex-wrap gap-2">
      <button type="button" class="btn-outline" (click)="startNew()">Novo</button>
      <button type="button" class="btn-primary" (click)="submit()" [disabled]="isSubmitting">
        {{ isSubmitting ? 'Salvando...' : 'Salvar' }}
      </button>
      <button type="button" class="btn-outline" (click)="cancel()">Cancelar</button>
      <button type="button" class="btn-ghost" (click)="goBack()">Voltar para lista</button>
    </div>
  </div>

  <div *ngIf="feedback" class="alert" [class.alert-success]="feedback.type === 'success'" [class.alert-error]="feedback.type === 'error'">
    {{ feedback.message }}
  </div>

  <nav class="tab-list" aria-label="Etapas do cadastro">
    <button type="button" class="tab-list__item" [class.tab-list__item--active]="activeTab === 'personal'" (click)="setActiveTab('personal')">
      Dados pessoais
    </button>
    <button type="button" class="tab-list__item" [class.tab-list__item--active]="activeTab === 'address'" (click)="setActiveTab('address')">
      Endereço
    </button>
    <button type="button" class="tab-list__item" [class.tab-list__item--active]="activeTab === 'contact'" (click)="setActiveTab('contact')">
      Contato
    </button>
    <button type="button" class="tab-list__item" [class.tab-list__item--active]="activeTab === 'documents'" (click)="setActiveTab('documents')">
      Documentos
    </button>
    <button type="button" class="tab-list__item" [class.tab-list__item--active]="activeTab === 'socio'" (click)="setActiveTab('socio')">
      Informações familiares e socioeconômicas
    </button>
  </nav>

  <form [formGroup]="beneficiaryForm" class="card tab-panel">
    <section *ngIf="activeTab === 'personal'" class="space-y-4">
      <h2 class="card__header">Dados pessoais</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="field-group">
          <label for="nomeCompleto">Nome completo *</label>
          <input
            id="nomeCompleto"
            type="text"
            class="input"
            formControlName="nomeCompleto"
            (input)="formatTitleCase('nomeCompleto')"
            placeholder="Digite o nome completo"
          />
          <p *ngIf="beneficiaryForm.get('nomeCompleto')?.invalid && beneficiaryForm.get('nomeCompleto')?.touched" class="field-error">
            Informe um nome válido.
          </p>
        </div>
        <div class="field-group">
          <label for="cpf">CPF *</label>
          <input
            id="cpf"
            type="text"
            class="input"
            formControlName="cpf"
            (input)="onCpfInput($event)"
            placeholder="000.000.000-00"
          />
          <p *ngIf="beneficiaryForm.get('cpf')?.invalid && beneficiaryForm.get('cpf')?.touched" class="field-error">CPF inválido.</p>
        </div>
        <div class="field-group">
          <label for="rg">RG</label>
          <input id="rg" type="text" class="input" formControlName="rg" placeholder="Número do RG" />
        </div>
        <div class="grid grid-cols-[2fr_1fr] gap-3">
          <div class="field-group">
            <label for="orgaoEmissor">Órgão emissor</label>
            <input id="orgaoEmissor" type="text" class="input" formControlName="orgaoEmissor" placeholder="SSP" />
          </div>
          <div class="field-group">
            <label for="ufEmissor">UF</label>
            <select id="ufEmissor" class="input" formControlName="ufEmissor">
              <option value="">Selecione</option>
              <option *ngFor="let state of states" [value]="state">{{ state }}</option>
            </select>
          </div>
        </div>
        <div class="field-group">
          <label for="dataNascimento">Data de nascimento *</label>
          <input id="dataNascimento" type="date" class="input" formControlName="dataNascimento" />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="field-group">
            <label for="sexo">Sexo</label>
            <select id="sexo" class="input" formControlName="sexo">
              <option value="">Selecione</option>
              <option value="Feminino">Feminino</option>
              <option value="Masculino">Masculino</option>
              <option value="Outro">Outro</option>
            </select>
          </div>
          <div class="field-group">
            <label for="estadoCivil">Estado civil</label>
            <select id="estadoCivil" class="input" formControlName="estadoCivil">
              <option value="">Selecione</option>
              <option value="Solteiro(a)">Solteiro(a)</option>
              <option value="Casado(a)">Casado(a)</option>
              <option value="Divorciado(a)">Divorciado(a)</option>
              <option value="Viúvo(a)">Viúvo(a)</option>
              <option value="União estável">União estável</option>
            </select>
          </div>
        </div>
        <div class="field-group">
          <label for="nomeMae">Nome da mãe</label>
          <input
            id="nomeMae"
            type="text"
            class="input"
            formControlName="nomeMae"
            (input)="formatTitleCase('nomeMae')"
            placeholder="Digite o nome da mãe"
          />
        </div>
        <div class="field-group">
          <label for="nis">NIS / Número do benefício</label>
          <input id="nis" type="text" class="input" formControlName="nis" placeholder="Número do benefício" />
        </div>
      </div>
    </section>

    <section *ngIf="activeTab === 'address'" class="space-y-4">
      <h2 class="card__header">Endereço</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="field-group">
          <label for="cep">CEP</label>
          <input
            id="cep"
            type="text"
            class="input"
            formControlName="cep"
            (input)="handleCepInput($event)"
            placeholder="00000-000"
          />
        </div>
        <div class="md:col-span-2 field-group">
          <label for="logradouro">Logradouro</label>
          <input id="logradouro" type="text" class="input" formControlName="logradouro" placeholder="Rua/Avenida" />
        </div>
        <div class="field-group">
          <label for="numero">Número</label>
          <input id="numero" type="text" class="input" formControlName="numero" placeholder="Número" />
        </div>
        <div class="field-group">
          <label for="complemento">Complemento</label>
          <input id="complemento" type="text" class="input" formControlName="complemento" placeholder="Apartamento, bloco" />
        </div>
        <div class="field-group">
          <label for="bairro">Bairro</label>
          <input id="bairro" type="text" class="input" formControlName="bairro" (input)="formatTitleCase('bairro')" />
        </div>
        <div class="field-group">
          <label for="cidade">Cidade</label>
          <input id="cidade" type="text" class="input" formControlName="cidade" (input)="formatTitleCase('cidade')" />
        </div>
        <div class="field-group">
          <label for="uf">UF</label>
          <select id="uf" class="input" formControlName="uf">
            <option value="">Selecione</option>
            <option *ngFor="let state of states" [value]="state">{{ state }}</option>
          </select>
        </div>
        <div class="md:col-span-2 field-group">
          <label for="pontoReferencia">Ponto de referência</label>
          <input id="pontoReferencia" type="text" class="input" formControlName="pontoReferencia" />
        </div>
      </div>
    </section>

    <section *ngIf="activeTab === 'contact'" class="space-y-4">
      <h2 class="card__header">Contato</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="field-group">
          <label for="telefoneFixo">Telefone fixo</label>
          <input
            id="telefoneFixo"
            type="text"
            class="input"
            formControlName="telefoneFixo"
            (input)="onPhoneInput('telefoneFixo', $event)"
            placeholder="(00) 0000-0000"
          />
        </div>
        <div class="field-group">
          <label for="celular">Celular / WhatsApp *</label>
          <input
            id="celular"
            type="text"
            class="input"
            formControlName="celular"
            (input)="onPhoneInput('celular', $event)"
            placeholder="(00) 00000-0000"
          />
          <p *ngIf="beneficiaryForm.get('celular')?.invalid && beneficiaryForm.get('celular')?.touched" class="field-error">
            Informe um celular válido.
          </p>
        </div>
        <div class="field-group">
          <label for="email">E-mail</label>
          <input id="email" type="email" class="input" formControlName="email" placeholder="email@exemplo.com" />
        </div>
      </div>
    </section>

    <section *ngIf="activeTab === 'documents'" class="space-y-4">
      <div class="flex flex-col gap-2">
        <h2 class="card__header">Documentos</h2>
        <p class="text-sm text-slate-600">Adicione anexos e acompanhe os documentos obrigatórios definidos em Configurações.</p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-[2fr_3fr] gap-4">
        <div class="card card--sub" [formGroup]="documentForm">
          <h3 class="card__header">Novo documento</h3>
          <div class="space-y-3">
            <div class="field-group">
              <label for="tipo">Tipo *</label>
              <input id="tipo" type="text" class="input" formControlName="tipo" placeholder="RG, CPF, Cartão SUS..." />
              <p *ngIf="documentForm.get('tipo')?.invalid && documentForm.get('tipo')?.touched" class="field-error">
                Informe o tipo do documento.
              </p>
            </div>
            <div class="field-group">
              <label for="numeroDoc">Número</label>
              <input id="numeroDoc" type="text" class="input" formControlName="numero" />
            </div>
            <div class="field-group">
              <label for="dataEmissao">Data de emissão</label>
              <input id="dataEmissao" type="date" class="input" formControlName="dataEmissao" />
            </div>
            <div class="field-group">
              <label for="arquivo">Arquivo</label>
              <input id="arquivo" type="file" class="file-input" (change)="onDocumentFileChange($event)" />
            </div>
            <button type="button" class="btn-primary w-full" (click)="addDocument()">Adicionar documento</button>
          </div>
        </div>

        <div class="card card--sub">
          <div class="flex items-center justify-between">
            <h3 class="card__header">Documentos anexados</h3>
            <span class="text-xs text-slate-600">Obrigatórios: {{ requiredMandatoryCount }}</span>
          </div>
          <div class="overflow-hidden border border-slate-200 rounded-xl">
            <table class="min-w-full divide-y divide-slate-200">
              <thead class="bg-slate-50">
                <tr>
                  <th class="table-head">Tipo</th>
                  <th class="table-head">Arquivo</th>
                  <th class="table-head">Emissão</th>
                  <th class="table-head text-right">Ações</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-200" *ngIf="uploadedDocuments.length; else noDocuments">
                <tr *ngFor="let doc of uploadedDocuments; index as i" class="hover:bg-slate-50">
                  <td class="table-cell">
                    <div class="flex items-center gap-2">
                      <span>{{ doc.tipo }}</span>
                      <span *ngIf="documentIsRequired(doc.tipo)" class="badge badge-required">Obrigatório</span>
                    </div>
                  </td>
                  <td class="table-cell">{{ doc.nomeArquivo || 'Não enviado' }}</td>
                  <td class="table-cell">{{ doc.dataEmissao || '-' }}</td>
                  <td class="table-cell text-right">
                    <button type="button" class="btn-ghost" (click)="removeDocument(i)">Remover</button>
                  </td>
                </tr>
              </tbody>
            </table>
            <ng-template #noDocuments>
              <div class="text-center py-6 text-slate-600">Nenhum documento anexado.</div>
            </ng-template>
          </div>
        </div>
      </div>
    </section>

    <section *ngIf="activeTab === 'socio'" class="space-y-4">
      <h2 class="card__header">Informações familiares e socioeconômicas</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="field-group">
          <label for="situacaoMoradia">Situação de moradia</label>
          <select id="situacaoMoradia" class="input" formControlName="situacaoMoradia">
            <option value="">Selecione</option>
            <option value="Própria">Própria</option>
            <option value="Alugada">Alugada</option>
            <option value="Cedida">Cedida</option>
            <option value="Outra">Outra</option>
          </select>
        </div>
        <div class="field-group">
          <label for="pessoasResidencia">Quantidade de pessoas na residência</label>
          <input id="pessoasResidencia" type="number" min="1" class="input" formControlName="pessoasResidencia" />
        </div>
        <div class="field-group">
          <label for="rendaFamiliar">Renda familiar total</label>
          <input id="rendaFamiliar" type="number" step="0.01" min="0" class="input" formControlName="rendaFamiliar" />
        </div>
        <div class="field-group">
          <label for="rendaPerCapita">Renda per capita</label>
          <input id="rendaPerCapita" type="number" class="input" formControlName="rendaPerCapita" readonly />
        </div>
        <div class="field-group">
          <label for="situacaoTrabalho">Situação de trabalho</label>
          <select id="situacaoTrabalho" class="input" formControlName="situacaoTrabalho">
            <option value="">Selecione</option>
            <option value="Empregado">Empregado</option>
            <option value="Desempregado">Desempregado</option>
            <option value="Autônomo">Autônomo</option>
            <option value="Aposentado">Aposentado</option>
          </select>
        </div>
        <div class="field-group">
          <label for="escolaridade">Escolaridade</label>
          <input id="escolaridade" type="text" class="input" formControlName="escolaridade" />
        </div>
        <div class="field-group md:col-span-2">
          <label for="programasSociais">Programas sociais</label>
          <input id="programasSociais" type="text" class="input" formControlName="programasSociais" placeholder="Bolsa Família, BPC..." />
        </div>
        <div class="field-group md:col-span-3">
          <label for="observacoes">Observações gerais</label>
          <textarea id="observacoes" class="input" rows="3" formControlName="observacoes"></textarea>
        </div>
      </div>
    </section>
  </form>
</div>
