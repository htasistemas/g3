<div class="p-6 space-y-4 form-compact family-form">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <p class="text-sm text-g3-green-600 font-semibold uppercase tracking-wide">Famílias</p>
      <h1 class="text-2xl font-semibold text-slate-800">Cadastro de Família</h1>
      <p class="text-sm text-slate-600">Organize os dados da família por abas para facilitar a navegação.</p>
    </div>
    <div class="flex items-center space-x-2 text-sm text-slate-600">
      <span class="inline-flex items-center rounded-full bg-green-50 text-g3-green-700 px-3 py-1 font-medium">Formulário ativo</span>
    </div>
  </div>

  <nav class="tab-list" aria-label="Etapas do cadastro da família">
    <button
      type="button"
      class="tab-list__item"
      [class.tab-list__item--active]="activeTab === 'family'"
      (click)="setActiveTab('family')"
    >
      Dados da família
      <span *ngIf="tabHasErrors('family')" class="tab-list__badge" aria-label="Aba com erros"></span>
    </button>
    <button
      type="button"
      class="tab-list__item"
      [class.tab-list__item--active]="activeTab === 'address'"
      (click)="setActiveTab('address')"
    >
      Endereço
      <span *ngIf="tabHasErrors('address')" class="tab-list__badge" aria-label="Aba com erros"></span>
    </button>
    <button
      type="button"
      class="tab-list__item"
      [class.tab-list__item--active]="activeTab === 'members'"
      (click)="setActiveTab('members')"
    >
      Beneficiários
      <span *ngIf="tabHasErrors('members')" class="tab-list__badge" aria-label="Aba com erros"></span>
    </button>
    <button
      type="button"
      class="tab-list__item"
      [class.tab-list__item--active]="activeTab === 'documents'"
      (click)="setActiveTab('documents')"
    >
      Documentos
      <span *ngIf="tabHasErrors('documents')" class="tab-list__badge" aria-label="Aba com erros"></span>
    </button>
    <button
      type="button"
      class="tab-list__item"
      [class.tab-list__item--active]="activeTab === 'notes'"
      (click)="setActiveTab('notes')"
    >
      Observações
      <span *ngIf="tabHasErrors('notes')" class="tab-list__badge" aria-label="Aba com erros"></span>
    </button>
  </nav>

  <form [formGroup]="beneficiaryForm" (ngSubmit)="submit()" class="space-y-3">
    <section *ngIf="activeTab === 'family'" class="tab-panel space-y-3">
      <div class="card">
        <div class="card__header">Dados da família</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="field-group">
            <label class="text-sm font-medium text-slate-700" for="nomeCompleto">Identificação da família</label>
            <input
              id="nomeCompleto"
              type="text"
              formControlName="nomeCompleto"
              (input)="formatTitleCase('nomeCompleto')"
              class="input"
              placeholder="Nome da família ou responsável"
            />
            <p *ngIf="beneficiaryForm.get('nomeCompleto')?.touched && beneficiaryForm.get('nomeCompleto')?.invalid" class="text-xs text-red-500">
              Informe um nome válido (mínimo 3 caracteres).
            </p>
          </div>

          <div class="field-group">
            <label class="text-sm font-medium text-slate-700" for="documentos">CPF/Documento do responsável</label>
            <input
              id="documentos"
              type="text"
              formControlName="documentos"
              (input)="onCpfInput($event)"
              class="input"
              placeholder="000.000.000-00"
            />
            <p *ngIf="beneficiaryForm.get('documentos')?.touched && beneficiaryForm.get('documentos')?.invalid" class="text-xs text-red-500">
              CPF inválido ou ausente.
            </p>
          </div>

          <div class="field-group">
            <label class="text-sm font-medium text-slate-700" for="telefone">Telefone/WhatsApp</label>
            <input
              id="telefone"
              type="text"
              formControlName="telefone"
              (input)="onPhoneInput($event)"
              class="input"
              placeholder="(00) 00000-0000"
            />
            <p *ngIf="beneficiaryForm.get('telefone')?.touched && beneficiaryForm.get('telefone')?.invalid" class="text-xs text-red-500">
              Informe um telefone válido.
            </p>
          </div>

          <div class="field-group">
            <label class="text-sm font-medium text-slate-700" for="email">E-mail de contato</label>
            <input id="email" type="email" formControlName="email" class="input" placeholder="email@dominio.com" />
            <p *ngIf="beneficiaryForm.get('email')?.touched && beneficiaryForm.get('email')?.invalid" class="text-xs text-red-500">
              E-mail inválido.
            </p>
          </div>

          <div class="field-group">
            <label class="text-sm font-medium text-slate-700" for="status">Situação da família</label>
            <select id="status" formControlName="status" class="input">
              <option value="Ativo">Ativo</option>
              <option value="Inativo">Inativo</option>
              <option value="Em análise">Em análise</option>
              <option value="Bloqueado">Bloqueado</option>
            </select>
          </div>

          <div class="field-group">
            <label class="text-sm font-medium text-slate-700" for="nomeMae">Referência familiar</label>
            <input
              id="nomeMae"
              type="text"
              formControlName="nomeMae"
              (input)="formatTitleCase('nomeMae')"
              class="input"
              placeholder="Outro responsável ou contato"
            />
          </div>

          <div class="field-group" *ngIf="beneficiaryForm.get('status')?.value === 'Bloqueado'">
            <label class="text-sm font-medium text-slate-700" for="motivoBloqueio">Motivo do bloqueio</label>
            <textarea id="motivoBloqueio" formControlName="motivoBloqueio" rows="3" class="input" placeholder="Descreva o motivo"></textarea>
            <p *ngIf="beneficiaryForm.get('motivoBloqueio')?.touched && beneficiaryForm.get('motivoBloqueio')?.invalid" class="text-xs text-red-500">
              Informe o motivo do bloqueio.
            </p>
          </div>
        </div>
      </div>
    </section>

    <section *ngIf="activeTab === 'address'" class="tab-panel space-y-3">
      <div class="card">
        <div class="card__header">Endereço da família</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="field-group">
            <label class="text-sm font-medium text-slate-700" for="cep">CEP</label>
            <div class="grid grid-cols-[1fr_auto] gap-3 items-end">
              <div>
                <input
                  id="cep"
                  type="text"
                  formControlName="cep"
                  (input)="handleCepInput($event)"
                  class="input"
                  placeholder="00000-000"
                />
                <p *ngIf="beneficiaryForm.get('cep')?.touched && beneficiaryForm.get('cep')?.invalid" class="text-xs text-red-500">
                  <ng-container *ngIf="beneficiaryForm.get('cep')?.errors?.['cep']">Informe um CEP com 8 dígitos.</ng-container>
                  <ng-container *ngIf="beneficiaryForm.get('cep')?.errors?.['invalidCep']">CEP não encontrado.</ng-container>
                </p>
              </div>
            </div>
          </div>

          <div class="field-group md:w-full">
            <label class="text-sm font-medium text-slate-700" for="bairro">Bairro</label>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <input id="bairro" type="text" formControlName="bairro" (input)="formatTitleCase('bairro')" class="input" placeholder="Digite o bairro" />
              <div>
                <label class="text-sm font-medium text-slate-700" for="pontoReferencia">Ponto de referência</label>
                <input
                  id="pontoReferencia"
                  type="text"
                  formControlName="pontoReferencia"
                  class="input"
                  placeholder="Próximo a..."
                />
              </div>
            </div>
          </div>

          <div class="md:col-span-2 field-group">
            <label class="text-sm font-medium text-slate-700" for="endereco">Logradouro e número</label>
            <div class="grid grid-cols-[2fr_1fr] gap-3 items-end">
              <div class="field-group m-0">
                <input
                  id="endereco"
                  type="text"
                  formControlName="endereco"
                  (input)="formatTitleCase('endereco')"
                  class="input"
                  placeholder="Rua ou avenida"
                />
                <p *ngIf="beneficiaryForm.get('endereco')?.touched && beneficiaryForm.get('endereco')?.invalid" class="text-xs text-red-500">Endereço é obrigatório.</p>
              </div>
              <div class="field-group m-0">
                <label class="text-sm font-medium text-slate-700" for="numeroEndereco">Número</label>
                <input id="numeroEndereco" type="text" formControlName="numeroEndereco" class="input" placeholder="Número" />
                <p *ngIf="beneficiaryForm.get('numeroEndereco')?.touched && beneficiaryForm.get('numeroEndereco')?.invalid" class="text-xs text-red-500">Informe o número da residência.</p>
              </div>
            </div>
          </div>

          <div class="field-group md:col-span-2">
            <label class="text-sm font-medium text-slate-700" for="cidade">Cidade e UF</label>
            <div class="grid grid-cols-[2fr_1fr] gap-3">
              <input id="cidade" type="text" formControlName="cidade" (input)="formatTitleCase('cidade')" class="input" placeholder="Informe a cidade" />
              <select id="estado" formControlName="estado" class="input">
                <option value="" disabled>UF</option>
                <option *ngFor="let state of states" [value]="state">{{ state }}</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section *ngIf="activeTab === 'members'" class="tab-panel space-y-3">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
        <div class="card space-y-3 photo-card">
          <div class="card__header">Foto do beneficiário</div>
          <div class="space-y-3">
            <div class="flex justify-center">
              <div class="relative photo-card__preview rounded-lg bg-slate-100 overflow-hidden shadow-inner flex items-center justify-center">
                <img *ngIf="photoPreview" [src]="photoPreview" alt="Foto do beneficiário" class="h-full w-full object-cover" />
                <div *ngIf="!photoPreview" class="h-full w-full flex items-center justify-center text-slate-400 text-sm">Prévia</div>
              </div>
            </div>

            <label class="text-sm font-medium text-slate-700">Capturar pela webcam</label>
            <div class="space-y-2">
              <video
                #videoElement
                class="w-full rounded-lg border border-dashed border-slate-300 min-h-36 bg-black/30 object-cover"
                autoplay
                muted
                playsinline
                [class.opacity-0]="!cameraActive"
              ></video>
              <canvas #canvasElement class="hidden"></canvas>
              <div class="flex gap-2 justify-center">
                <button type="button" class="btn-outline" [disabled]="cameraActive" (click)="startCamera(videoElement)">Abrir câmera</button>
                <button type="button" class="btn-primary" [disabled]="!cameraReady" (click)="capturePhoto(videoElement, canvasElement)">
                  Capturar
                </button>
              </div>
              <p class="text-xs text-slate-500 text-center">Aguarde a câmera inicializar para habilitar a captura.</p>
            </div>

            <label class="text-sm font-medium text-slate-700">Ou enviar arquivo</label>
            <input type="file" accept="image/*" (change)="handlePhotoUpload($event)" class="file-input" />
          </div>
        </div>

        <div class="card lg:col-span-2 space-y-3">
          <div class="card__header">Dados do beneficiário</div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="field-group">
              <label class="text-sm font-medium text-slate-700" for="dataNascimento">Data de nascimento</label>
              <input id="dataNascimento" type="date" formControlName="dataNascimento" class="input" />
            </div>
            <div class="field-group">
              <label class="text-sm font-medium text-slate-700" for="idade">Idade</label>
              <input id="idade" type="number" formControlName="idade" class="input" placeholder="Idade" readonly />
            </div>

            <div class="field-group">
              <label class="text-sm font-medium text-slate-700" for="escolaridade">Escolaridade</label>
              <input id="escolaridade" type="text" formControlName="escolaridade" class="input" placeholder="Ensino médio completo" />
            </div>

            <div class="field-group">
              <label class="text-sm font-medium text-slate-700" for="rendaIndividual">Renda individual</label>
              <input id="rendaIndividual" type="number" step="0.01" formControlName="rendaIndividual" class="input" placeholder="0,00" />
            </div>

            <div class="field-group">
              <label class="text-sm font-medium text-slate-700" for="rendaFamiliar">Renda total da família</label>
              <input id="rendaFamiliar" type="number" step="0.01" formControlName="rendaFamiliar" class="input" placeholder="0,00" />
            </div>

            <div class="field-group">
              <label class="text-sm font-medium text-slate-700" for="situacaoEmprego">Situação de trabalho</label>
              <input id="situacaoEmprego" type="text" formControlName="situacaoEmprego" class="input" placeholder="Empregado, autônomo, desempregado..." />
            </div>

            <div class="field-group">
              <label class="text-sm font-medium text-slate-700" for="ocupacao">Ocupação</label>
              <input id="ocupacao" type="text" formControlName="ocupacao" class="input" placeholder="Profissão ou atividade" />
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card__header">Informações familiares e socioeconômicas</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="field-group">
            <label class="text-sm font-medium text-slate-700" for="possuiFilhosMenores">Possui filhos menores?</label>
            <label class="inline-flex items-center gap-3 text-sm text-slate-700 pl-px">
              <input type="checkbox" id="possuiFilhosMenores" formControlName="possuiFilhosMenores" class="h-4 w-4" />
              <span>Sim</span>
            </label>
            <p class="text-xs text-slate-500">Quando marcado, a certidão de nascimento passa a ser obrigatória.</p>
          </div>

          <div class="field-group">
            <label class="text-sm font-medium text-slate-700" for="possuiCnh">Beneficiário habilitado?</label>
            <label class="inline-flex items-center gap-2 text-sm text-slate-700">
              <input type="checkbox" id="possuiCnh" formControlName="possuiCnh" class="h-4 w-4" />
              <span>Sim</span>
            </label>
            <p class="text-xs text-slate-500">Quando marcado, o envio da CNH torna-se obrigatório.</p>
          </div>

          <div class="field-group">
            <label class="text-sm font-medium text-slate-700" for="quantidadeFilhosMenores">Quantidade de filhos menores</label>
            <input id="quantidadeFilhosMenores" type="number" formControlName="quantidadeFilhosMenores" class="input" placeholder="0" min="0" />
            <p *ngIf="beneficiaryForm.get('quantidadeFilhosMenores')?.touched && beneficiaryForm.get('quantidadeFilhosMenores')?.invalid" class="text-xs text-red-500">
              Informe a quantidade de filhos menores.
            </p>
          </div>

          <div class="field-group md:col-span-2">
            <label class="text-sm font-medium text-slate-700" for="informacoesMoradia">Informações sobre a moradia</label>
            <textarea id="informacoesMoradia" formControlName="informacoesMoradia" rows="3" class="input" placeholder="Condições gerais da moradia"></textarea>
          </div>

          <div class="field-group md:col-span-2">
            <label class="text-sm font-medium text-slate-700">Condições de saneamento</label>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
              <label
                *ngFor="let option of sanitationOptions"
                class="inline-flex items-center gap-2 text-sm text-slate-700 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2"
              >
                <input
                  type="checkbox"
                  class="h-4 w-4 rounded border-slate-300"
                  [checked]="selectedSanitationOptions.has(option)"
                  (change)="toggleSanitationOption(option, $event.target.checked)"
                />
                <span>{{ option }}</span>
              </label>
            </div>
            <p class="text-xs text-slate-500">Selecione todas as condições que se aplicam.</p>
            <input id="condicoesSaneamento" type="hidden" formControlName="condicoesSaneamento" />
          </div>
        </div>
      </div>

      <div class="card space-y-3" [formGroup]="filterForm">
        <div class="flex items-center justify-between gap-3">
          <div class="card__header">Beneficiários vinculados à família</div>
          <button type="button" class="btn-outline inline-flex items-center gap-2" (click)="resetForm()">
            <span class="text-lg leading-none">＋</span>
            <span>Adicionar beneficiário</span>
          </button>
        </div>
        <p class="text-sm text-slate-600">Use os filtros para localizar e editar integrantes cadastrados.</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="field-group">
            <label class="text-sm font-medium text-slate-700" for="filterNome">Nome</label>
            <input id="filterNome" type="text" class="input" formControlName="nome" placeholder="Buscar por nome" />
          </div>
          <div class="field-group">
            <label class="text-sm font-medium text-slate-700" for="filterCpf">CPF</label>
            <input id="filterCpf" type="text" class="input" formControlName="cpf" placeholder="000.000.000-00" />
          </div>
          <div class="field-group">
            <label class="text-sm font-medium text-slate-700" for="filterIdade">Idade</label>
            <input id="filterIdade" type="number" class="input" formControlName="idade" placeholder="Idade" />
          </div>
          <div class="field-group">
            <label class="text-sm font-medium text-slate-700" for="filterDataNascimento">Data de nascimento</label>
            <input id="filterDataNascimento" type="date" class="input" formControlName="dataNascimento" />
          </div>
          <div class="field-group">
            <label class="text-sm font-medium text-slate-700" for="filterBairro">Bairro</label>
            <input id="filterBairro" type="text" class="input" formControlName="bairro" placeholder="Filtrar por bairro" />
          </div>
          <div class="field-group">
            <p class="text-sm font-medium text-slate-700">Status</p>
            <div class="flex flex-wrap gap-3">
              <label
                *ngFor="let status of statusOptions"
                class="inline-flex items-center gap-2 text-sm text-slate-700 bg-slate-50 border border-slate-200 rounded-lg px-3 py-1"
              >
                <input
                  type="checkbox"
                  class="h-4 w-4 rounded border-slate-300"
                  [checked]="filterForm.get('status')?.value?.includes(status)"
                  (change)="toggleStatusFilter(status, $event.target.checked)"
                />
                <span>{{ status }}</span>
              </label>
            </div>
          </div>
        </div>

        <div class="flex justify-end">
          <button type="button" class="btn-outline" (click)="clearFilters()">Limpar filtros</button>
        </div>

        <p class="text-sm text-slate-600" *ngIf="!filteredBeneficiaries.length">Nenhum beneficiário encontrado.</p>
        <div class="overflow-x-auto" *ngIf="filteredBeneficiaries.length">
          <table class="min-w-full text-sm text-slate-700">
            <thead>
              <tr class="text-left border-b border-slate-200">
                <th class="py-2 pr-4">Nome</th>
                <th class="py-2 pr-4">CPF</th>
                <th class="py-2 pr-4">Status</th>
                <th class="py-2 pr-4">Bairro</th>
                <th class="py-2">Ações</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let beneficiary of filteredBeneficiaries" class="border-b border-slate-100">
                <td class="py-2 pr-4">
                  <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-slate-100 overflow-hidden flex-shrink-0">
                      <img *ngIf="beneficiary.foto" [src]="beneficiary.foto" alt="Foto de {{ beneficiary.nomeCompleto }}" class="h-full w-full object-cover" />
                      <div *ngIf="!beneficiary.foto" class="h-full w-full flex items-center justify-center text-xs text-slate-400">Sem foto</div>
                    </div>
                    <div class="flex flex-col">
                      <span class="font-semibold">{{ beneficiary.nomeCompleto }}</span>
                      <span class="text-xs text-slate-500" *ngIf="beneficiary.idade">{{ beneficiary.idade }} anos</span>
                    </div>
                  </div>
                </td>
                <td class="py-2 pr-4">{{ beneficiary.documentos }}</td>
                <td class="py-2 pr-4">{{ beneficiary.status }}</td>
                <td class="py-2 pr-4">{{ beneficiary.bairro || '—' }}</td>
                <td class="py-2">
                  <button type="button" class="btn-outline" (click)="startEdit(beneficiary)">Editar</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section *ngIf="activeTab === 'documents'" class="tab-panel space-y-3">
      <div class="card space-y-3">
        <div class="card__header">Documentos / Anexos</div>
        <p class="text-sm text-slate-600">Envie um arquivo para cada documento listado abaixo.</p>
        <input type="hidden" formControlName="arquivosDocumentos" />

        <div class="space-y-3">
          <div
            class="flex flex-col md:flex-row md:items-center justify-between gap-3 border border-slate-200 rounded-lg p-3 bg-slate-50"
            *ngFor="let doc of requiredDocuments"
          >
            <div>
              <div class="flex items-center gap-2">
                <p class="text-sm font-semibold text-slate-800">{{ doc.nome }}</p>
                <span
                  class="inline-flex items-center px-2 py-0.5 text-[11px] font-semibold rounded-full"
                  [ngClass]="{
                    'bg-amber-100 text-amber-700': doc.required,
                    'bg-slate-100 text-slate-600': !doc.required
                  }"
                >
                  {{ doc.required ? 'Obrigatório' : 'Opcional' }}
                </span>
              </div>
              <p class="text-xs text-slate-500">{{ doc.nomeArquivo ? 'Arquivo: ' + doc.nomeArquivo : 'Nenhum arquivo selecionado' }}</p>
            </div>
            <input type="file" (change)="onDocumentUpload($event, doc.nome)" class="file-input" />
          </div>
        </div>

        <p *ngIf="beneficiaryForm.get('arquivosDocumentos')?.touched && beneficiaryForm.get('arquivosDocumentos')?.invalid" class="text-xs text-red-500">
          Documentos obrigatórios pendentes: {{ missingRequiredDocuments.join(', ') }}.
        </p>

        <div class="flex items-center gap-3 pt-2">
          <span class="text-sm font-medium text-slate-700">Status do cadastro:</span>
          <span class="inline-flex items-center rounded-full px-3 py-1 text-sm" [ngClass]="{
            'bg-green-50 text-g3-green-700': documentStatus === 'Enviado',
            'bg-orange-50 text-orange-700': documentStatus === 'Pendente'
          }">{{ documentStatus }}</span>
        </div>
      </div>
    </section>

    <section *ngIf="activeTab === 'notes'" class="tab-panel space-y-3">
      <div class="card">
        <div class="card__header">Observações e informações adicionais</div>
        <div class="grid grid-cols-1 gap-3">
          <div class="field-group">
            <label class="text-sm font-medium text-slate-700" for="observacoes">Observações gerais</label>
            <textarea
              id="observacoes"
              formControlName="observacoes"
              rows="5"
              class="input"
              placeholder="Anotações e pontos de atenção sobre a família"
            ></textarea>
            <p class="text-xs text-slate-500 text-right">{{ observacoesLength }} caracteres</p>
          </div>
        </div>
      </div>
    </section>

    <div class="flex justify-end gap-3 px-6 py-4 border border-slate-200 bg-white rounded-xl shadow-sm sticky-actions">
      <button type="button" class="btn-outline" (click)="resetForm()">Limpar</button>
      <button type="submit" class="btn-primary">{{ editingId ? 'Atualizar família' : 'Salvar família' }}</button>
      <span
        *ngIf="saveFeedback"
        [ngClass]="{ 'text-g3-green-700': saveFeedback.type === 'success', 'text-red-600': saveFeedback.type === 'error' }"
        class="text-sm font-medium"
      >
        {{ saveFeedback.message }}
      </span>
    </div>
  </form>
</div>
