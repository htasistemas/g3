<section class="cadastro">
  <header class="page-title">
    <p class="page-title__eyebrow">Biblioteca</p>
    <p class="page-title__label">Empréstimo de Livros</p>
    <p class="page-title__description">Controle de empréstimos, devoluções e atrasos dos livros da biblioteca.</p>
  </header>

  <div class="tab-shell">
    <p class="tab-shell__title">Navegue pelas informações</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of tabs; index as idx"
        class="step-tabs__item"
        [class.active]="activeTab === tab.id"
        [class.completed]="idx < activeTabIndex"
      >
        <button
          class="step-tabs__button"
          type="button"
          role="tab"
          [attr.aria-selected]="activeTab === tab.id"
          (click)="changeTab(tab.id)"
        >
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ tab.label }}</span>
        </button>
      </li>
    </ol>
  </div>

  <div class="tab-card">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">{{ tabs[activeTabIndex]?.label }}</p>
        <p class="muted">Preencha os dados do empréstimo e acompanhe o histórico.</p>
      </div>
      <div class="pill-group">
        <span class="pill" *ngIf="editingId">Editando</span>
        <span class="pill" *ngIf="!editingId">Novo registro</span>
      </div>
    </div>

    <form [formGroup]="form" (ngSubmit)="save()" class="tab-card__content">
      <ng-container *ngIf="activeTab === 'dados'">
        <div class="tab-grid" formGroupName="dados">
          <label class="field">
            <span>Beneficiário *</span>
            <input formControlName="beneficiario" type="text" placeholder="Nome do beneficiário" />
          </label>
          <label class="field">
            <span>Livro *</span>
            <select formControlName="livroId">
              <option value="" disabled>Selecione</option>
              <option *ngFor="let livro of booksDisponiveis" [value]="livro.id">
                {{ livro.titulo }} ({{ livro.codigoInterno }})
              </option>
            </select>
            <small class="muted" *ngIf="form.get('dados.livroId')?.value">Disponíveis: {{ disponibilidadeLivro(form.get('dados.livroId')?.value) }}</small>
          </label>
          <label class="field">
            <span>Exemplar</span>
            <input formControlName="exemplar" type="text" placeholder="Número do exemplar" />
          </label>
          <label class="field">
            <span>Data do empréstimo</span>
            <input formControlName="dataEmprestimo" type="date" />
          </label>
          <label class="field">
            <span>Data prevista de devolução *</span>
            <input formControlName="dataPrevistaDevolucao" type="date" />
          </label>
          <label class="field">
            <span>Situação do empréstimo</span>
            <select formControlName="status">
              <option *ngFor="let situacao of situacoesEmprestimo" [value]="situacao">{{ situacao }}</option>
            </select>
          </label>
          <label class="field">
            <span>Responsável pelo atendimento</span>
            <input formControlName="responsavel" type="text" />
          </label>
          <label class="field field--full">
            <span>Observações</span>
            <textarea formControlName="observacoes" rows="3"></textarea>
          </label>
        </div>
      </ng-container>

      <ng-container *ngIf="activeTab === 'devolucao'">
        <div class="tab-grid" formGroupName="devolucao">
          <label class="field">
            <span>Data de devolução efetiva</span>
            <input formControlName="dataDevolucao" type="date" />
          </label>
          <label class="field">
            <span>Situação na devolução</span>
            <select formControlName="statusDevolucao">
              <option value="">Selecione</option>
              <option value="Devolvido">Devolvido em bom estado</option>
              <option value="Danificado">Devolvido com dano</option>
              <option value="Perdido">Não devolvido (perdido)</option>
            </select>
          </label>
          <label class="field field--full">
            <span>Observações da devolução</span>
            <textarea formControlName="devolucaoObservacoes" rows="4"></textarea>
          </label>
        </div>
      </ng-container>

      <ng-container *ngIf="activeTab === 'historico'">
        <div class="filter-grid">
          <label class="field">
            <span>Status</span>
            <select [(ngModel)]="filtroStatus" name="filtroStatus">
              <option value="todos">Todos</option>
              <option *ngFor="let situacao of situacoesEmprestimo" [value]="situacao">{{ situacao }}</option>
            </select>
          </label>
          <label class="field">
            <span>Beneficiário</span>
            <input [(ngModel)]="filtroBeneficiario" name="filtroBeneficiario" type="text" />
          </label>
          <label class="field">
            <span>Livro</span>
            <input [(ngModel)]="filtroLivro" name="filtroLivro" type="text" />
          </label>
        </div>

        <div class="list-table" *ngIf="historicoFiltrado.length; else emptyHistory">
          <div class="list-table__row list-table__row--head">
            <span>Beneficiário</span>
            <span>Livro</span>
            <span>Data empréstimo</span>
            <span>Previsto devolução</span>
            <span>Data devolução</span>
            <span>Status</span>
            <span>Responsável</span>
            <span>Ações</span>
          </div>
          <div class="list-table__row" *ngFor="let loan of historicoFiltrado">
            <span>{{ loan.beneficiario }}</span>
            <span>{{ livroTitulo(loan.livroId) }}</span>
            <span>{{ loan.dataEmprestimo | date: 'dd/MM/yyyy' }}</span>
            <span>{{ loan.dataPrevistaDevolucao | date: 'dd/MM/yyyy' }}</span>
            <span>{{ loan.dataDevolucao ? (loan.dataDevolucao | date: 'dd/MM/yyyy') : '-' }}</span>
            <span>{{ loan.status }}</span>
            <span>{{ loan.responsavel || '-' }}</span>
            <div class="list-table__actions">
              <button type="button" (click)="edit(loan)">Editar</button>
              <button type="button" class="danger" (click)="remove(loan)">Excluir</button>
            </div>
          </div>
        </div>
        <ng-template #emptyHistory>
          <p class="muted">Nenhum empréstimo encontrado para os filtros.</p>
        </ng-template>
      </ng-container>

      <div class="tab-actions">
        <div class="tab-actions__nav">
          <button type="button" class="btn-secondary" (click)="goToPreviousTab()" [disabled]="!hasPreviousTab">Voltar</button>
          <button type="button" class="btn-secondary" (click)="goToNextTab()" [disabled]="!hasNextTab">Próxima etapa</button>
        </div>

        <div class="tab-actions__save">
          <button type="button" class="btn-tertiary" (click)="resetForm()">Novo empréstimo</button>
          <button type="submit" class="btn-primary">{{ editingId ? 'Atualizar' : 'Registrar' }} empréstimo</button>
        </div>
      </div>
      <p class="feedback" *ngIf="feedback" [class.error]="feedback.type === 'error'">{{ feedback.message }}</p>
    </form>
  </div>
</section>
