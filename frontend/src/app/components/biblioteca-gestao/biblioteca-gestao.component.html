<app-tela-padrao
  [fullWidth]="true"
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  (buscar)="aoBuscarToolbar()"
  (salvar)="aoSalvarToolbar()"
  (excluir)="aoExcluirToolbar()"
  (novo)="aoNovoToolbar()"
  (cancelar)="aoCancelarToolbar()"
  (imprimir)="aoImprimirToolbar()"
  (fechar)="aoFecharToolbar()"
>
  <section class="cadastro">
    <app-popup-messages [mensagens]="popupErros" (fechar)="popupErros = []"></app-popup-messages>

    <div *ngIf="mensagemFeedback" class="feedback">
      <span>{{ mensagemFeedback }}</span>
      <button type="button" class="feedback__close" (click)="limparMensagemFeedback()" aria-label="Fechar aviso">&times;</button>
    </div>

    <div class="cadastro-layout">
      <aside class="cadastro-menu">
        <div class="tab-shell">
          <p class="tab-shell__title tab-shell__title--destaque">
            <fa-icon [icon]="faBook" class="tab-shell__icon"></fa-icon>
            Biblioteca
          </p>
          <ol class="step-tabs" role="tablist">
            <li
              *ngFor="let aba of abas; index as idx"
              class="step-tabs__item"
              [class.active]="abaAtiva === aba.id"
              [class.completed]="idx < indiceAbaAtiva"
            >
              <button
                type="button"
                class="step-tabs__button"
                role="tab"
                [attr.aria-selected]="abaAtiva === aba.id"
                (click)="alterarAba(aba.id)"
              >
                <span class="step-tabs__index">{{ idx + 1 }}</span>
                <span class="step-tabs__label">{{ aba.label }}</span>
              </button>
            </li>
          </ol>
        </div>
      </aside>
      <div class="cadastro-conteudo">

    <section class="tab-card" *ngIf="abaAtiva === 'visao'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">Visão geral</p>
        </div>
        <div class="tab-card__header-actions"></div>
      </div>

      <div class="metrics-grid">
        <div class="metric-card">
          <p class="metric-label">Livros cadastrados</p>
          <p class="metric-value">{{ totalLivros }}</p>
        </div>
        <div class="metric-card metric-card--info">
          <p class="metric-label">Exemplares disponíveis</p>
          <p class="metric-value">{{ totalDisponiveis }}</p>
        </div>
        <div class="metric-card metric-card--warning">
          <p class="metric-label">Empréstimos ativos</p>
          <p class="metric-value">{{ totalEmprestimosAtivos }}</p>
        </div>
        <div class="metric-card metric-card--danger">
          <p class="metric-label">Atrasados</p>
          <p class="metric-value">{{ totalEmprestimosAtrasados }}</p>
        </div>
      </div>

      <div class="grid-cols-2">
        <div class="card">
          <div class="card__header">
            <p class="card__title">Alerta rapido</p>
            <span class="pill">Prioridade</span>
          </div>
          <ul class="legend">
            <li><span class="dot danger"></span>{{ alertaResumo.atrasados }} atrasados</li>
            <li><span class="dot warning"></span>{{ alertaResumo.vencendo }} vencendo em breve</li>
            <li><span class="dot success"></span>{{ alertaResumo.emDia }} em dia</li>
          </ul>
        </div>

        <div class="card">
          <div class="card__header">
            <p class="card__title">Empréstimo selecionado</p>
          </div>
          <p class="muted">{{ getEmprestimoSelecionadoTitulo() }}</p>
          <div class="divider"></div>
        </div>
      </div>
    </section>

    <section class="tab-card" *ngIf="abaAtiva === 'livros'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">cadastro de livros</p>
        </div>
        <div class="tab-card__header-actions">
          <span class="status status--info">Selecionado: {{ getLivroSelecionadoTitulo() }}</span>
        </div>
      </div>

      <form [formGroup]="formLivro" class="field-grid cols-4 grid-livros">
        <label class="field campo-codigo">
          Código
          <input formControlName="codigo" placeholder="Gerado automaticamente" readonly />
        </label>
        <label class="field campo-titulo">
          Título (*)
          <input formControlName="titulo" placeholder="Nome do livro" (blur)="aplicarCapitalizacaoCampo('titulo')" />
        </label>
        <label class="field campo-autor">
          Autor (*)
          <input formControlName="autor" placeholder="Autor principal" (blur)="aplicarCapitalizacaoCampo('autor')" />
        </label>
        <label class="field campo-isbn">
          ISBN
          <input formControlName="isbn" placeholder="000-0000000000" />
        </label>
        <label class="field campo-editora">
          Editora
          <input formControlName="editora" placeholder="Editora responsável" (blur)="aplicarCapitalizacaoCampo('editora')" />
        </label>
        <label class="field campo-ano">
          Ano de publicação
          <input formControlName="anoPublicacao" type="number" placeholder="2025" />
        </label>
        <label class="field campo-categoria">
          Categoria
          <select formControlName="categoria">
            <option value="">Selecione</option>
            <option *ngFor="let categoria of categoriasLivros" [value]="categoria">{{ categoria }}</option>
          </select>
        </label>
        <label class="field campo-quantidade-total">
          Quantidade total (*)
          <input formControlName="quantidadeTotal" type="number" min="1" />
        </label>
        <label class="field campo-quantidade-disponivel">
          Quantidade disponível (*)
          <input formControlName="quantidadeDisponivel" type="number" min="0" />
        </label>
        <label class="field campo-localizacao">
          Localização
          <input
            formControlName="localizacao"
            placeholder="Estante, prateleira, sala"
            (blur)="aplicarCapitalizacaoCampo('localizacao')"
          />
        </label>
        <label class="field campo-status">
          Status (*)
          <select formControlName="status">
            <option value="ATIVO">Ativo</option>
            <option value="INATIVO">Inativo</option>
          </select>
        </label>
        <label class="field campo-estado-livro">
          Estado do livro (*)
          <select formControlName="estadoLivro">
            <option value="">Selecione</option>
            <option *ngFor="let estado of estadosLivro" [value]="estado">{{ estado }}</option>
          </select>
        </label>
        <label class="field full">
          Observações
          <textarea formControlName="observacoes" rows="3"></textarea>
        </label>
      </form>

      <div class="divider"></div>

      <div class="filters">
        <label class="field">
          Buscar livros
          <input [(ngModel)]="termoLivro" placeholder="Título, autor, código ou categoria" />
        </label>
      </div>

      <div class="table-wrapper" *ngIf="!carregandoLivros; else loadingLivros">
        <table>
          <thead>
            <tr>
              <th>Código</th>
              <th>Título</th>
              <th>Autor</th>
              <th>Categoria</th>
              <th>Disponíveis</th>
              <th>Status</th>
              <th class="text-right">Ações</th>
            </tr>
          </thead>
          <tbody *ngIf="livrosFiltrados.length; else emptyLivros">
            <tr *ngFor="let livro of livrosFiltrados">
              <td>{{ livro.codigo }}</td>
              <td>{{ livro.titulo }}</td>
              <td>{{ livro.autor }}</td>
              <td>{{ livro.categoria || '-' }}</td>
              <td>{{ livro.quantidadeDisponivel }}</td>
              <td>
                <span class="status" [ngClass]="livro.status === 'ATIVO' ? 'status--valido' : 'status--neutro'">
                  {{ livro.status }}
                </span>
              </td>
              <td class="text-right actions">
                <button type="button" class="ghost" (click)="selecionarLivro(livro)">Selecionar</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <ng-template #loadingLivros>
        <p class="muted">Carregando livros...</p>
      </ng-template>
      <ng-template #emptyLivros>
        <tbody>
          <tr>
            <td colspan="7" class="muted">Nenhum livro encontrado.</td>
          </tr>
        </tbody>
      </ng-template>
    </section>

    <section class="tab-card" *ngIf="abaAtiva === 'emprestimos'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">Empréstimos</p>
        </div>
        <div class="tab-card__header-actions">
          <span class="status status--info">Selecionado: {{ getEmprestimoSelecionadoTitulo() }}</span>
        </div>
      </div>

      <form [formGroup]="formEmprestimo" class="field-grid cols-3">
        <label class="field">
          Livro (*)
          <select formControlName="livroId">
            <option value="">Selecione</option>
            <option *ngFor="let livro of livrosParaEmprestimo" [ngValue]="livro.id">
              {{ livro.codigo }} - {{ livro.titulo }} ({{ obterDisponibilidadeLivro(livro) }} disponíveis)
            </option>
          </select>
        </label>
        <label class="field">
          Beneficiário (*)
          <app-autocomplete
            [placeholder]="'Digite o nome do beneficiário'"
            [termo]="beneficiarioTermo"
            [opcoes]="beneficiarioOpcoes"
            [carregando]="carregandoBeneficiarios"
            (termoChange)="atualizarBeneficiarioTermo($event)"
            (selecionar)="selecionarBeneficiario($event)"
          ></app-autocomplete>
        </label>
        <label class="field">
          Responsável pela entrega
          <app-autocomplete
            [placeholder]="'Digite o nome do responsável'"
            [termo]="responsavelTermo"
            [opcoes]="responsavelOpcoes"
            [carregando]="carregandoResponsaveis"
            (termoChange)="atualizarResponsavelTermo($event)"
            (selecionar)="selecionarResponsavel($event)"
          ></app-autocomplete>
        </label>
        <label class="field">
          Data de empréstimo (*)
          <input type="date" formControlName="dataEmprestimo" />
        </label>
        <label class="field">
          Data prevista de devolução (*)
          <input type="date" formControlName="dataDevolucaoPrevista" />
        </label>
        <label class="field">
          Data de devolução real
          <input type="date" formControlName="dataDevolucaoReal" />
        </label>
        <label class="field full">
          Observações
          <textarea formControlName="observacoes" rows="3"></textarea>
        </label>
      </form>

      <div class="divider"></div>

      <div class="filters">
        <label class="field">
          Buscar empréstimos
          <input [(ngModel)]="termoEmprestimo" placeholder="Livro, beneficiário ou código" />
        </label>
      </div>

      <div class="table-wrapper" *ngIf="!carregandoEmprestimos; else loadingEmprestimos">
        <table>
          <thead>
            <tr>
              <th>Livro</th>
              <th>Beneficiário</th>
              <th>Empréstimo</th>
              <th>Previsto</th>
              <th>Status</th>
              <th class="text-right">Ações</th>
            </tr>
          </thead>
          <tbody *ngIf="emprestimosFiltrados.length; else emptyEmprestimos">
            <tr *ngFor="let emprestimo of emprestimosFiltrados">
              <td>{{ emprestimo.livroTitulo || emprestimo.livroId }}</td>
              <td>{{ emprestimo.beneficiarioNome || '-' }}</td>
              <td>{{ emprestimo.dataEmprestimo | date: 'dd/MM/yyyy' }}</td>
              <td>{{ emprestimo.dataDevolucaoPrevista | date: 'dd/MM/yyyy' }}</td>
              <td>
                <span class="status" [ngClass]="
                  emprestimo.status === 'ATRASADO'
                    ? 'status--critico'
                    : emprestimo.status === 'ATIVO'
                      ? 'status--aviso'
                      : 'status--neutro'
                ">
                  {{ emprestimo.status }}
                </span>
              </td>
              <td class="text-right actions">
                <button type="button" class="ghost" (click)="selecionarEmprestimo(emprestimo)">Selecionar</button>
                <button
                  type="button"
                  class="primary"
                  [disabled]="emprestimo.status !== 'ATIVO'"
                  (click)="registrarDevolucao(emprestimo)"
                >
                  Registrar devolução
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <ng-template #loadingEmprestimos>
        <p class="muted">Carregando empréstimos...</p>
      </ng-template>
      <ng-template #emptyEmprestimos>
        <tbody>
          <tr>
            <td colspan="6" class="muted">Nenhum empréstimo encontrado.</td>
          </tr>
        </tbody>
      </ng-template>
    </section>

    <section class="tab-card tab-card--devolucoes" *ngIf="abaAtiva === 'devolucoes'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">Devoluções</p>
        </div>
        <div class="tab-card__header-actions">
          <span class="status status--info">Empréstimos ativos: {{ emprestimosParaDevolucao.length }}</span>
        </div>
      </div>

      <div class="filters">
        <label class="field">
          Buscar devoluções
          <input [(ngModel)]="termoDevolucao" placeholder="Livro, beneficiário ou código" />
        </label>
      </div>

      <div class="table-wrapper" *ngIf="!carregandoEmprestimos; else loadingDevolucoes">
        <table>
          <thead>
            <tr>
              <th>Livro</th>
              <th>Beneficiário</th>
              <th>Empréstimo</th>
              <th>Previsto</th>
              <th>Status</th>
              <th class="text-right">Ações</th>
            </tr>
          </thead>
          <tbody *ngIf="emprestimosParaDevolucao.length; else emptyDevolucoes">
            <tr *ngFor="let emprestimo of emprestimosParaDevolucao">
              <td>{{ emprestimo.livroTitulo || emprestimo.livroId }}</td>
              <td>{{ emprestimo.beneficiarioNome || '-' }}</td>
              <td>{{ emprestimo.dataEmprestimo | date: 'dd/MM/yyyy' }}</td>
              <td>{{ emprestimo.dataDevolucaoPrevista | date: 'dd/MM/yyyy' }}</td>
              <td>
                <span
                  class="status"
                  [ngClass]="
                    emprestimo.status === 'ATRASADO'
                      ? 'status--critico'
                      : emprestimo.status === 'ATIVO'
                        ? 'status--aviso'
                        : 'status--neutro'
                  "
                >
                  {{ emprestimo.status }}
                </span>
              </td>
              <td class="text-right actions">
                <button type="button" class="primary" (click)="registrarDevolucao(emprestimo)">
                  Registrar devolução
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <ng-template #loadingDevolucoes>
        <p class="muted">Carregando devoluções...</p>
      </ng-template>
      <ng-template #emptyDevolucoes>
        <tbody>
          <tr>
            <td colspan="6" class="muted">Nenhuma devolução pendente.</td>
          </tr>
        </tbody>
      </ng-template>
    </section>

    <section class="tab-card" *ngIf="abaAtiva === 'disponiveis'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">Livros disponíveis</p>
        </div>
        <div class="tab-card__header-actions">
          <span class="status status--info">Títulos: {{ totalTitulosDisponiveis }}</span>
          <span class="status status--valido">Unidades: {{ totalUnidadesDisponiveis }}</span>
        </div>
      </div>

      <div class="almox-resumo">
        <div class="almox-card">
          <p class="almox-card__label">Títulos disponíveis</p>
          <p class="almox-card__value">{{ totalTitulosDisponiveis }}</p>
        </div>
        <div class="almox-card">
          <p class="almox-card__label">Unidades em estoque</p>
          <p class="almox-card__value">{{ totalUnidadesDisponiveis }}</p>
        </div>
      </div>

      <div class="table-wrapper" *ngIf="estoquePorCategoria.length">
        <table>
          <thead>
            <tr>
              <th>Categoria</th>
              <th>Títulos</th>
              <th>Unidades</th>
              <th>Percentual</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of estoquePorCategoria">
              <td>{{ item.categoria }}</td>
              <td>{{ item.titulos }}</td>
              <td>
                <span class="status" [ngClass]="isCategoriaBaixa(item.unidades) ? 'status--critico' : 'status--valido'">
                  {{ item.unidades }}
                </span>
              </td>
              <td>{{ item.percentual }}%</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="filters">
        <label class="field">
          Buscar livros disponíveis
          <input [(ngModel)]="termoDisponiveis" placeholder="Título, autor, código ou categoria" />
        </label>
      </div>

      <div class="table-wrapper" *ngIf="!carregandoLivros; else loadingDisponiveis">
        <table>
          <thead>
            <tr>
              <th>Código</th>
              <th>Título</th>
              <th>Autor</th>
              <th>Categoria</th>
              <th>Disponíveis</th>
              <th>Status</th>
              <th class="text-right">Ações</th>
            </tr>
          </thead>
          <tbody *ngIf="livrosDisponiveisFiltrados.length; else emptyDisponiveis">
            <tr *ngFor="let livro of livrosDisponiveisFiltrados">
              <td>{{ livro.codigo }}</td>
              <td>{{ livro.titulo }}</td>
              <td>{{ livro.autor }}</td>
              <td>{{ livro.categoria || '-' }}</td>
              <td>{{ obterDisponibilidadeLivro(livro) }}</td>
              <td>
                <span class="status status--valido">Ativo</span>
              </td>
              <td class="text-right actions">
                <button type="button" class="ghost" (click)="editarLivroDisponivel(livro)">Editar</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <ng-template #loadingDisponiveis>
        <p class="muted">Carregando livros disponíveis...</p>
      </ng-template>
      <ng-template #emptyDisponiveis>
        <tbody>
          <tr>
            <td colspan="7" class="muted">Nenhum livro disponível no momento.</td>
          </tr>
        </tbody>
      </ng-template>
    </section>

    <section class="tab-card" *ngIf="abaAtiva === 'alertas'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">Alertas de devolução</p>
        </div>
        <div class="tab-card__header-actions">
          <button type="button" class="btn-outline" (click)="carregarAlertas()">Recarregar alertas</button>
        </div>
      </div>

      <div class="alert-grid">
        <div class="alert-card danger">
          <p class="alert-card__label">Atrasados</p>
          <p class="alert-card__value">{{ alertaResumo.atrasados }}</p>
        </div>
        <div class="alert-card warning">
          <p class="alert-card__label">Vencendo em breve</p>
          <p class="alert-card__value">{{ alertaResumo.vencendo }}</p>
        </div>
        <div class="alert-card neutral">
          <p class="alert-card__label">Em dia</p>
          <p class="alert-card__value">{{ alertaResumo.emDia }}</p>
        </div>
      </div>

      <div class="table-wrapper" *ngIf="!carregandoAlertas; else loadingAlertas">
        <table>
          <thead>
            <tr>
              <th>Livro</th>
              <th>Beneficiário</th>
              <th>Previsto</th>
              <th>Dias para vencimento</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody *ngIf="alertas.length; else emptyAlertas">
            <tr *ngFor="let alerta of alertas" [class.alert-blink]="alerta.status === 'ATRASADO'">
              <td>{{ alerta.livroTitulo }}</td>
              <td>{{ alerta.beneficiarioNome || '-' }}</td>
              <td>{{ alerta.dataDevolucaoPrevista | date: 'dd/MM/yyyy' }}</td>
              <td>{{ alerta.diasParaVencimento }}</td>
              <td>
                <span class="status"
                  [ngClass]="
                    alerta.status === 'ATRASADO'
                      ? 'status--critico'
                      : alerta.status === 'VENCENDO'
                        ? 'status--aviso'
                        : 'status--valido'
                  ">
                  {{ alerta.status }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <ng-template #loadingAlertas>
        <p class="muted">Carregando alertas...</p>
      </ng-template>
      <ng-template #emptyAlertas>
        <tbody>
          <tr>
            <td colspan="5" class="muted">Nenhum alerta ativo no momento.</td>
          </tr>
        </tbody>
      </ng-template>
    </section>
      </div>
    </div>
  </section>

  <app-dialog
    [aberto]="dialogConfirmacaoAberta"
    [titulo]="dialogTitulo"
    [mensagem]="dialogMensagem"
    [confirmarLabel]="dialogConfirmarLabel"
    (confirmar)="confirmarDialogo()"
    (cancelar)="cancelarDialogo()"
  ></app-dialog>
</app-tela-padrao>






