<app-tela-padrao
  [acoes]="acoesToolbar"
  [mostrarFechar]="true"
  [fullWidth]="true"
  (salvar)="onSave()"
  (cancelar)="onCancel()"
  (novo)="onNovo()"
  (buscar)="onBuscar()"
  (excluir)="onExcluir()"
  (imprimir)="onImprimir()"
  (fechar)="onFechar()"
>

  <section class="cadastro">
    <app-popup-messages
      [mensagens]="popupErros"
      [titulo]="popupTitulo"
      (fechar)="popupErros = []"
    ></app-popup-messages>


    <div class="cadastro-layout">
      <aside class="cadastro-menu">
        <div class="tab-shell">
          <p class="tab-shell__title tab-shell__title--destaque">
            <fa-icon [icon]="faHeadset" class="tab-shell__icon"></fa-icon>
            Chamado técnico
          </p>
          <ol class="step-tabs" role="tablist">
            <li
              class="step-tabs__item"
              *ngFor="let tab of tabs; index as idx"
              [class.active]="activeTab === tab.id"
              [class.completed]="idx < activeTabIndex"
            >
              <button
                type="button"
                class="step-tabs__button"
                role="tab"
                [attr.aria-selected]="activeTab === tab.id"
                (click)="changeTab(tab.id)"
              >
                <span class="step-tabs__index">{{ idx + 1 }}</span>
                <span class="step-tabs__label">{{ tab.label }}</span>
              </button>
            </li>
          </ol>
        </div>
      </aside>

      <div class="cadastro-conteudo">
        <section class="tab-card" *ngIf="activeTab === 'registro'">
          <div class="tab-card__header">
            <div class="tab-card__title-stack">
              <p class="tab-card__highlight">Registro do chamado</p>
            </div>
          </div>
          <form [formGroup]="form" class="form-shell">
            <div class="field-grid cols-2">
              <div class="field-row">
                <label class="field field--titulo">Título (*)
                  <input type="text" formControlName="titulo" />
                </label>
                <label class="field field--versao">Versão do sistema
                  <input type="text" formControlName="versao_sistema" (input)="onVersaoInput($event)" placeholder="0.00.00" />
                </label>
              </div>
              <label class="field full">Descrição (*)
                <textarea rows="8" formControlName="descricao" (paste)="onColarImagem($event)"></textarea>
                <span class="muted">Você pode colar prints da tela neste campo.</span>
              </label>
              <label class="field">Tipo (*)
                <select formControlName="tipo">
                  <option *ngFor="let option of tipoOptions" [value]="option">{{ formatTipo(option) }}</option>
                </select>
              </label>
              <label class="field">Prioridade (*)
                <select formControlName="prioridade">
                  <option *ngFor="let option of prioridadeOptions" [value]="option">{{ option }}</option>
                </select>
              </label>
              <label class="field">Módulo (*)
                <app-autocomplete
                  [termo]="moduloTermo"
                  [opcoes]="moduloOpcoes"
                  placeholder="Selecione o módulo"
                  (termoChange)="atualizarTermoModulo($event)"
                  (selecionar)="selecionarModulo($event)"
                ></app-autocomplete>
              </label>
              <label class="field">Menu (*)
                <app-autocomplete
                  [termo]="menuTermo"
                  [opcoes]="menuOpcoes"
                  placeholder="Selecione o menu"
                  (termoChange)="atualizarTermoMenu($event)"
                  (selecionar)="selecionarMenu($event)"
                ></app-autocomplete>
              </label>
              <label class="field">Cliente (*)
                <input type="text" formControlName="cliente" readonly />
              </label>
              <label class="field">Ambiente
                <input type="text" formControlName="ambiente" />
              </label>
              <label class="field full">Anexos (imagens)
                <input type="file" accept="image/*" (change)="selecionarArquivo($event)" />
              </label>
              <div class="field full" *ngIf="previewsAnexos.length">
                <span class="field__label">Prévias das imagens</span>
                <div class="anexos-preview">
                  <figure class="anexos-preview__item" *ngFor="let preview of previewsAnexos">
                    <img [src]="preview.url" [alt]="preview.nome" />
                    <figcaption>{{ preview.nome }}</figcaption>
                  </figure>
                </div>
              </div>
            </div>
            <div class="tab-card__response" *ngIf="modoTela === 'usuario' && (form.get('resposta_desenvolvedor')?.value || form.get('status')?.value === 'RESOLVIDO' || form.get('status')?.value === 'FECHADO')">
              <p class="muted" *ngIf="form.get('resposta_desenvolvedor')?.value">{{ form.get('resposta_desenvolvedor')?.value }}</p>
              <label class="field" *ngIf="form.get('status')?.value === 'RESOLVIDO' || form.get('status')?.value === 'FECHADO'">
                <textarea
                  rows="3"
                  [(ngModel)]="comentarioReabrirTexto"
                  [ngModelOptions]="{ standalone: true }"
                  name="comentarioReabrir"
                ></textarea>
              </label>
              <div class="tab-card__actions" *ngIf="form.get('status')?.value === 'RESOLVIDO' || form.get('status')?.value === 'FECHADO'">
                <button
                  type="button"
                  class="btn-outline"
                  (click)="reabrirChamado()"
                >
                  Reabrir chamado
                </button>
                <button
                  type="button"
                  class="btn-outline"
                  (click)="encerrarChamado()"
                >
                  Fechar chamado
                </button>
              </div>
            </div>
          </form>
        </section>

        <section class="tab-card" *ngIf="activeTab === 'acompanhamento'">
          <div class="tab-card__header">
            <div class="tab-card__title-stack">
              <p class="tab-card__highlight">Acompanhamento</p>
              <p class="muted">Ações, comentários e anexos do chamado.</p>
            </div>
          </div>

          <div class="comment-box">
            <label class="field">Novo comentário
              <textarea rows="3" [(ngModel)]="comentarioTexto" name="comentarioTexto"></textarea>
            </label>
            <button type="button" class="primary" (click)="adicionarComentario()">Salvar comentário</button>
          </div>

          <div class="acoes-lista" *ngIf="acoes.length; else acoesVazias">
            <div class="acoes-item" *ngFor="let acao of acoes">
              <div class="acoes-item__linha-unica">
                <span class="acoes-item__tipo">{{ formatarTipoAcao(acao.tipo) }}</span>
                <span class="acoes-item__separador">•</span>
                <span class="acoes-item__data">{{ acao.criado_em | date: 'dd/MM/yyyy HH:mm' }}</span>
                <span class="acoes-item__separador">•</span>
                <span class="acoes-item__descricao">{{ acao.descricao }}</span>
                <ng-container *ngIf="acao.de_status || acao.para_status">
                  <span class="acoes-item__separador">•</span>
                  <span class="acoes-item__rotulo">Status:</span>
                  <span class="acoes-item__valor">
                    {{ formatStatus(acao.de_status || '') }} -> {{ formatStatus(acao.para_status || '') }}
                  </span>
                </ng-container>
                <ng-container *ngIf="acao.de_responsavel_id || acao.para_responsavel_id">
                  <span class="acoes-item__separador">•</span>
                  <span class="acoes-item__rotulo">Responsável:</span>
                  <span class="acoes-item__valor">
                    {{ acao.de_responsavel_id ?? '---' }} -> {{ acao.para_responsavel_id ?? '---' }}
                  </span>
                </ng-container>
                <ng-container *ngIf="acao.criado_por_usuario_id">
                  <span class="acoes-item__separador">•</span>
                  <span class="acoes-item__rotulo">Registrado por:</span>
                  <span class="acoes-item__valor">{{ nomeRegistradoPor(acao) }}</span>
                </ng-container>
              </div>
            </div>
          </div>
          <ng-template #acoesVazias>
            <p class="muted">Nenhuma ação registrada.</p>
          </ng-template>

          <div class="comentarios-lista" *ngIf="comentarios.length; else comentariosVazios">
            <div class="comentarios-item" *ngFor="let comentario of comentarios">
              <div class="comentarios-item__linha-unica">
                <span class="comentarios-item__tipo">COMENTÃRIO</span>
                <span class="comentarios-item__separador">•</span>
                <span class="comentarios-item__data">{{ comentario.criado_em | date: 'dd/MM/yyyy HH:mm' }}</span>
                <span class="comentarios-item__separador">•</span>
                <span class="comentarios-item__texto">{{ comentario.comentario }}</span>
                <span class="comentarios-item__separador">•</span>
                <span class="comentarios-item__rotulo">Registrado por:</span>
                <span class="comentarios-item__valor">{{ nomeRegistradoPorComentario(comentario) }}</span>
              </div>
            </div>
          </div>
          <ng-template #comentariosVazios>
            <p class="muted">Nenhum comentário registrado.</p>
          </ng-template>

          <div class="timeline">
            <div class="timeline__item" *ngFor="let anexo of anexos">
              <p class="timeline__title">{{ anexo.nome_arquivo }}</p>
              <p class="timeline__meta">{{ anexo.criado_em | date: 'dd/MM/yyyy HH:mm' }}</p>
            </div>
            <p class="muted" *ngIf="!anexos.length">Nenhum anexo registrado.</p>
          </div>
        </section>

        <section class="tab-card" *ngIf="activeTab === 'atendimento'">
          <div class="tab-card__header">
            <div class="tab-card__title-stack">
              <p class="tab-card__highlight">Desenvolvimento</p>
              <p class="muted">Registrar a tratativa do desenvolvedor.</p>
            </div>
          </div>
          <form [formGroup]="form" class="form-shell">
            <div class="field-grid cols-2">
              <label class="field">Status do atendimento (*)
                <select formControlName="status">
                  <option *ngFor="let option of statusAtendimento" [value]="option.valor">
                    {{ option.label }}
                  </option>
                </select>
              </label>
              <label class="field">Responsável
                <input type="text" formControlName="responsavel_usuario_nome" readonly />
              </label>
              <input type="hidden" formControlName="responsavel_usuario_id" />
              <label class="field full">Comentários
                <textarea rows="6" formControlName="resposta_desenvolvedor"></textarea>
              </label>
            </div>
          </form>
        </section>
      </div>
    </div>
  </section>

  <app-dialog
    [aberto]="excluirAberto"
    titulo="Excluir chamado"
    mensagem="Confirma a exclusão deste chamado?"
    confirmarLabel="Excluir"
    cancelarLabel="Cancelar"
    (confirmar)="confirmarExcluir()"
    (cancelar)="cancelarExcluir()"
  ></app-dialog>
</app-tela-padrao>



















