<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  (salvar)="onSalvar()"
  (excluir)="onExcluir()"
  (novo)="onNovo()"
  (cancelar)="onCancelar()"
  (imprimir)="onImprimir()"
  (buscar)="onBuscar()"
  (fechar)="onFechar()"
>
<header class="page-title" slot="titulo">
    <p class="page-title__eyebrow">Financeiro - Contabilidade</p>
    <p class="page-title__label">Gestao de contas a pagar e a receber</p>
    <p class="page-title__note">Gestao de contas a pagar, receber e movimentacoes.</p>
  </header>

  <app-popup-messages [mensagens]="popupErros" (fechar)="fecharPopupErros()"></app-popup-messages>

  <section class="cadastro">
  <div class="tab-shell">
    <p class="tab-shell__title">Navegue pelas visões financeiras</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of tabs; index as idx"
        class="step-tabs__item"
        [class.active]="activeTab === tab.id"
        [class.completed]="idx < activeTabIndex"
      >
        <button
          class="step-tabs__button"
          type="button"
          role="tab"
          [attr.aria-selected]="activeTab === tab.id"
          (click)="changeTab(tab.id)"
        >
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">
            {{ tab.label }}
            
          </span>
          <span *ngIf="tab.badge" class="pill pill--ghost">{{ tab.badge }}</span>
        </button>
      </li>
    </ol>
  </div>

  <div class="tab-card" *ngIf="activeTab === 'visao-geral'">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">Resumo financeiro</p>
      </div>
      <div class="tab-card__actions">
        <button type="button" class="ghost" (click)="printResumo()">
          <fa-icon [icon]="faPrint"></fa-icon>
          Imprimir resumo
        </button>
        <button type="button" class="ghost" (click)="changeTab('relatorios')">
          <fa-icon [icon]="faBell"></fa-icon>
          Alertas e notificações
        </button>
      </div>
    </div>

    <div class="section-block">
      <div class="section-heading">
        <p class="section-title">Indicadores rápidos</p>
        <div class="section-actions"></div>
      </div>
      <div class="card-grid">
        <article class="metric-card" *ngFor="let card of summaryCards">
          <div class="metric-card__icon" [class.positive]="card.trend === 'up'" [class.negative]="card.trend === 'down'">
            <fa-icon [icon]="card.icon"></fa-icon>
          </div>
          <div class="metric-card__content">
            <p class="eyebrow">{{ card.label }}</p>
            <p class="metric-card__value">{{ card.value }}</p>
            <p class="muted" [class.positive]="card.trend === 'up'" [class.negative]="card.trend === 'down'"></p>
          </div>
        </article>
      </div>
    </div>

    <div class="panel-grid">
      <article class="panel">
        <header class="panel__header">
          <div>
            <p class="panel__eyebrow">Agenda de pagamentos e recebimentos</p>
          </div>
          <div class="panel__actions">
            <button type="button" class="ghost" (click)="novoLancamento()">Novo lançamento</button>
            <span class="pill pill--ghost">Operacional</span>
          </div>
        </header>

        <form class="form-grid" (ngSubmit)="registerEntry()">
          <label class="form-field">
            <span>Tipo *</span>
            <select class="select" name="type" [(ngModel)]="newEntry.tipo" required>
              <option value="receber">A receber</option>
              <option value="pagar">A pagar</option>
            </select>
          </label>
          <label class="form-field form-field--wide">
            <span>Descricao *</span>
            <input
              type="text"
              class="input"
              name="title"
              [(ngModel)]="newEntry.descricao"
              placeholder="Ex.: Repasse municipal"
              autocomplete="transaction-purpose"
              required
            />
          </label>
          <label class="form-field form-field--wide">
            <span>Contraparte *</span>
            <input
              type="text"
              class="input"
              name="counterparty"
              [(ngModel)]="newEntry.contraparte"
              list="counterpartyList"
              placeholder="Prefeitura, fornecedor..."
              autocomplete="organization"
              required
            />
            <datalist id="counterpartyList">
              <option *ngFor="let option of counterpartySuggestions" [value]="option"></option>
            </datalist>
          </label>
          <label class="form-field">
            <span>Vencimento *</span>
            <input
              type="date"
              class="input"
              name="dueDate"
              [(ngModel)]="newEntry.vencimento"
              autocomplete="on"
              required
            />
          </label>
          <label class="form-field">
            <span>Valor *</span>
            <input
              type="text"
              class="input"
              name="amount"
              [ngModel]="valorLancamentoMascara"
              (ngModelChange)="onValorLancamentoInput($event)"
              placeholder="R$ 0,00"
              autocomplete="transaction-amount"
              required
            />
          </label>
          <label class="form-field">
            <span>Situacao *</span>
            <select class="select" name="status" [(ngModel)]="newEntry.situacao" required>
              <option value="aberto">Aberto</option>
              <option value="pago">Pago</option>
              <option value="atrasado">Em atraso</option>
            </select>
          </label>
          <div class="form-actions">
            <button class="primary" type="submit">
              {{ lancamentoEmEdicaoId ? 'Atualizar lançamento' : 'Salvar lançamento' }}
            </button>
            <button class="ghost" type="button" *ngIf="lancamentoEmEdicaoId" (click)="cancelarEdicaoLancamento()">
              Cancelar
            </button>
          </div>
        </form>
      </article>
    </div>

    <div class="panel-grid">
      <article class="panel">
        <header class="panel__header">
          <div>
            <p class="panel__eyebrow">Lançamentos registrados</p>
            <p class="panel__title">Pesquise e acompanhe os lançamentos</p>
          </div>
          <span class="pill pill--ghost">Listagem</span>
        </header>

        <div class="filter-bar">
          <label class="form-field">
            <span>Descrição</span>
            <input type="text" class="input" [(ngModel)]="filtrosLancamentos.descricao" name="filtroDescricao" placeholder="Repasse, fornecedor..." />
          </label>
          <label class="form-field form-field--wide">
            <span>Contraparte</span>
            <input type="text" class="input" [(ngModel)]="filtrosLancamentos.contraparte" name="filtroContraparte" placeholder="Prefeitura, fornecedor..." />
          </label>
          <label class="form-field">
            <span>Tipo *</span>
            <select class="select" [(ngModel)]="filtrosLancamentos.tipo" name="filtroTipoLancamento">
              <option value="">Todos</option>
              <option value="receber">A receber</option>
              <option value="pagar">A pagar</option>
            </select>
          </label>
          <label class="form-field">
            <span>Situação</span>
            <select class="select" [(ngModel)]="filtrosLancamentos.situacao" name="filtroSituacao">
              <option value="">Todas</option>
              <option value="aberto">Aberto</option>
              <option value="pago">Pago</option>
              <option value="atrasado">Em atraso</option>
            </select>
          </label>
        </div>

        <p class="muted list-count">Total: {{ lancamentosFiltrados.length }} lançamentos</p>
        <div class="table-wrapper" *ngIf="lancamentosFiltrados.length; else emptyAgenda">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Descrição</th>
                <th>Contraparte</th>
                <th>Vencimento</th>
                <th>Valor</th>
                <th>Situação</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of lancamentosFiltrados; index as i">
                <td>{{ i + 1 }}</td>
                <td>
                  <p class="strong">{{ item.descricao }}</p>
                  <p class="muted">{{ item.tipo === 'receber' ? 'Entrada programada' : 'Saída programada' }}</p>
                </td>
                <td>{{ item.contraparte }}</td>
                <td>{{ formatDate(item.vencimento) }}</td>
                <td>{{ item.valor | currency:'BRL' }}</td>
                <td>
                  <span
                    class="status"
                    [class.status--positive]="item.situacao === 'pago' || item.tipo === 'receber'"
                    [class.status--warning]="item.situacao === 'atrasado'"
                  >
                    <fa-icon
                      [icon]="
                        item.situacao === 'pago'
                          ? faCircleCheck
                          : item.situacao === 'atrasado'
                            ? faCircleExclamation
                            : faCircleDot
                      "
                    ></fa-icon>
                    {{ getStatusLabel(item) }}
                  </span>
                </td>
                <td class="text-right actions">
                  <button class="ghost" type="button" (click)="editarLancamento(item)">Editar</button>
                  <button
                    class="primary"
                    type="button"
                    *ngIf="item.compraId; else pagamentoManual"
                    (click)="pagarLancamento(item)"
                  >
                    Efetuar pagamento
                  </button>
                  <ng-template #pagamentoManual>
                    <button class="primary" type="button" (click)="setEntryStatus(item, 'pago')">
                      Registrar pagamento
                    </button>
                  </ng-template>
                  <button class="ghost" type="button" (click)="setEntryStatus(item, 'atrasado')">Marcar atraso</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <ng-template #emptyAgenda>
          <p class="empty-state">Nenhum lançamento. Inclua dados reais para liberar projeções e relatórios.</p>
        </ng-template>
      </article>
    </div>

    <div class="panel-grid three-cols">
      

      <article class="panel">
        <header class="panel__header">
          <div>
            <p class="panel__eyebrow">Resumo para impressão</p>
            <p class="panel__title">Saldos recebidos e a receber</p>
          </div>
          <button class="ghost" type="button" (click)="printResumo()">
            <fa-icon [icon]="faPrint"></fa-icon>
            Gerar PDF
          </button>
        </header>
        <div class="report-preview">
          <div class="report-row">
            <p class="strong">Recebimentos registrados</p>
            <p>{{ reportTotals.recebimentos | currency:'BRL' }}</p>
          </div>
          <div class="report-row">
            <p class="strong">Pagamentos realizados</p>
            <p>{{ reportTotals.pagamentos | currency:'BRL' }}</p>
          </div>
          <div class="report-row">
            <p class="strong">Saldo a receber</p>
            <p>{{ reportTotals.saldoAReceber | currency:'BRL' }}</p>
          </div>
          <div class="report-row total">
            <p class="strong">Saldo projetado</p>
            <p>{{ reportTotals.saldoProjetado | currency:'BRL' }}</p>
          </div>
          <p class="muted">Use os botões de impressão ou exportacao para compartilhar o resumo.</p>
        </div>
      </article>
    </div>
  </div>
  <section class="print-report" *ngIf="reciboPagamento">
    <header class="print-report__header">
      <div>
        <p class="print-report__eyebrow">Recibo de pagamento</p>
        <p class="print-report__title">Autorização de pagamento</p>
      </div>
      <div class="print-report__meta">
        <p>Nº {{ reciboPagamento.numeroRecibo }}</p>
        <p>{{ reciboPagamento.dataPagamento | date: 'dd/MM/yyyy' }}</p>
      </div>
    </header>
    <div class="print-report__body">
      <p><strong>Descrição:</strong> {{ reciboPagamento.descricao }}</p>
      <p><strong>Responsável:</strong> {{ reciboPagamento.responsavel || 'Não informado' }}</p>
      <p><strong>Valor total:</strong> {{ reciboPagamento.valorTotal | currency:'BRL' }}</p>
      <table class="print-report__table" *ngIf="reciboPagamento.contas?.length">
        <thead>
          <tr>
            <th>Banco</th>
            <th>Conta</th>
            <th>Valor</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let conta of reciboPagamento.contas">
            <td>{{ conta.banco }}</td>
            <td>{{ conta.numero }}</td>
            <td>{{ conta.valor | currency:'BRL' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <footer class="print-report__footer">
      <p>Emitido pelo sistema G3.</p>
    </footer>
  </section>
  <div class="tab-card" *ngIf="activeTab === 'lancamentos'">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">Lançamentos</p>
        <p class="muted">Gestão de contas a pagar e a receber.</p>
      </div>
    </div>

    <article class="panel">
        <header class="panel__header">
          <div>
            <p class="panel__eyebrow">Emendas impositivas</p>
            <p class="panel__title">Controle de valores a receber</p>
          </div>
          <span class="pill">Alertas</span>
        </header>

        <form class="form-grid" (ngSubmit)="addAmendment()">
          <label class="form-field">
            <span>Identificacao *</span>
            <input
              type="text"
              class="input"
              name="name"
              [(ngModel)]="newAmendment.identificacao"
              placeholder="Emenda 001/2024"
              autocomplete="on"
              required
            />
          </label>
          <label class="form-field">
            <span>Referencia legal</span>
            <input
              type="text"
              class="input"
              name="lawReference"
              [(ngModel)]="newAmendment.referenciaLegal"
              placeholder="Lei ou oficio"
              autocomplete="on"
            />
          </label>
          <label class="form-field">
            <span>Previsao de recebimento *</span>
            <input
              type="date"
              class="input"
              name="expectedDate"
              [(ngModel)]="newAmendment.dataPrevista"
              required
            />
          </label>
          <label class="form-field">
            <span>Valor previsto *</span>
            <input
              type="number"
              class="input"
              name="amount"
              [(ngModel)]="newAmendment.valorPrevisto"
              step="0.01"
              min="0"
              placeholder="0,00"
              autocomplete="transaction-amount"
              required
            />
          </label>
          <label class="form-field">
            <span>Antecedencia do alerta (dias) *</span>
            <input
              type="number"
              class="input"
              name="alertDays"
              [(ngModel)]="newAmendment.diasAlerta"
              min="1"
              autocomplete="on"
              required
            />
          </label>
          <label class="form-field">
            <span>Status *</span>
            <select class="select" name="status" [(ngModel)]="newAmendment.status" required>
              <option value="previsto">Previsto</option>
              <option value="empenhado">Empenhado</option>
              <option value="recebido">Recebido</option>
            </select>
          </label>
          <label class="form-field">
            <span>Observações</span>
            <textarea class="input" name="notes" [(ngModel)]="newAmendment.observacoes" rows="2" placeholder="Responsavel, etapa ou vinculo"></textarea>
          </label>
          <div class="form-actions">
            <button class="primary" type="submit">Controlar emenda</button>
          </div>
        </form>

        
        <div class="filter-bar">
          <label class="form-field">
            <span>Identificacao</span>
            <input type="text" class="input" [(ngModel)]="filtrosEmendas.identificacao" name="filtroEmenda" placeholder="Emenda 001/2024" />
          </label>
          <label class="form-field">
            <span>Status</span>
            <select class="select" [(ngModel)]="filtrosEmendas.status" name="filtroEmendaStatus">
              <option value="">Todos</option>
              <option value="previsto">Previsto</option>
              <option value="empenhado">Empenhado</option>
              <option value="recebido">Recebido</option>
            </select>
          </label>
        </div>

<p class="muted list-count">Total: {{ emendasFiltradas.length }} emendas</p>
    <ul class="pillars" *ngIf="emendasFiltradas.length; else emptyAmendments">
          <li *ngFor="let amendment of emendasFiltradas">
            <div>
              <p class="strong">{{ amendment.identificacao }}</p>
              <p class="muted">{{ amendment.referenciaLegal || 'Sem referencia' }} - {{ formatDate(amendment.dataPrevista) }}</p>
              <p class="muted">{{ amendment.observacoes || 'Sem observacoes' }}</p>
            </div>
            <div class="tag-wrapper">
              <span class="tag positive">{{ amendment.valorPrevisto | currency:'BRL' }}</span>
              <button class="pill pill--ghost" type="button" (click)="setAmendmentStatus(amendment, 'recebido')">
                Marcar recebido
              </button>
            </div>
          </li>
        </ul>
        <ng-template #emptyAmendments>
          <p class="empty-state">Cadastre suas emendas impositivas para monitorar datas e alertas automaticos.</p>
        </ng-template>
      </article>

      <article class="panel">
        <header class="panel__header">
          <div>
            <p class="panel__eyebrow">Alertas e lembretes</p>
            <p class="panel__title">Próximas datas críticas</p>
          </div>
          <span class="pill pill--ghost">Automatico</span>
        </header>
        <ul class="alert-list" *ngIf="alerts.length; else emptyAlerts">
          <li *ngFor="let alert of alerts">
            <fa-icon [icon]="faBell"></fa-icon>
            <span>{{ alert }}</span>
          </li>
        </ul>
        <ng-template #emptyAlerts>
          <p class="empty-state">Sem alertas pendentes. Mantenha os vencimentos e emendas atualizados.</p>
        </ng-template>
      </article>
  </div>

  <div class="tab-card" *ngIf="activeTab === 'contas'">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">Contas bancarias</p>
        <p class="muted">Saldos atualizados das contas cadastradas.</p>
      </div>
    </div>

    <div class="panel">
      <header class="panel__header">
        <div>
          <p class="panel__eyebrow">Cadastro</p>
          <p class="panel__title">Nova conta bancaria</p>
        </div>
        <span class="pill">Saldo real</span>
      </header>

      <form class="form-grid" (ngSubmit)="addBankAccount()">
        <label class="form-field">
          <span>Banco *</span>
          <input
            type="text"
            class="input"
            name="bankName"
            [(ngModel)]="newAccount.banco"
            placeholder="Ex.: Banco do Brasil"
            list="bankSuggestions"
            autocomplete="organization"
            required
          />
          <datalist id="bankSuggestions">
            <option *ngFor="let banco of bancosDisponiveis" [value]="banco"></option>
          </datalist>
        </label>
        <label class="form-field">
          <span>Agencia</span>
          <input
            type="text"
            class="input"
            name="agencia"
            [(ngModel)]="newAccount.agencia"
            placeholder="0000"
            autocomplete="account-number"
          />
        </label>
        <label class="form-field">
          <span>Numero da conta *</span>
          <input
            type="text"
            class="input"
            name="numero"
            [(ngModel)]="newAccount.numero"
            placeholder="000000-0"
            autocomplete="account-number"
            required
          />
        </label>
        <label class="form-field">
          <span>Tipo *</span>
          <select class="select" name="type" [(ngModel)]="newAccount.tipo" required>
            <option *ngFor="let tipo of tiposConta" [value]="tipo.value">{{ tipo.label }}</option>
          </select>
        </label>
        <label class="form-field" *ngIf="newAccount.tipo === 'projeto'">
          <span>Projeto vinculado</span>
          <input
            type="text"
            class="input"
            name="projetoVinculado"
            [(ngModel)]="newAccount.projetoVinculado"
            placeholder="Nome do projeto"
            required
          />
        </label>
        <label class="checkbox-field full">
          <input
            type="checkbox"
            name="pixVinculado"
            [ngModel]="newAccount.pixVinculado"
            (ngModelChange)="onPixVinculadoChange($event)"
          />
          <span>Possui Pix vinculado</span>
        </label>
        <label class="form-field" *ngIf="newAccount.pixVinculado">
          <span>Tipo de chave Pix</span>
          <select class="select" name="tipoChavePix" [ngModel]="newAccount.tipoChavePix" (ngModelChange)="onTipoChavePixChange($event)">
            <option value="">Selecione</option>
            <option *ngFor="let tipo of tiposChavePix" [value]="tipo.value">{{ tipo.label }}</option>
          </select>
        </label>
        <label class="form-field" *ngIf="newAccount.pixVinculado">
          <span>Chave Pix</span>
          <input
            type="text"
            class="input"
            name="chavePix"
            [ngModel]="newAccount.chavePix"
            (ngModelChange)="onChavePixInput($event)"
          />
          <p class="field-error" *ngIf="erroChavePix">{{ erroChavePix }}</p>
        </label>
        <label class="form-field">
          <span>Saldo informado</span>
          <input
            type="text"
            class="input"
            name="balance"
            [ngModel]="saldoContaMascara"
            (ngModelChange)="onSaldoContaInput($event)"
            placeholder="R$ 0,00"
            autocomplete="transaction-amount"
            required
          />
        </label>
        <label class="form-field">
          <span>ultima atualizacao</span>
          <input
            type="date"
            class="input"
            name="lastUpdate"
            [(ngModel)]="newAccount.dataAtualizacao"
            autocomplete="on"
            required
          />
        </label>
        <div class="form-actions">
          <button class="primary" type="submit">{{ contaEmEdicaoId ? 'Atualizar conta' : 'Salvar conta' }}</button>
          <button *ngIf="contaEmEdicaoId" class="ghost" type="button" (click)="cancelarEdicaoContaBancaria()">
            Cancelar
          </button>
        </div>
      </form>
    </div>

    <div class="filter-bar">
      <label class="form-field">
        <span>Banco</span>
        <input type="text" class="input" [(ngModel)]="filtrosContas.banco" name="filtroBancoContas" placeholder="Nome do banco" />
      </label>
      <label class="form-field">
        <span>Agência</span>
        <input type="text" class="input" [(ngModel)]="filtrosContas.agencia" name="filtroAgenciaContas" placeholder="Agência" />
      </label>
      <label class="form-field">
        <span>Número</span>
        <input type="text" class="input" [(ngModel)]="filtrosContas.numero" name="filtroNumeroContas" placeholder="Número da conta" />
      </label>
      <label class="form-field">
        <span>Tipo</span>
        <select class="select" [(ngModel)]="filtrosContas.tipo" name="filtroTipoContas">
          <option value="">Todos</option>
          <option *ngFor="let tipo of tiposConta" [value]="tipo.value">{{ tipo.label }}</option>
        </select>
      </label>
      <div class="filter-actions">
        <button
          type="button"
          class="ghost"
          (click)="filtrosContas = { banco: '', agencia: '', numero: '', tipo: '' }"
        >
          Limpar filtros
        </button>
      </div>
    </div>

    <p class="muted list-count">Total: {{ contasFiltradas.length }} contas</p>
    <div class="bank-grid" *ngIf="contasFiltradas.length; else emptyBanksTab">
      <article class="bank-card" *ngFor="let account of contasFiltradas">
        <div class="bank-card__header">
          <div class="bank-card__type">
            <span
              class="pill"
              [class.pill--ghost]="account.tipo === 'corrente'"
              [class.pill--warning]="account.tipo !== 'corrente'"
            >
              {{ getTipoContaLabel(account.tipo) }}
            </span>
            <span class="bank-card__project" *ngIf="account.tipo === 'projeto'">
              Projeto: {{ account.projetoVinculado || 'Não informado' }}
            </span>
          </div>
          <div>
            <p class="strong">{{ account.banco }}</p>
            <p class="muted"><strong>Agência:</strong> {{ account.agencia || 'Não informado' }}</p>
            <p class="muted"><strong>Conta:</strong> {{ account.numero }}</p>
            <p class="bank-card__pix" *ngIf="account.pixVinculado || account.chavePix">
              Pix ({{ getTipoChavePixLabel(account.tipoChavePix) }}): {{ account.chavePix || 'Não informado' }}
            </p>
          </div>
        </div>
        <p class="bank-card__balance">{{ account.saldo | currency:'BRL' }}</p>
        <p class="bank-card__updated">Atualizado em {{ formatDate(account.dataAtualizacao) }}</p>
        <div class="bank-card__actions">
          <button class="ghost" type="button" (click)="editarContaBancaria(account)">Editar</button>
          <button class="ghost" type="button" (click)="removerContaBancaria(account)">Excluir</button>
        </div>
      </article>
    </div>
    <ng-template #emptyBanksTab>
      <p class="empty-state">Nenhuma conta cadastrada. Registre contas na aba Visão geral.</p>
    </ng-template>
  </div>

<div class="tab-card" *ngIf="activeTab === 'movimentacoes'">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">Fluxo de caixa</p>
        <p class="muted">Projeções semanais com entradas, saídas e saldo estimado.</p>
      </div>
      <span class="pill">Planejamento continuo</span>
    </div>

    <div class="panel">
      <header class="panel__header">
        <div>
          <p class="panel__eyebrow">Fluxo financeiro</p>
          <p class="panel__title">Projecao semanal de caixa</p>
        </div>
        <span class="pill">Relatórios e fluxos</span>
      </header>
      <div class="flow-chart" *ngIf="cashFlow.length; else emptyFlow">
        <div class="flow-chart__bars" *ngFor="let item of cashFlow">
          <div class="flow-chart__label">{{ item.period }}</div>
          <div class="flow-chart__bar bar-positive" [style.width.%]="item.receivable / 6.5">
            <span>A receber</span>
            <strong>{{ item.receivable | currency:'BRL':'symbol':'1.0-0' }}</strong>
          </div>
          <div class="flow-chart__bar bar-negative" [style.width.%]="item.payable / 6.5">
            <span>A pagar</span>
            <strong>{{ item.payable | currency:'BRL':'symbol':'1.0-0' }}</strong>
          </div>
          <div class="flow-chart__projection">
            <fa-icon [icon]="faFileInvoice"></fa-icon>
            <div>
              <p class="strong">Projecao</p>
              <p class="muted">Saldo estimado de {{ item.projection | currency:'BRL':'symbol':'1.0-0' }}</p>
            </div>
          </div>
        </div>
      </div>
      <ng-template #emptyFlow>
        <p class="empty-state">Cadastre lançamentos e contas para gerar projeções semanais de caixa.</p>
      </ng-template>
    </div>

    <div class="panel-grid three-cols">
      <article class="panel">
        <header class="panel__header">
          <div>
            <p class="panel__eyebrow">Movimentação real</p>
            <p class="panel__title">Registrar entrada ou saída</p>
          </div>
          <span class="pill pill--ghost">Atualiza saldo</span>
        </header>

        <form class="form-grid" (ngSubmit)="registerMovement()">
          <label class="form-field">
            <span>Tipo</span>
            <select class="select" name="movementType" [(ngModel)]="newMovement.tipo" required>
              <option value="entrada">Entrada</option>
              <option value="saida">Saída</option>
            </select>
          </label>
          <label class="form-field">
            <span>Descricao *</span>
            <input
              type="text"
              class="input"
              name="movementDescription"
              [(ngModel)]="newMovement.descricao"
              placeholder="Ex.: Pagamento de fornecedor"
              autocomplete="transaction-purpose"
              required
            />
          </label>
          <label class="form-field">
            <span>Categoria</span>
            <input
              type="text"
              class="input"
              name="movementCategory"
              [(ngModel)]="newMovement.categoria"
              list="categorySuggestions"
              placeholder="Operacional, pessoal, projeto..."
              autocomplete="on"
            />
            <datalist id="categorySuggestions">
              <option value="Operacional"></option>
              <option value="Pessoal"></option>
              <option value="Projeto"></option>
              <option value="Captacao"></option>
            </datalist>
          </label>
          <label class="form-field form-field--wide">
            <span>Contraparte</span>
            <input
              type="text"
              class="input"
              name="movementCounterparty"
              [(ngModel)]="newMovement.contraparte"
              list="counterpartyList"
              placeholder="Fornecedor, prefeitura..."
              autocomplete="organization"
            />
          </label>
          <label class="form-field">
            <span>Conta bancaria *</span>
            <select class="select" name="movementAccount" [(ngModel)]="newMovement.contaBancariaId" required>
              <option value="" disabled>Selecione</option>
              <option *ngFor="let account of bankAccounts" [value]="account.id">
                {{ account.banco }} - Ag {{ account.agencia || '---' }} / {{ account.numero }}
              </option>
            </select>
          </label>
          <label class="form-field">
            <span>Data *</span>
            <input type="date" class="input" name="movementDate" [(ngModel)]="newMovement.dataMovimentacao" required />
          </label>
          <label class="form-field">
            <span>Valor *</span>
            <input
              type="number"
              class="input"
              name="movementAmount"
              [(ngModel)]="newMovement.valor"
              step="0.01"
              min="0"
              placeholder="0,00"
              autocomplete="transaction-amount"
              required
            />
          </label>
          <div class="form-actions">
            <button class="primary" type="submit">Registrar movimentacao</button>
          </div>
        </form>
      </article>

      <article class="panel">
        <header class="panel__header">
          <div>
            <p class="panel__eyebrow">Movimentações registradas</p>
            <p class="panel__title">Histórico financeiro</p>
          </div>
          <span class="pill">Rastreamento</span>
        </header>
        
        <div class="filter-bar">
          <label class="form-field">
            <span>Descrição</span>
            <input type="text" class="input" [(ngModel)]="filtrosMovimentacoes.descricao" name="filtroMovDescricao" placeholder="Pagamento, repasse..." />
          </label>
          <label class="form-field">
            <span>Categoria</span>
            <input type="text" class="input" [(ngModel)]="filtrosMovimentacoes.categoria" name="filtroMovCategoria" placeholder="Operacional, projeto..." />
          </label>
          <label class="form-field">
            <span>Tipo</span>
            <select class="select" [(ngModel)]="filtrosMovimentacoes.tipo" name="filtroMovTipo">
              <option value="">Todos</option>
              <option value="entrada">Entrada</option>
              <option value="saida">Saída</option>
            </select>
          </label>
        </div>

<p class="muted list-count">Total: {{ movimentacoesFiltradas.length }} movimentacoes</p>
        <div class="table-wrapper" *ngIf="movimentacoesFiltradas.length; else emptyMovements">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Data</th>
                <th>Descrição</th>
                <th>Conta</th>
                <th>Categoria</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let movement of movimentacoesFiltradas; index as i">
                <td>{{ i + 1 }}</td>
                <td>{{ formatDate(movement.dataMovimentacao) }}</td>
                <td>
                  <p class="strong">{{ movement.descricao }}</p>
                  <p class="muted">{{ movement.contraparte || 'Não informado' }}</p>
                </td>
                <td>{{ movement.contaBancariaNumero || "---" }}</td>
                <td>{{ movement.categoria }}</td>
                <td>
                  <span class="tag" [class.positive]="movement.tipo === 'entrada'">
                    {{ movement.tipo === 'entrada' ? '+' : '-' }}
                    {{ movement.valor | currency:'BRL' }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <ng-template #emptyMovements>
          <p class="empty-state">Inclua lançamentos reais para acompanhar o histórico de entradas e saídas.</p>
        </ng-template>
      </article>

      <article class="panel">
        <header class="panel__header">
          <div>
            <p class="panel__eyebrow">Próximas entradas e saídas</p>
            <p class="panel__title">Prioridades da semana</p>
          </div>
          <span class="pill pill--warning">Urgente</span>
        </header>
        <div class="pillars" *ngIf="upcomingReceivables.length || upcomingPayables.length; else emptyPipelines">
          <ng-container *ngFor="let item of upcomingReceivables | slice:0:3">
            <div class="pipeline-row positive">
              <div>
                <p class="strong">{{ item.descricao }}</p>
                <p class="muted">{{ formatDate(item.vencimento) }} - {{ item.contraparte }}</p>
              </div>
              <span class="tag positive">{{ item.valor | currency:'BRL' }}</span>
            </div>
          </ng-container>
          <ng-container *ngFor="let item of upcomingPayables | slice:0:3">
            <div class="pipeline-row">
              <div>
                <p class="strong">{{ item.descricao }}</p>
                <p class="muted">{{ formatDate(item.vencimento) }} - {{ item.contraparte }}</p>
              </div>
              <span class="tag">{{ item.valor | currency:'BRL' }}</span>
            </div>
          </ng-container>
        </div>
        <ng-template #emptyPipelines>
          <p class="empty-state">Cadastre contas para acompanhar prioridades da semana.</p>
        </ng-template>
      </article>
    </div>
  </div>
  <div class="tab-card" *ngIf="activeTab === 'emendas'">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">Emendas impositivas</p>
        <p class="muted">Controle de valores a receber com alertas e status.</p>
      </div>
    </div>

    <div class="panel">
      <header class="panel__header">
        <div>
          <p class="panel__eyebrow">Emendas</p>
          <p class="panel__title">Cadastrar nova emenda</p>
        </div>
        <span class="pill">Alertas</span>
      </header>

      <form class="form-grid" (ngSubmit)="addAmendment()">
        <label class="form-field">
          <span>Identificacao *</span>
          <input type="text" class="input" name="name" [(ngModel)]="newAmendment.identificacao" placeholder="Emenda 001/2024" required />
        </label>
        <label class="form-field">
          <span>Referencia legal</span>
          <input type="text" class="input" name="lawReference" [(ngModel)]="newAmendment.referenciaLegal" placeholder="Lei ou oficio" />
        </label>
        <label class="form-field">
          <span>Previsao de recebimento *</span>
          <input type="date" class="input" name="expectedDate" [(ngModel)]="newAmendment.dataPrevista" required />
        </label>
        <label class="form-field">
          <span>Valor previsto *</span>
          <input type="number" class="input" name="amount" [(ngModel)]="newAmendment.valorPrevisto" step="0.01" min="0" placeholder="0,00" required />
        </label>
        <label class="form-field">
          <span>Antecedencia do alerta (dias) *</span>
          <input type="number" class="input" name="alertDays" [(ngModel)]="newAmendment.diasAlerta" min="1" required />
        </label>
        <label class="form-field">
          <span>Status *</span>
          <select class="select" name="status" [(ngModel)]="newAmendment.status" required>
            <option value="previsto">Previsto</option>
            <option value="empenhado">Empenhado</option>
            <option value="recebido">Recebido</option>
          </select>
        </label>
        <label class="form-field">
          <span>Observações</span>
          <textarea class="input" name="notes" [(ngModel)]="newAmendment.observacoes" rows="2" placeholder="Responsavel, etapa ou vinculo"></textarea>
        </label>
        <div class="form-actions">
          <button class="primary" type="submit">Controlar emenda</button>
        </div>
      </form>
    </div>

    <div class="filter-bar">
      <label class="form-field">
        <span>Identificacao</span>
        <input type="text" class="input" [(ngModel)]="filtrosEmendas.identificacao" name="filtroEmenda" placeholder="Emenda 001/2024" />
      </label>
      <label class="form-field">
        <span>Status</span>
        <select class="select" [(ngModel)]="filtrosEmendas.status" name="filtroEmendaStatus">
          <option value="">Todos</option>
          <option value="previsto">Previsto</option>
          <option value="empenhado">Empenhado</option>
          <option value="recebido">Recebido</option>
        </select>
      </label>
      <div class="filter-actions">
        <button type="button" class="ghost" (click)="filtrosEmendas = { identificacao: '', status: '' }">Limpar filtros</button>
      </div>
    </div>

    <p class="muted list-count">Total: {{ emendasFiltradas.length }} emendas</p>
    <ul class="pillars" *ngIf="emendasFiltradas.length; else emptyAmendments">
      <li *ngFor="let amendment of emendasFiltradas">
        <div>
          <p class="strong">{{ amendment.identificacao }}</p>
          <p class="muted">{{ amendment.referenciaLegal || 'Sem referencia' }} - {{ formatDate(amendment.dataPrevista) }}</p>
          <p class="muted">{{ amendment.observacoes || 'Sem observacoes' }}</p>
        </div>
        <div class="tag-wrapper">
          <span class="tag positive">{{ amendment.valorPrevisto | currency:'BRL' }}</span>
          <button class="pill pill--ghost" type="button" (click)="setAmendmentStatus(amendment, 'recebido')">Marcar recebido</button>
        </div>
      </li>
    </ul>
    <ng-template #emptyAmendments>
      <p class="empty-state">Cadastre suas emendas impositivas para monitorar datas e alertas automaticos.</p>
    </ng-template>
  </div>

  <div class="tab-card" *ngIf="activeTab === 'relatorios'">
    <div class="panel-grid three-cols">
      <article class="panel">
        <header class="panel__header">
          <div>
            <p class="panel__eyebrow">Alertas e lembretes</p>
            <p class="panel__title">Próximas datas críticas</p>
          </div>
          <span class="pill pill--ghost">Automatico</span>
        </header>
        <ul class="alert-list" *ngIf="alerts.length; else emptyAlerts">
          <li *ngFor="let alert of alerts">
            <fa-icon [icon]="faBell"></fa-icon>
            <span>{{ alert }}</span>
          </li>
        </ul>
        <ng-template #emptyAlerts>
          <p class="empty-state">Sem alertas pendentes.</p>
        </ng-template>
      </article>

      <article class="panel">
        <header class="panel__header">
          <div>
            <p class="panel__eyebrow">Resumo para impressão</p>
            <p class="panel__title">Saldos recebidos e a receber</p>
          </div>
          <button class="ghost" type="button" (click)="printResumo()">
            <fa-icon [icon]="faPrint"></fa-icon>
            Gerar PDF
          </button>
        </header>
        <div class="report-preview">
          <div class="report-row">
            <p class="strong">Recebimentos registrados</p>
            <p>{{ reportTotals.recebimentos | currency:'BRL' }}</p>
          </div>
          <div class="report-row">
            <p class="strong">Pagamentos realizados</p>
            <p>{{ reportTotals.pagamentos | currency:'BRL' }}</p>
          </div>
          <div class="report-row">
            <p class="strong">Saldo a receber</p>
            <p>{{ reportTotals.saldoAReceber | currency:'BRL' }}</p>
          </div>
          <div class="report-row total">
            <p class="strong">Saldo projetado</p>
            <p>{{ reportTotals.saldoProjetado | currency:'BRL' }}</p>
          </div>
        </div>
      </article>
    </div>

    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">Relatórios e exportações</p>
        <p class="muted">Materiais essenciais para prestacao de contas e auditorias.</p>
      </div>
      <span class="pill">Documentos</span>
    </div>

    <div class="panel-grid three-cols">
      <article class="panel">
        <header class="panel__header">
          <div>
            <p class="panel__eyebrow">Relatórios</p>
            <p class="panel__title">Fluxos e demonstrativos</p>
          </div>
        </header>
        <div class="report-cards">
          <button type="button" class="report-card" (click)="printResumo()">
            <fa-icon [icon]="faFileInvoice"></fa-icon>
            <div>
              <p class="strong">DRE simplificada</p>
              <p class="muted">Receitas x despesas por projeto</p>
            </div>
          </button>
          <button type="button" class="report-card" (click)="printResumo()">
            <fa-icon [icon]="faMoneyBillTransfer"></fa-icon>
            <div>
              <p class="strong">Fluxo de caixa projetado</p>
              <p class="muted">12 semanas com cenarios</p>
            </div>
          </button>
          <button type="button" class="report-card" (click)="printResumo()">
            <fa-icon [icon]="faChartLine"></fa-icon>
            <div>
              <p class="strong">Custeio administrativo</p>
              <p class="muted">Gastos fixos e variaveis</p>
            </div>
          </button>
        </div>
      </article>

      <article class="panel">
        <header class="panel__header">
          <div>
            <p class="panel__eyebrow">Agenda critica</p>
            <p class="panel__title">Resumo de pendências</p>
          </div>
          <span class="pill pill--ghost">Imediato</span>
        </header>
        <ul class="pillars" *ngIf="agenda.length; else emptyAgendaQuick">
          <li *ngFor="let item of agenda | slice:0:3">
            <div>
              <p class="strong">{{ item.descricao }}</p>
              <p class="muted">{{ formatDate(item.vencimento) }} - {{ item.contraparte }}</p>
            </div>
            <span class="tag" [class.positive]="item.tipo === 'receber'">{{ item.valor | currency:'BRL' }}</span>
          </li>
        </ul>
        <ng-template #emptyAgendaQuick>
          <p class="empty-state">Cadastre lançamentos para acompanhar pendências na impressão.</p>
        </ng-template>
      </article>

      <article class="panel">
        <header class="panel__header">
          <div>
            <p class="panel__eyebrow">Ações rapidas</p>
            <p class="panel__title">Registro e notificações</p>
          </div>
        </header>
        <div class="quick-actions">
          <button class="ghost" type="button" (click)="printResumo()">Gerar PDF completo</button>
          <button class="ghost" type="button" (click)="changeTab('visao-geral')">Voltar para lançamentos</button>
          <button class="ghost" type="button" (click)="changeTab('movimentacoes')">Ver projeções</button>
        </div>
      </article>
    </div>
  </div>
</section>

<app-dialog
  [aberto]="dialogConfirmacaoAberta"
  [titulo]="dialogTitulo"
  [mensagem]="dialogMensagem"
  [confirmarLabel]="dialogConfirmarLabel"
  [cancelarLabel]="dialogCancelarLabel"
  (confirmar)="confirmarDialogo()"
  (cancelar)="cancelarDialogo()"
></app-dialog>
</app-tela-padrao>





