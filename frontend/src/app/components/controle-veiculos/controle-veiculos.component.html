<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  (buscar)="buscar()"
  (salvar)="salvar()"
  (excluir)="excluir()"
  (novo)="novo()"
  (cancelar)="cancelar()"
  (imprimir)="imprimir()"
  (fechar)="fechar()"
>
  <header class="page-title page-title--row" slot="titulo">
    <div>
      <p class="page-title__eyebrow">SETOR ADMINISTRATIVO</p>
      <p class="page-title__label">Controle de veiculos</p>
    </div>
    <p class="page-title__note page-title__note--right">
      Diario de bordo e cadastro de veiculos.
    </p>
  </header>

  <section class="controle-veiculos">
    <app-popup-messages [mensagens]="popupErros" (fechar)="fecharPopup()"></app-popup-messages>

    <div class="muted" *ngIf="carregando">Carregando dados do controle de veiculos...</div>

    <div *ngIf="mensagemFeedback" class="feedback">
      <span>{{ mensagemFeedback }}</span>
      <button type="button" class="feedback__close" (click)="mensagemFeedback = null" aria-label="Fechar aviso">
        &times;
      </button>
    </div>

    <div class="tab-shell">
      <p class="tab-shell__title">Navegue pelas informações</p>
      <ol class="step-tabs" role="tablist">
        <li
        *ngFor="let tab of abas; index as idx"
        class="step-tabs__item"
        [class.active]="abaAtiva === tab.id"
        [class.completed]="idx < indiceAbaAtiva"
      >
        <button
          class="step-tabs__button"
          type="button"
          role="tab"
          [attr.aria-selected]="abaAtiva === tab.id"
          (click)="mudarAba(tab.id)"
        >
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ tab.label }}</span>
          </button>
        </li>
      </ol>
    </div>

    <form *ngIf="abaAtiva === 'cadastro'" [formGroup]="formularioVeiculo" class="form-shell">
      <section class="tab-card" #cartaoMotoristas>
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">cadastro de veiculos</p>
            <p class="muted">Mantenha a frota organizada com dados completos.</p>
          </div>
        </div>

        <div class="field-grid cols-3">
          <label class="field" [class.invalid]="formularioVeiculo.get('placa')?.invalid && formularioVeiculo.get('placa')?.touched">
            Placa
            <input type="text" formControlName="placa" placeholder="ABC-1234" />
            <span
              class="field-error"
              *ngIf="
                formularioVeiculo.get('placa')?.errors?.['placaInvalida'] &&
                formularioVeiculo.get('placa')?.touched
              "
            >
              Informe LLL-NNNN ou LLLNLNN.
            </span>
          </label>

          <label class="field" [class.invalid]="formularioVeiculo.get('modelo')?.invalid && formularioVeiculo.get('modelo')?.touched">
            Modelo
            <input type="text" formControlName="modelo" placeholder="Ex.: Gol" />
          </label>

          <label class="field" [class.invalid]="formularioVeiculo.get('marca')?.invalid && formularioVeiculo.get('marca')?.touched">
            Marca
            <input type="text" formControlName="marca" placeholder="Ex.: Volkswagen" list="marcasPrincipais" />
            <datalist id="marcasPrincipais">
              <option *ngFor="let marcaItem of marcasPrincipais" [value]="marcaItem"></option>
            </datalist>
          </label>

          <label class="field" [class.invalid]="formularioVeiculo.get('ano')?.invalid && formularioVeiculo.get('ano')?.touched">
            Ano
            <input type="number" formControlName="ano" min="1900" />
          </label>

          <label class="field" [class.invalid]="formularioVeiculo.get('tipoCombustivel')?.invalid && formularioVeiculo.get('tipoCombustivel')?.touched">
            Tipo de combustivel
            <select formControlName="tipoCombustivel">
              <option value="">Selecione</option>
              <option value="Gasolina">Gasolina</option>
              <option value="Etanol">Etanol</option>
              <option value="Diesel">Diesel</option>
              <option value="Flex">Flex</option>
              <option value="Eletrico">Eletrico</option>
            </select>
          </label>

          <label class="field" [class.invalid]="formularioVeiculo.get('mediaConsumoPadrao')?.invalid && formularioVeiculo.get('mediaConsumoPadrao')?.touched">
            Media de consumo (km/L)
            <input type="number" formControlName="mediaConsumoPadrao" min="0" step="0.1" />
          </label>

          <label class="field">
            Capacidade do tanque (L)
            <input type="number" formControlName="capacidadeTanqueLitros" min="0" step="0.1" />
          </label>

          <label class="field full">
            Observações
            <textarea formControlName="observacoes" rows="3"></textarea>
          </label>

          <div class="document-section full">
            <div class="document-request">
              <div class="document-request__header">
                <div>
                  <p class="document-request__title">Documento do veiculo</p>
                  <p class="document-request__subtitle">
                    Anexe o documento do veiculo em PDF.
                  </p>
                </div>
              </div>
              <div class="envio-fotos-container">
                <div class="campo">
                  <label>Arquivo (PDF)</label>
                  <input type="file" accept="application/pdf" (change)="onDocumentoVeiculoSelecionado($event)" />
                </div>

                <div class="info">
                  Envie o documento em formato PDF para consulta futura.
                </div>
              </div>

              <div class="document-table">
                <table>
                  <thead>
                    <tr>
                      <th>Documento</th>
                      <th class="text-right">ações</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>{{ documentoVeiculoPdf ? 'Documento anexado' : 'Nenhum documento anexado' }}</td>
                      <td class="text-right actions">
                        <button
                          type="button"
                          class="ghost"
                          [disabled]="!documentoVeiculoPdf"
                          (click)="visualizarDocumentoVeiculo()"
                        >
                          Visualizar
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <label class="checkbox-field full">
            <input type="checkbox" formControlName="ativo" />
            <span>Veiculo ativo</span>
          </label>

          <div class="document-section full">
            <div class="document-request">
              <div class="document-request__header">
                <div>
                  <p class="document-request__title">Envio de fotos</p>
                  <p class="document-request__subtitle">
                    Selecione o tipo de foto, anexe o arquivo e visualize na listagem.
                  </p>
                </div>
              </div>
              <p class="document-count document-count--top">
                Fotos anexadas
                <span class="document-count__badge">{{ fotosAnexadas.length }}</span>
              </p>
              <div class="envio-fotos-container">
                <div class="campo">
                  <label>Tipo de foto</label>
                  <select [(ngModel)]="tipoFotoSelecionada" [ngModelOptions]="{ standalone: true }">
                    <option value="">Selecione</option>
                    <option *ngFor="let tipo of tiposFoto" [value]="tipo">{{ tipo }}</option>
                  </select>
                </div>

                <div class="campo">
                  <label>Arquivo</label>
                  <input type="file" accept="image/*" (change)="onFotoTipoSelecionada($event)" />
                </div>

                <div class="info">
                  Use fotos em boa resolucao para melhor visualização.
                </div>
              </div>

              <div class="document-table">
                <table>
                  <thead>
                    <tr>
                      <th>Tipo</th>
                      <th>Arquivo</th>
                      <th class="text-right">ações</th>
                    </tr>
                  </thead>
                  <tbody *ngIf="fotosAnexadas.length; else emptyFotos">
                    <tr *ngFor="let foto of fotosAnexadas">
                      <td>{{ foto.tipo }}</td>
                      <td>Arquivo anexado</td>
                      <td class="text-right actions">
                        <button type="button" class="ghost" (click)="visualizarFoto(foto.tipo)">
                          Visualizar
                        </button>
                        <button type="button" class="ghost destructive" (click)="removerFotoPorTipo(foto.tipo)">
                          Remover
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <ng-template #emptyFotos>
                  <tbody>
                    <tr>
                      <td colspan="3" class="list-panel__empty">
                        Nenhuma foto anexada ate o momento.
                      </td>
                    </tr>
                  </tbody>
                </ng-template>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="list-card">
        <div class="list-card__header">
          <div>
            <p class="list-card__eyebrow">Veiculos cadastrados</p>
            <p class="list-card__title">Selecione para editar ou excluir.</p>
          </div>
          <div class="list-card__actions">
            <span class="muted">Total: {{ veiculos.length }}</span>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Placa</th>
              <th>Modelo</th>
              <th>Marca</th>
              <th>Ano</th>
              <th>Status</th>
              <th class="text-right">ações</th>
            </tr>
          </thead>
          <tbody *ngIf="veiculos.length; else semVeiculos">
            <tr *ngFor="let veiculo of veiculos">
              <td>{{ veiculo.placa }}</td>
              <td>{{ veiculo.modelo }}</td>
              <td>{{ veiculo.marca }}</td>
              <td>{{ veiculo.ano }}</td>
              <td>{{ veiculo.ativo ? 'Ativo' : 'Inativo' }}</td>
              <td class="text-right">
                <button type="button" class="ghost" (click)="selecionarVeiculo(veiculo)">Selecionar</button>
              </td>
            </tr>
          </tbody>
        </table>

        <ng-template #semVeiculos>
          <p class="empty">Nenhum veiculo cadastrado ate o momento.</p>
        </ng-template>
      </section>
    </form>

    <form *ngIf="abaAtiva === 'diario'" [formGroup]="formularioDiario" class="form-shell">
      <section class="tab-card">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">Mapa de bordo</p>
            <p class="muted">Registre cada viagem e acompanhe o consumo.</p>
          </div>
        </div>

        <div class="field-grid cols-3">
          <label class="field" [class.invalid]="formularioDiario.get('veiculoId')?.invalid && formularioDiario.get('veiculoId')?.touched">
            Veiculo
            <select formControlName="veiculoId">
              <option [ngValue]="null">Selecione</option>
              <option *ngFor="let veiculo of veiculos" [ngValue]="veiculo.id">
                {{ veiculo.placa }} - {{ veiculo.modelo }}
              </option>
            </select>
          </label>

          <label class="field" [class.invalid]="formularioDiario.get('data')?.invalid && formularioDiario.get('data')?.touched">
            Data
            <input type="date" formControlName="data" />
          </label>

          <label class="field" [class.invalid]="formularioDiario.get('condutor')?.invalid && formularioDiario.get('condutor')?.touched">
            Condutor
            <select formControlName="condutor">
              <option value="">Selecione</option>
              <option *ngFor="let motorista of motoristasAutorizadosPorVeiculo" [value]="motorista.nomeMotorista">
                {{ motorista.nomeMotorista }}
              </option>
            </select>
          </label>

          <label class="field" [class.invalid]="formularioDiario.get('horarioSaida')?.invalid && formularioDiario.get('horarioSaida')?.touched">
            Horario de saida
            <input type="time" formControlName="horarioSaida" />
          </label>

          <label class="field" [class.invalid]="formularioDiario.get('kmInicial')?.invalid && formularioDiario.get('kmInicial')?.touched">
            Km inicial
            <input type="number" formControlName="kmInicial" min="0" />
          </label>

          <label class="field" [class.invalid]="formularioDiario.get('horarioChegada')?.invalid && formularioDiario.get('horarioChegada')?.touched">
            Horario de chegada
            <input type="time" formControlName="horarioChegada" />
          </label>

          <label class="field" [class.invalid]="formularioDiario.get('kmFinal')?.invalid && formularioDiario.get('kmFinal')?.touched">
            Km final
            <input type="number" formControlName="kmFinal" min="0" />
          </label>

          <label class="field full field-destino" [class.invalid]="formularioDiario.get('destino')?.invalid && formularioDiario.get('destino')?.touched">
            Destino
            <input type="text" formControlName="destino" placeholder="Local visitado" />
          </label>

          <label class="field full">
            Observações
            <textarea formControlName="observacoes" rows="3"></textarea>
          </label>
        </div>

        <div class="resumo-viagem">
          <div class="resumo-viagem__item">
            <p class="resumo-viagem__label">Km rodados</p>
            <p class="resumo-viagem__value">{{ formatarNumero(kmRodadosCalculado, 1) }}</p>
          </div>
          <div class="resumo-viagem__item">
            <p class="resumo-viagem__label">Media de consumo (km/L)</p>
            <p class="resumo-viagem__value">{{ formatarNumero(mediaConsumoCalculada, 2) }}</p>
          </div>
          <div class="resumo-viagem__item">
            <p class="resumo-viagem__label">Combustivel consumido (L)</p>
            <p class="resumo-viagem__value">{{ formatarNumero(combustivelConsumidoCalculado, 2) }}</p>
          </div>
        </div>
      </section>

      <section class="list-card">
        <div class="list-card__header">
          <div>
            <p class="list-card__eyebrow">Registros do diario</p>
            <p class="list-card__title">Selecione um registro para editar.</p>
          </div>
          <div class="list-card__actions">
            <span class="muted">Total: {{ registros.length }}</span>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Veiculo</th>
              <th>Condutor</th>
              <th>Km rodados</th>
              <th>Media (km/L)</th>
              <th>Combustivel (L)</th>
              <th>Destino</th>
              <th class="text-right">ações</th>
            </tr>
          </thead>
          <tbody *ngIf="registros.length; else semRegistros">
            <tr *ngFor="let registro of registros">
              <td>{{ registro.data | date : 'dd/MM/yyyy' }}</td>
              <td>{{ obterDescricaoVeiculo(registro.veiculoId) }}</td>
              <td>{{ registro.condutor }}</td>
              <td>{{ formatarNumero(registro.kmRodados, 1) }}</td>
              <td>{{ formatarNumero(registro.mediaConsumo, 2) }}</td>
              <td>{{ formatarNumero(registro.combustivelConsumidoLitros, 2) }}</td>
              <td>{{ registro.destino }}</td>
              <td class="text-right">
                <button type="button" class="ghost" (click)="selecionarRegistro(registro)">
                  Selecionar
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <ng-template #semRegistros>
          <p class="empty">Nenhum registro de bordo cadastrado ate o momento.</p>
        </ng-template>
      </section>
    </form>

    <form *ngIf="abaAtiva === 'motoristas'" [formGroup]="formularioMotorista" class="form-shell">
      <section class="tab-card">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">Motoristas autorizados</p>
            <p class="muted">Defina quem esta autorizado a conduzir veiculos da instituicao.</p>
          </div>
        </div>

        <div class="field-grid cols-3">
          <div class="field full">
            Veiculos autorizados
            <div class="motoristas-veiculos-grid">
              <label class="motoristas-veiculos-card" *ngFor="let veiculo of veiculos">
                <input
                  type="checkbox"
                  [checked]="veiculoSelecionado(veiculo.id)"
                  (change)="alternarVeiculoSelecionado(veiculo.id)"
                />
                <div class="motoristas-veiculos-texto">
                  <span class="motoristas-veiculos-placa">
                    Placa: {{ veiculo.placa || '--' }}
                  </span>
                  <span class="motoristas-veiculos-detalhes">
                    <span class="motoristas-veiculos-label">Modelo:</span>
                    <span>{{ veiculo.modelo || '--' }}</span>
                  </span>
                  <span class="motoristas-veiculos-detalhes">
                    <span class="motoristas-veiculos-label">Marca:</span>
                    <span>{{ veiculo.marca || '--' }}</span>
                  </span>
                </div>
              </label>
            </div>
          </div>

          <label class="field">
            Origem do motorista
            <select formControlName="tipoOrigem" (change)="aoAlterarTipoOrigem()">
              <option value="PROFISSIONAL">Profissional</option>
              <option value="VOLUNTARIO">Voluntario</option>
            </select>
          </label>

          <label class="field">
            Carteira de motorista
            <input type="text" formControlName="numeroCarteira" placeholder="Numero da CNH" />
          </label>

          <label class="field">
            Categoria
            <input type="text" formControlName="categoriaCarteira" placeholder="Ex.: B" />
          </label>

          <label class="field">
            Vencimento
            <input type="date" formControlName="vencimentoCarteira" />
          </label>

          <label class="field full">
            Motorista
            <app-autocomplete
              [opcoes]="opcoesMotorista"
              [termo]="termoMotorista"
              [carregando]="carregandoMotoristas"
              [erro]="erroMotoristas"
              placeholder="Digite o nome do motorista"
              (termoChange)="atualizarTermoMotorista($event)"
              (selecionar)="selecionarMotorista($event)"
            ></app-autocomplete>
          </label>

          <div class="document-table full">
            <table>
              <thead>
                <tr>
                  <th>Arquivo da carteira (PDF)</th>
                  <th class="text-right">ações</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <div class="carteira-anexo">
                      <input type="file" accept="application/pdf" (change)="onCarteiraSelecionada($event)" />
                      <span class="muted">
                        {{ carteiraPdfSelecionada ? 'Arquivo anexado' : 'Nenhum arquivo anexado' }}
                      </span>
                    </div>
                  </td>
                  <td class="text-right actions">
                    <button
                      type="button"
                      class="ghost"
                      [disabled]="!carteiraPdfSelecionada"
                      (click)="visualizarCarteiraPdf(carteiraPdfSelecionada)"
                    >
                      Visualizar
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="list-card">
        <div class="list-card__header">
          <div>
            <p class="list-card__eyebrow">Motoristas autorizados</p>
            <p class="list-card__title">
              {{ motoristaSelecionadoId ? 'Edite os dados dos motoristas autorizados.' : 'Selecione para editar ou excluir.' }}
            </p>
          </div>
          <div class="list-card__actions">
            <span class="muted">Total: {{ motoristasAutorizados.length }}</span>
          </div>
        </div>
        <div class="alert alert-warning alert-inline" *ngIf="mostrarAlertaEdicao">
          <span class="alert__message">Edite os dados dos motoristas autorizados.</span>
          <button type="button" class="alert__close" aria-label="Fechar" (click)="mostrarAlertaEdicao = false">
            &times;
          </button>
        </div>

        <div class="motoristas-resumo" *ngIf="motoristasPorVeiculo.length">
          <p class="motoristas-resumo__titulo">Veiculos e motoristas autorizados</p>
          <div class="motoristas-resumo__grid">
            <div class="motoristas-resumo__card" *ngFor="let item of motoristasPorVeiculo">
              <p class="motoristas-resumo__veiculo">{{ item.descricao }}</p>
              <ul class="motoristas-resumo__lista">
                <li *ngFor="let nome of item.motoristas">{{ nome }}</li>
              </ul>
            </div>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Veiculo</th>
              <th>Motorista</th>
              <th>Origem</th>
              <th>Carteira</th>
              <th>Categoria</th>
              <th>Vencimento</th>
              <th>Arquivo</th>
              <th class="text-right">ações</th>
            </tr>
          </thead>
          <tbody *ngIf="motoristasAutorizados.length; else semMotoristas">
            <tr *ngFor="let motorista of motoristasAutorizados">
              <td>{{ motorista.placaVeiculo }} - {{ motorista.modeloVeiculo }}</td>
              <td>{{ motorista.nomeMotorista }}</td>
              <td>{{ motorista.tipoOrigem === 'PROFISSIONAL' ? 'Profissional' : 'Voluntario' }}</td>
              <td>{{ motorista.numeroCarteira || '--' }}</td>
              <td>{{ motorista.categoriaCarteira || '--' }}</td>
              <td>{{ motorista.vencimentoCarteira ? (motorista.vencimentoCarteira | date : 'dd/MM/yyyy') : '--' }}</td>
              <td>
                <button
                  type="button"
                  class="ghost"
                  [disabled]="!motorista.arquivoCarteiraPdf"
                  (click)="visualizarCarteiraPdf(motorista.arquivoCarteiraPdf)"
                >
                  Visualizar
                </button>
              </td>
              <td class="text-right">
                <button type="button" class="ghost" (click)="selecionarMotoristaAutorizado(motorista)">
                  Selecionar
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <ng-template #semMotoristas>
          <p class="empty">Nenhum motorista autorizado cadastrado ate o momento.</p>
        </ng-template>
      </section>
    </form>
  </section>

  <app-dialog
    [aberto]="dialogoExclusaoAberto"
    [titulo]="dialogoTitulo"
    [mensagem]="dialogoMensagem"
    [confirmarLabel]="dialogoConfirmarLabel"
    (confirmar)="confirmarExclusao()"
    (cancelar)="cancelarExclusao()"
  ></app-dialog>
</app-tela-padrao>

<div class="modal-overlay" *ngIf="carteiraPdfAberto">
  <div class="modal-card modal-card--carteira" role="dialog" aria-modal="true">
    <div class="modal-card__header">
      <div>
        <p class="modal-card__eyebrow">Carteira de motorista</p>
        <p class="modal-card__title">Visualização do PDF</p>
      </div>
      <button type="button" class="ghost" (click)="fecharCarteiraPdf()" aria-label="Fechar">&times;</button>
    </div>
    <div class="modal-card__body">
      <iframe *ngIf="carteiraPdfSeguro" [src]="carteiraPdfSeguro" title="Carteira de motorista"></iframe>
    </div>
    <div class="modal-card__actions">
      <button type="button" class="ghost" (click)="fecharCarteiraPdf()">Fechar</button>
      <button type="button" class="primary" (click)="imprimirCarteiraPdf()">Imprimir</button>
    </div>
  </div>
</div>

