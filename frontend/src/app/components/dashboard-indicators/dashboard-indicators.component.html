<div class="p-6 space-y-6">
  <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-6 flex flex-col gap-4">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold">Indicadores da Assistencia</h1>
        <p class="text-slate-600">Acompanhe indicadores operacionais e sociais em tempo real.</p>
      </div>
      <div class="flex flex-wrap items-end gap-3">
        <label class="field">
          <span class="field__label">Data inicial</span>
          <input class="input" type="date" [(ngModel)]="filters.startDate" />
        </label>
        <label class="field">
          <span class="field__label">Data final</span>
          <input class="input" type="date" [(ngModel)]="filters.endDate" />
        </label>
        <button class="primary" type="button" (click)="refresh()">Atualizar</button>
      </div>
    </div>
  </div>

  <div *ngIf="dashboardService.error() && !loading" class="bg-white rounded-xl border border-rose-200 shadow-sm p-6 text-rose-700">
    <p class="font-semibold">Falha ao carregar os indicadores.</p>
    <p class="text-sm">{{ dashboardService.error() }}</p>
  </div>

  <ng-container *ngIf="!loading && top12 as indicadores; else loadingState">
    <div class="grid gap-4 lg:grid-cols-4 md:grid-cols-2">
      <div
        class="stat-card stat-card--center"
        *ngFor="let card of [
          { label: 'Beneficiarios atendidos', value: indicadores.beneficiariosAtendidosPeriodo, icon: 'groups', hint: 'Atendimentos no periodo.', tone: 'stat-card--emerald' },
          { label: 'Familias em extrema pobreza', value: indicadores.familiasExtremaPobreza, icon: 'diversity_3', hint: 'Familias em alta vulnerabilidade.', tone: 'stat-card--rose' },
          { label: 'Renda media familiar', value: indicadores.rendaMediaFamiliar | currency: 'BRL', icon: 'savings', hint: 'Media registrada no periodo.', tone: 'stat-card--indigo' },
          { label: 'Termos vencendo', value: indicadores.termosVencendo, icon: 'warning', hint: 'Termos proximos do vencimento.', tone: 'stat-card--amber' }
        ]"
        [ngClass]="card.tone"
      >
        <div class="stat-card__icon">
          <span class="material-icons">{{ card.icon }}</span>
        </div>
        <div>
          <p class="stat-card__label">{{ card.label }}</p>
          <p class="stat-card__value">{{ card.value }}</p>
          <p class="stat-card__hint">{{ card.hint }}</p>
        </div>
      </div>
    </div>

    <div class="grid gap-4 lg:grid-cols-3 md:grid-cols-2" *ngIf="atendimento">
      <div class="mini-card">
        <p class="mini-card__label">cadastro completo</p>
        <p class="mini-card__value">{{ atendimento.cadastroCompletoPercentual | number: '1.0-0' }}%</p>
      </div>
      <div class="mini-card">
        <p class="mini-card__label">Novos beneficiarios</p>
        <p class="mini-card__value">{{ atendimento.novosBeneficiarios }}</p>
      </div>
      <div class="mini-card">
        <p class="mini-card__label">Beneficiarios ativos</p>
        <p class="mini-card__value">{{ atendimento.ativos }}</p>
      </div>
    </div>

    <div class="grid gap-4 lg:grid-cols-3 md:grid-cols-2" *ngIf="familias as grupo">
      <div class="mini-card">
        <p class="mini-card__label">Familias cadastradas</p>
        <p class="mini-card__value">{{ grupo.total }}</p>
      </div>
      <div class="mini-card">
        <p class="mini-card__label">Media de pessoas</p>
        <p class="mini-card__value">{{ grupo.mediaPessoas | number: '1.1-1' }}</p>
      </div>
      <div class="mini-card">
        <p class="mini-card__label">Renda media familiar</p>
        <p class="mini-card__value">{{ grupo.rendaMediaFamiliar | currency: 'BRL' }}</p>
      </div>
    </div>

    <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-6" *ngIf="atendimento as dadosAtendimento">
      <div class="flex items-center justify-between gap-4">
        <div>
          <h3 class="text-base font-semibold text-slate-900">Faixa etaria por idade</h3>
          <p class="text-sm text-slate-500">Distribuicao de beneficiarios por idade registrada.</p>
        </div>
        <div class="text-right text-sm text-slate-600">
          <p>Total: {{ obterTotalIdades(dadosAtendimento) }}</p>
        </div>
      </div>
      <ng-container *ngIf="obterIdadesOrdenadas(dadosAtendimento) as idadesLista">
        <div class="mt-4 space-y-2" *ngIf="idadesLista.length; else semIdades">
          <div class="flex items-center gap-3" *ngFor="let item of idadesLista">
            <div class="w-16 text-sm font-semibold text-slate-700">{{ item.idade }} anos</div>
            <div class="flex-1 h-3 rounded-full bg-slate-100 overflow-hidden">
              <div
                class="h-full rounded-full bg-emerald-500"
                [style.width.%]="obterLarguraBarra(item.quantidade, obterMaiorQuantidade(dadosAtendimento))"
              ></div>
            </div>
            <div class="w-20 text-right text-sm font-semibold text-slate-800">{{ item.quantidade }}</div>
            <div class="w-14 text-right text-xs text-slate-500">{{ obterPercentual(item.quantidade, obterTotalIdades(dadosAtendimento)) }}%</div>
          </div>
        </div>
      </ng-container>
      <ng-template #semIdades>
        <p class="text-sm text-slate-500 mt-3">Sem dados de idade para exibir.</p>
      </ng-template>
    </div>

    <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-6" *ngIf="familias as grupoDetalhes">
      <div class="grid gap-4 lg:grid-cols-2">
        <div>
          <h3 class="text-base font-semibold text-slate-900">Faixa de renda</h3>
          <div class="chip-list mt-3">
            <span class="chip" *ngFor="let item of grupoDetalhes.faixaRenda | keyvalue">
              {{ item.key }}: {{ item.value }}
            </span>
          </div>
        </div>
        <div>
          <h3 class="text-base font-semibold text-slate-900">Inseguranca alimentar</h3>
          <div class="chip-list mt-3">
            <span class="chip" *ngFor="let item of grupoDetalhes.insegurancaAlimentar | keyvalue">
              {{ item.key }}: {{ item.value }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-template #loadingState>
    <div class="bg-white rounded-xl border border-slate-100 shadow-sm p-6 flex items-center gap-3 text-slate-700">
      <span class="material-icons animate-spin">refresh</span>
      <p>Carregando indicadores...</p>
    </div>
  </ng-template>
</div>

