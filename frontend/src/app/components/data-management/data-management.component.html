<app-tela-padrao [fullWidth]="true">
  <section class="cadastro">
    <div class="cadastro-layout">
      <aside class="cadastro-menu">
        <div class="tab-shell">
          <p class="tab-shell__title tab-shell__title--destaque">
            <fa-icon [icon]="faServer" class="tab-shell__icon"></fa-icon>
            Gerenciamento de Dados
          </p>
          <ol class="step-tabs" role="tablist">
            <li class="step-tabs__item active">
              <button type="button" class="step-tabs__button" role="tab" aria-selected="true">
                <span class="step-tabs__index">1</span>
                <span class="step-tabs__label">Painel</span>
              </button>
            </li>
          </ol>
        </div>
      </aside>

      <div class="cadastro-conteudo">
        <section class="data-shell">
          <div class="card">
            <div class="tab-card__header">
              <div class="tab-card__title-stack">
                <p class="tab-card__highlight">Gerenciamento de Dados</p>
              </div>
            </div>
            <div class="tab-card__divider"></div>

            <div class="card__header-row">
              <div>
                <p class="card__eyebrow">Resumo</p>
                <h2>Backup completo do sistema</h2>
                <p class="muted">Execute o backup completo e acompanhe o último registro.</p>
              </div>
              <div class="flex gap-2">
                <button type="button" class="btn-primary" (click)="startBackup()" [disabled]="backupEmAndamento()">
                  Backup completo
                </button>
              </div>
            </div>

            <div class="quick-grid">
              <div class="card kpi">
                <div>
                  <p class="kpi__label">Último backup bem-sucedido</p>
                  <p class="kpi__value">
                    {{ lastSuccessfulBackup()?.iniciadoEmFormatado || 'Sem registros' }}
                  </p>
                  <p class="kpi__hint">{{ lastSuccessfulBackup()?.rotulo }}</p>
                </div>
                <span class="pill pill--positive" *ngIf="lastSuccessfulBackup()">OK</span>
              </div>
              <div class="card kpi">
                <div>
                  <p class="kpi__label">Destino configurado</p>
                  <p class="kpi__value">{{ configuracao?.caminhoDestino || 'Sem destino' }}</p>
                  <p class="kpi__hint">{{ configuracao?.provedor || 'Não definido' }}</p>
                </div>
              </div>
            </div>

            <div class="inline-feedback" *ngIf="backupEmAndamento()">
              <div>
                <p class="font-semibold text-slate-800">Backup em andamento</p>
                <p class="muted">Processando backup completo... você será notificado ao concluir.</p>
                <div class="progress">
                  <div class="progress__bar progress__bar--indeterminate"></div>
                </div>
                <p class="muted">Tempo decorrido: {{ obterDuracaoDesde(backupEmAndamento()?.iniciadoEm) }}</p>
              </div>
            </div>

            <div class="inline-feedback inline-feedback--info" *ngIf="restauracaoEmAndamento">
              <div>
                <p class="font-semibold text-slate-800">Restauração em andamento</p>
                <p class="muted">Aplicando dados do backup selecionado.</p>
                <div class="progress">
                  <div class="progress__bar progress__bar--indeterminate"></div>
                </div>
                <p class="muted">Tempo decorrido: {{ obterDuracaoDesde(restauracaoInicio) }}</p>
              </div>
            </div>

            <div
              class="inline-feedback"
              *ngIf="restauracaoFeedback"
              [ngClass]="{
                'inline-feedback--success': restauracaoFeedback.tipo === 'success',
                'inline-feedback--error': restauracaoFeedback.tipo === 'error',
                'inline-feedback--info': restauracaoFeedback.tipo === 'info'
              }"
            >
              <div>
                <p class="font-semibold text-slate-800">
                  {{ restauracaoFeedback.tipo === 'error' ? 'Restauração com falha' : 'Restauração' }}
                </p>
                <p class="muted">{{ restauracaoFeedback.mensagem }}</p>
              </div>
            </div>
          </div>

          <div class="card mt-4 space-y-3">
            <div class="tab-card__header">
              <div class="tab-card__title-stack">
                <p class="tab-card__highlight">Histórico</p>
              </div>
              <div class="pill pill--outline">Últimos registros</div>
            </div>
            <div class="tab-card__divider"></div>

            <div class="history-grid" role="table">
              <div class="history-grid__header" role="row">
                <div role="columnheader">Backup</div>
                <div role="columnheader">Tipo</div>
                <div role="columnheader">Início</div>
                <div role="columnheader">Destino</div>
                <div role="columnheader">Tamanho</div>
                <div role="columnheader">Retenção</div>
                <div role="columnheader">Status</div>
                <div role="columnheader">Ações</div>
              </div>
              <div class="history-grid__row" *ngFor="let backup of recentBackups" role="row">
                <div role="cell">
                  <p class="font-semibold text-slate-800">{{ backup.codigo }}</p>
                  <p class="muted">{{ backup.rotulo }}</p>
                </div>
                <div role="cell">
                  <span class="pill pill--outline">{{ backup.tipo }}</span>
                </div>
                <div role="cell">{{ backup.iniciadoEmFormatado }}</div>
                <div role="cell">{{ backup.armazenadoEm || '--' }}</div>
                <div role="cell">{{ backup.tamanho || '--' }}</div>
                <div role="cell">{{ backup.retencaoDias }} dias</div>
                <div role="cell">
                  <span class="status-chip" [ngClass]="{
                    'status-chip--running': backup.status === 'executando',
                    'status-chip--success': backup.status === 'sucesso',
                    'status-chip--error': backup.status === 'falha'
                  }">
                    {{ backup.status === 'executando' ? 'Em execução' : backup.status === 'sucesso' ? 'Sucesso' : 'Falha' }}
                  </span>
                </div>
                <div role="cell">
                  <button
                    type="button"
                    class="btn-outline"
                    (click)="abrirDialogoRestaurar(backup)"
                    [disabled]="backup.status !== 'sucesso' || backupEmAndamento()"
                  >
                    Restaurar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </section>

  <app-dialog
    [aberto]="dialogoRestaurarAberto"
    titulo="Confirmar restauração"
    mensagem="Deseja restaurar este backup? Os dados atuais serão substituídos."
    confirmarLabel="Restaurar"
    cancelarLabel="Cancelar"
    (confirmar)="confirmarDialogoRestaurar()"
    (cancelar)="cancelarDialogoRestaurar()"
  ></app-dialog>
</app-tela-padrao>
