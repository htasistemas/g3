<app-tela-padrao>
<header class="page-title page-title--row" slot="titulo">
  <div>
    <p class="page-title__eyebrow">CONFIGURACOES GERAIS</p>
    <p class="page-title__label">Gerenciamento de Dados</p>
  </div>
  <p class="page-title__note">Administracao e manutencao de dados do sistema.</p>
</header>

  <section class="data-shell">
  <div class="card">
    <div class="card__header-row">
      <div>
        <p class="card__eyebrow">Resumo</p>
        <h2>Backup completo do sistema</h2>
        <p class="muted">Execute o backup completo e acompanhe o ultimo registro.</p>
      </div>
      <div class="flex gap-2">
        <button type="button" class="btn-primary" (click)="startBackup()" [disabled]="runningBackup()">
          Backup completo
        </button>
      </div>
    </div>

    <div class="quick-grid">
      <div class="card kpi">
        <div>
          <p class="kpi__label">Ultimo backup bem-sucedido</p>
          <p class="kpi__value">
            {{ lastSuccessfulBackup()?.iniciadoEmFormatado || 'Sem registros' }}
          </p>
          <p class="kpi__hint">{{ lastSuccessfulBackup()?.rotulo }}</p>
        </div>
        <span class="pill pill--positive" *ngIf="lastSuccessfulBackup()">OK</span>
      </div>
      <div class="card kpi">
        <div>
          <p class="kpi__label">Destino configurado</p>
          <p class="kpi__value">{{ configuracao?.caminhoDestino || 'Sem destino' }}</p>
          <p class="kpi__hint">{{ configuracao?.provedor || 'Nao definido' }}</p>
        </div>
      </div>
    </div>

    <div class="inline-feedback" *ngIf="runningBackup()">
      <div>
        <p class="font-semibold text-slate-800">Backup em andamento</p>
        <p class="muted">Processando backup completo... voce sera notificado ao concluir.</p>
      </div>
    </div>

    <div
      class="inline-feedback"
      *ngIf="restauracaoFeedback"
      [ngClass]="{
        'inline-feedback--success': restauracaoFeedback.tipo === 'success',
        'inline-feedback--error': restauracaoFeedback.tipo === 'error',
        'inline-feedback--info': restauracaoFeedback.tipo === 'info'
      }"
    >
      <div>
        <p class="font-semibold text-slate-800">
          {{ restauracaoFeedback.tipo === 'error' ? 'Restauracao com falha' : 'Restauracao' }}
        </p>
        <p class="muted">{{ restauracaoFeedback.mensagem }}</p>
      </div>
    </div>
  </div>

  <div class="card mt-4 space-y-3">
    <div class="card__header-row">
      <div>
        <p class="card__eyebrow">Historico</p>
        <p class="muted">Acompanhe status, tamanho e destino de cada execucao.</p>
      </div>
      <div class="pill pill--outline">Ultimos registros</div>
    </div>

    <div class="history-grid" role="table">
      <div class="history-grid__header" role="row">
        <div role="columnheader">Backup</div>
        <div role="columnheader">Tipo</div>
        <div role="columnheader">Inicio</div>
        <div role="columnheader">Destino</div>
        <div role="columnheader">Tamanho</div>
        <div role="columnheader">Retencao</div>
        <div role="columnheader">Status</div>
        <div role="columnheader">Acoes</div>
      </div>
      <div class="history-grid__row" *ngFor="let backup of recentBackups" role="row">
        <div role="cell">
          <p class="font-semibold text-slate-800">{{ backup.codigo }}</p>
          <p class="muted">{{ backup.rotulo }}</p>
        </div>
        <div role="cell">
          <span class="pill pill--outline">{{ backup.tipo }}</span>
        </div>
        <div role="cell">{{ backup.iniciadoEmFormatado }}</div>
        <div role="cell">{{ backup.armazenadoEm || '--' }}</div>
        <div role="cell">{{ backup.tamanho || '--' }}</div>
        <div role="cell">{{ backup.retencaoDias }} dias</div>
        <div role="cell">
          <span class="status-chip" [ngClass]="{
            'status-chip--running': backup.status === 'executando',
            'status-chip--success': backup.status === 'sucesso',
            'status-chip--error': backup.status === 'falha'
          }">
            {{ backup.status === 'executando' ? 'Em execucao' : backup.status === 'sucesso' ? 'Sucesso' : 'Falha' }}
          </span>
        </div>
        <div role="cell">
          <button
            type="button"
            class="btn-outline"
            (click)="abrirDialogoRestaurar(backup)"
            [disabled]="backup.status !== 'sucesso' || runningBackup()"
          >
            Restaurar
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<app-dialog
  [aberto]="dialogoRestaurarAberto"
  titulo="Confirmar restauracao"
  mensagem="Deseja restaurar este backup? Os dados atuais serao substituidos."
  confirmarLabel="Restaurar"
  cancelarLabel="Cancelar"
  (confirmar)="confirmarDialogoRestaurar()"
  (cancelar)="cancelarDialogoRestaurar()"
></app-dialog>
</app-tela-padrao>
