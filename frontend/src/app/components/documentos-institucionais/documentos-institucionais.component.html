ï»¿<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  [fullWidth]="true"
  (buscar)="onBuscarToolbar()"
  (novo)="onNovoToolbar()"
  (salvar)="onSalvarToolbar()"
  (cancelar)="onCancelarToolbar()"
  (excluir)="onExcluirToolbar()"
  (imprimir)="onImprimirToolbar()"
  (fechar)="onFecharToolbar()"
>
  <section class="cadastro">
    <div class="cadastro-layout">
      <aside class="cadastro-menu">
        <div class="tab-shell">
          <p class="tab-shell__title tab-shell__title--destaque">
            <fa-icon [icon]="faFolderOpen" class="tab-shell__icon"></fa-icon>
            Gestão de Documentos
          </p>

          <ul class="step-tabs">
            <li
              *ngFor="let tab of tabs; index as idx"
              class="step-tabs__item"
              [class.active]="activeTab === tab.id"
              [class.completed]="idx < activeTabIndex"
            >
              <button
                class="step-tabs__button"
                type="button"
                (click)="changeTab(tab.id)"
              >
                <span class="step-tabs__index">{{ idx + 1 }}</span>
                <span class="step-tabs__label">{{ tab.label }}</span>
              </button>
            </li>
          </ul>
        </div>
      </aside>

      <div class="cadastro-conteudo">
        <!-- Lista de documentos -->
        <div class="tab-card tab-card--lista" *ngIf="activeTab === 'lista'">
          <div class="tab-card__header">
            <div class="tab-card__title-stack">
              <p class="tab-card__highlight">Lista de Documentos</p>
            </div>
            <div class="tab-card__header-actions">
              <button class="primary" type="button" (click)="irParaNovoDocumento()">+ Novo Documento</button>
            </div>
          </div>

          <div class="metrics-grid">
            <div class="metric-card metric-card--neutral">
              <p class="metric-label">Documentos cadastrados</p>
              <p class="metric-value">{{ contadorSituacao.total }}</p>
            </div>
            <div class="metric-card metric-card--success">
              <p class="metric-label">Ativos</p>
              <p class="metric-value text-success">{{ contadorSituacao.ativos }}</p>
            </div>
            <div class="metric-card metric-card--danger">
              <p class="metric-label">Vencidos</p>
              <p class="metric-value text-danger">{{ contadorSituacao.vencidos }}</p>
            </div>
            <div class="metric-card metric-card--warning">
              <p class="metric-label">A vencer</p>
              <p class="metric-value text-warning">{{ contadorSituacao.aVencer }}</p>
            </div>
            <div class="metric-card metric-card--info">
              <p class="metric-label">Em renovação</p>
              <p class="metric-value text-info">{{ contadorSituacao.inativos }}</p>
            </div>
          </div>

          <form [formGroup]="filterForm" class="filters">
            <div class="field-grid cols-6">
              <label class="field">Tipo de documento
                <input formControlName="tipoDocumento" placeholder="CND Federal, Alvará..." />
              </label>
              <label class="field">Órgão emissor
                <input formControlName="orgaoEmissor" placeholder="Receita Federal, Prefeitura..." />
              </label>
              <label class="field">Situação
                <select formControlName="situacao">
                  <option value="">Todas</option>
                  <option value="valido">Válido</option>
                  <option value="vence_em_breve">Vence em breve</option>
                  <option value="vencido">Vencido</option>
                  <option value="em_renovacao">Em renovação</option>
                  <option value="sem_vencimento">Sem vencimento</option>
                </select>
              </label>
              <label class="field">Período de vencimento
                <select formControlName="periodoVencimento">
                  <option value="">Todos</option>
                  <option value="30">Próximos 30 dias</option>
                  <option value="60">Próximos 60 dias</option>
                  <option value="90">Próximos 90 dias</option>
                  <option value="sem_vencimento">Sem vencimento</option>
                </select>
              </label>
              <div class="field field--action">
                <button class="primary" type="button" (click)="aplicarFiltros()">Buscar</button>
              </div>
            </div>
          </form>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th>Órgão emissor</th>
                  <th>Emissão</th>
                  <th>Validade</th>
                  <th>Situação</th>
                  <th>Responsável</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let doc of documentosFiltrados" (click)="selecionarDocumento(doc)">
                  <td>
                    <div class="strong">{{ doc.tipoDocumento }}</div>
                    <div class="muted">{{ doc.categoria }}</div>
                  </td>
                  <td>{{ doc.orgaoEmissor }}</td>
                  <td>{{ doc.emissao }}</td>
                  <td>{{ doc.validade || 'Sem vencimento' }}</td>
                  <td>
                    <span
                      [class]="classeSituacao(doc.situacao)"
                      [class.status--blink]="doc.situacao === 'vencido' || doc.situacao === 'vence_em_breve'"
                    >
                      {{ labelSituacao(doc.situacao!) }}
                    </span>
                  </td>
                  <td>{{ doc.responsavelInterno || 'Não definido' }}</td>
                  <td class="text-right">
                    <div class="table-actions">
                      <button class="ghost" type="button" (click)="imprimirDocumento(doc)">Imprimir</button>
                      <button class="ghost" type="button" (click)="editarDocumento(doc)">Editar</button>
                      <button class="ghost" type="button" (click)="changeTab('anexos'); selecionarDocumento(doc)">Anexos</button>
                      <button class="ghost" type="button" (click)="changeTab('anexos'); selecionarDocumento(doc)">Histórico</button>
                      <button class="danger" type="button" (click)="excluirDocumento(doc)">Excluir</button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Cadastro / Edição -->
        <div class="tab-card" *ngIf="activeTab === 'cadastro'" [formGroup]="documentoForm">
          <div class="tab-card__header">
            <div class="tab-card__title-stack">
              <p class="tab-card__highlight">Cadastro / Edição</p>
            </div>
            <div class="tab-card__header-actions">
              <label class="checkbox-field">
                <input type="checkbox" formControlName="semVencimento" /> <span>Sem vencimento</span>
              </label>
              <label class="checkbox-field">
                <input type="checkbox" formControlName="vencimentoIndeterminado" /> <span>Vencimento indeterminado</span>
              </label>
            </div>
          </div>

          <div *ngIf="feedback" class="feedback">{{ feedback }}</div>

          <div class="field-grid cols-3">
            <label class="field">
              <div class="field__label">
                <span>Tipo de documento*</span>
                <button type="button" class="text-button" (click)="abrirModalNovoTipoDocumento()">+ Incluir tipo</button>
              </div>
              <select formControlName="tipoDocumento">
                <option value=""></option>
                <option *ngFor="let tipo of tiposPadrao" [value]="tipo">{{ tipo }}</option>
              </select>
            </label>
            <label class="field">Órgão emissor*
              <input formControlName="orgaoEmissor" />
            </label>
            <label class="field">
              <div class="field__label">
                <span>Categoria</span>
                <button type="button" class="text-button" (click)="abrirModalNovaCategoria()">+ Nova categoria</button>
              </div>
              <select formControlName="categoria">
                <option *ngFor="let categoria of categorias" [value]="categoria">{{ categoria }}</option>
              </select>
            </label>
            <label class="field full">Descrição / Observações
              <textarea rows="2" formControlName="descricao" placeholder="Resumo do documento, âmbito e Observações"></textarea>
            </label>
          </div>

          <div class="divider"></div>

          <div class="field-grid cols-4">
            <label class="field">Data de Emissão*
              <input type="date" formControlName="emissao" />
            </label>
            <label class="field" *ngIf="!documentoForm.get('semVencimento')?.value">
              Data de validade / vencimento
              <input type="date" formControlName="validade" />
            </label>
            <label class="field">Responsável interno
              <input formControlName="responsavelInterno" placeholder="Usuário ou setor" readonly />
            </label>
            <label class="field">Modo de renovação
              <select formControlName="modoRenovacao">
                <option *ngFor="let modo of modosRenovacao" [value]="modo">{{ modo }}</option>
              </select>
            </label>
          </div>

          <div class="divider"></div>

          <div class="field-grid cols-3">
            <label class="field full">Observação sobre renovação
              <textarea rows="2" formControlName="observacaoRenovacao" placeholder="Ex.: renovar no site com certificado digital"></textarea>
            </label>
            <label class="checkbox-field"><input type="checkbox" formControlName="emRenovacao" /> <span>Marcar como em renovação</span></label>
            <label class="checkbox-field"><input type="checkbox" formControlName="gerarAlerta" /> <span>Gerar alerta de vencimento</span></label>
            <label class="field">Dias de antecedência
              <div class="chips">
                <label *ngFor="let dia of [15, 30, 45, 60]" class="chip">
                  <input
                    type="checkbox"
                    [checked]="documentoForm.get('diasAntecedencia')?.value?.includes(dia)"
                    (change)="alternarDiasAntecedencia(dia)"
                  />
                  <span>{{ dia }} dias</span>
                </label>
              </div>
            </label>
            <label class="field">Forma de alerta
              <input formControlName="formaAlerta" placeholder="Aviso na aba de alertas" />
            </label>
          </div>

          <div class="tab-actions">
            <button type="button" class="ghost" (click)="changeTab('lista')">Cancelar</button>
            <button type="button" class="danger" *ngIf="editingId" (click)="excluirDocumento(documentoSelecionado!)">Excluir</button>
            <button type="button" class="primary" (click)="salvarDocumento()">{{ editingId ? 'Salvar alterações' : 'Salvar' }}</button>
          </div>
        </div>

        <!-- Alertas e vencimentos -->
        <div class="tab-card" *ngIf="activeTab === 'alertas'">
          <div class="tab-card__header">
            <div class="tab-card__title-stack">
              <p class="tab-card__highlight">Alertas e Vencimentos</p>
            </div>
          </div>

          <div class="alert-grid">
            <div class="alert-card">
              <p class="alert-card__label">Documentos Válidos</p>
              <p class="alert-card__value">{{ contadorSituacao.ativos }}</p>
            </div>
            <div class="alert-card warning">
              <p class="alert-card__label">Vencendo em 30 dias</p>
              <p class="alert-card__value">{{ contarVencendo(30, 0) }}</p>
            </div>
            <div class="alert-card info">
              <p class="alert-card__label">Vencendo em 60 dias</p>
              <p class="alert-card__value">{{ contarVencendo(60, 31) }}</p>
            </div>
            <div class="alert-card danger">
              <p class="alert-card__label">Vencidos</p>
              <p class="alert-card__value">{{ contadorSituacao.vencidos }}</p>
            </div>
            <div class="alert-card neutral">
              <p class="alert-card__label">Em renovação</p>
              <p class="alert-card__value">{{ contadorSituacao.inativos }}</p>
            </div>
          </div>

          <div class="filters compact">
            <label class="field">Período
              <select [(ngModel)]="alertaFiltro" name="alertaFiltro">
                <option value="hoje">Vencendo hoje</option>
                <option value="7">Próximos 7 dias</option>
                <option value="30">Próximos 30 dias</option>
                <option value="60">Próximos 60 dias</option>
                <option value="vencidos">Já vencidos</option>
              </select>
            </label>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th>Órgão emissor</th>
                  <th>Vencimento</th>
                  <th>Situação</th>
                  <th>Responsável</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let doc of documentosCriticos" [class.alert-blink]="doc.situacao === 'vencido' || doc.situacao === 'vence_em_breve'">
                  <td>{{ doc.tipoDocumento }}</td>
                  <td>{{ doc.orgaoEmissor }}</td>
                  <td>{{ doc.validade || 'Sem vencimento' }}</td>
                  <td>
                    <span
                      [class]="classeSituacao(doc.situacao)"
                      [class.status--blink]="doc.situacao === 'vencido' || doc.situacao === 'vence_em_breve'"
                    >
                      {{ labelSituacao(doc.situacao!) }}
                    </span>
                  </td>
                  <td>{{ doc.responsavelInterno || 'Não definido' }}</td>
                  <td class="text-right">
                    <button class="ghost" type="button" (click)="editarDocumento(doc)">Ver/Editar</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Anexos e Histórico -->
        <div class="tab-card" *ngIf="activeTab === 'anexos'">
          <div class="tab-card__header">
            <div class="tab-card__title-stack">
              <p class="tab-card__highlight">Anexos e Histórico</p>
            </div>
          </div>

          <div class="selection-bar">
            <p>Documento selecionado:</p>
            <select [ngModel]="selectedDocumentId" (ngModelChange)="onSelecionarDocumento($event)">
              <option [ngValue]="null">Selecione um documento</option>
              <option *ngFor="let doc of documentos" [ngValue]="doc.id">
                {{ doc.tipoDocumento }} - {{ doc.orgaoEmissor }}
              </option>
            </select>
          </div>

          <div *ngIf="feedback" class="feedback">{{ feedback }}</div>

          <div class="grid-cols-2">
            <div class="card">
              <div class="card__header">
                <div>
                  <p class="page-title__eyebrow">Anexos</p>
                  <p class="page-title__label">Upload e organização</p>
                </div>
                <button class="ghost button-anexo-destaque" type="button" (click)="adicionarAnexo()">Salvar anexo</button>
              </div>

              <form [formGroup]="anexoForm" class="field-grid cols-2">
                <label class="field">Nome do arquivo
                  <input formControlName="nomeArquivo" placeholder="Ex.: CND_2025.pdf" />
                </label>
                <label class="field">Tipo
                  <select formControlName="tipo">
                    <option value="PDF">PDF</option>
                    <option value="JPG">JPG</option>
                    <option value="PNG">PNG</option>
                  </select>
                </label>
                <label class="field full">Arquivo digitalizado*
                  <input type="file" accept=".pdf,image/*" (change)="onFileSelected($event)" />
                  <span class="muted">Formatos aceitos: PDF, JPG ou PNG. Tamanho máximo sugerido: 10MB.</span>
                </label>
              </form>

              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Arquivo</th>
                      <th>Tipo</th>
                      <th>Tamanho</th>
                      <th>Data</th>
                      <th>Usuário</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let anexo of anexosSelecionados">
                      <td>{{ anexo.nomeArquivo }}</td>
                      <td>{{ anexo.tipo }}</td>
                      <td>{{ anexo.tamanho || '?' }}</td>
                      <td>{{ anexo.dataUpload }}</td>
                      <td>{{ anexo.usuario }}</td>
                      <td class="text-right">
                        <button
                          class="ghost"
                          type="button"
                          [disabled]="!anexo.arquivoUrl"
                          (click)="visualizarAnexo(anexo)"
                        >
                          Visualizar documento
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="card">
              <div class="card__header">
                <div>
                  <p class="page-title__eyebrow">Histórico</p>
                  <p class="page-title__label">Eventos e alterações</p>
                </div>
                <button class="ghost" type="button" (click)="registrarHistorico('Registro manual inserido.', 'Edição')">Registrar anotação</button>
              </div>

              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>Usuário</th>
                      <th>Tipo</th>
                      <th>Observação</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let registro of historicoSelecionado">
                      <td>{{ registro.dataHora }}</td>
                      <td>{{ registro.usuario }}</td>
                      <td>{{ registro.tipoAlteracao }}</td>
                      <td>{{ registro.observacao }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Relatórios / Dashboard -->
        <div class="tab-card" *ngIf="activeTab === 'relatorios'">
          <div class="tab-card__header">
            <div class="tab-card__title-stack">
              <p class="tab-card__highlight">Relatórios e Dashboard</p>
            </div>
          </div>

          <div class="grid-cols-3">
            <div class="card">
              <p class="card__title">Situação</p>
              <div class="bar" [style.--value]="contadorSituacao.vencidos"></div>
              <ul class="legend">
                <li><span class="dot danger"></span>Vencidos: {{ contadorSituacao.vencidos }}</li>
                <li><span class="dot warning"></span>Vencendo: {{ contadorSituacao.aVencer }}</li>
                <li><span class="dot success"></span>Válidos: {{ contadorSituacao.ativos }}</li>
              </ul>
            </div>
            <div class="card">
              <p class="card__title">Categorias</p>
              <ul class="legend">
                <li *ngFor="let categoria of categorias">
                  <span class="dot"></span>{{ categoria }}: {{ contarPorCategoria(categoria) }}
                </li>
              </ul>
            </div>
            <div class="card">
              <p class="card__title">Exportação</p>
              <div class="actions">
                <button class="primary" type="button" (click)="exportarRelatorioPDF()">Exportar PDF</button>
                <button class="ghost" type="button" (click)="exportarRelatorioExcel()">Exportar Excel</button>
                <button class="ghost" type="button" (click)="alertaFiltro = 'vencidos'; changeTab('alertas')">Vencidos</button>
                <button class="ghost" type="button" (click)="alertaFiltro = '30'; changeTab('alertas')">A vencer em 30 dias</button>
              </div>
            </div>
          </div>

          <div class="list-card">
            <div class="list-card__header">
              <div>
                <p class="page-title__eyebrow">Documentos ativos</p>
                <p class="page-title__label">Relação resumida para Impressão</p>
              </div>
              <button class="ghost" type="button" (click)="imprimirRelatorioTexto()">Imprimir lista</button>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Categoria</th>
                    <th>Vencimento</th>
                    <th>Situação</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let doc of documentos">
                    <td>{{ doc.tipoDocumento }}</td>
                    <td>{{ doc.categoria }}</td>
                    <td>{{ doc.validade || 'Sem vencimento' }}</td>
                    <td>
                      <span
                        [class]="classeSituacao(doc.situacao)"
                        [class.status--blink]="doc.situacao === 'vencido' || doc.situacao === 'vence_em_breve'"
                      >
                        {{ labelSituacao(doc.situacao!) }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</app-tela-padrao>

<div class="modal" *ngIf="modalNovoTipoAberto">
  <div class="modal__backdrop" (click)="fecharModalNovoTipoDocumento()"></div>
  <div class="modal__content" role="dialog" aria-modal="true">
    <div class="modal__header">
      <div>
        <p class="modal__eyebrow">Tipo de documento</p>
        <h3>Novo tipo de documento</h3>
      </div>
      <button type="button" class="ghost" (click)="fecharModalNovoTipoDocumento()" aria-label="Fechar">&times;</button>
    </div>
    <label class="field">Nome do tipo*
      <input
        [(ngModel)]="novoTipoDocumento"
        placeholder="Ex.: certidão Negativa Estadual"
        [attr.autofocus]="focoNovoTipoDocumento ? true : null"
        (keyup.enter)="confirmarNovoTipoDocumento()"
      />
    </label>
    <p class="modal__error" *ngIf="modalEntradaErro">{{ modalEntradaErro }}</p>
    <div class="modal__actions">
      <button type="button" class="primary" (click)="confirmarNovoTipoDocumento()">Salvar</button>
      <button type="button" class="ghost" (click)="fecharModalNovoTipoDocumento()">Cancelar</button>
    </div>
  </div>
</div>

<div class="modal" *ngIf="modalNovaCategoriaAberta">
  <div class="modal__backdrop" (click)="fecharModalNovaCategoria()"></div>
  <div class="modal__content" role="dialog" aria-modal="true">
    <div class="modal__header">
      <div>
        <p class="modal__eyebrow">Categoria</p>
        <h3>Nova categoria</h3>
      </div>
      <button type="button" class="ghost" (click)="fecharModalNovaCategoria()" aria-label="Fechar">&times;</button>
    </div>
    <label class="field">Nome da categoria*
      <input
        [(ngModel)]="novaCategoria"
        placeholder="Ex.: Licenças e alvarás"
        [attr.autofocus]="focoNovaCategoria ? true : null"
        (keyup.enter)="confirmarNovaCategoria()"
      />
    </label>
    <p class="modal__error" *ngIf="modalEntradaErro">{{ modalEntradaErro }}</p>
    <div class="modal__actions">
      <button type="button" class="primary" (click)="confirmarNovaCategoria()">Salvar</button>
      <button type="button" class="ghost" (click)="fecharModalNovaCategoria()">Cancelar</button>
    </div>
  </div>
</div>


