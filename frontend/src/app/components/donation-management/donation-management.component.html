<app-tela-padrao>
<header class="page-title" slot="titulo">
    <p class="page-title__eyebrow">Atendimento</p>
    <p class="page-title__label">Doa&ccedil;&atilde;o realizada</p>
  </header>

  <div class="cadastro">

  <div class="tab-shell">
    <p class="tab-shell__title">Navegue pelas Informações</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of tabs; index as idx"
        class="step-tabs__item"
        [class.active]="activeTab() === tab.id"
        [class.completed]="idx < activeTabIndex()"
      >
        <button
          class="step-tabs__button"
          type="button"
          role="tab"
          [attr.aria-selected]="activeTab() === tab.id"
          (click)="changeTab(tab.id)"
        >
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ tab.label }}</span>
        </button>
      </li>
    </ol>
  </div>
  <ng-template #navigationControls>
    <div class="tab-actions">
      <button type="button" class="ghost" *ngIf="hasPreviousTab()" (click)="goToPreviousTab()">Voltar</button>
      <button type="button" class="primary" *ngIf="hasNextTab()" (click)="goToNextTab()">
        Próximo: {{ nextTabLabel() }}
      </button>
    </div>
  </ng-template>

  <div class="tab-card" *ngIf="activeTab() === 'identificacao'" [formGroup]="identificationForm">
    <app-popup-messages [mensagens]="popupErros" (fechar)="fecharPopupErros()"></app-popup-messages>
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">
          <fa-icon [icon]="faUserPlus"></fa-icon>
          Identificacao do atendimento
        </p>
      </div>
      <span class="pill">Fluxo ativo</span>
    </div>

    <div class="tab-card__hero">
      <div class="beneficiary-panel">
        <label class="field">Beneficiário ou família*
          <div class="search-box">
            <fa-icon [icon]="faMagnifyingGlass"></fa-icon>
            <input
              placeholder="Buscar Beneficiário ou família"
              [ngModel]="beneficiarySearch()"
              [ngModelOptions]="{ standalone: true }"
              (ngModelChange)="onBeneficiaryInput($event)"
            />
          </div>
        </label>
        <div class="suggestions suggestions--status" *ngIf="searchingBeneficiaries()">
          <p class="muted">Buscando Beneficiários e famílias...</p>
        </div>
        <div class="suggestions" *ngIf="!searchingBeneficiaries() && filteredBeneficiaries().length">
          <button
            type="button"
            class="suggestion"
            *ngFor="let beneficiary of filteredBeneficiaries()"
            (click)="populateBeneficiary(beneficiary)"
          >
            <div>
              <p class="suggestion__name">{{ beneficiary.name }}</p>
              <p class="muted">{{ beneficiary.document }}</p>
            </div>
            <span class="tag">{{ beneficiary.type === 'familia' ? 'Família' : 'Beneficiário' }}</span>
          </button>
        </div>
        <p
          class="muted"
          *ngIf="!searchingBeneficiaries() && beneficiarySearch().trim() && !filteredBeneficiaries().length"
        >
          Nenhum Beneficiário ou família encontrado.
        </p>
        <p class="field-error" *ngIf="beneficiarySearchError()">{{ beneficiarySearchError() }}</p>

        <div class="field-grid cols-2 compact">
          <label class="field">Responsavel pelo atendimento*
            <input formControlName="responsible" readonly />
          </label>
          <label class="field">Observações gerais
            <input formControlName="notes" placeholder="Descreva a carencia" />
          </label>
        </div>

        <div class="info-card" *ngIf="selectedBeneficiary() as beneficiary">
          <div class="info-card__profile">
            <div class="info-card__avatar" [class.info-card__avatar--empty]="!beneficiary.photoUrl">
              <img *ngIf="beneficiary.photoUrl" [src]="beneficiary.photoUrl" alt="Foto do beneficiário" />
              <span *ngIf="!beneficiary.photoUrl">{{ getInitials(beneficiary.name) }}</span>
            </div>
            <div>
              <p class="eyebrow">Beneficiário selecionado</p>
              <p class="strong"><span class="info-label">Nome:</span> <span class="info-value">{{ beneficiary.name }}</span></p>
            </div>
          </div>
          <p class="muted">
            <span class="info-label">Idade:</span>
            {{
              beneficiary.age !== null && beneficiary.age !== undefined
                ? (beneficiary.age + ' anos')
                : 'Não informado'
            }}
          </p>
          <p class="muted">
            <span class="info-label">CPF:</span>
            <span class="info-value">{{ beneficiary.cpf ? formatCpf(beneficiary.cpf) : 'Não informado' }}</span>
          </p>
          <p class="muted">
            <span class="info-label">Telefone:</span>
            <span class="info-value">{{ beneficiary.phone ? formatPhoneValue(beneficiary.phone) : 'Não informado' }}</span>
          </p>
          <p class="muted">
            <span class="info-label">Endereço:</span>
            <span class="info-value">{{ beneficiary.address || 'Não informado' }}</span>
          </p>
        </div>
      </div>

      <div class="status-panel" [formGroup]="deliveredItemForm">
        <p class="status-panel__title">
          <fa-icon [icon]="faBoxOpen"></fa-icon>
          Itens para entregar agora
        </p>

        <div class="stock-picker">
          <label class="field">Item do almoxarifado*
            <div class="picker-input">
              <input placeholder="Selecione um item" [value]="selectedDeliveryItem?.description || ''" readonly />
              <button type="button" class="ghost" (click)="openStockModal('deliver')">
                Escolher item
              </button>
            </div>
          </label>
          <div class="field-grid cols-2 compact">
            <label class="field">Quantidade*
              <input type="number" min="1" formControlName="quantity" />
            </label>
            <label class="field">Unidade
              <input [value]="selectedDeliveryItem?.unit || '-'" readonly />
            </label>
          </div>
          <label class="field">Observações do item
            <input formControlName="notes" placeholder="Ex.: caixa fechada" />
          </label>
          <div class="actions-row">
            <button type="button" class="ghost" (click)="deliveredItemForm.reset({ itemCode: '', quantity: 1, notes: '' })">
              Limpar item
            </button>
            <button type="button" class="primary" (click)="addDeliveredItem()">
              <fa-icon [icon]="faPlus"></fa-icon>
              Incluir item
            </button>
          </div>
          <p class="field-error" *ngIf="itemError()">{{ itemError() }}</p>
        </div>

        <div class="table-wrapper" *ngIf="deliveredItems().length; else emptyDelivery">
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th>Quantidade</th>
                <th>Observações</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of deliveredItems(); index as i">
                <td>
                  <p class="strong">{{ item.description }}</p>
                  <p class="muted">{{ item.stockCode }}</p>
                </td>
                <td>{{ item.quantity }} {{ item.unit }}</td>
                <td>{{ item.notes || '-' }}</td>
                <td class="text-right">
                  <button type="button" class="link" (click)="removeDeliveredItem(i)">Remover</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <ng-template #emptyDelivery>
          <div class="empty">
            <fa-icon [icon]="faTriangleExclamation"></fa-icon>
            <p>Inclua itens da lista do almoxarifado.</p>
          </div>
        </ng-template>

        <div class="tab-actions">
          <button type="button" class="ghost" (click)="changeTab('historico')">Ver historico</button>
          <button type="button" class="primary" (click)="registerDonation()">
            <fa-icon [icon]="faCheck"></fa-icon>
            Registrar doação entregue
          </button>
        </div>
      </div>
    </div>
    <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
  </div>

  <div class="tab-card" *ngIf="activeTab() === 'historico'">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">
          <fa-icon [icon]="faClipboardList"></fa-icon>
          historico de doações
        </p>
        <h3>Filtre e visualize tudo que ja foi doado</h3>
        <p class="muted">Sempre atualizado de acordo com o Beneficiário selecionado na primeira aba.</p>
      </div>
    </div>

    <form class="filter-bar" [formGroup]="historyFilters">
      <label class="field">Data inicial
        <input type="date" formControlName="startDate" />
      </label>
      <label class="field">Data final
        <input type="date" formControlName="endDate" />
      </label>
      <label class="field">Tipo de doação
        <input formControlName="donationType" placeholder="Ex.: cesta, roupa" />
      </label>
      <button type="button" class="ghost" (click)="historyFilters.reset({ startDate: '', endDate: '', donationType: '' })">
        Limpar filtros
      </button>
      <button type="button" class="primary" (click)="applyHistoryFilters()">
        Buscar
      </button>
    </form>
    <p class="field-error" *ngIf="historicoErro()">{{ historicoErro() }}</p>

    <div class="table-wrapper" *ngIf="selectedBeneficiary() && filteredHistory().length; else emptyHistory">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Beneficiário</th>
            <th>Itens</th>
            <th>Situação</th>
            <th>Responsavel</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let record of filteredHistory()">
            <td>{{ record.deliveryDate | date: 'shortDate' : undefined : 'pt-BR' }}</td>
            <td>
              <p class="strong">{{ record.beneficiaryName }}</p>
              <p class="muted">
                {{ record.beneficiaryType === 'familia' ? 'Família' : 'Beneficiário' }}
              </p>
            </td>
            <td>
              <ul>
                <li *ngFor="let item of record.items">{{ item.description }} ({{ item.quantity }} {{ item.unit }})</li>
              </ul>
            </td>
            <td><span class="status-chip">{{ record.status }}</span></td>
            <td>{{ record.responsible }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <ng-template #emptyHistory>
      <div class="empty">
        <fa-icon [icon]="faNotesMedical"></fa-icon>
        <p *ngIf="!selectedBeneficiary()">Selecione um beneficiário ou família para ver o historico.</p>
        <p *ngIf="selectedBeneficiary()">Sem registros para o filtro atual.</p>
      </div>
    </ng-template>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
  </div>

  <div class="tab-card" *ngIf="activeTab() === 'planejamento'">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">
          <fa-icon [icon]="faClock"></fa-icon>
          doações a realizar
        </p>
        <h3>Cadastre e acompanhe entregas futuras</h3>
      </div>
      <span class="pill">Integracao com almoxarifado</span>
    </div>

    <div class="field-grid cols-3 compact planned-grid" [formGroup]="plannedForm">
      <label class="field planned-item">Item do almoxarifado*
        <div class="picker-input">
          <input placeholder="Selecione um item" [value]="selectedPlannedItem?.description || ''" readonly />
          <button type="button" class="ghost" (click)="openStockModal('plan')">Escolher</button>
        </div>
      </label>
      <label class="field planned-qty">Quantidade*
        <input type="number" min="1" formControlName="quantity" />
      </label>
      <label class="field">Data prevista*
        <input type="date" formControlName="dueDate" />
      </label>
      <label class="field">Prioridade*
        <select formControlName="priority">
          <option value="baixa">Baixa</option>
          <option value="media">Média</option>
          <option value="alta">Alta</option>
        </select>
      </label>
      <label class="field">Status*
        <select formControlName="status">
          <option value="pendente">Pendente</option>
          <option value="em_separacao">Em separacao</option>
          <option value="pronto">Pronto para entrega</option>
          <option value="entregue">Entregue</option>
          <option value="cancelado">Cancelado</option>
        </select>
      </label>
      <label class="field planned-notes">Observações
        <input formControlName="notes" placeholder="Informações adicionais" />
      </label>
    </div>
    <p class="field-error" *ngIf="plannedError()">{{ plannedError() }}</p>
    <div class="tab-actions">
      <button type="button" class="ghost" (click)="clearPlanForm()">Cancelar edicao</button>
      <button type="button" class="primary" (click)="submitPlannedDonation()">
        <fa-icon [icon]="faCheck"></fa-icon>
        {{ editingPlanId ? 'Atualizar planejamento' : 'Salvar planejamento' }}
      </button>
    </div>

    <div class="table-wrapper" *ngIf="filteredPlans().length; else emptyPlans">
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th>Previsto</th>
            <th>Prioridade</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let plan of filteredPlans()">
            <td>
              <p class="strong">{{ plan.itemDescription }}</p>
              <p class="muted">{{ plan.itemCode }}</p>
              <p class="muted">Beneficiário: {{ plan.beneficiaryName }}</p>
              <p class="muted" *ngIf="plan.status === 'cancelado' && plan.cancelReason">
                Motivo do cancelamento: {{ plan.cancelReason }}
              </p>
            </td>
            <td>{{ plan.quantity }} {{ plan.unit }} a {{ plan.dueDate | date: 'shortDate' }}</td>
            <td><span class="status-chip status-chip--info">{{ plan.priority }}</span></td>
            <td><span [ngClass]="getPlanStatusClass(plan.status)">{{ formatPlanStatus(plan.status) }}</span></td>
            <td class="actions-cell">
              <button type="button" class="primary" (click)="editPlan(plan)">Editar</button>
              <button type="button" class="primary" (click)="realizarDoacaoPlanejada(plan)">Realizar doação</button>
              <button type="button" class="primary primary--danger" (click)="openCancelDialog(plan)">Cancelar</button>
              <p class="muted">Estoque disponivel: {{ getStockBalance(plan.itemCode) }} {{ plan.unit }}</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <ng-template #emptyPlans>
      <div class="empty">
        <fa-icon [icon]="faPeopleGroup"></fa-icon>
        <p>Sem doações planejadas para este Beneficiário.</p>
      </div>
    </ng-template>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
  </div>

  <div class="tab-card" *ngIf="activeTab() === 'dashboard'">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">
          <fa-icon [icon]="faChartPie"></fa-icon>
          Dashboard de doações
        </p>
        <h3>Visão rapida do atendimento</h3>
        <p class="muted">Resultados filtrados pelo Beneficiário selecionado em Identificacao.</p>
      </div>
      <span class="pill">Atualizado automaticamente</span>
    </div>

    <div class="insights-grid">
      <article class="insight-card">
        <p class="eyebrow">Registros entregues</p>
        <h4>{{ dashboardStats().deliveredCount }}</h4>
        <p class="muted">doações concluidas</p>
      </article>
      <article class="insight-card">
        <p class="eyebrow">Quantidade doada</p>
        <h4>{{ dashboardStats().deliveredQuantity }}</h4>
        <p class="muted">Soma das unidades entregues</p>
      </article>
      <article class="insight-card">
        <p class="eyebrow">Pendentes</p>
        <h4>{{ dashboardStats().pendingPlans }}</h4>
        <p class="muted">doações ainda Não entregues</p>
      </article>
      <article class="insight-card">
        <p class="eyebrow">Itens a entregar</p>
        <h4>{{ dashboardStats().pendingQuantity }}</h4>
        <p class="muted">Quantidade planejada restante</p>
      </article>
    </div>

    <div class="chart-card" *ngIf="dashboardStats().distribution | keyvalue as distribution">
      <p class="eyebrow">Distribuicao por tipo</p>
      <div class="bars" *ngIf="distribution.length; else noData">
        <div class="bar" *ngFor="let entry of distribution">
          <span class="bar__label">{{ entry.key }}</span>
          <div class="bar__track">
            <div class="bar__fill" [style.width.%]="Math.min(100, entry.value * 12)"></div>
          </div>
          <span class="bar__value">{{ entry.value }} unidade(s)</span>
        </div>
      </div>
      <ng-template #noData>
        <p class="muted">Ainda Não ha dados suficientes para gerar o grafico.</p>
      </ng-template>
    </div>
    <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
  </div>
</div>
<div class="modal-backdrop" *ngIf="cancelDialogOpen()">
  <div class="modal">
    <div class="modal__header">
      <div>
        <p class="eyebrow">Cancelamento</p>
        <h3>Cancelar doação planejada</h3>
      </div>
      <button type="button" class="ghost" (click)="closeCancelDialog()">Fechar</button>
    </div>
    <label class="field">
      Motivo do cancelamento*
      <input
        [ngModel]="cancelReason()"
        [ngModelOptions]="{ standalone: true }"
        (ngModelChange)="cancelReason.set($event)"
        placeholder="Descreva o motivo"
      />
    </label>
    <div class="tab-actions">
      <button type="button" class="ghost" (click)="closeCancelDialog()">Voltar</button>
      <button type="button" class="primary primary--danger" (click)="confirmCancelPlan()">Confirmar cancelamento</button>
    </div>
  </div>
</div>
<div class="modal-backdrop" *ngIf="stockModalOpen()">
  <div class="modal">
    <div class="modal__header">
      <div>
        <p class="eyebrow">Itens do almoxarifado</p>
        <h3>Selecione o item da doação</h3>
      </div>
      <button type="button" class="ghost" (click)="closeStockModal()">Fechar</button>
    </div>

    <div class="modal__filters">
      <div class="search-box">
        <fa-icon [icon]="faMagnifyingGlass"></fa-icon>
        <input placeholder="Busque por nome, codigo ou categoria" [ngModel]="stockSearch()" (ngModelChange)="stockSearch.set($event)" />
      </div>
      <div class="compact-grid">
        <label class="field">Categoria
          <select [ngModel]="stockCategory()" (ngModelChange)="stockCategory.set($event)">
            <option value="todos">Todas</option>
            <option value="Higiene">Higiene</option>
            <option value="EPI">EPI</option>
            <option value="Escritorio">Escritorio</option>
            <option value="Alimentos">Alimentos</option>
          </select>
        </label>
        <label class="field">Situação
          <select [ngModel]="stockStatus()" (ngModelChange)="stockStatus.set($event)">
            <option value="todos">Todas</option>
            <option value="Ativo">Ativo</option>
            <option value="Inativo">Inativo</option>
          </select>
        </label>
      </div>
    </div>

    <div class="modal__list" *ngIf="filteredStock().length; else emptyStock">
      <button type="button" class="stock-row" *ngFor="let item of filteredStock()" (click)="selectStockItem(item)">
        <div>
          <p class="strong">{{ item.description }}</p>
          <p class="muted">{{ item.code }} A {{ item.category }}</p>
        </div>
        <div class="stock-row__info">
          <span class="pill">{{ item.currentStock }} {{ item.unit }} em estoque</span>
          <span class="pill" [class.pill--danger]="item.status === 'Inativo'">{{ item.status }}</span>
        </div>
      </button>
    </div>
    <ng-template #emptyStock>
      <div class="empty">
        <fa-icon [icon]="faFilter"></fa-icon>
        <p>Nenhum item encontrado para os filtros informados.</p>
      </div>
    </ng-template>
  </div>
</div>
</app-tela-padrao>





















