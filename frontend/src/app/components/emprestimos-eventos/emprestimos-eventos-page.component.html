<app-tela-padrao
  [fullWidth]="true"
  [acoes]="acoesBarra"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  (buscar)="onBuscar()"
  (novo)="onNovo()"
  (salvar)="onSalvar()"
  (cancelar)="onCancelar()"
  (excluir)="onExcluir()"
  (imprimir)="onImprimir()"
  (fechar)="onFechar()"
>
  <app-popup-messages [mensagens]="mensagensErro" (fechar)="mensagensErro = []"></app-popup-messages>

  <section class="cadastro">
    <div class="cadastro-layout">
      <aside class="cadastro-menu">
        <div class="tab-shell">
          <p class="tab-shell__title tab-shell__title--destaque">
            <fa-icon [icon]="faCalendarCheck" class="tab-shell__icon"></fa-icon>
            Empréstimo para Eventos
          </p>

          <ul class="step-tabs">
            <li
              class="step-tabs__item"
              *ngFor="let tab of abas; let i = index"
              [class.active]="abaAtiva === tab.id"
            >
              <button type="button" class="step-tabs__button" (click)="alterarAba(tab.id)">
                <span class="step-tabs__index">{{ i + 1 }}</span>
                <span class="step-tabs__label">{{ tab.label }}</span>
              </button>
            </li>
          </ul>
        </div>
      </aside>

      <div class="cadastro-conteudo">
        <p class="local-feedback" *ngIf="feedbackLocal">
          {{ feedbackLocal }}
          <button type="button" (click)="feedbackLocal = null">X</button>
        </p>

        <section class="tab-card" *ngIf="abaAtiva === 'dashboard'">
          <div class="tab-card__header">
            <div class="tab-card__title-stack">
              <p class="tab-card__highlight">Dashboard</p>
            </div>
            <div class="tab-card__actions">
              <button type="button" class="nav-button" (click)="navegarParaAba('agenda')">
                Ver agenda
              </button>
            </div>
          </div>

          <div class="dashboard-grid">
            <div class="dashboard-card dashboard-card--accent">
              <div>
                <p class="dashboard-card__label">Dias com empréstimos</p>
                <p class="dashboard-card__value">{{ dashboardResumo.diasComEmprestimos }}</p>
                <p class="dashboard-card__hint">Dias distintos com movimentação registrada.</p>
              </div>
              <div class="dashboard-tags" *ngIf="dashboardDiasComEmprestimos.length; else semDias">
                <span class="dashboard-tag" *ngFor="let dia of dashboardDiasComEmprestimos">
                  {{ dia.data }} - {{ dia.quantidade }}
                </span>
              </div>
              <ng-template #semDias>
                <p class="muted">Nenhum dia com empréstimos até o momento.</p>
              </ng-template>
            </div>

            <div class="dashboard-card">
              <div>
                <p class="dashboard-card__label">Itens emprestados</p>
                <p class="dashboard-card__value">{{ dashboardResumo.itensEmprestados }}</p>
                <p class="dashboard-card__hint">Total de itens retirados.</p>
              </div>
              <div class="dashboard-list" *ngIf="dashboardItensEmprestados.length; else semItens">
                <div class="dashboard-list__item" *ngFor="let item of dashboardItensEmprestados">
                  <div>
                    <p class="font-semibold text-slate-800">{{ item.nome }}</p>
                    <p class="muted">{{ item.tipo === 'PATRIMONIO' ? 'Patrimônio' : 'Almoxarifado' }}</p>
                  </div>
                  <span class="dashboard-qty">{{ item.quantidade }}</span>
                </div>
              </div>
              <ng-template #semItens>
                <p class="muted">Nenhum item emprestado no momento.</p>
              </ng-template>
            </div>

            <div class="dashboard-card dashboard-card--highlight">
              <div>
                <p class="dashboard-card__label">Empréstimos em andamento</p>
                <p class="dashboard-card__value">{{ dashboardResumo.emprestimosAtivos }}</p>
                <p class="dashboard-card__hint">Retirados e não devolvidos.</p>
              </div>
              <div class="dashboard-actions">
                <button type="button" class="btn-outline" (click)="navegarParaAba('lista')">
                  Ver lista
                </button>
                <button type="button" class="btn-outline" (click)="navegarParaAba('cadastro')">
                  Novo empréstimo
                </button>
              </div>
            </div>

            <div class="dashboard-card">
              <div>
                <p class="dashboard-card__label">Resumo geral</p>
                <p class="dashboard-card__value">{{ dashboardResumo.totalEmprestimos }}</p>
                <p class="dashboard-card__hint">Empréstimos cadastrados no período atual.</p>
              </div>
              <div class="dashboard-metrics">
                <div>
                  <span class="dashboard-metrics__label">Agendados</span>
                  <span class="dashboard-metrics__value">{{ dashboardResumo.emprestimosAgendados }}</span>
                </div>
                <div>
                  <span class="dashboard-metrics__label">Devolvidos</span>
                  <span class="dashboard-metrics__value">{{ dashboardResumo.emprestimosDevolvidos }}</span>
                </div>
                <div>
                  <span class="dashboard-metrics__label">Itens agendados</span>
                  <span class="dashboard-metrics__value">{{ dashboardResumo.itensAgendados }}</span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="tab-card" *ngIf="abaAtiva === 'agenda'">
          <div class="tab-card__header">
            <div class="tab-card__title-stack">
              <p class="tab-card__highlight">Agenda</p>
            </div>
          </div>
          <app-emprestimos-eventos-agenda
            [mesReferencia]="mesAgenda"
            [dias]="diasAgenda"
            (mudarMes)="mudarMes($event)"
            (selecionarDia)="abrirDiaAgenda($event)"
          ></app-emprestimos-eventos-agenda>
        </section>

        <section class="tab-card" *ngIf="abaAtiva === 'lista'">
          <div class="tab-card__header">
            <div class="tab-card__title-stack">
              <p class="tab-card__highlight">Listagem de Empréstimos</p>
            </div>
          </div>
          <app-emprestimos-eventos-lista
            [emprestimos]="emprestimos"
            (selecionar)="selecionarEmprestimo($event)"
            (confirmarRetirada)="confirmarRetirada($event)"
            (confirmarDevolucao)="confirmarDevolucao($event)"
            (cancelar)="onExcluir($event)"
          ></app-emprestimos-eventos-lista>
        </section>

        <section class="tab-card" *ngIf="abaAtiva === 'cadastro'">
          <app-emprestimos-eventos-form
            [form]="formEmprestimo"
            [eventos]="eventosOpcoes"
            [responsaveis]="responsaveisOpcoes"
            [eventoTermo]="eventoTermo"
            [responsavelTermo]="responsavelTermo"
            (eventoTermoChange)="eventoTermo = $event"
            (eventoSelecionado)="formEmprestimo.patchValue({ eventoId: $event.id }); eventoTermo = $event.label"
            (criarEvento)="abrirFormularioEvento()"
            (responsavelTermoChange)="responsavelTermo = $event"
            (responsavelSelecionado)="formEmprestimo.patchValue({ responsavelId: $event.id }); responsavelTermo = $event.label"
          ></app-emprestimos-eventos-form>
        </section>

        <section class="tab-card" *ngIf="abaAtiva === 'itens'">
          <app-emprestimos-eventos-itens
            [form]="formularioItem"
            [itens]="itensEmprestimo"
            [patrimonios]="patrimonios"
            [almoxarifadoItens]="almoxarifadoItens"
            (adicionar)="adicionarItem()"
            (remover)="removerItem($event)"
          ></app-emprestimos-eventos-itens>
        </section>

        <section class="tab-card" *ngIf="abaAtiva === 'disponibilidade'">
          <app-emprestimos-eventos-disponibilidade
            [form]="formularioDisponibilidade"
            [patrimonios]="patrimonios"
            [almoxarifadoItens]="almoxarifadoItens"
            [resultado]="resultadoDisponibilidade"
            (consultar)="consultarDisponibilidade()"
          ></app-emprestimos-eventos-disponibilidade>
        </section>

        <section class="tab-card" *ngIf="abaAtiva === 'historico'">
          <app-emprestimos-eventos-historico
            [movimentacoes]="movimentacoesEmprestimo"
          ></app-emprestimos-eventos-historico>
        </section>

        <app-agenda-dia-modal
          [aberto]="modalAgendaAberto"
          [data]="modalAgendaData"
          [detalhes]="modalAgendaDetalhes"
          [qtdEmprestimosDia]="modalAgendaQtdEmprestimos"
          [eventosDia]="modalAgendaEventos"
          (fechar)="fecharModalAgenda()"
          (abrirEmprestimo)="abrirEmprestimoDoModal($event)"
        ></app-agenda-dia-modal>

        <div class="evento-modal-overlay" *ngIf="formularioEventoAberto">
          <div class="evento-modal">
            <div class="evento-modal__header">
              <div>
                <p class="muted">Empréstimo para eventos</p>
                <h3>Dados do evento *</h3>
              </div>
              <button type="button" class="evento-modal__close" (click)="cancelarFormularioEvento()">X</button>
            </div>

            <div class="form-card" [formGroup]="formularioEvento">
              <div class="form-row">
                <label class="field">Título *
                  <input type="text" formControlName="titulo" placeholder="Título do evento" />
                </label>
                <label class="field">Local
                  <input type="text" formControlName="local" placeholder="Local do evento" />
                </label>
              </div>
              <label class="field">Descrição
                <textarea rows="3" formControlName="descricao" placeholder="Descrição do evento"></textarea>
              </label>
              <div class="form-row">
                <button type="button" class="nav-button" (click)="salvarEvento()">Salvar evento</button>
                <button type="button" class="nav-button" (click)="iniciarNovoEvento()">Novo evento</button>
              </div>
            </div>

            <div class="form-card">
              <h4>Eventos cadastrados</h4>
              <div class="evento-lista" *ngIf="eventos.length; else nenhumEvento">
                <div class="evento-lista__item" *ngFor="let evento of eventos">
                  <div>
                    <strong>{{ evento.titulo }}</strong>
                    <p class="muted">Período: {{ evento.dataInicio | date: 'dd/MM/yyyy HH:mm' }} até {{ evento.dataFim | date: 'dd/MM/yyyy HH:mm' }}</p>
                  </div>
                  <div class="evento-lista__acoes">
                    <button type="button" class="ghost" (click)="editarEvento(evento)">Editar</button>
                    <button type="button" class="nav-button nav-button--danger" (click)="abrirDialogoExcluirEvento(evento)">Excluir</button>
                  </div>
                </div>
              </div>
              <ng-template #nenhumEvento>
                <p class="muted">Nenhum evento cadastrado até o momento.</p>
              </ng-template>
            </div>
          </div>
        </div>

        <app-dialog
          [aberto]="dialogExcluirEventoAberto"
          titulo="Excluir evento"
          [mensagem]="'Deseja excluir o evento ' + (eventoParaExcluir?.titulo || '') + '?'"
          confirmarLabel="Excluir"
          (confirmar)="confirmarExcluirEvento()"
          (cancelar)="cancelarExcluirEvento()"
        ></app-dialog>

        <div class="print-modal-overlay" *ngIf="dialogImpressaoAberto">
          <div class="print-modal">
            <div class="print-modal__header">
              <div>
                <p class="muted">Empréstimo para eventos</p>
                <h3>Escolha o tipo de impressão</h3>
              </div>
              <button type="button" class="print-modal__close" (click)="cancelarDialogoImpressao()">X</button>
            </div>
            <div class="print-modal__actions">
              <button type="button" class="nav-button" (click)="imprimirEmprestimosSelecionado()">
                Imprimir empréstimos
              </button>
              <button type="button" class="nav-button" (click)="imprimirTermoSelecionado()">
                Imprimir termo
              </button>
              <button type="button" class="ghost" (click)="cancelarDialogoImpressao()">Cancelar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</app-tela-padrao>
