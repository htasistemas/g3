<section class="cadastro">
  <header class="page-title">
    <p class="page-title__eyebrow">Cadastros</p>
    <p class="page-title__label">Cadastro de família</p>
  </header>

  <div class="tab-shell">
    <p class="tab-shell__title">Navegue pelas informações</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of tabs; index as idx"
        class="step-tabs__item"
        [class.active]="activeTab === tab.id"
        [class.completed]="idx < activeTabIndex"
      >
        <button
          class="step-tabs__button"
          type="button"
          role="tab"
          [attr.aria-selected]="activeTab === tab.id"
          (click)="changeTab(tab.id)"
        >
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ tab.label }}</span>
        </button>
      </li>
    </ol>
  </div>

  <form [formGroup]="form" (ngSubmit)="submit()" class="form-shell">
    <div *ngIf="feedback" class="feedback">{{ feedback }}</div>

    <ng-template #navigationControls>
      <div class="tab-actions">
        <button type="button" class="ghost" *ngIf="hasPreviousTab" (click)="goToPreviousTab()">Voltar</button>
        <button type="button" class="primary" *ngIf="hasNextTab" (click)="goToNextTab()">
          Próximo: {{ nextTabLabel }}
        </button>
        <button type="submit" class="primary" [disabled]="saving" *ngIf="!hasNextTab">
          {{ saving ? 'Salvando...' : 'Salvar cadastro' }}
        </button>
      </div>
    </ng-template>

    <div class="tab-card" *ngIf="activeTab === 'familia'" formGroupName="familia">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('familia') }}</p>
          <p class="muted">Identifique a família, referência principal e arranjo familiar.</p>
        </div>
        <span class="pill">Obrigatório</span>
      </div>
      <div class="field-grid cols-2">
        <label class="field">Nome da família*<input formControlName="nome_familia" placeholder="Ex.: Família Silva" /></label>
        <div class="field">
          <p class="field-title">Referência familiar (beneficiário)*</p>
          <input
            formControlName="referencia_familiar_nome"
            placeholder="Busque pelo nome do beneficiário"
            (input)="onReferenciaInput($event.target.value)"
          />
          <input type="hidden" formControlName="id_referencia_familiar" />
          <div class="search-results" *ngIf="referenciaResultados.length">
            <button type="button" *ngFor="let beneficiario of referenciaResultados" (click)="selecionarReferencia(beneficiario)">
              <span class="strong">{{ beneficiario.nome_completo || beneficiario.nome_social }}</span>
              <span class="muted">CPF: {{ beneficiario.cpf || 'Sem CPF' }} · ID: {{ beneficiario.id_beneficiario }}</span>
            </button>
          </div>
          <p class="field-error" *ngIf="form.get(['familia', 'id_referencia_familiar'])?.invalid && form.get(['familia', 'id_referencia_familiar'])?.touched">
            Selecione um beneficiário como referência familiar.
          </p>
        </div>
        <label class="field">Arranjo familiar<select formControlName="arranjo_familiar">
            <option value=""></option>
            <option value="NUCLEAR">Nuclear</option>
            <option value="MONOPARENTAL">Monoparental</option>
            <option value="EXTENSA">Extensa</option>
            <option value="RECONSTITUIDA">Reconstituída</option>
            <option value="OUTRO">Outro</option>
          </select></label>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'endereco'" formGroupName="endereco">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('endereco') }}</p>
          <p class="muted">Preencha o endereço completo para visitas, entregas e deslocamentos.</p>
        </div>
      </div>
      <div class="field-grid cols-3">
        <label class="field">CEP*<input formControlName="cep" placeholder="00000-000" (input)="onCepInput($event)" (blur)="onCepBlur()" />
          <p class="field-error" *ngIf="form.get(['endereco', 'cep'])?.invalid && form.get(['endereco', 'cep'])?.touched">
            Informe um CEP válido com 8 dígitos.
          </p>
          <p class="field-error" *ngIf="cepLookupError">{{ cepLookupError }}</p>
        </label>
        <label class="field">Logradouro<input formControlName="logradouro" placeholder="Rua, avenida..." /></label>
        <label class="field">Número<input formControlName="numero" placeholder="Nº" /></label>
        <label class="field">Complemento<input formControlName="complemento" placeholder="Apartamento, bloco" /></label>
        <label class="field">Bairro<input formControlName="bairro" /></label>
        <label class="field">Ponto de referência<input formControlName="ponto_referencia" /></label>
        <label class="field">Município<input formControlName="municipio" /></label>
        <label class="field">Estado<input maxlength="2" formControlName="uf" placeholder="UF" /></label>
        <label class="field">Zona<select formControlName="zona"><option value="URBANA">Urbana</option><option value="RURAL">Rural</option></select></label>
        <label class="field">Situação do imóvel<select formControlName="situacao_imovel"><option value=""></option><option value="PRÓPRIO">Próprio</option><option value="ALUGADO">Alugado</option><option value="CEDIDO">Cedido</option><option value="OCUPAÇÃO">Ocupação</option><option value="OUTRO">Outro</option></select></label>
        <div class="field-grid cols-3 compact full-span">
          <label class="field">Tipo de moradia<select formControlName="tipo_moradia"><option value=""></option><option value="CASA">Casa</option><option value="APARTAMENTO">Apartamento</option><option value="COMODATO">Comodato</option><option value="ABRIGO">Abrigo</option><option value="SITUACAO_RUA">Situação de rua</option></select></label>
          <label class="field">Esgoto<select formControlName="esgoto_tipo"><option value=""></option><option value="REDE">Rede</option><option value="FOSSA">Fossa</option><option value="CEU_ABERTO">Céu aberto</option><option value="NAO_POSSUI">Não possui</option></select></label>
          <label class="field">Coleta de lixo<select formControlName="coleta_lixo"><option value=""></option><option value="REGULAR">Regular</option><option value="IRREGULAR">Irregular</option><option value="NAO_POSSUI">Não possui</option></select></label>
        </div>
        <div class="feature-grid">
          <label class="checkbox-field"><input type="checkbox" formControlName="agua_encanada" /> <span>Água encanada</span></label>
          <label class="checkbox-field"><input type="checkbox" formControlName="energia_eletrica" /> <span>Energia elétrica</span></label>
          <label class="checkbox-field"><input type="checkbox" formControlName="internet" /> <span>Internet</span></label>
        </div>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'membros'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('membros') }}</p>
          <p class="muted">Inclua beneficiários vinculados, responsabilidades e observações.</p>
        </div>
        <button type="button" class="ghost" (click)="addMembro()">Adicionar membro</button>
      </div>
      <div class="membro" *ngFor="let membro of membros.controls; let i = index" [formGroupName]="i">
        <div class="field-grid cols-3">
          <label class="field">Beneficiário*<input
              formControlName="beneficiario_nome"
              placeholder="Busque pelo nome do beneficiário"
              (input)="buscarBeneficiarios($any($event.target).value, i)"
            />
            <input type="hidden" formControlName="id_beneficiario" />
            <div class="search-results" *ngIf="membrosFiltrados.length && membrosFiltrados[0]._membroIndex === i">
              <button type="button" *ngFor="let beneficiario of membrosFiltrados" (click)="selecionarMembro(i, beneficiario)">
                <span class="strong">{{ beneficiario.nome_completo || beneficiario.nome_social }}</span>
                <span class="muted">CPF: {{ beneficiario.cpf || 'Sem CPF' }} · ID: {{ beneficiario.id_beneficiario }}</span>
              </button>
            </div>
            <p class="field-error" *ngIf="membro.get('id_beneficiario')?.invalid && membro.get('id_beneficiario')?.touched">
              Selecione um beneficiário para compor a família.
            </p>
          </label>
          <label class="field">Parentesco*<input formControlName="parentesco" placeholder="Ex.: Filho, responsável" /></label>
          <label class="checkbox-field"><input type="checkbox" formControlName="responsavel_familiar" /> <span>Responsável familiar</span></label>
          <label class="checkbox-field"><input type="checkbox" formControlName="contribui_renda" /> <span>Contribui renda</span></label>
          <label class="field">Renda individual<input type="number" formControlName="renda_individual" placeholder="0,00" /></label>
          <label class="checkbox-field"><input type="checkbox" formControlName="participa_servicos" /> <span>Participa de serviços</span></label>
          <label class="field full">Observações<textarea formControlName="observacoes" placeholder="Referências, notas importantes"></textarea></label>
        </div>
        <div class="flex justify-end">
          <button type="button" class="ghost" (click)="removeMembro(i)">Remover</button>
        </div>
      </div>
      <div class="list-card" *ngIf="membros.length">
        <div class="list-card__header">
          <div>
            <p class="page-title__eyebrow">Resumo</p>
            <p class="page-title__label">Membros adicionados</p>
          </div>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Beneficiário</th>
                <th>Parentesco</th>
                <th>Responsável</th>
                <th>Contribui renda</th>
                <th>Observações</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let membro of membros.controls; let i = index">
                <td>{{ getNomeBeneficiario(i) }}</td>
                <td>{{ membro.get('parentesco')?.value || '---' }}</td>
                <td>{{ membro.get('responsavel_familiar')?.value ? 'Sim' : 'Não' }}</td>
                <td>{{ membro.get('contribui_renda')?.value ? 'Sim' : 'Não' }}</td>
                <td class="muted">{{ membro.get('observacoes')?.value || '---' }}</td>
                <td class="text-right"><button type="button" class="ghost" (click)="removeMembro(i)">Excluir</button></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'renda'" formGroupName="renda">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('renda') }}</p>
          <p class="muted">Registre a renda total, per capita e fontes que sustentam a família.</p>
        </div>
      </div>
      <div class="field-grid cols-2">
        <label class="field">Renda familiar total<input formControlName="renda_familiar_total" placeholder="Somatório mensal" /></label>
        <label class="field">Renda per capita<input formControlName="renda_per_capita" placeholder="Valor por pessoa" /></label>
        <label class="field full">Principais fontes de renda<textarea formControlName="principais_fontes_renda" placeholder="Salário, benefícios, outros"></textarea></label>
        <label class="field">Situação de insegurança alimentar<select formControlName="situacao_inseguranca_alimentar">
            <option value=""></option>
            <option value="NAO_APRESENTA">Não apresenta</option>
            <option value="MODERADA">Moderada</option>
            <option value="GRAVE">Grave</option>
          </select></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="possui_dividas_relevantes" /> <span>Possui dívidas relevantes</span></label>
        <label class="field full">Descrição das dívidas<textarea formControlName="descricao_dividas" placeholder="Bancos, cartões, financiamentos"></textarea></label>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'vulnerabilidades'" formGroupName="vulnerabilidades">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ getTabLabel('vulnerabilidades') }}</p>
          <p class="muted">Registre riscos, acompanhamentos e próxima visita planejada.</p>
        </div>
      </div>
      <div class="field-grid cols-2">
        <label class="field full">Vulnerabilidades<textarea formControlName="vulnerabilidades_familia" placeholder="Insegurança alimentar, saúde, moradia..."></textarea></label>
        <label class="field full">Serviços de acompanhamento<textarea formControlName="servicos_acompanhamento" placeholder="CRAS, saúde, rede de apoio"></textarea></label>
        <label class="field">Técnico responsável<input formControlName="tecnico_responsavel" placeholder="Nome do profissional" /></label>
        <label class="field">Periodicidade<input formControlName="periodicidade_atendimento" placeholder="Semanal, mensal..." /></label>
        <label class="field">Próxima visita<input type="date" formControlName="proxima_visita_prevista" /></label>
        <label class="field full">Observações<textarea formControlName="observacoes" placeholder="Notas adicionais"></textarea></label>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>
  </form>
</section>
