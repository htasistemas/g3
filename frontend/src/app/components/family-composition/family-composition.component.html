<section class="cadastro">
  <header class="page-title">
    <p class="page-title__eyebrow">Cadastros</p>
    <p class="page-title__label">Composição familiar</p>
  </header>

  <div class="page-actions">
    <button type="button" class="ghost" (click)="startNewFamily()">Nova família</button>
    <button type="button" class="primary" (click)="submit()" [disabled]="isSaving">
      {{ isSaving ? 'Salvando...' : 'Salvar composição' }}
    </button>
    <button type="button" class="ghost" routerLink="/beneficiarios">Voltar para beneficiários</button>
  </div>

  <div class="tab-shell">
    <p class="tab-shell__title">Navegue pelas informações</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of tabs; index as idx"
        class="step-tabs__item"
        [class.active]="activeTab === tab.id"
        [class.completed]="idx < activeTabIndex"
      >
        <button
          class="step-tabs__button"
          type="button"
          role="tab"
          [attr.aria-selected]="activeTab === tab.id"
          (click)="changeTab(tab.id)"
        >
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ tab.label }}</span>
        </button>
      </li>
    </ol>
  </div>

  <form [formGroup]="familyForm" class="form-shell">
    <div
      *ngIf="feedback"
      class="feedback"
      [class.feedback--success]="feedback.type === 'success'"
      [class.feedback--error]="feedback.type === 'error'"
    >
      {{ feedback.message }}
    </div>

    <ng-template #navigationControls>
      <div class="tab-actions">
        <button type="button" class="ghost" *ngIf="hasPreviousTab" (click)="goToPreviousTab()">Voltar</button>
        <button type="button" class="primary" *ngIf="hasNextTab" (click)="goToNextTab()">
          Próximo: {{ nextTabLabel }}
        </button>
        <button type="button" class="primary" *ngIf="!hasNextTab" (click)="submit()" [disabled]="isSaving">
          {{ isSaving ? 'Salvando...' : 'Salvar cadastro' }}
        </button>
      </div>
    </ng-template>

    <div class="tab-card" *ngIf="activeTab === 'family'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">Dados da família</p>
          <h3>Identifique a família, referência e arranjo familiar.</h3>
          <p class="muted">Uma família por endereço. Cadastre a pessoa de referência e defina o arranjo familiar.</p>
        </div>
        <span class="pill">Obrigatório</span>
      </div>

      <div class="field-grid cols-2">
        <label class="field">Nome de referência da família*
          <input
            id="referenceName"
            type="text"
            formControlName="referenceName"
            placeholder="Ex: Família Silva - Maria de Souza"
          />
        </label>
        <label class="field">Beneficiário referência (responsável)
          <select
            id="referenceBeneficiaryId"
            formControlName="referenceBeneficiaryId"
            (change)="selectReferenceBeneficiary(familyForm.get('referenceBeneficiaryId')?.value ?? null)"
          >
            <option [ngValue]="null">Selecione</option>
            <option *ngFor="let beneficiary of beneficiaries" [ngValue]="beneficiary.id">{{ beneficiary.nomeCompleto }}</option>
          </select>
        </label>
      </div>

      <div class="field-grid cols-3 compact">
        <label class="field">Tipo de arranjo familiar
          <select id="arrangementType" formControlName="arrangementType">
            <option value="">Selecione</option>
            <option value="nuclear">Nuclear (pais + filhos)</option>
            <option value="monoparental">Monoparental</option>
            <option value="extensa">Extensa</option>
            <option value="reconstituida">Reconstituída</option>
            <option value="outra">Outra</option>
          </select>
        </label>
        <label class="field full" *ngIf="familyForm.get('arrangementType')?.value === 'outra'">Descreva o arranjo
          <input id="arrangementOther" type="text" formControlName="arrangementOther" />
        </label>
      </div>

      <div class="stats-grid">
        <div class="info-card">
          <p class="info-card__label">Total de membros</p>
          <p class="info-card__value">{{ totalMembers }}</p>
        </div>
        <div class="info-card">
          <p class="info-card__label">Crianças (0-12)</p>
          <p class="info-card__value">{{ childrenCount }}</p>
        </div>
        <div class="info-card">
          <p class="info-card__label">Adolescentes (13-17)</p>
          <p class="info-card__value">{{ teensCount }}</p>
        </div>
        <div class="info-card">
          <p class="info-card__label">Idosos (60+)</p>
          <p class="info-card__value">{{ seniorsCount }}</p>
        </div>
        <div class="info-card">
          <p class="info-card__label">Pessoas com deficiência</p>
          <p class="info-card__value">{{ disabledCount }}</p>
        </div>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'address'" [formGroup]="addressGroup">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">Endereço</p>
          <h3>Endereço de referência</h3>
          <p class="muted">Preencha o endereço completo para visitas, entregas e deslocamentos.</p>
        </div>
      </div>

      <div class="field-grid cols-3">
        <label class="field">CEP<input id="cep" type="text" formControlName="cep" /></label>
        <label class="field">Logradouro<input id="logradouro" type="text" formControlName="logradouro" /></label>
        <label class="field">Número<input id="numero" type="text" formControlName="numero" /></label>
        <label class="field">Complemento<input id="complemento" type="text" formControlName="complemento" /></label>
        <label class="field">Bairro<input id="bairro" type="text" formControlName="bairro" /></label>
        <label class="field">Município<input id="municipio" type="text" formControlName="municipio" /></label>
        <label class="field">UF<input id="uf" type="text" formControlName="uf" /></label>
        <label class="field">Ponto de referência<input id="pontoReferencia" type="text" formControlName="pontoReferencia" /></label>
        <label class="field">Zona
          <select id="zona" formControlName="zona">
            <option value="urbana">Urbana</option>
            <option value="rural">Rural</option>
          </select>
        </label>
        <label class="field">Situação do imóvel<input id="situacaoImovel" type="text" formControlName="situacaoImovel" /></label>
        <label class="field">Tipo de moradia<input id="tipoMoradia" type="text" formControlName="tipoMoradia" /></label>
      </div>

      <div class="feature-grid" formGroupName="saneamento">
        <label class="checkbox-field"><input type="checkbox" formControlName="agua" /> <span>Possui água tratada</span></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="esgoto" /> <span>Rede de esgoto</span></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="lixo" /> <span>Coleta de lixo</span></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="energia" /> <span>Energia elétrica</span></label>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'members'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">Composição familiar</p>
          <h3>Vincule beneficiários e organize responsabilidades.</h3>
          <p class="muted">Selecione beneficiários já cadastrados ou inclua membros manualmente.</p>
        </div>
        <button type="button" class="ghost" (click)="openBeneficiaryForm()">Cadastrar novo beneficiário</button>
      </div>

      <div class="field-grid cols-2">
        <label class="field">Buscar beneficiário por nome ou CPF
          <input
            type="text"
            placeholder="Buscar beneficiário por nome ou CPF"
            [(ngModel)]="memberSearchTerm"
            (ngModelChange)="filterBeneficiaries()"
            name="memberSearch"
            [ngModelOptions]="{ standalone: true }"
          />
        </label>
        <div class="info-card">
          <p class="info-card__label">Membros cadastrados</p>
          <p class="info-card__value">{{ totalMembers }}</p>
          <p class="muted">Defina o responsável e a contribuição de renda.</p>
        </div>
      </div>

      <div class="member-grid">
        <div class="border-card">
          <h3 class="section-title">Base de beneficiários</h3>
          <p class="muted">Selecione um beneficiário já cadastrado para vinculá-lo à família.</p>
          <div class="suggestions" *ngIf="filteredBeneficiaries.length; else emptySearch">
            <button
              *ngFor="let beneficiary of filteredBeneficiaries"
              type="button"
              class="suggestion"
              (click)="addMember(beneficiary)"
            >
              <div>
                <p class="suggestion__name">{{ beneficiary.nomeCompleto }}</p>
                <p class="muted">CPF: {{ beneficiary.cpf || '—' }}</p>
              </div>
              <span class="tag">Vincular</span>
            </button>
          </div>
          <ng-template #emptySearch>
            <div class="empty">
              <p class="muted">Nenhum beneficiário encontrado para o filtro informado.</p>
            </div>
          </ng-template>
        </div>

        <div class="border-card">
          <h3 class="section-title">Resumo</h3>
          <p class="muted">Defina o responsável familiar e marque quem contribui com a renda.</p>
          <div class="field-grid cols-2 compact">
            <div class="info-card">
              <p class="info-card__label">Membros cadastrados</p>
              <p class="info-card__value">{{ totalMembers }}</p>
            </div>
            <div class="info-card">
              <p class="info-card__label">Renda familiar calculada</p>
              <p class="info-card__value">R$ {{ rendaTotalFromMembers | number: '1.2-2' }}</p>
            </div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button type="button" class="ghost" (click)="addEmptyMember()">Adicionar membro manualmente</button>
      </div>

      <div class="space-y">
        <div *ngIf="members.length === 0" class="empty">Nenhum membro vinculado ainda.</div>
        <div *ngFor="let member of members.controls; index as i" [formGroup]="member" class="member-card">
          <div class="member-card__header">
            <div>
              <p class="muted">Beneficiário</p>
              <p class="member-name">{{ member.get('nome')?.value || 'Novo membro' }}</p>
              <p class="muted">CPF: {{ member.get('cpf')?.value || '—' }}</p>
            </div>
            <div class="member-actions">
              <label class="checkbox-field">
                <input type="checkbox" [checked]="member.get('responsavel')?.value" (change)="markAsResponsible(i)" />
                <span>Responsável familiar</span>
              </label>
              <button type="button" class="ghost" (click)="removeMember(i)">Remover</button>
            </div>
          </div>

          <div class="field-grid cols-3">
            <label class="field">Parentesco
              <select formControlName="parentesco">
                <option value="">Selecione</option>
                <option value="conjuge">Cônjuge/companheiro(a)</option>
                <option value="filho">Filho(a)</option>
                <option value="enteado">Enteado(a)</option>
                <option value="pai">Pai/Mãe</option>
                <option value="avo">Avô/Avó</option>
                <option value="neto">Neto(a)</option>
                <option value="irmao">Irmão(ã)</option>
                <option value="outro">Outro</option>
              </select>
            </label>
            <label class="field">Data de nascimento<input type="date" formControlName="dataNascimento" /></label>
            <label class="field">Idade estimada<input type="number" [value]="ageFromMember(member)" readonly /></label>
          </div>

          <div class="field-grid cols-3">
            <label class="field">Escolaridade<input type="text" formControlName="escolaridade" /></label>
            <label class="field">Situação de trabalho<input type="text" formControlName="condicaoTrabalho" /></label>
            <label class="field">Renda individual (R$)
              <input type="number" min="0" step="0.01" formControlName="rendaIndividual" (input)="updateIncomeTotals()" />
            </label>
          </div>

          <div class="feature-grid">
            <label class="checkbox-field"><input type="checkbox" formControlName="contribuiRenda" (change)="updateIncomeTotals()" /> <span>Contribui com a renda</span></label>
            <label class="checkbox-field"><input type="checkbox" formControlName="participaServicos" /> <span>Participa dos serviços da instituição</span></label>
            <label class="checkbox-field"><input type="checkbox" formControlName="possuiDeficiencia" /> <span>Possui deficiência</span></label>
          </div>

          <label class="field full">Observações
            <textarea rows="2" formControlName="observacoes" placeholder="Registro de condição na família, vínculos e observações"></textarea>
          </label>
        </div>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'income'" [formGroup]="incomeGroup">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">Renda e condições de vida</p>
          <h3>Registre a renda total, per capita e fontes que sustentam a família.</h3>
        </div>
      </div>

      <div class="field-grid cols-3">
        <label class="field">Renda familiar total (calculada)<input id="rendaTotal" type="number" formControlName="rendaTotal" readonly /></label>
        <label class="field">Renda per capita<input id="rendaPerCapita" type="text" formControlName="rendaPerCapita" readonly /></label>
        <label class="field">Faixa de renda per capita
          <select id="faixaRenda" formControlName="faixaRenda">
            <option value="">Selecione</option>
            <option value="ate_quarto">Até 1/4 salário mínimo</option>
            <option value="quarto_meio">Entre 1/4 e 1/2 salário mínimo</option>
            <option value="meio_um">Entre 1/2 e 1 salário mínimo</option>
            <option value="acima_um">Acima de 1 salário mínimo</option>
          </select>
        </label>
      </div>

      <div class="field-grid cols-2">
        <div class="field">
          <p class="field-title">Fontes de renda</p>
          <div class="feature-grid" formGroupName="fontes">
            <label class="checkbox-field"><input type="checkbox" formControlName="trabalhoFormal" /> <span>Trabalho formal</span></label>
            <label class="checkbox-field"><input type="checkbox" formControlName="trabalhoInformal" /> <span>Trabalho informal</span></label>
            <label class="checkbox-field"><input type="checkbox" formControlName="previdenciario" /> <span>Benefício previdenciário</span></label>
            <label class="checkbox-field"><input type="checkbox" formControlName="assistencial" /> <span>Benefício assistencial</span></label>
            <label class="checkbox-field"><input type="checkbox" formControlName="doacoes" /> <span>Doações / ajuda</span></label>
            <label class="checkbox-field"><input type="checkbox" formControlName="outros" /> <span>Outros</span></label>
          </div>
        </div>
        <div class="field">
          <p class="field-title">Despesas principais</p>
          <div class="field-grid cols-2 compact" formGroupName="despesas">
            <label class="field">Aluguel / financiamento<input type="text" formControlName="aluguel" /></label>
            <label class="field">Alimentação<input type="text" formControlName="alimentacao" /></label>
            <label class="field">Água / Luz<input type="text" formControlName="aguaLuz" /></label>
            <label class="field">Transporte<input type="text" formControlName="transporte" /></label>
            <label class="field">Medicamentos<input type="text" formControlName="medicamentos" /></label>
            <label class="field">Outros<input type="text" formControlName="outros" /></label>
          </div>
        </div>
      </div>

      <div class="field-grid cols-3">
        <label class="field">Situação de insegurança alimentar
          <select id="insegurancaAlimentar" formControlName="insegurancaAlimentar">
            <option value="">Selecione</option>
            <option value="nao">Não apresenta</option>
            <option value="moderada">Moderada</option>
            <option value="grave">Grave</option>
          </select>
        </label>
        <label class="field">Possui dívidas relevantes?
          <select id="possuiDividas" formControlName="possuiDividas">
            <option [ngValue]="false">Não</option>
            <option [ngValue]="true">Sim</option>
          </select>
        </label>
        <label class="field">Detalhes das dívidas<input id="detalhesDividas" type="text" formControlName="detalhesDividas" /></label>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'vulnerability'" [formGroup]="vulnerabilityGroup">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">Vulnerabilidades e encaminhamentos</p>
          <h3>Mapeie vulnerabilidades e acompanhamentos necessários.</h3>
        </div>
      </div>

      <div class="feature-grid">
        <label class="checkbox-field"><input type="checkbox" formControlName="violenciaDomestica" /> <span>Violência doméstica</span></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="trabalhoInfantil" /> <span>Trabalho infantil</span></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="situacaoRua" /> <span>Situação de rua</span></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="desempregoLongo" /> <span>Desemprego prolongado</span></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="moradiaPrecaria" /> <span>Moradia precária</span></label>
        <label class="checkbox-field"><input type="checkbox" formControlName="dependenciaQuimica" /> <span>Dependência química</span></label>
      </div>

      <label class="field">Outras vulnerabilidades
        <textarea id="outras" rows="2" formControlName="outras"></textarea>
      </label>

      <label class="field">Serviços e programas que acompanham a família
        <textarea id="programas" rows="2" formControlName="programas"></textarea>
      </label>

      <label class="field">Histórico de atendimentos/resumo
        <textarea id="historico" rows="3" formControlName="historico"></textarea>
      </label>

      <div class="field-grid cols-3">
        <label class="field">Técnico responsável<input id="tecnicoResponsavel" type="text" formControlName="tecnicoResponsavel" /></label>
        <label class="field">Periodicidade de atendimento<input id="periodicidade" type="text" formControlName="periodicidade" /></label>
        <label class="field">Próxima visita domiciliar<input id="proximaVisita" type="date" formControlName="proximaVisita" /></label>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>
  </form>
</section>
