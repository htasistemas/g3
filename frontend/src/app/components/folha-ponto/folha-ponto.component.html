<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarToolbar]="false"
  [mostrarFechar]="true"
  [fullWidth]="true"
  (buscar)="onBuscar()"
  (imprimir)="onImprimir()"
  (fechar)="onFechar()"
>
  <header class="page-title page-title--row" slot="titulo"></header>

  <section class="cadastro">
    <div class="page-actions">
      <app-barra-acoes-crud
        [acoes]="acoesToolbar"
        [desabilitado]="acoesDesabilitadas"
        [mostrarFechar]="true"
        (imprimir)="onImprimir()"
        (buscar)="onBuscar()"
        (fechar)="onFechar()"
      ></app-barra-acoes-crud>
    </div>

    <app-popup-messages
      [mensagens]="popupErros"
      [titulo]="popupTitulo"
      (fechar)="fecharPopupErros()"
    ></app-popup-messages>

    <div class="cadastro-layout">
      <aside class="cadastro-menu">
        <div class="tab-shell">
          <p class="tab-shell__title tab-shell__title--destaque">
            <fa-icon [icon]="faUserClock" class="tab-shell__icon"></fa-icon>
            Folha de ponto
          </p>
          <ol class="step-tabs" role="tablist">
            <li
              *ngFor="let tab of tabs; index as idx"
              class="step-tabs__item"
              [class.active]="activeTab === tab.id"
              [class.completed]="idx < getTabIndex(activeTab)"
            >
              <button
                class="step-tabs__button"
                type="button"
                role="tab"
                [attr.aria-selected]="activeTab === tab.id"
                (click)="changeTab(tab.id)"
              >
                <span class="step-tabs__index">{{ idx + 1 }}</span>
                <span class="step-tabs__label">{{ tab.label }}</span>
              </button>
            </li>
          </ol>
        </div>
      </aside>

      <div class="cadastro-conteudo">
        <div class="tab-card" *ngIf="activeTab === 'registro'">
          <div class="tab-card__header">
            <div class="tab-card__title-stack">
              <p class="tab-card__highlight">Registro diário</p>
            </div>
          </div>

          <p class="info-note">
            Para registrar o ponto, permita a localização e esteja dentro do raio definido da instituição.
            A sequência obrigatória é: Entrada 1 → Saída 1 → Entrada 2 → Saída 2.
          </p>

          <div class="info-grid">
            <div class="info-card">
              <p class="info-card__label">Unidade assistencial</p>
              <h3>{{ unidadeAssistencial?.nomeFantasia || 'Não configurada' }}</h3>
              <p>
                {{ unidadeAssistencial?.endereco || 'Endereço não informado' }}
                <span *ngIf="unidadeAssistencial?.numeroEndereco">, {{ unidadeAssistencial?.numeroEndereco }}</span>
              </p>
              <p class="status-pill" [class.status-pill--ok]="unidadeAssistencial?.latitude && unidadeAssistencial?.longitude"
                 [class.status-pill--pendente]="!unidadeAssistencial?.latitude || !unidadeAssistencial?.longitude">
                {{ unidadeAssistencial?.latitude && unidadeAssistencial?.longitude ? 'Localização configurada' : 'Localização pendente' }}
              </p>
              <button
                *ngIf="!unidadeAssistencial?.latitude || !unidadeAssistencial?.longitude"
                type="button"
                class="status-link"
                [routerLink]="['/unidades/cadastro']"
              >
                Abrir cadastro da unidade
              </button>
              <button
                *ngIf="!unidadeAssistencial?.latitude || !unidadeAssistencial?.longitude"
                type="button"
                class="status-link"
                (click)="atualizarLocalizacaoUnidade()"
              >
                Atualizar localização
              </button>
              <p *ngIf="unidadeAssistencial">
                Raio: {{ unidadeAssistencial.raioPontoMetros || 100 }}m • Precisão máxima:
                {{ unidadeAssistencial.accuracyMaxPontoMetros || 80 }}m
              </p>
              <p *ngIf="unidadeAssistencial?.ipValidacaoPonto">
                Validação por IP interno: {{ unidadeAssistencial?.ipValidacaoPonto }}
              </p>
            </div>
            <div class="info-card">
              <p class="info-card__label">Carga e tolerância</p>
              <h3>{{ formatarMinutos(configuracao?.cargaSemanalMinutos) }} semanais</h3>
              <p>Seg–qui: {{ formatarMinutos(configuracao?.cargaSegQuiMinutos) }}</p>
              <p>Sexta: {{ formatarMinutos(configuracao?.cargaSextaMinutos) }}</p>
              <p>Tolerância: {{ formatarMinutos(configuracao?.toleranciaMinutos) }}</p>
              <p>Carga prevista hoje: {{ cargaPrevistaHoje() }}</p>
              <p>Horas trabalhadas hoje: {{ horasTrabalhadasHoje() }}</p>
            </div>
          </div>

          <div class="horario-trabalho__data">
            Hoje: {{ dataHojeCompleta() }} · {{ horaAtual }}
          </div>

          <div class="horario-trabalho">
            <div class="horario-trabalho__header">
              <p class="horario-trabalho__title">Horários do funcionário</p>
              <span class="horario-trabalho__subtitle" *ngIf="isRhAdmin && funcionarioSelecionadoId">
                Funcionário selecionado na lista
              </span>
            </div>
            <div class="horario-trabalho__grid">
              <div class="horario-trabalho__item">
                <span class="horario-trabalho__label">Entrada 1</span>
                <strong>{{ obterHorarioDiaAtual().entrada1 || '--:--' }}</strong>
              </div>
              <div class="horario-trabalho__item">
                <span class="horario-trabalho__label">Saída 1</span>
                <strong>{{ obterHorarioDiaAtual().saida1 || '--:--' }}</strong>
              </div>
              <div class="horario-trabalho__item">
                <span class="horario-trabalho__label">Entrada 2</span>
                <strong>{{ obterHorarioDiaAtual().entrada2 || '--:--' }}</strong>
              </div>
              <div class="horario-trabalho__item">
                <span class="horario-trabalho__label">Saída 2</span>
                <strong>{{ obterHorarioDiaAtual().saida2 || '--:--' }}</strong>
              </div>
            </div>
          </div>

          <div class="batida-grid">
            <button
              type="button"
              class="batida-card"
              [class.batida-card--ativa]="podeRegistrar('E1')"
              [disabled]="!podeRegistrar('E1')"
              (click)="iniciarBatida('E1')"
            >
              <span class="batida-card__titulo">Entrada 1</span>
              <strong class="batida-card__acao">
                <fa-icon [icon]="faClock"></fa-icon>
                Registrar
              </strong>
              <span class="batida-card__hora">{{ obterHoraExibida('E1') }}</span>
            </button>
            <button
              type="button"
              class="batida-card"
              [class.batida-card--ativa]="podeRegistrar('S1')"
              [disabled]="!podeRegistrar('S1')"
              (click)="iniciarBatida('S1')"
            >
              <span class="batida-card__titulo">Saída 1</span>
              <strong class="batida-card__acao">
                <fa-icon [icon]="faClock"></fa-icon>
                Registrar
              </strong>
              <span class="batida-card__hora">{{ obterHoraExibida('S1') }}</span>
            </button>
            <button
              type="button"
              class="batida-card"
              [class.batida-card--ativa]="podeRegistrar('E2')"
              [disabled]="!podeRegistrar('E2')"
              (click)="iniciarBatida('E2')"
            >
              <span class="batida-card__titulo">Entrada 2</span>
              <strong class="batida-card__acao">
                <fa-icon [icon]="faClock"></fa-icon>
                Registrar
              </strong>
              <span class="batida-card__hora">{{ obterHoraExibida('E2') }}</span>
            </button>
            <button
              type="button"
              class="batida-card"
              [class.batida-card--ativa]="podeRegistrar('S2')"
              [disabled]="!podeRegistrar('S2')"
              (click)="iniciarBatida('S2')"
            >
              <span class="batida-card__titulo">Saída 2</span>
              <strong class="batida-card__acao">
                <fa-icon [icon]="faClock"></fa-icon>
                Registrar
              </strong>
              <span class="batida-card__hora">{{ obterHoraExibida('S2') }}</span>
            </button>
          </div>
        </div>

        <div class="tab-card" *ngIf="activeTab === 'espelho'">
          <div class="tab-card__header">
            <div class="tab-card__title-stack">
              <p class="tab-card__highlight">Espelho mensal</p>
            </div>
            <div class="tab-card__header-actions">
              <label class="field compact">
                Mês
                <select [(ngModel)]="espelhoMesSelecionado" (ngModelChange)="selecionarReferenciaEspelho()" name="mesEspelho">
                  <option *ngFor="let mes of mesesEspelho" [value]="mes.valor">{{ mes.label }}</option>
                </select>
              </label>
              <label class="field compact">
                Ano
                <select [(ngModel)]="espelhoAnoSelecionado" (ngModelChange)="selecionarReferenciaEspelho()" name="anoEspelho">
                  <option *ngFor="let ano of anosEspelho" [value]="ano">{{ ano }}</option>
                </select>
              </label>
              <label class="field compact" *ngIf="isRhAdmin">
                Funcionário
                <select #selectFuncionario (change)="selecionarFuncionario(selectFuncionario.value)">
                  <option *ngFor="let user of usuarios" [value]="user.id" [selected]="user.id === funcionarioSelecionadoId">
                    {{ user.nome || user.nomeUsuario }}
                  </option>
                </select>
              </label>
            </div>
          </div>

          <p class="info-note">
            Selecione o mês e o ano para consultar o espelho. Os totais são calculados automaticamente.
          </p>

          <div class="info-grid" *ngIf="espelho">
            <div class="info-card">
              <p class="info-card__label">Total trabalhado</p>
              <h3>{{ formatarMinutos(espelho.totalTrabalhadoMinutos) }}</h3>
            </div>
            <div class="info-card">
              <p class="info-card__label">Total devido</p>
              <h3>{{ formatarMinutos(espelho.totalDevidoMinutos) }}</h3>
            </div>
            <div class="info-card">
              <p class="info-card__label">Horas extras</p>
              <h3>{{ formatarMinutos(espelho.totalExtrasMinutos) }}</h3>
            </div>
            <div class="info-card">
              <p class="info-card__label">Faltas/Atrasos</p>
              <h3>{{ formatarMinutos(espelho.totalFaltasAtrasosMinutos) }}</h3>
            </div>
          </div>

          <div class="table-wrapper" *ngIf="espelho?.dias?.length">
            <table class="espelho-table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Ocorr.</th>
                  <th>Entrada</th>
                  <th>Saída</th>
                  <th>Entrada</th>
                  <th>Saída</th>
                  <th>Horas</th>
                  <th>Extras</th>
                  <th>Faltas/Atrasos</th>
                  <th>Observações</th>
                  <th *ngIf="isRhAdmin">Ações</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let dia of espelho?.dias">
                  <td>{{ dia.data | date: 'dd/MM/yyyy' }}</td>
                  <td>{{ dia.ocorrencia }}</td>
                  <td>{{ dia.entradaManha || '---' }}</td>
                  <td>{{ dia.saidaManha || '---' }}</td>
                  <td>{{ dia.entradaTarde || '---' }}</td>
                  <td>{{ dia.saidaTarde || '---' }}</td>
                  <td>{{ formatarMinutos(dia.totalTrabalhadoMinutos) }}</td>
                  <td>{{ formatarMinutos(dia.extrasMinutos) }}</td>
                  <td>{{ formatarMinutos(dia.faltasAtrasosMinutos) }}</td>
                  <td>{{ dia.observacoes || '---' }}</td>
                  <td *ngIf="isRhAdmin">
                    <button type="button" class="primary" (click)="abrirEditarOcorrencia(dia)" [disabled]="!dia.pontoDiaId">
                      Corrigir
                    </button>
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="6">Totais</td>
                  <td>{{ formatarMinutos(espelho?.totalTrabalhadoMinutos) }}</td>
                  <td>{{ formatarMinutos(espelho?.totalExtrasMinutos) }}</td>
                  <td>{{ formatarMinutos(espelho?.totalFaltasAtrasosMinutos) }}</td>
                  <td></td>
                  <td *ngIf="isRhAdmin"></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <div class="tab-card" *ngIf="activeTab === 'configuracao'">
          <div class="tab-card__header">
            <div class="tab-card__title-stack">
              <p class="tab-card__highlight">Configuração de carga</p>
            </div>
          </div>

          <form class="field-grid cols-6" [formGroup]="configuracaoForm">
            <label class="field">Carga semanal (horas) (*)
              <input type="number" step="0.25" formControlName="cargaSemanalHoras" />
            </label>
            <label class="field">Seg–Qui (horas) (*)
              <input type="number" step="0.25" formControlName="cargaSegQuiHoras" />
            </label>
            <label class="field">Sexta (horas) (*)
              <input type="number" step="0.25" formControlName="cargaSextaHoras" />
            </label>
            <label class="field">Sábado (horas) (*)
              <input type="number" step="0.25" formControlName="cargaSabadoHoras" />
            </label>
            <label class="field">Domingo (horas) (*)
              <input type="number" step="0.25" formControlName="cargaDomingoHoras" />
            </label>
            <label class="field">Tolerância (min) (*)
              <input type="number" formControlName="toleranciaMinutos" />
            </label>
            <label class="field">Carga diária sugerida
              <input type="text" [value]="cargaDiariaSugerida()" readonly />
            </label>
            <label class="field">Observação
              <input type="text" value="Sábado e domingo contam como horas extras" readonly />
            </label>
          </form>

          <div class="tab-actions">
            <button type="button" class="primary" (click)="salvarConfiguracao()">Salvar configuração</button>
          </div>

          <div class="tab-card__divider"></div>

          <div class="tab-card__header">
            <div class="tab-card__title-stack">
              <p class="tab-card__highlight">Horários do funcionário</p>
            </div>
          </div>

          <div class="tab-card__subheader" *ngIf="isRhAdmin">
            <label class="field compact">
              Funcionário
              <select #selectFuncionarioConfig (change)="selecionarFuncionario(selectFuncionarioConfig.value)">
                <option *ngFor="let user of usuarios" [value]="user.id" [selected]="user.id === funcionarioSelecionadoId">
                  {{ user.nome || user.nomeUsuario }}
                </option>
              </select>
            </label>
          </div>

          <form class="horarios-semana" [formGroup]="horariosForm">
            <div class="horario-dia" *ngFor="let dia of diasSemana; index as idx">
              <div class="horario-dia__header">
                <span class="horario-dia__title">{{ dia.label }}</span>
                <button
                  *ngIf="idx > 0 && isRhAdmin"
                  type="button"
                  class="ghost"
                  (click)="copiarHorarioDia(idx)"
                >
                  Copiar do dia anterior
                </button>
              </div>
              <div class="field-grid cols-4 inline">
                <label class="field">Entrada 1
                  <input type="time" [formControlName]="campoHorario(dia.id, 'Entrada1')" [readonly]="!isRhAdmin" />
                </label>
                <label class="field">Saída 1
                  <input type="time" [formControlName]="campoHorario(dia.id, 'Saida1')" [readonly]="!isRhAdmin" />
                </label>
                <label class="field">Entrada 2
                  <input type="time" [formControlName]="campoHorario(dia.id, 'Entrada2')" [readonly]="!isRhAdmin" />
                </label>
                <label class="field">Saída 2
                  <input type="time" [formControlName]="campoHorario(dia.id, 'Saida2')" [readonly]="!isRhAdmin" />
                </label>
              </div>
            </div>
          </form>

          <div class="tab-actions" *ngIf="isRhAdmin">
            <button type="button" class="primary" (click)="salvarHorariosFuncionario()">Salvar horários</button>
          </div>

          <div class="table-wrapper" *ngIf="usuarios.length">
            <table class="espelho-table">
              <thead>
                <tr>
                  <th>Funcionário</th>
                  <th>Segunda</th>
                  <th>Terça</th>
                  <th>Quarta</th>
                  <th>Quinta</th>
                  <th>Sexta</th>
                  <th>Sábado</th>
                  <th>Domingo</th>
                  <th *ngIf="isRhAdmin">Ações</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let user of usuarios">
                  <td>{{ user.nome || user.nomeUsuario }}</td>
                  <td>{{ formatarHorarioDia(user, 'segunda') }}</td>
                  <td>{{ formatarHorarioDia(user, 'terca') }}</td>
                  <td>{{ formatarHorarioDia(user, 'quarta') }}</td>
                  <td>{{ formatarHorarioDia(user, 'quinta') }}</td>
                  <td>{{ formatarHorarioDia(user, 'sexta') }}</td>
                  <td>{{ formatarHorarioDia(user, 'sabado') }}</td>
                  <td>{{ formatarHorarioDia(user, 'domingo') }}</td>
                  <td *ngIf="isRhAdmin">
                    <button type="button" class="primary" (click)="abrirDetalheHorario(user)">
                      Ver detalhes
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <app-dialog
      [aberto]="dialogBatidaAberta"
      titulo="Confirmar batida"
      mensagem="Informe a senha para concluir o registro do ponto."
      confirmarLabel="Confirmar"
      cancelarLabel="Cancelar"
      (confirmar)="confirmarBatida()"
      (cancelar)="cancelarBatida()"
    >
      <div class="dialog-conteudo dialog-bloco">
        <p class="dialog-info" *ngIf="batidaCarregando">Obtendo localização...</p>
        <p class="dialog-info">Tipo de batida: <strong>{{ tipoBatidaAtual }}</strong></p>
        <p class="dialog-info" *ngIf="localizacaoAtual">
          Precisão: {{ localizacaoAtual.accuracy | number: '1.0-0' }}m
          <ng-container *ngIf="localizacaoAtual.distancia !== undefined">
            • Distância: {{ localizacaoAtual.distancia | number: '1.0-0' }}m
          </ng-container>
        </p>
        <label class="field">Senha do funcionário (*)
          <input
            type="password"
            [(ngModel)]="senhaBatida"
            name="senhaBatida"
            placeholder="Digite sua senha"
            (keyup.enter)="confirmarBatida()"
          />
        </label>
      </div>
    </app-dialog>

    <app-dialog
      [aberto]="dialogOcorrenciaAberta"
      titulo="Corrigir ocorrência"
      mensagem="Informe a justificativa e a senha administrativa para corrigir."
      confirmarLabel="Salvar"
      cancelarLabel="Cancelar"
      (confirmar)="confirmarEditarOcorrencia()"
      (cancelar)="cancelarEditarOcorrencia()"
    >
      <div class="dialog-conteudo dialog-bloco" [formGroup]="ocorrenciaForm">
        <label class="field">Ocorrência
          <select #selectFuncionario formControlName="ocorrencia">
            <option value="NORMAL">Normal</option>
            <option value="FERIADO">Feriado</option>
            <option value="FOLGA">Folga</option>
            <option value="JUSTIFICADO">Justificado</option>
            <option value="FERIAS">Férias</option>
            <option value="FALTA">Falta</option>
          </select>
        </label>
        <div class="field-grid cols-4">
          <label class="field">Entrada 1
            <input type="time" formControlName="entrada1" />
          </label>
          <label class="field">Saída 1
            <input type="time" formControlName="saida1" />
          </label>
          <label class="field">Entrada 2
            <input type="time" formControlName="entrada2" />
          </label>
          <label class="field">Saída 2
            <input type="time" formControlName="saida2" />
          </label>
        </div>
        <label class="field">Justificativa (*)
          <textarea rows="3" formControlName="justificativa"></textarea>
        </label>
        <label class="field">Senha administrativa (*)
          <input type="password" formControlName="senhaAdmin" />
        </label>
      </div>
    </app-dialog>

    <app-dialog
      [aberto]="dialogDetalheHorarioAberta"
      titulo="Horários do funcionário"
      mensagem="Horários cadastrados por dia da semana."
      confirmarLabel="Fechar"
      (confirmar)="fecharDetalheHorario()"
      (cancelar)="fecharDetalheHorario()"
    >
      <div class="dialog-conteudo dialog-bloco" *ngIf="usuarioDetalheHorario as usuario">
        <div class="horarios-semana">
          <div class="horario-dia" *ngFor="let dia of diasSemana">
            <div class="horario-dia__header">
              <span class="horario-dia__title">{{ dia.label }}</span>
            </div>
            <div class="field-grid cols-4 inline">
              <div class="field">
                <span>Entrada 1</span>
                <strong>{{ obterValorHorarioUsuario(usuario, dia.id, 'Entrada1') || '--:--' }}</strong>
              </div>
              <div class="field">
                <span>Saída 1</span>
                <strong>{{ obterValorHorarioUsuario(usuario, dia.id, 'Saida1') || '--:--' }}</strong>
              </div>
              <div class="field">
                <span>Entrada 2</span>
                <strong>{{ obterValorHorarioUsuario(usuario, dia.id, 'Entrada2') || '--:--' }}</strong>
              </div>
              <div class="field">
                <span>Saída 2</span>
                <strong>{{ obterValorHorarioUsuario(usuario, dia.id, 'Saida2') || '--:--' }}</strong>
              </div>
            </div>
          </div>
        </div>
      </div>
    </app-dialog>

    <app-dialog
      [aberto]="dialogImpressaoAberta"
      titulo="Impressão"
      mensagem="Selecione o tipo de relatório para imprimir."
      confirmarLabel="Fechar"
      (confirmar)="fecharDialogImpressao()"
      (cancelar)="fecharDialogImpressao()"
    >
      <div class="dialog-conteudo dialog-bloco">
        <div class="dialog-opcoes">
          <button type="button" class="primary" (click)="imprimirEspelhoMensal()">
            Espelho Mensal
          </button>
          <button type="button" class="primary" (click)="imprimirRelacaoColaboradores()">
            Relação de Colaboradores
          </button>
          <button type="button" class="primary" (click)="imprimirConfiguracaoPonto()">
            Configuração do ponto
          </button>
        </div>
      </div>
    </app-dialog>
  </section>
</app-tela-padrao>
