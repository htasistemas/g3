<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  (novo)="abrirFormularioNovo()"
  (cancelar)="acaoCancelar()"
  (buscar)="onBuscar()"
>
  <header class="page-title page-title--row" slot="titulo">
    <div>
      <p class="page-title__eyebrow">SETOR ADMINISTRATIVO</p>
      <p class="page-title__label">Fotos e Eventos</p>
    </div>
    <p class="page-title__note">Cadastro e acompanhamento de fotos e eventos.</p>
  </header>

  <div class="page-actions-extra" slot="acoes">
    <button type="button" class="btn-outline" (click)="carregarEventos()">Atualizar</button>
    <button type="button" class="btn-primary" (click)="abrirFormularioNovo()">Novo evento</button>
  </div>

  <section class="fotos-eventos">
    <app-popup-messages [mensagens]="popupErros" (fechar)="fecharPopupErros()"></app-popup-messages>

    <div *ngIf="feedback" class="alert alert-success">
      <span class="alert__message">{{ feedback }}</span>
      <button type="button" class="alert__close" (click)="dismissFeedback()" aria-label="Fechar">x</button>
    </div>

    <section class="lista-eventos" *ngIf="!mostrandoDetalhe">
      <div class="card filtro-card">
        <div class="card__header">
          <div>
            <p class="card__eyebrow">Filtros</p>
            <h2 class="card__title">Encontre eventos rapidamente</h2>
            <p class="card__subtitle">Busque por nome, descricao, local e tags. Use os filtros para refinar a lista.</p>
          </div>
          <div class="card__actions">
            <button type="button" class="btn-outline" (click)="limparFiltros()">Limpar filtros</button>
            <button type="button" class="btn-primary" (click)="aplicarFiltros()">Aplicar filtros</button>
            <button type="button" class="btn-primary" (click)="aplicarFiltros()">Buscar</button>
          </div>
        </div>

        <form [formGroup]="filtrosForm" class="filtro-grid" (ngSubmit)="aplicarFiltros()">
          <label class="field">
            Busca
            <input type="text" formControlName="busca" placeholder="Nome, descricao ou local" title="Busca por nome, descricao e local" />
          </label>
          <label class="field">
            Data inicial
            <input type="date" formControlName="dataInicio" title="Filtre a partir desta data" />
          </label>
          <label class="field">
            Data final
            <input type="date" formControlName="dataFim" title="Filtre ate esta data" />
          </label>
          <label class="field">
            Tags
            <input type="text" formControlName="tags" placeholder="Ex.: Capacitacao, Campanha" title="Separe as tags por virgula" />
          </label>
          <label class="field">
            Ordenacao
            <select formControlName="ordenacao" title="Ordene a listagem">
              <option *ngFor="let item of ordenacaoOpcoes" [value]="item.valor">{{ item.label }}</option>
            </select>
          </label>
        </form>
      </div>

      <div *ngIf="listLoading" class="skeleton-grid">
        <div class="skeleton-card" *ngFor="let item of [1,2,3,4,5,6]"></div>
      </div>

      <div class="eventos-grid" *ngIf="!listLoading && eventos.length">
        <article class="evento-card" *ngFor="let evento of eventos" (click)="abrirDetalhe(evento)">
          <div class="evento-card__media">
            <img *ngIf="evento.fotoPrincipalUrl" [src]="evento.fotoPrincipalUrl" alt="Foto principal do evento" />
            <div class="evento-card__placeholder" *ngIf="!evento.fotoPrincipalUrl">Sem foto</div>
          </div>
          <div class="evento-card__content">
            <div class="evento-card__header">
              <h3>{{ evento.titulo }}</h3>
              <span class="pill" [ngClass]="classeStatus(evento.status)">{{ formatarStatus(evento.status) }}</span>
            </div>
            <p class="evento-card__meta">
              <span>{{ evento.dataEvento | date: 'dd/MM/yyyy' }}</span>
              <span *ngIf="evento.local">{{ evento.local }}</span>
            </p>
            <p class="evento-card__descricao" *ngIf="evento.descricao">{{ recortarTexto(evento.descricao) }}</p>
            <div class="evento-card__info">
              <span>{{ totalFotos(evento) }} fotos</span>
              <span *ngIf="evento.unidadeId">Unidade {{ evento.unidadeId }}</span>
            </div>
            <div class="evento-card__tags" *ngIf="obterTags(evento.tags).length">
              <span class="chip" *ngFor="let tag of obterTags(evento.tags)">{{ tag }}</span>
            </div>
            <div class="evento-card__actions">
              <button type="button" class="btn-ghost" (click)="abrirDetalhe(evento); $event.stopPropagation()">Ver detalhes</button>
              <button type="button" class="btn-ghost" (click)="abrirFormularioEdicao(evento); $event.stopPropagation()">Editar</button>
              <button type="button" class="btn-ghost" (click)="abrirUploadFotos(evento); $event.stopPropagation()">Adicionar fotos</button>
              <button type="button" class="btn-ghost danger" (click)="confirmarExcluirEvento(evento); $event.stopPropagation()">Excluir</button>
            </div>
          </div>
        </article>
      </div>

      <div *ngIf="!listLoading && !eventos.length" class="empty-state">
        <div>
          <h3>Nenhum evento encontrado</h3>
          <p>Crie um novo evento para iniciar a galeria da instituicao.</p>
        </div>
        <button type="button" class="btn-primary" (click)="abrirFormularioNovo()">Criar evento</button>
      </div>

      <div class="pagination" *ngIf="!listLoading && totalPaginas > 1">
        <span>Pagina {{ paginaAtual + 1 }} de {{ totalPaginas }} - {{ totalRegistros }} eventos</span>
        <div class="pagination__actions">
          <button type="button" class="btn-outline" (click)="paginaAnterior()" [disabled]="paginaAtual === 0">Anterior</button>
          <button type="button" class="btn-outline" (click)="proximaPagina()" [disabled]="paginaAtual + 1 >= totalPaginas">Proxima</button>
        </div>
      </div>
    </section>

    <section class="detalhe-evento" *ngIf="mostrandoDetalhe">
      <button type="button" class="btn-ghost" (click)="voltarLista()">Voltar para lista</button>

      <div class="card detalhe-card" *ngIf="eventoSelecionado">
        <div class="card__header">
          <div>
            <p class="card__eyebrow">Resumo do evento</p>
            <h2 class="card__title">{{ eventoSelecionado.titulo }}</h2>
            <p class="card__subtitle">{{ eventoSelecionado.descricao || 'Sem descricao informada.' }}</p>
          </div>
          <div class="card__actions">
            <button type="button" class="btn-outline" (click)="abrirFormularioEdicao()">Editar</button>
            <button type="button" class="btn-outline" (click)="abrirUploadFotos()">Adicionar fotos</button>
            <button type="button" class="btn-danger" (click)="confirmarExcluirEvento()">Excluir</button>
          </div>
        </div>

        <div class="detalhe-grid">
          <div class="detalhe-item">
            <span>Data</span>
            <strong>{{ eventoSelecionado.dataEvento | date: 'dd/MM/yyyy' }}</strong>
          </div>
          <div class="detalhe-item">
            <span>Local</span>
            <strong>{{ eventoSelecionado.local || 'Nao informado' }}</strong>
          </div>
          <div class="detalhe-item">
            <span>Status</span>
            <strong>{{ formatarStatus(eventoSelecionado.status) }}</strong>
          </div>
          <div class="detalhe-item">
            <span>Total de fotos</span>
            <strong>{{ totalFotos(eventoSelecionado) }}</strong>
          </div>
        </div>

        <div class="detalhe-tags" *ngIf="obterTags(eventoSelecionado.tags).length">
          <span class="chip" *ngFor="let tag of obterTags(eventoSelecionado.tags)">{{ tag }}</span>
        </div>
      </div>

      <div class="galeria">
        <div class="galeria__header">
          <div>
            <h3>Galeria de fotos</h3>
            <p>Edite legendas, creditos e tags diretamente nos cards.</p>
          </div>
          <button type="button" class="btn-primary" (click)="abrirUploadFotos()">Adicionar fotos</button>
        </div>

        <div *ngIf="detalheLoading" class="skeleton-grid">
          <div class="skeleton-card" *ngFor="let item of [1,2,3,4]"></div>
        </div>

        <div class="galeria__grid" *ngIf="!detalheLoading && fotosEvento.length">
          <article class="galeria__item" *ngFor="let foto of fotosEvento">
            <button type="button" class="galeria__thumb" (click)="abrirLightbox(foto)">
              <img *ngIf="foto.arquivoUrl" [src]="foto.arquivoUrl" alt="Foto do evento" />
            </button>
            <div class="galeria__meta">
              <p class="galeria__legenda">{{ foto.legenda || 'Sem legenda' }}</p>
              <p class="galeria__creditos" *ngIf="foto.creditos">{{ foto.creditos }}</p>
              <div class="galeria__tags" *ngIf="obterTags(foto.tags).length">
                <span class="chip" *ngFor="let tag of obterTags(foto.tags)">{{ tag }}</span>
              </div>
            </div>
            <div class="galeria__actions">
              <button type="button" class="btn-ghost" (click)="abrirEdicaoFoto(foto)">Editar</button>
              <button type="button" class="btn-ghost" (click)="definirFotoPrincipal(foto)">Definir capa</button>
              <button type="button" class="btn-ghost danger" (click)="confirmarExcluirFoto(foto)">Excluir</button>
            </div>
          </article>
        </div>

        <div class="empty-state" *ngIf="!detalheLoading && !fotosEvento.length">
          <div>
            <h3>Galeria vazia</h3>
            <p>Adicione fotos para registrar os melhores momentos do evento.</p>
          </div>
          <button type="button" class="btn-primary" (click)="abrirUploadFotos()">Adicionar fotos</button>
        </div>
      </div>
    </section>
  </section>
</app-tela-padrao>

<div class="modal" *ngIf="formularioAberto">
  <div class="modal__backdrop" (click)="fecharFormulario()"></div>
  <div class="modal__content">
    <div class="modal__header">
      <div>
        <p class="modal__eyebrow">{{ eventoEmEdicaoId ? 'Editar evento' : 'Novo evento' }}</p>
        <h3>Cadastro de evento</h3>
      </div>
      <button type="button" class="btn-ghost" (click)="fecharFormulario()" aria-label="Fechar">x</button>
    </div>
    <form [formGroup]="eventoForm" class="form">
      <label class="field">
        Titulo *
        <input formControlName="titulo" placeholder="Informe o titulo" (blur)="capitalizarCampo('titulo')" />
        <span class="hint" *ngIf="eventoForm.get('titulo')?.touched && eventoForm.get('titulo')?.invalid">
          Informe o titulo do evento.
        </span>
      </label>
      <label class="field">
        Data do evento *
        <input type="date" formControlName="dataEvento" />
      </label>
      <label class="field">
        Local
        <input formControlName="local" placeholder="Ex.: Sala de eventos" (blur)="capitalizarCampo('local')" />
      </label>
      <label class="field">
        Status
        <select formControlName="status">
          <option *ngFor="let status of statusOpcoes" [value]="status.valor">{{ status.label }}</option>
        </select>
      </label>
      <label class="field">
        Tags
        <input formControlName="tags" placeholder="Separadas por virgula" />
      </label>
      <label class="field">
        Unidade
        <select formControlName="unidadeId">
          <option value="">Selecione</option>
          <option *ngFor="let unidade of unidades" [value]="unidade.id">{{ unidade.nomeFantasia }}</option>
        </select>
      </label>
      <label class="field full">
        Descricao
        <textarea formControlName="descricao" rows="3"></textarea>
      </label>
      <div class="field full">
        <p class="field-title">Foto principal *</p>
        <div class="foto-principal">
          <div class="foto-principal__preview">
            <img *ngIf="uploadPrincipalPreview" [src]="uploadPrincipalPreview" alt="Foto principal" />
            <span *ngIf="!uploadPrincipalPreview">Selecione uma foto principal</span>
          </div>
          <label class="upload-btn">
            Selecionar foto
            <input type="file" accept="image/png, image/jpeg, image/webp" (change)="onFotoPrincipalSelecionada($event)" />
          </label>
        </div>
      </div>
    </form>
    <div class="modal__actions">
      <button type="button" class="btn-outline" (click)="fecharFormulario()">Cancelar</button>
      <button type="button" class="btn-primary" (click)="salvarEvento()" [disabled]="salvandoEvento">
        {{ salvandoEvento ? 'Salvando...' : 'Salvar' }}
      </button>
    </div>
  </div>
</div>

<div class="modal" *ngIf="galeriaUploadAberta">
  <div class="modal__backdrop" (click)="fecharUploadFotos()"></div>
  <div class="modal__content modal__content--wide">
    <div class="modal__header">
      <div>
        <p class="modal__eyebrow">Galeria do evento</p>
        <h3>Adicionar fotos</h3>
      </div>
      <button type="button" class="btn-ghost" (click)="fecharUploadFotos()" aria-label="Fechar">x</button>
    </div>
    <div class="upload-panel">
      <label class="upload-btn">
        Selecionar fotos
        <input type="file" accept="image/png, image/jpeg, image/webp" multiple (change)="onFotosSelecionadas($event)" />
      </label>
      <div class="upload-grid" *ngIf="fotosUpload.length; else uploadVazio">
        <div class="upload-card" *ngFor="let foto of fotosUpload; index as i">
          <img [src]="foto.preview" alt="Preview da foto" />
          <label class="field">
            Legenda
            <input [(ngModel)]="foto.legenda" name="legenda-{{ i }}" />
          </label>
          <label class="field">
            Creditos
            <input [(ngModel)]="foto.creditos" name="creditos-{{ i }}" />
          </label>
          <label class="field">
            Tags
            <input [(ngModel)]="foto.tags" name="tags-{{ i }}" placeholder="Separadas por virgula" />
          </label>
          <label class="field">
            Ordem
            <input type="number" [(ngModel)]="foto.ordem" name="ordem-{{ i }}" />
          </label>
          <button type="button" class="btn-ghost danger" (click)="removerFotoUpload(i)">Remover</button>
        </div>
      </div>
      <ng-template #uploadVazio>
        <p class="muted">Selecione fotos para montar a galeria.</p>
      </ng-template>
    </div>
    <div class="modal__actions">
      <button type="button" class="btn-outline" (click)="fecharUploadFotos()">Cancelar</button>
      <button type="button" class="btn-primary" (click)="enviarFotos()" [disabled]="enviandoFotos">
        {{ enviandoFotos ? 'Enviando...' : 'Salvar fotos' }}
      </button>
    </div>
  </div>
</div>

<div class="modal" *ngIf="editarFotoAberto">
  <div class="modal__backdrop" (click)="fecharEdicaoFoto()"></div>
  <div class="modal__content">
    <div class="modal__header">
      <div>
        <p class="modal__eyebrow">Editar foto</p>
        <h3>Legenda e metadados</h3>
      </div>
      <button type="button" class="btn-ghost" (click)="fecharEdicaoFoto()" aria-label="Fechar">x</button>
    </div>
    <form [formGroup]="fotoForm" class="form">
      <label class="field">
        Legenda
        <input formControlName="legenda" />
      </label>
      <label class="field">
        Creditos
        <input formControlName="creditos" />
      </label>
      <label class="field">
        Tags
        <input formControlName="tags" />
      </label>
      <label class="field">
        Ordem
        <input type="number" formControlName="ordem" />
      </label>
    </form>
    <div class="modal__actions">
      <button type="button" class="btn-outline" (click)="fecharEdicaoFoto()">Cancelar</button>
      <button type="button" class="btn-primary" (click)="salvarEdicaoFoto()">Salvar</button>
    </div>
  </div>
</div>

<div class="modal" *ngIf="lightboxAberto">
  <div class="modal__backdrop" (click)="fecharLightbox()"></div>
  <div class="lightbox">
    <button type="button" class="lightbox__close" (click)="fecharLightbox()">x</button>
    <img *ngIf="lightboxUrl" [src]="lightboxUrl" alt="Foto em destaque" />
    <p *ngIf="lightboxLegenda" class="lightbox__caption">{{ lightboxLegenda }}</p>
  </div>
</div>

<app-dialog
  [aberto]="confirmarExclusaoAberta"
  [titulo]="'Confirmar exclusao'"
  [mensagem]="confirmarExclusaoMensagem"
  [confirmarLabel]="'Excluir'"
  [cancelarLabel]="'Cancelar'"
  (confirmar)="executarExcluir()"
  (cancelar)="cancelarExcluir()"
></app-dialog>


