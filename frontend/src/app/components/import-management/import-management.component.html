<app-tela-padrao>
<header class="page-title" slot="titulo">
    <p class="page-title__eyebrow">Configurações gerais</p>
    <div class="page-title__stack">
      <p class="page-title__label">Importação de dados</p>
      <p class="page-title__description">
        Centralize a entrada de dados dos cadastros críticos. Os campos mapeados serão preenchidos
        automaticamente e os campos sem informação permanecerão em branco.
      </p>
    </div>
  </header>

  <section class="import-shell">
  <div class="quick-grid">
    <div class="card kpi" *ngFor="let target of targets">
      <div class="kpi__icon" [ngClass]="{ 'kpi__icon--green': target.id === 'beneficiarios', 'kpi__icon--accent': target.id === 'almoxarifado' }">
        <fa-icon
          [icon]="target.id === 'beneficiarios' ? faUserPlus : target.id === 'patrimonio' ? faClipboardList : faWarehouse"
        ></fa-icon>
      </div>
      <div>
        <p class="kpi__label">{{ target.label }}</p>
        <p class="kpi__value">{{ target.fields.length }} campos mapeáveis</p>
        <p class="kpi__hint">{{ target.description }}</p>
      </div>
      <span class="pill pill--outline" *ngIf="lastAppliedEntity === target.id">Última importação</span>
    </div>
  </div>

  <div class="grid gap-4 lg:grid-cols-3">
    <div class="card lg:col-span-2 space-y-4">
      <div class="card__header-row">
        <div>
          <p class="card__eyebrow">
            <fa-icon [icon]="faFileImport"></fa-icon>
            Selecione o alvo e o arquivo
          </p>
          <p class="muted">Ajuste o mapeamento para preencher as telas de cadastro.</p>
        </div>
        <div class="pill pill--outline" *ngIf="selectedFileName">
          <fa-icon [icon]="faFileArrowDown" class="mr-2"></fa-icon>
          {{ selectedFileName }}
        </div>
      </div>

      <form [formGroup]="importForm" class="grid gap-3 md:grid-cols-2">
        <label class="field">
          <span>Importar para</span>
          <select class="input" formControlName="entity">
            <option value="beneficiarios">Cadastro de beneficiário</option>
            <option value="patrimonio">Cadastro de patrimônio</option>
            <option value="almoxarifado">Cadastro de almoxarifado</option>
          </select>
        </label>

        <div class="field">
          <span>Arquivo (.csv ou .txt)</span>
          <label class="upload">
            <input type="file" accept=".csv,.txt" (change)="onFileSelected($event)" />
            <fa-icon [icon]="faCloudArrowUp"></fa-icon>
            <div>
              <p class="font-semibold text-slate-800">Escolher arquivo</p>
              <p class="muted">{{ selectedFileName || 'Nenhum arquivo selecionado' }}</p>
            </div>
          </label>
        </div>

        <div class="toggle-list md:col-span-2">
          <label class="toggle">
            <input type="checkbox" [checked]="true" [disabled]="true" />
            <span>Campos não mapeados permanecerão em branco</span>
          </label>
          <label class="toggle">
            <input type="checkbox" formControlName="applyUppercase" />
            <span>Aplicar caixa alta aos textos importados</span>
          </label>
        </div>
      </form>

      <div class="flex flex-wrap gap-3">
        <button type="button" class="btn-primary" (click)="applyImport()">
          <fa-icon [icon]="faCheckCircle" class="mr-2"></fa-icon>
          Aplicar importação
        </button>
        <button type="button" class="btn-outline" (click)="useSampleData()">
          <fa-icon [icon]="faPlug" class="mr-2"></fa-icon>
          Carregar exemplo rápido
        </button>
        <span
          *ngIf="importFeedback"
          class="text-sm font-medium px-3 py-2 rounded-lg bg-emerald-50 text-emerald-800 border border-emerald-200"
        >
          {{ importFeedback }}
        </span>
      </div>
    </div>

    <div class="card space-y-3">
      <div class="card__header-row">
        <div>
          <p class="card__eyebrow">
            <fa-icon [icon]="faDatabase"></fa-icon>
            Status do arquivo
          </p>
          <p class="muted">Detectamos cabeçalhos e geramos um mapeamento inicial.</p>
        </div>
        <span class="pill" *ngIf="hasParsedData; else waiting">
          <fa-icon [icon]="faCheckCircle" class="mr-1"></fa-icon>
          Pronto
        </span>
        <ng-template #waiting>
          <span class="pill pill--outline">
            <fa-icon [icon]="faCircleNotch" class="spin mr-1"></fa-icon>
            Aguardando arquivo
          </span>
        </ng-template>
      </div>

      <div class="status-list">
        <div class="status-item" *ngFor="let header of parsedHeaders | slice:0:4">
          <div class="status-dot status-dot--success"></div>
          <div>
            <p class="font-semibold text-slate-800">{{ header }}</p>
            <p class="muted">Exemplo: {{ parsedRows[0]?.[header] || '—' }}</p>
          </div>
        </div>
        <p class="muted" *ngIf="!parsedHeaders.length">
          Nenhum arquivo carregado ainda. Use "Carregar exemplo" para testar o fluxo.
        </p>
      </div>
    </div>
  </div>

  <div class="grid gap-4 lg:grid-cols-3">
    <div class="card lg:col-span-2 space-y-3">
      <div class="card__header-row">
        <div>
          <p class="card__eyebrow">
            <fa-icon [icon]="faClipboardList"></fa-icon>
            Mapeie as colunas para os campos
          </p>
          <p class="muted">Tudo que não tiver coluna ficará em branco no cadastro.</p>
        </div>
        <span class="pill pill--outline">{{ activeTarget.label }}</span>
      </div>

      <form *ngIf="mappingForm" [formGroup]="mappingForm" class="mapping-grid">
        <div class="mapping-row mapping-row--header">
          <span>Campo do cadastro</span>
          <span>Coluna do arquivo</span>
          <span>Prévia do dado</span>
        </div>

        <div class="mapping-row" *ngFor="let field of activeTarget.fields">
          <div>
            <p class="font-semibold text-slate-800">{{ field.label }}</p>
            <p class="muted">{{ field.description || 'Campo opcional' }}</p>
          </div>

          <label class="field">
            <select class="input" [formControlName]="field.key">
              <option value="">Deixar em branco</option>
              <option *ngFor="let header of parsedHeaders" [value]="header">
                {{ header }}
              </option>
            </select>
          </label>

          <div class="preview-cell">
            <p class="font-semibold text-slate-800">
              {{
                parsedRows[0]?.[mappingForm.get(field.key)?.value || ''] ||
                '—'
              }}
            </p>
            <p class="muted">Prévia da primeira linha</p>
          </div>
        </div>
      </form>

      <div *ngIf="!mappingForm" class="muted">
        Carregue um arquivo ou amostra para liberar o mapeamento.
      </div>
    </div>

    <div class="card space-y-3">
      <div class="card__header-row">
        <div>
          <p class="card__eyebrow">
            <fa-icon [icon]="faBoxOpen"></fa-icon>
            Pré-visualização do preenchimento
          </p>
          <p class="muted">Confira como os dados serão distribuídos nos campos.</p>
        </div>
        <span class="pill">Até 5 linhas</span>
      </div>

      <div class="preview-table" *ngIf="mappedPreview.length; else emptyPreview">
        <div class="preview-table__row preview-table__row--header">
          <span>Campo</span>
          <span>Valor importado</span>
        </div>

        <div *ngFor="let row of mappedPreview; let idx = index" class="preview-table__group">
          <p class="preview-table__title">Linha {{ idx + 1 }}</p>
          <div class="preview-table__row" *ngFor="let field of activeTarget.fields">
            <span class="font-semibold text-slate-800">{{ field.label }}</span>
            <span class="muted">{{ row[field.key] || '—' }}</span>
          </div>
        </div>
      </div>

      <ng-template #emptyPreview>
        <p class="muted">Ainda não há pré-visualização. Carregue um arquivo e clique em "Aplicar importação".</p>
      </ng-template>
    </div>
  </div>

  <div class="card mt-4 space-y-3">
    <div class="card__header-row">
      <div>
        <p class="card__eyebrow">
          <fa-icon [icon]="faWarehouse"></fa-icon>
          Orientações rápidas
        </p>
        <p class="muted">Boas práticas para importar beneficiários, patrimônio e almoxarifado.</p>
      </div>
      <span class="pill pill--outline">Checklist</span>
    </div>

    <ul class="guidelines">
      <li>
        Use arquivos com cabeçalho. Caso um campo não exista no arquivo, deixe o mapeamento vazio para
        manter o valor em branco no cadastro.
      </li>
      <li>
        Beneficiários: priorize nome, CPF e telefone para agilizar a conferência manual na tela de cadastro.
      </li>
      <li>
        Patrimônio: mantenha o número de tombo e data de aquisição para organizar o histórico e rastreabilidade.
      </li>
      <li>
        Almoxarifado: inclua unidade, lote e validade quando disponíveis. Na ausência, o sistema não preencherá
        esses campos.
      </li>
    </ul>
  </div>
</section>
</app-tela-padrao>

