<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  (salvar)="submit()"
  (excluir)="editingId && delete(editingId)"
  (novo)="startNew()"
  (cancelar)="resetForm()"
  (imprimir)="printCurrent()"
  (buscar)="onBuscar()"
  (fechar)="closeForm()"
>
  <app-popup-messages [mensagens]="popupErros" [titulo]="popupTitulo" (fechar)="fecharPopupErros()"></app-popup-messages>
<header class="page-title" slot="titulo">
    <p class="page-title__eyebrow">Administrativo</p>
    <p class="page-title__label">Oficios e Documentos</p>

    <p class="page-title__note">Controle de criacao, envio e tramitacao de oficios.</p>
  </header>

  <section class="cadastro">
  <div class="tab-shell">
    <p class="tab-shell__title">Navegue pelas etapas do oficio</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of tabs; index as idx"
        class="step-tabs__item"
        [class.active]="activeTab === tab.id"
        [class.completed]="idx < activeTabIndex"
      >
        <button
          class="step-tabs__button"
          type="button"
          role="tab"
          [attr.aria-selected]="activeTab === tab.id"
          (click)="changeTab(tab.id)"
        >
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ tab.label }}</span>
        </button>
      </li>
    </ol>
  </div>

  <form [formGroup]="form" (ngSubmit)="submit()" class="form-shell">

    <ng-template #navigationControls>
      <div class="tab-actions">
        <button type="button" class="ghost" *ngIf="hasPreviousTab" (click)="goToPreviousTab()">Voltar</button>
        <button type="button" class="primary" *ngIf="hasNextTab" (click)="goToNextTab()">
          Proximo: {{ nextTabLabel }}
        </button>
        <button type="submit" class="primary" [disabled]="saving" *ngIf="!hasNextTab">
          {{ saving ? 'Salvando...' : 'Salvar oficio' }}
        </button>
      </div>
    </ng-template>

    <div class="tab-card" *ngIf="activeTab === 'dashboard'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Resumo geral dos oficios do sistema.</p>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="dashboard-card dashboard-card--primary">
          <p class="dashboard-card__label">Oficios criados</p>
          <p class="dashboard-card__value">{{ quantidadeOficiosCriados }}</p>
          <p class="dashboard-card__hint">Total de registros no periodo atual.</p>
        </div>
        <div class="dashboard-card dashboard-card--info">
          <p class="dashboard-card__label">Oficios recebidos</p>
          <p class="dashboard-card__value">{{ quantidadeOficiosRecebidos }}</p>
          <p class="dashboard-card__hint">Entrada via recebimento.</p>
        </div>
        <div class="dashboard-card dashboard-card--success">
          <p class="dashboard-card__label">Oficios enviados</p>
          <p class="dashboard-card__value">{{ quantidadeOficiosEnviados }}</p>
          <p class="dashboard-card__hint">Fluxo concluido por envio.</p>
        </div>
        <div class="dashboard-card dashboard-card--warning">
          <p class="dashboard-card__label">Em analise</p>
          <p class="dashboard-card__value">{{ quantidadeOficiosEmAnalise }}</p>
          <p class="dashboard-card__hint">Pendentes de avaliacao.</p>
        </div>
        <div class="dashboard-card dashboard-card--neutral">
          <p class="dashboard-card__label">Em preparacao</p>
          <p class="dashboard-card__value">{{ quantidadeOficiosEmPreparacao }}</p>
          <p class="dashboard-card__hint">Em montagem do conteudo.</p>
        </div>
        <div class="dashboard-card dashboard-card--accent">
          <p class="dashboard-card__label">Recebidos (status)</p>
          <p class="dashboard-card__value">{{ quantidadeOficiosRecebidosStatus }}</p>
          <p class="dashboard-card__hint">Confirmados como recebidos.</p>
        </div>
        <div class="dashboard-card dashboard-card--soft">
          <p class="dashboard-card__label">Rascunhos</p>
          <p class="dashboard-card__value">{{ quantidadeOficiosRascunho }}</p>
          <p class="dashboard-card__hint">Aguardando revisao.</p>
        </div>
        <div class="dashboard-card dashboard-card--archived">
          <p class="dashboard-card__label">Arquivados</p>
          <p class="dashboard-card__value">{{ quantidadeOficiosArquivados }}</p>
          <p class="dashboard-card__hint">Finalizados e fechados.</p>
        </div>
        <div class="dashboard-card dashboard-card--primary">
          <p class="dashboard-card__label">Com anexo PDF</p>
          <p class="dashboard-card__value">{{ quantidadeOficiosComAnexo }}</p>
          <p class="dashboard-card__hint">PDF assinado vinculado.</p>
        </div>
        <div class="dashboard-card dashboard-card--info">
          <p class="dashboard-card__label">Protocolo de envio</p>
          <p class="dashboard-card__value">{{ quantidadeComProtocoloEnvio }}</p>
          <p class="dashboard-card__hint">Envios protocolados.</p>
        </div>
        <div class="dashboard-card dashboard-card--info">
          <p class="dashboard-card__label">Protocolo de recebimento</p>
          <p class="dashboard-card__value">{{ quantidadeComProtocoloRecebimento }}</p>
          <p class="dashboard-card__hint">Recebimentos protocolados.</p>
        </div>
        <div class="dashboard-card dashboard-card--warning">
          <p class="dashboard-card__label">Sem protocolo</p>
          <p class="dashboard-card__value">{{ quantidadeSemProtocolo }}</p>
          <p class="dashboard-card__hint">Sem envio ou recebimento registrado.</p>
        </div>
        <div class="dashboard-card dashboard-card--accent">
          <p class="dashboard-card__label">Em atraso</p>
          <p class="dashboard-card__value">{{ quantidadeEmAtraso }}</p>
          <p class="dashboard-card__hint">Prazo de resposta expirado.</p>
        </div>
        <div class="dashboard-card dashboard-card--neutral">
          <p class="dashboard-card__label">Responsavel com mais oficios</p>
          <p class="dashboard-card__value">{{ responsavelComMaisOficios.quantidade }}</p>
          <p class="dashboard-card__hint">{{ responsavelComMaisOficios.nome }}</p>
        </div>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'identificacao'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
        </div>
      </div>

      <div formGroupName="identificacao">
        <div class="field-grid cols-3">
          <label class="field">Tipo de registro*
            <select formControlName="tipo">
              <option value="emissao">Emissao</option>
              <option value="recebimento">Recebimento</option>
            </select>
          </label>
          <label class="field">Numero do oficio*
            <input formControlName="numero" placeholder="Gerado automaticamente" readonly />
          </label>
          <label class="field">Data*
            <input type="date" formControlName="data" />
          </label>
          <label class="field">Setor/Unidade de origem*
            <app-autocomplete
              [opcoes]="unidadeOpcoes"
              [termo]="unidadeTermo"
              placeholder="Selecione a unidade assistencial"
              (termoChange)="onUnidadeTermoChange($event)"
              (selecionar)="selecionarUnidade($event)"
            ></app-autocomplete>
          </label>
          <label class="field">Responsavel pela emissao*
            <input formControlName="responsavel" readonly />
          </label>
          <label class="field">Meio de envio*
            <select formControlName="meioEnvio">
              <option *ngFor="let meio of meiosEnvio" [value]="meio">{{ meio }}</option>
            </select>
          </label>
          <label class="field">Prazo de resposta
            <input formControlName="prazoResposta" placeholder="Ex.: 10 dias" />
          </label>
        </div>
      </div>

      <div class="divider"></div>

      <div formGroupName="protocolo" class="field-grid cols-3">
        <label class="field">Situacao do oficio*
          <select formControlName="status">
            <option *ngFor="let status of statusOptions" [value]="status">{{ status }}</option>
          </select>
        </label>
        <label class="field">Protocolo de envio
          <input formControlName="protocoloEnvio" placeholder="Gerado automaticamente ou informado" />
        </label>
        <label class="field">Data de envio
          <input type="date" formControlName="dataEnvio" />
        </label>
        <label class="field">Protocolo de recebimento
          <input formControlName="protocoloRecebimento" placeholder="Gerado automaticamente ou informado" />
        </label>
        <label class="field">Data de recebimento
          <input type="date" formControlName="dataRecebimento" />
        </label>
        <label class="field">Proximo destino
          <input formControlName="proximoDestino" placeholder="Quem recebera o proximo passo" />
        </label>
        <label class="field full">Observacoes
          <textarea rows="2" formControlName="observacoes" placeholder="Instrucoes de protocolo ou pendencias"></textarea>
        </label>
        <div class="feature-grid">
          <button type="button" class="nav-button" (click)="registrarEnvio()">Registrar envio</button>
          <button type="button" class="nav-button" (click)="registrarRecebimento()">Registrar recebimento</button>
        </div>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'conteudo'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Estruture o texto conforme o modelo institucional apresentado.</p>
        </div>
        <span class="pill">Layout do oficio</span>
      </div>

      <div formGroupName="conteudo" class="field-grid cols-2">
        <div class="field-row full" *ngIf="!editingId">
          <label class="field">Buscar oficio
            <input
              [(ngModel)]="termoBuscarOficio"
              [ngModelOptions]="{ standalone: true }"
              placeholder="Ex.: 0001/2026"
            />
          </label>
          <button type="button" class="nav-button" (click)="buscarOficioParaReaproveitar()">
            Buscar oficio
          </button>
        </div>
        <label class="field full">Empresa/Orgao/Instituicao
          <input formControlName="razaoSocial" placeholder="Titulo com razao social" />
        </label>
        <div class="field-row">
        <label class="field small">Saudacao
          <select formControlName="saudacao">
            <option value="">Selecione</option>
            <option *ngFor="let saudacao of saudacoes" [value]="saudacao">{{ saudacao }}</option>
          </select>
        </label>
        <label class="field small">Para
          <input formControlName="para" />
        </label>
        <label class="field small">Cargo
          <input formControlName="cargoPara" />
        </label>
      </div>
        <label class="field full">Assunto*
          <input formControlName="assunto" placeholder="Assunto em destaque" />
        </label>
        <label class="field full">Corpo do oficio*
          <textarea rows="6" formControlName="corpo" placeholder="Texto principal escrito pelo usuario"></textarea>
        </label>
        <label class="field full">Finalizacao
          <textarea rows="2" formControlName="finalizacao" placeholder="Agradecimento e consideracoes finais"></textarea>
        </label>
        <label class="field">Assinatura - Nome
          <input formControlName="assinaturaNome" readonly />
        </label>
        <label class="field">Assinatura - Cargo
          <select formControlName="assinaturaCargo" *ngIf="responsavelCargos.length > 0; else cargoManual">
            <option *ngFor="let cargo of responsavelCargos" [value]="cargo">{{ cargo }}</option>
          </select>
          <ng-template #cargoManual>
            <input formControlName="assinaturaCargo" />
          </ng-template>
        </label>
        <div class="field full imagem-anexo-bloco">
          <div class="imagem-anexo-header">
            <span>Imagens anexo</span>
            <label class="nav-button imagem-anexo-botao">
              Adicionar imagens
              <input
                type="file"
                accept="image/png,image/jpeg"
                multiple
                (change)="onImagensSelecionadas($event)"
              />
            </label>
          </div>
          <div class="imagem-anexo-lista" *ngIf="imagensAnexo.length > 0; else semImagens">
            <div class="imagem-anexo-item" *ngFor="let imagem of imagensAnexo">
              <img [src]="obterImagemPreview(imagem)" [alt]="imagem.nomeArquivo" />
              <div class="imagem-anexo-info">
                <span>{{ imagem.nomeArquivo }}</span>
                <button type="button" class="ghost" (click)="removerImagemAnexo(imagem)">
                  Remover
                </button>
              </div>
            </div>
          </div>
          <ng-template #semImagens>
            <p class="muted">Nenhuma imagem anexada.</p>
          </ng-template>
        </div>
        <label class="field full">Rodape com dados da instituicao
          <textarea rows="2" formControlName="rodape" placeholder="Endereco, CNPJ, contatos e site"></textarea>
        </label>
      </div>

      <div class="actions">
        <button type="button" class="primary" (click)="imprimirRascunho()">Visualizar modelo</button>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'tramitacao'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Controle a trilha do oficio: onde esta, quem assinou e qual o proximo passo.</p>
        </div>
      </div>

      <div class="field-grid cols-3" formGroupName="tramitacao">
        <label class="field">Data do registro
          <input type="date" formControlName="data" />
        </label>
        <label class="field">Origem
          <input formControlName="origem" placeholder="De onde vem esta etapa" />
        </label>
        <label class="field">Destino
          <input formControlName="destino" placeholder="Para onde segue" />
        </label>
        <label class="field">Responsavel
          <input formControlName="responsavel" placeholder="Quem movimentou" />
        </label>
        <label class="field full">Acao realizada*
          <input formControlName="acao" placeholder="Envio, Analise, Assinatura, Devolucao..." />
        </label>
        <label class="field full">Observacoes
          <textarea rows="2" formControlName="observacoes" placeholder="Pendencias, documentos anexos ou prazos"></textarea>
        </label>
      </div>

      <div class="actions">
        <button type="button" class="primary" (click)="addTramite()">Adicionar etapa de tramitacao</button>
      </div>

      <div class="timeline" *ngIf="tramites.length > 0">
        <div class="timeline__header">
          <div>
            <p class="page-title__eyebrow">Historico de tramitacao</p>
            <p class="page-title__label">Controle de onde parou e para onde vai</p>
          </div>
        </div>
        <ol class="timeline__list">
          <li *ngFor="let tramite of tramites">
            <div class="timeline__bullet"></div>
            <div class="timeline__content">
              <p class="timeline__title">{{ tramite.acao }}</p>
              <p class="muted">{{ tramite.data | date: 'dd/MM/yyyy' }} • {{ tramite.origem || 'Origem nao informada' }} ? {{ tramite.destino || 'Destino nao informado' }}</p>
              <p class="muted">Responsavel: {{ tramite.responsavel || 'Sem responsavel' }}</p>
              <p class="muted" *ngIf="tramite.observacoes">Notas: {{ tramite.observacoes }}</p>
            </div>
          </li>
        </ol>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'listagem'">
      <div class="list-card">
        <div class="list-card__header">
          <div>
            <p class="page-title__eyebrow">Oficios registrados</p>
            <p class="page-title__label">Acompanhe a situacao, destinatario e responsavel</p>
          </div>
        </div>
        <div class="field-row full field-row--filtro">
          <label class="field field--buscar">Buscar por
            <select [(ngModel)]="filtroOficioCampo" [ngModelOptions]="{ standalone: true }">
              <option value="numero">Numero</option>
              <option value="assunto">Assunto</option>
              <option value="resp">Resp</option>
              <option value="para">Para</option>
              <option value="data">Data</option>
            </select>
          </label>
          <label class="field field--valor">Valor
            <input [(ngModel)]="filtroOficioTermo" [ngModelOptions]="{ standalone: true }" placeholder="Digite para filtrar" />
          </label>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Status</th>
                <th>N°</th>
                <th>Assunto</th>
                <th>Para</th>
                <th>Resp</th>
                <th class="col-anexo">Anexo</th>
                <th>Acoes</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let oficio of oficiosFiltrados">
                <td>
                  <span class="status-pill" [ngClass]="obterClasseStatus(oficio.protocolo.status)">
                    {{ oficio.protocolo.status }}
                  </span>
                </td>
                <td>{{ oficio.identificacao.numero }}</td>
                <td>{{ oficio.conteudo.assunto }}</td>
                <td>{{ oficio.conteudo.razaoSocial || '-' }}</td>
                <td>{{ oficio.conteudo.para || '-' }}</td>
                <td class="col-anexo">
                  <button
                    type="button"
                    class="anexo-botao"
                    *ngIf="oficio.pdfAssinadoUrl"
                    title="Imprimir anexo"
                    (click)="abrirPopupAnexo(oficio)"
                  >
                    <svg class="anexo-icone" viewBox="0 0 24 24" aria-hidden="true">
                      <path
                        d="M7.5 12.5l6.8-6.8a3 3 0 014.2 4.2L9.3 19.1a4.5 4.5 0 01-6.4-6.4l8.6-8.6a1 1 0 111.4 1.4l-8.6 8.6a2.5 2.5 0 103.6 3.6l9.2-9.2a1 1 0 10-1.4-1.4l-6.8 6.8a1 1 0 11-1.4-1.4z"
                        fill="currentColor"
                      />
                    </svg>
                  </button>
                  <span class="anexo-sem" *ngIf="!oficio.pdfAssinadoUrl">X</span>
                </td>
                <td>
                  <div class="table-actions">
                    <div class="table-actions__row">
                      <button type="button" class="ghost" (click)="imprimirModelo(oficio)">Imprimir</button>
                      <label class="ghost file-label">
                        Anexo
                        <input
                          type="file"
                          accept="application/pdf"
                          (change)="onPdfAssinadoSelecionado($event, oficio)"
                        />
                      </label>
                    </div>
                    <div class="table-actions__row">
                      <button type="button" class="ghost" (click)="delete(oficio.id)">Excluir</button>
                      <button type="button" class="ghost" (click)="edit(oficio)">Editar</button>
                    </div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </form>
  <div class="print-dialog" *ngIf="popupAnexoAberto">
    <div class="print-dialog__backdrop" (click)="fecharPopupAnexo()"></div>
    <div
      class="print-dialog__card"
      role="dialog"
      aria-modal="true"
      aria-label="Opcoes de anexo"
    >
      <div class="print-dialog__header">
        <p class="print-dialog__title">Anexo do oficio</p>
        <p class="print-dialog__subtitle">Escolha a acao desejada.</p>
      </div>
      <div class="print-dialog__actions">
        <button type="button" class="btn-primary" (click)="visualizarAnexo()">
          Visualizar
        </button>
        <button type="button" class="btn-outline" (click)="imprimirAnexo()">
          Imprimir
        </button>
      </div>
    </div>
  </div>
</section>
</app-tela-padrao>






