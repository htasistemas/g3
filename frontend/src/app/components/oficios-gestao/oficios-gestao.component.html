<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  (salvar)="submit()"
  (excluir)="editingId && delete(editingId)"
  (novo)="startNew()"
  (cancelar)="resetForm()"
  (imprimir)="printCurrent()"
  (buscar)="onBuscar()"
  (fechar)="closeForm()"
>
  <app-popup-messages [mensagens]="popupErros" [titulo]="popupTitulo" (fechar)="fecharPopupErros()"></app-popup-messages>
<header class="page-title" slot="titulo">
    <p class="page-title__eyebrow">Administrativo • Oficios</p>
    <p class="page-title__label">Gestao de criacao, envio, recebimento e tramitacao</p>

    <p class="page-title__note">Controle de criacao, envio e tramitacao de oficios.</p>
  </header>

  <section class="cadastro">
  <div class="tab-shell">
    <p class="tab-shell__title">Navegue pelas etapas do oficio</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of tabs; index as idx"
        class="step-tabs__item"
        [class.active]="activeTab === tab.id"
        [class.completed]="idx < activeTabIndex"
      >
        <button
          class="step-tabs__button"
          type="button"
          role="tab"
          [attr.aria-selected]="activeTab === tab.id"
          (click)="changeTab(tab.id)"
        >
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ tab.label }}</span>
        </button>
      </li>
    </ol>
  </div>

  <form [formGroup]="form" (ngSubmit)="submit()" class="form-shell">

    <ng-template #navigationControls>
      <div class="tab-actions">
        <button type="button" class="ghost" *ngIf="hasPreviousTab" (click)="goToPreviousTab()">Voltar</button>
        <button type="button" class="primary" *ngIf="hasNextTab" (click)="goToNextTab()">
          Proximo: {{ nextTabLabel }}
        </button>
        <button type="submit" class="primary" [disabled]="saving" *ngIf="!hasNextTab">
          {{ saving ? 'Salvando...' : 'Salvar oficio' }}
        </button>
      </div>
    </ng-template>

    <div class="tab-card" *ngIf="activeTab === 'identificacao'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
        </div>
      </div>

      <div formGroupName="identificacao">
        <div class="field-grid cols-3">
          <label class="field">Tipo de registro*
            <select formControlName="tipo">
              <option value="emissao">Emissao</option>
              <option value="recebimento">Recebimento</option>
            </select>
          </label>
          <label class="field">Numero do oficio*
            <input formControlName="numero" placeholder="Ex.: 013/2025" />
          </label>
          <label class="field">Data*
            <input type="date" formControlName="data" />
          </label>
          <label class="field">Setor/Unidade de origem*
            <input formControlName="setorOrigem" />
          </label>
          <label class="field">Responsavel pela emissao*
            <input formControlName="responsavel" />
          </label>
          <label class="field">Destinatario*
            <input formControlName="destinatario" />
          </label>
          <label class="field">Meio de envio*
            <select formControlName="meioEnvio">
              <option *ngFor="let meio of meiosEnvio" [value]="meio">{{ meio }}</option>
            </select>
          </label>
          <label class="field">Prazo de resposta
            <input formControlName="prazoResposta" placeholder="Ex.: 10 dias" />
          </label>
          <label class="field">Classificacao
            <input formControlName="classificacao" placeholder="Solicitacao, Resposta, Circular..." />
          </label>
        </div>
      </div>

      <div class="divider"></div>

      <div formGroupName="protocolo" class="field-grid cols-3">
        <label class="field">Situacao do oficio*
          <select formControlName="status">
            <option *ngFor="let status of statusOptions" [value]="status">{{ status }}</option>
          </select>
        </label>
        <label class="field">Protocolo de envio
          <input formControlName="protocoloEnvio" placeholder="Gerado automaticamente ou informado" />
        </label>
        <label class="field">Data de envio
          <input type="date" formControlName="dataEnvio" />
        </label>
        <label class="field">Protocolo de recebimento
          <input formControlName="protocoloRecebimento" placeholder="Gerado automaticamente ou informado" />
        </label>
        <label class="field">Data de recebimento
          <input type="date" formControlName="dataRecebimento" />
        </label>
        <label class="field">Proximo destino
          <input formControlName="proximoDestino" placeholder="Quem recebera o proximo passo" />
        </label>
        <label class="field full">Observacoes
          <textarea rows="2" formControlName="observacoes" placeholder="Instrucoes de protocolo ou pendencias"></textarea>
        </label>
        <div class="feature-grid">
          <button type="button" class="primary" (click)="registrarEnvio()">Registrar envio</button>
          <button type="button" class="ghost" (click)="registrarRecebimento()">Registrar recebimento</button>
        </div>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'conteudo'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Estruture o texto conforme o modelo institucional apresentado.</p>
        </div>
        <span class="pill">Layout do oficio</span>
      </div>

      <div formGroupName="conteudo" class="field-grid cols-2">
        <label class="field">Razao social com logomarca*
          <input formControlName="razaoSocial" placeholder="Titulo com razao social" />
        </label>
        <label class="field">URL da logomarca (opcional)
          <input formControlName="logoUrl" placeholder="Cole o endereco da imagem da logomarca" />
        </label>
        <label class="field">Titulo do documento
          <input formControlName="titulo" placeholder="OFICIO ..." />
        </label>
        <label class="field">Saudacao
          <input formControlName="saudacao" placeholder="Prezado(a)," />
        </label>
        <label class="field full">Assunto*
          <input formControlName="assunto" placeholder="Assunto em destaque" />
        </label>
        <label class="field full">Corpo do oficio*
          <textarea rows="6" formControlName="corpo" placeholder="Texto principal escrito pelo usuario"></textarea>
        </label>
        <label class="field full">Finalizacao
          <textarea rows="2" formControlName="finalizacao" placeholder="Agradecimento e consideracoes finais"></textarea>
        </label>
        <label class="field">Assinatura - Nome
          <input formControlName="assinaturaNome" />
        </label>
        <label class="field">Assinatura - Cargo
          <input formControlName="assinaturaCargo" />
        </label>
        <label class="field full">Rodape com dados da instituicao
          <textarea rows="2" formControlName="rodape" placeholder="Endereco, CNPJ, contatos e site"></textarea>
        </label>
      </div>

      <div class="actions">
        <button type="button" class="primary" (click)="imprimirRascunho()">Visualizar modelo</button>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'tramitacao'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Controle a trilha do oficio: onde esta, quem assinou e qual o proximo passo.</p>
        </div>
      </div>

      <div class="field-grid cols-3" formGroupName="tramitacao">
        <label class="field">Data do registro
          <input type="date" formControlName="data" />
        </label>
        <label class="field">Origem
          <input formControlName="origem" placeholder="De onde vem esta etapa" />
        </label>
        <label class="field">Destino
          <input formControlName="destino" placeholder="Para onde segue" />
        </label>
        <label class="field">Responsavel
          <input formControlName="responsavel" placeholder="Quem movimentou" />
        </label>
        <label class="field full">Acao realizada*
          <input formControlName="acao" placeholder="Envio, Analise, Assinatura, Devolucao..." />
        </label>
        <label class="field full">Observacoes
          <textarea rows="2" formControlName="observacoes" placeholder="Pendencias, documentos anexos ou prazos"></textarea>
        </label>
      </div>

      <div class="actions">
        <button type="button" class="primary" (click)="addTramite()">Adicionar etapa de tramitacao</button>
      </div>

      <div class="timeline" *ngIf="tramites.length > 0">
        <div class="timeline__header">
          <div>
            <p class="page-title__eyebrow">Historico de tramitacao</p>
            <p class="page-title__label">Controle de onde parou e para onde vai</p>
          </div>
        </div>
        <ol class="timeline__list">
          <li *ngFor="let tramite of tramites">
            <div class="timeline__bullet"></div>
            <div class="timeline__content">
              <p class="timeline__title">{{ tramite.acao }}</p>
              <p class="muted">{{ tramite.data | date: 'dd/MM/yyyy' }} • {{ tramite.origem || 'Origem nao informada' }} ? {{ tramite.destino || 'Destino nao informado' }}</p>
              <p class="muted">Responsavel: {{ tramite.responsavel || 'Sem responsavel' }}</p>
              <p class="muted" *ngIf="tramite.observacoes">Notas: {{ tramite.observacoes }}</p>
            </div>
          </li>
        </ol>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'confirmacao'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Revise os dados, confirme protocolos e gere o documento.</p>
        </div>
      </div>

      <div class="field-grid cols-2">
        <div class="summary-card">
          <p class="summary-card__title">Dados principais</p>
          <ul>
            <li><strong>N° do oficio:</strong> {{ form.value.identificacao?.numero || '-' }}</li>
            <li><strong>Origem:</strong> {{ form.value.identificacao?.setorOrigem }}</li>
            <li><strong>Destinatario:</strong> {{ form.value.identificacao?.destinatario }}</li>
            <li><strong>Meio:</strong> {{ form.value.identificacao?.meioEnvio }}</li>
            <li><strong>Status:</strong> {{ form.value.protocolo?.status }}</li>
          </ul>
        </div>
        <div class="summary-card">
          <p class="summary-card__title">Protocolos</p>
          <ul>
            <li><strong>Envio:</strong> {{ form.value.protocolo?.protocoloEnvio || '-' }} {{ form.value.protocolo?.dataEnvio ? '(' + (form.value.protocolo?.dataEnvio | date:'dd/MM/yyyy') + ')' : '' }}</li>
            <li><strong>Recebimento:</strong> {{ form.value.protocolo?.protocoloRecebimento || '-' }} {{ form.value.protocolo?.dataRecebimento ? '(' + (form.value.protocolo?.dataRecebimento | date:'dd/MM/yyyy') + ')' : '' }}</li>
            <li><strong>Proximo destino:</strong> {{ form.value.protocolo?.proximoDestino || '-' }}</li>
            <li><strong>Observacoes:</strong> {{ form.value.protocolo?.observacoes || 'Sem observacoes' }}</li>
          </ul>
        </div>
        <div class="summary-card full">
          <p class="summary-card__title">Conteudo</p>
          <p><strong>Assunto:</strong> {{ form.value.conteudo?.assunto }}</p>
          <p><strong>Corpo:</strong> {{ form.value.conteudo?.corpo }}</p>
          <p><strong>Finalizacao:</strong> {{ form.value.conteudo?.finalizacao }}</p>
          <p><strong>Assinatura:</strong> {{ form.value.conteudo?.assinaturaNome }} • {{ form.value.conteudo?.assinaturaCargo }}</p>
        </div>
      </div>

      <div class="actions">
        <button type="button" class="ghost" (click)="imprimirRascunho()">Gerar oficio para impressao</button>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'listagem'">
      <div class="list-card">
        <div class="list-card__header">
          <div>
            <p class="page-title__eyebrow">Oficios registrados</p>
            <p class="page-title__label">Acompanhe a situacao, local atual e protocolos</p>
          </div>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>N°</th>
                <th>Assunto</th>
                <th>Status</th>
                <th>Local atual</th>
                <th>Destino</th>
                <th>Protocolos</th>
                <th>Acoes</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let oficio of oficios">
                <td>{{ oficio.identificacao.numero }}</td>
                <td>{{ oficio.conteudo.assunto }}</td>
                <td><span class="status-pill">{{ oficio.protocolo.status }}</span></td>
                <td>{{ getLocalAtual(oficio) }}</td>
                <td>{{ oficio.protocolo.proximoDestino || oficio.identificacao.destinatario }}</td>
                <td>
                  <div class="muted">Envio: {{ oficio.protocolo.protocoloEnvio || '-' }}</div>
                  <div class="muted">Receb.: {{ oficio.protocolo.protocoloRecebimento || '-' }}</div>
                </td>
                <td>
                  <div class="table-actions">
                    <button type="button" class="ghost" (click)="edit(oficio)">Editar</button>
                    <button type="button" class="ghost" (click)="imprimirModelo(oficio)">Visualizar</button>
                    <button type="button" class="ghost" (click)="delete(oficio.id)">Excluir</button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </form>
</section>
</app-tela-padrao>
