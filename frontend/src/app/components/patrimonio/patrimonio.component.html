<app-tela-padrao>
<header class="page-title" slot="titulo">
    <p class="page-title__eyebrow">Administrativo • Patrimônio</p>
    <p class="page-title__label">Gestão de controle patrimonial</p>
    <p class="page-title__description">
      Centralize entradas, saídas, baixas e depreciação dos bens com rastreabilidade completa por placa e número de patrimônio.
    </p>
  </header>

  <section class="cadastro patrimonio">
  <div class="tab-shell">
    <p class="tab-shell__title">Navegue pelas informações</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of assetTabs; index as idx"
        class="step-tabs__item"
        [class.active]="activeAssetTab === tab.id"
        [class.completed]="idx < activeAssetTabIndex"
      >
        <button
          class="step-tabs__button"
          type="button"
          role="tab"
          [attr.aria-selected]="activeAssetTab === tab.id"
          (click)="changeAssetTab(tab.id)"
        >
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ tab.label }}</span>
        </button>
        <p class="step-tabs__description">{{ tab.description }}</p>
      </li>
    </ol>
  </div>

  <div *ngIf="errorMessage" class="alert">{{ errorMessage }}</div>

  <ng-template #navigationControls>
    <div class="tab-actions">
      <button type="button" class="ghost" *ngIf="hasPreviousAssetTab" (click)="goToPreviousAssetTab()">Voltar</button>
      <button type="button" class="primary" *ngIf="hasNextAssetTab" (click)="goToNextAssetTab()">
        Próximo: {{ nextAssetTabLabel }}
      </button>
      <button
        type="button"
        class="primary"
        *ngIf="!hasNextAssetTab"
        (click)="saveAsset()"
        [disabled]="isSaving"
      >
        {{ isSaving ? 'Salvando...' : editingAssetId ? 'Atualizar patrimônio' : 'Salvar patrimônio' }}
      </button>
    </div>
  </ng-template>

  <div class="tab-card" *ngIf="activeAssetTab === 'dados'">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">{{ assetTabs[activeAssetTabIndex].label }}</p>
        <p class="muted">Campos obrigatórios para identificação, classificação e depreciação.</p>
      </div>
      <div class="tab-card__actions">
        <button type="button" class="ghost" (click)="startEditingSelected()" [disabled]="!selectedAsset">
          <fa-icon [icon]="faFileInvoice" class="mr-2"></fa-icon>
          Editar patrimônio selecionado
        </button>
        <button type="button" class="ghost" (click)="generateCessionTerm()">
          <fa-icon [icon]="faPrint" class="mr-2"></fa-icon>
          Imprimir termo de cessão
        </button>
        <button type="button" class="primary" (click)="saveAsset()" [disabled]="isSaving">
          <fa-icon [icon]="faFloppyDisk" class="mr-2"></fa-icon>
          {{ isSaving ? 'Salvando...' : editingAssetId ? 'Atualizar patrimônio' : 'Salvar patrimônio' }}
        </button>
        <button *ngIf="editingAssetId" type="button" class="ghost" (click)="cancelEdit()">Cancelar edição</button>
      </div>
    </div>

    <div class="grid gap-4 md:grid-cols-2">
      <div class="form-group">
        <label class="form-label">Número do patrimônio *</label>
        <input class="input" [(ngModel)]="assetForm.patrimonyNumber" placeholder="PAT-2024-0001" />
      </div>
      <div class="form-group">
        <label class="form-label">Nome do patrimônio *</label>
        <input
          class="input"
          [(ngModel)]="assetForm.name"
          (input)="formatField('name')"
          (blur)="formatField('name')"
          placeholder="Ex.: Notebook Dell Latitude"
        />
      </div>
      <div class="form-group">
        <div class="flex items-center justify-between gap-2">
          <label class="form-label">Categoria *</label>
          <div class="flex gap-2">
            <button type="button" class="text-xs btn-outline" (click)="editCategories()">Alterar categorias</button>
            <button type="button" class="text-xs btn-outline" (click)="addCategory()">+ Incluir categoria</button>
          </div>
        </div>
        <select class="input" [(ngModel)]="assetForm.category">
          <option value="" disabled>Selecione</option>
          <option *ngFor="let category of categories" [value]="category.label">{{ category.label }}</option>
        </select>
      </div>
      <div class="form-group">
        <div class="flex items-center justify-between gap-2">
          <label class="form-label">Subcategoria</label>
          <div class="flex gap-2">
            <button type="button" class="text-xs btn-outline" (click)="editSubcategories()" [disabled]="!assetForm.category">
              Alterar subcategorias
            </button>
            <button type="button" class="text-xs btn-outline" (click)="addSubcategory()" [disabled]="!assetForm.category">
              + Incluir subcategoria
            </button>
          </div>
        </div>
        <select class="input" [(ngModel)]="assetForm.subcategory">
          <option value="" disabled>Selecione</option>
          <ng-container *ngFor="let category of categories">
            <option *ngFor="let sub of category.subcategories" [value]="sub">{{ sub }}</option>
          </ng-container>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Descrição detalhada</label>
        <textarea class="input" [(ngModel)]="assetForm.description" rows="3" placeholder="Identifique marca, modelo e características"></textarea>
      </div>
      <div class="grid gap-4 md:grid-cols-2">
        <div class="form-group">
          <label class="form-label">Estado de conservação *</label>
          <div class="grid grid-cols-2 gap-2">
            <label *ngFor="let option of conservationOptions" class="chip chip--compact">
              <input type="radio" [(ngModel)]="assetForm.conservation" [value]="option" />
              <span>{{ option }}</span>
            </label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Situação atual *</label>
          <div class="grid grid-cols-2 gap-2">
            <label *ngFor="let status of statusOptions" class="chip chip--compact chip--small-text">
              <input type="radio" [(ngModel)]="assetForm.status" [value]="status" />
              <span>{{ status }}</span>
            </label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Quantidade</label>
        <input type="number" min="1" class="input" [(ngModel)]="assetForm.quantity" />
      </div>
      <div class="form-group">
        <label class="form-label">Número(s) de patrimônio individual</label>
        <input class="input" [(ngModel)]="assetForm.individualNumbers" placeholder="Separe por vírgula" />
      </div>
    </div>

    <div class="divider"></div>

    <div class="grid gap-4 md:grid-cols-2">
      <div class="form-group">
        <label class="form-label">Data de aquisição *</label>
        <input type="date" class="input" [(ngModel)]="assetForm.acquisitionDate" />
      </div>
      <div class="form-group">
        <label class="form-label">Valor de aquisição *</label>
        <input
          type="text"
          class="input"
          [ngModel]="displayedAcquisitionValue"
          (ngModelChange)="onAcquisitionValueChange($event)"
          inputmode="decimal"
          placeholder="0,00"
        />
      </div>
      <div class="form-group">
        <label class="form-label">Origem *</label>
        <select class="input" [(ngModel)]="assetForm.origin">
          <option *ngFor="let origin of origins" [value]="origin">{{ origin }}</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Número da nota fiscal</label>
        <input class="input" [(ngModel)]="assetForm.invoiceNumber" placeholder="NF-e" />
      </div>
      <div class="form-group">
        <label class="form-label">Fornecedor</label>
        <input
          class="input"
          [(ngModel)]="assetForm.supplier"
          (input)="formatField('supplier')"
          (blur)="formatField('supplier')"
          placeholder="Razão social"
        />
      </div>
      <div class="form-group">
        <label class="form-label">Vida útil estimada (meses)</label>
        <input type="number" class="input" [(ngModel)]="assetForm.usefulLife" />
      </div>
      <div class="form-group">
        <label class="form-label">Data de início da depreciação</label>
        <input type="date" class="input" [(ngModel)]="assetForm.depreciationStartDate" />
      </div>
      <div class="form-group">
        <label class="form-label">Depreciação mensal (%)</label>
        <input type="number" class="input" [(ngModel)]="assetForm.depreciationRate" />
      </div>
    </div>

    <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
  </div>

  <div class="tab-card" *ngIf="activeAssetTab === 'visual'">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">{{ assetTabs[activeAssetTabIndex].label }}</p>
        <p class="muted">Foto, etiqueta, QR Code e garantias.</p>
      </div>
      <div class="tab-card__actions">
        <button type="button" class="ghost" (click)="goToPreviousAssetTab()">Voltar</button>
        <button type="button" class="primary" (click)="goToNextAssetTab()">Próximo: {{ nextAssetTabLabel }}</button>
      </div>
    </div>

    <div class="grid gap-6 lg:grid-cols-2">
      <div class="upload-box" [class.upload-box--empty]="!filePreview">
        <ng-container *ngIf="filePreview; else emptyState">
          <img [src]="filePreview" alt="Foto do patrimônio" class="rounded-lg w-full h-48 object-cover" />
        </ng-container>
        <ng-template #emptyState>
          <div class="flex flex-col items-center justify-center text-slate-500 h-48">
            <fa-icon [icon]="faCloudArrowUp" class="text-2xl mb-2"></fa-icon>
            <p>Faça upload para visualizar a foto</p>
          </div>
        </ng-template>
      </div>
      <div class="space-y-3">
        <input type="file" (change)="handleFileInput($event)" class="file-input" />
        <div class="flex gap-2">
          <button type="button" class="btn-outline" (click)="generateQrCode()">
            <fa-icon [icon]="faQrcode" class="mr-2"></fa-icon>
            Gerar QR Code
          </button>
          <div class="px-3 py-2 rounded-lg bg-emerald-50 border border-emerald-100 text-sm text-emerald-800 flex-1">
            <p class="font-semibold">Código interno</p>
            <p>{{ qrCodeValue }}</p>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Manual / Termo digital</label>
          <div class="flex gap-2">
            <input class="input" [(ngModel)]="assetForm.manualUrl" placeholder="Anexe ou cole o link" />
            <button type="button" class="btn-outline">
              <fa-icon [icon]="faFileInvoice" class="mr-2"></fa-icon>
              Upload
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="grid gap-4 md:grid-cols-2 mt-6">
      <div class="form-group">
        <label class="form-label">Observações gerais</label>
        <textarea class="input" [(ngModel)]="assetForm.observations" rows="3"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Condições de garantia</label>
        <input class="input" [(ngModel)]="assetForm.warranty" placeholder="Prazo, cobertura e contato" />
      </div>
      <div class="form-group">
        <label class="form-label">Última movimentação</label>
        <input class="input" [(ngModel)]="assetForm.lastMovement" placeholder="Não registrada" />
      </div>
      <div class="form-group">
        <label class="form-label">Último responsável</label>
        <input class="input" [(ngModel)]="assetForm.lastResponsible" placeholder="Não registrado" />
      </div>
      <div class="form-group">
        <label class="form-label">Última manutenção</label>
        <input class="input" [(ngModel)]="assetForm.lastMaintenance" placeholder="Não registrada" />
      </div>
    </div>

    <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
  </div>

  <div class="tab-card" *ngIf="activeAssetTab === 'localizacao'">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">{{ assetTabs[activeAssetTabIndex].label }}</p>
        <p class="muted">Responsáveis, endereços e código interno do bem.</p>
      </div>
      <div class="tab-card__actions">
        <button type="button" class="ghost" (click)="goToPreviousAssetTab()">Voltar</button>
        <button type="button" class="primary" (click)="goToNextAssetTab()">Próximo: {{ nextAssetTabLabel }}</button>
      </div>
    </div>

    <div class="grid gap-4 md:grid-cols-2">
      <div class="form-group">
        <label class="form-label">Unidade / Setor responsável *</label>
        <input
          class="input"
          [(ngModel)]="assetForm.unit"
          (input)="formatField('unit')"
          (blur)="formatField('unit')"
          placeholder="Ex.: TI"
        />
      </div>
      <div class="form-group">
        <label class="form-label">Ambiente / Sala</label>
        <input
          class="input"
          [(ngModel)]="assetForm.room"
          (input)="formatField('room')"
          (blur)="formatField('room')"
          placeholder="Ex.: Sala 12"
        />
      </div>
      <div class="form-group">
        <label class="form-label">Endereço completo</label>
        <input
          class="input"
          [(ngModel)]="assetForm.address"
          (input)="formatField('address')"
          (blur)="formatField('address')"
          placeholder="Somente para outras unidades"
        />
      </div>
      <div class="form-group">
        <label class="form-label">Responsável pelo item *</label>
        <input
          class="input"
          [(ngModel)]="assetForm.responsibleName"
          (input)="formatField('responsibleName')"
          (blur)="formatField('responsibleName')"
          placeholder="Nome"
        />
      </div>
      <div class="form-group">
        <label class="form-label">Contato do responsável</label>
        <input class="input" [(ngModel)]="assetForm.responsibleContact" placeholder="Telefone ou e-mail" />
      </div>
      <div class="form-group">
        <label class="form-label">Código interno</label>
        <input class="input" [(ngModel)]="assetForm.internalCode" placeholder="Ex.: TAG-889" />
      </div>
    </div>

    <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
  </div>

  <div class="tab-card" *ngIf="activeAssetTab === 'dashboard'">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">{{ assetTabs[activeAssetTabIndex].label }}</p>
        <p class="muted">Indicadores de entradas, saídas, bens ativos e valor de aquisição.</p>
      </div>
    </div>

    <div class="grid gap-4 md:grid-cols-4">
      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <p class="text-sm text-slate-500">Entradas registradas</p>
          <span class="badge badge--success">+18% vs mês anterior</span>
        </div>
        <div class="flex items-baseline gap-2">
          <fa-icon [icon]="faArrowDown" class="text-emerald-600"></fa-icon>
          <p class="text-3xl font-semibold">{{ assetLibrary.length }}</p>
        </div>
        <p class="text-xs text-slate-500 mt-1">Bens com nota fiscal lançada na unidade.</p>
      </div>

      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <p class="text-sm text-slate-500">Saídas / empréstimos</p>
          <span class="badge">{{ loanedAssets.length }} em empréstimo</span>
        </div>
        <div class="flex items-baseline gap-2">
          <fa-icon [icon]="faArrowUp" class="text-amber-500"></fa-icon>
          <p class="text-3xl font-semibold">{{ loanedAssets.length }}</p>
        </div>
        <p class="text-xs text-slate-500 mt-1">Apenas bens emprestados com termo gerado.</p>
        <div *ngIf="overdueLoanedAssets.length" class="mt-2 space-y-2">
          <p class="text-xs font-semibold text-rose-700">{{ overdueLoanedAssets.length }} atrasado(s) para devolução</p>
          <div class="flex flex-wrap gap-2">
            <span
              *ngFor="let asset of overdueLoanedAssets"
              class="px-3 py-1 text-xs rounded-full bg-rose-50 border border-rose-200 text-rose-700"
            >
              {{ asset.numeroPatrimonio }} • {{ asset.nome }}
            </span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <p class="text-sm text-slate-500">Bens ativos</p>
          <span class="badge badge--success">Uso corrente</span>
        </div>
        <div class="flex items-baseline gap-2">
          <fa-icon [icon]="faFileInvoice" class="text-emerald-600"></fa-icon>
          <p class="text-3xl font-semibold">{{ activeAssets }}</p>
        </div>
        <p class="text-xs text-slate-500 mt-1">Soma de patrimônios disponíveis e em uso.</p>
      </div>

      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <p class="text-sm text-slate-500">Valor dos bens</p>
          <span class="badge badge--success">{{ monthlyDepreciation | number: '1.0-1' }}% ao mês</span>
        </div>
        <p class="text-3xl font-semibold text-slate-800">{{ totalAcquisitionValue | currency:'BRL' }}</p>
        <p class="text-xs text-slate-500 mt-1">Soma do valor de todos os bens lançados.</p>
      </div>
    </div>

    <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
  </div>

  <div class="tab-card" *ngIf="activeAssetTab === 'movimentacao'">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">{{ assetTabs[activeAssetTabIndex].label }}</p>
        <p class="muted">Filtros, impressão e registro de movimentações.</p>
      </div>
      <div class="tab-card__actions">
        <button type="button" class="ghost" (click)="printAssets()">
          <fa-icon [icon]="faPrint" class="mr-2"></fa-icon>
          Imprimir bens
        </button>
      </div>
    </div>

    <div class="grid gap-3 md:grid-cols-3 mb-4">
      <div class="input-with-icon">
        <fa-icon [icon]="faMagnifyingGlass"></fa-icon>
        <input class="input" [(ngModel)]="searchTerm" placeholder="Buscar por número, placa ou responsável" />
      </div>
      <div class="input-with-icon">
        <fa-icon [icon]="faTags"></fa-icon>
        <input class="input" placeholder="Filtrar por categoria" />
      </div>
      <div class="input-with-icon">
        <fa-icon [icon]="faBuilding"></fa-icon>
        <input class="input" placeholder="Filtrar por unidade" />
      </div>
    </div>

    <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
      <div class="flex flex-wrap items-center gap-3">
        <div class="flex items-center gap-2">
          <label class="text-sm text-slate-600">Imprimir bens por</label>
          <select class="input" [(ngModel)]="printOrder">
            <option value="alphabetical">Ordem alfabética</option>
            <option value="patrimony">Número de patrimônio</option>
            <option value="value">Valor</option>
            <option value="location">Local</option>
          </select>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-slate-600">Filtrar por local</label>
          <select class="input" [(ngModel)]="printLocationFilter">
            <option value="all">Todos os locais</option>
            <option *ngFor="let location of availableLocations" [value]="location">{{ location }}</option>
          </select>
        </div>
      </div>
      <button type="button" class="btn-outline" (click)="printAssets()">
        <fa-icon [icon]="faPrint" class="mr-2"></fa-icon>
        Imprimir bens
      </button>
    </div>

    <div class="movement-form" *ngIf="selectedAsset; else noSelection">
      <div class="space-y-1">
        <p class="text-xs uppercase text-slate-500">Movimentar patrimônio</p>
        <h3 class="text-lg font-semibold text-slate-800">{{ selectedAsset.numeroPatrimonio }} • {{ selectedAsset.nome }}</h3>
      </div>
      <div class="grid gap-3 md:grid-cols-4">
        <label class="form-label">Tipo
          <select class="input" [(ngModel)]="movementForm.tipo">
            <option value="MOVIMENTACAO">Movimentação</option>
            <option value="MANUTENCAO">Manutenção</option>
            <option value="BAIXA">Baixa</option>
          </select>
        </label>
        <label class="form-label">Destino/Unidade
          <input
            class="input"
            [(ngModel)]="movementForm.destino"
            (input)="formatMovementField('destino')"
            (blur)="formatMovementField('destino')"
            placeholder="Sala, setor ou unidade"
          />
        </label>
        <label class="form-label">Responsável
          <input
            class="input"
            [(ngModel)]="movementForm.responsavel"
            (input)="formatMovementField('responsavel')"
            (blur)="formatMovementField('responsavel')"
            placeholder="Quem autoriza"
          />
        </label>
        <label class="form-label">Observação
          <input class="input" [(ngModel)]="movementForm.observacao" placeholder="Número de termo ou motivo" />
        </label>
      </div>
      <div class="flex items-center justify-between">
        <p *ngIf="movementError" class="text-sm text-rose-600">{{ movementError }}</p>
        <button
          type="button"
          class="btn-primary"
          (click)="registerMovement()"
          [disabled]="isRegisteringMovement"
        >
          {{ isRegisteringMovement ? 'Registrando...' : 'Registrar' }}
        </button>
      </div>
    </div>
    <ng-template #noSelection>
      <p class="text-sm text-slate-500 mb-3">Selecione um patrimônio para registrar movimentações.</p>
    </ng-template>

    <div class="overflow-hidden border border-slate-200 rounded-xl">
      <table class="min-w-full">
        <thead class="bg-slate-50 text-left text-xs font-semibold text-slate-500">
          <tr>
            <th class="px-4 py-3">Número do patrimônio</th>
            <th class="px-4 py-3">Nome</th>
            <th class="px-4 py-3">Categoria</th>
            <th class="px-4 py-3">Estado</th>
            <th class="px-4 py-3">Situação</th>
            <th class="px-4 py-3">Local</th>
            <th class="px-4 py-3">Data aquisição</th>
            <th class="px-4 py-3">Valor</th>
            <th class="px-4 py-3">Depreciação</th>
            <th class="px-4 py-3">Responsável</th>
            <th class="px-4 py-3 text-right">Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let asset of filteredAssets"
            class="border-t border-slate-200 text-sm hover:bg-slate-50 cursor-pointer"
            (click)="setSelected(asset)"
          >
            <td class="px-4 py-3 font-semibold text-slate-800">{{ asset.numeroPatrimonio }}</td>
            <td class="px-4 py-3">{{ asset.nome }}</td>
            <td class="px-4 py-3">{{ asset.categoria }} <span *ngIf="asset.subcategoria" class="text-slate-500">/ {{ asset.subcategoria }}</span></td>
            <td class="px-4 py-3">{{ asset.conservacao }}</td>
            <td class="px-4 py-3">
              <span
                class="status-pill"
                [class.status-pill--warning]="(asset.status ?? '').includes('manutenção')"
                [class.status-pill--muted]="(asset.status ?? '').toLowerCase().includes('inativo')"
              >
                {{ asset.status || 'Não informado' }}
              </span>
            </td>
            <td class="px-4 py-3">{{ getLocationLabel(asset) || 'Não informado' }}</td>
            <td class="px-4 py-3">{{ asset.dataAquisicao | date: 'dd/MM/yyyy' }}</td>
            <td class="px-4 py-3">{{ asset.valorAquisicao | currency:'BRL' }}</td>
            <td class="px-4 py-3">{{ asset.taxaDepreciacao }}% / mês</td>
            <td class="px-4 py-3">{{ asset.responsavel }} <span *ngIf="asset.unidade">({{ asset.unidade }})</span></td>
            <td class="px-4 py-3 text-right space-x-2">
              <button type="button" class="btn-outline" (click)="quickMovement(asset, 'MOVIMENTACAO'); $event.stopPropagation()">Mover</button>
              <button type="button" class="btn-outline" (click)="quickMovement(asset, 'MANUTENCAO'); $event.stopPropagation()">Manutenção</button>
              <button type="button" class="btn-outline" (click)="quickMovement(asset, 'BAIXA'); $event.stopPropagation()">Baixar</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
  </div>
</section>
</app-tela-padrao>

