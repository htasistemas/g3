<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  (salvar)="salvar()"
  (excluir)="excluir()"
  (novo)="novo()"
  (cancelar)="cancelar()"
  (imprimir)="imprimir()"
  (buscar)="onBuscar()"
  (fechar)="fechar()"
>
  <app-popup-messages [mensagens]="popupErros" (fechar)="fecharPopupErros()"></app-popup-messages>
  <header class="page-title page-title--row" slot="titulo">
    <div>
      <p class="page-title__eyebrow">SETOR FINANCEIRO</p>
      <p class="page-title__label">Prestacao de Contas</p>
    </div>
    <p class="page-title__note">Transparencia de recursos e destino das doacoes.</p>
  </header>

  <section class="cadastro">
    <div class="page-actions">
      <button class="ghost" type="button">
        <fa-icon [icon]="faHandHoldingHeart"></fa-icon>
        Publicar resumo aos doadores
      </button>
      <button class="ghost" type="button">
        <fa-icon [icon]="faShareNodes"></fa-icon>
        Compartilhar evidencias
      </button>
    </div>

    <div class="tab-shell">
      <p class="tab-shell__title">Navegue pelas informacoes</p>
      <ol class="step-tabs" role="tablist">
        <li
          *ngFor="let tab of tabs; index as idx"
          class="step-tabs__item"
          [class.active]="activeTab === tab.id"
          [class.completed]="idx < activeTabIndex"
        >
          <button
            class="step-tabs__button"
            type="button"
            role="tab"
            [attr.aria-selected]="activeTab === tab.id"
            (click)="changeTab(tab.id)"
          >
            <span class="step-tabs__index">{{ idx + 1 }}</span>
            <span class="step-tabs__label">{{ tab.label }}</span>
          </button>
        </li>
      </ol>
    </div>

    <form [formGroup]="form" class="form-shell">
      <div class="tab-card" *ngIf="activeTab === 'resumo'" formGroupName="resumo">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
            <p class="muted">{{ activeTabHelper }}</p>
          </div>
          <span class="pill pill--success">Atualizado</span>
        </div>

        <div class="card-grid">
          <article class="summary-card">
            <div class="summary-card__header">
              <p class="summary-card__label">Total recebido</p>
              <fa-icon [icon]="faChartPie" class="summary-card__icon"></fa-icon>
            </div>
            <input
              class="summary-input"
              type="text"
              formControlName="totalRecebido"
              placeholder="R$ 0,00"
              (input)="onResumoValorInput($event, ['resumo','totalRecebido'])"
            />
            <input
              class="summary-helper"
              type="text"
              formControlName="totalRecebidoHelper"
              placeholder="Ex.: Somatorio dos doadores ativos"
              (blur)="capitalizarCampo(['resumo','totalRecebidoHelper'])"
            />
          </article>
          <article class="summary-card">
            <div class="summary-card__header">
              <p class="summary-card__label">Total aplicado</p>
            </div>
            <input
              class="summary-input"
              type="text"
              formControlName="totalAplicado"
              placeholder="R$ 0,00"
              (input)="onResumoValorInput($event, ['resumo','totalAplicado'])"
            />
            <input
              class="summary-helper"
              type="text"
              formControlName="totalAplicadoHelper"
              placeholder="Ex.: Projetos e despesas comprovadas"
              (blur)="capitalizarCampo(['resumo','totalAplicadoHelper'])"
            />
          </article>
          <article class="summary-card">
            <div class="summary-card__header">
              <p class="summary-card__label">Saldo para executar</p>
            </div>
            <input
              class="summary-input"
              type="text"
              formControlName="saldoDisponivel"
              placeholder="R$ 0,00"
              (input)="onResumoValorInput($event, ['resumo','saldoDisponivel'])"
            />
            <input
              class="summary-helper"
              type="text"
              formControlName="saldoDisponivelHelper"
              placeholder="Ex.: Disponivel para novos repasses"
              (blur)="capitalizarCampo(['resumo','saldoDisponivelHelper'])"
            />
          </article>
          <article class="summary-card">
            <div class="summary-card__header">
              <p class="summary-card__label">Prestado no mes</p>
            </div>
            <input
              class="summary-input"
              type="text"
              formControlName="prestadoMes"
              placeholder="R$ 0,00"
              (input)="onResumoValorInput($event, ['resumo','prestadoMes'])"
            />
            <input
              class="summary-helper"
              type="text"
              formControlName="prestadoMesHelper"
              placeholder="Ex.: + 9% vs. mes anterior"
              (blur)="capitalizarCampo(['resumo','prestadoMesHelper'])"
            />
          </article>
        </div>
      </div>

      <div class="tab-card" *ngIf="activeTab === 'fluxo'">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
            <p class="muted">{{ activeTabHelper }}</p>
          </div>
          <span class="pill">Fontes e aplicacoes</span>
        </div>

        <div class="panel-grid">
          <article class="panel" formArrayName="recebimentos">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Doacoes recebidas</p>
                <p class="panel__title">Fontes e recorrencia</p>
              </div>
              <button class="ghost" type="button" (click)="addRecebimento()">
                <fa-icon [icon]="faCloudArrowUp"></fa-icon>
                Novo recebimento
              </button>
            </header>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Fonte</th>
                    <th>Valor</th>
                    <th>Periodicidade</th>
                    <th>Status</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of recebimentos.controls; let idx = index" [formGroupName]="idx">
                    <td><input type="text" formControlName="fonte" placeholder="Fonte" (blur)="capitalizarCampo(['recebimentos', idx, 'fonte'])" /></td>
                    <td><input type="text" formControlName="valor" placeholder="R$ 0,00" (input)="onRecebimentoValorInput($event, idx)" /></td>
                    <td><input type="text" formControlName="periodicidade" placeholder="Ex.: Mensal" (blur)="capitalizarCampo(['recebimentos', idx, 'periodicidade'])" /></td>
                    <td>
                      <select formControlName="status">
                        <option value="OK">OK</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Pendente NFe">Pendente NFe</option>
                      </select>
                    </td>
                    <td>
                      <button class="danger" type="button" (click)="removeRecebimento(idx)">Excluir</button>
                    </td>
                  </tr>
                  <tr *ngIf="!recebimentos.length">
                    <td colspan="5" class="muted">Nenhum recebimento registrado.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </article>

          <article class="panel" formArrayName="destinacoes">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Destinacao dos recursos</p>
                <p class="panel__title">Percentual aplicado por frente</p>
              </div>
              <button class="ghost" type="button" (click)="addDestinacao()">
                <fa-icon [icon]="faCloudArrowUp"></fa-icon>
                Nova destinacao
              </button>
            </header>
            <div class="destinacoes">
              <div class="destinacao-item" *ngFor="let item of destinacoes.controls; let idx = index" [formGroupName]="idx">
                <div class="destinacao-fields">
                  <input type="text" formControlName="titulo" placeholder="Titulo" (blur)="capitalizarCampo(['destinacoes', idx, 'titulo'])" />
                  <textarea rows="2" formControlName="descricao" placeholder="Descricao"></textarea>
                </div>
                <div class="destinacao-actions">
                  <input type="number" min="0" max="100" formControlName="percentual" placeholder="%" />
                  <button class="danger" type="button" (click)="removeDestinacao(idx)">Excluir</button>
                </div>
              </div>
              <p class="muted" *ngIf="!destinacoes.length">Nenhuma destinacao registrada.</p>
            </div>
          </article>
        </div>
      </div>

      <div class="tab-card" *ngIf="activeTab === 'transparencia'">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
            <p class="muted">{{ activeTabHelper }}</p>
          </div>
          <span class="pill">Evidencias</span>
        </div>

        <div class="panel-grid three-cols">
          <article class="panel" formArrayName="timelines">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Linhas do tempo</p>
                <p class="panel__title">Prestacao detalhada</p>
              </div>
              <button class="ghost" type="button" (click)="addTimeline()">
                <fa-icon [icon]="faCloudArrowUp"></fa-icon>
                Nova etapa
              </button>
            </header>
            <div class="timeline">
              <div class="timeline-item" *ngFor="let item of timelines.controls; let idx = index" [formGroupName]="idx">
                <div class="timeline__marker" [class.is-complete]="item.get('status')?.value === 'concluido'" [class.is-active]="item.get('status')?.value === 'andamento'"></div>
                <div class="timeline-fields">
                  <input type="text" formControlName="titulo" placeholder="Titulo" (blur)="capitalizarCampo(['timelines', idx, 'titulo'])" />
                  <textarea rows="2" formControlName="detalhe" placeholder="Detalhe"></textarea>
                  <div class="timeline-actions">
                    <select formControlName="status">
                      <option *ngFor="let status of statusItens" [value]="status">{{ status }}</option>
                    </select>
                    <button class="danger" type="button" (click)="removeTimeline(idx)">Excluir</button>
                  </div>
                </div>
              </div>
              <p class="muted" *ngIf="!timelines.length">Nenhuma etapa registrada.</p>
            </div>
          </article>

          <article class="panel" formArrayName="comprovantes">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Comprovantes e evidencias</p>
                <p class="panel__title">Arquivos prontos para auditoria</p>
              </div>
              <button class="ghost" type="button" (click)="addComprovante()">
                <fa-icon [icon]="faCloudArrowUp"></fa-icon>
                Enviar novo arquivo
              </button>
            </header>
            <div class="report-cards">
              <div class="report-card" *ngFor="let item of comprovantes.controls; let idx = index" [formGroupName]="idx">
                <fa-icon [icon]="faFileLines"></fa-icon>
                <div>
                  <input type="text" formControlName="titulo" placeholder="Titulo" (blur)="capitalizarCampo(['comprovantes', idx, 'titulo'])" />
                  <textarea rows="2" formControlName="descricao" placeholder="Descricao"></textarea>
                  <div class="report-actions">
                    <label class="ghost upload-button" type="button">
                      <input type="file" accept="application/pdf,image/*" (change)="onComprovanteSelecionado($event, idx)" />
                      Anexar arquivo
                    </label>
                    <button class="danger" type="button" (click)="removeComprovante(idx)">Excluir</button>
                  </div>
                  <p class="muted" *ngIf="item.get('arquivoNome')?.value">Arquivo: {{ item.get('arquivoNome')?.value }}</p>
                </div>
              </div>
              <p class="muted" *ngIf="!comprovantes.length">Nenhum comprovante registrado.</p>
            </div>
          </article>

          <article class="panel" formArrayName="checklist">
            <header class="panel__header">
              <div>
                <p class="panel__eyebrow">Checklist</p>
                <p class="panel__title">Documentos obrigatorios</p>
              </div>
              <button class="ghost" type="button" (click)="addChecklist()">
                <fa-icon [icon]="faCloudArrowUp"></fa-icon>
                Novo item
              </button>
            </header>
            <div class="checklist">
              <div class="checklist-item" *ngFor="let item of checklist.controls; let idx = index" [formGroupName]="idx">
                <fa-icon [icon]="item.get('status')?.value === 'concluido' ? faCircleCheck : faCircleExclamation"></fa-icon>
                <div class="checklist-fields">
                  <input type="text" formControlName="titulo" placeholder="Titulo" (blur)="capitalizarCampo(['checklist', idx, 'titulo'])" />
                  <textarea rows="2" formControlName="descricao" placeholder="Descricao"></textarea>
                  <div class="checklist-actions">
                    <select formControlName="status">
                      <option *ngFor="let status of statusItens" [value]="status">{{ status }}</option>
                    </select>
                    <button class="danger" type="button" (click)="removeChecklist(idx)">Excluir</button>
                  </div>
                </div>
              </div>
              <p class="muted" *ngIf="!checklist.length">Nenhum item no checklist.</p>
            </div>
          </article>
        </div>
      </div>

      <div class="tab-card" *ngIf="activeTab === 'listagem'">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
            <p class="muted">Acompanhe os registros salvos e edite quando necessario.</p>
          </div>
          <button class="ghost" type="button" (click)="novo()">Novo registro</button>
        </div>
        <div class="list-card">
          <div class="list-card__header">
            <div>
              <p class="page-title__eyebrow">Registros de transparencia</p>
              <p class="page-title__label">Historico</p>
            </div>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Total recebido</th>
                  <th>Total aplicado</th>
                  <th>Saldo</th>
                  <th>Prestado no mes</th>
                  <th>Acoes</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let registro of registros">
                  <td>{{ registro.id }}</td>
                  <td>{{ formatCurrency(registro.totalRecebido) }}</td>
                  <td>{{ formatCurrency(registro.totalAplicado) }}</td>
                  <td>{{ formatCurrency(registro.saldoDisponivel) }}</td>
                  <td>{{ formatCurrency(registro.prestadoMes) }}</td>
                  <td class="row-actions">
                    <button class="ghost" type="button" (click)="editarRegistro(registro)">Editar</button>
                    <button class="ghost" type="button" (click)="imprimirRegistro(registro)">Imprimir</button>
                    <button class="danger" type="button" (click)="excluirRegistro(registro)">Excluir</button>
                  </td>
                </tr>
                <tr *ngIf="!registros.length">
                  <td colspan="6" class="muted">Nenhum registro encontrado.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </form>
  </section>
</app-tela-padrao>



