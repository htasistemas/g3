<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  [fullWidth]="true"
  (salvar)="onSave()"
  (excluir)="onDelete()"
  (novo)="onNew()"
  (cancelar)="onCancel()"
  (imprimir)="onPrint()"
  (buscar)="onBuscar()"
  (fechar)="onClose()"
>
<header class="page-title page-title--row" slot="titulo">
  <div>
  <p class="page-title__label"></p>
  </div>
</header>

  <section class="cadastro">
  <div class="cadastro-layout">
    <aside class="cadastro-menu">
      <div class="tab-shell">
        <p class="tab-shell__title tab-shell__title--destaque">
          <fa-icon [icon]="faUserDoctor" class="tab-shell__icon"></fa-icon>
          cadastros de Profissionais
        </p>
        <ol class="step-tabs" role="tablist">
          <li
            *ngFor="let tab of tabs; index as idx"
            class="step-tabs__item"
            [class.active]="activeTab === tab.id"
            [class.completed]="idx < activeTabIndex"
          >
            <button
              class="step-tabs__button"
              type="button"
              role="tab"
              [attr.aria-selected]="activeTab === tab.id"
              (click)="changeTab(tab.id)"
            >
              <span class="step-tabs__index">{{ idx + 1 }}</span>
              <span class="step-tabs__label">{{ tab.label }}</span>
            </button>
          </li>
        </ol>
      </div>
    </aside>

    <div class="cadastro-conteudo">
      <form [formGroup]="form" (ngSubmit)="submit()" class="form-shell">
    <app-popup-messages [mensagens]="popupErros" (fechar)="fecharPopupErros()"></app-popup-messages>
    <div *ngIf="feedback" class="feedback">
      <span>{{ feedback }}</span>
      <button type="button" class="feedback__close" (click)="clearFeedback()" aria-label="Fechar mensagem">X</button>
    </div>

    <ng-template #navigationControls>
      <div class="tab-actions">
        <button type="button" class="ghost" *ngIf="hasPreviousTab" (click)="goToPreviousTab()">Voltar</button>
        <button type="button" class="ghost" *ngIf="hasNextTab" (click)="goToNextTab()">
          Próximo: {{ nextTabLabel }}
        </button>
        <button type="submit" class="primary" [disabled]="saving" *ngIf="!hasNextTab">
          {{ saving ? 'Salvando...' : editingId ? 'Salvar alterações' : 'Cadastrar profissional' }}
        </button>
      </div>
    </ng-template>

    <div class="tab-card" *ngIf="activeTab === 'dados'" formGroupName="dadosPessoais">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Dados pessoais do profissional.</p>
        </div>
      </div>

      <div class="photo-panel">
        <div class="photo-panel__preview">
          <img *ngIf="photoPreview" [src]="photoPreview" alt="Foto do profissional" />
          <div class="photo-panel__placeholder" *ngIf="!photoPreview">Sem foto</div>
        </div>
        <div class="photo-panel__actions">
          <label class="ghost">
            Enviar foto 3x4
            <input type="file" accept="image/*" (change)="onPhotoSelected($event)" hidden />
          </label>
          <button type="button" class="ghost" (click)="handleCameraCapture()">
            {{ cameraActive ? 'Registrar foto' : 'Capturar pela câmera' }}
          </button>
          <button type="button" class="ghost" *ngIf="photoPreview" (click)="removePhoto()">Remover foto</button>
          <button type="button" class="ghost" *ngIf="cameraActive" (click)="stopCamera()">Fechar câmera</button>
          <p class="photo-hint">Status: {{ form.get('status')?.value || 'EM_ANALISE' }}</p>
          <p *ngIf="captureError" class="field-error">{{ captureError }}</p>
        </div>
      </div>

      <div class="camera-panel" *ngIf="cameraActive">
        <p class="camera-panel__title">Visualização da câmera</p>
        <div class="camera-panel__preview">
          <video #videoElement autoplay muted playsinline></video>
        </div>
        <p class="camera-panel__hint">Ajuste o enquadramento e clique em "Registrar foto" para salvar.</p>
      </div>

      <canvas #canvasElement class="capture-canvas"></canvas>
      <div class="field-grid cols-3">
        <label class="field field-nome-completo">Nome completo*<input formControlName="nome_completo" placeholder="Digite o nome completo" (input)="applyCapitalization('dadosPessoais.nome_completo', $any($event.target).value)" /></label>

        <label class="field">Data de nascimento*<input type="date" formControlName="data_nascimento" /></label>
        <label class="field">Sexo biológico<select formControlName="sexo_biologico">
            <option value="">Selecione</option>
            <option value="MASCULINO">Masculino</option>
            <option value="FEMININO">Feminino</option>
            <option value="OUTRO">Outro</option>
          </select></label>
        <label class="field">Estado civil<select formControlName="estado_civil">
            <option value=""></option>
            <option *ngFor="let option of maritalStatusOptions" [value]="option">{{ option }}</option>
          </select></label>
        <label class="field">Nacionalidade<select formControlName="nacionalidade">
            <option value=""></option>
            <option *ngFor="let option of nationalityOptions" [value]="option">{{ option }}</option>
          </select></label>

        <label class="field">Naturalidade (cidade)<input formControlName="naturalidade_cidade" (input)="applyCapitalization('dadosPessoais.naturalidade_cidade', $any($event.target).value)" /></label>
        <label class="field">Estado<select formControlName="naturalidade_uf">
            <option value="">Selecione o estado</option>
            <option *ngFor="let uf of brazilianStates" [value]="uf">{{ uf }}</option>
          </select></label>

        <label class="field field-nome-mae">Nome da mãe*<input formControlName="nome_mae" (input)="applyCapitalization('dadosPessoais.nome_mae', $any($event.target).value)" /></label>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'endereco'" formGroupName="endereco">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Endereço completo do profissional.</p>
        </div>
      </div>

      <div class="field-grid cols-3">
        <label class="field">CEP*<input formControlName="cep" placeholder="00000-000" (input)="onCepInput($event)" (blur)="onCepBlur()" />
          <p class="field-error" *ngIf="form.get(['endereco', 'cep'])?.invalid && form.get(['endereco', 'cep'])?.touched">
            Informe um CEP válido com 8 dígitos.
          </p>
          <p class="field-error" *ngIf="cepLookupError">{{ cepLookupError }}</p>
        </label>
        <label class="field">Endereço<input formControlName="logradouro" (input)="applyCapitalization('endereco.logradouro', $any($event.target).value)" /></label>
        <label class="field">Número<input formControlName="numero" /></label>
        <label class="field">Complemento<input formControlName="complemento" (input)="applyCapitalization('endereco.complemento', $any($event.target).value)" /></label>
        <label class="field">Bairro<input formControlName="bairro" (input)="applyCapitalization('endereco.bairro', $any($event.target).value)" /></label>
        <label class="field">Ponto de referência<input formControlName="ponto_referencia" (input)="applyCapitalization('endereco.ponto_referencia', $any($event.target).value)" /></label>
        <label class="field">Município<input formControlName="municipio" (input)="applyCapitalization('endereco.municipio', $any($event.target).value)" /></label>
        <label class="field">Zona<input formControlName="zona" /></label>
        <label class="field">Subzona<input formControlName="subzona" /></label>
        <label class="field">UF<select formControlName="uf">
            <option value="">Selecione o estado</option>
            <option *ngFor="let uf of brazilianStates" [value]="uf">{{ uf }}</option>
          </select></label>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'perfil'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Identifique o profissional e dados de contato de forma estruturada.</p>
        </div>
      </div>

      <div class="field-grid cols-3">
        <div class="field category-manager">
          <label class="field-title" for="categoriaSelect">Categoria*</label>
          <select id="categoriaSelect" formControlName="categoria">
            <option *ngFor="let categoria of categorias" [value]="categoria">{{ categoria }}</option>
          </select>
          <div class="category-actions">
            <div class="category-actions__inline">
              <input
                #novaCategoria
                type="text"
                placeholder="Nova categoria"
                (keydown.enter)="addCategoria(novaCategoria.value); novaCategoria.value = ''; $event.preventDefault();"
              />
              <button
                type="button"
                class="ghost"
                aria-label="Adicionar categoria"
                title="Adicionar categoria"
                (click)="addCategoria(novaCategoria.value); novaCategoria.value = ''"
              >
                +
              </button>
            </div>
          </div>
        </div>
        <label class="field">CPF*
          <input
            type="text"
            formControlName="cpf"
            placeholder="000.000.000-00"
            (input)="onCpfInput($event)"
            [class.input-error]="form.get('cpf')?.invalid && form.get('cpf')?.touched"
          />
          <p class="field-error" *ngIf="form.get('cpf')?.invalid && form.get('cpf')?.touched">
            Informe um CPF válido.
          </p>
        </label>
        <label class="field">Vínculo
          <select formControlName="vinculo">
            <option *ngFor="let vinculo of vinculos" [value]="vinculo.value">{{ vinculo.label }}</option>
          </select>
        </label>
        <label class="field"
          >Especialidade<input
            type="text"
            formControlName="especialidade"
            placeholder="Área principal de atuação"
            (input)="applyCapitalization('especialidade', $any($event.target).value)"
            (blur)="applyCapitalization('especialidade', $any($event.target).value)"
        /></label>
        <label class="field"
          >Registro em conselho<input
            type="text"
            formControlName="registroConselho"
            placeholder="CRESS, CRP, CRM..."
            (input)="applyCapitalization('registroConselho', $any($event.target).value)"
            (blur)="applyCapitalization('registroConselho', $any($event.target).value)"
        /></label>
        <label class="field">E-mail*<input type="email" formControlName="email" placeholder="contato@instituicao.org.br" /></label>
        <label class="field"
          >Telefone/WhatsApp<input
            type="text"
            formControlName="telefone"
            placeholder="(11) 90000-0000"
            (input)="applyCapitalization('telefone', $any($event.target).value)"
            (blur)="applyCapitalization('telefone', $any($event.target).value)"
        /></label>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'agenda'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Combine unidade, status e agenda de atendimento.</p>
        </div>
        <span class="pill">Agenda</span>
      </div>

      <div class="field-grid cols-3">
        <label class="field">Unidade de atendimento
          <select formControlName="unidadeId" (change)="onUnidadeSelecionada($event)">
            <option value="">Selecione...</option>
            <option *ngFor="let unidade of unidadesDisponiveis" [value]="unidade.id">{{ unidade.nomeFantasia }}</option>
          </select>
        </label>
        <label class="field">Sala de atendimento
          <select formControlName="salaAtendimento" [disabled]="!salasDisponiveis.length">
            <option value="">Selecione...</option>
            <option *ngFor="let sala of salasDisponiveis" [value]="sala.nome">{{ sala.nome }}</option>
          </select>
          <div class="search-hint" *ngIf="salasLoading">Carregando salas...</div>
        </label>
        <label class="field">Carga horária semanal<input type="number" formControlName="cargaHoraria" min="1" placeholder="Horas disponíveis" /></label>
        <label class="field">Status*<select formControlName="status">
            <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
          </select></label>
<div class="field full">
          <p class="field-title">Disponibilidade</p>
          <div class="chips">
            <label *ngFor="let periodo of disponibilidades" class="chip">
              <input type="checkbox" [checked]="selectionChecked(['disponibilidade'], periodo)" (change)="toggleSelection(['disponibilidade'], periodo)" />
              <span>{{ periodo }}</span>
            </label>
          </div>
        </div>

        <div class="field full">
          <p class="field-title">Canais de atendimento</p>
          <div class="chips">
            <label *ngFor="let canal of canais" class="chip">
              <input type="checkbox" [checked]="selectionChecked(['canaisAtendimento'], canal)" (change)="toggleSelection(['canaisAtendimento'], canal)" />
              <span>{{ canal }}</span>
            </label>
          </div>
        </div>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'resumo'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Resumo, observações e palavras-chave para encontrar rápido.</p>
        </div>
      </div>

      <div class="field-grid cols-2">
        <div class="field full">
          <label class="field-title">Palavras-chave</label>
          <div class="tag-input">
            <input
              type="text"
              placeholder="Digite e pressione Enter"
              #tagInput
              (keydown.enter)="addTag(tagInput.value); tagInput.value = ''; $event.preventDefault();"
            />
            <div class="tag-suggestions">
              <button type="button" *ngFor="let tag of tagsSugeridas" (click)="addTag(tag)">{{ tag }}</button>
            </div>
          </div>
          <div class="tag-list" *ngIf="form.value.tags?.length">
            <span class="tag" *ngFor="let tag of form.value.tags">
              {{ tag }}
              <button type="button" (click)="removeTag(tag)">X</button>
            </span>
          </div>
        </div>

        <label class="field">Resumo breve<textarea formControlName="resumo" rows="3" placeholder="Como este profissional contribui?"></textarea></label>
        <label class="field">Observações internas<textarea formControlName="observacoes" rows="3" placeholder="Notas de equipe e agenda"></textarea></label>
      </div>

      <div class="actions">
        <button type="button" class="ghost" (click)="resetForm()">Limpar</button>
        <button type="button" class="ghost" (click)="startNew()">Cancelar</button>
        <button type="submit" class="primary" [disabled]="saving">
          {{ saving ? 'Salvando...' : editingId ? 'Salvar alterações' : 'Cadastrar profissional' }}
        </button>
      </div>
    </div>
    <div class="tab-card" *ngIf="activeTab === 'lista'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Listagem completa para localizar profissionais cadastrados.</p>
        </div>
      </div>

      <div [formGroup]="searchForm" class="list-filters">
        <label class="field">Nome
          <input type="text" formControlName="nome" placeholder="Digite parte do nome" />
        </label>
        <label class="field">Categoria
          <input type="text" formControlName="categoria" placeholder="Ex.: Psicólogo" />
        </label>
        <label class="field">Status
          <select formControlName="status">
            <option value="">Todos</option>
            <option *ngFor="let option of statuses" [value]="option">{{ option }}</option>
          </select>
        </label>
        <div class="list-panel__filter-actions">
          <button type="button" class="btn-outline" (click)="searchProfessionalsList()">Buscar</button>
          <button type="button" class="btn-outline" (click)="clearSearchFilters()">Limpar</button>
        </div>
      </div>

      <div class="unit-list" *ngIf="professionalsPaginados.length">
        <div class="unit-list__item" *ngFor="let professional of professionalsPaginados" (dblclick)="edit(professional)">
          <div>
            <div class="unit-list__name-row">
              <div class="unit-list__avatar" [class.unit-list__avatar--empty]="!professional.foto3x4">
                <img *ngIf="professional.foto3x4" [src]="professional.foto3x4" alt="Foto do profissional" />
                <span *ngIf="!professional.foto3x4" aria-hidden="true">
                  {{ (professional.nomeCompleto || 'P')[0] }}
                </span>
              </div>
              <div>
                <div class="unit-list__header-row">
                  <span class="unit-list__name-text">{{ professional.nomeCompleto }}</span>
                  <span class="pill" [class.success]="professional.status === 'ATIVO'">{{ professional.status }}</span>
                </div>
                <div class="unit-list__info-row">
                  <span class="unit-list__meta-text">Categoria: {{ professional.categoria }}</span>
                  <span class="unit-list__separator">-</span>
                  <span class="unit-list__meta-text">E-mail: {{ professional.email || 'Não informado' }}</span>
                  <span class="unit-list__separator">-</span>
                  <span class="unit-list__meta-text">Telefone: {{ professional.telefone || 'Não informado' }}</span>
                  <span class="unit-list__separator">-</span>
                  <span class="unit-list__meta-text">Unidade: {{ professional.unidade || 'Não informada' }}</span>
                  <span class="unit-list__separator">-</span>
                  <span class="unit-list__meta-text">Sala: {{ professional.salaAtendimento || 'Não informada' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="unit-list__pagination" *ngIf="filteredProfessionals.length && professionalsPaginados.length">
        <span class="unit-list__total">
          Total: {{ filteredProfessionals.length }} profissionais
        </span>
        <button type="button" class="btn-outline" (click)="paginaAnterior()" [disabled]="paginaAtual === 1">
          Anterior
        </button>
        <span class="unit-list__page">
          Página {{ paginaAtual }} de {{ totalPaginas }}
        </span>
        <button type="button" class="btn-outline" (click)="proximaPagina()" [disabled]="paginaAtual >= totalPaginas">
          Próximo
        </button>
      </div>

      <p class="muted" *ngIf="!filteredProfessionals.length">Nenhum profissional cadastrado até o momento.</p>
    </div>

  </form>
    </div>
  </div>

</section>
<app-dialog
  [aberto]="dialogConfirmacaoAberta"
  [titulo]="dialogTitulo"
  [mensagem]="dialogMensagem"
  [confirmarLabel]="dialogConfirmarLabel"
  (confirmar)="confirmarDialogo()"
  (cancelar)="cancelarDialogo()"
></app-dialog>
</app-tela-padrao>



