<section class="cadastro">
  <header class="page-title">
    <p class="page-title__eyebrow">Cadastros</p>
    <p class="page-title__label">Profissionais para atendimentos</p>
    <p class="page-title__description">
      Utilize a mesma jornada do cadastro de voluntários para organizar o quadro profissional, com abas e fontes consistentes.
    </p>
  </header>

  <div class="tab-shell">
    <p class="tab-shell__title">Navegue pelas informações</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of tabs; index as idx"
        class="step-tabs__item"
        [class.active]="activeTab === tab.id"
        [class.completed]="idx < activeTabIndex"
      >
        <button
          class="step-tabs__button"
          type="button"
          role="tab"
          [attr.aria-selected]="activeTab === tab.id"
          (click)="changeTab(tab.id)"
        >
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ tab.label }}</span>
        </button>
      </li>
    </ol>
  </div>

  <div class="metrics-grid">
    <div class="metric">
      <p class="metric__label">Profissionais disponíveis</p>
      <p class="metric__value">{{ totalDisponiveis }}</p>
      <p class="metric__hint">Prontos para novos atendimentos</p>
    </div>
    <div class="metric">
      <p class="metric__label">Atendimento presencial</p>
      <p class="metric__value">{{ totalPresencial }}</p>
      <p class="metric__hint">Escala em unidades e salas</p>
    </div>
    <div class="metric">
      <p class="metric__label">Atendimento online</p>
      <p class="metric__value">{{ totalOnline }}</p>
      <p class="metric__hint">Teleatendimento e orientações</p>
    </div>
  </div>

  <form [formGroup]="form" (ngSubmit)="submit()" class="form-shell">
    <div *ngIf="feedback" class="feedback">{{ feedback }}</div>

    <ng-template #navigationControls>
      <div class="tab-actions">
        <button type="button" class="ghost" *ngIf="hasPreviousTab" (click)="goToPreviousTab()">Voltar</button>
        <button type="button" class="ghost" *ngIf="hasNextTab" (click)="goToNextTab()">
          Próximo: {{ nextTabLabel }}
        </button>
        <button type="submit" class="primary" [disabled]="saving" *ngIf="!hasNextTab">
          {{ saving ? 'Salvando...' : editingId ? 'Salvar alterações' : 'Cadastrar profissional' }}
        </button>
      </div>
    </ng-template>

    <div class="tab-card" *ngIf="activeTab === 'perfil'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Identifique o profissional e dados de contato de forma estruturada.</p>
        </div>
        <span class="pill">Obrigatório</span>
      </div>

      <div class="field-grid cols-3">
        <label class="field"
          >Nome completo*<input
            type="text"
            formControlName="nome"
            placeholder="Quem irá atender?"
            (input)="applyCapitalization('nome', $any($event.target).value)"
            (blur)="applyCapitalization('nome', $any($event.target).value)"
        /></label>
        <div class="field category-manager">
          <label class="field-title" for="categoriaSelect">Categoria*</label>
          <select id="categoriaSelect" formControlName="categoria">
            <option *ngFor="let categoria of categorias" [value]="categoria">{{ categoria }}</option>
          </select>
          <div class="category-actions">
            <div class="category-actions__inline">
              <input
                #novaCategoria
                type="text"
                placeholder="Nova categoria"
                (keydown.enter)="addCategoria(novaCategoria.value); novaCategoria.value = ''; $event.preventDefault();"
              />
              <button type="button" class="ghost" (click)="addCategoria(novaCategoria.value); novaCategoria.value = ''">
                Adicionar
              </button>
            </div>
            <div class="category-list">
              <span class="category-chip" *ngFor="let categoria of categorias">
                {{ categoria }}
                <button type="button" class="ghost tiny" (click)="editCategoria(categoria)">Editar</button>
                <button type="button" class="danger ghost tiny" (click)="removeCategoria(categoria)">
                  Remover
                </button>
              </span>
            </div>
          </div>
        </div>
        <label class="field"
          >Especialidade<input
            type="text"
            formControlName="especialidade"
            placeholder="Área principal de atuação"
            (input)="applyCapitalization('especialidade', $any($event.target).value)"
            (blur)="applyCapitalization('especialidade', $any($event.target).value)"
        /></label>
        <label class="field"
          >Registro em conselho<input
            type="text"
            formControlName="registroConselho"
            placeholder="CRESS, CRP, CRM..."
            (input)="applyCapitalization('registroConselho', $any($event.target).value)"
            (blur)="applyCapitalization('registroConselho', $any($event.target).value)"
        /></label>
        <label class="field">E-mail*<input type="email" formControlName="email" placeholder="contato@instituicao.org.br" /></label>
        <label class="field"
          >Telefone/WhatsApp<input
            type="text"
            formControlName="telefone"
            placeholder="(11) 90000-0000"
            (input)="applyCapitalization('telefone', $any($event.target).value)"
            (blur)="applyCapitalization('telefone', $any($event.target).value)"
        /></label>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'agenda'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Combine unidade, status e agenda de atendimento.</p>
        </div>
        <span class="pill">Agenda</span>
      </div>

      <div class="field-grid cols-3">
        <label class="field"
          >Unidade de atendimento<input
            type="text"
            formControlName="unidade"
            placeholder="Unidade, polo ou sala"
            (input)="applyCapitalization('unidade', $any($event.target).value)"
            (blur)="applyCapitalization('unidade', $any($event.target).value)"
        /></label>
        <label class="field">Carga horária semanal<input type="number" formControlName="cargaHoraria" min="1" placeholder="Horas disponíveis" /></label>
        <label class="field">Status*<select formControlName="status">
            <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
          </select></label>
        <div class="field full">
          <p class="field-title">Disponibilidade</p>
          <div class="chips">
            <label *ngFor="let periodo of disponibilidades" class="chip">
              <input type="checkbox" [checked]="selectionChecked(['disponibilidade'], periodo)" (change)="toggleSelection(['disponibilidade'], periodo)" />
              <span>{{ periodo }}</span>
            </label>
          </div>
        </div>

        <div class="field full">
          <p class="field-title">Canais de atendimento</p>
          <div class="chips">
            <label *ngFor="let canal of canais" class="chip">
              <input type="checkbox" [checked]="selectionChecked(['canaisAtendimento'], canal)" (change)="toggleSelection(['canaisAtendimento'], canal)" />
              <span>{{ canal }}</span>
            </label>
          </div>
        </div>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'resumo'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Resumo, observações e palavras-chave para encontrar rápido.</p>
        </div>
        <span class="pill">Finalização</span>
      </div>

      <div class="field-grid cols-2">
        <div class="field full">
          <label class="field-title">Palavras-chave</label>
          <div class="tag-input">
            <input
              type="text"
              placeholder="Digite e pressione Enter"
              #tagInput
              (keydown.enter)="addTag(tagInput.value); tagInput.value = ''; $event.preventDefault();"
            />
            <div class="tag-suggestions">
              <button type="button" *ngFor="let tag of tagsSugeridas" (click)="addTag(tag)">{{ tag }}</button>
            </div>
          </div>
          <div class="tag-list" *ngIf="form.value.tags?.length">
            <span class="tag" *ngFor="let tag of form.value.tags">
              {{ tag }}
              <button type="button" (click)="removeTag(tag)">×</button>
            </span>
          </div>
        </div>

        <label class="field">Resumo breve<textarea formControlName="resumo" rows="3" placeholder="Como este profissional contribui?"></textarea></label>
        <label class="field">Observações internas<textarea formControlName="observacoes" rows="3" placeholder="Notas de equipe e agenda"></textarea></label>
      </div>

      <div class="actions">
        <button type="button" class="ghost" (click)="resetForm()">Limpar</button>
        <button type="button" class="secondary" (click)="startNew()">Cancelar edição</button>
        <button type="submit" class="primary" [disabled]="saving">
          {{ saving ? 'Salvando...' : editingId ? 'Salvar alterações' : 'Cadastrar profissional' }}
        </button>
      </div>
    </div>
  </form>

  <div class="list-card">
    <div class="list-card__header">
      <div>
        <p class="page-title__eyebrow">Profissionais cadastrados</p>
        <p class="page-title__label">Agenda e disponibilidade</p>
      </div>
      <div class="list-card__actions">
        <span class="pill">{{ professionals.length }} no total</span>
        <span class="pill success">{{ totalDisponiveis }} disponíveis</span>
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Especialidade</th>
            <th>Unidade</th>
            <th>Status</th>
            <th>Contato</th>
            <th class="text-right">Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let professional of professionals">
            <td>
              <div class="strong">{{ professional.nome }}</div>
              <div class="muted">{{ professional.categoria }}</div>
            </td>
            <td>{{ professional.especialidade || 'Sem especialidade' }}</td>
            <td>{{ professional.unidade || 'Unidade não informada' }}</td>
            <td>
              <span class="pill" [class.success]="professional.status === 'Disponível'">{{ professional.status }}</span>
              <div class="muted">{{ professional.canaisAtendimento?.join(' • ') || 'Sem canais definidos' }}</div>
            </td>
            <td>
              <div class="muted">{{ professional.email || 'E-mail não informado' }}</div>
              <div class="muted">{{ professional.telefone || 'Telefone não informado' }}</div>
            </td>
            <td class="text-right">
              <div class="row-actions">
                <button type="button" class="ghost" (click)="edit(professional)">Editar</button>
                <button type="button" class="danger" (click)="remove(professional)">Remover</button>
              </div>
            </td>
          </tr>
          <tr *ngIf="!professionals.length">
            <td colspan="6" class="muted">Nenhum profissional cadastrado ainda.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>
