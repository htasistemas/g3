<section class="cadastro">
  <header class="page-title">
    <p class="page-title__eyebrow">Cadastros</p>
    <p class="page-title__label">Profissionais para atendimentos</p>
    <p class="page-title__description">
      Utilize a mesma jornada do cadastro de voluntários para organizar o quadro profissional, com abas e fontes consistentes.
    </p>
  </header>

  <div class="tab-shell">
    <p class="tab-shell__title">Navegue pelas informações</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of tabs; index as idx"
        class="step-tabs__item"
        [class.active]="activeTab === tab.id"
        [class.completed]="idx < activeTabIndex"
      >
        <button
          class="step-tabs__button"
          type="button"
          role="tab"
          [attr.aria-selected]="activeTab === tab.id"
          (click)="changeTab(tab.id)"
        >
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ tab.label }}</span>
        </button>
      </li>
    </ol>
  </div>

  <div class="metrics-grid">
    <div class="metric">
      <p class="metric__label">Profissionais disponíveis</p>
      <p class="metric__value">{{ totalDisponiveis }}</p>
      <p class="metric__hint">Prontos para novos atendimentos</p>
    </div>
    <div class="metric">
      <p class="metric__label">Atendimento presencial</p>
      <p class="metric__value">{{ totalPresencial }}</p>
      <p class="metric__hint">Escala em unidades e salas</p>
    </div>
    <div class="metric">
      <p class="metric__label">Atendimento online</p>
      <p class="metric__value">{{ totalOnline }}</p>
      <p class="metric__hint">Teleatendimento e orientações</p>
    </div>
  </div>

  <form [formGroup]="form" (ngSubmit)="submit()" class="form-shell">
    <div *ngIf="feedback" class="feedback">{{ feedback }}</div>

    <ng-template #navigationControls>
      <div class="tab-actions">
        <button type="button" class="ghost" *ngIf="hasPreviousTab" (click)="goToPreviousTab()">Voltar</button>
        <button type="button" class="ghost" *ngIf="hasNextTab" (click)="goToNextTab()">
          Próximo: {{ nextTabLabel }}
        </button>
        <button type="submit" class="primary" [disabled]="saving" *ngIf="!hasNextTab">
          {{ saving ? 'Salvando...' : editingId ? 'Salvar alterações' : 'Cadastrar profissional' }}
        </button>
      </div>
    </ng-template>

    <div class="tab-card" *ngIf="activeTab === 'perfil'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Identifique o profissional e dados de contato de forma estruturada.</p>
        </div>
        <div class="tab-card__header-actions">
          <span class="pill">Obrigatório</span>
          <div class="nav-buttons" aria-label="Ações rápidas do profissional">
            <button type="button" class="nav-button" (click)="printProfessional()">
              <span class="nav-button__icon" aria-hidden="true">
                <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M6 4.5C6 3.67157 6.67157 3 7.5 3H12.5C13.3284 3 14 3.67157 14 4.5V6H6V4.5Z"
                    fill="currentColor"
                  />
                  <path
                    fill-rule="evenodd"
                    clip-rule="evenodd"
                    d="M5 6H15C16.1046 6 17 6.89543 17 8V11.5C17 12.3284 16.3284 13 15.5 13H14V14.5C14 15.3284 13.3284 16 12.5 16H7.5C6.67157 16 6 15.3284 6 14.5V13H4.5C3.67157 13 3 12.3284 3 11.5V8C3 6.89543 3.89543 6 5 6ZM7.5 8.75C7.22386 8.75 7 8.97386 7 9.25C7 9.52614 7.22386 9.75 7.5 9.75H12.5C12.7761 9.75 13 9.52614 13 9.25C13 8.97386 12.7761 8.75 12.5 8.75H7.5Z"
                    fill="currentColor"
                  />
                </svg>
              </span>
              <span class="nav-button__label">Imprimir dados</span>
            </button>
            <button type="button" class="nav-button" (click)="submit()">
              <span class="nav-button__icon" aria-hidden="true">
                <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M5 3C4.44772 3 4 3.44772 4 4V16C4 16.5523 4.44772 17 5 17H15C15.5523 17 16 16.5523 16 16V6.41421C16 6.149 15.8946 5.89464 15.7071 5.70711L13.2929 3.29289C13.1054 3.10536 12.851 3 12.5858 3H5Z"
                    stroke="currentColor"
                    stroke-width="1.25"
                  />
                  <path d="M7 3.5H12V7H7V3.5Z" fill="currentColor" />
                  <rect x="7" y="11.5" width="6" height="3" rx="0.5" fill="currentColor" />
                </svg>
              </span>
              <span class="nav-button__label">Salvar</span>
            </button>
            <button type="button" class="nav-button" (click)="resetForm()">
              <span class="nav-button__icon" aria-hidden="true">
                <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M4.5 10C4.5 7.51472 6.51472 5.5 9 5.5H12.5"
                    stroke="currentColor"
                    stroke-width="1.25"
                    stroke-linecap="round"
                  />
                  <path
                    d="M12 3.5L14.5 5.75L12 8"
                    stroke="currentColor"
                    stroke-width="1.25"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M15.5 10C15.5 12.4853 13.4853 14.5 11 14.5H7.5"
                    stroke="currentColor"
                    stroke-width="1.25"
                    stroke-linecap="round"
                  />
                  <path
                    d="M8 16.5L5.5 14.25L8 12"
                    stroke="currentColor"
                    stroke-width="1.25"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </span>
              <span class="nav-button__label">Cancelar</span>
            </button>
            <button type="button" class="nav-button nav-button--danger" *ngIf="editingId" (click)="removeCurrent()">
              <span class="nav-button__icon" aria-hidden="true">
                <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M8 3.5H12C12.2761 3.5 12.5 3.72386 12.5 4V4.5H16"
                    stroke="currentColor"
                    stroke-width="1.25"
                    stroke-linecap="round"
                  />
                  <path d="M4 4.5H7.5V4C7.5 3.72386 7.72386 3.5 8 3.5" stroke="currentColor" stroke-width="1.25" />
                  <path
                    d="M6.5 7.5V15.5C6.5 16.0523 6.94772 16.5 7.5 16.5H12.5C13.0523 16.5 13.5 16.0523 13.5 15.5V7.5"
                    stroke="currentColor"
                    stroke-width="1.25"
                    stroke-linecap="round"
                  />
                  <path d="M9.25 9.5V14" stroke="currentColor" stroke-width="1.25" stroke-linecap="round" />
                  <path d="M10.75 9.5V14" stroke="currentColor" stroke-width="1.25" stroke-linecap="round" />
                </svg>
              </span>
              <span class="nav-button__label">Excluir</span>
            </button>
            <button type="button" class="nav-button" (click)="startNew()">
              <span class="nav-button__icon" aria-hidden="true">
                <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M10 4.5V15.5"
                    stroke="currentColor"
                    stroke-width="1.25"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M4.5 10H15.5"
                    stroke="currentColor"
                    stroke-width="1.25"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </span>
              <span class="nav-button__label">Novo</span>
            </button>
            <button type="button" class="nav-button" (click)="closeForm()">
              <span class="nav-button__icon" aria-hidden="true">
                <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M6.5 6.5L13.5 13.5"
                    stroke="currentColor"
                    stroke-width="1.25"
                    stroke-linecap="round"
                  />
                  <path
                    d="M13.5 6.5L6.5 13.5"
                    stroke="currentColor"
                    stroke-width="1.25"
                    stroke-linecap="round"
                  />
                </svg>
              </span>
              <span class="nav-button__label">Fechar</span>
            </button>
          </div>
        </div>
      </div>

      <div class="field-grid cols-3">
        <label class="field"
          >Nome completo*<input
            type="text"
            formControlName="nome"
            placeholder="Quem irá atender?"
            (input)="applyCapitalization('nome', $any($event.target).value)"
            (blur)="applyCapitalization('nome', $any($event.target).value)"
        /></label>
        <div class="field category-manager">
          <label class="field-title" for="categoriaSelect">Categoria*</label>
          <select id="categoriaSelect" formControlName="categoria">
            <option *ngFor="let categoria of categorias" [value]="categoria">{{ categoria }}</option>
          </select>
          <div class="category-actions">
            <div class="category-actions__inline">
              <input
                #novaCategoria
                type="text"
                placeholder="Nova categoria"
                (keydown.enter)="addCategoria(novaCategoria.value); novaCategoria.value = ''; $event.preventDefault();"
              />
              <button type="button" class="ghost" (click)="addCategoria(novaCategoria.value); novaCategoria.value = ''">
                Adicionar
              </button>
            </div>
            <div class="category-list">
              <span class="category-chip" *ngFor="let categoria of categorias">
                {{ categoria }}
                <button type="button" class="ghost tiny" (click)="editCategoria(categoria)">Editar</button>
                <button type="button" class="danger ghost tiny" (click)="removeCategoria(categoria)">
                  Remover
                </button>
              </span>
            </div>
          </div>
        </div>
        <label class="field"
          >Especialidade<input
            type="text"
            formControlName="especialidade"
            placeholder="Área principal de atuação"
            (input)="applyCapitalization('especialidade', $any($event.target).value)"
            (blur)="applyCapitalization('especialidade', $any($event.target).value)"
        /></label>
        <label class="field"
          >Registro em conselho<input
            type="text"
            formControlName="registroConselho"
            placeholder="CRESS, CRP, CRM..."
            (input)="applyCapitalization('registroConselho', $any($event.target).value)"
            (blur)="applyCapitalization('registroConselho', $any($event.target).value)"
        /></label>
        <label class="field">E-mail*<input type="email" formControlName="email" placeholder="contato@instituicao.org.br" /></label>
        <label class="field"
          >Telefone/WhatsApp<input
            type="text"
            formControlName="telefone"
            placeholder="(11) 90000-0000"
            (input)="applyCapitalization('telefone', $any($event.target).value)"
            (blur)="applyCapitalization('telefone', $any($event.target).value)"
        /></label>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'agenda'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Combine unidade, status e agenda de atendimento.</p>
        </div>
        <span class="pill">Agenda</span>
      </div>

      <div class="field-grid cols-3">
        <label class="field"
          >Unidade de atendimento<input
            type="text"
            formControlName="unidade"
            placeholder="Unidade, polo ou sala"
            (input)="applyCapitalization('unidade', $any($event.target).value)"
            (blur)="applyCapitalization('unidade', $any($event.target).value)"
        /></label>
        <label class="field">Carga horária semanal<input type="number" formControlName="cargaHoraria" min="1" placeholder="Horas disponíveis" /></label>
        <label class="field">Status*<select formControlName="status">
            <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
          </select></label>
        <div class="field full">
          <p class="field-title">Disponibilidade</p>
          <div class="chips">
            <label *ngFor="let periodo of disponibilidades" class="chip">
              <input type="checkbox" [checked]="selectionChecked(['disponibilidade'], periodo)" (change)="toggleSelection(['disponibilidade'], periodo)" />
              <span>{{ periodo }}</span>
            </label>
          </div>
        </div>

        <div class="field full">
          <p class="field-title">Canais de atendimento</p>
          <div class="chips">
            <label *ngFor="let canal of canais" class="chip">
              <input type="checkbox" [checked]="selectionChecked(['canaisAtendimento'], canal)" (change)="toggleSelection(['canaisAtendimento'], canal)" />
              <span>{{ canal }}</span>
            </label>
          </div>
        </div>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'resumo'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Resumo, observações e palavras-chave para encontrar rápido.</p>
        </div>
        <span class="pill">Finalização</span>
      </div>

      <div class="field-grid cols-2">
        <div class="field full">
          <label class="field-title">Palavras-chave</label>
          <div class="tag-input">
            <input
              type="text"
              placeholder="Digite e pressione Enter"
              #tagInput
              (keydown.enter)="addTag(tagInput.value); tagInput.value = ''; $event.preventDefault();"
            />
            <div class="tag-suggestions">
              <button type="button" *ngFor="let tag of tagsSugeridas" (click)="addTag(tag)">{{ tag }}</button>
            </div>
          </div>
          <div class="tag-list" *ngIf="form.value.tags?.length">
            <span class="tag" *ngFor="let tag of form.value.tags">
              {{ tag }}
              <button type="button" (click)="removeTag(tag)">×</button>
            </span>
          </div>
        </div>

        <label class="field">Resumo breve<textarea formControlName="resumo" rows="3" placeholder="Como este profissional contribui?"></textarea></label>
        <label class="field">Observações internas<textarea formControlName="observacoes" rows="3" placeholder="Notas de equipe e agenda"></textarea></label>
      </div>

      <div class="actions">
        <button type="button" class="ghost" (click)="resetForm()">Limpar</button>
        <button type="button" class="secondary" (click)="startNew()">Cancelar edição</button>
        <button type="submit" class="primary" [disabled]="saving">
          {{ saving ? 'Salvando...' : editingId ? 'Salvar alterações' : 'Cadastrar profissional' }}
        </button>
      </div>
    </div>
  </form>

  <div class="list-card">
    <div class="list-card__header">
      <div>
        <p class="page-title__eyebrow">Profissionais cadastrados</p>
        <p class="page-title__label">Agenda e disponibilidade</p>
      </div>
      <div class="list-card__actions">
        <span class="pill">{{ professionals.length }} no total</span>
        <span class="pill success">{{ totalDisponiveis }} disponíveis</span>
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Especialidade</th>
            <th>Unidade</th>
            <th>Status</th>
            <th>Contato</th>
            <th class="text-right">Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let professional of professionals">
            <td>
              <div class="strong">{{ professional.nome }}</div>
              <div class="muted">{{ professional.categoria }}</div>
            </td>
            <td>{{ professional.especialidade || 'Sem especialidade' }}</td>
            <td>{{ professional.unidade || 'Unidade não informada' }}</td>
            <td>
              <span class="pill" [class.success]="professional.status === 'Disponível'">{{ professional.status }}</span>
              <div class="muted">{{ professional.canaisAtendimento?.join(' • ') || 'Sem canais definidos' }}</div>
            </td>
            <td>
              <div class="muted">{{ professional.email || 'E-mail não informado' }}</div>
              <div class="muted">{{ professional.telefone || 'Telefone não informado' }}</div>
            </td>
            <td class="text-right">
              <div class="row-actions">
                <button type="button" class="ghost" (click)="edit(professional)">Editar</button>
                <button type="button" class="danger" (click)="remove(professional)">Remover</button>
              </div>
            </td>
          </tr>
          <tr *ngIf="!professionals.length">
            <td colspan="6" class="muted">Nenhum profissional cadastrado ainda.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>
