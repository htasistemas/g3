<app-tela-padrao
  [acoes]="acoesTopo"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  (imprimir)="imprimirCompleto()"
  (buscar)="onBuscar()"
  (fechar)="cancelarSelecao()"
>
  <header class="page-title page-title--row" slot="titulo">
    <div>
    <p class="page-title__eyebrow">ATENDIMENTOS</p>
    <p class="page-title__label">Prontu&aacute;rio social</p>
    </div>
    <p class="page-title__note">Historico e registros do prontuario do beneficiario.</p>
  </header>

  <section class="cadastro">
    <app-popup-messages [mensagens]="popupErros" (fechar)="popupErros = []"></app-popup-messages>

    <div class="prontuario-card">
      <app-prontuario-filtros
        [mostrarBuscaBeneficiario]="!beneficiarioId"
        [filtros]="filtros"
        [beneficiarioSelecionado]="beneficiarioSelecionado"
        [opcoesBeneficiarios]="opcoesBeneficiarios"
        [opcoesProfissionais]="opcoesProfissionais"
        [opcoesUnidades]="opcoesUnidades"
        [termoBusca]="termoBusca"
        [carregandoBeneficiarios]="carregandoBeneficiarios"
        [erroBeneficiarios]="erroBeneficiarios"
        (termoBuscaChange)="onTermoBuscaChange($event)"
        (selecionarBeneficiario)="selecionarBeneficiario($event)"
        (filtrosChange)="atualizarFiltros($event)"
        (limpar)="limparFiltros()"
      ></app-prontuario-filtros>
    </div>

    <div class="prontuario-grid" *ngIf="beneficiarioId; else selecioneBeneficiario">
      <aside class="prontuario-resumo">
        <div class="resumo-card" *ngIf="resumo">
          <div class="resumo-card__foto" [class.resumo-card__foto--empty]="!resumo.beneficiario.foto3x4">
            <img *ngIf="resumo.beneficiario.foto3x4" [src]="resumo.beneficiario.foto3x4" alt="Foto do beneficiÃ¡rio" />
            <span *ngIf="!resumo.beneficiario.foto3x4">Sem foto</span>
          </div>
          <div class="resumo-card__info">
            <h3>{{ resumo.beneficiario.nomeCompleto }}</h3>
            <p>CPF/NIS: {{ resumo.beneficiario.cpf || 'NÃ£o informado' }} / {{ resumo.beneficiario.nis || 'NÃ£o informado' }}</p>
            <p>FamÃ­lia de referÃªncia: {{ resumo.beneficiario.familiaReferencia || 'NÃ£o informada' }}</p>
            <p>Nascimento: {{ formatarDataNascimento(resumo.beneficiario.dataNascimento) }}</p>
            <p>Nome da mae: {{ resumo.beneficiario.nomeMae || 'NÃ£o informado' }}</p>
            <p>Telefone: {{ resumo.beneficiario.telefone || 'NÃ£o informado' }}</p>
            <p>WhatsApp: {{ resumo.beneficiario.whatsapp || 'NÃ£o informado' }}</p>
            <p>EndereÃ§o: {{ resumo.beneficiario.endereco || 'NÃ£o informado' }}</p>
          </div>
          <div class="resumo-card__tags">
            <span class="pill">{{ resumo.beneficiario.status || 'Sem status' }}</span>
        <span class="pill pill--ghost" *ngIf="resumo.ultimaAtualizacao">
          Atualizado em {{ resumo.ultimaAtualizacao | date: 'dd/MM/yyyy' }}
        </span>
            <span class="pill pill--ghost" *ngFor="let vulnerabilidade of resumo.beneficiario.vulnerabilidades || []">
              {{ vulnerabilidade }}
            </span>
          </div>
          <div class="resumo-card__actions">
            <button class="ghost" type="button" (click)="imprimirResumo()">Imprimir resumo</button>
            <button class="ghost" type="button" (click)="imprimirCompleto()">Imprimir prontuario completo</button>
          </div>
        </div>

        <div class="resumo-card" *ngIf="resumo">
          <h4>Indicadores</h4>
          <app-prontuario-indicadores
            [contagens]="resumo.contagens"
            [indicadoresResumo]="resumo.indicadores"
          ></app-prontuario-indicadores>
        </div>
      </aside>

      <section class="prontuario-conteudo">
        <div class="tab-shell">
          <p class="tab-shell__title">Navegue pelas informa&ccedil;&otilde;es</p>
          <ol class="step-tabs" role="tablist">
            <li
              *ngFor="let aba of abas; index as idx"
              class="step-tabs__item"
              [class.active]="abaAtiva === aba.id"
              [class.completed]="idx < abaAtivaIndex"
            >
              <button
                class="step-tabs__button"
                type="button"
                role="tab"
                [attr.aria-selected]="abaAtiva === aba.id"
                (click)="selecionarAba(aba.id, aba.tipo)"
              >
                <span class="step-tabs__index">{{ idx + 1 }}</span>
                <span class="step-tabs__label">{{ aba.label }}</span>
              </button>
            </li>
          </ol>
        </div>

        <div class="prontuario-conteudo__body">
          <div class="prontuario-card" [class.prontuario-card--timeline]="abaAtiva === 'linha'">
            <app-prontuario-timeline
              *ngIf="abaAtiva !== 'indicadores'"
              [registros]="registros"
              [mapaProfissionais]="mapaProfissionais"
              [mapaUnidades]="mapaUnidades"
              [total]="totalRegistros"
              [carregando]="carregandoRegistros"
              [pagina]="filtros.page || 0"
              [tamanhoPagina]="filtros.pageSize || 10"
              (carregarMais)="carregarMais()"
              (filtrarTipo)="aplicarFiltroTipo($event)"
              (filtrarProfissional)="aplicarFiltroProfissional($event)"
              (filtrarUnidade)="aplicarFiltroUnidade($event)"
            ></app-prontuario-timeline>

            <div *ngIf="abaAtiva === 'indicadores'">
              <app-prontuario-indicadores
                *ngIf="resumo"
                [contagens]="resumo.contagens"
                [indicadoresResumo]="resumo.indicadores"
              ></app-prontuario-indicadores>
          </div>
          </div>
        </div>
      </section>
    </div>

    <ng-template #selecioneBeneficiario>
      <div class="empty-state">Selecione um beneficiÃ¡rio para visualizar o prontuario.</div>
    </ng-template>
  </section>

  <div class="print-area" [class.print-area--active]="modoImpressao === 'resumo'">
    <h1>ProntuÃ¡rio - Resumo</h1>
    <p *ngIf="resumo">BeneficiÃ¡rio: {{ resumo.beneficiario.nomeCompleto }}</p>
    <p *ngIf="resumo">CPF/NIS: {{ resumo.beneficiario.cpf || 'NÃ£o informado' }} / {{ resumo.beneficiario.nis || 'NÃ£o informado' }}</p>
    <p *ngIf="resumo">EndereÃ§o: {{ resumo.beneficiario.endereco || 'NÃ£o informado' }}</p>
    <p *ngIf="resumo">FamÃ­lia de referÃªncia: {{ resumo.beneficiario.familiaReferencia || 'NÃ£o informada' }}</p>
    <h2>ultimos registros</h2>
    <ul>
      <li *ngFor="let registro of registros | slice:0:5">
        {{ registro.dataRegistro | date: 'dd/MM/yyyy HH:mm' }} - {{ registro.tipo }} - {{ registro.titulo || 'Sem titulo' }}
      </li>
    </ul>
  </div>

  <div class="print-area" [class.print-area--active]="modoImpressao === 'completo'">
    <h1>ProntuÃ¡rio completo</h1>
    <p *ngIf="resumo">BeneficiÃ¡rio: {{ resumo.beneficiario.nomeCompleto }}</p>
    <ul>
      <li *ngFor="let registro of registros">
        {{ registro.dataRegistro | date: 'dd/MM/yyyy HH:mm' }} - {{ registro.tipo }} - {{ registro.descricao }}
      </li>
    </ul>
  </div>
</app-tela-padrao>



