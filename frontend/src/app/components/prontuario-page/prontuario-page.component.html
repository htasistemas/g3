<app-tela-padrao
  [acoes]="acoesTopo"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  [fullWidth]="true"
  (imprimir)="imprimirCompleto()"
  (buscar)="onBuscar()"
  (fechar)="cancelarSelecao()"
>
  <section class="cadastro">
    <app-popup-messages [mensagens]="popupErros" (fechar)="popupErros = []"></app-popup-messages>
    <div class="cadastro-layout">
      <aside class="cadastro-menu">
        <div class="tab-shell">
          <p class="tab-shell__title tab-shell__title--destaque">
            <fa-icon [icon]="faNotesMedical" class="tab-shell__icon"></fa-icon>
            Prontuário social
          </p>
          <ol class="step-tabs" role="tablist">
            <li
              *ngFor="let aba of abas; index as idx"
              class="step-tabs__item"
              [class.active]="abaAtiva === aba.id"
              [class.completed]="idx < abaAtivaIndex"
            >
              <button
                class="step-tabs__button"
                type="button"
                role="tab"
                [attr.aria-selected]="abaAtiva === aba.id"
                (click)="selecionarAba(aba.id, aba.tipo)"
              >
                <span class="step-tabs__index">{{ idx + 1 }}</span>
                <span class="step-tabs__label">{{ aba.label }}</span>
              </button>
            </li>
          </ol>
        </div>
      </aside>

      <div class="cadastro-conteudo">
        <section class="tab-card">
          <div class="tab-card__header">
            <div class="tab-card__title-stack">
              <p class="tab-card__highlight">Filtros</p>
            </div>
          </div>
          <app-prontuario-filtros
            [mostrarBuscaBeneficiario]="!beneficiarioId"
            [filtros]="filtros"
            [beneficiarioSelecionado]="beneficiarioSelecionado"
            [opcoesBeneficiarios]="opcoesBeneficiarios"
            [opcoesProfissionais]="opcoesProfissionais"
            [opcoesUnidades]="opcoesUnidades"
            [termoBusca]="termoBusca"
            [carregandoBeneficiarios]="carregandoBeneficiarios"
            [erroBeneficiarios]="erroBeneficiarios"
            (termoBuscaChange)="onTermoBuscaChange($event)"
            (selecionarBeneficiario)="selecionarBeneficiario($event)"
            (filtrosChange)="atualizarFiltros($event)"
            (limpar)="limparFiltros()"
          ></app-prontuario-filtros>
        </section>

        <div class="prontuario-grid" *ngIf="beneficiarioId; else selecioneBeneficiario">
          <aside class="prontuario-resumo">
            <section class="tab-card" *ngIf="resumo">
              <div class="tab-card__header">
                <div class="tab-card__title-stack">
                  <p class="tab-card__highlight">Resumo do beneficiário</p>
                </div>
              </div>
              <div class="resumo-card">
                <div class="resumo-card__foto" [class.resumo-card__foto--empty]="!resumo.beneficiario.foto3x4">
                  <img *ngIf="resumo.beneficiario.foto3x4" [src]="resumo.beneficiario.foto3x4" alt="Foto do beneficiário" />
                  <span *ngIf="!resumo.beneficiario.foto3x4">Sem foto</span>
                </div>
                <div class="resumo-card__info">
                  <h3>{{ resumo.beneficiario.nomeCompleto }}</h3>
                  <p>CPF/NIS: {{ resumo.beneficiario.cpf || 'Não informado' }} / {{ resumo.beneficiario.nis || 'Não informado' }}</p>
                  <p>Família de referência: {{ resumo.beneficiario.familiaReferencia || 'Não informada' }}</p>
                  <p>Nascimento: {{ formatarDataNascimento(resumo.beneficiario.dataNascimento) }}</p>
                  <p>Nome da mãe: {{ resumo.beneficiario.nomeMae || 'Não informado' }}</p>
                  <p>Telefone: {{ resumo.beneficiario.telefone || 'Não informado' }}</p>
                  <p>WhatsApp: {{ resumo.beneficiario.whatsapp || 'Não informado' }}</p>
                  <p>Endereço: {{ resumo.beneficiario.endereco || 'Não informado' }}</p>
                </div>
                <div class="resumo-card__tags">
                  <span class="pill">{{ resumo.beneficiario.status || 'Sem status' }}</span>
                  <span class="pill pill--ghost" *ngIf="resumo.ultimaAtualizacao">
                    Atualizado em {{ resumo.ultimaAtualizacao | date: 'dd/MM/yyyy' }}
                  </span>
                  <span class="pill pill--ghost" *ngFor="let vulnerabilidade of resumo.beneficiario.vulnerabilidades || []">
                    {{ vulnerabilidade }}
                  </span>
                </div>
                <div class="resumo-card__actions">
                  <button class="ghost" type="button" (click)="imprimirResumo()">Imprimir resumo</button>
                  <button class="ghost" type="button" (click)="imprimirCompleto()">Imprimir prontuário completo</button>
                </div>
              </div>
            </section>

            <section class="tab-card" *ngIf="resumo">
              <div class="tab-card__header">
                <div class="tab-card__title-stack">
                  <p class="tab-card__highlight">Indicadores</p>
                </div>
              </div>
              <app-prontuario-indicadores
                [contagens]="resumo.contagens"
                [indicadoresResumo]="resumo.indicadores"
              ></app-prontuario-indicadores>
            </section>
          </aside>

          <section class="prontuario-conteudo">
            <section class="tab-card" [class.prontuario-card--timeline]="abaAtiva === 'linha'">
              <div class="tab-card__header">
                <div class="tab-card__title-stack">
                  <p class="tab-card__highlight">{{ labelAbaAtiva }}</p>
                </div>
              </div>
              <div class="prontuario-conteudo__body">
                <app-prontuario-timeline
                  *ngIf="abaAtiva !== 'indicadores'"
                  [registros]="registrosVisiveis"
                  [mapaProfissionais]="mapaProfissionais"
                  [mapaUnidades]="mapaUnidades"
                  [total]="totalRegistrosVisiveis"
                  [carregando]="carregandoRegistros"
                  [pagina]="filtros.page || 0"
                  [tamanhoPagina]="filtros.pageSize || 10"
                  (carregarMais)="carregarMais()"
                  (filtrarTipo)="aplicarFiltroTipo($event)"
                  (filtrarProfissional)="aplicarFiltroProfissional($event)"
                  (filtrarUnidade)="aplicarFiltroUnidade($event)"
                ></app-prontuario-timeline>

                <div *ngIf="abaAtiva === 'indicadores'">
                  <app-prontuario-indicadores
                    *ngIf="resumo"
                    [contagens]="resumo.contagens"
                    [indicadoresResumo]="resumo.indicadores"
                  ></app-prontuario-indicadores>
                </div>
              </div>
            </section>
          </section>
        </div>

    <ng-template #selecioneBeneficiario>
      <div class="empty-state">Selecione um beneficiário para visualizar o prontuário.</div>
    </ng-template>
      </div>
    </div>
  </section>

  <div class="print-area" [class.print-area--active]="modoImpressao === 'resumo'">
    <h1>Prontuário - Resumo</h1>
    <p *ngIf="resumo">Beneficiário: {{ resumo.beneficiario.nomeCompleto }}</p>
    <p *ngIf="resumo">CPF/NIS: {{ resumo.beneficiario.cpf || 'Não informado' }} / {{ resumo.beneficiario.nis || 'Não informado' }}</p>
    <p *ngIf="resumo">Endereço: {{ resumo.beneficiario.endereco || 'Não informado' }}</p>
    <p *ngIf="resumo">Família de referência: {{ resumo.beneficiario.familiaReferencia || 'Não informada' }}</p>
    <h2>Últimos registros</h2>
    <ul>
      <li *ngFor="let registro of registros | slice:0:5">
        {{ registro.dataRegistro | date: 'dd/MM/yyyy HH:mm' }} - {{ registro.tipo }} - {{ registro.titulo || 'Sem título' }}
      </li>
    </ul>
  </div>

  <div class="print-area" [class.print-area--active]="modoImpressao === 'completo'">
    <h1>Prontuário completo</h1>
    <p *ngIf="resumo">Beneficiário: {{ resumo.beneficiario.nomeCompleto }}</p>
    <ul>
      <li *ngFor="let registro of registros">
        {{ registro.dataRegistro | date: 'dd/MM/yyyy HH:mm' }} - {{ registro.tipo }} - {{ registro.descricao }}
      </li>
    </ul>
  </div>
</app-tela-padrao>









