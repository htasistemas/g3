<app-tela-padrao
  [fullWidth]="true"
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  (salvar)="onSalvar()"
  (excluir)="onExcluir()"
  (novo)="onNovo()"
  (cancelar)="onCancelar()"
  (imprimir)="onImprimir()"
  (buscar)="onBuscar()"
>
<section class="cadastro">
  <app-popup-messages [mensagens]="popupErros" (fechar)="fecharPopupErros()"></app-popup-messages>

  <div class="cadastro-layout">
    <aside class="cadastro-menu">
      <div class="tab-shell">
        <p class="tab-shell__title tab-shell__title--destaque">
          <fa-icon [icon]="faHandshake" class="tab-shell__icon"></fa-icon>
          Recebimento de doações
        </p>
        <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of tabs; index as idx"
        class="step-tabs__item"
        [class.active]="activeTab === tab.id"
        [class.completed]="idx < getTabIndex(activeTab)"
      >
        <button
          class="step-tabs__button"
          type="button"
          role="tab"
          [attr.aria-selected]="activeTab === tab.id"
          (click)="changeTab(tab.id)"
        >
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ tab.label }}</span>
        </button>
      </li>
    </ol>
      </div>
    </aside>
    <div class="cadastro-conteudo">

  <div class="tab-card" *ngIf="activeTab === 'doador'" [formGroup]="doadorForm">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">Cadastro do doador</p>
      </div>
    </div>

    <div class="field-grid cols-2 doador-grid" [class.doador-grid--juridica]="isPessoaJuridica">
      <label class="field field--tipo-pessoa">Tipo de pessoa (*)
        <select formControlName="tipoPessoa" (change)="onTipoPessoaChange()">
          <option value="FISICA">Física</option>
          <option value="JURIDICA">Jurídica</option>
        </select>
      </label>
      <label class="field field--nome">Nome (*)
        <input formControlName="nome" (blur)="onSentenceCaseBlur($event)" />
        <p class="field-error" *ngIf="doadorForm.get('nome')?.invalid && doadorForm.get('nome')?.touched">
          Informe o nome do doador.
        </p>
      </label>
      <label class="field field--documento">{{ documentoLabel }} (*)
        <input formControlName="documento" [placeholder]="documentoPlaceholder" (input)="onDocumentoInput($event)" />
        <p class="field-error" *ngIf="doadorForm.get('documento')?.invalid && doadorForm.get('documento')?.touched">
          Informe um {{ isPessoaJuridica ? 'CNPJ' : 'CPF' }} válido.
        </p>
      </label>
      <label class="field field--responsavel-empresa" *ngIf="isPessoaJuridica">Responsável pela empresa (*)
        <input formControlName="responsavelEmpresa" (blur)="onSentenceCaseBlur($event)" />
        <p class="field-error" *ngIf="doadorForm.get('responsavelEmpresa')?.invalid && doadorForm.get('responsavelEmpresa')?.touched">
          Informe o responsável pela empresa.
        </p>
      </label>
      <label class="field field--email">Email
        <input formControlName="email" type="email" placeholder="nome@exemplo.com" />
        <p class="field-error" *ngIf="doadorForm.get('email')?.invalid && doadorForm.get('email')?.touched">
          Informe um e-mail válido.
        </p>
      </label>
      <label class="field field--telefone">Telefone
        <input formControlName="telefone" placeholder="(00) 00000-0000" (input)="onTelefoneInput($event)" (blur)="onSentenceCaseBlur($event)" />
        <p class="field-error" *ngIf="doadorForm.get('telefone')?.invalid && doadorForm.get('telefone')?.touched">
          Informe um telefone válido.
        </p>
      </label>
      <label class="field full">Logradouro
        <input formControlName="logradouro" (blur)="onSentenceCaseBlur($event)" />
      </label>
      <label class="field">Número
        <input formControlName="numero" />
      </label>
      <label class="field">Complemento
        <input formControlName="complemento" (blur)="onSentenceCaseBlur($event)" />
      </label>
      <label class="field">Bairro
        <input formControlName="bairro" (blur)="onSentenceCaseBlur($event)" />
      </label>
      <label class="field">Cidade
        <input formControlName="cidade" (blur)="onSentenceCaseBlur($event)" />
      </label>
      <label class="field">UF
        <input formControlName="uf" maxlength="2" />
      </label>
      <label class="field">CEP
        <input formControlName="cep" placeholder="00000-000" (input)="onCepInput($event)" />
      </label>
      <label class="field full field--observacoes">Observações
        <textarea formControlName="observacoes" rows="3" (blur)="onSentenceCaseBlur($event)"></textarea>
      </label>
    </div>
    <div class="tab-actions">
      <button type="button" class="primary" (click)="salvarDoadorSemDoacao()">Salvar doador</button>
      <button type="button" class="ghost" (click)="changeTab('dados')">Avançar para doação</button>
    </div>
  </div>

  <div class="tab-card" *ngIf="activeTab === 'doadores'">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">Listagem de doadores</p>
      </div>
      <div class="tab-card__header-actions">
        <button type="button" class="btn-outline" (click)="carregarDoadores()">Atualizar</button>
      </div>
    </div>

    <div class="table-wrapper" *ngIf="doadores.length; else emptyDoadores">
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Documento</th>
            <th>Email</th>
            <th>Telefone</th>
            <th class="text-right">Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let doador of doadores" [class.is-selected]="doador.id === doadorSelecionadoId">
            <td class="strong">{{ doador.nome }}</td>
            <td>{{ doador.documento || '---' }}</td>
            <td>{{ doador.email || '---' }}</td>
            <td>{{ doador.telefone || '---' }}</td>
            <td class="text-right">
              <button type="button" class="ghost" (click)="selecionarDoador(doador)">Selecionar</button>
              <button type="button" class="ghost ghost--danger" (click)="abrirDialogoExcluirDoador(doador)">Excluir</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <ng-template #emptyDoadores>
      <div class="empty">
        <fa-icon [icon]="faUserPlus"></fa-icon>
        <div class="loading-block" *ngIf="carregandoDoadores">
          <span class="spinner" aria-hidden="true"></span>
          <p>Carregando doadores...</p>
        </div>
        <p *ngIf="!carregandoDoadores">Nenhum doador cadastrado.</p>
      </div>
    </ng-template>
  </div>

  <app-dialog
    [aberto]="dialogExcluirDoadorAberto"
    titulo="Excluir doador"
    mensagem="Deseja excluir este doador?"
    confirmarLabel="Excluir"
    cancelarLabel="Cancelar"
    (confirmar)="confirmarExcluirDoador()"
    (cancelar)="cancelarExcluirDoador()"
  ></app-dialog>

  <div class="tab-card" *ngIf="activeTab === 'dados'" [formGroup]="recebimentoForm">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">Dados da doação</p>
      </div>
    </div>

    <div class="field-grid cols-3 doacao-grid">
      <label class="field field--doador">Doador (*)
        <app-autocomplete
          [placeholder]="'Digite o nome do doador'"
          [termo]="termoBuscaDoador"
          [opcoes]="doadoresFiltrados"
          [carregando]="doadoresCarregando"
          [erro]="doadoresErro"
          (termoChange)="onDoadorTermoChange($event)"
          (selecionar)="onDoadorSelecionado($event)"
        ></app-autocomplete>
        <p class="field-error" *ngIf="recebimentoForm.get('doadorId')?.invalid && recebimentoForm.get('doadorId')?.touched">
          Selecione um doador.
        </p>
      </label>
      <label class="field">Tipo de doação (*)
        <select formControlName="tipoDoacao" (change)="onTipoDoacaoChange()">
          <option value="DINHEIRO">Dinheiro</option>
          <option value="ALIMENTOS">Alimentos</option>
          <option value="INDUSTRIALIZADOS">Industrializados</option>
          <option value="BENS">Bens</option>
          <option value="MATERIAIS">Materiais</option>
          <option value="SERVICOS">Servicos</option>
        </select>
      </label>
      <label class="field" *ngIf="isDoacaoItens">Quantidade (*)
        <input type="number" formControlName="quantidadeItens" min="1" (input)="onQuantidadeItensChange($event)" />
        <p class="field-error" *ngIf="recebimentoForm.get('quantidadeItens')?.invalid && recebimentoForm.get('quantidadeItens')?.touched">
          Informe a quantidade do item.
        </p>
      </label>
      <label class="field full" *ngIf="isDoacaoItens">Descrição do item doado
        <textarea formControlName="descricao" rows="3" (blur)="onSentenceCaseBlur($event)"></textarea>
      </label>
      <label class="field">Data de recebimento (*)
        <input type="date" formControlName="dataRecebimento" />
      </label>
      <label class="field" *ngIf="isDoacaoItens">Valor médio (*)
        <input formControlName="valorMedio" placeholder="0,00" (input)="onValorMedioInput($event)" />
        <p class="field-error" *ngIf="recebimentoForm.get('valorMedio')?.invalid && recebimentoForm.get('valorMedio')?.touched">
          Informe o valor médio.
        </p>
      </label>
      <label class="field" *ngIf="isDoacaoItens">Valor total (*)
        <input formControlName="valorTotal" placeholder="0,00" (input)="onValorTotalInput($event)" />
        <p class="field-error" *ngIf="recebimentoForm.get('valorTotal')?.invalid && recebimentoForm.get('valorTotal')?.touched">
          Informe o valor total.
        </p>
      </label>
      <label class="field" *ngIf="isDoacaoDinheiro">Valor (*)
        <input formControlName="valor" placeholder="R$ 0,00" (input)="onValorInput($event)" />
        <p class="field-error" *ngIf="recebimentoForm.get('valor')?.invalid && recebimentoForm.get('valor')?.touched">
          Informe o valor recebido.
        </p>
      </label>
      <label class="field">Forma de recebimento
        <select formControlName="formaRecebimento" [disabled]="!isDoacaoDinheiro">
          <option value="">Selecione</option>
          <option value="PIX">Pix</option>
          <option value="DINHEIRO">Dinheiro</option>
          <option value="TRANSFERENCIA">Transferencia bancaria</option>
          <option value="CARTAO_CREDITO">Cartão de crédito</option>
        </select>
      </label>
      <label class="field">Status (*)
        <select formControlName="status">
          <option value="RECEBIDA">Recebida</option>
          <option value="PENDENTE">Pendente</option>
          <option value="CANCELADA">Cancelada</option>
        </select>
      </label>
      <label class="field full" *ngIf="isDoacaoDinheiro">Descrição
        <textarea formControlName="descricao" rows="3" (blur)="onSentenceCaseBlur($event)"></textarea>
      </label>
      <label class="field full">Observações
        <textarea formControlName="observacoes" rows="3" (blur)="onSentenceCaseBlur($event)"></textarea>
      </label>
    </div>
    <div class="tab-actions">
      <button type="button" class="ghost" (click)="changeTab('doador')">Voltar para doador</button>
      <button type="button" class="ghost" (click)="changeTab('recorrencia')">Configurar recorrência</button>
      <button type="button" class="ghost" (click)="changeTab('gestao')">Gestão da doação</button>
    </div>
  </div>

  <div class="tab-card" *ngIf="activeTab === 'recorrencia'" [formGroup]="recorrenciaForm">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">Recorrência e cobrança</p>
      </div>
    </div>

    <div class="field-grid cols-3">
      <label class="checkbox-field">
        <input type="checkbox" formControlName="recorrente" />
        <span>Doação recorrente</span>
      </label>
      <label class="field">Periodicidade
        <select formControlName="periodicidade" [disabled]="!recorrenciaForm.get('recorrente')?.value">
          <option value="MENSAL">Mensal</option>
          <option value="TRIMESTRAL">Trimestral</option>
          <option value="SEMESTRAL">Semestral</option>
          <option value="ANUAL">Anual</option>
        </select>
      </label>
      <label class="field">Próxima cobrança
        <input type="date" formControlName="proximaCobranca" [disabled]="!recorrenciaForm.get('recorrente')?.value" />
      </label>
    </div>
    <div class="tab-actions">
      <button type="button" class="ghost" (click)="atualizarProximaCobranca()" [disabled]="!recorrenciaForm.get('recorrente')?.value">
        Gerar cobrança mensal
      </button>
      <button type="button" class="ghost" (click)="changeTab('dados')">Voltar</button>
      <button type="button" class="ghost" (click)="changeTab('gestao')">Gestão da doação</button>
    </div>
  </div>

  <div class="tab-card" *ngIf="activeTab === 'gestao'" [formGroup]="gestaoForm">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">Gestão de doação</p>
      </div>
    </div>

    <div class="field-grid cols-2">
      <label class="field">Canal de envio
        <select formControlName="canal">
          <option value="WHATSAPP">WhatsApp</option>
          <option value="EMAIL">Email</option>
        </select>
      </label>
      <div class="field template-field">
        <p class="field-title">Templates rápidos</p>
        <div class="template-actions">
          <button type="button" class="ghost" (click)="aplicarTemplateMensagem('lembrete')">Lembrete</button>
          <button type="button" class="ghost" (click)="aplicarTemplateMensagem('agradecimento')">Agradecimento</button>
          <button type="button" class="ghost" (click)="aplicarTemplateMensagem('transparencia')">Transparência</button>
        </div>
      </div>
      <label class="field">Mensagem (*)
        <textarea formControlName="mensagem" rows="4" (blur)="onSentenceCaseBlur($event)"></textarea>
        <p class="field-error" *ngIf="gestaoForm.get('mensagem')?.invalid && gestaoForm.get('mensagem')?.touched">
          Informe a mensagem que sera enviada ao doador.
        </p>
      </label>
    </div>

    <div class="tab-actions">
      <button type="button" class="primary" (click)="enviarMensagemGestao()">Enviar mensagem</button>
      <button type="button" class="ghost" (click)="changeTab('recorrencia')">Voltar</button>
    </div>
  </div>

  <div class="tab-card" *ngIf="activeTab === 'lista'">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">Listagem de recebimentos</p>
      </div>
      <div class="tab-card__header-actions">
        <button type="button" class="btn-outline" (click)="carregarRecebimentos()">Atualizar</button>
      </div>
    </div>

    <div class="table-wrapper" *ngIf="recebimentos.length; else emptyList">
      <table>
        <thead>
          <tr>
            <th>Doador</th>
            <th>Tipo</th>
            <th>Data</th>
            <th>Valor</th>
            <th>Status</th>
            <th>Contabilidade</th>
            <th class="text-right">Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of recebimentos" (dblclick)="editarRecebimento(item)">
            <td>
              <p class="strong">{{ item.doadorNome || getNomeDoador(item.doadorId) }}</p>
              <p class="muted">{{ item.tipoDoacao }}</p>
            </td>
            <td>{{ item.descricao || '---' }}</td>
            <td>{{ item.dataRecebimento | date: 'dd/MM/yyyy' }}</td>
            <td>{{ item.valor || 0 | currency: 'BRL' }}</td>
            <td><span class="status-chip">{{ item.status }}</span></td>
            <td>
              <span class="status-chip" [class.status-chip--info]="!item.contabilidadePendente">
                {{ item.contabilidadePendente ? 'Pendente' : 'Não aplicado' }}
              </span>
              <button type="button" class="btn-outline" disabled title="Disponível quando a contabilidade estiver integrada">
                Enviar para contabilidade
              </button>
            </td>
            <td class="text-right">
              <button type="button" class="ghost danger" (click)="excluirRecebimento(item)">Excluir</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <ng-template #emptyList>
      <div class="empty">
        <fa-icon [icon]="faClipboardList"></fa-icon>
        <div class="loading-block" *ngIf="carregandoRecebimentos">
          <span class="spinner" aria-hidden="true"></span>
          <p>Carregando recebimentos...</p>
        </div>
        <p *ngIf="!carregandoRecebimentos">Nenhum recebimento cadastrado.</p>
        <button type="button" class="primary" *ngIf="!carregandoRecebimentos" (click)="changeTab('dados')">
          Cadastrar recebimento
        </button>
      </div>
    </ng-template>
  </div>
    </div>
  </div>
</section>
</app-tela-padrao>








