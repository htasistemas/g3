<app-tela-padrao>
  <header class="page-title page-title--row" slot="titulo">
    <div>
      <p class="page-title__eyebrow">ATENDIMENTOS</p>
      <p class="page-title__label">Chamada de senhas</p>
    </div>
    <p class="page-title__note">Controle de fila e chamada de beneficiarios.</p>
  </header>

  <section class="cadastro">
    <app-popup-messages *ngIf="popupErros.length" [mensagens]="popupErros" (fechar)="popupErros = []"></app-popup-messages>
    <div class="feedback" *ngIf="mensagem">
      <span>{{ mensagem }}</span>
      <button type="button" class="feedback__close" (click)="mensagem = null">x</button>
    </div>
    <div class="tab-shell">
      <p class="tab-shell__title">Navegue pelas informações</p>
      <ol class="step-tabs" role="tablist">
        <li
          *ngFor="let aba of abas; index as idx"
          class="step-tabs__item"
          [class.active]="abaAtiva === aba.id"
          [class.completed]="idx < abaAtivaIndex"
        >
          <button
            class="step-tabs__button"
            type="button"
            role="tab"
            [attr.aria-selected]="abaAtiva === aba.id"
            (click)="selecionarAba(aba.id)"
          >
            <span class="step-tabs__index">{{ idx + 1 }}</span>
            <span class="step-tabs__label">{{ aba.label }}</span>
          </button>
        </li>
      </ol>
    </div>

    <div class="painel-grid painel-grid--single" *ngIf="abaAtiva === 'entrada'">
      <div class="g3-card g3-card--form g3-card--compact">
        <div class="g3-card__header">
          <div>
            <p class="g3-card__title">Entrada na fila</p>
            <p class="g3-card__subtitle">Selecione o beneficiario e defina prioridade.</p>
          </div>
          <div class="g3-card__badge">Passo 1</div>
        </div>

        <div class="field-grid field-grid--compact">
          <label class="field field--full">
            Beneficiario (*)
            <app-autocomplete
              [placeholder]="'Nome, CPF ou codigo'"
              [termo]="termoBusca"
              [opcoes]="opcoesBeneficiarios"
              [carregando]="carregandoBeneficiarios"
              (termoChange)="onTermoBuscaChange($event)"
              (selecionar)="selecionarBeneficiario($event)"
            ></app-autocomplete>
            <span class="selecionado" *ngIf="beneficiarioSelecionadoNome">
              Selecionado: {{ beneficiarioSelecionadoNome }}
            </span>
          </label>

          <label class="field">
            Unidade
            <select [(ngModel)]="unidadeSelecionadaId" (ngModelChange)="onUnidadeSelecionada()">
              <option [ngValue]="null">Selecione</option>
              <option *ngFor="let unidade of unidades" [ngValue]="unidade.id">
                {{ unidade.nomeFantasia }}
              </option>
            </select>
          </label>

          <label class="field">
            Sala de atendimento (*)
            <select [(ngModel)]="salaSelecionadaId">
              <option [ngValue]="null">Selecione</option>
              <option *ngFor="let sala of salasDisponiveis" [ngValue]="sala.id">
                {{ sala.nome }}
              </option>
            </select>
          </label>

          <label class="field">
            Prioridade (*)
            <select [(ngModel)]="prioridadeSelecionada">
              <option *ngFor="let prioridade of prioridades" [ngValue]="prioridade">{{ prioridade }}</option>
            </select>
          </label>
        </div>

        <div class="prioridade-custom prioridade-custom--compact">
          <label class="field">
            Nova prioridade
            <input type="text" [(ngModel)]="novaPrioridade" placeholder="Ex.: Urgente" />
          </label>
          <button type="button" class="ghost" (click)="adicionarPrioridade()">Adicionar</button>
        </div>

        <div class="g3-card__footer g3-card__footer--actions">
          <p class="g3-card__hint">Inclua o beneficiario na fila de atendimento.</p>
          <button type="button" class="primary incluir-button" (click)="emitirSenha()">Incluir na fila</button>
        </div>
      </div>

    </div>

    <div class="painel-grid painel-grid--single" *ngIf="abaAtiva === 'fila'">
      <div class="g3-card g3-card--fila g3-card--compact">
        <div class="g3-card__header g3-card__header--row">
          <div>
            <p class="g3-card__title">Fila aguardando</p>
            <p class="g3-card__subtitle">Chame o beneficiario para a sala informada.</p>
          </div>
          <div class="fila-resumo">
            <div class="fila-chip">
              <span class="fila-chip__label">Na fila</span>
              <span class="fila-chip__valor">{{ filaFiltrada.length }}</span>
            </div>
            <div class="fila-chip fila-chip--tempo">
              <span class="fila-chip__label">Espera media</span>
              <span class="fila-chip__valor">{{ tempoMedioEspera }} min</span>
            </div>
          </div>
        </div>

        <div class="fila-filtros">
          <label class="field">
            Filtrar por unidade
            <select [(ngModel)]="filtroUnidadeId">
              <option [ngValue]="null">Todas</option>
              <option *ngFor="let unidade of unidades" [ngValue]="unidade.id">
                {{ unidade.nomeFantasia }}
              </option>
            </select>
          </label>
          <label class="field">
            Filtrar por prioridade
            <select [(ngModel)]="filtroPrioridade">
              <option [ngValue]="null">Todas</option>
              <option *ngFor="let prioridade of prioridades" [ngValue]="prioridade">{{ prioridade }}</option>
            </select>
          </label>
        </div>

        <div class="list-card">
          <div class="list-panel__loading" *ngIf="carregandoFila">Carregando fila...</div>
          <table *ngIf="!carregandoFila">
            <thead>
              <tr>
                <th class="tag-col"></th>
                <th>Beneficiario</th>
                <th>Sala</th>
                <th>Prioridade</th>
                <th>Entrada</th>
                <th class="text-right">ações</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of filaFiltrada; index as idx" [class.linha-destaque]="idx === 0">
                <td class="tag-col">
                  <span class="fila-tag" [class.fila-tag--primeiro]="idx === 0">
                    {{ idx === 0 ? 'Primeiro' : 'Fila' }}
                  </span>
                </td>
                <td>{{ item.nomeBeneficiario }}</td>
                <td>{{ item.salaAtendimento || '-' }}</td>
                <td>
                  <span class="prioridade" [class.prioridade--alta]="item.prioridade >= 2">
                    {{ obterLabelPrioridadeFila(item.prioridade) }}
                  </span>
                </td>
                <td>
                  {{ item.dataHoraEntrada | date: 'dd/MM/yyyy HH:mm' }}
                  <span class="muted tempo">({{ calcularEspera(item.dataHoraEntrada) }} min)</span>
                </td>
                <td class="text-right">
                  <div class="acoes-fila">
                    <button
                      type="button"
                      class="primary chamar-button"
                      [disabled]="filaEmChamadaId === item.id"
                      (click)="chamar(item)"
                    >
                      {{ filaEmChamadaId === item.id ? 'Chamando...' : 'Chamar senha' }}
                    </button>
                    <button type="button" class="ghost concluir-button" (click)="concluirFila(item)">Concluido</button>
                  </div>
                </td>
              </tr>
              <tr *ngIf="!filaFiltrada.length">
                <td colspan="6" class="muted">Nenhum beneficiario aguardando.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="painel-grid painel-grid--single" *ngIf="abaAtiva === 'config'">
      <div class="g3-card g3-card--compact">
        <div class="g3-card__header">
          <div>
            <p class="g3-card__title">Configurações gerais</p>
            <p class="g3-card__subtitle">Personalize o painel e a chamada por voz.</p>
          </div>
        </div>

        <div class="g3-card__footer g3-card__footer--actions">
          <p class="g3-card__hint">Salve as configurações antes de abrir o painel.</p>
          <div class="actions-row">
            <button
              type="button"
              class="primary incluir-button"
              [disabled]="acoesDesabilitadas.cancelar"
              (click)="cancelarConfiguracoes()"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="primary incluir-button"
              [disabled]="acoesDesabilitadas.salvar"
              (click)="salvarConfiguracoes()"
            >
              Salvar
            </button>
            <button type="button" class="primary incluir-button" (click)="testarFrase()">Testar frase</button>
            <button type="button" class="primary incluir-button" (click)="abrirPainel()">Abrir painel</button>
          </div>
        </div>

        <div class="field-grid field-grid--compact">
          <label class="field field--full">
            Titulo da tela de chamada
            <input type="text" [(ngModel)]="tituloTela" />
          </label>
          <label class="field field--full">
            Descricao da tela de chamada
            <input type="text" [(ngModel)]="descricaoTela" />
          </label>
          <label class="field field--full">
            Frase da chamada (*)
            <input type="text" [(ngModel)]="fraseFala" />
            <span class="field-hint">Use {{ '{' }}beneficiario{{ '}' }} e {{ '{' }}sala{{ '}' }}.</span>
          </label>
          <label class="field">
            Origem das noticias (*)
            <select [(ngModel)]="modoNoticias">
              <option [ngValue]="'RSS'">Automatico (RSS)</option>
              <option [ngValue]="'MANUAL'">Manual</option>
            </select>
          </label>
          <label class="field field--full" *ngIf="modoNoticias === 'RSS'">
            Feed de noticias (RSS) (*)
            <input type="text" [(ngModel)]="rssUrl" />
          </label>
          <label class="field field--full" *ngIf="modoNoticias === 'MANUAL'">
            Noticias manuais (*)
            <div class="manual-noticias">
              <input
                type="text"
                [(ngModel)]="noticiaManualInput"
                placeholder="Digite a noticia e clique em adicionar (max 120 caracteres)."
              />
              <button type="button" class="ghost" (click)="adicionarNoticiaManual()">Adicionar</button>
            </div>
            <ul class="manual-noticias__lista">
              <li *ngFor="let noticia of noticiasManuaisLista; index as idx">
                <span>{{ noticia }}</span>
                <button type="button" class="ghost" (click)="removerNoticiaManual(idx)">Remover</button>
              </li>
              <li *ngIf="!noticiasManuaisLista.length" class="muted">
                Nenhuma noticia manual adicionada.
              </li>
            </ul>
            <span class="field-hint">Use â€œ;â€ ou quebra de linha para adicionar varias noticias.</span>
          </label>
          <label class="field field--compact">
            Velocidade do ticker (segundos) (*)
            <select [(ngModel)]="velocidadeTicker">
              <option *ngFor="let velocidade of velocidadesDisponiveis" [ngValue]="velocidade">
                {{ velocidade }} segundos
              </option>
            </select>
            <span class="field-hint">Quanto maior o segundo, mais lento sera o ticker.</span>
          </label>
          <label class="field field--compact">
            Quantidade de ultimas chamadas (*)
            <select [(ngModel)]="quantidadeUltimasChamadas">
              <option *ngFor="let quantidade of quantidadesUltimasChamadasDisponiveis" [ngValue]="quantidade">
                {{ quantidade }}
              </option>
            </select>
          </label>
          <label class="field field--full">
            Unidade do painel
            <select [(ngModel)]="unidadePainelId">
              <option [ngValue]="null">Usar unidade atual</option>
              <option *ngFor="let unidade of unidades" [ngValue]="unidade.id">
                {{ unidade.nomeFantasia }}
              </option>
            </select>
          </label>
        </div>
      </div>
    </div>
  </section>
</app-tela-padrao>

