<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  (salvar)="onSave()"
  (cancelar)="onCancel()"
  (novo)="onNew()"
  (excluir)="onDelete()"
>
  <header class="page-title" slot="titulo">
    <p class="page-title__eyebrow">Administrativo</p>
    <p class="page-title__label">Tarefas e pendências</p>
  </header>

  <div class="tab-shell">
    <p class="tab-shell__title">Navegue pelas informações</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of tabs; index as idx"
        class="step-tabs__item"
        [class.active]="activeTab === tab.id"
      >
        <button
          type="button"
          class="step-tabs__button"
          (click)="changeTab(tab.id)"
          [attr.aria-selected]="activeTab === tab.id"
        >
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ tab.label }}</span>
        </button>
      </li>
    </ol>
  </div>

  <form [formGroup]="form" (ngSubmit)="onSave()" class="form-shell">
    <app-popup-messages
      *ngIf="popupErros.length"
      [mensagens]="popupErros"
      (fechar)="fecharPopupErros()"
    ></app-popup-messages>

    <div *ngIf="feedback" class="feedback">
      <span>{{ feedback }}</span>
      <button type="button" class="feedback__close" (click)="feedback = null" aria-label="Fechar aviso">
        &times;
      </button>
    </div>

  <div class="tab-card" *ngIf="activeTab === 'cadastro'">
    <div class="tab-card__header">
        <div>
          <p class="tab-card__highlight">{{ editingId ? 'Atualizando pendência' : 'Cadastre uma nova pendência' }}</p>
        </div>
      <span class="pill">{{ editingId ? 'Editando' : 'Rascunho' }}</span>
    </div>

    <section class="panel">
      <div class="panel__header">
        <div>
          <p class="panel__title">Dados da tarefa</p>
          <p class="muted">Campos essenciais para priorizar e monitorar.</p>
        </div>
      </div>

      <div class="field-grid cols-2">
        <label class="field">
          Título*
          <input formControlName="titulo" placeholder="Nome da tarefa" />
        </label>
        <label class="field">
          Responsável*
          <input list="responsaveis" formControlName="responsavel" placeholder="Selecione ou digite" />
          <datalist id="responsaveis">
            <option *ngFor="let pessoa of responsaveisSugeridos" [value]="pessoa"></option>
          </datalist>
        </label>
        <label class="field">
          Prioridade*
          <select formControlName="prioridade">
            <option *ngFor="let prioridade of prioridades" [value]="prioridade">{{ prioridade }}</option>
          </select>
        </label>
        <label class="field">
          Prazo previsto*
          <input type="date" formControlName="prazo" />
        </label>
        <label class="field">
          Status*
          <select formControlName="status">
            <option *ngFor="let status of statusOptions" [value]="status">{{ status }}</option>
          </select>
        </label>
        <label class="field full">
          Descrição*
          <textarea formControlName="descricao" rows="3" placeholder="Contexto, escopo da entrega e responsáveis técnicos"></textarea>
        </label>
      </div>

      <div class="checklist">
        <div class="checklist__header">
          <p class="panel__title">Checklist</p>
          <p class="muted">Registre itens que comprovam o progresso da tarefa.</p>
        </div>
        <div class="checklist__controls">
          <input [(ngModel)]="checklistEntry" name="checklistEntry" placeholder="Adicionar item" />
          <button type="button" class="ghost" (click)="addChecklistItem()">Adicionar</button>
        </div>
        <ul class="checklist__list" *ngIf="checklistDraft.length; else emptyChecklist">
          <li *ngFor="let item of checklistDraft">
            <label>
              <input type="checkbox" [checked]="item.concluido" (change)="toggleDraftChecklist(item)" />
              <span [class.done]="item.concluido">{{ item.titulo }}</span>
            </label>
          </li>
        </ul>
        <ng-template #emptyChecklist>
          <p class="muted">Nenhum item adicionado ainda.</p>
        </ng-template>
      </div>
    </section>

    <div class="tab-actions">
      <button type="button" class="ghost" (click)="goToPreviousTab()" [disabled]="!hasPreviousTab">
        Voltar
      </button>
      <button type="button" class="ghost" (click)="goToNextTab()" [disabled]="!hasNextTab">
        Próxima: {{ nextTabLabel }}
      </button>
      <button type="submit" class="primary" [disabled]="saving">
        {{ saving ? 'Salvando...' : editingId ? 'Salvar pendência' : 'Registrar pendência' }}
      </button>
    </div>
  </div>

  <div class="tab-card" *ngIf="activeTab === 'dashboard'">
    <div class="tab-card__header">
      <div>
        <p class="tab-card__highlight">Dashboard e alertas</p>
        <p class="muted">Indicadores rápidos e contexto das tarefas.</p>
      </div>
    </div>

    <section class="panel summary">
      <div class="panel__header">
        <div>
          <p class="panel__title">Visão geral</p>
          <p class="muted">Status, checklist e alertas em um único lugar.</p>
        </div>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <p class="stat-card__label">Pendências abertas</p>
          <p class="stat-card__value">{{ dashboard.abertas }}</p>
          <p class="stat-card__hint">{{ dashboard.total }} pendências no total</p>
        </div>
        <div class="stat-card">
          <p class="stat-card__label">Em andamento</p>
          <p class="stat-card__value">{{ dashboard.andamento }}</p>
          <p class="stat-card__hint">{{ checklistProgresso }} do checklist concluído</p>
        </div>
        <div class="stat-card">
          <p class="stat-card__label">Concluídas</p>
          <p class="stat-card__value">{{ dashboard.concluidas }}</p>
          <p class="stat-card__hint">{{ dashboard.atrasadas }} em atraso</p>
        </div>
        <div class="stat-card">
          <p class="stat-card__label">Prazos próximos</p>
          <p class="stat-card__value">{{ dashboard.proximas }}</p>
          <p class="stat-card__hint">Alertas exibidos abaixo</p>
        </div>
      </div>

      <div class="alert-card" *ngIf="alertas.length">
        <p class="panel__title">Avisos de alerta</p>
        <ul>
          <li *ngFor="let alerta of alertas">
            <div>
              <p class="strong">{{ alerta.titulo }}</p>
              <p class="muted">Responsável: {{ alerta.responsavel || 'Não informado' }}</p>
            </div>
            <span class="pill" [class.danger]="alerta.status === 'Em atraso'">{{ alerta.status }}</span>
          </li>
        </ul>
      </div>

      <div class="history-card" *ngIf="selectedTask">
        <div class="panel__header">
          <div>
            <p class="panel__title">Histórico de andamento</p>
            <p class="muted">{{ selectedTask.titulo }}</p>
          </div>
          <span class="pill">{{ selectedTask.status }}</span>
        </div>
        <ul class="timeline">
          <li *ngFor="let entry of selectedTask.historico">
            <p class="strong">{{ entry.mensagem }}</p>
            <p class="muted">{{ entry.data | date: 'short' }}</p>
          </li>
        </ul>
      </div>
    </section>

    <div class="tab-actions">
      <button type="button" class="ghost" (click)="goToPreviousTab()">
        Voltar ao cadastro
      </button>
      <button type="button" class="ghost" (click)="goToNextTab()" [disabled]="!hasNextTab">
        Próxima: {{ nextTabLabel }}
      </button>
    </div>
  </div>

    <div class="tab-card" *ngIf="activeTab === 'lista'">
      <div class="tab-card__header">
        <div>
          <p class="panel__title">Tarefas registradas</p>
          <p class="muted">Controle e checklist em um único painel.</p>
        </div>
        <div class="list-card__actions">
          <button type="button" class="ghost" (click)="startNewTask()">Nova pendência</button>
          <button type="button" class="ghost" (click)="goToPreviousTab()">Voltar ao cadastro</button>
        </div>
      </div>

      <div class="list-card">
        <div class="list-panel__loading" *ngIf="listLoading">Carregando pendências...</div>
        <table *ngIf="!listLoading">
          <thead>
            <tr>
              <th>Título</th>
              <th>Responsável</th>
              <th>Prazo</th>
              <th>Status</th>
              <th>Checklist</th>
              <th class="text-right">Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let task of tasks">
              <td>
                <div class="strong">{{ task.titulo }}</div>
                <p class="muted">{{ task.descricao }}</p>
              </td>
              <td>{{ task.responsavel }}</td>
              <td>{{ dueLabel(task) }}</td>
              <td>
                <span class="pill" [class.danger]="statusTone(task) === 'red'" [class.success]="statusTone(task) === 'green'">
                  {{ task.status }}
                </span>
              </td>
              <td>{{ progress(task) }}</td>
              <td class="text-right">
                <div class="row-actions">
                  <button type="button" class="ghost" (click)="selectTask(task)">Histórico</button>
                  <button type="button" class="ghost" (click)="editTask(task)">Editar</button>
                  <button type="button" class="primary" (click)="changeStatus(task, 'Concluída')" [disabled]="task.status === 'Concluída'">
                    Concluir
                  </button>
                  <button type="button" class="danger" (click)="removeTask(task)">Excluir</button>
                </div>
                <div class="inline-checklist" *ngIf="task.checklist.length">
                  <p class="muted">Checklist rápido</p>
                  <label *ngFor="let item of task.checklist">
                    <input type="checkbox" [checked]="item.concluido" (change)="toggleChecklist(task, item)" />
                    <span>{{ item.titulo }}</span>
                  </label>
                </div>
              </td>
            </tr>
            <tr *ngIf="!tasks.length">
              <td colspan="6" class="muted">Nenhuma pendência registrada.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="tab-actions">
        <button type="button" class="ghost" (click)="goToPreviousTab()">Voltar ao dashboard</button>
        <button type="button" class="primary" (click)="startNewTask()">Iniciar nova pendência</button>
      </div>
    </div>
  </form>
</app-tela-padrao>
