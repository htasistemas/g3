<app-tela-padrao>
<header class="page-title" slot="titulo">
    <p class="page-title__eyebrow">Administrativo</p>
    <p class="page-title__label">Tarefas e pendências</p>
    <p class="page-title__description">
      Registre pendências, responsáveis, prazos e acompanhe o status com um checklist e dashboard simplificado.
    </p>
  </header>

  <section class="tarefas">
  <div class="layout">
    <section class="panel">
      <div class="panel__header">
        <div>
          <p class="panel__title">Nova pendência</p>
          <p class="muted">Checklist, prioridade e prazo para organizar a execução.</p>
        </div>
        <span class="pill">{{ editingId ? 'Editando' : 'Rascunho' }}</span>
      </div>

      <form [formGroup]="form" (ngSubmit)="saveTask()" class="form-shell">
        <div *ngIf="feedback" class="feedback">{{ feedback }}</div>

        <div class="field-grid cols-2">
          <label class="field">Título*<input formControlName="titulo" placeholder="Qual é a tarefa?" /></label>
          <label class="field">Responsável*
            <input formControlName="responsavel" list="responsaveis" placeholder="Selecione ou digite" />
            <datalist id="responsaveis">
              <option *ngFor="let pessoa of responsaveisSugeridos" [value]="pessoa"></option>
            </datalist>
          </label>
          <label class="field">Prioridade*
            <select formControlName="prioridade">
              <option *ngFor="let prioridade of prioridades" [value]="prioridade">{{ prioridade }}</option>
            </select>
          </label>
          <label class="field">Prazo previsto*<input type="date" formControlName="prazo" /></label>
          <label class="field">Status*
            <select formControlName="status">
              <option *ngFor="let status of statusOptions" [value]="status">{{ status }}</option>
            </select>
          </label>
          <label class="field full">Descrição detalhada*
            <textarea formControlName="descricao" rows="3" placeholder="Contexto e expectativa de entrega"></textarea>
          </label>
        </div>

        <div class="checklist">
          <div class="checklist__header">
            <p class="panel__title">Checklist</p>
            <p class="muted">Itens de verificação para concluir a tarefa.</p>
          </div>
          <div class="checklist__controls">
            <input [(ngModel)]="checklistEntry" name="checklistEntry" placeholder="Adicionar item" />
            <button type="button" class="ghost" (click)="addChecklistItem()">Adicionar</button>
          </div>
          <ul class="checklist__list" *ngIf="checklistDraft.length; else emptyChecklist">
            <li *ngFor="let item of checklistDraft">
              <label>
                <input type="checkbox" [checked]="item.concluido" (change)="toggleDraftChecklist(item)" />
                <span [class.done]="item.concluido">{{ item.titulo }}</span>
              </label>
            </li>
          </ul>
          <ng-template #emptyChecklist>
            <p class="muted">Nenhum item adicionado ainda.</p>
          </ng-template>
        </div>

        <div class="actions">
          <button type="button" class="ghost" (click)="resetForm()">Limpar</button>
          <button type="submit" class="primary">{{ editingId ? 'Salvar pendência' : 'Registrar pendência' }}</button>
        </div>
      </form>
    </section>

    <section class="panel summary">
      <div class="panel__header">
        <div>
          <p class="panel__title">Dashboard</p>
          <p class="muted">Indicadores rápidos e alertas.</p>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <p class="stat-card__label">Pendências abertas</p>
          <p class="stat-card__value">{{ dashboard.abertas }}</p>
          <p class="stat-card__hint">{{ dashboard.total }} tarefas no total</p>
        </div>
        <div class="stat-card">
          <p class="stat-card__label">Em andamento</p>
          <p class="stat-card__value">{{ dashboard.andamento }}</p>
          <p class="stat-card__hint">{{ checklistProgresso }} do checklist concluído</p>
        </div>
        <div class="stat-card">
          <p class="stat-card__label">Concluídas</p>
          <p class="stat-card__value">{{ dashboard.concluidas }}</p>
          <p class="stat-card__hint">{{ dashboard.atrasadas }} em atraso</p>
        </div>
        <div class="stat-card">
          <p class="stat-card__label">Prazos próximos</p>
          <p class="stat-card__value">{{ dashboard.proximas }}</p>
          <p class="stat-card__hint">Alertas exibidos abaixo</p>
        </div>
      </div>

      <div class="alert-card" *ngIf="alertas.length">
        <p class="panel__title">Avisos de alerta</p>
        <ul>
          <li *ngFor="let alerta of alertas">
            <div>
              <p class="strong">{{ alerta.titulo }}</p>
              <p class="muted">Responsável: {{ alerta.responsavel || 'Não informado' }}</p>
            </div>
            <span class="pill" [class.danger]="isOverdue(alerta)">{{ dueLabel(alerta) }}</span>
          </li>
        </ul>
      </div>

      <div class="history-card" *ngIf="selectedTask">
        <div class="panel__header">
          <div>
            <p class="panel__title">Histórico de andamento</p>
            <p class="muted">{{ selectedTask.titulo }}</p>
          </div>
          <span class="pill">{{ selectedTask.status }}</span>
        </div>
        <ul class="timeline">
          <li *ngFor="let entry of selectedTask.historico">
            <p class="strong">{{ entry.mensagem }}</p>
            <p class="muted">{{ entry.data | date: 'short' }}</p>
          </li>
        </ul>
      </div>
    </section>
  </div>

  <div class="list-card">
    <div class="list-card__header">
      <div>
        <p class="page-title__eyebrow">Tarefas registradas</p>
        <p class="page-title__label">Controle e checklist</p>
      </div>
      <div class="list-card__actions">
        <button class="ghost" type="button" (click)="resetForm()">Nova pendência</button>
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Título</th>
            <th>Responsável</th>
            <th>Prazo</th>
            <th>Prioridade</th>
            <th>Status</th>
            <th>Checklist</th>
            <th class="text-right">Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let task of tasks">
            <td>
              <div class="strong">{{ task.titulo }}</div>
              <p class="muted">{{ task.descricao }}</p>
            </td>
            <td>{{ task.responsavel || 'Não informado' }}</td>
            <td>{{ dueLabel(task) }}</td>
            <td><span class="pill">{{ task.prioridade }}</span></td>
            <td>
              <span class="pill" [class.danger]="statusTone(task) === 'red'" [class.success]="task.status === 'Concluída'">{{ task.status }}</span>
            </td>
            <td>{{ progress(task) }}</td>
            <td class="text-right">
              <div class="row-actions">
                <button type="button" class="ghost" (click)="selectTask(task)">Histórico</button>
                <button type="button" class="ghost" (click)="editTask(task)">Editar</button>
                <button type="button" class="primary" (click)="changeStatus(task, 'Concluída')" [disabled]="task.status === 'Concluída'">
                  Concluir
                </button>
                <button type="button" class="danger" (click)="removeTask(task)">Excluir</button>
              </div>
              <div class="inline-checklist" *ngIf="task.checklist && task.checklist.length">
                <p class="muted">Checklist rápido</p>
                <label *ngFor="let item of task.checklist">
                  <input type="checkbox" [checked]="item.concluido" (change)="toggleChecklist(task, item)" />
                  <span>{{ item.titulo }}</span>
                </label>
              </div>
            </td>
          </tr>
          <tr *ngIf="!tasks.length">
            <td colspan="7" class="muted">Nenhuma pendência registrada.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>
</app-tela-padrao>

