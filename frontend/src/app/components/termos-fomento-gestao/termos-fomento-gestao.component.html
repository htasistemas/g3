<section class="gestao-termos">
  <header class="page-title">
    <p class="page-title__eyebrow">Convênios e Fomentos</p>
    <p class="page-title__label">Gestão de Termos de Fomento</p>
  </header>

  <div class="toolbar">
    <div class="toolbar__actions">
      <button class="ghost" type="button" (click)="resetForm()">Novo termo</button>
      <button class="primary" type="button" (click)="submit()" [disabled]="saving">
        {{ saving ? 'Salvando...' : 'Salvar' }}
      </button>
      <button class="danger" type="button" [disabled]="!editingTermoId" (click)="termoEmEdicao && deleteTermo(termoEmEdicao)">
        Excluir
      </button>
    </div>
    <div class="toolbar__filters">
      <label class="filter">
        <span>Pesquisa</span>
        <input
          type="search"
          placeholder="Número, órgão ou responsável"
          (input)="onSearchInput($event)"
        />
      </label>
      <label class="filter">
        <span>Situação</span>
        <select (change)="onSituacaoFiltroChange($event)">
          <option value="">Todas</option>
          <option value="Ativo">Ativo</option>
          <option value="Aditivado">Aditivado</option>
          <option value="Encerrado">Encerrado</option>
          <option value="Cancelado">Cancelado</option>
        </select>
      </label>
      <label class="checkbox-field filter">
        <input type="checkbox" [checked]="somenteVencidos" (change)="somenteVencidos = !somenteVencidos; applyFilters()" />
        <span>Mostrar apenas vencidos</span>
      </label>
    </div>
  </div>

  <div class="tab-shell">
    <p class="tab-shell__title">Navegue pelos detalhes do termo</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of tabs; index as idx"
        class="step-tabs__item"
        [class.active]="activeTab === tab.id"
        [class.completed]="idx < activeTabIndex"
      >
        <button
          class="step-tabs__button"
          type="button"
          role="tab"
          [attr.aria-selected]="activeTab === tab.id"
          (click)="changeTab(tab.id)"
        >
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ tab.label }}</span>
        </button>
      </li>
    </ol>
  </div>

  <form [formGroup]="form" class="form-shell">
    <div *ngIf="feedback" class="feedback">{{ feedback }}</div>

    <ng-template #navigationControls>
      <div class="tab-actions">
        <button type="button" class="ghost" *ngIf="hasPreviousTab" (click)="goToPreviousTab()">Voltar</button>
        <button type="button" class="primary" *ngIf="hasNextTab" (click)="goToNextTab()">
          Próximo: {{ nextTabLabel }}
        </button>
        <button type="button" class="primary" [disabled]="saving" *ngIf="!hasNextTab" (click)="submit()">
          {{ saving ? 'Salvando...' : 'Salvar termo' }}
        </button>
      </div>
    </ng-template>

    <div class="tab-card" *ngIf="activeTab === 'dados'" formGroupName="dadosTermo">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Cadastre os dados principais do termo de fomento.</p>
        </div>
        <span class="pill">Obrigatório</span>
      </div>
      <div class="field-grid cols-3">
        <label class="field">Número do termo*<input formControlName="numeroTermo" placeholder="Código interno" /></label>
        <label class="field">Tipo de termo*
          <select formControlName="tipoTermo">
            <option value="Uniao">União</option>
            <option value="Estado">Estado</option>
            <option value="Municipio">Município</option>
          </select>
        </label>
        <label class="field">Órgão concedente<input formControlName="orgaoConcedente" placeholder="Nome do órgão" /></label>
        <label class="field">Data de assinatura<input type="date" formControlName="dataAssinatura" /></label>
        <label class="field">Início da vigência<input type="date" formControlName="dataInicioVigencia" /></label>
        <label class="field">Fim da vigência<input type="date" formControlName="dataFimVigencia" /></label>
        <label class="field">Situação do termo*
          <select formControlName="situacao">
            <option value="Ativo">Ativo</option>
            <option value="Aditivado">Aditivado</option>
            <option value="Encerrado">Encerrado</option>
            <option value="Cancelado">Cancelado</option>
          </select>
        </label>
        <label class="field">Valor global<input type="number" formControlName="valorGlobal" placeholder="0,00" /></label>
        <label class="field">Responsável interno<input formControlName="responsavelInterno" placeholder="Selecione o responsável" /></label>
        <label class="field full">Objeto / descrição<textarea formControlName="descricaoObjeto" rows="3" placeholder="Descreva o objeto do termo"></textarea></label>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'anexos'" formGroupName="anexos">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Anexe o PDF do termo e documentos relacionados.</p>
        </div>
      </div>
      <div class="field-grid cols-2">
        <div class="upload-card">
          <div class="upload-card__header">
            <div>
              <p class="upload-card__title">PDF do termo de fomento</p>
              <p class="muted">Anexe o documento oficial assinado.</p>
            </div>
            <span class="pill">PDF</span>
          </div>
          <div class="upload-card__body">
            <p class="muted" *ngIf="!(form.get('anexos.termoDocumento')?.value)">Nenhum arquivo selecionado.</p>
            <div class="file-chip" *ngIf="form.get('anexos.termoDocumento')?.value as termoDoc">
              <span class="file-chip__name">{{ termoDoc.nome }}</span>
              <span class="file-chip__meta">{{ termoDoc.tipo?.toUpperCase() || 'TERMO' }}</span>
            </div>
            <label class="primary upload-button">
              <input type="file" accept="application/pdf" (change)="onFileSelected($event, ['anexos', 'termoDocumento'], 'termo')" />
              Carregar PDF
            </label>
            <button class="ghost" type="button" (click)="termoEmEdicao && visualizarTermo(termoEmEdicao)">Visualizar termo</button>
          </div>
        </div>

        <div class="upload-card">
          <div class="upload-card__header">
            <div>
              <p class="upload-card__title">Documentos relacionados</p>
              <p class="muted">Portarias, pareceres e demais anexos.</p>
            </div>
            <span class="pill">PDF</span>
          </div>
          <div class="upload-card__body">
            <div class="file-chip" *ngFor="let doc of form.get('anexos.documentosRelacionados')?.value">
              <span class="file-chip__name">{{ doc.nome }}</span>
              <span class="file-chip__meta">{{ doc.tipo?.toUpperCase() || 'ANEXO' }}</span>
            </div>
            <p class="muted" *ngIf="!(form.get('anexos.documentosRelacionados')?.value?.length)">Nenhum documento relacionado.</p>
            <label class="primary upload-button">
              <input type="file" accept="application/pdf" (change)="onFileSelected($event, ['anexos', 'documentosRelacionados'], 'outro')" />
              Adicionar documento
            </label>
          </div>
        </div>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'aditivos'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Registre prorrogações, ajustes de valor e alterações contratuais.</p>
        </div>
        <span class="pill" *ngIf="termoEmEdicao">Vinculado a {{ termoEmEdicao.numeroTermo }}</span>
      </div>

      <div class="aditivo-grid" formGroupName="aditivo">
        <label class="field">Tipo de aditivo*
          <select formControlName="tipoAditivo">
            <option value="">Selecione</option>
            <option value="Prorrogacao">Prorrogação de prazo</option>
            <option value="Reajuste">Reajuste de valor</option>
            <option value="Clausula">Alteração de cláusula</option>
            <option value="Outro">Outro</option>
          </select>
        </label>
        <label class="field">Data do aditivo*<input type="date" formControlName="dataAditivo" /></label>
        <label class="field">Nova data fim<input type="date" formControlName="novaDataFim" /></label>
        <label class="field">Novo valor<input type="number" formControlName="novoValor" placeholder="0,00" /></label>
        <label class="field full">Observações<textarea rows="2" formControlName="observacoes" placeholder="Resumo das alterações"></textarea></label>
        <div class="upload-card full">
          <div class="upload-card__header">
            <div>
              <p class="upload-card__title">Anexo do aditivo (PDF)</p>
              <p class="muted">Carregue o documento assinado do aditivo.</p>
            </div>
            <span class="pill">PDF</span>
          </div>
          <div class="upload-card__body">
            <p class="muted" *ngIf="!(form.get('aditivo.anexo')?.value)">Nenhum arquivo selecionado.</p>
            <div class="file-chip" *ngIf="form.get('aditivo.anexo')?.value as aditivoDoc">
              <span class="file-chip__name">{{ aditivoDoc.nome }}</span>
              <span class="file-chip__meta">{{ aditivoDoc.tipo?.toUpperCase() || 'ADITIVO' }}</span>
            </div>
            <label class="primary upload-button">
              <input type="file" accept="application/pdf" (change)="onFileSelected($event, ['aditivo', 'anexo'], 'aditivo')" />
              Carregar PDF
            </label>
          </div>
        </div>
        <div class="tab-actions full">
          <button class="ghost" type="button" (click)="goToPreviousTab()" *ngIf="hasPreviousTab">Voltar</button>
          <button class="primary" type="button" (click)="saveAditivo()">Salvar aditivo</button>
        </div>
      </div>

      <div class="list-card aditivo-list" *ngIf="termoEmEdicao">
        <div class="list-card__header">
          <div>
            <p class="page-title__eyebrow">Histórico</p>
            <p class="page-title__label">Aditivos registrados</p>
          </div>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Tipo</th>
                <th>Nova vigência</th>
                <th>Novo valor</th>
                <th>Observações</th>
                <th></th>
              </tr>
            </thead>
              <tbody>
                <tr *ngFor="let aditivo of termoEmEdicao.aditivos || []">
                  <td>{{ formatDate(aditivo.dataAditivo) }}</td>
                  <td>{{ aditivo.tipoAditivo }}</td>
                  <td>{{ formatDate(aditivo.novaDataFim) }}</td>
                  <td>{{ formatCurrency(aditivo.novoValor) }}</td>
                  <td>{{ aditivo.observacoes || '—' }}</td>
                  <td class="text-right">
                    <a
                      class="primary"
                      *ngIf="aditivo.anexo?.dataUrl"
                      [href]="aditivo.anexo?.dataUrl"
                      target="_blank"
                    >
                      Abrir PDF
                    </a>
                  </td>
                </tr>
                <tr *ngIf="!(termoEmEdicao.aditivos?.length)">
                  <td colspan="6" class="muted">Nenhum aditivo cadastrado.</td>
                </tr>
              </tbody>
          </table>
        </div>
      </div>
    </div>
  </form>

  <div class="list-card">
    <div class="list-card__header">
      <div>
        <p class="page-title__eyebrow">Termos cadastrados</p>
        <p class="page-title__label">Painel de gestão</p>
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Número</th>
            <th>Tipo</th>
            <th>Órgão concedente</th>
            <th>Vigência</th>
            <th>Situação</th>
            <th>Valor</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let termo of filteredTermos; index as i">
            <td>{{ i + 1 }}</td>
            <td>
              <div class="strong">{{ termo.numeroTermo }}</div>
              <div class="muted">{{ termo.responsavelInterno || 'Sem responsável' }}</div>
            </td>
            <td>{{ termo.tipoTermo }}</td>
            <td>{{ termo.orgaoConcedente || '—' }}</td>
            <td>{{ formatDate(termo.dataInicioVigencia) }} — {{ formatDate(termo.dataFimVigencia) }}</td>
            <td>
              <span class="badge" [ngClass]="statusBadge(termo)?.tone">{{ statusBadge(termo)?.label }}</span>
              <div class="muted">{{ termo.situacao }}</div>
            </td>
            <td>{{ formatCurrency(termo.valorGlobal) }}</td>
            <td class="text-right">
              <div class="table-actions">
                <button class="ghost" type="button" (click)="editTermo(termo)">Editar</button>
                <button class="danger" type="button" (click)="deleteTermo(termo)">Excluir</button>
                <button class="primary" type="button" (click)="visualizarTermo(termo)">Visualizar termo</button>
              </div>
            </td>
          </tr>
          <tr *ngIf="!filteredTermos.length">
            <td colspan="8" class="muted">Nenhum termo encontrado com os filtros atuais.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>
