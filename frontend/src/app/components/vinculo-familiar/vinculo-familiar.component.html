<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  (salvar)="saveFamily()"
  (novo)="startNewFamily()"
  (cancelar)="startNewFamily()"
  (buscar)="onBuscar()"
  (fechar)="closeForm()"
>
  <header class="page-title" slot="titulo">
    <p class="page-title__eyebrow">Vínculo familiar</p>
    <p class="page-title__label">Cadastro de familias</p>
    <p class="page-title__note">Cadastro e gestao de vinculos familiares.</p>
  </header>

  <section class="cadastro">
    <div class="tab-shell">
      <p class="tab-shell__title">Navegacao por etapas</p>
      <ol class="step-tabs" role="tablist">
        <li
          *ngFor="let tab of tabs; index as idx"
          class="step-tabs__item"
          [class.active]="activeTab === tab.id"
          [class.completed]="idx < activeTabIndex"
        >
          <button
            class="step-tabs__button"
            type="button"
            role="tab"
            [attr.aria-selected]="activeTab === tab.id"
            (click)="changeTab(tab.id)"
          >
            <span class="step-tabs__index">{{ idx + 1 }}</span>
            <span class="step-tabs__label">{{ tab.label }}</span>
          </button>
        </li>
      </ol>
    </div>

    <form [formGroup]="familyForm" (ngSubmit)="saveFamily()" class="form-shell">
      <app-popup-messages [mensagens]="popupErros" (fechar)="fecharPopupErros()"></app-popup-messages>

      <div *ngIf="feedback" class="feedback">
        <span>{{ feedback }}</span>
        <button type="button" class="feedback__close" (click)="clearFeedback()" aria-label="Fechar aviso">X</button>
      </div>

      <ng-template #navigationControls>
        <div class="tab-actions">
          <button type="button" class="ghost" *ngIf="hasPreviousTab" (click)="goToPreviousTab()">Voltar</button>
          <button type="button" class="primary" *ngIf="hasNextTab" (click)="goToNextTab()">
            Próximo: {{ nextTabLabel }}
          </button>
          <button type="submit" class="primary" [disabled]="saving" *ngIf="!hasNextTab">
            {{ saving ? 'Salvando...' : 'Salvar vinculo familiar' }}
          </button>
        </div>
      </ng-template>

      <div class="tab-card" *ngIf="activeTab === 'cadastro'">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">Cadastro da familia</p>
            <p class="muted">Informe o nome da familia e identifique o responsavel principal.</p>
          </div>
        </div>
        <div class="field-grid cols-2">
          <label class="field">Status
            <select formControlName="status">
              <option *ngFor="let status of statusOptions" [value]="status">{{ formatarStatusLabel(status) }}</option>
            </select>
          </label>
          <label class="field">
            Nome da familia*
            <input formControlName="nome_familia" placeholder="Ex.: Familia Souza" />
          </label>
          <label class="field">
            Responsavel principal*
            <input [value]="principalLabel" readonly />
          </label>
        </div>
        <div class="search-block">
          <label class="field">
            Buscar familia cadastrada
            <input [formControl]="familySearch" placeholder="Digite o nome da familia" />
          </label>
          <div class="suggestions" *ngIf="familyLoading">
            <p class="muted">Buscando familias...</p>
          </div>
          <div class="suggestions" *ngIf="familyError">
            <p class="muted text-error">{{ familyError }}</p>
          </div>
          <ul class="suggestions" *ngIf="!familyLoading && familyResults.length">
            <li *ngFor="let familia of familyResults">
              <button type="button" (click)="selectFamily(familia)">
                <div>
                  <strong>{{ familia.nome_familia }}</strong>
                  <small>{{ familia.municipio || 'Município n?o informado' }}</small>
                </div>
                <span class="pill">Carregar</span>
              </button>
            </li>
          </ul>
        </div>
        <div class="search-block">
          <label class="field">
            Buscar responsavel
            <input [formControl]="principalSearch" placeholder="Digite nome ou CPF" />
          </label>
          <div class="suggestions" *ngIf="principalLoading">
            <p class="muted">Buscando beneficiários...</p>
          </div>
          <div class="suggestions" *ngIf="principalError">
            <p class="muted text-error">{{ principalError }}</p>
          </div>
          <ul class="suggestions" *ngIf="!principalLoading && principalResults.length">
            <li *ngFor="let beneficiary of principalResults">
              <button type="button" (click)="selectPrincipal(beneficiary)">
                <div>
                  <strong>{{ beneficiary.nome_completo || beneficiary.nome_social }}</strong>
                  <small>{{ beneficiary.cpf || beneficiary.nis || beneficiary.codigo || 'Documento não informado' }}</small>
                </div>
                <span class="pill">Selecionar</span>
              </button>
            </li>
          </ul>
        </div>
        <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
      </div>

      <div class="tab-card" *ngIf="activeTab === 'endereço'">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">Endereço da familia</p>
            <p class="muted">Esse endereço sera a referencia principal para todos os membros.</p>
          </div>
          <label class="checkbox-field checkbox-field--inline">
            <input type="checkbox" [checked]="applyAddressToMembers" (change)="toggleAddressForAll()" />
            <span>Aplicar endereço da familia aos membros vinculados</span>
          </label>
        </div>
        <div class="field-grid cols-3">
          <label class="field">
            CEP
            <input formControlName="cep" placeholder="00000-000" (input)="onFamilyCepInput($event)" (blur)="onFamilyCepBlur()" />
            <p class="field-error" *ngIf="familyForm.get('cep')?.invalid && familyForm.get('cep')?.touched">
              Informe um CEP valido.
            </p>
            <p class="field-error" *ngIf="cepLookupError">{{ cepLookupError }}</p>
          </label>
          <label class="field">Logradouro<input formControlName="logradouro" /></label>
          <label class="field">Número<input formControlName="numero" /></label>
          <label class="field">Complemento<input formControlName="complemento" /></label>
          <label class="field">Bairro<input formControlName="bairro" /></label>
          <label class="field">Ponto de referencia<input formControlName="ponto_referencia" /></label>
          <label class="field">Município<input formControlName="municipio" /></label>
          <label class="field">UF<input maxlength="2" formControlName="uf" /></label>
          <label class="field">Zona<input formControlName="zona" placeholder="Urbana, rural..." /></label>
        </div>
        <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
      </div>

      <div class="tab-card" *ngIf="activeTab === 'membros'" formArrayName="membros">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">Membros vinculados</p>
            <p class="muted">Adicione os beneficiários que compoem o nucleo familiar.</p>
          </div>
        </div>
        <div class="search-block">
          <label class="field">
            Buscar beneficiário
            <input [formControl]="memberSearch" placeholder="Digite nome ou CPF" />
          </label>
          <div class="suggestions" *ngIf="memberLoading">
            <p class="muted">Buscando beneficiários...</p>
          </div>
          <div class="suggestions" *ngIf="memberError">
            <p class="muted text-error">{{ memberError }}</p>
          </div>
          <ul class="suggestions" *ngIf="!memberLoading && memberResults.length">
            <li *ngFor="let beneficiary of memberResults">
              <button type="button" (click)="addMember(beneficiary)">
                <div>
                  <strong>{{ beneficiary.nome_completo || beneficiary.nome_social }}</strong>
                  <small>{{ beneficiary.cpf || beneficiary.nis || beneficiary.codigo || 'Documento não informado' }}</small>
                </div>
                <span class="pill">Adicionar</span>
              </button>
            </li>
          </ul>
        </div>

        <div class="members-grid" *ngIf="membros.length; else emptyMembers">
          <div class="member-card" *ngFor="let member of membros.controls; index as i" [formGroupName]="i">
            <div class="member-card__header">
              <div>
                <p class="member-card__name">{{ member.get('nome')?.value }}</p>
                <p class="member-card__meta">{{ member.get('documento')?.value || 'Documento não informado' }}</p>
              </div>
              <button type="button" class="ghost destructive" (click)="removeMember(i)">Remover</button>
            </div>
            <div class="member-card__address" *ngIf="member.get('usa_endereço_familia')?.value">
              <p class="member-card__address-label">Endereço da familia aplicado</p>
              <p class="member-card__address-value">
                {{ familyAddressLabel || 'Informe o endereço da familia para preencher os membros.' }}
              </p>
            </div>
            <div class="field-grid cols-2 compact">
              <label class="field">
                Parentesco*
                <select formControlName="parentesco">
                  <option value="">Selecione</option>
                  <option *ngFor="let option of relationshipOptions" [value]="option">{{ option }}</option>
                </select>
              </label>
              <label class="checkbox-field">
                <input type="checkbox" formControlName="responsavel_familiar" />
                <span>Responsavel familiar</span>
              </label>
              <label class="checkbox-field">
                <input type="checkbox" formControlName="contribui_renda" />
                <span>Contribui com a renda</span>
              </label>
              <label class="field">
                Renda individual
                <input formControlName="renda_individual" placeholder="R$" />
              </label>
              <label class="checkbox-field">
                <input type="checkbox" formControlName="participa_servicos" />
                <span>Participa dos servicos</span>
              </label>
              <label class="checkbox-field">
                <input type="checkbox" formControlName="usa_endereço_familia" />
                <span>Usa o endereço da familia</span>
              </label>
            </div>
            <label class="field">
              Observações
              <textarea formControlName="observacoes" rows="2"></textarea>
            </label>
          </div>
        </div>

        <ng-template #emptyMembers>
          <div class="empty-state">Nenhum beneficiário vinculado ainda.</div>
        </ng-template>
        <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
      </div>

      <div class="tab-card" *ngIf="activeTab === 'indicadores'">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">Indicadores sociais</p>
            <p class="muted">Informações para analise social e planejamento de atendimentos.</p>
          </div>
        </div>
        <div class="field-grid cols-3">
          <label class="field">Arranjo familiar<input formControlName="arranjo_familiar" /></label>
          <label class="field">Situação do imovel<select formControlName="situacao_imovel">
              <option value="">Selecione</option>
              <option *ngFor="let option of housingOptions" [value]="option">{{ option }}</option>
            </select></label>
          <label class="field">Tipo de moradia<select formControlName="tipo_moradia">
              <option value="">Selecione</option>
              <option *ngFor="let option of housingTypes" [value]="option">{{ option }}</option>
            </select></label>
          <label class="field">Total de membros<input type="number" formControlName="qtd_membros" /></label>
          <label class="field">Criancas<input type="number" formControlName="qtd_criancas" /></label>
          <label class="field">Adolescentes<input type="number" formControlName="qtd_adolescentes" /></label>
          <label class="field">Idosos<input type="number" formControlName="qtd_idosos" /></label>
          <label class="field">Pessoas com deficiencia<input type="number" formControlName="qtd_pessoas_deficiencia" /></label>
          <label class="field">Renda familiar total<input formControlName="renda_familiar_total" placeholder="R$" /></label>
          <label class="field">Renda per capita<input formControlName="renda_per_capita" placeholder="R$" /></label>
          <label class="field">Faixa renda per capita<input formControlName="faixa_renda_per_capita" /></label>
          <label class="field">Principais fontes de renda<textarea formControlName="principais_fontes_renda" rows="2"></textarea></label>
          <label class="field">Inseguranca alimentar<textarea formControlName="situacao_inseguranca_alimentar" rows="2"></textarea></label>
          <label class="checkbox-field">
            <input type="checkbox" formControlName="possui_d?vidas_relevantes" />
            <span>Possui d?vidas relevantes</span>
          </label>
          <label class="field">Descrição das d?vidas<textarea formControlName="descricao_d?vidas" rows="2"></textarea></label>
          <label class="field">Vulnerabilidades familiares<textarea formControlName="vulnerabilidades_familia" rows="2"></textarea></label>
          <label class="field">Servicos de acompanhamento<textarea formControlName="servicos_acompanhamento" rows="2"></textarea></label>
          <label class="field">Tecnico responsavel<input formControlName="tecnico_responsavel" /></label>
          <label class="field">Periodicidade de atendimento<input formControlName="periodicidade_atendimento" /></label>
          <label class="field">Proxima visita prevista<input type="date" formControlName="proxima_visita_prevista" /></label>
          <label class="field">Observações<textarea formControlName="observacoes" rows="3"></textarea></label>
        </div>
        <div class="field-grid cols-3 compact">
          <label class="checkbox-field">
            <input type="checkbox" formControlName="agua_encanada" />
            <span>Agua encanada</span>
          </label>
          <label class="checkbox-field">
            <input type="checkbox" formControlName="energia_eletrica" />
            <span>Energia eletrica</span>
          </label>
          <label class="checkbox-field">
            <input type="checkbox" formControlName="internet" />
            <span>Internet</span>
          </label>
          <label class="field">Tipo de esgoto<input formControlName="esgoto_tipo" /></label>
          <label class="field">Coleta de lixo<input formControlName="coleta_lixo" /></label>
        </div>
        <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
      </div>

      <div class="tab-card" *ngIf="activeTab === 'lista'">
        <div class="tab-card__header">
          <div class="tab-card__title-stack">
            <p class="tab-card__highlight">Listagem de familias</p>
            <p class="muted">Localizacao completa para correspondencias e visitas.</p>
          </div>
          <div class="tab-card__header-actions">
            <button type="button" class="btn-outline" (click)="limparFiltrosListagem()">Limpar</button>
            <button type="button" class="btn-outline" (click)="aplicarFiltrosListagem()">Buscar</button>
          </div>
        </div>

        <form [formGroup]="listagemForm" class="list-filters" (ngSubmit)="aplicarFiltrosListagem()">
          <label class="field">Nome
            <input type="text" formControlName="nome" placeholder="Digite parte do nome" />
          </label>
          <label class="field">CPF
            <input type="text" formControlName="cpf" placeholder="Somente numeros" />
          </label>
          <label class="field">Código
            <input type="text" formControlName="codigo" placeholder="Ex.: 0001" />
          </label>
          <label class="field">Nascimento
            <input type="date" formControlName="dataNascimento" />
          </label>
          <label class="field">Status
            <select formControlName="status">
              <option value="">Todos</option>
              <option *ngFor="let status of statusOptions" [value]="status">{{ formatarStatusLabel(status) }}</option>
            </select>
          </label>
        </form>

        <div class="unit-list" *ngIf="familiasPaginadas.length">
          <div class="unit-list__item" *ngFor="let familia of familiasPaginadas">
            <div>
              <div class="unit-list__header-row">
                <span class="unit-list__code">Código: {{ familia.id_familia || '---' }}</span>
                <span class="pill" [ngClass]="getStatusClass(familia.status)">{{ formatarStatusLabel(familia.status) }}</span>
              </div>
              <div class="unit-list__name-row">
                <div class="unit-list__avatar">
                  <span aria-hidden="true">
                    {{
                      ((familia.nome_familia || 'F').trim().split(' ')[0] || 'F')[0] +
                      ((familia.nome_familia || '').trim().split(' ')[1] || '')[0]
                    }}
                  </span>
                </div>
                <p class="unit-list__name-text">{{ familia.nome_familia || 'familia sem nome' }}</p>
              </div>
              <div class="unit-list__info-row">
                <span class="unit-list__meta-text" [title]="getReferenciaFamilia(familia)?.bairro || 'Bairro n?o informado'">
                  <span class="unit-list__meta-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24">
                      <path
                        d="M12 2.5c-4.14 0-7.5 3.17-7.5 7.09 0 4.73 6.39 11.22 7.02 11.85a.68.68 0 0 0 .96 0c.63-.63 7.02-7.12 7.02-11.85C19.5 5.67 16.14 2.5 12 2.5zm0 10.2a3.1 3.1 0 1 1 0-6.2 3.1 3.1 0 0 1 0 6.2z"
                      />
                    </svg>
                  </span>
                  <strong>Bairro:</strong> {{ getReferenciaFamilia(familia)?.bairro || 'Bairro n?o informado' }}
                </span>
                <span class="unit-list__separator">&middot;</span>
                <span class="unit-list__meta-text">
                  <span class="unit-list__meta-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24">
                      <path
                        d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5C23 14.17 18.33 13 16 13z"
                      />
                    </svg>
                  </span>
                  <strong>Membros:</strong> {{ formatarMembrosFamilia(familia) }}
                </span>
              </div>
            </div>
            <div class="unit-list__actions">
              <button type="button" class="btn-outline btn-small" (click)="editarFamiliaNaLista(familia)">
                Editar
              </button>
            </div>
          </div>
        </div>

        <div class="unit-list__pagination" *ngIf="familiasFiltradas.length && familiasPaginadas.length">
          <span class="unit-list__total">
            Total: {{ familiasFiltradas.length }} familias
          </span>
          <button type="button" class="btn-outline" (click)="paginaAnterior()" [disabled]="paginaAtual === 1">
            Anterior
          </button>
          <span class="unit-list__page">
            Página {{ paginaAtual }} de {{ totalPaginas }}
          </span>
          <button type="button" class="btn-outline" (click)="proximaPagina()" [disabled]="paginaAtual >= totalPaginas">
            Próximo
          </button>
        </div>

        <p class="muted" *ngIf="!familiasFiltradas.length">Nenhuma familia cadastrada ate o momento.</p>
      </div>
    </form>
  </section>
</app-tela-padrao>




