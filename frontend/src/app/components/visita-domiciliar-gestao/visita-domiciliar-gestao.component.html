<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  [fullWidth]="true"
  (salvar)="submit()"
  (excluir)="handleExcluir()"
  (novo)="novaVisita()"
  (cancelar)="resetForm()"
  (imprimir)="imprimirVisita()"
  (buscar)="onBuscar()"
  (fechar)="closeForm()"
>
  <section class="cadastro">
  <div class="cadastro-layout">
    <aside class="cadastro-menu">
      <div class="tab-shell">
        <p class="tab-shell__title tab-shell__title--destaque">
          <fa-icon [icon]="faClipboardUser" class="tab-shell__icon"></fa-icon>
          Registro de visitas
        </p>
        <ol class="step-tabs" role="tablist">
          <li
            *ngFor="let tab of tabs; index as idx"
            class="step-tabs__item"
            [class.active]="activeTab === tab.id"
            [class.completed]="idx < activeTabIndex"
          >
            <button
              class="step-tabs__button"
              type="button"
              role="tab"
              [attr.aria-selected]="activeTab === tab.id"
              (click)="changeTab(tab.id)"
            >
              <span class="step-tabs__index">{{ idx + 1 }}</span>
              <span class="step-tabs__label">{{ tab.label }}</span>
            </button>
          </li>
        </ol>
      </div>
    </aside>

    <div class="cadastro-conteudo">
  <form [formGroup]="visitForm" (ngSubmit)="submit()" class="form-shell">
    <div *ngIf="feedback" class="feedback">
      <span>{{ feedback }}</span>
      <button type="button" class="feedback__close" (click)="dismissFeedback()">X</button>
    </div>

    <ng-template #navigationControls>
      <div class="tab-actions">
        <button type="button" class="ghost" *ngIf="hasPreviousTab" (click)="goToPreviousTab()">Voltar</button>
        <button type="button" class="primary" *ngIf="hasNextTab" (click)="goToNextTab()">
          Próximo: {{ nextTabLabel }}
        </button>
        <button type="submit" class="primary" [disabled]="saving" *ngIf="!hasNextTab">
          {{ saving ? 'Salvando...' : editingId ? 'Atualizar visita' : 'Salvar visita' }}
        </button>
      </div>
    </ng-template>

    <div class="tab-card" *ngIf="activeTab === 'identificacao'" formGroupName="identificacao">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
        </div>
        <span class="pill">Obrigatório</span>
      </div>
      <div class="tab-card__status" *ngIf="beneficiarioAptidao">
        <p class="muted">
          <strong>Aptidão para doações:</strong> {{ formatarAptidaoDoacoes() }}
        </p>
      </div>
      <div class="field-grid cols-3">
        <label class="field">Unidade de atendimento*
          <select formControlName="unidade">
            <option value=""></option>
            <option *ngFor="let unidade of unidades" [value]="unidade">{{ unidade }}</option>
          </select>
        </label>
        <label class="field">Beneficiário*
          <app-autocomplete
            [opcoes]="beneficiarioOpcoes"
            [termo]="beneficiarioTermo"
            [carregando]="beneficiariosLoading"
            [erro]="beneficiariosError"
            placeholder="Digite o nome do beneficiário"
            (termoChange)="atualizarTermoBeneficiario($event)"
            (selecionar)="selecionarBeneficiario($event)"
          ></app-autocomplete>
        </label>
        <p class="muted" *ngIf="beneficiariosLoading">Carregando beneficiários...</p>
        <p class="muted text-red-600" *ngIf="beneficiariosError">{{ beneficiariosError }}</p>
        <label class="field">Responsável pela visita*<select formControlName="responsavel">
            <option value=""></option>
            <option *ngFor="let responsavel of responsaveis" [value]="responsavel">{{ responsavel }}</option>
          </select></label>
        <label class="field">Data da visita*<input type="date" formControlName="dataVisita" /></label>
        <label class="field">Horário inicial*<input type="time" formControlName="horarioInicial" /></label>
        <label class="field">Horário final<input type="time" formControlName="horarioFinal" /></label>
        <label class="field">Tipo de visita<select formControlName="tipoVisita">
            <option value=""></option>
            <option *ngFor="let tipo of tiposVisita" [value]="tipo">{{ tipo }}</option>
          </select></label>
        <label class="field">Situação da visita*<select formControlName="situacao">
            <option value=""></option>
            <option *ngFor="let situacao of situacoes" [value]="situacao">{{ situacao }}</option>
          </select></label>
        <label class="field full">Observações iniciais<textarea formControlName="observacoesIniciais" rows="3" placeholder="Resumo do objetivo da visita"></textarea></label>
        <div class="feature-grid">
          <label class="checkbox-field"><input type="checkbox" formControlName="usarEnderecoBeneficiario" (change)="onToggleEnderecoBeneficiario()" />
            <span>Utilizar endereço do beneficiário</span></label>
        </div>
        <div class="field full" formGroupName="endereco">
          <p class="field-title">Endereço da visita (preencha apenas se diferente do beneficiário)</p>
          <div class="field-grid cols-3">
            <label class="field">Logradouro<input formControlName="logradouro" /></label>
            <label class="field">Número<input formControlName="numero" /></label>
            <label class="field">Bairro<input formControlName="bairro" /></label>
            <label class="field">Cidade<input formControlName="cidade" /></label>
            <label class="field">UF<input maxlength="2" formControlName="uf" /></label>
            <label class="field">CEP<input formControlName="cep" /></label>
          </div>
        </div>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'condicoes'" formGroupName="condicoes">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
        </div>
      </div>
      <div class="field-grid cols-3">
        <label class="field">Tipo de moradia<select formControlName="tipoMoradia">
            <option value=""></option>
            <option *ngFor="let situacao of situacaoMoradia" [value]="situacao">{{ situacao }}</option>
          </select></label>
        <label class="field">Situação de posse<select formControlName="situacaoPosse">
            <option value=""></option>
            <option *ngFor="let situacao of situacaoPosse" [value]="situacao">{{ situacao }}</option>
          </select></label>
        <label class="field">Quantidade de comodos<input type="number" formControlName="comodos" /></label>
        <label class="field">Saneamento<select formControlName="saneamento">
            <option value=""></option>
            <option *ngFor="let option of saneamento" [value]="option">{{ option }}</option>
          </select></label>
        <label class="field">Abastecimento de agua<select formControlName="abastecimentoAgua">
            <option value=""></option>
            <option *ngFor="let option of abastecimentoAgua" [value]="option">{{ option }}</option>
          </select></label>
        <label class="field">Energia eletrica<select formControlName="energiaEletrica">
            <option value=""></option>
            <option *ngFor="let option of energia" [value]="option">{{ option }}</option>
          </select></label>
        <label class="field">Condições de higiene<select formControlName="condicoesHigiene">
            <option value=""></option>
            <option *ngFor="let option of higiene" [value]="option">{{ option }}</option>
          </select></label>
        <div class="field full">
          <p class="field-title">Situação de risco</p>
          <div class="chips">
            <label *ngFor="let risco of riscos" class="chip">
              <input type="checkbox" [checked]="selectionChecked(['condicoes', 'situacaoRisco'], risco)" (change)="toggleSelection(['condicoes', 'situacaoRisco'], risco)" />
              <span>{{ risco }}</span>
            </label>
          </div>
        </div>
        <label class="field full">Observações<textarea formControlName="observacoes" rows="3"></textarea></label>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'social'" formGroupName="situacaoSocial">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
        </div>
      </div>
      <div class="field-grid cols-2">
        <label class="field">Renda familiar estimada<input formControlName="rendaFamiliar" placeholder="Ex.: R$ 1.800,00" /></label>
        <label class="field">Faixa de renda<select formControlName="faixaRenda">
            <option value=""></option>
            <option *ngFor="let faixa of faixasRenda" [value]="faixa">{{ faixa }}</option>
          </select></label>
        <div class="field full">
          <p class="field-title">benefícios sociais</p>
          <div class="chips">
            <label *ngFor="let beneficio of beneficiosSociais" class="chip">
              <input type="checkbox" [checked]="selectionChecked(['situacaoSocial', 'beneficios'], beneficio)" (change)="toggleSelection(['situacaoSocial', 'beneficios'], beneficio)" />
              <span>{{ beneficio }}</span>
            </label>
          </div>
        </div>
        <label class="field">Rede de apoio<textarea rows="3" formControlName="redeApoio" placeholder="Vizinhos, parentes, igreja..."></textarea></label>
        <label class="field">Vinculos comunitarios<textarea rows="3" formControlName="vinculos" placeholder="Como participa da comunidade"></textarea></label>
        <label class="field full">Observações sociais<textarea rows="3" formControlName="observacoes"></textarea></label>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'registro'" formGroupName="registro">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
        </div>
        <span class="pill">Obrigatório se realizada</span>
      </div>
      <div class="field-grid cols-2">
        <label class="field full">Relato da visita<textarea formControlName="relato" rows="4" placeholder="Descreva como foi a visita"></textarea></label>
        <label class="field">Necessidades identificadas<textarea formControlName="necessidades" rows="3"></textarea></label>
        <label class="field">Encaminhamentos realizados<textarea formControlName="encaminhamentos" rows="3" placeholder="Serviço/setor, data, responsável"></textarea></label>
        <label class="field">Orientações dadas<textarea formControlName="orientacoes" rows="3"></textarea></label>
        <label class="field full">Plano de acompanhamento<textarea formControlName="plano" rows="3" placeholder="ações planejadas com prazo/responsável"></textarea></label>
        <label class="field">Usuário necessita de cesta básica?*
          <select formControlName="optaReceberCestaBasica" (change)="onOptaCestaBasicaChange()">
            <option [ngValue]="null"></option>
            <option [ngValue]="true">Sim</option>
            <option [ngValue]="false">Não</option>
          </select>
        </label>
        <label class="field" *ngIf="visitForm.get('registro.optaReceberCestaBasica')?.value === true">Apto a receber cesta básica?*
          <select formControlName="aptoReceberCestaBasica" (change)="onAptoCestaBasicaChange()">
            <option [ngValue]="null"></option>
            <option [ngValue]="true">Sim</option>
            <option [ngValue]="false">Não</option>
          </select>
        </label>
        <label class="field" *ngIf="visitForm.get('registro.optaReceberCestaBasica')?.value === true && visitForm.get('registro.aptoReceberCestaBasica')?.value === false">Motivo:*
          <input formControlName="motivoNaoReceberCestaBasica" placeholder="Informe o motivo" />
        </label>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'anexos'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
        </div>
      </div>
      <div class="field-grid cols-3" [formGroup]="anexoForm">
        <label class="field">Nome do arquivo*<input formControlName="nome" placeholder="Ex.: foto-fachada.jpg" /></label>
        <label class="field">Tipo<select formControlName="tipo">
            <option value="Imagem">Imagem</option>
            <option value="PDF">PDF</option>
            <option value="Documento">Documento</option>
          </select></label>
        <label class="field">Tamanho<input formControlName="tamanho" placeholder="Ex.: 1.2 MB" /></label>
        <div class="actions full">
          <button type="button" class="primary" (click)="addAnexo()">Adicionar anexo</button>
          <button type="button" class="ghost" (click)="anexoForm.reset({ tipo: 'PDF' })">Limpar</button>
        </div>
      </div>

      <div class="list-card compact" *ngIf="(visitForm.get('anexos')?.value?.length ?? 0) > 0">
        <div class="list-card__header">
          <div>
            <p class="page-title__eyebrow">Lista de anexos</p>
            <p class="page-title__label">Arquivos vinculados a visita</p>
          </div>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Tipo</th>
                <th>Tamanho</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let anexo of visitForm.get('anexos')?.value">
                <td>{{ anexo.nome }}</td>
                <td>{{ anexo.tipo }}</td>
                <td>{{ anexo.tamanho || '---' }}</td>
                <td class="text-right">
                  <div class="table-actions">
                    <button type="button" class="ghost">Visualizar</button>
                    <button type="button" class="danger" (click)="removerAnexo(anexo)">Excluir</button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'historico'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
        </div>
      </div>
      <div class="list-card compact">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Situação</th>
                <th>Responsável</th>
                <th>Unidade</th>
                <th>Resumo</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let visita of historicoBeneficiario" [class.row-highlight]="visita.situacao === 'Agendada'">
                <td>{{ visita.dataVisita }}</td>
                <td>
                  <span
                    class="status-badge"
                    [class.status-badge--agendada]="visita.situacao === 'Agendada'"
                    [class.status-badge--realizada]="visita.situacao === 'Realizada'"
                  >
                    {{ visita.situacao }}
                  </span>
                  <button
                    *ngIf="visita.situacao === 'Agendada'"
                    type="button"
                    class="ghost btn-inline"
                    (click)="marcarVisitaRealizada(visita)"
                  >
                    Marcar como realizada
                  </button>
                </td>
                <td>{{ visita.responsavel }}</td>
                <td>{{ visita.unidade }}</td>
                <td>{{ visita.observacoesIniciais || visita.registro.relato || '---' }}</td>
              </tr>
              <tr *ngIf="!historicoBeneficiario.length">
                <td colspan="5" class="muted">Nenhuma visita anterior encontrada para este beneficiário.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>      
    </div>

    <div class="tab-card" *ngIf="activeTab === 'listagem'">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
        </div>
      </div>

      <div class="list-card">
        <div class="list-card__header">
          <div>
            <p class="page-title__eyebrow">Visitas registradas</p>
            <p class="page-title__label">Listagem e filtros</p>
          </div>
          <div class="list-card__actions">
            <button class="ghost" type="button" (click)="novaVisita()">Nova visita</button>
          </div>
        </div>

        <form class="filters" [formGroup]="filterForm" (ngSubmit)="aplicarFiltros()">
          <div class="field-grid cols-3">
            <label class="field">Data inicial<input type="date" formControlName="dataInicial" /></label>
            <label class="field">Data final<input type="date" formControlName="dataFinal" /></label>
            <label class="field">Unidade<select formControlName="unidade">
                <option value=""></option>
                <option *ngFor="let unidade of unidades" [value]="unidade">{{ unidade }}</option>
              </select></label>
            <label class="field">Situação<select formControlName="situacao">
                <option value=""></option>
                <option *ngFor="let situacao of situacoes" [value]="situacao">{{ situacao }}</option>
              </select></label>
            <label class="field">Beneficiário<input formControlName="beneficiario" placeholder="Buscar por nome" /></label>
            <label class="field">Responsável<input formControlName="responsavel" placeholder="Profissional/voluntário" /></label>
          </div>
          <div class="actions">
            <button class="ghost" type="button" (click)="filterForm.reset(); aplicarFiltros();">Limpar filtros</button>
            <button class="primary" type="submit">Aplicar</button>
          </div>
        </form>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Data da visita</th>
                <th>Beneficiário</th>
                <th>Responsável</th>
                <th>Unidade</th>
                <th>Situação</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let visita of filteredVisitas" (dblclick)="editarVisita(visita)">
                <td>{{ visita.dataVisita }}</td>
                <td>
                  <div class="strong">{{ visita.beneficiario }}</div>
                  <div class="muted">{{ visita.tipoVisita || '---' }}</div>
                </td>
                <td>{{ visita.responsavel }}</td>
                <td>{{ visita.unidade }}</td>
                <td>{{ visita.situacao }}</td>
                <td class="text-right">
                  <div class="table-actions">
                    <button class="primary" type="button" (click)="cancelarVisita(visita)" [disabled]="visita.situacao === 'Cancelada'">Cancelar</button>
                    <button class="danger" type="button" (click)="excluirVisita(visita)">Excluir</button>
                  </div>
                </td>
              </tr>
              <tr *ngIf="!filteredVisitas.length">
                <td colspan="6" class="muted">Nenhuma visita encontrada para os filtros informados.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
    </div>
  </form>
    </div>
  </div>
</section>
</app-tela-padrao>

