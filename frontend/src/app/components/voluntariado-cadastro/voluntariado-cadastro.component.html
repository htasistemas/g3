<app-tela-padrao
  [acoes]="acoesToolbar"
  [desabilitado]="acoesDesabilitadas"
  [mostrarFechar]="true"
  (imprimir)="printCurrentVolunteer()"
  (salvar)="submit()"
  (cancelar)="cancelEdit()"
  (excluir)="deleteCurrentVolunteer()"
  (novo)="startNewVolunteer()"
  (buscar)="onBuscar()"
  (fechar)="closeForm()"
>
<header class="page-title page-title--row" slot="titulo">
  <div>
    <p class="page-title__eyebrow">cadastros</p>
    <p class="page-title__label">cadastro de voluntÃ¡rio</p>
  </div>
    <p class="page-title__note">Cadastramento de voluntarios da instituicao.</p>
</header>

  <section class="cadastro">
  <app-popup-messages [mensagens]="popupErros" (fechar)="fecharPopupErros()"></app-popup-messages>
  <div class="tab-shell">
    <p class="tab-shell__title">Navegue pelas informaÃ§Ãµes</p>
    <ol class="step-tabs" role="tablist">
      <li
        *ngFor="let tab of tabs; index as idx"
        class="step-tabs__item"
        [class.active]="activeTab === tab.id"
        [class.completed]="idx < activeTabIndex"
      >
        <button
          class="step-tabs__button"
          type="button"
          role="tab"
          [attr.aria-selected]="activeTab === tab.id"
          (click)="changeTab(tab.id)"
        >
          <span class="step-tabs__index">{{ idx + 1 }}</span>
          <span class="step-tabs__label">{{ tab.label }}</span>
        </button>
      </li>
    </ol>
  </div>

  <form [formGroup]="form" (ngSubmit)="submit()" class="form-shell">
    <div *ngIf="feedback" class="feedback"><span>{{ feedback }}</span><button type="button" class="feedback__close" (click)="clearFeedback()" aria-label="Fechar mensagem">X</button></div>

    

    <div class="tab-card" *ngIf="activeTab === 'dados'" formGroupName="dadosPessoais">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
        </div>
        
      </div>
      <div class="tab-card__hero" [class.tab-card__hero--camera]="cameraActive">
        <div class="photo-section">
          <div class="photo-preview" [class.photo-preview--empty]="!photoPreview">
            <img *ngIf="photoPreview" [src]="photoPreview" alt="Foto 3x4 do voluntÃ¡rio" />
            <span *ngIf="!photoPreview">Foto 3x4 do voluntÃ¡rio</span>
          </div>
          <div class="photo-actions">
            <label class="upload-btn upload-btn--primary">
              Enviar foto 3x4
              <input type="file" accept="image/*" (change)="onPhotoSelected($event)" />
            </label>
            <button type="button" class="ghost" (click)="handleCameraCapture()">
              {{ cameraActive ? 'Registrar foto' : 'Capturar pela camera' }}
            </button>
            <button type="button" class="ghost" *ngIf="photoPreview" (click)="removePhoto()">Remover foto</button>
            <button type="button" class="ghost" *ngIf="cameraActive" (click)="stopCamera()">Fechar camera</button>
            <p class="photo-hint">Aceite arquivos enviados ou registre uma nova foto pela webcam.</p>
            <p *ngIf="captureError" class="field-error">{{ captureError }}</p>
          </div>
        </div>

        <div class="camera-panel" *ngIf="cameraActive">
          <p class="camera-panel__title">Visualização da camera</p>
          <div class="camera-panel__preview">
            <video #videoElement autoplay muted playsinline></video>
          </div>
          <p class="camera-panel__hint">Ajuste o enquadramento e clique em "Registrar foto" para salvar.</p>
        </div>
      </div>
      <canvas #canvasElement class="capture-canvas"></canvas>
      <div class="field-grid cols-3">
        <label class="field field--wide">Buscar profissional voluntÃ¡rio
          <input type="text" [value]="profissionalBusca" placeholder="Digite nome ou CPF" (input)="onBuscaProfissional($any($event.target).value)" />
          <div class="search-hint" *ngIf="carregandoProfissionais">Carregando profissionais...</div>
          <ul class="search-results" *ngIf="profissionalResultados.length">
            <li *ngFor="let profissional of profissionalResultados">
              <button type="button" (click)="selecionarProfissional(profissional)">
                <span>{{ profissional.nomeCompleto }}</span>
                <small>{{ profissional.cpf || 'CPF n?o informado' }}</small>
              </button>
            </li>
          </ul>
        </label>
        <label class="field field--compact">Status
          <select formControlName="status">
            <option *ngFor="let status of statusOptions" [value]="status">{{ formatarStatusLabel(status) }}</option>
          </select>
        </label>

        <label class="field full">Nome completo*<input formControlName="nomeCompleto" placeholder="Digite o nome completo" /></label>
        <label class="field">CPF*
          <input formControlName="cpf" placeholder="000.000.000-00" (input)="onCpfInput($event)" [class.input-error]="form.get(['dadosPessoais', 'cpf'])?.invalid && form.get(['dadosPessoais', 'cpf'])?.touched" />
          <p class="field-error" *ngIf="form.get(['dadosPessoais', 'cpf'])?.invalid && form.get(['dadosPessoais', 'cpf'])?.touched">Informe um CPF válido.</p>
        </label>
        <label class="field">Data de nascimento<input type="date" formControlName="dataNascimento" /></label>
        <label class="field">Sexo<select formControlName="genero">
            <option value=""></option>
            <option value="Feminino">Feminino</option>
            <option value="Masculino">Masculino</option>
            <option value="Outro">Outro</option>
          </select></label>
        <label class="field">ProfissÃ£o<input formControlName="profissao" placeholder="Ãrea de atuaÃ§Ã£o" /></label>
        <label class="field full">MotivaÃ§Ã£o<textarea formControlName="motivacao" placeholder="Por que deseja atuar como voluntÃ¡rio?" rows="3"></textarea></label>
      </div>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'contato'" formGroupName="contato">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Formas de contato e competÃªncias relevantes para a atuaÃ§Ã£o.</p>
        </div>
      </div>
      <div class="field-grid cols-3">
        <label class="field">Telefone<input formControlName="telefone" placeholder="(00) 00000-0000" (input)="onTelefoneInput($event)" /></label>
        <label class="field">E-mail*<input type="email" formControlName="email" placeholder="nome@email.com" /></label>
        <label class="field">Cidade<input formControlName="cidade" /></label>
        <label class="field">Estado<input maxlength="2" formControlName="estado" /></label>
        <label class="field">Ãrea de interesse<input formControlName="areaInteresse" placeholder="Ex.: EducaÃ§Ã£o, SaÃºde" /></label>
        <label class="field">Habilidades e experiÃªncias<textarea formControlName="habilidades" rows="3" placeholder="Atendimento, facilitaÃ§Ã£o, gestÃ£o..."></textarea></label>
        <label class="field">Idiomas<input formControlName="idiomas" placeholder="PortuguÃªs, InglÃªs..." /></label>
        <label class="field">LinkedIn / PortfÃ³lio<input formControlName="linkedin" placeholder="Link para perfil profissional" /></label>
      </div>
    </div>


    <div class="tab-card" *ngIf="activeTab === 'endereÃ§o'" formGroupName="endereÃ§o">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Preencha o endereÃ§o para contato e registro do voluntÃ¡rio.</p>
        </div>
      </div>
      <div class="field-grid cols-3">
        <label class="field">CEP<input formControlName="cep" placeholder="00000-000" (input)="onCepInput($event)" (blur)="onCepBlur()" />
          <p class="field-error" *ngIf="form.get(['endereÃ§o', 'cep'])?.invalid && form.get(['endereÃ§o', 'cep'])?.touched">Informe um CEP válido.</p>
          <p class="field-error" *ngIf="cepLookupError">{{ cepLookupError }}</p>
        </label>
        <label class="field">Logradouro<input formControlName="logradouro" placeholder="Rua, avenida, estrada" /></label>
        <label class="field">NÃºmero<input formControlName="numero" /></label>
        <label class="field">Complemento<input formControlName="complemento" /></label>
        <label class="field">Bairro<input formControlName="bairro" /></label>
        <label class="field">Ponto de referencia<input formControlName="pontoReferencia" /></label>
        <label class="field">Cidade<input formControlName="municipio" /></label>
        <label class="field">Zona<input formControlName="zona" /></label>
        <label class="field">Estado<input maxlength="2" formControlName="uf" /></label>
      </div>
    </div>
    <div class="tab-card" *ngIf="activeTab === 'disponibilidade'" formGroupName="disponibilidade">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Combine dias, perÃ­odos e formato de atuaÃ§Ã£o para alocar o voluntÃ¡rio.</p>
        </div>
      </div>
      <div class="field-grid cols-2">
                <div class="field full">
          <p class="field-title">Dias da semana</p>
          <div class="chips">
            <label *ngFor="let dia of diasSemana" class="chip">
              <input type="checkbox" [checked]="selectionChecked(['disponibilidade', 'dias'], dia)" (change)="toggleSelection(['disponibilidade', 'dias'], dia)" />
              <span>{{ dia }}</span>
            </label>
          </div>
        </div>
        <div class="field full">
          <p class="field-title">PerÃ­odos disponÃ­veis</p>
          <div class="chips">
            <label *ngFor="let periodo of periodos" class="chip">
              <input type="checkbox" [checked]="selectionChecked(['disponibilidade', 'periodos'], periodo)" (change)="toggleSelection(['disponibilidade', 'periodos'], periodo)" />
              <span>{{ periodo }}</span>
            </label>
          </div>
        </div>
        <label class="field">Carga horÃ¡ria semanal<input formControlName="cargaHorariaSemanal" placeholder="Ex.: 4h/semana" /></label>
        <label class="field">InÃ­cio previsto<input type="date" formControlName="inicioPrevisto" /></label>
        <div class="feature-grid">
          <label class="checkbox-field"><input type="checkbox" formControlName="presencial" /> <span>DisponÃ­vel para atuar presencialmente</span></label>
          <label class="checkbox-field"><input type="checkbox" formControlName="remoto" /> <span>Pode atuar de forma remota</span></label>
        </div>
        <label class="field full">ObservaÃ§Ãµes<textarea formControlName="observacoes" rows="3" placeholder="PreferÃªncias de local, restriÃ§Ãµes e recursos necessÃ¡rios"></textarea></label>
      </div>
    </div>

    <div class="tab-card" *ngIf="activeTab === 'termos'" formGroupName="termos">
      <div class="tab-card__header">
        <div class="tab-card__title-stack">
          <p class="tab-card__highlight">{{ tabs[activeTabIndex].label }}</p>
          <p class="muted">Formalize o aceite do termo de voluntariado e da autorizaÃ§Ã£o de uso de imagem.</p>
        </div>
      </div>
      <div class="field-grid cols-2">
        <div class="document-upload-grid full">
          <div class="document-upload-card">
            <p class="document-upload-card__title">Documento de identificação</p>
            <p class="muted">Envie a imagem do documento (RG, CNH ou similar).</p>
            <input
              type="file"
              accept=".jpg,.jpeg,.png,.pdf,image/jpeg,image/png,application/pdf"
              (change)="onDocumentoSelecionado('documentoIdentificacao', $event)"
            />
            <p class="document-upload-card__file" *ngIf="documentoIdentificacaoNome">
              {{ documentoIdentificacaoNome }}
            </p>
          </div>
          <div class="document-upload-card">
            <p class="document-upload-card__title">Comprovante de endereÃ§o</p>
            <p class="muted">Envie a imagem do comprovante atualizado.</p>
            <input
              type="file"
              accept=".jpg,.jpeg,.png,.pdf,image/jpeg,image/png,application/pdf"
              (change)="onDocumentoSelecionado('comprovanteEndereco', $event)"
            />
            <p class="document-upload-card__file" *ngIf="comprovanteEnderecoNome">
              {{ comprovanteEnderecoNome }}
            </p>
          </div>
        </div>
        <div class="term-card full">
          <div class="term-card__header">
            <div>
              <p class="term-card__title">Termo de voluntariado</p>
              <p class="muted">Responsabilidades, ausÃªncia de vÃ­nculo empregatÃ­cio e cuidados com seguranÃ§a e confidencialidade.</p>
            </div>
          </div>
          <ul>
            <li>AtuaÃ§Ã£o espontÃ¢nea e nÃ£o remunerada, regida pela Lei nÂº 9.608/1998, sem vÃ­nculo empregatÃ­cio.</li>
            <li>Dever de confidencialidade sobre beneficiÃ¡rios, relatÃ³rios e informaÃ§Ãµes estratÃ©gicas.</li>
            <li>Direito a capacitaÃ§Ã£o, orientaÃ§Ãµes de seguranÃ§a e materiais necessÃ¡rios para a atividade.</li>
            <li>Responsabilidade de comunicar ausÃªncias, zelar por equipamentos e cumprir protocolos internos.</li>
          </ul>
          <label class="checkbox-field">
            <input type="checkbox" formControlName="aceiteVoluntariado" />
            <span>Li e aceito o termo de voluntariado</span>
          </label>
        </div>

        <div class="term-card full">
          <div class="term-card__header">
            <div>
              <p class="term-card__title">AutorizaÃ§Ã£o de uso de imagem</p>
              <p class="muted">AutorizaÃ§Ã£o detalhada para captaÃ§Ã£o e divulgaÃ§Ã£o de imagem e voz em materiais institucionais.</p>
            </div>
          </div>
          <ul>
            <li>Uso gratuito da imagem e voz em mÃ­dias digitais, impressas, transmissÃµes e relatÃ³rios.</li>
            <li>Possibilidade de revogaÃ§Ã£o futura, sem efeito retroativo sobre peÃ§as jÃ¡ divulgadas.</li>
            <li>Tratamento de dados pessoais em conformidade com a LGPD e polÃ­ticas internas de privacidade.</li>
          </ul>
          <label class="checkbox-field">
            <input type="checkbox" formControlName="aceiteImagem" />
            <span>Autorizo o uso de imagem e voz para fins institucionais</span>
          </label>
        </div>

        <label class="field full">Assinatura digital / observaÃ§Ãµes para termo<textarea formControlName="assinaturaDigital" rows="3" placeholder="Registre informaÃ§Ãµes complementares ou assinatura eletrÃ´nica"></textarea></label>
        <div class="actions">
          <button class="primary" type="button" (click)="openTermo()">Gerar termo para assinatura</button>
        </div>
      </div>
    </div>
  </form>

  <div class="tab-card" *ngIf="activeTab === 'lista'">
    <div class="tab-card__header">
      <div class="tab-card__title-stack">
        <p class="tab-card__highlight">Listagem de voluntÃ¡rios</p>
        <p class="muted">Localização completa para correspondencias e visitas.</p>
      </div>
      <div class="tab-card__header-actions">
        <button type="button" class="btn-outline" (click)="limparFiltrosListagem()">Limpar</button>
        <button type="button" class="btn-outline" (click)="aplicarFiltrosListagem()">Buscar</button>
      </div>
    </div>

    <form [formGroup]="listagemForm" class="list-filters" (ngSubmit)="aplicarFiltrosListagem()">
      <label class="field">Nome
        <input type="text" formControlName="nome" placeholder="Digite parte do nome" />
      </label>
      <label class="field">CPF
        <input type="text" formControlName="cpf" placeholder="Somente numeros" />
      </label>
      <label class="field">CÃ³digo
        <input type="text" formControlName="codigo" placeholder="Ex.: 0001" />
      </label>
      <label class="field">Nascimento
        <input type="date" formControlName="dataNascimento" />
      </label>
      <label class="field">Status
        <select formControlName="status">
          <option value="">Todos</option>
          <option *ngFor="let status of statusOptions" [value]="status">{{ formatarStatusLabel(status) }}</option>
        </select>
      </label>
    </form>

    <div class="unit-active" *ngIf="voluntarioSelecionado">
      <div>
        <p class="unit-active__eyebrow">voluntÃ¡rio <span class="pill">ativo</span></p>
        <p class="unit-active__name">{{ voluntarioSelecionado.nome || 'voluntÃ¡rio sem nome' }}</p>
        <p class="unit-active__meta">
          {{ voluntarioSelecionado.cpf || 'CPF n?o informado' }} - {{ voluntarioSelecionado.email || 'E-mail n?o informado' }}
        </p>
      </div>
      <button type="button" class="btn-outline btn-small" (click)="editarVoluntarioNaLista(voluntarioSelecionado)">
        Editar
      </button>
    </div>

    <div class="unit-list" *ngIf="voluntariosPaginados.length">
      <div class="unit-list__item" *ngFor="let volunteer of voluntariosPaginados">
        <div>
          <div class="unit-list__header-row">
            <span class="unit-list__code">CÃ³digo: {{ volunteer.id || '---' }}</span>
            <span class="pill" [ngClass]="getStatusClass(volunteer.status)">{{ formatarStatusLabel(volunteer.status) }}</span>
          </div>
          <div class="unit-list__name-row">
            <div class="unit-list__avatar" [class.unit-list__avatar--empty]="!volunteer.foto_3x4">
              <img *ngIf="volunteer.foto_3x4" [src]="volunteer.foto_3x4" alt="Foto do voluntÃ¡rio" />
              <span *ngIf="!volunteer.foto_3x4" aria-hidden="true">
                {{ (volunteer.nome || 'V')[0] }}
              </span>
            </div>
            <p class="unit-list__name-text">{{ volunteer.nome || 'voluntÃ¡rio sem nome' }}</p>
          </div>
          <div class="unit-list__info-row">
            <span class="unit-list__meta-text">Idade: {{ calcularIdade(volunteer.dataNascimento) }}</span>
            <span class="unit-list__separator">Â·</span>
            <span class="unit-list__meta-text">Nascimento: {{ formatarDataNascimentoListagem(volunteer.dataNascimento) }}</span>
            <span class="unit-list__separator">Â·</span>
            <span class="unit-list__meta-text">CPF: {{ volunteer.cpf || 'CPF n?o informado' }}</span>
            <span class="unit-list__separator">Â·</span>
            <span class="unit-list__meta-text" [title]="volunteer.bairro || 'Bairro n?o informado'">
              <span class="unit-list__meta-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24">
                  <path
                    d="M12 2.5c-4.14 0-7.5 3.17-7.5 7.09 0 4.73 6.39 11.22 7.02 11.85a.68.68 0 0 0 .96 0c.63-.63 7.02-7.12 7.02-11.85C19.5 5.67 16.14 2.5 12 2.5zm0 10.2a3.1 3.1 0 1 1 0-6.2 3.1 3.1 0 0 1 0 6.2z"
                  />
                </svg>
              </span>
              Bairro: {{ volunteer.bairro || 'NÃ£o informado' }}
            </span>
            <span class="unit-list__separator">Â·</span>
            <span class="unit-list__meta-text">
              <span class="unit-list__meta-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24">
                  <path
                    d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.02-.24 11.72 11.72 0 0 0 3.68.59 1 1 0 0 1 1 1v3.5a1 1 0 0 1-1 1A17.5 17.5 0 0 1 2.5 3a1 1 0 0 1 1-1H7a1 1 0 0 1 1 1 11.72 11.72 0 0 0 .59 3.68 1 1 0 0 1-.24 1.02l-2.2 2.09z"
                  />
                </svg>
              </span>
              Tel.: {{ volunteer.telefone || 'NÃ£o informado' }}
            </span>
          </div>
        </div>
        <div class="unit-list__actions">
          <button type="button" class="btn-outline btn-small" (click)="selecionarVoluntarioNaLista(volunteer)">
            Editar
          </button>
        </div>
      </div>
    </div>

    <div class="unit-list__pagination" *ngIf="volunteersFiltrados.length && voluntariosPaginados.length">
      <span class="unit-list__total">
        Total: {{ volunteersFiltrados.length }} voluntÃ¡rios
      </span>
      <button type="button" class="btn-outline" (click)="paginaAnterior()" [disabled]="paginaAtual === 1">
        Anterior
      </button>
      <span class="unit-list__page">
        PÃ¡gina {{ paginaAtual }} de {{ totalPaginas }}
      </span>
      <button type="button" class="btn-outline" (click)="proximaPagina()" [disabled]="paginaAtual >= totalPaginas">
        PrÃ³ximo
      </button>
    </div>

    <p class="muted" *ngIf="!volunteersFiltrados.length">Nenhum voluntÃ¡rio cadastrado ate o momento.</p>
  </div>
</section>
</app-tela-padrao>





