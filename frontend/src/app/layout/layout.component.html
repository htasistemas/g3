<div class="h-screen flex app-shell overflow-hidden">
  <aside
    class="sidebar hidden md:flex flex-col flex-shrink-0 overflow-y-auto"
    [class.sidebar--collapsed]="isSidebarCollapsed"
  >
    <div class="sidebar__header">
      <a
        class="sidebar__logo-wrapper"
        *ngIf="activeUnitLogo$ | async as logomarcaAtiva"
        [routerLink]="'/dashboard/visao-geral'"
        title="Ir para a tela inicial"
        aria-label="Ir para a tela inicial"
      >
        <img
          [src]="logomarcaAtiva"
          alt="Logomarca da unidade"
          class="sidebar__logo"
        />
      </a>
    </div>
    <nav class="p-4 space-y-3">
      <div
        *ngFor="let section of menuSections"
        class="menu-card"
      >
        <button
          type="button"
          (click)="toggleSection(section.label)"
          class="menu-card__trigger"
          [attr.title]="isSidebarCollapsed ? section.label : null"
        >
          <span class="flex items-center space-x-3">
            <fa-icon [icon]="section.icon" class="menu-section__icon text-emerald-100"></fa-icon>
            <span class="menu-card__label">{{ section.label }}</span>
          </span>
          <fa-icon
            [icon]="openSection === section.label ? faChevronUp : faChevronDown"
            class="text-emerald-50"
            *ngIf="!isSidebarCollapsed"
          ></fa-icon>
        </button>

        <div *ngIf="openSection === section.label" class="menu-card__content">
          <ng-container *ngFor="let child of section.children">
            <a
              *ngIf="child.route; else semRota"
              class="menu-link"
              [routerLink]="child.route"
              routerLinkActive="menu-link--active"
              [routerLinkActiveOptions]="{ exact: true }"
            >
              <fa-icon [icon]="child.icon" class="menu-link__icon mr-3 text-emerald-600"></fa-icon>
              <span>{{ child.label }}</span>
            </a>
            <ng-template #semRota>
              <a
                *ngIf="child.urlExterna; else staticChild"
                class="menu-link"
                [href]="child.urlExterna"
                target="_blank"
                rel="noopener"
              >
                <fa-icon [icon]="child.icon" class="menu-link__icon mr-3 text-emerald-600"></fa-icon>
                <span>{{ child.label }}</span>
              </a>
              <ng-template #staticChild>
                <div class="menu-link menu-link--static">
                  <fa-icon [icon]="child.icon" class="menu-link__icon mr-3 text-emerald-600"></fa-icon>
                  <span>{{ child.label }}</span>
                </div>
              </ng-template>
            </ng-template>
          </ng-container>
        </div>
      </div>
    </nav>
    <div class="sidebar__footer">
      <button
        type="button"
        class="sidebar-toggle"
        (click)="toggleSidebar()"
        [attr.aria-label]="isSidebarCollapsed ? 'Abrir menu' : 'Recolher menu'"
        [attr.title]="isSidebarCollapsed ? 'Abrir menu' : 'Recolher menu'"
      >
        <fa-icon [icon]="isSidebarCollapsed ? faChevronRight : faChevronLeft"></fa-icon>
      </button>
    </div>
  </aside>

  <div class="flex-1 flex flex-col min-w-0 h-screen">
    <header class="app-header">
      <div class="app-header__spacer" aria-hidden="true"></div>
      <div class="app-header__actions">
        <button
          *ngIf="lembretesPendentes.length"
          type="button"
          class="lembretes-chip"
          (click)="abrirLembretes()"
        >
          Você tem {{ lembretesPendentes.length }} lembretes diários
        </button>
        <div class="tarefas-chip">
          <button type="button" class="tarefas-chip__button" (click)="abrirTarefas()">Tarefas</button>
          <button
            type="button"
            class="tarefas-chip__item tarefas-chip__item--abertas"
            (click)="abrirTarefasAbertas()"
          >
            Abertas: {{ tarefasAbertas }}
          </button>
          <button
            type="button"
            class="tarefas-chip__item tarefas-chip__item--alerta tarefas-chip__item--vencidas"
            [class.tarefas-chip__item--piscar]="tarefasVencidas > 0"
            (click)="abrirTarefasVencidas()"
          >
            Vencidas: {{ tarefasVencidas }}
          </button>
        </div>
        <span class="user-chip">
          <fa-icon [icon]="faUserCircle" class="text-white"></fa-icon>
          <span class="capitalize">{{ username }}</span>
        </span>
        <button
          type="button"
          (click)="toggleTheme()"
          class="theme-toggle-button"
          [attr.title]="themeService.currentTheme() === 'dark' ? 'Tema claro' : 'Tema escuro'"
          [attr.aria-label]="themeService.currentTheme() === 'dark' ? 'Ativar tema claro' : 'Ativar tema escuro'"
        >
          <fa-icon [icon]="themeService.currentTheme() === 'dark' ? faSun : faMoon"></fa-icon>
        </button>
        <button type="button"
          (click)="logout()"
          class="logout-button"
        >
          <fa-icon [icon]="faRightFromBracket"></fa-icon>
          <span>Sair</span>
        </button>
      </div>
    </header>
    <main class="flex-1 overflow-y-auto">
      <div class="w-full">
        <router-outlet></router-outlet>
      </div>
    </main>
  </div>
</div>

<div class="modal" *ngIf="lembretesAbertos">
  <div class="modal__backdrop" (click)="fecharLembretes()"></div>
  <div class="modal__container lembretes-modal">
    <header class="modal__header">
      <div>
        <p class="modal__eyebrow">Lembretes diários</p>
        <h3 class="modal__title">Pendentes e atrasados</h3>
      </div>
      <button type="button" class="ghost" (click)="fecharLembretes()" aria-label="Fechar">&times;</button>
    </header>
    <div class="modal__body">
      <div *ngIf="!lembretesPendentes.length" class="muted">Nenhum lembrete pendente para hoje.</div>
      <div class="lembretes-lista" *ngIf="lembretesPendentes.length">
        <div class="lembrete-card" *ngFor="let lembrete of lembretesPendentes">
          <div>
            <p class="lembrete-card__titulo">{{ lembrete.titulo }}</p>
            <p class="lembrete-card__meta">
              {{ lembrete.proximaExecucaoEm | date: 'dd/MM/yyyy HH:mm' }}
            </p>
          </div>
          <div class="lembrete-card__acoes">
            <button type="button" class="btn-outline btn-small" (click)="concluirLembrete(lembrete)">Concluir</button>
            <button type="button" class="btn-outline btn-small" (click)="abrirAdiarLembrete(lembrete)">Adiar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal" *ngIf="adiarAberto">
  <div class="modal__backdrop" (click)="fecharAdiarLembrete()"></div>
  <div class="modal__container">
    <header class="modal__header">
      <div>
        <p class="modal__eyebrow">Adiar lembrete</p>
        <h3 class="modal__title">Defina nova data e hora</h3>
      </div>
      <button type="button" class="ghost" (click)="fecharAdiarLembrete()" aria-label="Fechar">&times;</button>
    </header>
    <div class="modal__body">
      <label class="field">Data
        <input type="date" [(ngModel)]="adiarData" />
      </label>
      <label class="field">Hora
        <input type="time" [(ngModel)]="adiarHora" />
      </label>
    </div>
    <footer class="modal__footer">
      <button type="button" class="ghost" (click)="fecharAdiarLembrete()">Cancelar</button>
      <button type="button" class="primary" (click)="confirmarAdiarLembrete()">Salvar</button>
    </footer>
  </div>
</div>

