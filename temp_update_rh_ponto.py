from pathlib import Path
p=Path('backend/src/main/java/br/com/g3/rh/serviceimpl/RhPontoServiceImpl.java')
text=p.read_text(errors='ignore')
old_start='@Override\n  @Transactional\n  public RhPontoDiaResponse baterPonto(RhPontoBaterRequest request, String ip, String userAgent) {'
old_end='  }
\n  @Override\n  public RhPontoEspelhoResponse consultarEspelho'
if old_start in text and old_end in text:
    pre, rest = text.split(old_start,1)
    body, post = rest.split(old_end,1)
    new_block='@Override\n  @Transactional\n  public RhPontoDiaResponse baterPonto(RhPontoBaterRequest request, Long usuarioId, String ip, String userAgent) {\n    if (request == null) {\n      throw new ResponseStatusException(HttpStatus.BAD_REQUEST, " Informe os dados da marcação.\);\n }\n if (usuarioId == null) {\n throw new ResponseStatusException(HttpStatus.BAD_REQUEST, \Usuário não informado.\);\n }\n String tipo = normalizarTexto(request.getTipo());\n if (!TIPOS_VALIDOS.contains(tipo)) {\n throw new ResponseStatusException(HttpStatus.BAD_REQUEST, \Tipo de marcação inválido.\);\n }\n if (request.getSenha() == null || request.getSenha().isBlank()) {\n registrarAuditoria(usuarioId, \PONTO_SENHA_VAZIA\, \Senha não informada\);\n throw new ResponseStatusException(HttpStatus.BAD_REQUEST, \Informe a senha para registrar o ponto.\);\n }\n if (request.getLatitude() == null || request.getLongitude() == null || request.getAccuracy() == null) {\n throw new ResponseStatusException(HttpStatus.BAD_REQUEST, \Localização não informada.\);\n }\n\n Usuario usuario = buscarUsuario(usuarioId);\n if (!passwordEncoder.matches(request.getSenha(), usuario.getSenhaHash())) {\n registrarAuditoria(usuarioId, \PONTO_SENHA_INVALIDA\, \Senha inválida\);\n throw new ResponseStatusException(HttpStatus.UNAUTHORIZED, \Senha inválida.\);\n }\n\n RhLocalPonto local = localRepository.buscarPrimeiroAtivo()\n .orElseThrow(() -> new ResponseStatusException(HttpStatus.BAD_REQUEST, \Local de ponto ativo não configurado.\));\n validarAccuracy(request.getAccuracy(), local.getAccuracyMaxMetros());\n\n double distancia = calcularDistanciaMetros(\n request.getLatitude(), request.getLongitude(), local.getLatitude(), local.getLongitude());\n boolean dentroPerimetro = distancia <= local.getRaioMetros();\n if (!dentroPerimetro) {\n registrarAuditoria(usuarioId, \PONTO_FORA_PERIMETRO\,\n String.format(Locale.forLanguageTag(\pt-BR\), \Distância %.2f m\, distancia));\n throw new ResponseStatusException(HttpStatus.BAD_REQUEST,\n \Você precisa estar na instituição para registrar o ponto.\);\n }\n\n LocalDate hoje = LocalDate.now();\n RhConfiguracaoPonto configuracao = configuracaoRepository.buscarAtual().orElseGet(this::criarConfiguracaoPadrao);\n RhPontoDia pontoDia = pontoDiaRepository.buscarPorFuncionarioEData(usuarioId, hoje)\n .orElseGet(() -> criarPontoDia(hoje, usuarioId, configuracao));\n\n String proximoTipo = obterProximoTipo(pontoDia.getMarcacoes());\n if (!tipo.equals(proximoTipo)) {\n throw new ResponseStatusException(HttpStatus.BAD_REQUEST,\n \Sequência de marcação inválida. Próxima marcação esperada: \ + proximoTipo + \.\);\n }\n\n RhPontoMarcacao marcacao = new RhPontoMarcacao();\n marcacao.setPontoDia(pontoDia);\n marcacao.setTipo(tipo);\n marcacao.setDataHoraServidor(LocalDateTime.now());\n marcacao.setLatitude(request.getLatitude());\n marcacao.setLongitude(request.getLongitude());\n marcacao.setAccuracy(request.getAccuracy());\n marcacao.setDistanciaMetros(distancia);\n marcacao.setDentroPerimetro(true);\n marcacao.setIp(ip);\n marcacao.setUserAgent(userAgent);\n marcacao.setCriadoEm(LocalDateTime.now());\n RhPontoMarcacao salvo = marcacaoRepository.salvar(marcacao);\n pontoDia.getMarcacoes().add(salvo);\n\n recalcularPontoDia(pontoDia, configuracao);\n pontoDia.setAtualizadoEm(LocalDateTime.now());\n RhPontoDia pontoAtualizado = pontoDiaRepository.salvar(pontoDia);\n\n auditoriaService.registrarEvento(\n \Ponto registrado\,\n \rh_ponto_dia\,\n String.valueOf(pontoAtualizado.getId()),\n \Marcação \ + tipo,\n usuarioId);\n registrarAuditoria(usuarioId, \PONTO_REGISTRADO\, \Marcação \ + tipo);\n\n return mapper.toPontoDiaResponse(pontoAtualizado);\n }\n\n @Override\n public RhPontoEspelhoResponse consultarEspelho'
 text=pre+new_block+post
 p.write_text(text)
else:
 raise SystemExit('Bloco não encontrado')
